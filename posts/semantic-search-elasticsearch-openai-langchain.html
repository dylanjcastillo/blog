<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Dylan Castillo">
<meta name="dcterms.date" content="2023-04-27">
<meta name="description" content="In this tutorial, I’ll walk you through building a semantic search service using Elasticsearch, OpenAI, LangChain, and FastAPI.">

<title>Semantic Search with Elasticsearch, OpenAI, and LangChain – Dylan Castillo</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../logo.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;0,900;1,300;1,400;1,700;1,900&amp;display=swap" rel="stylesheet">
<script src="https://cdn.usefathom.com/script.js" data-site="ZJFQREIA" defer=""></script>


</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../projects.html"> 
<span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/dylanjcastillo"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/dylanjcastillo/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/dylanjcastillo"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#prerequisites" id="toc-prerequisites" class="nav-link active" data-scroll-target="#prerequisites">Prerequisites</a></li>
  <li><a href="#designing-a-semantic-search-service" id="toc-designing-a-semantic-search-service" class="nav-link" data-scroll-target="#designing-a-semantic-search-service">Designing a Semantic Search Service</a></li>
  <li><a href="#set-up-your-local-environment" id="toc-set-up-your-local-environment" class="nav-link" data-scroll-target="#set-up-your-local-environment">Set Up Your Local Environment</a></li>
  <li><a href="#start-a-local-elasticsearch-cluster" id="toc-start-a-local-elasticsearch-cluster" class="nav-link" data-scroll-target="#start-a-local-elasticsearch-cluster">Start a Local Elasticsearch Cluster</a></li>
  <li><a href="#split-and-index-the-book" id="toc-split-and-index-the-book" class="nav-link" data-scroll-target="#split-and-index-the-book">Split and Index the Book</a></li>
  <li><a href="#create-a-search-application" id="toc-create-a-search-application" class="nav-link" data-scroll-target="#create-a-search-application">Create a Search Application</a></li>
  <li><a href="#going-to-production" id="toc-going-to-production" class="nav-link" data-scroll-target="#going-to-production">Going to Production</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Semantic Search with Elasticsearch, OpenAI, and LangChain</h1>
  <div class="quarto-categories">
    <div class="quarto-category">python</div>
    <div class="quarto-category">ml</div>
    <div class="quarto-category">nlp</div>
  </div>
  </div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author"><a href="https://dylancastillo.co">Dylan Castillo</a> </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            <a href="https://iwanalabs.com">
            Iwana Labs
            </a>
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">April 27, 2023</p>
    </div>
  </div>
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">September 4, 2024</p>
    </div>
  </div>
    
  </div>
  


</header>


<p><a href="https://github.com/hwchase17/langchain">LangChain</a> is the new cool kid on the block. It’s a library designed to help you interact with Large Language Models (LLMs). Up until recently, I was building most things from scratch when working with LLMs, so I decided to give LangChain a try.</p>
<p>After a <a href="https://deepsheet.dylancastillo.co/">few</a> <a href="https://namemancer.dylancastillo.co/">projects</a> using it, I’m truly impressed. It simplifies many of the routine tasks associated with working with LLMs, such as extracting text from documents or indexing them in a vector database. If you’re working with LLMs today, LangChain can save you hours of work.</p>
<p>However, one drawback is that its <a href="https://python.langchain.com/en/latest/">documentation</a>, despite being extensive, can be scattered and difficult for newcomers to comprehend. Moreover, most of the content online focuses on the latest generation of vector databases. Since many organizations still use older, but battle-tested technologies such as <a href="https://www.elastic.co/">Elasticsearch</a> and I decided to write a tutorial using it.</p>
<p>I combined LangChain and Elasticsearch in one of the most common LLM applications: semantic search. In this tutorial, I’ll walk you through building a semantic search service using Elasticsearch, OpenAI, LangChain, and FastAPI. You’ll create an application that lets users ask questions about Marcus Aurelius’ Meditations and provides them with concise answers by extracting the most relevant content from the book.</p>
<p>Let’s dive in!</p>
<section id="prerequisites" class="level2">
<h2 class="anchored" data-anchor-id="prerequisites">Prerequisites</h2>
<p>You should be familiar with these topics to make the most out of this tutorial:</p>
<ol type="1">
<li>What <a href="https://blog.dataiku.com/semantic-search-an-overlooked-nlp-superpower?ref=dylancastillo.co">semantic search</a> is.</li>
<li>How to use <a href="https://dylancastillo.co/elasticsearch-python/">Elasticsearch in Python</a>.</li>
<li>What <a href="https://platform.openai.com/docs/guides/embeddings">text embeddings</a> are.</li>
</ol>
<p>In addition, you must install <a href="https://docs.docker.com/get-docker/?ref=dylancastillo.co">Docker</a> and create an account at <a href="https://beta.openai.com">OpenAI</a>.</p>
</section>
<section id="designing-a-semantic-search-service" class="level2">
<h2 class="anchored" data-anchor-id="designing-a-semantic-search-service">Designing a Semantic Search Service</h2>
<p>You’re going to build a service with three components:</p>
<ol type="1">
<li><strong>Indexer:</strong> This creates the index, generates the embeddings and the metadata (source and title of the book, in this case), and adds them to the vector database.</li>
<li><strong>Vector database:</strong> This is a database that you use to store and retrieve the embeddings you generate.</li>
<li><strong>Search app:</strong> This is a backend service that uses the user’s search term, generates an embedding from it, and then looks for the most similar embeddings in the vector database.</li>
</ol>
<p>Here’s a diagram of this architecture:</p>
<p><img src="images/semantic-search-elasticsearch-openai-langchain/image-12.png" class="img-fluid"></p>
<p>If you’ve read my previous <a href="https://dylancastillo.co/semantic-search-with-opensearch-cohere-and-fastapi/">tutorial</a> on semantic search, you might have noticed that the <strong>vectorizer</strong> isn’t part of this architecture. I’m purposely skipping it because <code>langchain</code> takes care of that part for you, so you can have the indexer and vectorizer in the same place.</p>
<p>Next, you’ll set up your local environment.</p>
</section>
<section id="set-up-your-local-environment" class="level2">
<h2 class="anchored" data-anchor-id="set-up-your-local-environment">Set Up Your Local Environment</h2>
<p>Follow these steps to set up your local environment:</p>
<ol type="1">
<li>Install <a href="https://www.python.org/downloads/">Python 3.10</a>.</li>
<li>Install <a href="https://python-poetry.org/docs/#installation">Poetry</a>. It’s optional but highly recommended.</li>
<li>Clone the project’s repository:</li>
</ol>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">git</span> clone https://github.com/dylanjcastillo/semantic-search-elasticsearch-openai-langchain</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="4" type="1">
<li><p>From the root folder of the project, install the dependencies:</p>
<ul>
<li>Using <strong>Poetry:</strong> Create the virtual environment in the same directory as the project and install the dependencies:</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1"></a><span class="ex">poetry</span> config virtualenvs.in-project true</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="ex">poetry</span> install</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Using <strong>venv and pip:</strong> Create a virtual environment and install the dependencies listed in <code>requirements.txt</code>:</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1"></a><span class="ex">python3.10</span> <span class="at">-m</span> venv .venv <span class="kw">&amp;&amp;</span> <span class="bu">source</span> .venv/bin/activate</span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="ex">pip</span> install <span class="at">-r</span> requirements.txt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Open <code>src/.env-example</code>, add your secret OpenAI key, and save the file as <code>.env</code>.</p></li>
</ol>
<p>By now, you’ll have a virtual environment set up with the required libraries and a local copy of the repository. Your project structure should look like this:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1"></a><span class="ex">semantic-search-elasticsearch-openai-langchain</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="ex">├──</span> LICENSE</span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="ex">├──</span> README.md</span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="ex">├──</span> poetry.lock</span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="ex">├──</span> pyproject.toml</span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="ex">├──</span> requirements.txt</span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="ex">├──</span> run_elasticsearch.sh</span>
<span id="cb4-8"><a href="#cb4-8"></a><span class="ex">├──</span> src</span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="ex">│&nbsp;&nbsp;</span> ├── app.py</span>
<span id="cb4-10"><a href="#cb4-10"></a><span class="ex">│&nbsp;&nbsp;</span> ├── config.py</span>
<span id="cb4-11"><a href="#cb4-11"></a><span class="ex">│</span>   ├── data</span>
<span id="cb4-12"><a href="#cb4-12"></a><span class="ex">│&nbsp;&nbsp;</span> │   └── Marcus_Aurelius_Antoninus...</span>
<span id="cb4-13"><a href="#cb4-13"></a><span class="ex">│&nbsp;&nbsp;</span> │       ├── index.html</span>
<span id="cb4-14"><a href="#cb4-14"></a><span class="ex">│&nbsp;&nbsp;</span> │       ├── metadata.opf</span>
<span id="cb4-15"><a href="#cb4-15"></a><span class="ex">│&nbsp;&nbsp;</span> │       └── style.css</span>
<span id="cb4-16"><a href="#cb4-16"></a><span class="ex">│&nbsp;&nbsp;</span> ├── indexer.py</span>
<span id="cb4-17"><a href="#cb4-17"></a><span class="ex">│</span>   └── .env-example</span>
<span id="cb4-18"><a href="#cb4-18"></a><span class="ex">└──</span> .venv/</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These are the most relevant files and directories in the project:</p>
<ul>
<li><code>poetry.lock</code> and <code>pyproject.toml</code>: These files contain the project’s specifications and dependencies and are used by Poetry to create a virtual environment.</li>
<li><code>requirements.txt</code>: This file contains a list of Python packages required by the project.</li>
<li><code>run_elasticsearch_docker.sh</code>: This file contains a bash script used to run an Elasticsearch cluster locally.</li>
<li><code>src/app.py</code>: This file contains the code of the search application.</li>
<li><code>src/config.py</code>: This file contains project configuration specifications such as OpenAI’s API key (read from a <code>.env</code> file), the paths to the data, and the name of the index.</li>
<li><code>src/data/</code>: This directory contains <a href="https://en.wikisource.org/wiki/Marcus_Aurelius_Antoninus_-_His_Meditations_concerning_himselfe">Meditations</a> as originally downloaded from <a href="https://en.wikisource.org/wiki/Main_Page?ref=dylancastillo.co">Wikisource</a>. You’ll use that as the corpus of text for this tutorial.</li>
<li><code>src/indexer.py</code>: This file contains the code you use to create an index and insert the documents in OpenSearch.</li>
<li><code>.env-example</code>: This file is typically used for environment variables. In this case, you use it to pass OpenAI’s API key to your application.</li>
<li><code>.venv/</code>: This directory contains the project’s virtual environment.</li>
</ul>
<p>All done! Let’s get going.</p>
</section>
<section id="start-a-local-elasticsearch-cluster" class="level2">
<h2 class="anchored" data-anchor-id="start-a-local-elasticsearch-cluster">Start a Local Elasticsearch Cluster</h2>
<p>Before we get into the code, you should start a local Elasticsearch cluster. Open a new terminal, navigate to the project’s root folder, and run:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1"></a><span class="fu">sh</span> run_elasticsearch_docker.sh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If everything went well, a lengthy text string will appear on the terminal. For the rest of the tutorial, keep this terminal window open in the background.</p>
</section>
<section id="split-and-index-the-book" class="level2">
<h2 class="anchored" data-anchor-id="split-and-index-the-book">Split and Index the Book</h2>
<p>In this step, you’ll do two things:</p>
<ol type="1">
<li>Process the text from the book by splitting it into chunks of 1,000 tokens.</li>
<li>Index the text chunks you’ve generated (from now on called documents) in your Elasticsearch cluster.</li>
</ol>
<p>Take a look at <code>src/indexer.py</code>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1"></a><span class="im">from</span> langchain.document_loaders <span class="im">import</span> BSHTMLLoader</span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="im">from</span> langchain.embeddings.openai <span class="im">import</span> OpenAIEmbeddings</span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="im">from</span> langchain.text_splitter <span class="im">import</span> RecursiveCharacterTextSplitter</span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="im">from</span> langchain.vectorstores <span class="im">import</span> ElasticVectorSearch</span>
<span id="cb6-5"><a href="#cb6-5"></a></span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="im">from</span> config <span class="im">import</span> Paths, openai_api_key</span>
<span id="cb6-7"><a href="#cb6-7"></a></span>
<span id="cb6-8"><a href="#cb6-8"></a></span>
<span id="cb6-9"><a href="#cb6-9"></a><span class="kw">def</span> main():</span>
<span id="cb6-10"><a href="#cb6-10"></a>    loader <span class="op">=</span> BSHTMLLoader(<span class="bu">str</span>(Paths.book))</span>
<span id="cb6-11"><a href="#cb6-11"></a>    data <span class="op">=</span> loader.load()</span>
<span id="cb6-12"><a href="#cb6-12"></a></span>
<span id="cb6-13"><a href="#cb6-13"></a>    text_splitter <span class="op">=</span> RecursiveCharacterTextSplitter.from_tiktoken_encoder(</span>
<span id="cb6-14"><a href="#cb6-14"></a>        chunk_size<span class="op">=</span><span class="dv">1000</span>, chunk_overlap<span class="op">=</span><span class="dv">0</span></span>
<span id="cb6-15"><a href="#cb6-15"></a>    )</span>
<span id="cb6-16"><a href="#cb6-16"></a>    documents <span class="op">=</span> text_splitter.split_documents(data)</span>
<span id="cb6-17"><a href="#cb6-17"></a></span>
<span id="cb6-18"><a href="#cb6-18"></a>    embeddings <span class="op">=</span> OpenAIEmbeddings(openai_api_key<span class="op">=</span>openai_api_key)</span>
<span id="cb6-19"><a href="#cb6-19"></a>    db <span class="op">=</span> ElasticVectorSearch.from_documents(</span>
<span id="cb6-20"><a href="#cb6-20"></a>        documents,</span>
<span id="cb6-21"><a href="#cb6-21"></a>        embeddings,</span>
<span id="cb6-22"><a href="#cb6-22"></a>        elasticsearch_url<span class="op">=</span><span class="st">"http://localhost:9200"</span>,</span>
<span id="cb6-23"><a href="#cb6-23"></a>        index_name<span class="op">=</span><span class="st">"elastic-index"</span>,</span>
<span id="cb6-24"><a href="#cb6-24"></a>    )</span>
<span id="cb6-25"><a href="#cb6-25"></a>    <span class="bu">print</span>(db.client.info())</span>
<span id="cb6-26"><a href="#cb6-26"></a></span>
<span id="cb6-27"><a href="#cb6-27"></a></span>
<span id="cb6-28"><a href="#cb6-28"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb6-29"><a href="#cb6-29"></a>    main()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This code takes Meditations, splits it into text chunks of 1,000 tokens, and then indexes those chunks in your Elasticsearch cluster. Here’s a detailed breakdown:</p>
<ul>
<li><strong>Lines 1 to 4</strong> import the required components from <code>langchain</code>:
<ul>
<li><strong><code>BSHTMLLoader</code></strong>: This <a href="https://python.langchain.com/en/latest/modules/indexes/document_loaders.html">loader</a> uses BeautifulSoup4 to parse the documents.</li>
<li><strong><code>OpenAIEmbeddings</code></strong>: This component is a wrapper around OpenAI embeddings. It helps you generate embeddings for documents and queries.</li>
<li><strong><code>RecursiveCharacterTextSplitter</code></strong>: This utility function divides the input text by attempting various characters in an order designed to maintain semantically similar content in proximity. The characters used for splitting, in the following order, are: <code>"\n\n"</code>, <code>"\n"</code>, <code>" "</code>, <code>""</code>.</li>
<li><strong><code>ElasticSearchVector</code></strong>: This is a wrapper around the Elasticsearch client, that simplifies interacting with your cluster.</li>
</ul></li>
<li><strong>Line 6</strong> imports the relevant configurations from <code>config.py</code></li>
<li><strong>Lines 11 and 12</strong> extract the book’s text using <code>BSHTMLLoader</code>.</li>
<li><strong>Lines 13 to 16</strong> initialize the text splitter and split the text in chunks of no more than 1,000 tokens. In this case, you use <a href="https://github.com/openai/tiktoken"><code>tiktoken</code></a> to count the tokens but you can also use different <a href="https://python.langchain.com/en/latest/modules/indexes/text_splitters/getting_started.html">length functions</a>, such as counting the number of characters instead of tokens or a different tokenizing function.</li>
<li><strong>Lines 18 to 25</strong> initialize the embeddings function, create a new index, and index the documents generated by the text splitter. In <code>elasticsearch_url</code>, you specify the port where your application is running locally, and in <code>index_name</code> you specify the name of the index you’ll use. Finally, you print the Elasticsearch client information.</li>
</ul>
<p>To run this script, open a terminal, activate the virtual environment, and from <code>src</code> folder of your project, run the following command:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1"></a><span class="co"># ../src/</span></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="ex">python</span> indexer.py</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If everything went well, you should get an output that looks similar to this (but not properly formatted):</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode numberSource json number-lines code-with-copy"><code class="sourceCode json"><span id="cb8-1"><a href="#cb8-1"></a><span class="fu">{</span></span>
<span id="cb8-2"><a href="#cb8-2"></a>  <span class="dt">"name"</span><span class="fu">:</span> <span class="st">"0e1113eb2915"</span><span class="fu">,</span></span>
<span id="cb8-3"><a href="#cb8-3"></a>  <span class="dt">"cluster_name"</span><span class="fu">:</span> <span class="st">"docker-cluster"</span><span class="fu">,</span></span>
<span id="cb8-4"><a href="#cb8-4"></a>  <span class="dt">"cluster_uuid"</span><span class="fu">:</span> <span class="st">"og6mFMqwQtaJiv_3E_q2YQ"</span><span class="fu">,</span></span>
<span id="cb8-5"><a href="#cb8-5"></a>  <span class="dt">"version"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb8-6"><a href="#cb8-6"></a>    <span class="dt">"number"</span><span class="fu">:</span> <span class="st">"8.7.0"</span><span class="fu">,</span></span>
<span id="cb8-7"><a href="#cb8-7"></a>    <span class="dt">"build_flavor"</span><span class="fu">:</span> <span class="st">"default"</span><span class="fu">,</span></span>
<span id="cb8-8"><a href="#cb8-8"></a>    <span class="dt">"build_type"</span><span class="fu">:</span> <span class="st">"docker"</span><span class="fu">,</span></span>
<span id="cb8-9"><a href="#cb8-9"></a>    <span class="dt">"build_hash"</span><span class="fu">:</span> <span class="st">"09520b59b6bc1057340b55750186466ea715e30e"</span><span class="fu">,</span></span>
<span id="cb8-10"><a href="#cb8-10"></a>    <span class="dt">"build_date"</span><span class="fu">:</span> <span class="st">"2023-03-27T16:31:09.816451435Z"</span><span class="fu">,</span></span>
<span id="cb8-11"><a href="#cb8-11"></a>    <span class="dt">"build_snapshot"</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span></span>
<span id="cb8-12"><a href="#cb8-12"></a>    <span class="dt">"lucene_version"</span><span class="fu">:</span> <span class="st">"9.5.0"</span><span class="fu">,</span></span>
<span id="cb8-13"><a href="#cb8-13"></a>    <span class="dt">"minimum_wire_compatibility_version"</span><span class="fu">:</span> <span class="st">"7.17.0"</span><span class="fu">,</span></span>
<span id="cb8-14"><a href="#cb8-14"></a>    <span class="dt">"minimum_index_compatibility_version"</span><span class="fu">:</span> <span class="st">"7.0.0"</span></span>
<span id="cb8-15"><a href="#cb8-15"></a>  <span class="fu">},</span></span>
<span id="cb8-16"><a href="#cb8-16"></a>  <span class="dt">"tagline"</span><span class="fu">:</span> <span class="st">"You Know, for Search"</span></span>
<span id="cb8-17"><a href="#cb8-17"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Next, let’s create a simple FastAPI app, to interact with your cluster.</p>
</section>
<section id="create-a-search-application" class="level2">
<h2 class="anchored" data-anchor-id="create-a-search-application">Create a Search Application</h2>
<p>In this step, you’ll create a simple application to interact with Meditations. You’ll connect to the Elasticsearch cluster, initialize the <a href="https://python.langchain.com/en/latest/modules/chains/index_examples/vector_db_qa.html">Retrieval Questioning/Answering Chain</a>, and create an <code>/ask</code> endpoint that lets the user interact with the app.</p>
<p>Take a look at the code of <code>src/app.py</code>:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1"></a><span class="im">from</span> fastapi <span class="im">import</span> FastAPI</span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="im">from</span> langchain.chains <span class="im">import</span> RetrievalQA</span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="im">from</span> langchain.chat_models <span class="im">import</span> ChatOpenAI</span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="im">from</span> langchain.embeddings.openai <span class="im">import</span> OpenAIEmbeddings</span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="im">from</span> langchain.vectorstores <span class="im">import</span> ElasticVectorSearch</span>
<span id="cb9-6"><a href="#cb9-6"></a></span>
<span id="cb9-7"><a href="#cb9-7"></a><span class="im">from</span> config <span class="im">import</span> openai_api_key</span>
<span id="cb9-8"><a href="#cb9-8"></a></span>
<span id="cb9-9"><a href="#cb9-9"></a>embedding <span class="op">=</span> OpenAIEmbeddings(openai_api_key<span class="op">=</span>openai_api_key)</span>
<span id="cb9-10"><a href="#cb9-10"></a></span>
<span id="cb9-11"><a href="#cb9-11"></a>db <span class="op">=</span> ElasticVectorSearch(</span>
<span id="cb9-12"><a href="#cb9-12"></a>    elasticsearch_url<span class="op">=</span><span class="st">"http://localhost:9200"</span>,</span>
<span id="cb9-13"><a href="#cb9-13"></a>    index_name<span class="op">=</span><span class="st">"elastic-index"</span>,</span>
<span id="cb9-14"><a href="#cb9-14"></a>    embedding<span class="op">=</span>embedding,</span>
<span id="cb9-15"><a href="#cb9-15"></a>)</span>
<span id="cb9-16"><a href="#cb9-16"></a>qa <span class="op">=</span> RetrievalQA.from_chain_type(</span>
<span id="cb9-17"><a href="#cb9-17"></a>    llm<span class="op">=</span>ChatOpenAI(temperature<span class="op">=</span><span class="dv">0</span>),</span>
<span id="cb9-18"><a href="#cb9-18"></a>    chain_type<span class="op">=</span><span class="st">"stuff"</span>,</span>
<span id="cb9-19"><a href="#cb9-19"></a>    retriever<span class="op">=</span>db.as_retriever(),</span>
<span id="cb9-20"><a href="#cb9-20"></a>)</span>
<span id="cb9-21"><a href="#cb9-21"></a></span>
<span id="cb9-22"><a href="#cb9-22"></a>app <span class="op">=</span> FastAPI()</span>
<span id="cb9-23"><a href="#cb9-23"></a></span>
<span id="cb9-24"><a href="#cb9-24"></a></span>
<span id="cb9-25"><a href="#cb9-25"></a><span class="at">@app.get</span>(<span class="st">"/"</span>)</span>
<span id="cb9-26"><a href="#cb9-26"></a><span class="kw">def</span> index():</span>
<span id="cb9-27"><a href="#cb9-27"></a>    <span class="cf">return</span> {</span>
<span id="cb9-28"><a href="#cb9-28"></a>        <span class="st">"message"</span>: <span class="st">"Make a post request to /ask to ask questions about Meditations by Marcus Aurelius"</span></span>
<span id="cb9-29"><a href="#cb9-29"></a>    }</span>
<span id="cb9-30"><a href="#cb9-30"></a></span>
<span id="cb9-31"><a href="#cb9-31"></a></span>
<span id="cb9-32"><a href="#cb9-32"></a><span class="at">@app.post</span>(<span class="st">"/ask"</span>)</span>
<span id="cb9-33"><a href="#cb9-33"></a><span class="kw">def</span> ask(query: <span class="bu">str</span>):</span>
<span id="cb9-34"><a href="#cb9-34"></a>    response <span class="op">=</span> qa.run(query)</span>
<span id="cb9-35"><a href="#cb9-35"></a>    <span class="cf">return</span> {</span>
<span id="cb9-36"><a href="#cb9-36"></a>        <span class="st">"response"</span>: response,</span>
<span id="cb9-37"><a href="#cb9-37"></a>    }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This code lets the user ask questions about Marcus Aurelius’ Meditations and provides answers back to the users. Let me show you how it works:</p>
<ul>
<li><strong>Lines 1 to 5</strong> import the required libraries:
<ul>
<li><strong><code>FastAPI</code></strong>: This class initializes the app.</li>
<li><strong><code>RetrievalQA</code></strong>: This is a <a href="https://python.langchain.com/en/latest/modules/chains.html">chain</a> that allows you to ask questions about documents in a vector database. It finds the most relevant documents based on your question and generates an answer from them.</li>
<li><strong><code>ChatOpenAI</code></strong>: This is a wrapper around OpenAI’s chat models.</li>
<li><strong><code>OpenAIEmbeddings</code></strong> and <strong><code>ElasticVectorSearch</code></strong>: These are the same wrappers discussed in the previous section.</li>
</ul></li>
<li><strong>Line 7</strong> imports the OpenAI secret key.</li>
<li><strong>Lines 9 to 15</strong> initialize the Elasticsearch cluster using OpenAI embeddings.</li>
<li><strong>Lines 16 to 20</strong> initialize the <code>RetrievalQA</code> chain with the following parameters:
<ul>
<li><strong><code>llm</code></strong>: Specifies the LLM used to run prompts defined in the chain.</li>
<li><strong><code>chain_type</code></strong>: Defines how documents are retrieved and processed from the vector database. By specifying <code>stuff</code>, documents will be retrieved and passed to the chain to answer the question as-is. Alternatively, you can use <code>map_reduce</code> or <code>map_rerank</code> for additional processing before answering the question, but these methods use more API calls. For more information, consult <a href="https://docs.langchain.com/docs/components/chains/index_related_chains">the langchain documentation</a>.</li>
<li><strong><code>retriever</code></strong>: Specifies the vector database used by the chain to retrieve documents.</li>
</ul></li>
<li><strong>Lines 22 to 36</strong> initialize the FastAPI app and define two endpoints. The <code>/</code> endpoint provides users with information on how to use the application. The <code>/ask</code> endpoint takes a user’s question (<code>query</code> parameter) and returns an answer using the previously initialized chain.</li>
</ul>
<p>Finally, you can run the app from the terminal (using your virtual environment):</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1"></a><span class="ex">uvicorn</span> app:app <span class="at">--reload</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then, visit <code>http://127.0.0.1:8000/docs</code>, and test <code>/ask</code> by making a question about the book:</p>
<p><img src="images/semantic-search-elasticsearch-openai-langchain/image-13.png" class="img-fluid"></p>
<p>If everything went well, you should get something like this:</p>
<p><img src="images/semantic-search-elasticsearch-openai-langchain/image-14.png" class="img-fluid"></p>
<p>That’s it! You now have your own semantic search service up and running, based on Elasticsearch, OpenAI, Langchain, and FastAPI.</p>
</section>
<section id="going-to-production" class="level2">
<h2 class="anchored" data-anchor-id="going-to-production">Going to Production</h2>
<p>Moving to production can vary greatly for different software products. However, at a minimum, you should:</p>
<ul>
<li>Build appropriate data ingestion and processing pipelines. When adding new data, you generally do not want to rebuild the index, as you did in this tutorial.</li>
<li>Use a production-ready <a href="https://www.elastic.co/pricing/">Elasticsearch-managed instance</a> or a <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docker.html#docker-prod-prerequisites">Docker image</a> optimized for production. The instance used in this tutorial was intended for testing and development purposes only.</li>
<li>Choose a deployment strategy that suits your organization’s needs. For example, I often use <a href="https://dylancastillo.co/fastapi-nginx-gunicorn/">NGINX with Gunicorn and Uvicorn workers</a> for small projects.</li>
</ul>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Way to go! In this tutorial, you’ve learned how to build a semantic search engine using Elasticsearch, OpenAI, and Langchain.</p>
<p>In particular, you’ve learned:</p>
<ul>
<li>How to structure a semantic search service.</li>
<li>How to use LangChain to split and index documents.</li>
<li>How to use Elasticsearch as a vector database with LangChain.</li>
<li>How to use the Retrieval Questioning/Answering Chain to answer questions with a vector database.</li>
<li>What you should consider when productizing this type of application.</li>
</ul>
<p>Hope you found this tutorial useful. Let me know if you have any questions!</p>
<p>All the code for this tutorial is <a href="https://github.com/dylanjcastillo/semantic-search-elasticsearch-openai-langchain">available on GitHub</a>.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2023,
  author = {Castillo, Dylan},
  title = {Semantic {Search} with {Elasticsearch,} {OpenAI,} and
    {LangChain}},
  date = {2023-04-27},
  url = {https://dylancastillo.co/posts/semantic-search-elasticsearch-openai-langchain.html},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2023" class="csl-entry quarto-appendix-citeas" role="listitem">
Castillo, Dylan. 2023. <span>“Semantic Search with Elasticsearch,
OpenAI, and LangChain.”</span> April 27, 2023. <a href="https://dylancastillo.co/posts/semantic-search-elasticsearch-openai-langchain.html">https://dylancastillo.co/posts/semantic-search-elasticsearch-openai-langchain.html</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/dylancastillo\.co");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="dylanjcastillo/blog_comments" issue-term="pathname" theme="dark-blue" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>Copyright 2024, Dylan Castillo</p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>