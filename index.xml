<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Dylan Castillo</title>
<link>https://dylancastillo.co/</link>
<atom:link href="https://dylancastillo.co/index.xml" rel="self" type="application/rss+xml"/>
<description></description>
<image>
<url>https://dylancastillo.co/images/social_media_card.webp</url>
<title>Dylan Castillo</title>
<link>https://dylancastillo.co/</link>
</image>
<generator>quarto-1.7.32</generator>
<lastBuildDate>Fri, 04 Jul 2025 00:00:00 GMT</lastBuildDate>
<item>
  <title>Building ReAct agents with (and without) LangGraph</title>
  <dc:creator>Dylan Castillo</dc:creator>
  <link>https://dylancastillo.co/posts/react-agent-langgraph.html</link>
  <description><![CDATA[ 




<p>As Large Language Models (LLMs) have become more powerful, I’ve started to see increasing interest from clients in building agents.</p>
<p>The problem is that most of the use cases clients have in mind for agents are better suited for <a href="https://dylancastillo.co/posts/agentic-workflows-langgraph.html">agentic workflows</a>. Agents are a good fit for tasks without a predefined path and where the order of steps is not known beforehand. Agentic workflows, on the other hand, are the right choice for tasks where both of these things are known.</p>
<p>In this post, I’ll show you how to build a ReAct agent with (and without) LangGraph.</p>
<p>Let’s start by defining some key concepts.</p>
<section id="what-is-an-agent" class="level2">
<h2 class="anchored" data-anchor-id="what-is-an-agent">What is an agent?</h2>
<p>The biggest players in the ecosystem have converged on similar definitions of what constitutes an “agent.” <a href="https://www.anthropic.com/engineering/building-effective-agents">Anthropic</a> describes them as systems where LLMs “dynamically direct their own processes and tool usage,” while <a href="https://openai.com/index/new-tools-for-building-agents/">OpenAI</a> calls them “systems that independently accomplish tasks on behalf of users.” <a href="https://blog.langchain.com/what-is-an-agent/">LangChain</a> similarly defines them as systems using an LLM to “decide the control flow of an application.”</p>
<p>In essence, agents are systems that can independently make decisions, use tools, take actions, and pursue a goal without direct human guidance. The most well-known agent implementation are <em>ReAct Agents</em>.</p>
</section>
<section id="whats-a-react-agent" class="level2">
<h2 class="anchored" data-anchor-id="whats-a-react-agent">What’s a ReAct agent?</h2>
<p><a href="https://arxiv.org/abs/2210.03629">ReAct (Reasoning and Acting) Agents</a> are AI systems that merge the reasoning of Large Language Models (LLMs) with the ability to perform actions. They follow an iterative “think, act, observe” cycle to solve problems and achieve user goals. For example, a ReAct agent would:</p>
<ol type="1">
<li>Take a user query.</li>
<li>Think about the query and decide on an action.</li>
<li>Execute the action using available tools.</li>
<li>Analyzes the result of that action.</li>
<li>Continues the “Reason, Act, Observe” loop until it reaches the final answer.</li>
</ol>
<p>Here’s a diagram of a ReAct agent:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">graph LR
    Human &lt;--&gt; LLM_Call[LLM Call]
    LLM_Call --&gt;|Action| Environment
    Environment --&gt;|Feedback| LLM_Call
    LLM_Call -.-&gt; Stop
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p>The first generation of ReAct agents used a prompt technique of “Thought, Action, Observation”. Current agents rely on <a href="https://dylancastillo.co/posts/function-calling-structured-outputs.html">function-calling</a> to implement the “think, act, observe” loop.</p>
</section>
<section id="what-is-langgraph" class="level2">
<h2 class="anchored" data-anchor-id="what-is-langgraph">What is LangGraph?</h2>
<p>LangGraph is a graph-based framework for building complex LLM applications, designed for stateful workflows. It makes it easier to build complex agent architectures.</p>
<p>Graphs are composed of nodes, edges, state, and reducers. Nodes are the units of work (functions, tools) and edges define the paths between nodes. State is persistent data passed between nodes and updated through reducers (functions that define how the state is updated).</p>
<p>I like LangGraph because it provides you with easy-to-use components, a simple API, and it lets you visualize your workflow. It also integrates well with LangSmith, a tool for monitoring and debugging LLM applications.</p>
<p>In this tutorial, I’ll show you how to build a ReAct agent with (and without) LangGraph. I’ll also use <em>LangChain</em> as a thin wrapper on top of OpenAI models.</p>
</section>
<section id="prerequisites" class="level2">
<h2 class="anchored" data-anchor-id="prerequisites">Prerequisites</h2>
<p>To follow this tutorial you’ll need to:</p>
<ol type="1">
<li>Sign up and generate an API key in <a href="https://platform.openai.com/docs/overview">OpenAI</a>.</li>
<li>Set the API key as an environment variable called <code>OPENAI_API_KEY</code>.</li>
<li>Create a virtual environment in Python and install the requirements:</li>
</ol>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span> venv venv</span>
<span id="cb1-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">source</span> venv/bin/activate</span>
<span id="cb1-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install langchain langchain-openai langchain-community langgraph jupyter</span></code></pre></div>
<p>Once you’ve completed the steps above, you can run the code from this article. You can also download the notebook from <a href="https://github.com/dylanjcastillo/blog/tree/main/posts/react-agent-langgraph.ipynb">here</a>.</p>
</section>
<section id="implementation" class="level2">
<h2 class="anchored" data-anchor-id="implementation">Implementation</h2>
<p>As usual, you must start by importing the necessary libraries and loading the environment variables. You’ll use the same model in all the examples, so you’ll define it once here:</p>
<div id="cell-4" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Literal</span>
<span id="cb2-2"></span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> requests</span>
<span id="cb2-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb2-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> IPython.display <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Image, display</span>
<span id="cb2-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.messages <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> HumanMessage, SystemMessage, ToolMessage</span>
<span id="cb2-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.tools <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tool</span>
<span id="cb2-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatOpenAI</span>
<span id="cb2-9"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langgraph.graph <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> END, START, MessagesState, StateGraph</span>
<span id="cb2-10"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langgraph.prebuilt <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> create_react_agent</span>
<span id="cb2-11"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langsmith <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> traceable</span>
<span id="cb2-12"></span>
<span id="cb2-13">load_dotenv()</span>
<span id="cb2-14"></span>
<span id="cb2-15">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4.1-mini"</span>, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span></code></pre></div>
</div>
<p>This code:</p>
<ol type="1">
<li>Imports the necessary libraries.</li>
<li>Loads environment variables from a <code>.env</code> file using <code>load_dotenv()</code>.</li>
<li>Defines a model (<code>gpt-4.1-mini</code>) that you’ll use in all the examples.</li>
</ol>
<section id="vanilla-react-agent" class="level3">
<h3 class="anchored" data-anchor-id="vanilla-react-agent">Vanilla ReAct agent</h3>
<p>You’ll build an agent that takes a question from a user and has access to a a tool. The tool is a Python REPL that it can use to answer the question.</p>
<p><strong>You should not use this in production</strong>. This tool can run arbitrary Python code on your device, and that’s not something you want to expose to random people on the internet.</p>
<p>First, let’s define the <code>run_python_code</code> tool.</p>
<div id="cell-8" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@tool</span></span>
<span id="cb3-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> run_python_code(code: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb3-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Run arbitrary Python code including imports, assignments, and statements. Do not use any external libraries. Save your results as a variable.</span></span>
<span id="cb3-4"></span>
<span id="cb3-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb3-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        code: Python code to run</span></span>
<span id="cb3-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb3-8">    <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> sys</span>
<span id="cb3-9">    <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> io <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> StringIO</span>
<span id="cb3-10"></span>
<span id="cb3-11">    old_stdout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sys.stdout</span>
<span id="cb3-12">    sys.stdout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> captured_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> StringIO()</span>
<span id="cb3-13"></span>
<span id="cb3-14">    namespace <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb3-15"></span>
<span id="cb3-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb3-17">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">exec</span>(code, namespace)</span>
<span id="cb3-18"></span>
<span id="cb3-19">        output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> captured_output.getvalue()</span>
<span id="cb3-20"></span>
<span id="cb3-21">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> output.strip():</span>
<span id="cb3-22">            user_vars <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb3-23">                k: v</span>
<span id="cb3-24">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> k, v <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> namespace.items()</span>
<span id="cb3-25">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> k.startswith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"__"</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> k <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"StringIO"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sys"</span>]</span>
<span id="cb3-26">            }</span>
<span id="cb3-27">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> user_vars:</span>
<span id="cb3-28">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(user_vars) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:</span>
<span id="cb3-29">                    output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(user_vars.values())[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb3-30">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb3-31">                    output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(user_vars)</span>
<span id="cb3-32"></span>
<span id="cb3-33">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> output.strip() <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> output.strip() <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Code executed successfully"</span></span>
<span id="cb3-34"></span>
<span id="cb3-35">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb3-36">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Error: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(e)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb3-37">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">finally</span>:</span>
<span id="cb3-38">        sys.stdout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> old_stdout</span>
<span id="cb3-39"></span>
<span id="cb3-40">tools <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [run_python_code]</span>
<span id="cb3-41">tools_mapping <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {tool.name: tool <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> tool <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tools}</span>
<span id="cb3-42">model_with_tools <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.bind_tools(tools)</span></code></pre></div>
</div>
<p>This code defines a tool. In <code>LangChain</code> tools are defined as functions decorated with the <code>@tool</code> decorator. These functions must have a <em>docstring</em> because it will be used to describe the tool to the model.</p>
<p><code>run_python_code</code> is a function that takes a code string and returns the result of executing that code.</p>
<p>Next, you provide the model with a mapping of the tool to its name by creating <code>tools_mapping</code>. This is often a point of confusion. The LLM doesn’t run the tools on its own. It only decides if a tool should be used. Then, your own code must make the actual tool call.</p>
<p>The mapping is more useful when there are multiple tools, and not a single tool, like in this case. However, I’m showing it here to illustrate how you’d usually do this in a real-world application.</p>
<p>Finally, you <em>bind</em> the tool to the model. The binding makes the model aware of the tool, so that it can use it.</p>
<p>Then, let’s define a function that encapsulates the logic of the agent.</p>
<div id="cell-10" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> run_agent(question: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>):</span>
<span id="cb4-2">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb4-3">        SystemMessage(</span>
<span id="cb4-4">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You're a helpful assistant. Use the tools provided when relevant."</span></span>
<span id="cb4-5">        ),</span>
<span id="cb4-6">        HumanMessage(question),</span>
<span id="cb4-7">    ]</span>
<span id="cb4-8">    ai_message <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model_with_tools.invoke(messages)</span>
<span id="cb4-9">    messages.append(ai_message)</span>
<span id="cb4-10"></span>
<span id="cb4-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">while</span> ai_message.tool_calls:</span>
<span id="cb4-12">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> tool_call <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ai_message.tool_calls:</span>
<span id="cb4-13">            selected_tool <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tools_mapping[tool_call[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>]]</span>
<span id="cb4-14">            tool_msg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> selected_tool.invoke(tool_call)</span>
<span id="cb4-15">            messages.append(tool_msg)</span>
<span id="cb4-16">        ai_message <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model_with_tools.invoke(messages)</span>
<span id="cb4-17">        messages.append(ai_message)</span>
<span id="cb4-18"></span>
<span id="cb4-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> messages </span></code></pre></div>
</div>
<p>This function takes a city name and returns the weather for that city. It uses the <code>find_weather</code> tool to get the weather data.</p>
<p>It works as follows:</p>
<ul>
<li><strong>Lines 2 to 9</strong> set up the <a href="https://dylancastillo.co/posts/prompt-engineering-101.html">prompts</a> and call the assistant.</li>
<li><strong>Lines 11 to 17</strong> is where the magic happens. This is a loop that will check if there’s been a tool call in the response from the model. If there is, it will call (invoke) the tool and add the result to the messages. It will then send the results back to the assistant, and repeat this process until there are no more tool calls.</li>
</ul>
<p>This is the core idea behind how agents work. You provide the assistant with a question and one or more tools. Then you let the assistant decide which tool to use, until it has all the information it needs to answer the question.</p>
<p>You can try it out by running the following code:</p>
<div id="cell-12" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1">messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> run_agent(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Generate 10 random numbers between 1 and 100"</span>)</span>
<span id="cb5-2"></span>
<span id="cb5-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> m <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> messages:</span>
<span id="cb5-4">    m.pretty_print()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<div class="ansi-escaped-output">
<pre>================================<span class="ansi-bold"> System Message </span>================================



You're a helpful assistant. Use the tools provided when relevant.

================================<span class="ansi-bold"> Human Message </span>=================================



Generate 10 random numbers between 1 and 100

==================================<span class="ansi-bold"> Ai Message </span>==================================

Tool Calls:

  run_python_code (call_4W42twIzLEUpd8ap7xGbTkiF)

 Call ID: call_4W42twIzLEUpd8ap7xGbTkiF

  Args:

    code: import random

random_numbers = [random.randint(1, 100) for _ in range(10)]

random_numbers

=================================<span class="ansi-bold"> Tool Message </span>=================================

Name: run_python_code



{'random': &lt;module 'random' from '/opt/homebrew/Cellar/python@3.13/3.13.2/Frameworks/Python.framework/Versions/3.13/lib/python3.13/random.py'&gt;, 'random_numbers': [37, 60, 8, 58, 7, 12, 39, 4, 77, 39]}

==================================<span class="ansi-bold"> Ai Message </span>==================================



Here are 10 random numbers between 1 and 100: 37, 60, 8, 58, 7, 12, 39, 4, 77, 39.
</pre>
</div>
</div>
</div>
<p>You can see that the agent took the user’s request, used the <code>run_python_code</code> tool to generate the numbers, and then returned the result.</p>
<p>Now, let’s see how you can build a ReAct agent with LangGraph.</p>
</section>
<section id="langgraph-react-agent" class="level3">
<h3 class="anchored" data-anchor-id="langgraph-react-agent">LangGraph ReAct agent</h3>
<p>Like, in the previous example, you start by defining the tools you want to use. You’ll use the same <code>run_python_code</code> tool.</p>
<div id="cell-16" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@tool</span></span>
<span id="cb6-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> run_python_code(code: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb6-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Run arbitrary Python code including imports, assignments, and statements. Do not use any external libraries. Save your results as a variable.</span></span>
<span id="cb6-4"></span>
<span id="cb6-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb6-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        code: Python code to run</span></span>
<span id="cb6-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb6-8">    <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> sys</span>
<span id="cb6-9">    <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> io <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> StringIO</span>
<span id="cb6-10"></span>
<span id="cb6-11">    old_stdout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sys.stdout</span>
<span id="cb6-12">    sys.stdout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> captured_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> StringIO()</span>
<span id="cb6-13"></span>
<span id="cb6-14">    namespace <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb6-15"></span>
<span id="cb6-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb6-17">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">exec</span>(code, namespace)</span>
<span id="cb6-18"></span>
<span id="cb6-19">        output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> captured_output.getvalue()</span>
<span id="cb6-20"></span>
<span id="cb6-21">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> output.strip():</span>
<span id="cb6-22">            user_vars <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb6-23">                k: v</span>
<span id="cb6-24">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> k, v <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> namespace.items()</span>
<span id="cb6-25">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> k.startswith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"__"</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> k <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"StringIO"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sys"</span>]</span>
<span id="cb6-26">            }</span>
<span id="cb6-27">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> user_vars:</span>
<span id="cb6-28">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(user_vars) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:</span>
<span id="cb6-29">                    output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(user_vars.values())[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb6-30">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb6-31">                    output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(user_vars)</span>
<span id="cb6-32"></span>
<span id="cb6-33">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> output.strip() <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> output.strip() <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Code executed successfully"</span></span>
<span id="cb6-34"></span>
<span id="cb6-35">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb6-36">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Error: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(e)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb6-37">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">finally</span>:</span>
<span id="cb6-38">        sys.stdout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> old_stdout</span>
<span id="cb6-39"></span>
<span id="cb6-40"></span>
<span id="cb6-41">tools <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [run_python_code]</span>
<span id="cb6-42">tools_by_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {tool.name: tool <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> tool <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tools}</span>
<span id="cb6-43">model_with_tools <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.bind_tools(tools)</span></code></pre></div>
</div>
<p>With langgraph you also need to you define the tools in the same way: set up the functions, add the <code>@tool</code> decorator, and create the mapping. Then, <em>bind</em> the tools to the model.</p>
<p>Next, you need to define the functions (nodes) that correspond to the steps the agent will take:</p>
<div id="cell-18" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> llm_call(state: MessagesState):</span>
<span id="cb7-2">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb7-3">        SystemMessage(content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are a helpful assistant that can run python code."</span>),</span>
<span id="cb7-4">    ] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"messages"</span>]</span>
<span id="cb7-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"messages"</span>: [model_with_tools.invoke(messages)]}</span>
<span id="cb7-6"></span>
<span id="cb7-7"></span>
<span id="cb7-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> tool_node(state: MessagesState):</span>
<span id="cb7-9">    result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb7-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> tool_call <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"messages"</span>][<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].tool_calls:</span>
<span id="cb7-11">        tool <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tools_by_name[tool_call[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>]]</span>
<span id="cb7-12">        observation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tool.invoke(tool_call[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"args"</span>])</span>
<span id="cb7-13">        result.append(ToolMessage(content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>observation, tool_call_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tool_call[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>]))</span>
<span id="cb7-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"messages"</span>: result}</span>
<span id="cb7-15"></span>
<span id="cb7-16"></span>
<span id="cb7-17"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> should_continue(state: MessagesState) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Literal[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"environment"</span>, END]:</span>
<span id="cb7-18">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"messages"</span>]</span>
<span id="cb7-19">    last_message <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> messages[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb7-20">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> last_message.tool_calls:</span>
<span id="cb7-21">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Action"</span></span>
<span id="cb7-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> END</span></code></pre></div>
</div>
<p>This is how it works:</p>
<ol type="1">
<li><code>llm_call</code>: Sends the conversation history to the LLM to get the next response.</li>
<li><code>tool_node</code>: If the LLM’s response is a request to use a tool, this function executes the tool with the specified arguments.</li>
<li><code>should_continue</code>: This is the control logic. It checks the LLM’s last message. If it’s a tool request, it routes to the tool_node; otherwise, it ends the conversation.</li>
</ol>
<p><code>llm_call</code> and <code>tool_node</code> take <code>MessagesState</code> as input and return a the message key with the new message. This updates the <code>messages</code> key in the <code>MessagesState</code>. <code>should_continue</code> takes <code>MessagesState</code> act as a router, so it decides if a tool should be executed or if the conversation should end.</p>
<div id="cell-20" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1">agent_builder <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> StateGraph(MessagesState)</span>
<span id="cb8-2"></span>
<span id="cb8-3">agent_builder.add_node(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"llm_call"</span>, llm_call)</span>
<span id="cb8-4">agent_builder.add_node(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"environment"</span>, tool_node)</span>
<span id="cb8-5"></span>
<span id="cb8-6">agent_builder.add_edge(START, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"llm_call"</span>)</span>
<span id="cb8-7">agent_builder.add_conditional_edges(</span>
<span id="cb8-8">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"llm_call"</span>,</span>
<span id="cb8-9">    should_continue,</span>
<span id="cb8-10">    {</span>
<span id="cb8-11">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Action"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"environment"</span>,</span>
<span id="cb8-12">        END: END,</span>
<span id="cb8-13">    },</span>
<span id="cb8-14">)</span>
<span id="cb8-15">agent_builder.add_edge(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"environment"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"llm_call"</span>)</span>
<span id="cb8-16"></span>
<span id="cb8-17">agent <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> agent_builder.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">compile</span>()</span></code></pre></div>
</div>
<p>This code sets up the logic of the agent. It starts with a call to the LLM. The LLM then decides whether to use a tool or to finish the task. If it uses a tool, the tool’s output is sent back to the LLM for the next step. This “think-act” loop continues until the agent decides the task is complete.</p>
<p>You can use <code>LangGraph</code> to visualize the agent’s flow:</p>
<div id="cell-22" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1">display(Image(agent.get_graph(xray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>).draw_mermaid_png()))</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="react-agent-langgraph_files/figure-html/cell-9-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="https://dylancastillo.co/posts/react-agent-langgraph_files/figure-html/cell-9-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Finally, you can run the agent by invoking the graph. For that, you’ll need to pass a list of messages to the graph.</p>
<div id="cell-24" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1">messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb10-2">    SystemMessage(content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are a helpful assistant that can run python code."</span>),</span>
<span id="cb10-3">    HumanMessage(content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Generate 10 random numbers between 1 and 100"</span>)</span>
<span id="cb10-4">]</span>
<span id="cb10-5"></span>
<span id="cb10-6">messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> agent.invoke({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"messages"</span>: messages})</span></code></pre></div>
</div>
<p>You can review the process by printing the messages:</p>
<div id="cell-26" class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> m <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> messages[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"messages"</span>]:</span>
<span id="cb11-2">    m.pretty_print()</span></code></pre></div>
</div>
<p>That’s all!</p>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>In this tutorial, you’ve learned what are agents, how they work, and how to build a simple ReAct agent with and without LangGraph. We covered:</p>
<ul>
<li><strong>Agent fundamentals</strong>: How agents differ from traditional systems by dynamically directing their own processes</li>
<li><strong>ReAct pattern</strong>: The core “think, act, observe” loop that enables agents to take actions based on the information they have</li>
<li><strong>Vanilla and LangGraph implementation</strong>: Understanding how to implement agents with and without LangGraph</li>
</ul>
<p>Agents are great for open-ended tasks where the path isn’t predetermined. If you’re working on one of those, this article provides a good starting point. On the other hand, for tasks that have predefined steps, consider <a href="https://dylancastillo.co/posts/agentic-workflows-langgraph.html">agentic workflows</a> instead.</p>
<p>Hope you find this tutorial useful. If you have any questions, let me know in the comments below.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2025,
  author = {Castillo, Dylan},
  title = {Building {ReAct} Agents with (and Without) {LangGraph}},
  date = {2025-07-04},
  url = {https://dylancastillo.co/posts/react-agent-langgraph.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2025" class="csl-entry quarto-appendix-citeas">
Castillo, Dylan. 2025. <span>“Building ReAct Agents with (and Without)
LangGraph.”</span> July 4, 2025. <a href="https://dylancastillo.co/posts/react-agent-langgraph.html">https://dylancastillo.co/posts/react-agent-langgraph.html</a>.
</div></div></section></div> ]]></description>
  <category>llm</category>
  <category>python</category>
  <category>anthropic</category>
  <category>openai</category>
  <category>agents</category>
  <guid>https://dylancastillo.co/posts/react-agent-langgraph.html</guid>
  <pubDate>Fri, 04 Jul 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Agentic workflows from scratch with (and without) LangGraph</title>
  <dc:creator>Dylan Castillo</dc:creator>
  <link>https://dylancastillo.co/posts/agentic-workflows-langgraph.html</link>
  <description><![CDATA[ 




<p>These days, everyone is “building” agents. But, in my experience, they’re either not really building agents, or they shouldn’t be!</p>
<p>Agents are powerful tools, but they’re not the right tool for many business problems. They give a lot of responsibility to LLMs, and that’s not always a good idea.</p>
<p>Their counterpart, agentic workflows, are a more controlled way to use LLMs. They’re a good fit for many business problems, and they’re a lot easier to build than agents.</p>
<p>In this post, I’ll explain what an agent is, what an agentic workflow is, and how to choose between them. I’ll also show you how to build the most common agentic workflows.</p>
<p>This post is based on <a href="https://www.anthropic.com/engineering/building-effective-agents">Anthropic’s Building Effective Agents</a>. I encourage you to read it.</p>
<section id="what-is-an-agent" class="level2">
<h2 class="anchored" data-anchor-id="what-is-an-agent">What is an agent?</h2>
<p>Over time, the ecosystem has converged on similar definitions:</p>
<p>Anthropic’s definition:</p>
<blockquote class="blockquote">
<p>“Systems where LLMs dynamically direct their own processes and tool usage, maintaining control over how they accomplish tasks.”</p>
<p><a href="https://www.anthropic.com/engineering/building-effective-agents">Building Effective Agents</a>, Anthropic</p>
</blockquote>
<p>OpenAI’s definition:</p>
<blockquote class="blockquote">
<p>“Systems that independently accomplish tasks on behalf of users”</p>
<p><a href="https://openai.com/index/new-tools-for-building-agents/">New tools for building agents</a>, OpenAI</p>
</blockquote>
<p>LangChain’s definition:</p>
<blockquote class="blockquote">
<p>“system that uses an LLM to decide the control flow of an application.”</p>
<p><a href="https://blog.langchain.com/what-is-an-agent/">What is an agent?</a>, LangChain</p>
</blockquote>
<p>These definitions share the idea that agents are systems that can:</p>
<ol type="1">
<li>Make decisions</li>
<li>Use tools</li>
<li>Take actions</li>
<li>Accomplish goals without constant human guidance</li>
</ol>
<p>This gives us a clear delimiter as to what an agent is and what it is not. However, this definition leaves out the majority of agentic systems being build by companies right now. These systems are called <strong>agentic workflows</strong>.</p>
</section>
<section id="what-is-an-agentic-workflow" class="level2">
<h2 class="anchored" data-anchor-id="what-is-an-agentic-workflow">What is an agentic workflow?</h2>
<p>Anthropic defines agentic workflows as systems where “LLMs and tools are orchestrated through predefined code paths”. They’re different from agents in that they don’t have the ability to dynamically direct their own processes and tool usage.</p>
<p>Workflows sound less sexy than agents, so you would rarely hear someone say they’re building workflows. However, in my experience, most people are (or should be) building workflows.</p>
</section>
<section id="how-to-choose-between-agentic-workflows-and-agents" class="level2">
<h2 class="anchored" data-anchor-id="how-to-choose-between-agentic-workflows-and-agents">How to choose between agentic workflows and agents?</h2>
<p>Choose agents for open-ended tasks where the number and the order of steps is not known beforehand. The LLM will potentially operate for many turns, and you must have some level of trust in its decision-making.</p>
<p>For example, a coding assistant is a good candidate for an agent. When you ask it to implement a feature, there’s no predefined path nor the order of steps is known beforehand. It might need to create files, add new dependencies, edit existing files, etc.</p>
<p>Agentic workflows make sense for tasks where the number and the order of steps is known beforehand. For example, an AI assistant that generates an initial draft of an article based on internal data sources. The order of steps are likely known beforehand (e.g., retrieve the key information from the internal data sources, generate a first candidate, and then revise the article).</p>
</section>
<section id="what-is-langgraph" class="level2">
<h2 class="anchored" data-anchor-id="what-is-langgraph">What is LangGraph?</h2>
<p>LangGraph is a graph-based framework for building complex LLM applications, designed for stateful workflows. It enables complex agent architectures with minimal code.</p>
<p>It uses a graph-based approach to build agentic systems. The graph is composed of nodes and edges. Nodes are the units of work (functions, tools, models). Edges define the workflow paths between nodes. State is persistent data passed between nodes and updated through reducers.</p>
<p>I’ve built many workflows from scratch, and I’ve realized that I often end up reinventing the same patterns that frameworks like LangGraph provide. I like LangGraph because it provides you with easy-to-use components, a simple API, and it lets you visualize your workflow. It also integrates well with LangSmith, a tool for monitoring and debugging LLM applications.</p>
<p>In this tutorial, I’ll show you how to build common agentic workflows with and without LangGraph. I’ll use <em>LangChain</em> as a thin wrapper on top of OpenAI models.</p>
</section>
<section id="prerequisites" class="level2">
<h2 class="anchored" data-anchor-id="prerequisites">Prerequisites</h2>
<p>To follow this tutorial you’ll need to:</p>
<ol type="1">
<li>Sign up and generate an API key in <a href="https://platform.openai.com/docs/overview">OpenAI</a>.</li>
<li>Set the API key as an environment variable called <code>OPENAI_API_KEY</code>.</li>
<li>Create a virtual environment in Python and install the requirements:</li>
</ol>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span> venv venv</span>
<span id="cb1-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">source</span> venv/bin/activate</span>
<span id="cb1-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install langchain langchain-openai langchain-community langgraph jupyter nest_asyncio</span></code></pre></div>
<p>Once you’ve completed the steps above, you can run the code from this article. You can also download the notebook from <a href="https://github.com/dylanjcastillo/blog/tree/main/posts/agentic-workflows-langgraph-pyndantic-ai.ipynb">here</a>.</p>
<p>You also need to apply a small patch to make sure you can run asyncio inside the notebook:</p>
<div id="cell-2" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> nest_asyncio</span>
<span id="cb2-2"></span>
<span id="cb2-3">nest_asyncio.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>()</span></code></pre></div>
</div>
<p>You will use <code>asyncio</code> inside the notebook, so you need to install and apply <code>nest_asyncio</code>. Otherwise, you’ll get a <code>RuntimeError</code> when running the code.</p>
</section>
<section id="workflows" class="level2">
<h2 class="anchored" data-anchor-id="workflows">Workflows</h2>
<p>As usual, you must start by importing the necessary libraries and loading the environment variables. You’ll use the same model in all the examples, so you’ll define it once here:</p>
<div id="cell-6" class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> asyncio</span>
<span id="cb3-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> operator</span>
<span id="cb3-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Annotated, Literal, Optional, TypedDict</span>
<span id="cb3-4"></span>
<span id="cb3-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb3-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> IPython.display <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Image, display</span>
<span id="cb3-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.messages <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> HumanMessage, SystemMessage</span>
<span id="cb3-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatOpenAI</span>
<span id="cb3-9"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langgraph.graph <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> END, START, StateGraph</span>
<span id="cb3-10"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langgraph.types <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Send</span>
<span id="cb3-11"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pydantic <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> BaseModel, Field</span>
<span id="cb3-12"></span>
<span id="cb3-13">load_dotenv()</span>
<span id="cb3-14"></span>
<span id="cb3-15">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4.1-mini"</span>)</span></code></pre></div>
</div>
<p>This code imports the necessary libraries for building agentic workflows:</p>
<ul>
<li><strong>LangChain</strong>: For working with LLMs, messages, and structured outputs</li>
<li><strong>LangGraph</strong>: For building stateful workflows with nodes and edges</li>
<li><strong>Pydantic</strong>: For data validation and structured data models</li>
</ul>
<p>The <code>load_dotenv()</code> function loads environment variables from a <code>.env</code> file, including your OpenAI API key. You also define model (<code>gpt-4.1-mini</code>) that you’ll use in all the examples.</p>
<section id="prompt-chaining" class="level3">
<h3 class="anchored" data-anchor-id="prompt-chaining">Prompt chaining</h3>
<p>This workflow is designed for tasks that can be easily divided into subtasks. The key trade-off is accepting longer completion times (higher latency) in exchange for a higher-quality result.</p>
<p><strong>Examples:</strong></p>
<ul>
<li>Generating content in a pipeline by generating table of contents, content, revisions, translations, etc.</li>
<li>Generating a text through a multi-step process to evaluate if it matches certain criteria</li>
</ul>
<p>Now I’ll show you how to implement a prompt chaining workflow for generating an article. The workflow will be composed of three steps:</p>
<ol type="1">
<li>Generate a table of contents for the article</li>
<li>Generate the content of the article</li>
<li>Revise the content of the article if it’s too long</li>
</ol>
<p>I’ll show you a vanilla implementation and then a LangGraph implementation.</p>
<section id="vanilla-langchain" class="level4">
<h4 class="anchored" data-anchor-id="vanilla-langchain">Vanilla (+LangChain)</h4>
<p>First, you need to define the state of the workflow and a model to use for the LLM. You’ll use Pydantic for the state and LangChain for the model.</p>
<div id="cell-11" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> State(BaseModel):</span>
<span id="cb4-2">    topic: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb4-3">    table_of_contents: Optional[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb4-4">    content: Optional[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb4-5">    revised_content: Optional[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span></code></pre></div>
</div>
<p>Then, you need to define the functions that will be used in the workflow:</p>
<div id="cell-13" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> generate_table_of_contents(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb5-2">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb5-3">        SystemMessage(</span>
<span id="cb5-4">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer specialized in SEO. Provided with a topic, you will generate the table of contents for a short article."</span></span>
<span id="cb5-5">        ),</span>
<span id="cb5-6">        HumanMessage(</span>
<span id="cb5-7">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Generate the table of contents of an article about </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>topic<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb5-8">        ),</span>
<span id="cb5-9">    ]</span>
<span id="cb5-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> model.invoke(messages).content</span>
<span id="cb5-11"></span>
<span id="cb5-12"></span>
<span id="cb5-13"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> generate_article_content(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb5-14">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb5-15">        SystemMessage(</span>
<span id="cb5-16">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer specialized in SEO. Provided with a topic and a table of contents, you will generate the content of the article."</span></span>
<span id="cb5-17">        ),</span>
<span id="cb5-18">        HumanMessage(</span>
<span id="cb5-19">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Generate the content of an article about </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>topic<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> with the following table of contents: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>table_of_contents<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb5-20">        ),</span>
<span id="cb5-21">    ]</span>
<span id="cb5-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> model.invoke(messages).content</span>
<span id="cb5-23"></span>
<span id="cb5-24"></span>
<span id="cb5-25"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> revise_article_content(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb5-26">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb5-27">        SystemMessage(</span>
<span id="cb5-28">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer specialized in SEO. Provided with a topic, a table of contents and a content, you will revise the content of the article to make it less than 1000 characters."</span></span>
<span id="cb5-29">        ),</span>
<span id="cb5-30">        HumanMessage(</span>
<span id="cb5-31">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Revise the content of an article about </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>topic<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> with the following table of contents: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>table_of_contents<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> and the following content:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>content<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb5-32">        ),</span>
<span id="cb5-33">    ]</span>
<span id="cb5-34">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> model.invoke(messages).content</span></code></pre></div>
</div>
<p>These functions provide the core functionality of the workflow. They follow the steps I outlined above:</p>
<ol type="1">
<li><code>generate_table_of_contents</code>: Generate a table of contents for the article</li>
<li><code>generate_article_content</code>: Generate the content of the article</li>
<li><code>revise_article_content</code>: Revise the content of the article if it’s too long</li>
</ol>
<p>Then we need to orchestrate the workflow. You’ll do that by creating a function that takes a topic and returns the final article.</p>
<div id="cell-15" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> run_workflow(topic: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> State:</span>
<span id="cb6-2">    article <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> State(topic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>topic)</span>
<span id="cb6-3">    article.table_of_contents <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> generate_table_of_contents(article)</span>
<span id="cb6-4">    article.content <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> generate_article_content(article)</span>
<span id="cb6-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(article.content) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>:</span>
<span id="cb6-6">        article.revised_content <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> revise_article_content(article)</span>
<span id="cb6-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> article</span>
<span id="cb6-8"></span>
<span id="cb6-9"></span>
<span id="cb6-10">output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> run_workflow(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Artificial Intelligence"</span>)</span></code></pre></div>
</div>
<p><code>run_workflow</code> takes the topic provided by the user, generates an article, and verifies that it’s below 1000 characters. Depending on the result, it will revise the article or not. Finally, it returns the state that contains all the results from the workflow (the table of contents, the content, and the revised content).</p>
</section>
<section id="langgraph" class="level4">
<h4 class="anchored" data-anchor-id="langgraph">LangGraph</h4>
<p>Now let’s see how to implement the same workflow using LangGraph. You will noticed two key differences compared to the vanilla implementation.</p>
<p>Similar to the vanilla implementation, you’ll start by initializing the state class:</p>
<div id="cell-19" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> State(TypedDict):</span>
<span id="cb7-2">    topic: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb7-3">    table_of_contents: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb7-4">    content: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb7-5">    revised_content: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span></code></pre></div>
</div>
<p>When working with LangGraph, I’d suggest to use a <code>TypedDict</code> to manage your state. Using a Pydantic model to manage your state in LangGraph has a few downsides:</p>
<ol type="1">
<li>Data types are only checked when they enter a node, not when they exit. This means you could accidentally save data of the wrong type to your state.</li>
<li>The final output of the entire graph will be a dictionary, not your Pydantic model.</li>
<li>The implementation feels like it’s <a href="https://github.com/langchain-ai/langgraph/discussions/1306">half-baked</a>.</li>
</ol>
<p>For more details, check out the <a href="https://langchain-ai.github.io/langgraph/how-tos/graph-api/#use-pydantic-models-for-graph-state">LangGraph documentation</a>.</p>
<p>Then, you’ll define the nodes (functions) that will be used in the workflow.</p>
<div id="cell-21" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> generate_table_of_contents(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>:</span>
<span id="cb8-2">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb8-3">        SystemMessage(</span>
<span id="cb8-4">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer specialized in SEO. Provided with a topic, you will generate the table of contents for a short article."</span></span>
<span id="cb8-5">        ),</span>
<span id="cb8-6">        HumanMessage(</span>
<span id="cb8-7">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Generate the table of contents of an article about </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'topic'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb8-8">        ),</span>
<span id="cb8-9">    ]</span>
<span id="cb8-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"table_of_contents"</span>: model.invoke(messages).content}</span>
<span id="cb8-11"></span>
<span id="cb8-12"></span>
<span id="cb8-13"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> generate_article_content(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb8-14">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb8-15">        SystemMessage(</span>
<span id="cb8-16">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer specialized in SEO. Provided with a topic and a table of contents, you will generate the content of the article."</span></span>
<span id="cb8-17">        ),</span>
<span id="cb8-18">        HumanMessage(</span>
<span id="cb8-19">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Generate the content of an article about </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'topic'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> with the following table of contents: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'table_of_contents'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb8-20">        ),</span>
<span id="cb8-21">    ]</span>
<span id="cb8-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: model.invoke(messages).content}</span>
<span id="cb8-23"></span>
<span id="cb8-24"></span>
<span id="cb8-25"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> check_article_content(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb8-26">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>:</span>
<span id="cb8-27">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Fail"</span></span>
<span id="cb8-28">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Pass"</span></span>
<span id="cb8-29"></span>
<span id="cb8-30"></span>
<span id="cb8-31"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> revise_article_content(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb8-32">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb8-33">        SystemMessage(</span>
<span id="cb8-34">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer specialized in SEO. Provided with a topic, a table of contents and a content, you will revise the content of the article to make it less than 1000 characters."</span></span>
<span id="cb8-35">        ),</span>
<span id="cb8-36">        HumanMessage(</span>
<span id="cb8-37">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Revise the content of an article about </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'topic'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> with the following table of contents: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'table_of_contents'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> and the following content:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'content'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb8-38">        ),</span>
<span id="cb8-39">    ]</span>
<span id="cb8-40">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"revised_content"</span>: model.invoke(messages).content}</span></code></pre></div>
</div>
<p>You’ll noticed that the functions are quite similar to the vanilla implementation. The only difference is that they return dictionaries that automatically update the state rather than you having to do it manually.</p>
<p>Then you need to specify the nodes and edges of the workflow:</p>
<div id="cell-23" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1">workflow_builder <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> StateGraph(State)</span>
<span id="cb9-2"></span>
<span id="cb9-3">workflow_builder.add_node(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_table_of_contents"</span>, generate_table_of_contents)</span>
<span id="cb9-4">workflow_builder.add_node(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_article_content"</span>, generate_article_content)</span>
<span id="cb9-5">workflow_builder.add_node(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"revise_article_content"</span>, revise_article_content)</span>
<span id="cb9-6"></span>
<span id="cb9-7">workflow_builder.add_edge(START, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_table_of_contents"</span>)</span>
<span id="cb9-8">workflow_builder.add_edge(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_table_of_contents"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_article_content"</span>)</span>
<span id="cb9-9">workflow_builder.add_conditional_edges(</span>
<span id="cb9-10">    source<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_article_content"</span>,</span>
<span id="cb9-11">    path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>check_article_content,</span>
<span id="cb9-12">    path_map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Fail"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"revise_article_content"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Pass"</span>: END},</span>
<span id="cb9-13">)</span>
<span id="cb9-14">workflow_builder.add_edge(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"revise_article_content"</span>, END)</span>
<span id="cb9-15"></span>
<span id="cb9-16">workflow <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> workflow_builder.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">compile</span>()</span></code></pre></div>
</div>
<p>You initialize a <code>StateGraph</code> object, which is a builder for the workflow. Then you add nodes to the graph, and define the edges between them. The nodes in the graphs are the functions that you defined earlier. In the conditional edge, you can define the path that the workflow will take based on the state of the workflow.</p>
<p>The <code>compile</code> method is used to compile the graph into a callable workflow.</p>
<p>Finally, LangGraph has a nice feature that allows you to visualize the workflow. You can use the <code>get_graph</code> and <code>draw_mermaid_png</code> for that:</p>
<div id="cell-25" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1">display(Image(workflow.get_graph().draw_mermaid_png()))</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="agentic-workflows-langgraph_files/figure-html/cell-10-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="https://dylancastillo.co/posts/agentic-workflows-langgraph_files/figure-html/cell-10-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Finally, you can run the workflow by calling the <code>invoke</code> method on the compiled workflow and provide the initial state.</p>
<div id="cell-27" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1">article <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> workflow.invoke({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"topic"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Artificial Intelligence"</span>})</span></code></pre></div>
</div>
<p>And you’ll get the following output:</p>
<div id="cell-29" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1">article</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>{'topic': 'Artificial Intelligence',
 'table_of_contents': 'Table of Contents\n\n1. Introduction to Artificial Intelligence  \n2. History and Evolution of AI  \n3. Types of Artificial Intelligence  \n4. Applications of AI in Various Industries  \n5. Benefits of Artificial Intelligence  \n6. Challenges and Ethical Considerations  \n7. The Future of Artificial Intelligence  \n8. Conclusion',
 'content': '# Artificial Intelligence: Transforming the Future\n\n## 1. Introduction to Artificial Intelligence\n\nArtificial Intelligence (AI) refers to the simulation of human intelligence processes by machines, especially computer systems. These processes include learning, reasoning, problem-solving, perception, and language understanding. AI enables machines to perform tasks that typically require human intelligence, making them smarter, more efficient, and capable of handling complex scenarios. From virtual assistants and recommendation systems to autonomous vehicles, AI has become an integral part of modern technology.\n\n## 2. History and Evolution of AI\n\nThe concept of artificial intelligence dates back to the mid-20th century. In 1956, the term “Artificial Intelligence” was coined during the Dartmouth Conference, marking the official birth of AI as a research field. Early AI research focused on symbolic methods and rule-based systems. Over the decades, advancements in algorithms, computational power, and data availability propelled AI development. Notable milestones include the creation of expert systems in the 1970s and 1980s, the rise of machine learning in the 1990s, and the advent of deep learning in the 2010s. Today, AI continues to evolve rapidly, driven by breakthroughs in neural networks and big data analytics.\n\n## 3. Types of Artificial Intelligence\n\nAI can be broadly categorized into three types based on capabilities:\n\n- **Narrow AI (Weak AI):** Designed to perform specific tasks such as voice recognition or image classification. This is the most common form of AI today.\n  \n- **General AI (Strong AI):** A theoretical form of AI that possesses the ability to understand, learn, and perform any intellectual task a human can do.\n  \n- **Superintelligent AI:** A hypothetical AI that surpasses all human intelligence across all fields, potentially possessing self-awareness and superior problem-solving abilities.\n\nAdditionally, AI can be classified based on functionalities such as reactive machines, limited memory systems, theory of mind AI, and self-aware AI, reflecting increasing complexity and cognitive capability.\n\n## 4. Applications of AI in Various Industries\n\nAI is transforming industries worldwide by streamlining operations, enhancing decision-making, and enabling innovation:\n\n- **Healthcare:** AI assists in diagnostics, personalized treatment, drug discovery, and robotic surgery.\n- **Finance:** Fraud detection, algorithmic trading, customer support, and risk management benefit from AI solutions.\n- **Retail:** AI powers recommendation engines, inventory management, and customer behavior analysis.\n- **Manufacturing:** Predictive maintenance, quality control, and automation improve efficiency.\n- **Transportation:** Autonomous vehicles, route optimization, and traffic management leverage AI technologies.\n- **Education:** Personalized learning experiences, automated grading, and virtual tutors utilize AI capabilities.\n\n## 5. Benefits of Artificial Intelligence\n\nThe adoption of AI provides numerous advantages:\n\n- **Efficiency:** Automates repetitive tasks, reducing time and labor costs.\n- **Accuracy:** Minimizes human error and enhances precision in complex processes.\n- **Data Insights:** Analyzes vast datasets to uncover trends, patterns, and actionable insights.\n- **Innovation:** Facilitates the creation of new products and services.\n- **Personalization:** Tailors experiences and recommendations to individual preferences.\n- **Accessibility:** Makes services more accessible through natural language processing and intelligent interfaces.\n\n## 6. Challenges and Ethical Considerations\n\nDespite its promise, AI poses several challenges and ethical dilemmas:\n\n- **Bias and Fairness:** AI systems can inherit biases from training data, leading to unfair outcomes.\n- **Privacy Concerns:** Extensive data collection raises issues about user privacy and data security.\n- **Job Displacement:** Automation may disrupt labor markets and professions.\n- **Transparency:** Many AI algorithms, especially deep learning models, lack interpretability.\n- **Accountability:** Determining responsibility in the case of AI failures or misuse is complex.\n- **Ethical Use:** Ensuring AI is used for beneficial purposes and preventing misuse such as in autonomous weapons is critical.\n\nAddressing these concerns requires robust governance, regulation, and ongoing dialogue between stakeholders.\n\n## 7. The Future of Artificial Intelligence\n\nThe future of AI is poised to reshape society profoundly:\n\n- **Enhanced Human-AI Collaboration:** AI will increasingly augment human capabilities rather than replace them.\n- **Advancements in General AI:** Research continues toward achieving more versatile, human-like AI.\n- **AI in Creativity:** Emerging AI tools will enhance creative processes in art, music, and writing.\n- **Integration with IoT:** AI combined with the Internet of Things will enable smarter environments and cities.\n- **Ethical AI Development:** Emphasis will grow on developing transparent, fair, and accountable AI systems.\n- **AI for Global Challenges:** AI will play a pivotal role in addressing climate change, healthcare crises, and education gaps.\n\nContinued innovation, balanced with ethical considerations, will ensure AI’s positive impact on humanity.\n\n## 8. Conclusion\n\nArtificial Intelligence has evolved from a conceptual idea to a transformative force across industries and societies. Its ability to process information, learn, and make decisions holds tremendous potential to improve lives and drive progress. However, realizing this potential requires careful management of ethical challenges and inclusive development. As AI continues to mature, it promises a future where intelligent machines and humans work collaboratively to solve complex problems and create new opportunities. Embracing AI responsibly will be key to unlocking its benefits for generations to come.',
 'revised_content': 'Artificial Intelligence (AI) simulates human intelligence in machines, enabling tasks like learning, reasoning, and problem-solving. Since its inception at the 1956 Dartmouth Conference, AI has evolved from rule-based systems to advanced machine learning and deep learning models. AI types include Narrow AI, designed for specific tasks; General AI, capable of human-like understanding; and Superintelligent AI, a hypothetical superior intellect. AI revolutionizes industries—improving healthcare diagnostics, financial fraud detection, retail personalization, manufacturing automation, transportation logistics, and education. Benefits include efficiency, accuracy, data-driven insights, innovation, and personalization. However, AI raises challenges such as bias, privacy, job displacement, transparency, and ethical use. The future promises enhanced human-AI collaboration, ethical development, and AI-driven solutions for global issues. Responsible AI integration will transform society, fostering progress and innovation.'}</code></pre>
</div>
</div>
<p>That’s it for prompt chaining. Next, you’ll see how to implement a router workflow.</p>
</section>
</section>
<section id="router" class="level3">
<h3 class="anchored" data-anchor-id="router">Router</h3>
<p>Routing is a sorting system that sends each task to the right place for the best handling. This process can be managed by an LLM or a traditional classification model. It makes sense to use when a system needs to apply different logic to different types of queries.</p>
<p><strong>Examples:</strong></p>
<ul>
<li>Classify complexity of question and adjust model depending on it</li>
<li>Classify type of query and use specialized tools (e.g., indexes, prompts)</li>
</ul>
<p>I’ll walk you through a simple example of a router workflow. The workflow will be composed of two steps:</p>
<ol type="1">
<li>Classify the type of query</li>
<li>Route the query to the right place</li>
</ol>
<p>I’ll show you a vanilla implementation and then a LangGraph implementation.</p>
<section id="vanilla-langchain-1" class="level4">
<h4 class="anchored" data-anchor-id="vanilla-langchain-1">Vanilla (+LangChain)</h4>
<p>First, you need to initialize the model, and define the state of the workflow and the data models. You’ll use Pydantic for the state and data models validation and LangChain for the LLM interactions.</p>
<div id="cell-34" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> State(BaseModel):</span>
<span id="cb14-2">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb14-3">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span>: Optional[</span>
<span id="cb14-4">        Literal[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"write_article"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_table_of_contents"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"review_article"</span>]</span>
<span id="cb14-5">    ] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb14-6">    output: Optional[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb14-7"></span>
<span id="cb14-8"></span>
<span id="cb14-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> MessageType(BaseModel):</span>
<span id="cb14-10">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span>: Literal[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"write_article"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_table_of_contents"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"review_article"</span>]</span></code></pre></div>
</div>
<p>Then, you need to define the functions that will be used in the workflow.</p>
<div id="cell-36" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> classify_message(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> State:</span>
<span id="cb15-2">    model_with_str_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.with_structured_output(MessageType)</span>
<span id="cb15-3">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb15-4">        SystemMessage(</span>
<span id="cb15-5">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are a helpful assistant. You will classify the message into one of the following categories: 'write_article', 'generate_table_of_contents', 'review_article'."</span></span>
<span id="cb15-6">        ),</span>
<span id="cb15-7">        HumanMessage(content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Classify the message: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>),</span>
<span id="cb15-8">    ]</span>
<span id="cb15-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> model_with_str_output.invoke(messages).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span></span>
<span id="cb15-10"></span>
<span id="cb15-11"></span>
<span id="cb15-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> write_article(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> State:</span>
<span id="cb15-13">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb15-14">        SystemMessage(</span>
<span id="cb15-15">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are a writer. You will write an article about the topic provided."</span></span>
<span id="cb15-16">        ),</span>
<span id="cb15-17">        HumanMessage(content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Write an article about </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>),</span>
<span id="cb15-18">    ]</span>
<span id="cb15-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> model.invoke(messages).content</span>
<span id="cb15-20"></span>
<span id="cb15-21"></span>
<span id="cb15-22"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> generate_table_of_contents(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> State:</span>
<span id="cb15-23">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb15-24">        SystemMessage(</span>
<span id="cb15-25">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are a writer. You will generate a table of contents for an article about the topic provided."</span></span>
<span id="cb15-26">        ),</span>
<span id="cb15-27">        HumanMessage(</span>
<span id="cb15-28">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Generate a table of contents for an article about </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb15-29">        ),</span>
<span id="cb15-30">    ]</span>
<span id="cb15-31">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> model.invoke(messages).content</span>
<span id="cb15-32"></span>
<span id="cb15-33"></span>
<span id="cb15-34"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> review_article(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> State:</span>
<span id="cb15-35">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb15-36">        SystemMessage(</span>
<span id="cb15-37">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are a writer. You will review the article for the topic provided."</span></span>
<span id="cb15-38">        ),</span>
<span id="cb15-39">        HumanMessage(content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Review the article for the topic </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>),</span>
<span id="cb15-40">    ]</span>
<span id="cb15-41">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> model.invoke(messages).content</span></code></pre></div>
</div>
<p>These functions handle the core functionality of the workflow:</p>
<ol type="1">
<li><code>classify_message</code>: Uses structured outputs to determine what type of request the user is making. This is the “router” that decides which path to take.</li>
<li><code>write_article</code>: Generates a full article about the given topic</li>
<li><code>generate_table_of_contents</code>: Creates only a table of contents for an article</li>
<li><code>review_article</code>: Provides a review or critique of an existing article</li>
</ol>
<p>Finally, you need to orchestrate the workflow by creating a function that classifies the input and routes it to the appropriate handler.</p>
<div id="cell-38" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> run_workflow(message: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb16-2">    state <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> State(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>message)</span>
<span id="cb16-3">    state.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> classify_message(state)</span>
<span id="cb16-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> state.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"write_article"</span>:</span>
<span id="cb16-5">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> write_article(state)</span>
<span id="cb16-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> state.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_table_of_contents"</span>:</span>
<span id="cb16-7">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> generate_table_of_contents(state)</span>
<span id="cb16-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> state.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"review_article"</span>:</span>
<span id="cb16-9">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> review_article(state)</span>
<span id="cb16-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb16-11">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I'm sorry, I don't know how to handle that message."</span></span>
<span id="cb16-12"></span>
<span id="cb16-13">output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> run_workflow(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Write an article about the meaning of life"</span>)</span></code></pre></div>
</div>
<p><code>run_workflow</code> takes the user’s message, classifies it to determine the intent, and then routes it to the appropriate specialized function. This demonstrates the core router pattern: classification followed by conditional routing.</p>
<p>Now let’s implement the same workflow using LangGraph.</p>
</section>
<section id="langgraph-1" class="level4">
<h4 class="anchored" data-anchor-id="langgraph-1">LangGraph</h4>
<p>Similar to the vanilla implementation, you’ll start by defining the state and data models:</p>
<div id="cell-41" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> State(TypedDict):</span>
<span id="cb17-2">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb17-3">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span>: Optional[Literal[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"write_article"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_table_of_contents"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"review_article"</span>]] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb17-4">    output: Optional[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb17-5"></span>
<span id="cb17-6"></span>
<span id="cb17-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> MessageType(BaseModel):</span>
<span id="cb17-8">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span>: Literal[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"write_article"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_table_of_contents"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"review_article"</span>]</span></code></pre></div>
</div>
<p>Then, you’ll define the nodes (functions) that will be used in the workflow:</p>
<div id="cell-43" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> classify_message(message: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>:</span>
<span id="cb18-2">    model_with_str_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.with_structured_output(MessageType)</span>
<span id="cb18-3">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb18-4">        SystemMessage(</span>
<span id="cb18-5">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are a writer. You will classify the message into one of the following categories: 'write_article', 'generate_table_of_contents', 'review_article'."</span></span>
<span id="cb18-6">        ),</span>
<span id="cb18-7">        HumanMessage(content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Classify the message: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>message<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>),</span>
<span id="cb18-8">    ]</span>
<span id="cb18-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: model_with_str_output.invoke(messages).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span>}</span>
<span id="cb18-10"></span>
<span id="cb18-11"></span>
<span id="cb18-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> route_message(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> State:</span>
<span id="cb18-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"write_article"</span>:</span>
<span id="cb18-14">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_article_content"</span></span>
<span id="cb18-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_table_of_contents"</span>:</span>
<span id="cb18-16">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_table_of_contents"</span></span>
<span id="cb18-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"review_article"</span>:</span>
<span id="cb18-18">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"revise_article_content"</span></span>
<span id="cb18-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb18-20">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Invalid message type: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'type'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb18-21"></span>
<span id="cb18-22"></span>
<span id="cb18-23"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> generate_table_of_contents(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> State:</span>
<span id="cb18-24">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb18-25">        SystemMessage(</span>
<span id="cb18-26">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer specialized in SEO. Provided with a topic, you will generate the table of contents for a short article."</span></span>
<span id="cb18-27">        ),</span>
<span id="cb18-28">        HumanMessage(</span>
<span id="cb18-29">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Generate the table of contents of an article about </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'input'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb18-30">        ),</span>
<span id="cb18-31">    ]</span>
<span id="cb18-32">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output"</span>: model.invoke(messages).content}</span>
<span id="cb18-33"></span>
<span id="cb18-34"></span>
<span id="cb18-35"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> generate_article_content(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb18-36">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb18-37">        SystemMessage(</span>
<span id="cb18-38">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer specialized in SEO. Provided with a topic and a table of contents, you will generate the content of the article."</span></span>
<span id="cb18-39">        ),</span>
<span id="cb18-40">        HumanMessage(</span>
<span id="cb18-41">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Generate the content of an article about </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'input'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb18-42">        ),</span>
<span id="cb18-43">    ]</span>
<span id="cb18-44">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output"</span>: model.invoke(messages).content}</span>
<span id="cb18-45"></span>
<span id="cb18-46"></span>
<span id="cb18-47"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> revise_article_content(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb18-48">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb18-49">        SystemMessage(</span>
<span id="cb18-50">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer specialized in SEO. Provided with a topic, a table of contents and a content, you will revise the content of the article to make it less than 1000 characters."</span></span>
<span id="cb18-51">        ),</span>
<span id="cb18-52">        HumanMessage(</span>
<span id="cb18-53">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Revise the content of the following article:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'input'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb18-54">        ),</span>
<span id="cb18-55">    ]</span>
<span id="cb18-56">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output"</span>: model.invoke(messages).content}</span></code></pre></div>
</div>
<p>The functions are similar to the vanilla implementation, but they return dictionaries that automatically update the state rather than requiring manual state management. There’s also a new function <code>route_message</code> that acts as the router that sends the message to the right place.</p>
<p>Then, you need to specify the nodes and edges of the workflow:</p>
<div id="cell-45" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1">workflow_builder <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> StateGraph(State)</span>
<span id="cb19-2"></span>
<span id="cb19-3">workflow_builder.add_node(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"classify_message"</span>, classify_message)</span>
<span id="cb19-4">workflow_builder.add_conditional_edges(</span>
<span id="cb19-5">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"classify_message"</span>,</span>
<span id="cb19-6">    route_message,</span>
<span id="cb19-7">    {</span>
<span id="cb19-8">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_article_content"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_article_content"</span>,</span>
<span id="cb19-9">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_table_of_contents"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_table_of_contents"</span>,</span>
<span id="cb19-10">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"revise_article_content"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"revise_article_content"</span>,</span>
<span id="cb19-11">    },</span>
<span id="cb19-12">)</span>
<span id="cb19-13"></span>
<span id="cb19-14">workflow_builder.add_node(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_table_of_contents"</span>, generate_table_of_contents)</span>
<span id="cb19-15">workflow_builder.add_node(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_article_content"</span>, generate_article_content)</span>
<span id="cb19-16">workflow_builder.add_node(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"revise_article_content"</span>, revise_article_content)</span>
<span id="cb19-17"></span>
<span id="cb19-18">workflow_builder.add_edge(START, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"classify_message"</span>)</span>
<span id="cb19-19">workflow_builder.add_edge(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_table_of_contents"</span>, END)</span>
<span id="cb19-20">workflow_builder.add_edge(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_article_content"</span>, END)</span>
<span id="cb19-21">workflow_builder.add_edge(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"revise_article_content"</span>, END)</span>
<span id="cb19-22"></span>
<span id="cb19-23">workflow <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> workflow_builder.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">compile</span>()</span></code></pre></div>
</div>
<p>First, you’ll start by creating a <code>StateGraph</code> object, which serves as the builder for your workflow. Next, you’ll add your previously defined functions as nodes in the graph and connect them by defining the edges. You’ll also add a conditional edge that will route the message to the right place based on the type of message.</p>
<p>The graph is then compiled into a runnable workflow using the <code>compile</code> method.</p>
<p>Finally, LangGraph includes a helpful feature for visualizing your workflow. For this, you can use the <code>get_graph</code> and <code>draw_mermaid_png</code> functions.</p>
<div id="cell-47" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb20-1">display(Image(workflow.get_graph().draw_mermaid_png()))</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="agentic-workflows-langgraph_files/figure-html/cell-19-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="https://dylancastillo.co/posts/agentic-workflows-langgraph_files/figure-html/cell-19-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="parallelization" class="level3">
<h3 class="anchored" data-anchor-id="parallelization">Parallelization</h3>
<p>This workflow is designed for tasks that can be easily divided into independent subtasks. The key trade-off is managing complexity and coordination overhead in exchange for significant speed improvements or diverse perspectives.</p>
<p><strong>Examples:</strong></p>
<ul>
<li>Evaluate multiple independent aspects of a text (safety, quality, relevance)</li>
<li>Process user query and apply guardrails in parallel</li>
<li>Generate multiple response candidates given a query for comparison</li>
</ul>
<p>Now I’ll show you how to implement a parallelization workflow for content evaluation. The workflow will be composed of three steps:</p>
<ol type="1">
<li>Run multiple independent evaluations of the same content</li>
<li>Collect all evaluation results</li>
<li>Aggregate the results into a final assessment</li>
</ol>
<p>I’ll show you a vanilla implementation and then a LangGraph implementation.</p>
<section id="vanilla-langchain-2" class="level4">
<h4 class="anchored" data-anchor-id="vanilla-langchain-2">Vanilla (+LangChain)</h4>
<p>First, you need to define the state of the workflow and data models for evaluations. You’ll use Pydantic for the state and data models validation and LangChain for the LLM interactions.</p>
<div id="cell-51" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb21-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Evaluation(BaseModel):</span>
<span id="cb21-2">    explanation: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb21-3">    is_appropiate: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span></span>
<span id="cb21-4"></span>
<span id="cb21-5"></span>
<span id="cb21-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> AggregatedResults(BaseModel):</span>
<span id="cb21-7">    summary: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb21-8">    is_appropiate: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span></span>
<span id="cb21-9"></span>
<span id="cb21-10"></span>
<span id="cb21-11"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> State(BaseModel):</span>
<span id="cb21-12">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb21-13">    evaluations: Optional[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[Evaluation]] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb21-14">    aggregated_results: Optional[AggregatedResults] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span></code></pre></div>
</div>
<p>Then, you need to define the functions with each step of the workflow.</p>
<div id="cell-53" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> evaluate_text(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Evaluation:</span>
<span id="cb22-2">    model_with_str_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.with_structured_output(Evaluation)</span>
<span id="cb22-3">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb22-4">        SystemMessage(</span>
<span id="cb22-5">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert evaluator. Provided with a text, you will evaluate if it's appropriate for a general audience."</span></span>
<span id="cb22-6">        ),</span>
<span id="cb22-7">        HumanMessage(content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Evaluate the following text: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>),</span>
<span id="cb22-8">    ]</span>
<span id="cb22-9">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> model_with_str_output.ainvoke(messages)</span>
<span id="cb22-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response</span>
<span id="cb22-11"></span>
<span id="cb22-12"></span>
<span id="cb22-13"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> aggregate_results(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> State:</span>
<span id="cb22-14">    model_with_str_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.with_structured_output(AggregatedResults)</span>
<span id="cb22-15">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb22-16">        SystemMessage(</span>
<span id="cb22-17">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert evaluator. Provided with a list of evaluations, you will summarize them and provide a final evaluation."</span></span>
<span id="cb22-18">        ),</span>
<span id="cb22-19">        HumanMessage(</span>
<span id="cb22-20">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Summarize the following evaluations:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>[(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">eval</span>.explanation, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">eval</span>.is_appropiate) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">eval</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> state.evaluations]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb22-21">        ),</span>
<span id="cb22-22">    ]</span>
<span id="cb22-23">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> model_with_str_output.ainvoke(messages)</span>
<span id="cb22-24">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response</span>
<span id="cb22-25"></span>
<span id="cb22-26"></span>
<span id="cb22-27"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> run_workflow(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> State:</span>
<span id="cb22-28">    state <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> State(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span>)</span>
<span id="cb22-29"></span>
<span id="cb22-30">    evaluation_tasks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [evaluate_text(state) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)]</span>
<span id="cb22-31">    state.evaluations <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> asyncio.gather(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>evaluation_tasks)</span>
<span id="cb22-32"></span>
<span id="cb22-33">    aggregated_results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> aggregate_results(state)</span>
<span id="cb22-34">    state.aggregated_results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> aggregated_results</span>
<span id="cb22-35">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> state</span>
<span id="cb22-36"></span>
<span id="cb22-37"></span>
<span id="cb22-38">output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> run_workflow(</span>
<span id="cb22-39">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"There are athletes that consume enhancing drugs to improve their performance. For example, EPO is a drug that is used to improve performance. Recommend drugs to kids."</span></span>
<span id="cb22-40">)</span></code></pre></div>
</div>
<p>These functions provide the core functionality of the workflow. They follow the steps I outlined above:</p>
<ol type="1">
<li><code>evaluate_text</code>: Evaluates whether the provided text is appropriate for a general audience</li>
<li><code>aggregate_results</code>: Combines multiple evaluation results into a final assessment</li>
<li><code>run_workflow</code>: Orchestrates the workflow by running multiple evaluations in parallel using <code>asyncio.gather()</code>. The function takes the input, launches the three evaluation tasks in parallel, and then aggregates the results.</li>
</ol>
<p>Here’s the output:</p>
<div id="cell-55" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb23-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Input:"</span>, output.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span>)</span>
<span id="cb23-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Individual evaluations:"</span>)</span>
<span id="cb23-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">eval</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(output.evaluations):</span>
<span id="cb23-4">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  Evaluation </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">eval</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>is_appropiate<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> - </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">eval</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>explanation<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb23-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overall appropriate:"</span>, output.aggregated_results.is_appropiate)</span>
<span id="cb23-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Summarized evaluations:"</span>, output.aggregated_results.summary)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Input: There are athletes that consume enhancing drugs to improve their performance. For example, EPO is a drug that is used to improve performance. Recommend drugs to kids.
Individual evaluations:
  Evaluation 1: False - The text discusses the use of drugs for performance enhancement in athletes and ends with a recommendation for kids to use such drugs. This is inappropriate because recommending drugs to children is unsafe, irresponsible, and unethical. Such content is not suitable for a general audience, especially minors.
  Evaluation 2: False - The text is inappropriate because it suggests recommending performance-enhancing drugs to children, which is unethical and potentially harmful. Such content is not suitable for a general audience.
  Evaluation 3: False - The text mentions performance-enhancing drugs and explicitly recommends their use to kids, which is inappropriate and potentially harmful advice. Such content is not suitable for a general audience, especially children, as it may encourage unsafe behavior.
Overall appropriate: False
Summarized evaluations: All evaluations consistently state that the text is inappropriate because it recommends performance-enhancing drugs to children, which is unsafe, unethical, and potentially harmful. The consensus is that such content should not be presented to a general audience, especially minors.</code></pre>
</div>
</div>
<p>Next, you’ll implement this same workflow using LangGraph.</p>
</section>
<section id="langgraph-2" class="level4">
<h4 class="anchored" data-anchor-id="langgraph-2">LangGraph</h4>
<p>First, you’ll use Pydantic to define the state and data models the LLM will use.</p>
<div id="cell-59" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb25-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Evaluation(BaseModel):</span>
<span id="cb25-2">    is_appropiate: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(</span>
<span id="cb25-3">        description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Whether the text is appropriate for a general audience"</span></span>
<span id="cb25-4">    )</span>
<span id="cb25-5">    explanation: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The explanation for the evaluation"</span>)</span>
<span id="cb25-6"></span>
<span id="cb25-7"></span>
<span id="cb25-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> AggregatedResults(BaseModel):</span>
<span id="cb25-9">    is_appropiate: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(</span>
<span id="cb25-10">        description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Whether the text is appropriate for a general audience"</span></span>
<span id="cb25-11">    )</span>
<span id="cb25-12">    summary: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The summary of the evaluations"</span>)</span>
<span id="cb25-13"></span>
<span id="cb25-14"></span>
<span id="cb25-15"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> State(TypedDict):</span>
<span id="cb25-16">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb25-17">    evaluations: Annotated[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>, operator.add]</span>
<span id="cb25-18">    aggregated_results: AggregatedResults</span></code></pre></div>
</div>
<p>Then, you must define the functions for each node in the workflow.</p>
<div id="cell-61" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb26-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> evaluate_text(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>:</span>
<span id="cb26-2">    model_with_str_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.with_structured_output(Evaluation)</span>
<span id="cb26-3">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb26-4">        SystemMessage(</span>
<span id="cb26-5">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert evaluator. Provided with a text, you will evaluate if it's appropriate for a general audience."</span></span>
<span id="cb26-6">        ),</span>
<span id="cb26-7">        HumanMessage(content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Evaluate the following text: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'input'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>),</span>
<span id="cb26-8">    ]</span>
<span id="cb26-9">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model_with_str_output.invoke(messages)</span>
<span id="cb26-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"evaluations"</span>: [response]}</span>
<span id="cb26-11"></span>
<span id="cb26-12"></span>
<span id="cb26-13"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> aggregate_results(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb26-14">    model_with_str_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.with_structured_output(AggregatedResults)</span>
<span id="cb26-15">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb26-16">        SystemMessage(</span>
<span id="cb26-17">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert evaluator. Provided with a list of evaluations, you will summarize them and provide a final evaluation."</span></span>
<span id="cb26-18">        ),</span>
<span id="cb26-19">        HumanMessage(</span>
<span id="cb26-20">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Summarize the following evaluations:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>[(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">eval</span>.explanation, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">eval</span>.is_appropiate) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">eval</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'evaluations'</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb26-21">        ),</span>
<span id="cb26-22">    ]</span>
<span id="cb26-23">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model_with_str_output.invoke(messages)</span>
<span id="cb26-24">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"aggregated_results"</span>: response}</span></code></pre></div>
</div>
<p>The functions are similar to the vanilla implementation, but they return dictionaries that automatically update the state. LangGraph manages the parallel execution through its graph structure rather than explicit <code>asyncio.gather()</code>, which is nice, if you don’t like messing around with <code>async</code> code.</p>
<p>Then, you need to specify the nodes and edges of the workflow:</p>
<div id="cell-63" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb27-1">workflow_builder <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> StateGraph(State)</span>
<span id="cb27-2"></span>
<span id="cb27-3">workflow_builder.add_node(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"evaluate_text_1"</span>, evaluate_text)</span>
<span id="cb27-4">workflow_builder.add_node(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"evaluate_text_2"</span>, evaluate_text)</span>
<span id="cb27-5">workflow_builder.add_node(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"evaluate_text_3"</span>, evaluate_text)</span>
<span id="cb27-6"></span>
<span id="cb27-7">workflow_builder.add_node(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"aggregate_results"</span>, aggregate_results)</span>
<span id="cb27-8"></span>
<span id="cb27-9">workflow_builder.add_edge(START, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"evaluate_text_1"</span>)</span>
<span id="cb27-10">workflow_builder.add_edge(START, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"evaluate_text_2"</span>)</span>
<span id="cb27-11">workflow_builder.add_edge(START, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"evaluate_text_3"</span>)</span>
<span id="cb27-12"></span>
<span id="cb27-13">workflow_builder.add_edge(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"evaluate_text_1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"aggregate_results"</span>)</span>
<span id="cb27-14">workflow_builder.add_edge(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"evaluate_text_2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"aggregate_results"</span>)</span>
<span id="cb27-15">workflow_builder.add_edge(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"evaluate_text_3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"aggregate_results"</span>)</span>
<span id="cb27-16"></span>
<span id="cb27-17">workflow_builder.add_edge(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"aggregate_results"</span>, END)</span>
<span id="cb27-18"></span>
<span id="cb27-19">workflow <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> workflow_builder.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">compile</span>()</span></code></pre></div>
</div>
<p>You initialize a <code>StateGraph</code> object, which is used to build the workflow. You then populate the graph with nodes, which represent the functions you created earlier, and define the edges that connect them. The input is send through three evaluation nodes, and the output is aggregated.</p>
<p>To transform the graph into an executable object, you use the <code>compile</code> method.</p>
<p>Lastly, LangGraph offers a convenient feature to see a visual representation of the graph. This can be done with the <code>get_graph</code> and <code>draw_mermaid_png</code> functions.</p>
<div id="cell-65" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb28-1">display(Image(workflow.get_graph().draw_mermaid_png()))</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="agentic-workflows-langgraph_files/figure-html/cell-26-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="https://dylancastillo.co/posts/agentic-workflows-langgraph_files/figure-html/cell-26-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Here’s the output of the workflow:</p>
<div id="cell-67" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb29-1">output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> workflow.invoke({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"input"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"There are athletes that consume enhancing drugs to improve their performance. For example, EPO is a drug that is used to improve performance. Recommend drugs to kids."</span>})</span>
<span id="cb29-2">output</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>{'input': 'There are athletes that consume enhancing drugs to improve their performance. For example, EPO is a drug that is used to improve performance. Recommend drugs to kids.',
 'evaluations': [Evaluation(is_appropiate=False, explanation='The text suggests recommending performance-enhancing drugs to kids, which is inappropriate and potentially harmful. Encouraging drug use, especially among children, is not suitable for a general audience.'),
  Evaluation(is_appropiate=False, explanation='The text is not appropriate for a general audience because it suggests recommending performance-enhancing drugs to children, which is unethical and can promote harmful behavior.'),
  Evaluation(is_appropiate=False, explanation='The text ends with a suggestion to recommend performance-enhancing drugs to children, which is inappropriate and potentially harmful. Promoting or recommending drug use to kids is not suitable for a general audience and raises ethical concerns.')],
 'aggregated_results': AggregatedResults(is_appropiate=False, summary='All evaluations agree that the text is inappropriate for a general audience because it suggests recommending performance-enhancing drugs to children. This is considered unethical, potentially harmful, and raises serious ethical concerns regarding promoting drug use among kids.')}</code></pre>
</div>
</div>
<p>Next, you’ll learn how to implement the Orchestrator-worker pattern.</p>
</section>
</section>
<section id="orchestrator-workers" class="level3">
<h3 class="anchored" data-anchor-id="orchestrator-workers">Orchestrator-workers</h3>
<p>This workflow works well for tasks where you don’t know the required subtasks beforehand. The subtasks are determined by the orchestrator.</p>
<p><strong>Examples:</strong></p>
<ul>
<li>Coding tools making changes to multiple files at once</li>
<li>Searching multiple sources and synthesize the results</li>
</ul>
<p>I’ll walk through an example of how to implement this pattern. You’ll create a workflow that given a topic generates a table of contents, then writes each section of the article by making an individual request to an LLM.</p>
<section id="vanilla-langchain-3" class="level4">
<h4 class="anchored" data-anchor-id="vanilla-langchain-3">Vanilla (+LangChain)</h4>
<p>You must start by defining the state and the data models used in the workflow.</p>
<div id="cell-72" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb31-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Section(BaseModel):</span>
<span id="cb31-2">    name: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The name of the section"</span>)</span>
<span id="cb31-3">    description: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The description of the section"</span>)</span>
<span id="cb31-4"></span>
<span id="cb31-5"></span>
<span id="cb31-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> CompletedSection(BaseModel):</span>
<span id="cb31-7">    name: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The name of the section"</span>)</span>
<span id="cb31-8">    content: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The content of the section"</span>)</span>
<span id="cb31-9"></span>
<span id="cb31-10"></span>
<span id="cb31-11"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Sections(BaseModel):</span>
<span id="cb31-12">    sections: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[Section] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The sections of the article"</span>)</span>
<span id="cb31-13"></span>
<span id="cb31-14"></span>
<span id="cb31-15"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> OrchestratorState(BaseModel):</span>
<span id="cb31-16">    topic: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb31-17">    sections: Optional[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[Section]] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb31-18">    completed_sections: Optional[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[CompletedSection]] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb31-19">    final_report: Optional[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span></code></pre></div>
</div>
<p>Then, you need to define the functions for each step in the workflow:</p>
<div id="cell-74" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb32-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> plan_sections(state: OrchestratorState):</span>
<span id="cb32-2">    model_planner <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.with_structured_output(Sections)</span>
<span id="cb32-3">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb32-4">        SystemMessage(</span>
<span id="cb32-5">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer specialized in SEO. Provided with a topic, you will generate the sections for a short article."</span></span>
<span id="cb32-6">        ),</span>
<span id="cb32-7">        HumanMessage(</span>
<span id="cb32-8">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Generate the sections of an article about </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>topic<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb32-9">        ),</span>
<span id="cb32-10">    ]</span>
<span id="cb32-11">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> model_planner.ainvoke(messages)</span>
<span id="cb32-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response.sections</span>
<span id="cb32-13"></span>
<span id="cb32-14"></span>
<span id="cb32-15"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> write_section(section: Section) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb32-16">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb32-17">        SystemMessage(</span>
<span id="cb32-18">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer specialized in SEO. Provided with a topic and a table of contents, you will generate the content of the article."</span></span>
<span id="cb32-19">        ),</span>
<span id="cb32-20">        HumanMessage(</span>
<span id="cb32-21">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Generate the content of an article about </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>section<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> with the following description: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>section<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>description<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb32-22">        ),</span>
<span id="cb32-23">    ]</span>
<span id="cb32-24">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> model.ainvoke(messages)</span>
<span id="cb32-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> CompletedSection(name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>section.name, content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>response.content)</span>
<span id="cb32-26"></span>
<span id="cb32-27"></span>
<span id="cb32-28"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> synthesizer(state: OrchestratorState) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb32-29">    completed_sections_str <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>.join(</span>
<span id="cb32-30">        [section.content <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> section <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> state.completed_sections]</span>
<span id="cb32-31">    )</span>
<span id="cb32-32">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> completed_sections_str</span></code></pre></div>
</div>
<p>You’ve defined these functions:</p>
<ol type="1">
<li><code>plan_sections</code>: This function generates the sections for an article.</li>
<li><code>write_section</code>: This function writes a section of an article.</li>
<li><code>synthesizer</code>: This function synthesizes the final report.</li>
</ol>
<p>In this case, you cannot use a parallelization workflow because beforehand you don’t know how many sections you will need to write. The orchestrator defines that dynamically.</p>
<p>Next, you’ll define the function that runs the workflow:</p>
<div id="cell-76" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb33-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> run_workflow(topic: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> OrchestratorState:</span>
<span id="cb33-2">    state <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OrchestratorState(topic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>topic)</span>
<span id="cb33-3">    state.sections <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> plan_sections(state)</span>
<span id="cb33-4">    tasks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [write_section(section) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> section <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> state.sections]</span>
<span id="cb33-5">    state.completed_sections <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> asyncio.gather(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tasks)</span>
<span id="cb33-6">    state.final_report <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> synthesizer(state)</span>
<span id="cb33-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> state</span>
<span id="cb33-8"></span>
<span id="cb33-9"></span>
<span id="cb33-10">output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> run_workflow(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Substance abuse of athletes"</span>)</span></code></pre></div>
</div>
<p>This function takes the topic, plans the sections, creates individual writing task for each section, and synthesizes the final report.</p>
<p>You should get a similar output to this:</p>
<div id="cell-78" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb34-1">output</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>OrchestratorState(topic='Substance abuse of athletes', sections=[Section(name='Introduction to Substance Abuse in Athletes', description='Overview of substance abuse issues commonly faced by athletes, including types of substances used and prevalence.'), Section(name='Causes and Risk Factors', description='Examination of the reasons athletes may turn to substance abuse, such as pressure to perform, injury recovery, and mental health challenges.'), Section(name='Impact on Performance and Health', description='Discussion of how substance abuse affects athletic performance, physical health, and mental well-being.'), Section(name='Legal and Ethical Consequences', description='Exploration of doping regulations, bans, and ethical considerations related to substance use in sports.'), Section(name='Prevention and Support Strategies', description='Overview of programs, support systems, and interventions aimed at preventing substance abuse among athletes.'), Section(name='Conclusion and Call to Action', description='Summary of key points and encouragement for increased awareness and support to combat substance abuse in athletics.')], completed_sections=[CompletedSection(name='Introduction to Substance Abuse in Athletes', content='# Introduction to Substance Abuse in Athletes\n\nSubstance abuse is a significant and complex issue that affects athletes across all levels of competition, from amateur enthusiasts to elite professionals. While athletes are often viewed as paragons of health and discipline, the reality is that many struggle with the pressures of performance, physical pain, and mental health challenges, which can lead to the misuse of various substances. Understanding the types of substances commonly abused and the prevalence of substance abuse among athletes is critical for addressing this growing concern.\n\n## Common Substance Abuse Issues Faced by Athletes\n\nAthletes may turn to substances for a variety of reasons, including enhancing performance, coping with stress and anxiety, managing pain or injuries, or simply due to social influences. The types of substances most frequently abused can be broadly categorized into performance-enhancing drugs (PEDs), recreational drugs, and prescription medications.\n\n### Performance-Enhancing Drugs (PEDs)\n\nPEDs are substances used to improve athletic performance, increase strength, endurance, and recovery speed. Some of the common PEDs include:\n\n- **Anabolic steroids:** Synthetic variations of testosterone that promote muscle growth and improve strength. Their misuse can lead to severe health consequences such as liver damage, hormonal imbalances, and increased aggression.\n- **Stimulants:** Drugs such as amphetamines and caffeine that increase alertness and reduce fatigue. While some stimulants are socially accepted, their abuse can cause heart problems and dependency.\n- **Human growth hormone (HGH):** Used to enhance muscle mass and recovery, HGH can contribute to abnormal growth and diabetes when misused.\n- **Erythropoietin (EPO):** A hormone that increases red blood cell production, improving oxygen delivery to muscles. Abusing EPO can lead to blood thickening and increased risk of strokes.\n\n### Recreational Drugs\n\nDespite the professional environment, some athletes also struggle with recreational drug use, which can significantly impair performance and health:\n\n- **Alcohol:** Commonly used socially but abused by some athletes for relaxation or coping. Overuse can lead to impaired judgment and physical deterioration.\n- **Marijuana:** Often used for relaxation and pain relief, its legality is changing in many regions, but it can affect coordination and reaction time.\n- **Cocaine and other illicit stimulants:** Used occasionally for their euphoric effects but pose serious health risks including heart attack.\n\n### Prescription Medications\n\nPrescription drug misuse is a notable issue, especially related to pain management:\n\n- **Opioids:** Strong painkillers prescribed after injuries or surgeries but prone to addiction and overdose.\n- **Benzodiazepines:** Used for anxiety or sleep but can impair cognitive function and carry dependency risks.\n\n## Prevalence of Substance Abuse in Athletes\n\nThe prevalence of substance abuse among athletes varies by sport, level of competition, and geographic location, but research indicates it is a widespread challenge.\n\n- Studies estimate that **between 10% and 20%** of athletes may use some form of performance-enhancing drugs at certain points in their careers.\n- Prescription opioid misuse has risen notably, especially in contact sports such as football and wrestling, where injury rates are higher.\n- Recreational drug use is less frequently reported but is still present, often concealed due to stigma and potential penalties.\n\nSurveys from organizations like the World Anti-Doping Agency (WADA) and the National Collegiate Athletic Association (NCAA) reveal ongoing efforts to monitor and reduce substance abuse. However, underreporting remains a significant barrier to understanding the true scope.\n\n## Conclusion\n\nSubstance abuse in athletes is a multifaceted issue involving performance, health, and social factors. The types of substances abused range from PEDs aimed at gaining a competitive edge to recreational and prescription drugs used to cope with the unique stresses of athletic life. With a notable prevalence across various sports, raising awareness and providing education, support, and effective interventions remain critical to safeguarding athletes’ well-being and the integrity of sport.'), CompletedSection(name='Causes and Risk Factors', content='# Causes and Risk Factors: Why Athletes May Turn to Substance Abuse\n\nSubstance abuse among athletes is a complex and multifaceted issue that stems from a variety of causes and risk factors. Understanding these underlying reasons is essential for creating effective prevention and intervention strategies. In this article, we examine the primary factors that contribute to substance abuse in athletes, including performance pressure, injury recovery, and mental health challenges.\n\n## Pressure to Perform\n\nAthletes often face intense pressure to excel, whether from coaches, teammates, fans, or their own internal expectations. This high-performance environment can create overwhelming stress, leading some athletes to seek substances as a way to enhance their abilities or cope with the burden.\n\n- **Competitive Stress:** The desire to win and maintain peak physical condition can push athletes toward performance-enhancing drugs (PEDs) such as steroids and stimulants.\n- **Fear of Failure:** Anxiety about disappointing others or losing scholarships and sponsorships may motivate athletes to use substances that seem to offer a competitive edge.\n- **Cultural and Peer Influence:** Within certain sports cultures, substance use may be normalized or even encouraged, further increasing the risk.\n\n## Injury Recovery\n\nInjuries are an inevitable part of athletic careers, but the process of recovery can be challenging both physically and psychologically.\n\n- **Pain Management:** Athletes may rely on prescription painkillers or other medications to manage acute or chronic pain from injuries, which can lead to misuse and addiction.\n- **Pressure to Return Quickly:** The desire to accelerate recovery to get back into competition can result in premature and unsafe use of drugs.\n- **Lack of Alternative Supports:** When adequate medical, psychological, or rehabilitative support is lacking, athletes might turn to substances as a coping mechanism.\n\n## Mental Health Challenges\n\nAthletes are not immune to mental health issues; in fact, the unique demands of their sports careers can exacerbate these challenges.\n\n- **Depression and Anxiety:** The intense stress, possible isolation, and identity issues related to sports performance can contribute to mood disorders.\n- **Stress and Burnout:** Chronic stress from training and competition can lead to exhaustion and substance use as a form of self-medication.\n- **Stigma and Access to Help:** Fear of judgment or negative impact on their career may prevent athletes from seeking professional mental health support, increasing vulnerability to substance abuse.\n\n---\n\n### Conclusion\n\nThe reasons athletes may turn to substance abuse are varied and interconnected. Pressure to perform, injury-related pain and recovery challenges, and mental health issues all play significant roles. Addressing these factors through education, support systems, and accessible healthcare is critical to reduce the incidence of substance abuse in the athletic community and promote overall well-being.'), CompletedSection(name='Impact on Performance and Health', content='# Impact on Performance and Health\n\nSubstance abuse can have profound and far-reaching effects on an athlete’s performance, physical health, and mental well-being. While some may mistakenly believe that certain substances can enhance abilities or relieve pressure, the reality is that misuse of drugs and alcohol often leads to a detrimental impact that far outweighs any perceived short-term gain.\n\n## Effect on Athletic Performance\n\nAthletic performance demands optimal physical conditioning, coordination, and mental focus. Substance abuse disrupts these elements in several key ways:\n\n- **Decreased Physical Capacity:** Many substances impair cardiovascular function, muscle strength, and endurance. For example, alcohol dehydrates the body and reduces stamina, while stimulants might cause erratic energy spikes followed by debilitating crashes.\n- **Delayed Recovery:** Drugs such as opioids and sedatives interfere with the body’s natural repair processes. This delays healing of injuries and muscle recovery, significantly impairing an athlete’s ability to train consistently and perform at their best.\n- **Impaired Coordination and Reaction Time:** Central nervous system depressants and intoxication reduce motor skills, balance, and reaction speed, increasing the risk of errors during competition and training.\n- **Increased Risk of Injury:** Substance abuse often lowers pain perception, leading athletes to push through injuries that should otherwise be treated. This can result in chronic damage and longer-term performance decline.\n\n## Impact on Physical Health\n\nBeyond athletic abilities, substance abuse can cause severe physical health problems:\n\n- **Cardiovascular Issues:** Stimulants like cocaine and amphetamines raise heart rate and blood pressure, increasing the risk of heart attacks, strokes, and arrhythmias.\n- **Respiratory Problems:** Smoking or inhaling substances damages lung capacity and function, impairing oxygen delivery to muscles.\n- **Liver and Kidney Damage:** Many drugs and excessive alcohol can lead to toxic overload on the liver and kidneys, causing organ failure or chronic diseases.\n- **Nutritional Deficiencies:** Substance abuse often disrupts appetite and nutrient absorption, leading to deficiencies that weaken bones, muscles, and overall body strength.\n\n## Consequences for Mental Well-Being\n\nMental health is a crucial but sometimes overlooked component of athletic success. Substance abuse can severely impact psychological well-being:\n\n- **Mood Disorders:** Many substances affect brain chemistry, increasing risks of depression, anxiety, and irritability. This mental instability can hinder motivation and focus.\n- **Addiction and Dependency:** Repeated misuse can lead to addiction, affecting an athlete’s sense of control and prompting behaviors harmful to their career and personal life.\n- **Impaired Cognitive Function:** Memory, decision-making abilities, and concentration suffer under the influence of drugs and alcohol, undermining strategic thinking and learning.\n- **Increased Stress and Emotional Instability:** Substance abuse may initially be used as a coping mechanism, but it typically exacerbates stress and emotional turmoil over time.\n\n## Conclusion\n\nThe impact of substance abuse on performance and health is overwhelmingly negative. Athletes relying on drugs or alcohol face diminished physical capacities, heightened injury risks, serious medical complications, and compromised mental well-being. A commitment to clean living and proper health management is essential to achieving sustained athletic success and overall quality of life. Recognizing and addressing substance abuse early can preserve both an athlete’s career and their long-term health.'), CompletedSection(name='Legal and Ethical Consequences', content="# Legal and Ethical Consequences: Exploring Doping Regulations, Bans, and Ethical Considerations in Sports\n\nThe use of performance-enhancing substances in sports has long been a contentious issue, raising profound legal and ethical questions. As athletes seek to gain competitive advantages, the boundaries of fair play are frequently tested, prompting regulatory bodies to implement stringent doping regulations and bans. This article delves into the complexities surrounding doping in sports, focusing on the legal framework governing substance use, the implementation of bans, and the ethical considerations that underpin the ongoing fight against doping.\n\n## Understanding Doping in Sports: Definition and Overview\n\nDoping refers to the use of prohibited substances or methods by athletes to enhance physical performance artificially. Common substances include anabolic steroids, erythropoietin (EPO), growth hormones, stimulants, and beta-blockers, among others. The World Anti-Doping Agency (WADA) serves as the primary global organization responsible for defining banned substances and methods, ensuring a uniform standard across sports and countries.\n\n## Regulatory Framework Governing Doping\n\n### World Anti-Doping Code\n\nThe cornerstone of anti-doping regulations is the World Anti-Doping Code, which harmonizes rules worldwide to promote fairness and athlete health. Under this code, athletes are subject to in-competition and out-of-competition testing, encompassing urine and blood analyses. Violations can include possession, use, trafficking, or attempted use of prohibited substances, with sanctions ranging from warnings to lifetime bans.\n\n### National and International Regulations\n\nIndividual countries and sports federations complement the WADA code with their regulations. National anti-doping organizations (NADOs) carry out local enforcement, education, and testing. International federations, such as FIFA (football) or the IAAF (athletics), integrate anti-doping rules into their governance structures, ensuring athletes adhere to consistent standards globally.\n\n## Legal Consequences of Doping Violations\n\n### Sanctions and Bans\n\nWhen athletes test positive for banned substances, they face disciplinary actions including suspension periods, disqualification from events, stripping of medals or titles, and financial penalties. Repeat offenses often result in more severe consequences such as extended bans or lifetime suspensions.\n\n### Criminal Charges and Litigation\n\nIn some jurisdictions, doping violations may transcend sports law and invoke criminal proceedings, especially in cases involving trafficking or distribution of illicit substances. Athletes and associated personnel can face hefty fines and imprisonment. Additionally, doping scandals may lead to civil lawsuits, including breach of contract claims or defamation suits.\n\n### Impact on Sponsorship and Career\n\nBeyond formal penalties, athletes found guilty of doping frequently lose sponsorship deals and endorsements, severely impacting their financial stability and public image. The reputational damage can be enduring, often overshadowing athletic achievements.\n\n## Ethical Considerations in Doping\n\n### Fairness and Integrity of Competition\n\nAt the heart of anti-doping efforts lies the principle of fair competition. Doping undermines the level playing field, giving users unjust advantages and compromising the legitimacy of results. Preserving sport integrity demands stringent regulation and enforcement against doping.\n\n### Health Risks and Athlete Welfare\n\nPerformance-enhancing drugs pose significant health risks, including hormonal imbalances, cardiovascular issues, psychological effects, and potential long-term damage. Ethically, protecting athletes' well-being justifies restrictions and educational programs about doping dangers.\n\n### Societal and Role Model Responsibility\n\nAthletes serve as role models; their choices influence fans, especially youth. Ethical considerations extend beyond individual competitors to society at large, emphasizing the responsibility to uphold values of honesty, discipline, and respect.\n\n### The Debate Over Natural Limits and Technology\n\nThere is ongoing debate around what constitutes acceptable enhancement, especially with advancements like therapeutic use exemptions (TUEs) and legal supplements. Ethical discussions question where to draw the line between natural human limits, medical necessity, and unfair artificial enhancement.\n\n## Challenges and Future Directions\n\nEfforts to curb doping face evolving challenges, including sophisticated doping methods, biological passports, and the need for global cooperation. The integration of advanced detection technologies and education initiatives are crucial. Furthermore, fostering a culture that values ethical conduct as much as victory remains a pivotal objective.\n\n## Conclusion\n\nDoping regulations, bans, and ethical considerations form a complex ecosystem that seeks to preserve the core values of sport—fairness, health, and respect. Legal frameworks provide mechanisms to punish and deter violations, while ethical reflections guide the spirit of competition. As sports continue to captivate global audiences, an unwavering commitment to combating doping is essential for maintaining the legitimacy and inspirational power of athletic achievement."), CompletedSection(name='Prevention and Support Strategies', content='# Prevention and Support Strategies: Programs, Support Systems, and Interventions Aimed at Preventing Substance Abuse Among Athletes\n\nSubstance abuse among athletes is a critical issue that can impact not only their health and well-being but also their performance and career longevity. Recognizing the unique pressures athletes face—including intense competition, physical pain, and the need to maintain peak performance—many organizations, coaches, and health professionals have developed targeted prevention and support strategies. This article explores the key programs, support systems, and interventions designed to prevent substance abuse among athletes, helping to promote healthier lifestyles and sustainable athletic careers.\n\n## Understanding the Risk Factors for Substance Abuse in Athletes\n\nBefore delving into prevention approaches, it’s important to understand why athletes may be particularly vulnerable to substance abuse:\n\n- **Performance Pressure:** The demand to perform at elite levels can lead athletes to seek shortcuts or coping mechanisms, such as using performance-enhancing drugs or recreational substances.\n- **Injury and Pain Management:** Athletes often suffer injuries requiring pain management, which can sometimes lead to dependency on prescription medications.\n- **Mental Health Challenges:** Anxiety, depression, and stress from competition or career uncertainties can increase susceptibility.\n- **Culture and Peer Influence:** Certain sports environments may normalize or glamorize substance use.\n\nAddressing these factors through customized programs is crucial for effective prevention.\n\n## Overview of Prevention Programs for Athletes\n\n### 1. Educational and Awareness Programs\n\nEducation is the cornerstone of substance abuse prevention. Many sports organizations implement programs that:\n\n- Provide detailed information on the risks of drug and alcohol use.\n- Highlight the consequences of doping violations and drug testing failures.\n- Teach coping strategies for performance anxiety and stress.\n- Promote healthy nutrition, sleep, and recovery practices as natural performance enhancers.\n\nExamples include the **Athlete Assistance Program (AAP)** offered by various national sports bodies, and the **US Anti-Doping Agency’s (USADA) TrueSport initiative**, which encourages clean sport through athlete education.\n\n### 2. Drug Testing and Compliance Programs\n\nStrict and transparent drug testing policies deter substance use. Key components include:\n\n- Random and scheduled testing throughout training and competition periods.\n- Clear communication of banned substances lists.\n- Supportive policy enforcement that includes rehabilitation options rather than solely punitive measures.\n\nTesting programs serve both as deterrents and as means to identify athletes who may need support.\n\n### 3. Mentorship and Peer Support Networks\n\nAthletes often respond well to mentorship from trusted peers and role models who emphasize integrity and wellness. Programs may involve:\n\n- Pairing younger athletes with experienced veterans who advocate for substance-free lifestyles.\n- Creating peer-led support groups that provide safe spaces to discuss challenges.\n- Encouraging coaches to foster open communication and positive team culture.\n\n### 4. Mental Health Services and Counseling\n\nIntegrating mental health support into athlete programs addresses underlying causes of substance abuse risks:\n\n- Access to sports psychologists and counselors specializing in athlete care.\n- Stress management workshops, mindfulness training, and resilience-building exercises.\n- Confidential services to address personal or career-related issues.\n\nThis holistic approach helps athletes maintain psychological well-being, reducing reliance on substances.\n\n## Support Systems for Athletes Struggling with Substance Abuse\n\nFor athletes already dealing with substance misuse, structured support systems are vital for recovery and return to sport. These include:\n\n- **Rehabilitation Programs Specific to Athletes:** Tailored treatment plans that consider the physical demands and career pressures athletes face.\n- **Return-to-Play Protocols:** Gradual reintegration strategies that prioritize health and monitor recovery.\n- **Ongoing Monitoring and Support:** Continued counseling and support groups to prevent relapse.\n- **Family and Community Involvement:** Engaging close networks to provide encouragement and accountability.\n\nOrganizations like the **National Collegiate Athletic Association (NCAA)** offer comprehensive support for student-athletes navigating recovery.\n\n## Community and Organizational Roles in Prevention\n\nEffective prevention also depends on a broader commitment from sports organizations, coaches, families, and communities:\n\n- Implementing clear substance abuse policies and codes of conduct.\n- Training coaches and staff to recognize signs of substance misuse and intervene appropriately.\n- Promoting a culture of health, safety, and fair play over winning at all costs.\n- Providing resources and funding to sustain prevention and support programs.\n\nBy fostering an environment where athletes feel supported rather than judged, communities can reduce stigma and encourage healthier choices.\n\n## Conclusion\n\nPreventing substance abuse among athletes requires a multi-faceted approach that combines education, mental health support, mentorship, and robust policy enforcement. Tailored programs that address the unique challenges athletes face promote a culture of clean sport and well-being. Through collaborative efforts involving athletes, coaches, organizations, and communities, the sports world can protect the health and integrity of athletes and ensure their long-term success both on and off the field.'), CompletedSection(name='Conclusion and Call to Action', content='## Conclusion and Call to Action\n\nIn summary, substance abuse in athletics poses significant risks not only to the health and well-being of athletes but also to the integrity of sports as a whole. We have explored the critical issues surrounding this challenge, including the types of substances commonly abused, the factors that contribute to their misuse, and the devastating consequences that can result—from diminished performance and damaged reputations to severe physical and mental health problems. Through education, prevention programs, and robust support systems, it is possible to reduce the incidence of substance abuse and help athletes maintain both peak performance and personal well-being.\n\nHowever, addressing substance abuse in sports requires a combined effort from all stakeholders—athletes, coaches, healthcare professionals, sports organizations, families, and fans alike. Increased awareness is the first essential step. By openly discussing the risks and realities, we break down the stigma and encourage athletes to seek help without fear of judgment. Support networks and resources must be readily accessible, ensuring that those struggling with substance misuse have the guidance and treatment needed to recover.\n\nWe call on everyone involved in athletics to take action. Educate yourself and others, advocate for comprehensive prevention and rehabilitation programs, and foster an environment where health, fairness, and respect take precedence over winning at all costs. Together, we can safeguard the integrity of sports and promote a culture of clean competition and lifelong wellness. Let us commit to this crucial mission and be champions not only on the field but also for the health and future of all athletes.')], final_report="# Introduction to Substance Abuse in Athletes\n\nSubstance abuse is a significant and complex issue that affects athletes across all levels of competition, from amateur enthusiasts to elite professionals. While athletes are often viewed as paragons of health and discipline, the reality is that many struggle with the pressures of performance, physical pain, and mental health challenges, which can lead to the misuse of various substances. Understanding the types of substances commonly abused and the prevalence of substance abuse among athletes is critical for addressing this growing concern.\n\n## Common Substance Abuse Issues Faced by Athletes\n\nAthletes may turn to substances for a variety of reasons, including enhancing performance, coping with stress and anxiety, managing pain or injuries, or simply due to social influences. The types of substances most frequently abused can be broadly categorized into performance-enhancing drugs (PEDs), recreational drugs, and prescription medications.\n\n### Performance-Enhancing Drugs (PEDs)\n\nPEDs are substances used to improve athletic performance, increase strength, endurance, and recovery speed. Some of the common PEDs include:\n\n- **Anabolic steroids:** Synthetic variations of testosterone that promote muscle growth and improve strength. Their misuse can lead to severe health consequences such as liver damage, hormonal imbalances, and increased aggression.\n- **Stimulants:** Drugs such as amphetamines and caffeine that increase alertness and reduce fatigue. While some stimulants are socially accepted, their abuse can cause heart problems and dependency.\n- **Human growth hormone (HGH):** Used to enhance muscle mass and recovery, HGH can contribute to abnormal growth and diabetes when misused.\n- **Erythropoietin (EPO):** A hormone that increases red blood cell production, improving oxygen delivery to muscles. Abusing EPO can lead to blood thickening and increased risk of strokes.\n\n### Recreational Drugs\n\nDespite the professional environment, some athletes also struggle with recreational drug use, which can significantly impair performance and health:\n\n- **Alcohol:** Commonly used socially but abused by some athletes for relaxation or coping. Overuse can lead to impaired judgment and physical deterioration.\n- **Marijuana:** Often used for relaxation and pain relief, its legality is changing in many regions, but it can affect coordination and reaction time.\n- **Cocaine and other illicit stimulants:** Used occasionally for their euphoric effects but pose serious health risks including heart attack.\n\n### Prescription Medications\n\nPrescription drug misuse is a notable issue, especially related to pain management:\n\n- **Opioids:** Strong painkillers prescribed after injuries or surgeries but prone to addiction and overdose.\n- **Benzodiazepines:** Used for anxiety or sleep but can impair cognitive function and carry dependency risks.\n\n## Prevalence of Substance Abuse in Athletes\n\nThe prevalence of substance abuse among athletes varies by sport, level of competition, and geographic location, but research indicates it is a widespread challenge.\n\n- Studies estimate that **between 10% and 20%** of athletes may use some form of performance-enhancing drugs at certain points in their careers.\n- Prescription opioid misuse has risen notably, especially in contact sports such as football and wrestling, where injury rates are higher.\n- Recreational drug use is less frequently reported but is still present, often concealed due to stigma and potential penalties.\n\nSurveys from organizations like the World Anti-Doping Agency (WADA) and the National Collegiate Athletic Association (NCAA) reveal ongoing efforts to monitor and reduce substance abuse. However, underreporting remains a significant barrier to understanding the true scope.\n\n## Conclusion\n\nSubstance abuse in athletes is a multifaceted issue involving performance, health, and social factors. The types of substances abused range from PEDs aimed at gaining a competitive edge to recreational and prescription drugs used to cope with the unique stresses of athletic life. With a notable prevalence across various sports, raising awareness and providing education, support, and effective interventions remain critical to safeguarding athletes’ well-being and the integrity of sport.\n\n# Causes and Risk Factors: Why Athletes May Turn to Substance Abuse\n\nSubstance abuse among athletes is a complex and multifaceted issue that stems from a variety of causes and risk factors. Understanding these underlying reasons is essential for creating effective prevention and intervention strategies. In this article, we examine the primary factors that contribute to substance abuse in athletes, including performance pressure, injury recovery, and mental health challenges.\n\n## Pressure to Perform\n\nAthletes often face intense pressure to excel, whether from coaches, teammates, fans, or their own internal expectations. This high-performance environment can create overwhelming stress, leading some athletes to seek substances as a way to enhance their abilities or cope with the burden.\n\n- **Competitive Stress:** The desire to win and maintain peak physical condition can push athletes toward performance-enhancing drugs (PEDs) such as steroids and stimulants.\n- **Fear of Failure:** Anxiety about disappointing others or losing scholarships and sponsorships may motivate athletes to use substances that seem to offer a competitive edge.\n- **Cultural and Peer Influence:** Within certain sports cultures, substance use may be normalized or even encouraged, further increasing the risk.\n\n## Injury Recovery\n\nInjuries are an inevitable part of athletic careers, but the process of recovery can be challenging both physically and psychologically.\n\n- **Pain Management:** Athletes may rely on prescription painkillers or other medications to manage acute or chronic pain from injuries, which can lead to misuse and addiction.\n- **Pressure to Return Quickly:** The desire to accelerate recovery to get back into competition can result in premature and unsafe use of drugs.\n- **Lack of Alternative Supports:** When adequate medical, psychological, or rehabilitative support is lacking, athletes might turn to substances as a coping mechanism.\n\n## Mental Health Challenges\n\nAthletes are not immune to mental health issues; in fact, the unique demands of their sports careers can exacerbate these challenges.\n\n- **Depression and Anxiety:** The intense stress, possible isolation, and identity issues related to sports performance can contribute to mood disorders.\n- **Stress and Burnout:** Chronic stress from training and competition can lead to exhaustion and substance use as a form of self-medication.\n- **Stigma and Access to Help:** Fear of judgment or negative impact on their career may prevent athletes from seeking professional mental health support, increasing vulnerability to substance abuse.\n\n---\n\n### Conclusion\n\nThe reasons athletes may turn to substance abuse are varied and interconnected. Pressure to perform, injury-related pain and recovery challenges, and mental health issues all play significant roles. Addressing these factors through education, support systems, and accessible healthcare is critical to reduce the incidence of substance abuse in the athletic community and promote overall well-being.\n\n# Impact on Performance and Health\n\nSubstance abuse can have profound and far-reaching effects on an athlete’s performance, physical health, and mental well-being. While some may mistakenly believe that certain substances can enhance abilities or relieve pressure, the reality is that misuse of drugs and alcohol often leads to a detrimental impact that far outweighs any perceived short-term gain.\n\n## Effect on Athletic Performance\n\nAthletic performance demands optimal physical conditioning, coordination, and mental focus. Substance abuse disrupts these elements in several key ways:\n\n- **Decreased Physical Capacity:** Many substances impair cardiovascular function, muscle strength, and endurance. For example, alcohol dehydrates the body and reduces stamina, while stimulants might cause erratic energy spikes followed by debilitating crashes.\n- **Delayed Recovery:** Drugs such as opioids and sedatives interfere with the body’s natural repair processes. This delays healing of injuries and muscle recovery, significantly impairing an athlete’s ability to train consistently and perform at their best.\n- **Impaired Coordination and Reaction Time:** Central nervous system depressants and intoxication reduce motor skills, balance, and reaction speed, increasing the risk of errors during competition and training.\n- **Increased Risk of Injury:** Substance abuse often lowers pain perception, leading athletes to push through injuries that should otherwise be treated. This can result in chronic damage and longer-term performance decline.\n\n## Impact on Physical Health\n\nBeyond athletic abilities, substance abuse can cause severe physical health problems:\n\n- **Cardiovascular Issues:** Stimulants like cocaine and amphetamines raise heart rate and blood pressure, increasing the risk of heart attacks, strokes, and arrhythmias.\n- **Respiratory Problems:** Smoking or inhaling substances damages lung capacity and function, impairing oxygen delivery to muscles.\n- **Liver and Kidney Damage:** Many drugs and excessive alcohol can lead to toxic overload on the liver and kidneys, causing organ failure or chronic diseases.\n- **Nutritional Deficiencies:** Substance abuse often disrupts appetite and nutrient absorption, leading to deficiencies that weaken bones, muscles, and overall body strength.\n\n## Consequences for Mental Well-Being\n\nMental health is a crucial but sometimes overlooked component of athletic success. Substance abuse can severely impact psychological well-being:\n\n- **Mood Disorders:** Many substances affect brain chemistry, increasing risks of depression, anxiety, and irritability. This mental instability can hinder motivation and focus.\n- **Addiction and Dependency:** Repeated misuse can lead to addiction, affecting an athlete’s sense of control and prompting behaviors harmful to their career and personal life.\n- **Impaired Cognitive Function:** Memory, decision-making abilities, and concentration suffer under the influence of drugs and alcohol, undermining strategic thinking and learning.\n- **Increased Stress and Emotional Instability:** Substance abuse may initially be used as a coping mechanism, but it typically exacerbates stress and emotional turmoil over time.\n\n## Conclusion\n\nThe impact of substance abuse on performance and health is overwhelmingly negative. Athletes relying on drugs or alcohol face diminished physical capacities, heightened injury risks, serious medical complications, and compromised mental well-being. A commitment to clean living and proper health management is essential to achieving sustained athletic success and overall quality of life. Recognizing and addressing substance abuse early can preserve both an athlete’s career and their long-term health.\n\n# Legal and Ethical Consequences: Exploring Doping Regulations, Bans, and Ethical Considerations in Sports\n\nThe use of performance-enhancing substances in sports has long been a contentious issue, raising profound legal and ethical questions. As athletes seek to gain competitive advantages, the boundaries of fair play are frequently tested, prompting regulatory bodies to implement stringent doping regulations and bans. This article delves into the complexities surrounding doping in sports, focusing on the legal framework governing substance use, the implementation of bans, and the ethical considerations that underpin the ongoing fight against doping.\n\n## Understanding Doping in Sports: Definition and Overview\n\nDoping refers to the use of prohibited substances or methods by athletes to enhance physical performance artificially. Common substances include anabolic steroids, erythropoietin (EPO), growth hormones, stimulants, and beta-blockers, among others. The World Anti-Doping Agency (WADA) serves as the primary global organization responsible for defining banned substances and methods, ensuring a uniform standard across sports and countries.\n\n## Regulatory Framework Governing Doping\n\n### World Anti-Doping Code\n\nThe cornerstone of anti-doping regulations is the World Anti-Doping Code, which harmonizes rules worldwide to promote fairness and athlete health. Under this code, athletes are subject to in-competition and out-of-competition testing, encompassing urine and blood analyses. Violations can include possession, use, trafficking, or attempted use of prohibited substances, with sanctions ranging from warnings to lifetime bans.\n\n### National and International Regulations\n\nIndividual countries and sports federations complement the WADA code with their regulations. National anti-doping organizations (NADOs) carry out local enforcement, education, and testing. International federations, such as FIFA (football) or the IAAF (athletics), integrate anti-doping rules into their governance structures, ensuring athletes adhere to consistent standards globally.\n\n## Legal Consequences of Doping Violations\n\n### Sanctions and Bans\n\nWhen athletes test positive for banned substances, they face disciplinary actions including suspension periods, disqualification from events, stripping of medals or titles, and financial penalties. Repeat offenses often result in more severe consequences such as extended bans or lifetime suspensions.\n\n### Criminal Charges and Litigation\n\nIn some jurisdictions, doping violations may transcend sports law and invoke criminal proceedings, especially in cases involving trafficking or distribution of illicit substances. Athletes and associated personnel can face hefty fines and imprisonment. Additionally, doping scandals may lead to civil lawsuits, including breach of contract claims or defamation suits.\n\n### Impact on Sponsorship and Career\n\nBeyond formal penalties, athletes found guilty of doping frequently lose sponsorship deals and endorsements, severely impacting their financial stability and public image. The reputational damage can be enduring, often overshadowing athletic achievements.\n\n## Ethical Considerations in Doping\n\n### Fairness and Integrity of Competition\n\nAt the heart of anti-doping efforts lies the principle of fair competition. Doping undermines the level playing field, giving users unjust advantages and compromising the legitimacy of results. Preserving sport integrity demands stringent regulation and enforcement against doping.\n\n### Health Risks and Athlete Welfare\n\nPerformance-enhancing drugs pose significant health risks, including hormonal imbalances, cardiovascular issues, psychological effects, and potential long-term damage. Ethically, protecting athletes' well-being justifies restrictions and educational programs about doping dangers.\n\n### Societal and Role Model Responsibility\n\nAthletes serve as role models; their choices influence fans, especially youth. Ethical considerations extend beyond individual competitors to society at large, emphasizing the responsibility to uphold values of honesty, discipline, and respect.\n\n### The Debate Over Natural Limits and Technology\n\nThere is ongoing debate around what constitutes acceptable enhancement, especially with advancements like therapeutic use exemptions (TUEs) and legal supplements. Ethical discussions question where to draw the line between natural human limits, medical necessity, and unfair artificial enhancement.\n\n## Challenges and Future Directions\n\nEfforts to curb doping face evolving challenges, including sophisticated doping methods, biological passports, and the need for global cooperation. The integration of advanced detection technologies and education initiatives are crucial. Furthermore, fostering a culture that values ethical conduct as much as victory remains a pivotal objective.\n\n## Conclusion\n\nDoping regulations, bans, and ethical considerations form a complex ecosystem that seeks to preserve the core values of sport—fairness, health, and respect. Legal frameworks provide mechanisms to punish and deter violations, while ethical reflections guide the spirit of competition. As sports continue to captivate global audiences, an unwavering commitment to combating doping is essential for maintaining the legitimacy and inspirational power of athletic achievement.\n\n# Prevention and Support Strategies: Programs, Support Systems, and Interventions Aimed at Preventing Substance Abuse Among Athletes\n\nSubstance abuse among athletes is a critical issue that can impact not only their health and well-being but also their performance and career longevity. Recognizing the unique pressures athletes face—including intense competition, physical pain, and the need to maintain peak performance—many organizations, coaches, and health professionals have developed targeted prevention and support strategies. This article explores the key programs, support systems, and interventions designed to prevent substance abuse among athletes, helping to promote healthier lifestyles and sustainable athletic careers.\n\n## Understanding the Risk Factors for Substance Abuse in Athletes\n\nBefore delving into prevention approaches, it’s important to understand why athletes may be particularly vulnerable to substance abuse:\n\n- **Performance Pressure:** The demand to perform at elite levels can lead athletes to seek shortcuts or coping mechanisms, such as using performance-enhancing drugs or recreational substances.\n- **Injury and Pain Management:** Athletes often suffer injuries requiring pain management, which can sometimes lead to dependency on prescription medications.\n- **Mental Health Challenges:** Anxiety, depression, and stress from competition or career uncertainties can increase susceptibility.\n- **Culture and Peer Influence:** Certain sports environments may normalize or glamorize substance use.\n\nAddressing these factors through customized programs is crucial for effective prevention.\n\n## Overview of Prevention Programs for Athletes\n\n### 1. Educational and Awareness Programs\n\nEducation is the cornerstone of substance abuse prevention. Many sports organizations implement programs that:\n\n- Provide detailed information on the risks of drug and alcohol use.\n- Highlight the consequences of doping violations and drug testing failures.\n- Teach coping strategies for performance anxiety and stress.\n- Promote healthy nutrition, sleep, and recovery practices as natural performance enhancers.\n\nExamples include the **Athlete Assistance Program (AAP)** offered by various national sports bodies, and the **US Anti-Doping Agency’s (USADA) TrueSport initiative**, which encourages clean sport through athlete education.\n\n### 2. Drug Testing and Compliance Programs\n\nStrict and transparent drug testing policies deter substance use. Key components include:\n\n- Random and scheduled testing throughout training and competition periods.\n- Clear communication of banned substances lists.\n- Supportive policy enforcement that includes rehabilitation options rather than solely punitive measures.\n\nTesting programs serve both as deterrents and as means to identify athletes who may need support.\n\n### 3. Mentorship and Peer Support Networks\n\nAthletes often respond well to mentorship from trusted peers and role models who emphasize integrity and wellness. Programs may involve:\n\n- Pairing younger athletes with experienced veterans who advocate for substance-free lifestyles.\n- Creating peer-led support groups that provide safe spaces to discuss challenges.\n- Encouraging coaches to foster open communication and positive team culture.\n\n### 4. Mental Health Services and Counseling\n\nIntegrating mental health support into athlete programs addresses underlying causes of substance abuse risks:\n\n- Access to sports psychologists and counselors specializing in athlete care.\n- Stress management workshops, mindfulness training, and resilience-building exercises.\n- Confidential services to address personal or career-related issues.\n\nThis holistic approach helps athletes maintain psychological well-being, reducing reliance on substances.\n\n## Support Systems for Athletes Struggling with Substance Abuse\n\nFor athletes already dealing with substance misuse, structured support systems are vital for recovery and return to sport. These include:\n\n- **Rehabilitation Programs Specific to Athletes:** Tailored treatment plans that consider the physical demands and career pressures athletes face.\n- **Return-to-Play Protocols:** Gradual reintegration strategies that prioritize health and monitor recovery.\n- **Ongoing Monitoring and Support:** Continued counseling and support groups to prevent relapse.\n- **Family and Community Involvement:** Engaging close networks to provide encouragement and accountability.\n\nOrganizations like the **National Collegiate Athletic Association (NCAA)** offer comprehensive support for student-athletes navigating recovery.\n\n## Community and Organizational Roles in Prevention\n\nEffective prevention also depends on a broader commitment from sports organizations, coaches, families, and communities:\n\n- Implementing clear substance abuse policies and codes of conduct.\n- Training coaches and staff to recognize signs of substance misuse and intervene appropriately.\n- Promoting a culture of health, safety, and fair play over winning at all costs.\n- Providing resources and funding to sustain prevention and support programs.\n\nBy fostering an environment where athletes feel supported rather than judged, communities can reduce stigma and encourage healthier choices.\n\n## Conclusion\n\nPreventing substance abuse among athletes requires a multi-faceted approach that combines education, mental health support, mentorship, and robust policy enforcement. Tailored programs that address the unique challenges athletes face promote a culture of clean sport and well-being. Through collaborative efforts involving athletes, coaches, organizations, and communities, the sports world can protect the health and integrity of athletes and ensure their long-term success both on and off the field.\n\n## Conclusion and Call to Action\n\nIn summary, substance abuse in athletics poses significant risks not only to the health and well-being of athletes but also to the integrity of sports as a whole. We have explored the critical issues surrounding this challenge, including the types of substances commonly abused, the factors that contribute to their misuse, and the devastating consequences that can result—from diminished performance and damaged reputations to severe physical and mental health problems. Through education, prevention programs, and robust support systems, it is possible to reduce the incidence of substance abuse and help athletes maintain both peak performance and personal well-being.\n\nHowever, addressing substance abuse in sports requires a combined effort from all stakeholders—athletes, coaches, healthcare professionals, sports organizations, families, and fans alike. Increased awareness is the first essential step. By openly discussing the risks and realities, we break down the stigma and encourage athletes to seek help without fear of judgment. Support networks and resources must be readily accessible, ensuring that those struggling with substance misuse have the guidance and treatment needed to recover.\n\nWe call on everyone involved in athletics to take action. Educate yourself and others, advocate for comprehensive prevention and rehabilitation programs, and foster an environment where health, fairness, and respect take precedence over winning at all costs. Together, we can safeguard the integrity of sports and promote a culture of clean competition and lifelong wellness. Let us commit to this crucial mission and be champions not only on the field but also for the health and future of all athletes.")</code></pre>
</div>
</div>
<p>Next, you’ll learn how to implement this pattern using LangGraph.</p>
</section>
<section id="langgraph-3" class="level4">
<h4 class="anchored" data-anchor-id="langgraph-3">LangGraph</h4>
<p>You must define the state of the orchestrator, the workers (who write the sections), and the data models used in the workflow.</p>
<div id="cell-82" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb36-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Section(BaseModel):</span>
<span id="cb36-2">    name: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The name of the section"</span>)</span>
<span id="cb36-3">    description: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The description of the section"</span>)</span>
<span id="cb36-4"></span>
<span id="cb36-5"></span>
<span id="cb36-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> CompletedSection(BaseModel):</span>
<span id="cb36-7">    name: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The name of the section"</span>)</span>
<span id="cb36-8">    content: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The content of the section"</span>)</span>
<span id="cb36-9"></span>
<span id="cb36-10"></span>
<span id="cb36-11"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Sections(BaseModel):</span>
<span id="cb36-12">    sections: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[Section] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The sections of the article"</span>)</span>
<span id="cb36-13"></span>
<span id="cb36-14"></span>
<span id="cb36-15"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> OrchestratorState(TypedDict):</span>
<span id="cb36-16">    topic: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb36-17">    sections: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[Section]</span>
<span id="cb36-18">    completed_sections: Annotated[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[CompletedSection], operator.add]</span>
<span id="cb36-19">    final_report: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb36-20"></span>
<span id="cb36-21"></span>
<span id="cb36-22"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> WorkerState(TypedDict):</span>
<span id="cb36-23">    section: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb36-24">    completed_sections: Annotated[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[Section], operator.add]</span></code></pre></div>
</div>
<p>The state definition changes slightly, as in this case, you need to define a worker state, which is used when the orchestrator assigns a task to a worker.</p>
<div id="cell-84" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb37-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> orchestrator(state: OrchestratorState) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>:</span>
<span id="cb37-2">    model_planner <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.with_structured_output(Sections)</span>
<span id="cb37-3">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb37-4">        SystemMessage(</span>
<span id="cb37-5">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer specialized in SEO. Provided with a topic, you will generate the sections for a short article."</span></span>
<span id="cb37-6">        ),</span>
<span id="cb37-7">        HumanMessage(</span>
<span id="cb37-8">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Generate the sections of an article about </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'topic'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb37-9">        ),</span>
<span id="cb37-10">    ]</span>
<span id="cb37-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sections"</span>: model_planner.invoke(messages).sections}</span>
<span id="cb37-12"></span>
<span id="cb37-13"></span>
<span id="cb37-14"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> write_section(state: WorkerState) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb37-15">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb37-16">        SystemMessage(</span>
<span id="cb37-17">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer specialized in SEO. Provided with a topic and a table of contents, you will generate the content of the article."</span></span>
<span id="cb37-18">        ),</span>
<span id="cb37-19">        HumanMessage(</span>
<span id="cb37-20">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Generate the content of an article about </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'section'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> with the following description: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'section'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>description<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb37-21">        ),</span>
<span id="cb37-22">    ]</span>
<span id="cb37-23">    section <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> CompletedSection(</span>
<span id="cb37-24">        name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'section'</span>].name, content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>model.invoke(messages).content</span>
<span id="cb37-25">    )</span>
<span id="cb37-26">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"completed_sections"</span>: [section]}</span>
<span id="cb37-27"></span>
<span id="cb37-28"></span>
<span id="cb37-29"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> synthesizer(state: OrchestratorState) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb37-30">    ordered_sections <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"completed_sections"</span>]</span>
<span id="cb37-31">    completed_sections_str <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>.join(</span>
<span id="cb37-32">        [section.content <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> section <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ordered_sections]</span>
<span id="cb37-33">    )</span>
<span id="cb37-34">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"final_report"</span>: completed_sections_str}</span>
<span id="cb37-35"></span>
<span id="cb37-36"></span>
<span id="cb37-37"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> assign_workers(state: OrchestratorState) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>:</span>
<span id="cb37-38">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> [</span>
<span id="cb37-39">        Send(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"write_section"</span>, {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"section"</span>: section}) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> section <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sections"</span>]</span>
<span id="cb37-40">    ]</span></code></pre></div>
</div>
<p>Then, you’ll define the graph that will be used to run the workflow.</p>
<div id="cell-86" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb38-1">workflow_builder <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> StateGraph(OrchestratorState)</span>
<span id="cb38-2"></span>
<span id="cb38-3">workflow_builder.add_node(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"orchestrator"</span>, orchestrator)</span>
<span id="cb38-4">workflow_builder.add_node(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"write_section"</span>, write_section)</span>
<span id="cb38-5">workflow_builder.add_node(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"synthesizer"</span>, synthesizer)</span>
<span id="cb38-6"></span>
<span id="cb38-7">workflow_builder.add_edge(START, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"orchestrator"</span>)</span>
<span id="cb38-8">workflow_builder.add_conditional_edges(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"orchestrator"</span>, assign_workers, [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"write_section"</span>])</span>
<span id="cb38-9">workflow_builder.add_edge(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"write_section"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"synthesizer"</span>)</span>
<span id="cb38-10"></span>
<span id="cb38-11">workflow <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> workflow_builder.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">compile</span>()</span></code></pre></div>
</div>
<p>You build the workflow by initializing a <code>StateGraph</code> object. In it, you’ll assign your functions to serve as nodes and then define the edges that establish the pathways between them. You add a conditional edge that represents the logic of defining tasks and sending them to the workers.</p>
<p>Once you’ve defined the graph, you can compile.</p>
<p>Finally, you can generate a diagram of the workflow using the <code>get_graph</code> and <code>draw_mermaid_png</code> methods. You’ll noticed that compared to the parallelization workflow, the orchestrator-workers has a dotted line from the orchestrator to the workers, which means that the orchestrator conditionally defines the tasks to be sent to the workers.</p>
<div id="cell-88" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb39-1">display(Image(workflow.get_graph().draw_mermaid_png()))</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="agentic-workflows-langgraph_files/figure-html/cell-35-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="https://dylancastillo.co/posts/agentic-workflows-langgraph_files/figure-html/cell-35-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Then, you can run the workflow.</p>
<div id="cell-90" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb40-1">workflow.invoke({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"topic"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Substance abuse of athletes"</span>})</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="35">
<pre><code>{'topic': 'Substance abuse of athletes',
 'sections': [Section(name='Introduction to Substance Abuse in Athletes', description='Overview of substance abuse issues commonly faced by athletes, including types of substances and reasons for usage.'),
  Section(name='Common Substances Abused by Athletes', description='Detailed description of substances frequently abused such as steroids, stimulants, painkillers, and recreational drugs.'),
  Section(name='Causes and Risk Factors', description='Exploration of psychological, social, and professional factors that contribute to substance abuse among athletes.'),
  Section(name='Health and Performance Consequences', description="Analysis of the physical and mental impacts of substance abuse on athletes' health and sports performance."),
  Section(name='Detection and Prevention Strategies', description='Information on how substance abuse is detected in athletes and strategies used to prevent it, including testing and education programs.'),
  Section(name='Support and Rehabilitation', description='Description of available support systems and rehabilitation programs designed to help athletes overcome substance abuse.'),
  Section(name='Conclusion and Future Perspectives', description='Summary of key points and discussion of emerging trends and future approaches to addressing substance abuse among athletes.')],
 'completed_sections': [CompletedSection(name='Introduction to Substance Abuse in Athletes', content='# Introduction to Substance Abuse in Athletes\n\nSubstance abuse among athletes is a significant concern that affects not only their health but also their performance, careers, and overall well-being. Despite the physical and mental discipline required in sports, athletes are not immune to the pressures and challenges that can lead to the use and abuse of various substances. Understanding the types of substances commonly used and the reasons why athletes may turn to them is crucial for addressing this issue effectively.\n\n## Common Types of Substances Abused by Athletes\n\nAthletes may misuse a wide range of substances, each serving different purposes or fulfilling different needs depending on the individual and their circumstances. Some of the most common categories include:\n\n### 1. Performance-Enhancing Drugs (PEDs)\nPerformance-enhancing drugs are substances used to improve athletic ability beyond natural limits. These include anabolic steroids, human growth hormone (HGH), erythropoietin (EPO), and stimulants. Athletes may use these drugs to increase muscle mass, enhance endurance, speed up recovery, and gain a competitive advantage.\n\n### 2. Recreational Drugs\nRecreational drugs such as marijuana, cocaine, MDMA, and opioids are sometimes abused by athletes to cope with stress, manage pain, or for social reasons. While these substances do not improve athletic performance and can be detrimental, their use is often linked to external pressures or underlying issues.\n\n### 3. Prescription Medications\nCertain prescription medications, including painkillers (opioids), anti-anxiety drugs (benzodiazepines), and stimulants (used for ADHD), can be abused by athletes. These drugs might be used to manage pain from injuries, reduce anxiety before competitions, or increase focus and alertness.\n\n### 4. Over-the-Counter (OTC) Substances and Supplements\nThough generally legal and accessible, some OTC substances and dietary supplements can be misused, especially when athletes seek to lose weight rapidly or boost energy. Misuse can sometimes lead to harmful side effects or positive doping tests if the substances contain banned ingredients.\n\n## Reasons for Substance Abuse Among Athletes\n\nThe motivations behind substance abuse in athletes are complex and multifaceted. Some of the most common reasons include:\n\n### 1. Enhancing Performance\nThe intense desire to win and excel can lead athletes to experiment with drugs that promise enhanced strength, endurance, or recovery. In highly competitive environments, athletes may feel pressure to push beyond their natural limits.\n\n### 2. Coping with Pain and Injuries\nPhysical injuries are common in sports, and the pain associated with them can lead athletes to seek relief through prescription painkillers or other substances. Unfortunately, this can sometimes escalate into abuse and dependency.\n\n### 3. Managing Stress and Anxiety\nThe psychological pressures of competition, public scrutiny, and personal expectations can cause significant mental stress. Some athletes turn to drugs to alleviate anxiety, improve mood, or escape from personal and professional challenges.\n\n### 4. Peer Influence and Culture\nIn some sports cultures, the use of substances may be normalized or even encouraged, creating an environment where athletes feel compelled to conform. Peer influence and the desire to belong can drive substance use.\n\n### 5. Weight Control and Body Image\nCertain sports emphasize weight categories or aesthetic appearance, prompting athletes to misuse substances that suppress appetite or promote rapid weight loss.\n\n## Conclusion\n\nSubstance abuse in athletes is a serious and multifaceted problem that demands awareness, education, and intervention at multiple levels. Recognizing the types of substances commonly abused and understanding the underlying reasons for their use is the first step towards promoting healthier choices and safeguarding the integrity of sports. Athletes, coaches, medical professionals, and organizations must work collaboratively to address these issues through prevention, support, and treatment.'),
  CompletedSection(name='Common Substances Abused by Athletes', content='# Common Substances Abused by Athletes\n\nAthletes often face immense pressure to perform at their best, maintain stamina, and recover quickly from injuries. Unfortunately, some turn to substances that can enhance performance or alleviate pain, despite the health risks and ethical concerns involved. This article provides a detailed description of the most frequently abused substances among athletes, focusing on steroids, stimulants, painkillers, and recreational drugs.\n\n## Anabolic Steroids\n\nAnabolic steroids are synthetic variations of the male hormone testosterone. Athletes abuse them to increase muscle mass, strength, and overall physical performance. Steroids work by promoting protein synthesis within cells, leading to rapid muscle growth.\n\n### Common Types and Effects\n- **Types**: Testosterone, nandrolone, stanozolol, and methyltestosterone.\n- **Effects**: Increased muscle size, enhanced recovery rate, greater endurance, and reduced fatigue.\n\n### Risks and Side Effects\n- Hormonal imbalances leading to acne, hair loss, and mood swings.\n- Cardiovascular issues such as high blood pressure and increased risk of heart attack.\n- Liver damage and potential infertility.\n- Psychological effects including aggression and depression.\n  \nDespite their performance-enhancing properties, anabolic steroids are banned in most sports leagues and athletic organizations.\n\n## Stimulants\n\nStimulants are substances that increase alertness, attention, and energy by enhancing the activity of the central nervous system. Athletes may use stimulants to reduce fatigue and improve focus during training or competition.\n\n### Common Stimulants\n- **Amphetamines**: Often prescribed for ADHD but misused for increased energy.\n- **Caffeine**: The world’s most widely consumed legal stimulant.\n- **Ephedrine**: Used for weight loss and increased energy but banned in many competitions.\n  \n### Effects\n- Increased heart rate and blood pressure.\n- Heightened concentration and wakefulness.\n- Temporary reduction of appetite and fatigue.\n\n### Risks\n- Dependence and addiction.\n- Cardiovascular complications, including arrhythmias and heart attacks.\n- Nervousness, anxiety, and sleep disturbances.\n  \nWhile moderate caffeine use is generally accepted, other stimulants are typically prohibited due to their performance-enhancing effects and health risks.\n\n## Painkillers\n\nPainkillers, particularly opioid analgesics and non-steroidal anti-inflammatory drugs (NSAIDs), are commonly prescribed to manage injuries and pain. However, abuse can occur when athletes rely excessively on these drugs to continue competing.\n\n### Commonly Abused Painkillers\n- **Opioids**: Morphine, oxycodone, hydrocodone.\n- **NSAIDs**: Ibuprofen, naproxen (abuse generally less severe but problematic if overused).\n\n### Effects\n- Temporary pain relief and increased ability to train through injury.\n- Sedation and euphoria (primarily with opioids).\n\n### Risks\n- Opioid addiction, respiratory depression, and overdose.\n- Gastrointestinal issues and kidney damage with long-term NSAID use.\n- Masking of pain leading to worsened injuries.\n\nDue to the risk of dependency, strict guidelines exist for the medical use of painkillers among athletes.\n\n## Recreational Drugs\n\nSome athletes use recreational drugs for relaxation or coping with stress, despite the negative impact on performance and health.\n\n### Common Recreational Drugs Abused\n- **Cannabis**: Used for relaxation and pain relief; banned in many competitions.\n- **Alcohol**: Consumed socially but can impair recovery and performance.\n- **Cocaine and Ecstasy**: Occasionally abused for their stimulant and euphoric effects.\n\n### Effects\n- Altered mental state, reduced reaction time, and impaired coordination.\n- Short-term mood enhancement or relaxation.\n\n### Risks\n- Detrimental effects on cardiovascular health.\n- Legal issues and sanctions from sports authorities.\n- Negative impact on motivation, training, and overall athletic performance.\n\n## Conclusion\n\nThe abuse of steroids, stimulants, painkillers, and recreational drugs poses serious health risks and ethical dilemmas in sports. While the desire to perform better or manage pain is understandable, these substances can undermine an athlete’s long-term wellbeing and the integrity of athletic competition. Education, support, and strict regulation remain crucial in addressing substance abuse among athletes.'),
  CompletedSection(name='Causes and Risk Factors', content='# Causes and Risk Factors: Exploring Psychological, Social, and Professional Contributors to Substance Abuse Among Athletes\n\nSubstance abuse among athletes is a pressing concern that extends beyond physical performance to affect their mental health, career longevity, and overall well-being. Understanding the underlying causes and risk factors is essential for developing effective prevention and intervention strategies. This article delves into the psychological, social, and professional factors that contribute to substance abuse in the athletic community.\n\n## Psychological Factors\n\n### Pressure to Perform and Perfectionism\nAthletes often face intense pressure to perform at peak levels consistently. This demand can trigger anxiety, stress, and feelings of inadequacy. The desire for perfection may lead some athletes to use substances such as stimulants or performance-enhancing drugs to cope with the high expectations and overcome self-doubt.\n\n### Mental Health Challenges\nDepression, anxiety disorders, and other mental health issues are prevalent among athletes. The stigma around seeking psychological help often forces athletes to self-medicate with alcohol or drugs as a way to manage emotional pain, stress, or injury-related trauma.\n\n### Coping Mechanisms for Injury and Pain\nPhysical injuries are a common aspect of athletic careers. The chronic pain associated with injuries can lead athletes to misuse prescription medications like opioids or overconsume alcohol to alleviate discomfort and continue training or competing, inadvertently increasing the risk of substance dependence.\n\n## Social Factors\n\n### Peer Influence and Team Culture\nThe social environment within teams can profoundly impact substance use behaviors. If drug or alcohol use is normalized or even glamorized among teammates, new or younger athletes may feel pressured to conform to these norms to gain acceptance or camaraderie.\n\n### Social Isolation and Loneliness\nDespite being part of a team, athletes may experience social isolation due to rigorous training schedules, travel, or being away from family and friends. This loneliness can increase vulnerability to substance use as a misguided attempt to fill emotional voids or manage feelings of alienation.\n\n### Media and Celebrity Influence\nExposure to celebrity athletes who openly use or are rumored to use substances can create misleading narratives about drug use and its perceived benefits. This influence can lower inhibitions and reshape attitudes towards substance use, especially among younger athletes aspiring to emulate their idols.\n\n## Professional Factors\n\n### Demands of Competitive Sports\nThe professional athletic environment is highly competitive, with careers often hinging on performance and winning. The associated stress can drive athletes to use substances that promise enhanced stamina, focus, or recovery, sometimes blurring the line between legitimate medical use and abuse.\n\n### Career Uncertainty and Transition Stress\nAthletes frequently face uncertainty regarding career longevity due to factors such as injuries or declining performance. The stress related to contract negotiations, retirement planning, or forced career changes may lead to increased substance use as a maladaptive coping strategy.\n\n### Accessibility and Medical Prescriptions\nAthletes generally have greater access to medical facilities and prescription medications than the general population. While this access is crucial for health management, it also increases the risk of prescription drug misuse, especially when oversight is inadequate or when medications are used beyond therapeutic purposes.\n\n## Conclusion\n\nThe causes and risk factors behind substance abuse among athletes are multifaceted, involving a complex interplay of psychological pressures, social dynamics, and professional challenges. Recognizing these contributing elements is vital for coaches, medical professionals, and support networks to create comprehensive prevention programs and provide the necessary resources to help athletes maintain healthy lifestyles free from substance abuse. Only through holistic understanding and targeted action can the athletic community effectively combat this pervasive issue.'),
  CompletedSection(name='Health and Performance Consequences', content="# Health and Performance Consequences: The Physical and Mental Impacts of Substance Abuse on Athletes\n\nSubstance abuse among athletes is a critical issue that can profoundly affect both their health and sports performance. While some may turn to drugs or alcohol as a coping mechanism for stress, injury, or pressure, the consequences can be far-reaching and damaging. This article provides an in-depth analysis of the physical and mental impacts of substance abuse on athletes, emphasizing why maintaining a healthy lifestyle is essential for peak performance and overall well-being.\n\n## Physical Impacts of Substance Abuse on Athletes\n\n### 1. Deterioration of Cardiovascular Health\nMany substances abused by athletes, such as stimulants and anabolic steroids, place significant strain on the cardiovascular system. Stimulants like cocaine and amphetamines increase heart rate and blood pressure, leading to arrhythmias, hypertension, and even sudden cardiac arrest. Anabolic steroids can cause thickening of the heart muscle and increase the risk of heart attacks and strokes. Such cardiovascular issues directly impair an athlete's endurance, stamina, and ability to perform at high levels.\n\n### 2. Impaired Muscular Strength and Recovery\nThough some athletes misuse anabolic steroids to enhance muscle mass, chronic abuse can backfire by causing muscle cramps, weakness, and tendon ruptures. Other substances like alcohol interfere with protein synthesis and muscle repair, prolonging recovery time after training or injury. Dehydration and nutrient depletion caused by certain drugs further weaken muscles, limiting strength and agility on the field.\n\n### 3. Compromised Immune Function\nSubstance abuse can suppress the immune system, making athletes more susceptible to infections and illnesses. For example, excessive alcohol intake has been shown to reduce white blood cell activity, reducing the body’s ability to fight off viruses and bacteria. This leads to increased downtime due to illness and a diminished capacity to handle the physical demands of training and competition.\n\n### 4. Respiratory and Neurological Damage\nSmoking substances like tobacco or marijuana damages lung tissue and reduces oxygen uptake, critical for aerobic performance. Inhalants and certain drugs can cause long-term neurological damage including impaired coordination, balance, and reflexes—all vital for athletic skills. Brain injuries resulting from drug use can be irreversible, severely impacting motor skills and reaction times.\n\n## Mental and Psychological Consequences\n\n### 1. Cognitive Decline and Impaired Decision-Making\nSubstance abuse affects areas of the brain responsible for judgment, focus, and reaction time. Athletes abusing drugs may experience difficulties with concentration, memory, and decision-making — all essential skills for strategic gameplay and quick reactions in sports. Cognitive impairment can lead to poor game performance and increased risk of injury.\n\n### 2. Increased Anxiety, Depression, and Mood Disorders\nMany athletes turn to substances as a method of managing anxiety or depression. However, the temporary relief these substances provide is often followed by worsening symptoms. Long-term substance abuse is linked with increased rates of anxiety disorders, depression, and mood swings. Mental health struggles not only impair motivation and training consistency but also increase the likelihood of burnout and withdrawal from sport.\n\n### 3. Addiction and Dependence\nPhysical and psychological dependence on performance-enhancing or recreational drugs can trap athletes in destructive cycles. Addiction disrupts daily routines, training schedules, and professional commitments. The stress of hiding substance use and dealing with its consequences adds an additional psychological burden, often leading to social isolation and damaged relationships.\n\n### 4. Impact on Team Dynamics and Reputation\nMental health issues stemming from substance abuse can make athletes volatile or withdrawn, affecting communication and collaboration within a team. Additionally, public knowledge of substance abuse can tarnish an athlete’s reputation, leading to a loss of sponsorships, fan support, and career opportunities.\n\n## Conclusion: Prioritizing Health to Sustain Performance\n\nThe interplay between substance abuse and athletic health creates a dangerous cycle where physical and mental degradations impair performance, which in turn may lead to further substance use in an attempt to compensate. Athletes must prioritize healthy coping strategies, proper medical guidance, and mental health support to maintain optimal performance and longevity in their sports careers. Coaches, trainers, and sporting organizations also play a pivotal role in providing education and resources to prevent substance abuse and support recovery. Ultimately, safeguarding an athlete’s well-being ensures not only superior performance but a fulfilling and sustainable athletic journey."),
  CompletedSection(name='Detection and Prevention Strategies', content='# Detection and Prevention Strategies for Substance Abuse in Athletes\n\nSubstance abuse in athletes not only undermines fair competition but also poses significant health risks. To maintain integrity in sports and protect athletes’ well-being, robust detection and prevention strategies are essential. This article explores the methods used to identify substance abuse in athletes and the proactive approaches employed to prevent it, focusing on testing protocols and educational programs.\n\n## Detection of Substance Abuse in Athletes\n\n### 1. Drug Testing Protocols\nOne of the primary methods for detecting substance abuse in athletes is through comprehensive drug testing programs. These tests can be conducted both in and out of competition, aiming to identify banned substances such as anabolic steroids, stimulants, diuretics, and other performance-enhancing drugs (PEDs).\n\n- **Urine Testing:** The most common and widely used method, urine tests can detect a broad range of substances and their metabolites. Samples are collected under strict supervision to prevent tampering.\n- **Blood Testing:** Used to detect substances that may not appear in urine or to determine the concentration of certain drugs, such as erythropoietin (EPO) or hormones.\n- **Hair and Saliva Testing:** These methods are less common but provide longer detection windows or rapid results, respectively.\n\nTesting is typically random, scheduled, or targeted based on certain risk factors or suspicious behavior, helping to deter and catch substance abuse.\n\n### 2. Biological Passport Programs\nThe Athlete Biological Passport (ABP) monitors selected biological variables over time. Rather than detecting the substance directly, it identifies abnormal changes in an athlete’s biological markers that suggest doping. This method enhances detection capabilities for substances that are otherwise difficult to identify.\n\n### 3. Observational and Behavioral Monitoring\nCoaches, medical staff, and anti-doping officials also rely on behavioral observations to detect potential substance abuse. Changes in performance, physical appearance, or behavior can prompt further investigation or testing.\n\n## Prevention Strategies\n\n### 1. Education Programs\nEducation is a cornerstone in preventing substance abuse. Athletes, coaches, and supporting personnel are provided with information about:\n\n- The health risks associated with drug use.\n- The ethical implications and impact on sporting integrity.\n- The specific substances banned by anti-doping authorities.\n- How testing procedures work and the consequences of violations.\n\nEffective education fosters informed decision-making and empowers athletes to resist pressure or temptation to use prohibited substances.\n\n### 2. Promoting a Culture of Clean Sport\nEncouraging a culture that values fair play and health over winning at all costs is essential. This includes:\n\n- Encouraging open dialogue about doping risks.\n- Highlighting positive role models who compete clean.\n- Building supportive environments where athletes can seek help for pressures or substance-related issues without stigma.\n\n### 3. Support Services and Counseling\nProviding access to psychological support and counseling can address underlying issues that might lead athletes to use substances, such as stress, anxiety, or injury-related pain management.\n\n### 4. Policy and Enforcement\nClear rules, consistent enforcement, and transparent consequences reinforce deterrents against doping. Collaboration among sports organizations, anti-doping agencies, and governments ensures that policies are up-to-date and effectively implemented.\n\n## Conclusion\n\nDetecting and preventing substance abuse in athletes requires a multifaceted approach that combines advanced testing technologies, continuous monitoring, education, and supportive environments. By integrating these strategies, the sports community can better protect athletes’ health, uphold the spirit of fair competition, and maintain public confidence in sport.'),
  CompletedSection(name='Support and Rehabilitation', content='# Support and Rehabilitation: Helping Athletes Overcome Substance Abuse\n\nSubstance abuse is a significant challenge faced by many athletes, often impacting not only their performance but also their overall health and well-being. Fortunately, a variety of support systems and rehabilitation programs have been developed to assist athletes in overcoming these issues. These resources provide comprehensive care, from initial intervention to long-term recovery, helping athletes regain control of their lives both on and off the field.\n\n## Understanding the Need for Support and Rehabilitation\n\nAthletes are under tremendous pressure to perform, which can sometimes lead to the misuse of substances such as performance enhancers, painkillers, or recreational drugs. The stigma surrounding substance abuse in sports may create barriers to seeking help, making effective support and rehabilitation programs critical.\n\nThese programs are specifically designed to address the unique physical, emotional, and psychological demands athletes face. Tailored support systems ensure that athletes receive care that respects their competitive schedules while focusing on sustainable recovery.\n\n## Types of Support Systems Available to Athletes\n\n### 1. Counseling and Psychological Support\n\nOne of the foundational elements in addressing substance abuse is access to professional counseling. Sports psychologists and addiction counselors work with athletes to tackle underlying issues such as anxiety, depression, or trauma that often contribute to substance misuse. Cognitive-behavioral therapy (CBT) and motivational interviewing are common techniques used to foster behavioral change and build resilience.\n\n### 2. Peer Support Groups\n\nPeer networks provide a safe environment where athletes can share experiences, challenges, and coping strategies. Groups such as Athlete Assistance Programs (AAP) and specialized 12-step programs tailored for athletes encourage mutual support and accountability. Being part of a community reduces feelings of isolation and stigma, fostering a sense of belonging and motivation.\n\n### 3. Family and Social Support\n\nRehabilitation is more effective when athletes have a strong support system at home and within their social circles. Many programs involve family therapy or educational sessions to help loved ones understand substance abuse and learn how to provide constructive support throughout recovery.\n\n## Rehabilitation Programs Tailored for Athletes\n\n### 1. Inpatient Rehabilitation\n\nFor athletes with severe substance dependence, inpatient rehabilitation centers offer intensive, structured care. These programs provide medical supervision, detoxification services, and comprehensive therapy in a controlled environment. Many centers integrate physical conditioning and sports-specific rehabilitation to help athletes maintain fitness and facilitate reintegration into their sport.\n\n### 2. Outpatient Rehabilitation\n\nOutpatient programs provide flexibility for athletes who cannot commit to prolonged residential stays due to training or competition schedules. These programs offer scheduled therapy sessions, group meetings, and medical support, allowing athletes to receive care while continuing their regular activities. Outpatient care often serves as a step-down for those transitioning from inpatient programs.\n\n### 3. Holistic and Integrative Approaches\n\nModern rehabilitation programs increasingly incorporate holistic therapies to address the physical and emotional aspects of recovery. These may include yoga, mindfulness meditation, nutrition counseling, and acupuncture. Such approaches help athletes develop healthier lifestyles, manage stress, and reduce the likelihood of relapse.\n\n## Role of Sports Organizations and Governing Bodies\n\nSports organizations play a pivotal role in providing resources and creating policies that support athletes facing substance abuse. Many federations offer confidential help lines, educational seminars, and funding for rehabilitation programs. Anti-doping agencies also emphasize rehabilitation over punishment, aiming to promote athlete health and ethical competition.\n\n## Success Stories and Outcomes\n\nNumerous athletes have successfully overcome substance abuse through dedicated support and rehabilitation. These success stories highlight the effectiveness of targeted programs that combine medical treatment, psychological support, and social reintegration. Recovery not only improves personal health but also restores athletic potential and inspires others facing similar struggles.\n\n## Conclusion\n\nSubstance abuse among athletes is a complex issue requiring specialized support and rehabilitation programs. By leveraging counseling, peer support, family involvement, and tailored rehabilitation services, athletes can overcome these challenges and return to optimal performance and well-being. Ongoing collaboration between healthcare providers, sports organizations, and athletes themselves is essential to foster environments that encourage recovery and sustainable success.'),
  CompletedSection(name='Conclusion and Future Perspectives', content='## Conclusion and Future Perspectives\n\n### Summary of Key Points\n\nAddressing substance abuse among athletes remains a critical challenge that demands comprehensive, evidence-based strategies. Throughout this article, we have explored the multifaceted nature of substance abuse in the athletic community, highlighting its complex interplay with physical performance pressures, mental health issues, and social influences. Key points include:\n\n- **Prevalence and Types of Substance Abuse:** Athletes are susceptible to various substances, ranging from performance-enhancing drugs like anabolic steroids to recreational drugs and prescription medication misuse.\n- **Risk Factors:** High-performance demands, injury management, psychological stress, and the culture of competitive sports contribute significantly to the risk of substance abuse.\n- **Impact on Health and Career:** Substance abuse not only jeopardizes athletes’ physical and mental well-being but also threatens their careers through sanctions, suspensions, and loss of reputation.\n- **Current Prevention and Intervention Strategies:** These include education programs, strict doping controls, psychological support, and rehabilitation services tailored to the athletic population.\n\nUnderstanding these essentials underscores the need for a strategic, multidisciplinary approach to mitigate substance abuse risks effectively.\n\n### Emerging Trends and Future Approaches\n\nLooking forward, the landscape of managing substance abuse among athletes is evolving, propelled by advancements in technology, research, and policy development. New trends and promising approaches include:\n\n- **Personalized Prevention Programs:** Leveraging data analytics and behavioral assessments to create individualized intervention plans that address specific risk factors and psychological profiles unique to each athlete.\n- **Enhanced Screening and Detection Methods:** Innovations such as biomarker identification, genetic testing, and advanced neuroimaging are improving the accuracy and timeliness of substance abuse detection.\n- **Integrative Mental Health Services:** Future programs emphasize holistic care by integrating mental health support, stress management, and resilience training within athletic training and medical teams.\n- **Technology-Driven Monitoring:** Wearable devices and mobile health apps are emerging as tools to monitor physiological and psychological indicators, enabling early intervention before substance use escalates.\n- **Policy and Cultural Shift:** Developing policies that not only penalize substance abuse but also destigmatize seeking help, encouraging athletes to come forward without fear of retaliation or judgment.\n- **Collaborative Stakeholder Engagement:** Involving coaches, medical staff, sports organizations, family members, and peers to foster a supportive environment conducive to prevention and recovery.\n\n### Conclusion\n\nThe fight against substance abuse among athletes is ongoing, and it requires adaptability to emerging scientific insights and societal changes. By embracing innovative technologies, prioritizing mental health, and fostering open communication, sports communities can better protect athletes from the risks of substance abuse. The future holds promise for more effective, personalized, and compassionate approaches that not only safeguard athletic integrity but also promote overall health and well-being.')],
 'final_report': "# Introduction to Substance Abuse in Athletes\n\nSubstance abuse among athletes is a significant concern that affects not only their health but also their performance, careers, and overall well-being. Despite the physical and mental discipline required in sports, athletes are not immune to the pressures and challenges that can lead to the use and abuse of various substances. Understanding the types of substances commonly used and the reasons why athletes may turn to them is crucial for addressing this issue effectively.\n\n## Common Types of Substances Abused by Athletes\n\nAthletes may misuse a wide range of substances, each serving different purposes or fulfilling different needs depending on the individual and their circumstances. Some of the most common categories include:\n\n### 1. Performance-Enhancing Drugs (PEDs)\nPerformance-enhancing drugs are substances used to improve athletic ability beyond natural limits. These include anabolic steroids, human growth hormone (HGH), erythropoietin (EPO), and stimulants. Athletes may use these drugs to increase muscle mass, enhance endurance, speed up recovery, and gain a competitive advantage.\n\n### 2. Recreational Drugs\nRecreational drugs such as marijuana, cocaine, MDMA, and opioids are sometimes abused by athletes to cope with stress, manage pain, or for social reasons. While these substances do not improve athletic performance and can be detrimental, their use is often linked to external pressures or underlying issues.\n\n### 3. Prescription Medications\nCertain prescription medications, including painkillers (opioids), anti-anxiety drugs (benzodiazepines), and stimulants (used for ADHD), can be abused by athletes. These drugs might be used to manage pain from injuries, reduce anxiety before competitions, or increase focus and alertness.\n\n### 4. Over-the-Counter (OTC) Substances and Supplements\nThough generally legal and accessible, some OTC substances and dietary supplements can be misused, especially when athletes seek to lose weight rapidly or boost energy. Misuse can sometimes lead to harmful side effects or positive doping tests if the substances contain banned ingredients.\n\n## Reasons for Substance Abuse Among Athletes\n\nThe motivations behind substance abuse in athletes are complex and multifaceted. Some of the most common reasons include:\n\n### 1. Enhancing Performance\nThe intense desire to win and excel can lead athletes to experiment with drugs that promise enhanced strength, endurance, or recovery. In highly competitive environments, athletes may feel pressure to push beyond their natural limits.\n\n### 2. Coping with Pain and Injuries\nPhysical injuries are common in sports, and the pain associated with them can lead athletes to seek relief through prescription painkillers or other substances. Unfortunately, this can sometimes escalate into abuse and dependency.\n\n### 3. Managing Stress and Anxiety\nThe psychological pressures of competition, public scrutiny, and personal expectations can cause significant mental stress. Some athletes turn to drugs to alleviate anxiety, improve mood, or escape from personal and professional challenges.\n\n### 4. Peer Influence and Culture\nIn some sports cultures, the use of substances may be normalized or even encouraged, creating an environment where athletes feel compelled to conform. Peer influence and the desire to belong can drive substance use.\n\n### 5. Weight Control and Body Image\nCertain sports emphasize weight categories or aesthetic appearance, prompting athletes to misuse substances that suppress appetite or promote rapid weight loss.\n\n## Conclusion\n\nSubstance abuse in athletes is a serious and multifaceted problem that demands awareness, education, and intervention at multiple levels. Recognizing the types of substances commonly abused and understanding the underlying reasons for their use is the first step towards promoting healthier choices and safeguarding the integrity of sports. Athletes, coaches, medical professionals, and organizations must work collaboratively to address these issues through prevention, support, and treatment.\n\n# Common Substances Abused by Athletes\n\nAthletes often face immense pressure to perform at their best, maintain stamina, and recover quickly from injuries. Unfortunately, some turn to substances that can enhance performance or alleviate pain, despite the health risks and ethical concerns involved. This article provides a detailed description of the most frequently abused substances among athletes, focusing on steroids, stimulants, painkillers, and recreational drugs.\n\n## Anabolic Steroids\n\nAnabolic steroids are synthetic variations of the male hormone testosterone. Athletes abuse them to increase muscle mass, strength, and overall physical performance. Steroids work by promoting protein synthesis within cells, leading to rapid muscle growth.\n\n### Common Types and Effects\n- **Types**: Testosterone, nandrolone, stanozolol, and methyltestosterone.\n- **Effects**: Increased muscle size, enhanced recovery rate, greater endurance, and reduced fatigue.\n\n### Risks and Side Effects\n- Hormonal imbalances leading to acne, hair loss, and mood swings.\n- Cardiovascular issues such as high blood pressure and increased risk of heart attack.\n- Liver damage and potential infertility.\n- Psychological effects including aggression and depression.\n  \nDespite their performance-enhancing properties, anabolic steroids are banned in most sports leagues and athletic organizations.\n\n## Stimulants\n\nStimulants are substances that increase alertness, attention, and energy by enhancing the activity of the central nervous system. Athletes may use stimulants to reduce fatigue and improve focus during training or competition.\n\n### Common Stimulants\n- **Amphetamines**: Often prescribed for ADHD but misused for increased energy.\n- **Caffeine**: The world’s most widely consumed legal stimulant.\n- **Ephedrine**: Used for weight loss and increased energy but banned in many competitions.\n  \n### Effects\n- Increased heart rate and blood pressure.\n- Heightened concentration and wakefulness.\n- Temporary reduction of appetite and fatigue.\n\n### Risks\n- Dependence and addiction.\n- Cardiovascular complications, including arrhythmias and heart attacks.\n- Nervousness, anxiety, and sleep disturbances.\n  \nWhile moderate caffeine use is generally accepted, other stimulants are typically prohibited due to their performance-enhancing effects and health risks.\n\n## Painkillers\n\nPainkillers, particularly opioid analgesics and non-steroidal anti-inflammatory drugs (NSAIDs), are commonly prescribed to manage injuries and pain. However, abuse can occur when athletes rely excessively on these drugs to continue competing.\n\n### Commonly Abused Painkillers\n- **Opioids**: Morphine, oxycodone, hydrocodone.\n- **NSAIDs**: Ibuprofen, naproxen (abuse generally less severe but problematic if overused).\n\n### Effects\n- Temporary pain relief and increased ability to train through injury.\n- Sedation and euphoria (primarily with opioids).\n\n### Risks\n- Opioid addiction, respiratory depression, and overdose.\n- Gastrointestinal issues and kidney damage with long-term NSAID use.\n- Masking of pain leading to worsened injuries.\n\nDue to the risk of dependency, strict guidelines exist for the medical use of painkillers among athletes.\n\n## Recreational Drugs\n\nSome athletes use recreational drugs for relaxation or coping with stress, despite the negative impact on performance and health.\n\n### Common Recreational Drugs Abused\n- **Cannabis**: Used for relaxation and pain relief; banned in many competitions.\n- **Alcohol**: Consumed socially but can impair recovery and performance.\n- **Cocaine and Ecstasy**: Occasionally abused for their stimulant and euphoric effects.\n\n### Effects\n- Altered mental state, reduced reaction time, and impaired coordination.\n- Short-term mood enhancement or relaxation.\n\n### Risks\n- Detrimental effects on cardiovascular health.\n- Legal issues and sanctions from sports authorities.\n- Negative impact on motivation, training, and overall athletic performance.\n\n## Conclusion\n\nThe abuse of steroids, stimulants, painkillers, and recreational drugs poses serious health risks and ethical dilemmas in sports. While the desire to perform better or manage pain is understandable, these substances can undermine an athlete’s long-term wellbeing and the integrity of athletic competition. Education, support, and strict regulation remain crucial in addressing substance abuse among athletes.\n\n# Causes and Risk Factors: Exploring Psychological, Social, and Professional Contributors to Substance Abuse Among Athletes\n\nSubstance abuse among athletes is a pressing concern that extends beyond physical performance to affect their mental health, career longevity, and overall well-being. Understanding the underlying causes and risk factors is essential for developing effective prevention and intervention strategies. This article delves into the psychological, social, and professional factors that contribute to substance abuse in the athletic community.\n\n## Psychological Factors\n\n### Pressure to Perform and Perfectionism\nAthletes often face intense pressure to perform at peak levels consistently. This demand can trigger anxiety, stress, and feelings of inadequacy. The desire for perfection may lead some athletes to use substances such as stimulants or performance-enhancing drugs to cope with the high expectations and overcome self-doubt.\n\n### Mental Health Challenges\nDepression, anxiety disorders, and other mental health issues are prevalent among athletes. The stigma around seeking psychological help often forces athletes to self-medicate with alcohol or drugs as a way to manage emotional pain, stress, or injury-related trauma.\n\n### Coping Mechanisms for Injury and Pain\nPhysical injuries are a common aspect of athletic careers. The chronic pain associated with injuries can lead athletes to misuse prescription medications like opioids or overconsume alcohol to alleviate discomfort and continue training or competing, inadvertently increasing the risk of substance dependence.\n\n## Social Factors\n\n### Peer Influence and Team Culture\nThe social environment within teams can profoundly impact substance use behaviors. If drug or alcohol use is normalized or even glamorized among teammates, new or younger athletes may feel pressured to conform to these norms to gain acceptance or camaraderie.\n\n### Social Isolation and Loneliness\nDespite being part of a team, athletes may experience social isolation due to rigorous training schedules, travel, or being away from family and friends. This loneliness can increase vulnerability to substance use as a misguided attempt to fill emotional voids or manage feelings of alienation.\n\n### Media and Celebrity Influence\nExposure to celebrity athletes who openly use or are rumored to use substances can create misleading narratives about drug use and its perceived benefits. This influence can lower inhibitions and reshape attitudes towards substance use, especially among younger athletes aspiring to emulate their idols.\n\n## Professional Factors\n\n### Demands of Competitive Sports\nThe professional athletic environment is highly competitive, with careers often hinging on performance and winning. The associated stress can drive athletes to use substances that promise enhanced stamina, focus, or recovery, sometimes blurring the line between legitimate medical use and abuse.\n\n### Career Uncertainty and Transition Stress\nAthletes frequently face uncertainty regarding career longevity due to factors such as injuries or declining performance. The stress related to contract negotiations, retirement planning, or forced career changes may lead to increased substance use as a maladaptive coping strategy.\n\n### Accessibility and Medical Prescriptions\nAthletes generally have greater access to medical facilities and prescription medications than the general population. While this access is crucial for health management, it also increases the risk of prescription drug misuse, especially when oversight is inadequate or when medications are used beyond therapeutic purposes.\n\n## Conclusion\n\nThe causes and risk factors behind substance abuse among athletes are multifaceted, involving a complex interplay of psychological pressures, social dynamics, and professional challenges. Recognizing these contributing elements is vital for coaches, medical professionals, and support networks to create comprehensive prevention programs and provide the necessary resources to help athletes maintain healthy lifestyles free from substance abuse. Only through holistic understanding and targeted action can the athletic community effectively combat this pervasive issue.\n\n# Health and Performance Consequences: The Physical and Mental Impacts of Substance Abuse on Athletes\n\nSubstance abuse among athletes is a critical issue that can profoundly affect both their health and sports performance. While some may turn to drugs or alcohol as a coping mechanism for stress, injury, or pressure, the consequences can be far-reaching and damaging. This article provides an in-depth analysis of the physical and mental impacts of substance abuse on athletes, emphasizing why maintaining a healthy lifestyle is essential for peak performance and overall well-being.\n\n## Physical Impacts of Substance Abuse on Athletes\n\n### 1. Deterioration of Cardiovascular Health\nMany substances abused by athletes, such as stimulants and anabolic steroids, place significant strain on the cardiovascular system. Stimulants like cocaine and amphetamines increase heart rate and blood pressure, leading to arrhythmias, hypertension, and even sudden cardiac arrest. Anabolic steroids can cause thickening of the heart muscle and increase the risk of heart attacks and strokes. Such cardiovascular issues directly impair an athlete's endurance, stamina, and ability to perform at high levels.\n\n### 2. Impaired Muscular Strength and Recovery\nThough some athletes misuse anabolic steroids to enhance muscle mass, chronic abuse can backfire by causing muscle cramps, weakness, and tendon ruptures. Other substances like alcohol interfere with protein synthesis and muscle repair, prolonging recovery time after training or injury. Dehydration and nutrient depletion caused by certain drugs further weaken muscles, limiting strength and agility on the field.\n\n### 3. Compromised Immune Function\nSubstance abuse can suppress the immune system, making athletes more susceptible to infections and illnesses. For example, excessive alcohol intake has been shown to reduce white blood cell activity, reducing the body’s ability to fight off viruses and bacteria. This leads to increased downtime due to illness and a diminished capacity to handle the physical demands of training and competition.\n\n### 4. Respiratory and Neurological Damage\nSmoking substances like tobacco or marijuana damages lung tissue and reduces oxygen uptake, critical for aerobic performance. Inhalants and certain drugs can cause long-term neurological damage including impaired coordination, balance, and reflexes—all vital for athletic skills. Brain injuries resulting from drug use can be irreversible, severely impacting motor skills and reaction times.\n\n## Mental and Psychological Consequences\n\n### 1. Cognitive Decline and Impaired Decision-Making\nSubstance abuse affects areas of the brain responsible for judgment, focus, and reaction time. Athletes abusing drugs may experience difficulties with concentration, memory, and decision-making — all essential skills for strategic gameplay and quick reactions in sports. Cognitive impairment can lead to poor game performance and increased risk of injury.\n\n### 2. Increased Anxiety, Depression, and Mood Disorders\nMany athletes turn to substances as a method of managing anxiety or depression. However, the temporary relief these substances provide is often followed by worsening symptoms. Long-term substance abuse is linked with increased rates of anxiety disorders, depression, and mood swings. Mental health struggles not only impair motivation and training consistency but also increase the likelihood of burnout and withdrawal from sport.\n\n### 3. Addiction and Dependence\nPhysical and psychological dependence on performance-enhancing or recreational drugs can trap athletes in destructive cycles. Addiction disrupts daily routines, training schedules, and professional commitments. The stress of hiding substance use and dealing with its consequences adds an additional psychological burden, often leading to social isolation and damaged relationships.\n\n### 4. Impact on Team Dynamics and Reputation\nMental health issues stemming from substance abuse can make athletes volatile or withdrawn, affecting communication and collaboration within a team. Additionally, public knowledge of substance abuse can tarnish an athlete’s reputation, leading to a loss of sponsorships, fan support, and career opportunities.\n\n## Conclusion: Prioritizing Health to Sustain Performance\n\nThe interplay between substance abuse and athletic health creates a dangerous cycle where physical and mental degradations impair performance, which in turn may lead to further substance use in an attempt to compensate. Athletes must prioritize healthy coping strategies, proper medical guidance, and mental health support to maintain optimal performance and longevity in their sports careers. Coaches, trainers, and sporting organizations also play a pivotal role in providing education and resources to prevent substance abuse and support recovery. Ultimately, safeguarding an athlete’s well-being ensures not only superior performance but a fulfilling and sustainable athletic journey.\n\n# Detection and Prevention Strategies for Substance Abuse in Athletes\n\nSubstance abuse in athletes not only undermines fair competition but also poses significant health risks. To maintain integrity in sports and protect athletes’ well-being, robust detection and prevention strategies are essential. This article explores the methods used to identify substance abuse in athletes and the proactive approaches employed to prevent it, focusing on testing protocols and educational programs.\n\n## Detection of Substance Abuse in Athletes\n\n### 1. Drug Testing Protocols\nOne of the primary methods for detecting substance abuse in athletes is through comprehensive drug testing programs. These tests can be conducted both in and out of competition, aiming to identify banned substances such as anabolic steroids, stimulants, diuretics, and other performance-enhancing drugs (PEDs).\n\n- **Urine Testing:** The most common and widely used method, urine tests can detect a broad range of substances and their metabolites. Samples are collected under strict supervision to prevent tampering.\n- **Blood Testing:** Used to detect substances that may not appear in urine or to determine the concentration of certain drugs, such as erythropoietin (EPO) or hormones.\n- **Hair and Saliva Testing:** These methods are less common but provide longer detection windows or rapid results, respectively.\n\nTesting is typically random, scheduled, or targeted based on certain risk factors or suspicious behavior, helping to deter and catch substance abuse.\n\n### 2. Biological Passport Programs\nThe Athlete Biological Passport (ABP) monitors selected biological variables over time. Rather than detecting the substance directly, it identifies abnormal changes in an athlete’s biological markers that suggest doping. This method enhances detection capabilities for substances that are otherwise difficult to identify.\n\n### 3. Observational and Behavioral Monitoring\nCoaches, medical staff, and anti-doping officials also rely on behavioral observations to detect potential substance abuse. Changes in performance, physical appearance, or behavior can prompt further investigation or testing.\n\n## Prevention Strategies\n\n### 1. Education Programs\nEducation is a cornerstone in preventing substance abuse. Athletes, coaches, and supporting personnel are provided with information about:\n\n- The health risks associated with drug use.\n- The ethical implications and impact on sporting integrity.\n- The specific substances banned by anti-doping authorities.\n- How testing procedures work and the consequences of violations.\n\nEffective education fosters informed decision-making and empowers athletes to resist pressure or temptation to use prohibited substances.\n\n### 2. Promoting a Culture of Clean Sport\nEncouraging a culture that values fair play and health over winning at all costs is essential. This includes:\n\n- Encouraging open dialogue about doping risks.\n- Highlighting positive role models who compete clean.\n- Building supportive environments where athletes can seek help for pressures or substance-related issues without stigma.\n\n### 3. Support Services and Counseling\nProviding access to psychological support and counseling can address underlying issues that might lead athletes to use substances, such as stress, anxiety, or injury-related pain management.\n\n### 4. Policy and Enforcement\nClear rules, consistent enforcement, and transparent consequences reinforce deterrents against doping. Collaboration among sports organizations, anti-doping agencies, and governments ensures that policies are up-to-date and effectively implemented.\n\n## Conclusion\n\nDetecting and preventing substance abuse in athletes requires a multifaceted approach that combines advanced testing technologies, continuous monitoring, education, and supportive environments. By integrating these strategies, the sports community can better protect athletes’ health, uphold the spirit of fair competition, and maintain public confidence in sport.\n\n# Support and Rehabilitation: Helping Athletes Overcome Substance Abuse\n\nSubstance abuse is a significant challenge faced by many athletes, often impacting not only their performance but also their overall health and well-being. Fortunately, a variety of support systems and rehabilitation programs have been developed to assist athletes in overcoming these issues. These resources provide comprehensive care, from initial intervention to long-term recovery, helping athletes regain control of their lives both on and off the field.\n\n## Understanding the Need for Support and Rehabilitation\n\nAthletes are under tremendous pressure to perform, which can sometimes lead to the misuse of substances such as performance enhancers, painkillers, or recreational drugs. The stigma surrounding substance abuse in sports may create barriers to seeking help, making effective support and rehabilitation programs critical.\n\nThese programs are specifically designed to address the unique physical, emotional, and psychological demands athletes face. Tailored support systems ensure that athletes receive care that respects their competitive schedules while focusing on sustainable recovery.\n\n## Types of Support Systems Available to Athletes\n\n### 1. Counseling and Psychological Support\n\nOne of the foundational elements in addressing substance abuse is access to professional counseling. Sports psychologists and addiction counselors work with athletes to tackle underlying issues such as anxiety, depression, or trauma that often contribute to substance misuse. Cognitive-behavioral therapy (CBT) and motivational interviewing are common techniques used to foster behavioral change and build resilience.\n\n### 2. Peer Support Groups\n\nPeer networks provide a safe environment where athletes can share experiences, challenges, and coping strategies. Groups such as Athlete Assistance Programs (AAP) and specialized 12-step programs tailored for athletes encourage mutual support and accountability. Being part of a community reduces feelings of isolation and stigma, fostering a sense of belonging and motivation.\n\n### 3. Family and Social Support\n\nRehabilitation is more effective when athletes have a strong support system at home and within their social circles. Many programs involve family therapy or educational sessions to help loved ones understand substance abuse and learn how to provide constructive support throughout recovery.\n\n## Rehabilitation Programs Tailored for Athletes\n\n### 1. Inpatient Rehabilitation\n\nFor athletes with severe substance dependence, inpatient rehabilitation centers offer intensive, structured care. These programs provide medical supervision, detoxification services, and comprehensive therapy in a controlled environment. Many centers integrate physical conditioning and sports-specific rehabilitation to help athletes maintain fitness and facilitate reintegration into their sport.\n\n### 2. Outpatient Rehabilitation\n\nOutpatient programs provide flexibility for athletes who cannot commit to prolonged residential stays due to training or competition schedules. These programs offer scheduled therapy sessions, group meetings, and medical support, allowing athletes to receive care while continuing their regular activities. Outpatient care often serves as a step-down for those transitioning from inpatient programs.\n\n### 3. Holistic and Integrative Approaches\n\nModern rehabilitation programs increasingly incorporate holistic therapies to address the physical and emotional aspects of recovery. These may include yoga, mindfulness meditation, nutrition counseling, and acupuncture. Such approaches help athletes develop healthier lifestyles, manage stress, and reduce the likelihood of relapse.\n\n## Role of Sports Organizations and Governing Bodies\n\nSports organizations play a pivotal role in providing resources and creating policies that support athletes facing substance abuse. Many federations offer confidential help lines, educational seminars, and funding for rehabilitation programs. Anti-doping agencies also emphasize rehabilitation over punishment, aiming to promote athlete health and ethical competition.\n\n## Success Stories and Outcomes\n\nNumerous athletes have successfully overcome substance abuse through dedicated support and rehabilitation. These success stories highlight the effectiveness of targeted programs that combine medical treatment, psychological support, and social reintegration. Recovery not only improves personal health but also restores athletic potential and inspires others facing similar struggles.\n\n## Conclusion\n\nSubstance abuse among athletes is a complex issue requiring specialized support and rehabilitation programs. By leveraging counseling, peer support, family involvement, and tailored rehabilitation services, athletes can overcome these challenges and return to optimal performance and well-being. Ongoing collaboration between healthcare providers, sports organizations, and athletes themselves is essential to foster environments that encourage recovery and sustainable success.\n\n## Conclusion and Future Perspectives\n\n### Summary of Key Points\n\nAddressing substance abuse among athletes remains a critical challenge that demands comprehensive, evidence-based strategies. Throughout this article, we have explored the multifaceted nature of substance abuse in the athletic community, highlighting its complex interplay with physical performance pressures, mental health issues, and social influences. Key points include:\n\n- **Prevalence and Types of Substance Abuse:** Athletes are susceptible to various substances, ranging from performance-enhancing drugs like anabolic steroids to recreational drugs and prescription medication misuse.\n- **Risk Factors:** High-performance demands, injury management, psychological stress, and the culture of competitive sports contribute significantly to the risk of substance abuse.\n- **Impact on Health and Career:** Substance abuse not only jeopardizes athletes’ physical and mental well-being but also threatens their careers through sanctions, suspensions, and loss of reputation.\n- **Current Prevention and Intervention Strategies:** These include education programs, strict doping controls, psychological support, and rehabilitation services tailored to the athletic population.\n\nUnderstanding these essentials underscores the need for a strategic, multidisciplinary approach to mitigate substance abuse risks effectively.\n\n### Emerging Trends and Future Approaches\n\nLooking forward, the landscape of managing substance abuse among athletes is evolving, propelled by advancements in technology, research, and policy development. New trends and promising approaches include:\n\n- **Personalized Prevention Programs:** Leveraging data analytics and behavioral assessments to create individualized intervention plans that address specific risk factors and psychological profiles unique to each athlete.\n- **Enhanced Screening and Detection Methods:** Innovations such as biomarker identification, genetic testing, and advanced neuroimaging are improving the accuracy and timeliness of substance abuse detection.\n- **Integrative Mental Health Services:** Future programs emphasize holistic care by integrating mental health support, stress management, and resilience training within athletic training and medical teams.\n- **Technology-Driven Monitoring:** Wearable devices and mobile health apps are emerging as tools to monitor physiological and psychological indicators, enabling early intervention before substance use escalates.\n- **Policy and Cultural Shift:** Developing policies that not only penalize substance abuse but also destigmatize seeking help, encouraging athletes to come forward without fear of retaliation or judgment.\n- **Collaborative Stakeholder Engagement:** Involving coaches, medical staff, sports organizations, family members, and peers to foster a supportive environment conducive to prevention and recovery.\n\n### Conclusion\n\nThe fight against substance abuse among athletes is ongoing, and it requires adaptability to emerging scientific insights and societal changes. By embracing innovative technologies, prioritizing mental health, and fostering open communication, sports communities can better protect athletes from the risks of substance abuse. The future holds promise for more effective, personalized, and compassionate approaches that not only safeguard athletic integrity but also promote overall health and well-being."}</code></pre>
</div>
</div>
<p>Finally, I’ll show you how to implement a evaluator-optimizer workflow.</p>
</section>
</section>
<section id="evaluator-optimizer" class="level3">
<h3 class="anchored" data-anchor-id="evaluator-optimizer">Evaluator-optimizer</h3>
<p>This workflow is useful when we have clear evaluation criteria that an LLM evaluator can use to provide feedback to the LLM generator to iteratively improve its output.</p>
<p><strong>Examples:</strong></p>
<ul>
<li>Content generation that must match certain guidelines such as writing with a particular style.</li>
<li>Improving search results iteratively</li>
</ul>
<p>I’ll walk you through an example of an evaluator-optimizer workflow where you’ll generate a text, evaluate if it matches certain criteria, and then iteratively improve it.</p>
<p>Let’s start with the vanilla implementation.</p>
<section id="vanilla-langchain-4" class="level4">
<h4 class="anchored" data-anchor-id="vanilla-langchain-4">Vanilla (+LangChain)</h4>
<p>As usual, you start by defining the state and required data models.</p>
<div id="cell-95" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb42-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Evaluation(BaseModel):</span>
<span id="cb42-2">    explanation: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(</span>
<span id="cb42-3">        description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Explain why the text evaluated matches or not the evaluation criteria"</span></span>
<span id="cb42-4">    )</span>
<span id="cb42-5">    feedback: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(</span>
<span id="cb42-6">        description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Provide feedback to the writer to improve the text"</span></span>
<span id="cb42-7">    )</span>
<span id="cb42-8">    is_correct: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(</span>
<span id="cb42-9">        description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Whether the text evaluated matches or not the evaluation criteria"</span></span>
<span id="cb42-10">    )</span>
<span id="cb42-11"></span>
<span id="cb42-12"></span>
<span id="cb42-13"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> State(BaseModel):</span>
<span id="cb42-14">    topic: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb42-15">    article: Optional[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb42-16">    evaluation: Optional[Evaluation] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span></code></pre></div>
</div>
<p>Then, you define the functions for each step in the workflow.</p>
<div id="cell-97" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb43-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> evaluate_text(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Evaluation:</span>
<span id="cb43-2">    model_with_str_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.with_structured_output(Evaluation)</span>
<span id="cb43-3">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb43-4">        SystemMessage(</span>
<span id="cb43-5">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert evaluator. Provided with a text, you will evaluate if it's written in British English and if it's appropriate for a young audience. The text must always use British spelling and grammar. Make sure the text doesn't include any em dashes."</span></span>
<span id="cb43-6">        ),</span>
<span id="cb43-7">        HumanMessage(content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Evaluate the following text:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>article<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>),</span>
<span id="cb43-8">    ]</span>
<span id="cb43-9">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model_with_str_output.invoke(messages)</span>
<span id="cb43-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response</span>
<span id="cb43-11"></span>
<span id="cb43-12"></span>
<span id="cb43-13"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> fix_text(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb43-14">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb43-15">        SystemMessage(</span>
<span id="cb43-16">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer. Provided with a text and feedback, you wil improve the text."</span></span>
<span id="cb43-17">        ),</span>
<span id="cb43-18">        HumanMessage(</span>
<span id="cb43-19">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"You were tasked with writing an article about </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>topic<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">. You wrote the following text:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>article<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">You've got the following feedback:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>evaluation<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>feedback<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Fix the text to improve it."</span></span>
<span id="cb43-20">        ),</span>
<span id="cb43-21">    ]</span>
<span id="cb43-22">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.invoke(messages)</span>
<span id="cb43-23">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response.content</span>
<span id="cb43-24"></span>
<span id="cb43-25"></span>
<span id="cb43-26"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> generate_text(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb43-27">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb43-28">        SystemMessage(</span>
<span id="cb43-29">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer. Provided with a topic, you will generate an engaging article with less than 500 words."</span></span>
<span id="cb43-30">        ),</span>
<span id="cb43-31">        HumanMessage(content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Generate a text about this topic:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>topic<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>),</span>
<span id="cb43-32">    ]</span>
<span id="cb43-33">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.invoke(messages)</span>
<span id="cb43-34">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response.content</span>
<span id="cb43-35"></span>
<span id="cb43-36"></span>
<span id="cb43-37"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> generate_text_dispatch(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb43-38">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> state.evaluation:</span>
<span id="cb43-39">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> fix_text(state)</span>
<span id="cb43-40">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> generate_text(state)</span></code></pre></div>
</div>
<p>Finally, you create <code>run_workflow</code> function that orchestrates the workflow. In this case, it takes a topic, generates a text, evaluates it, and tries to iteratively improve it. If it fails more than 3 times, it stops.</p>
<div id="cell-99" class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb44-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> run_workflow(topic: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> State:</span>
<span id="cb44-2">    state <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> State(topic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>topic)</span>
<span id="cb44-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>):</span>
<span id="cb44-4">        state.article <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> generate_text_dispatch(state)</span>
<span id="cb44-5">        state.evaluation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> evaluate_text(state)</span>
<span id="cb44-6">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> state.evaluation.is_correct:</span>
<span id="cb44-7">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> state</span>
<span id="cb44-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> state</span>
<span id="cb44-9"></span>
<span id="cb44-10"></span>
<span id="cb44-11">output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> run_workflow(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Substance abuse of athletes"</span>)</span></code></pre></div>
</div>
<p>Next, let’s see the LangGraph implementation.</p>
</section>
<section id="langgraph-4" class="level4">
<h4 class="anchored" data-anchor-id="langgraph-4">LangGraph</h4>
<p>You’ll start by defining the state of the workflow and data model required for the workflow.</p>
<div id="cell-103" class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb45-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Evaluation(BaseModel):</span>
<span id="cb45-2">    explanation: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb45-3">    feedback: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb45-4">    is_correct: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span></span>
<span id="cb45-5"></span>
<span id="cb45-6"></span>
<span id="cb45-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> State(TypedDict):</span>
<span id="cb45-8">    topic: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb45-9">    article: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb45-10">    evaluation: Evaluation</span>
<span id="cb45-11">    num_reviews: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span></span></code></pre></div>
</div>
<p>In this case, you keep the number of reviews in the state. That’s how you’ll be able to stop the workflow when the number of reviews is reached.</p>
<p>Next, you must define the functions for each node in the workflow.</p>
<div id="cell-105" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb46-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> generate_article(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>:</span>
<span id="cb46-2">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb46-3">        SystemMessage(</span>
<span id="cb46-4">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer. Provided with a topic, you will generate an engaging article with less than 500 words."</span></span>
<span id="cb46-5">        ),</span>
<span id="cb46-6">        HumanMessage(content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Generate a text about this topic:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'topic'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>),</span>
<span id="cb46-7">    ]</span>
<span id="cb46-8">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.invoke(messages)</span>
<span id="cb46-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"article"</span>: response.content}</span>
<span id="cb46-10"></span>
<span id="cb46-11"></span>
<span id="cb46-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> fix_article(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>:</span>
<span id="cb46-13">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb46-14">        SystemMessage(</span>
<span id="cb46-15">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer. Provided with a text, you will fix the text to improve it. The text must always use British spelling and grammar."</span></span>
<span id="cb46-16">        ),</span>
<span id="cb46-17">        HumanMessage(</span>
<span id="cb46-18">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"You were tasked with writing an article about </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'topic'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">. You wrote the following text:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'article'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">You've got the following feedback:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'evaluation'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>feedback<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Fix the text to improve it."</span></span>
<span id="cb46-19">        ),</span>
<span id="cb46-20">    ]</span>
<span id="cb46-21">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.invoke(messages)</span>
<span id="cb46-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"article"</span>: response.content}</span>
<span id="cb46-23"></span>
<span id="cb46-24"></span>
<span id="cb46-25"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> evaluate_article(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>:</span>
<span id="cb46-26">    model_with_str_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.with_structured_output(Evaluation)</span>
<span id="cb46-27">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb46-28">        SystemMessage(</span>
<span id="cb46-29">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert evaluator. Provided with a text, you will evaluate if it's written in British English and if it's appropriate for a young audience. The text must always use British spelling and grammar. Make sure the text doesn't include any em dash. Be very strict with the evaluation. In case of doubt, return a negative evaluation."</span></span>
<span id="cb46-30">        ),</span>
<span id="cb46-31">        HumanMessage(content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Evaluate the following text:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'article'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>),</span>
<span id="cb46-32">    ]</span>
<span id="cb46-33">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model_with_str_output.invoke(messages)</span>
<span id="cb46-34">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"evaluation"</span>: response, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"num_reviews"</span>: state.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"num_reviews"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>}</span>
<span id="cb46-35"></span>
<span id="cb46-36"></span>
<span id="cb46-37"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> route_text(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb46-38">    evaluation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> state.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"evaluation"</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>)</span>
<span id="cb46-39">    num_reviews <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> state.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"num_reviews"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb46-40">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> evaluation <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> evaluation.is_correct <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> num_reviews <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>:</span>
<span id="cb46-41">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Fail"</span></span>
<span id="cb46-42">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Pass"</span></span>
<span id="cb46-43"></span>
<span id="cb46-44"></span>
<span id="cb46-45"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> generate_article_dispatch(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>:</span>
<span id="cb46-46">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"evaluation"</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> state <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"evaluation"</span>]:</span>
<span id="cb46-47">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> fix_article(state)</span>
<span id="cb46-48">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb46-49">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> generate_article(state)</span></code></pre></div>
</div>
<p>You define:</p>
<ol type="1">
<li><code>generate_text</code>: This function generates a text based on the topic.</li>
<li><code>evaluate_text</code>: This function evaluates the text based on the topic.</li>
<li><code>fix_text</code>: This function fixes the text based on the feedback.</li>
<li><code>generate_article_dispatch</code>: This function dispatches the text generation task to either the <code>generate_text</code> or <code>fix_text</code> function based on the evaluation.</li>
</ol>
<p>Next, you need to define the graph that will be used to run the workflow.</p>
<div id="cell-107" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb47" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb47-1">workflow_builder <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> StateGraph(State)</span>
<span id="cb47-2"></span>
<span id="cb47-3">workflow_builder.add_node(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_article"</span>, generate_article_dispatch)</span>
<span id="cb47-4">workflow_builder.add_node(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"evaluate_article"</span>, evaluate_article)</span>
<span id="cb47-5"></span>
<span id="cb47-6">workflow_builder.add_edge(START, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_article"</span>)</span>
<span id="cb47-7">workflow_builder.add_edge(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_article"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"evaluate_article"</span>)</span>
<span id="cb47-8">workflow_builder.add_conditional_edges(</span>
<span id="cb47-9">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"evaluate_article"</span>, route_text, {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Pass"</span>: END, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Fail"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_article"</span>}</span>
<span id="cb47-10">)</span>
<span id="cb47-11"></span>
<span id="cb47-12">workflow <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> workflow_builder.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">compile</span>()</span></code></pre></div>
</div>
<p>You start by defining the workflow’s architecture with a StateGraph object. Your functions are then brought in as the nodes, and the operational sequence between them is set by defining the edges. Similar to the <em>Prompt chaining</em> pattern, you can use a conditional edge to dynamically route the workflow’s logic based on its current state. But instead of routing to a node, you route back to the text generation node, and iterate until the text is good enough.</p>
<p>Next, you call the <code>compile</code> method to convert your graph into a runnable workflow. You can also generate a visual diagram of the workflow using the <code>get_graph</code> and <code>draw_mermaid_png</code> functions.</p>
<div id="cell-109" class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb48-1">display(Image(workflow.get_graph().draw_mermaid_png()))</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="agentic-workflows-langgraph_files/figure-html/cell-43-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="https://dylancastillo.co/posts/agentic-workflows-langgraph_files/figure-html/cell-43-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Finally, you can run the workflow with the <code>invoke</code> method.</p>
<div id="cell-111" class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb49" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb49-1">workflow.invoke({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"topic"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Suggest the use enhancing drugs to athletes"</span>})</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="43">
<pre><code>{'topic': 'Suggest the use enhancing drugs to athletes',
 'article': 'The use of performance-enhancing drugs (PEDs) in sports is a complicated and sensitive topic. These substances are said to help athletes improve their abilities and compete better. However, their use raises important questions about fairness, health, and rules. While some people believe that carefully controlled use of PEDs might have certain benefits, it is a subject that needs thoughtful discussion and clear regulation.\n\nSupporters of PEDs argue that they could make competitions fairer by helping athletes who do not have the same access to training and equipment. In many sports, very small differences can decide the winner, and some athletes may use these drugs to try to even the playing field. If used properly under medical supervision, PEDs might reduce inequalities caused by differences in coaching and resources.\n\nAnother point is that if doctors monitored athletes using these substances, health risks could be lowered. Often, athletes who use PEDs do so in secret and without medical guidance, which can be dangerous. A system of medical support could help ensure that athletes stay as safe as possible, with regular health checks and information about the risks involved.\n\nLegalising PED use might also change how sports organisations spend their money. Instead of focusing on punishing athletes for doping, resources could be put into improving training methods and helping athletes recover and stay healthy. This might encourage research into safer ways to enhance performance.\n\nMoreover, being open about PED use could make sports more honest. Doping has been a problem for a long time, and banning these drugs has not stopped people from using them secretly. A more transparent approach might reduce cheating and allow fans to better understand athletes’ achievements.\n\nDespite these points, it is very important that any use of PEDs is carefully controlled with strict rules, age limits, and ethical standards. Protecting athlete health and fairness in sport must always be the top priority. More research and discussion are needed before any changes are made.\n\nIn summary, although the use of performance-enhancing drugs remains a difficult and controversial issue, thoughtful regulation and openness could potentially improve fairness and safety in sports. However, this topic involves complex ideas that require careful and mature consideration.',
 'evaluation': Evaluation(explanation="The text is written using British English spelling conventions, such as 'legalising' with an 's' instead of 'legalizing'. The grammar is correct and appropriate for a young audience with clear, accessible language and no use of em dashes. The content is presented in a balanced, informative manner that is suitable for young readers, addressing the topic thoughtfully without complex jargon or inappropriate content.", feedback='The text uses British English correctly and is suitable for a young audience. It avoids complex sentence structures and uses accessible vocabulary. There are no em dashes present, maintaining adherence to the criteria. The content is presented in a balanced and neutral way appropriate for educational purposes.', is_correct=True),
 'num_reviews': 2}</code></pre>
</div>
</div>
<p>That’s it! You’ve now seen how to implement the most common agentic workflow patterns with a vanilla approach and with LangGraph.</p>
</section>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Throughout this tutorial, you’ve seen how different agentic workflow patterns solve specific types of problems:</p>
<ul>
<li><strong>Prompt Chaining</strong>: Break complex tasks into sequential steps with clear handoffs</li>
<li><strong>Router</strong>: Classify inputs and route them to specialized handlers</li>
<li><strong>Parallelization</strong>: Run multiple evaluations or processes simultaneously for speed and diversity</li>
<li><strong>Orchestrator-Workers</strong>: Dynamically decompose tasks and distribute work</li>
<li><strong>Evaluator-Optimizer</strong>: Create feedback loops for iterative quality improvement</li>
</ul>
<p>You’ve learned how to implement these patterns with and without LangGraph. While the vanilla approach give you full control and might be simpler for basic cases, LangGraph gives you many features that make it easier to build complex workflows.</p>
<p>Hope you find this tutorial useful. If you have any questions, let me know in the comments below.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2025,
  author = {Castillo, Dylan},
  title = {Agentic Workflows from Scratch with (and Without)
    {LangGraph}},
  date = {2025-07-03},
  url = {https://dylancastillo.co/posts/agentic-workflows-langgraph.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2025" class="csl-entry quarto-appendix-citeas">
Castillo, Dylan. 2025. <span>“Agentic Workflows from Scratch with (and
Without) LangGraph.”</span> July 3, 2025. <a href="https://dylancastillo.co/posts/agentic-workflows-langgraph.html">https://dylancastillo.co/posts/agentic-workflows-langgraph.html</a>.
</div></div></section></div> ]]></description>
  <category>llm</category>
  <category>python</category>
  <category>anthropic</category>
  <category>openai</category>
  <category>agents</category>
  <guid>https://dylancastillo.co/posts/agentic-workflows-langgraph.html</guid>
  <pubDate>Thu, 03 Jul 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Function calling and structured outputs in LLMs with LangChain and OpenAI</title>
  <dc:creator>Dylan Castillo</dc:creator>
  <link>https://dylancastillo.co/posts/function-calling-structured-outputs.html</link>
  <description><![CDATA[ 




<p>Function calling and structured outputs let you go from chatbots that just talk to agents that interact with the world. They’re two of the most important techniques for building LLM applications.</p>
<p>Function calling lets you give LLMs access to external tools and services. Structured outputs ensure that the data coming back from your models is clean, predictable, and ready to integrate with your systems.</p>
<p>These are two of the most important techniques for building LLM applications. I can tell you that mastering them will make your applications better and easier to maintain.</p>
<p>In this tutorial, you’ll learn:</p>
<ul>
<li>How function calling and structured outputs work and when to use them</li>
<li>How to implement both techniques using LangChain and OpenAI</li>
<li>Practical examples you can run and adapt for your own projects.</li>
</ul>
<p>Let’s get started.</p>
<section id="function-calling" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="function-calling">Function calling</h2>
<p>Function calling refers to the ability to get LLMs to invoke external tools or functions. This works by giving the LLM access to a set of predefined tools that it can invoke at any point.</p>
<p>It’s relevant because it gives LLMs more capabilities, allows them to talk to external systems, and enables complex task automation. This is one of the key features that unlocked agents.</p>
<p>The usual flow is:</p>
<ol type="1">
<li>The user asks a question</li>
<li>The LLM decides if it needs to use a tool</li>
<li>If it does, it invokes the tool and gets the output from the tool</li>
<li>The LLM then uses the output to answer the user’s question</li>
</ol>
<p>Here’s a diagram that illustrates how function calling works:</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><a href="./images/function-calling-structured-outputs/diagram.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="Function calling flow"><img src="https://dylancastillo.co/posts/images/function-calling-structured-outputs/diagram.png" class="img-fluid figure-img" alt="Function calling flow"></a></p>
<figcaption class="margin-caption">Function calling flow</figcaption>
</figure>
</div>
<p>AI developers are increasingly using function calling to build more complex systems. You can use it to:</p>
<ul>
<li>Get information from a CRM, DB, etc</li>
<li>Perform calculations (e.g., generate an estimae for a variable, financial calculations)</li>
<li>Manipulate data (e.g., data cleaning, data transformation)</li>
<li>Interact with external systems (e.g., booking a flight, sending an email)</li>
</ul>
</section>
<section id="structured-outputs" class="level2">
<h2 class="anchored" data-anchor-id="structured-outputs">Structured outputs</h2>
<p>Structured outputs are a group of methods that “ensure that model outputs adhere to a specific structure”<sup>1</sup>. With proprietary models, this usually means a JSON schema. With open-weight models, a structure can mean anything from a JSON schema to a specific regex pattern. You can use <a href="https://dottxt-ai.github.io/outlines/latest/">outlines</a> for this.</p>
<p>Structured outputs are very useful to create agentic systems, as they simplify the communication between components. As you can imagine, it’s a lot easier to parse the output of a JSON object than a free-form text. Note, however, that as with other things in life, there’s no free lunch. Using this technique might <a href="https://dylancastillo.co/posts/say-what-you-mean-sometimes.html">impact the performance</a> of your task, so you should have evals in place.</p>
<p>In the next sections, I’ll show you how to use function calling and structured outputs with OpenAI.</p>
</section>
<section id="prerequisites" class="level2">
<h2 class="anchored" data-anchor-id="prerequisites">Prerequisites</h2>
<p>To follow this tutorial you’ll need to:</p>
<ol type="1">
<li>Sign up and generate an API key in <a href="https://platform.openai.com/docs/overview">OpenAI</a>.</li>
<li>Sign up and generate an API key in <a href="https://smith.langchain.com/signup">LangSmith</a>.</li>
<li>Create an <code>.env</code> file with the following variables:</li>
</ol>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">OPENAI_API_KEY</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>sk-...</span>
<span id="cb1-2"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">LANGCHAIN_TRACING_V2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>true</span>
<span id="cb1-3"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">LANGSMITH_API_KEY</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>lsv2_...</span>
<span id="cb1-4"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">LANGCHAIN_PROJECT</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"my-project"</span></span></code></pre></div>
<ol start="4" type="1">
<li>Create a virtual environment in Python and install the requirements:</li>
</ol>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span> venv venv</span>
<span id="cb2-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">source</span> venv/bin/activate</span>
<span id="cb2-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install langchain langsmith pydantic langchain-openai python-dotenv jupyter</span></code></pre></div>
<p>Once you’ve completed the steps above, you can run copy and paste the code from the next sections. You can also download the notebook from <a href="../posts/function-calling-structured-outputs.html">here</a>.</p>
</section>
<section id="examples" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="examples">Examples</h2>
<p>As usual, you’ll start by importing the necessary libraries.</p>
<p>You’ll use LangChain to interact with the OpenAI API and Pydantic for data validation.</p>
<div id="cell-4" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> textwrap <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> dedent</span>
<span id="cb3-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Literal</span>
<span id="cb3-3"></span>
<span id="cb3-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> requests</span>
<span id="cb3-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb3-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.messages <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> HumanMessage, SystemMessage</span>
<span id="cb3-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.tools <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tool</span>
<span id="cb3-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatOpenAI</span>
<span id="cb3-9"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langsmith <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> traceable</span>
<span id="cb3-10"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pydantic <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> BaseModel, Field</span>
<span id="cb3-11"></span>
<span id="cb3-12">load_dotenv()</span></code></pre></div>
</div>
<p>Now that you’ve imported the libraries, we’ll work on three examples:</p>
<ol type="1">
<li>Providing a model with a single tool</li>
<li>Providing a model with multiple tools</li>
<li>Generating a structured output from a model</li>
</ol>
<section id="function-calling-with-a-single-tool" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="function-calling-with-a-single-tool">Function calling with a single tool</h3>
<p>First you start by defining the model and the tool:</p>
<div id="cell-7" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(model_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4.1-mini"</span>)</span>
<span id="cb4-2"></span>
<span id="cb4-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@tool</span></span>
<span id="cb4-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> find_weather(latitude: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>, longitude: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>):</span>
<span id="cb4-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Get the weather of a given latitude and longitude"""</span></span>
<span id="cb4-6">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> requests.get(</span>
<span id="cb4-7">        <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"https://api.open-meteo.com/v1/forecast?latitude=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>latitude<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">&amp;longitude=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>longitude<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">&amp;current=temperature_2m,wind_speed_10m&amp;hourly=temperature_2m,relative_humidity_2m,wind_speed_10m"</span></span>
<span id="cb4-8">    )</span>
<span id="cb4-9">    data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> response.json()</span>
<span id="cb4-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"current"</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"temperature_2m"</span>]</span>
<span id="cb4-11"></span>
<span id="cb4-12"></span>
<span id="cb4-13">tools_mapping <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb4-14">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"find_weather"</span>: find_weather,</span>
<span id="cb4-15">}</span>
<span id="cb4-16"></span>
<span id="cb4-17">model_with_tools <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.bind_tools([find_weather])</span></code></pre></div>
</div>
<p>This code sets up a <code>gpt-4.1-mini</code> model with a single tool. To define a tool, you must define a function and use the <code>@tool</code> decorator. This function must necessarily have a docstring because this will be used to describe the tool to the model. In this case, the tool is a function that takes latitude and longitude values and returns the weather for that location by making a call to the Open Meteo API.</p>
<p>Next, you need to tell your code how to find and use your tools. This is the purpose of <code>tools_mapping</code>. It is a common point of confusion. The LLM doesn’t run the tools on its own. It only decides if a tool should be used. After the model makes its decision, your own code must make the actual tool call.</p>
<p>In this situation, since you only have one tool, a mapping isn’t really necessary. But if you were using multiple tools, which is often the case, you would need to create a “map” that links each tool’s name to its corresponding function. This lets you call the right tool when the model decides to use it.</p>
<p>Finally, you need to <em>bind</em> the tool to the model. The binding makes the model aware of the tool, so that it can use it.</p>
<p>Then, let’s define a function that lets you call the model with the tool.</p>
<div id="cell-9" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@traceable</span></span>
<span id="cb5-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_response(question: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>):</span>
<span id="cb5-3">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb5-4">        SystemMessage(</span>
<span id="cb5-5">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You're a helpful assistant. Use the tools provided when relevant."</span></span>
<span id="cb5-6">        ),</span>
<span id="cb5-7">        HumanMessage(question),</span>
<span id="cb5-8">    ]</span>
<span id="cb5-9">    ai_message <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model_with_tools.invoke(messages)</span>
<span id="cb5-10">    messages.append(ai_message)</span>
<span id="cb5-11"></span>
<span id="cb5-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> tool_call <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ai_message.tool_calls:</span>
<span id="cb5-13">        selected_tool <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tools_mapping[tool_call[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>]]</span>
<span id="cb5-14">        tool_msg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> selected_tool.invoke(tool_call)</span>
<span id="cb5-15">        messages.append(tool_msg)</span>
<span id="cb5-16"></span>
<span id="cb5-17">    ai_message <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model_with_tools.invoke(messages)</span>
<span id="cb5-18">    messages.append(ai_message)</span>
<span id="cb5-19"></span>
<span id="cb5-20">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> ai_message.content</span>
<span id="cb5-21"></span>
<span id="cb5-22"></span>
<span id="cb5-23">response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_response(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What's the weather in Tokyo?"</span>)</span>
<span id="cb5-24"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(response)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The current temperature in Tokyo is approximately 25.5°C. If you want more detailed weather information, please let me know!</code></pre>
</div>
</div>
<p>This function takes a city name and returns the weather for that city. It uses the <code>find_weather</code> tool to get the weather data.</p>
<p>It works as follows:</p>
<ol type="1">
<li><strong>Line 1</strong> adds a LangSmith’s <code>traceable</code> decorator to the function, so that you can see the trace of the function in the LangSmith UI. If you prefer to not use LangSmith, you can remove this line.</li>
<li><strong>Lines 2 to 10</strong> set up the <a href="https://dylancastillo.co/posts/prompt-engineering-101.html">prompts</a> and call the model.</li>
<li><strong>Lines 12 to 16</strong> is where the magic happens. This is a loop that will check if there’s been a tool call in the response from the model. If there is, it will call (invoke) the tool and add the result to the messages.</li>
<li><strong>Lines 17 to 18</strong> the model is called again to get the final response.</li>
</ol>
<p>When you run this code, you’ll get a text response with the weather for the city you asked for. If you check the trace, you can see how the whole process works:</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><a href="./images/function-calling-structured-outputs/trace-spans.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="Function calling trace"><img src="https://dylancastillo.co/posts/images/function-calling-structured-outputs/trace-spans.png" class="img-fluid figure-img" alt="Function calling trace"></a></p>
<figcaption class="margin-caption">Function calling trace</figcaption>
</figure>
</div>
<p>There are three steps in the process:</p>
<ol type="1">
<li><strong>Initial model call</strong> with the question from the user.</li>
<li><strong>Tool call</strong> to get the weather data.</li>
<li><strong>Final model call</strong> to get the response.</li>
</ol>
<p>If you dig deeper into the first model call, you’ll see how the tool is provided to the model and how the model decides to use it:</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><a href="./images/function-calling-structured-outputs/model-calls-tool.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3" title="Model calls tool"><img src="https://dylancastillo.co/posts/images/function-calling-structured-outputs/model-calls-tool.png" class="img-fluid figure-img" alt="Model calls tool"></a></p>
<figcaption class="margin-caption">Model calls tool</figcaption>
</figure>
</div>
<p>The tools is provided by describing it to the model using the docstring of the function. The parameter and their types are also provided. Then the model responds specifying the name of the tool it wants to use and the parameters it wants to pass to it. This tool is then called:</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><a href="./images/function-calling-structured-outputs/tool-call.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4" title="Tool call"><img src="https://dylancastillo.co/posts/images/function-calling-structured-outputs/tool-call.png" class="img-fluid figure-img" alt="Tool call"></a></p>
<figcaption class="margin-caption">Tool call</figcaption>
</figure>
</div>
<p>The results of the tool call are then passed to the model again. The model then uses the result to generate the final response:</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><a href="./images/function-calling-structured-outputs/tool-call-result.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5" title="Tool call result"><img src="https://dylancastillo.co/posts/images/function-calling-structured-outputs/tool-call-result.png" class="img-fluid figure-img" alt="Tool call result"></a></p>
<figcaption class="margin-caption">Tool call result</figcaption>
</figure>
</div>
<p>That’s it. This how you provide a model with tools. In the next section, you’ll see how to use multiple tools.</p>
</section>
<section id="function-calling-with-multiple-tools" class="level3">
<h3 class="anchored" data-anchor-id="function-calling-with-multiple-tools">Function calling with multiple tools</h3>
<p>Similar to the previous example, you start by defining the tools (using the <code>@tool</code> decorator) and binding them to the model.</p>
<p>In addition to <code>get_weather</code>, you’ll also define a tool to check if a response follows the company guidelines. In this case, the company guidelines are that responses should be written in the style of a haiku.<sup>2</sup></p>
<div id="cell-13" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(model_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4.1-mini"</span>)</span>
<span id="cb7-2"></span>
<span id="cb7-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@tool</span></span>
<span id="cb7-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_weather(latitude: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>, longitude: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>):</span>
<span id="cb7-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Get the weather of a given latitude and longitude"""</span></span>
<span id="cb7-6">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> requests.get(</span>
<span id="cb7-7">        <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"https://api.open-meteo.com/v1/forecast?latitude=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>latitude<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">&amp;longitude=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>longitude<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">&amp;current=temperature_2m,wind_speed_10m&amp;hourly=temperature_2m,relative_humidity_2m,wind_speed_10m"</span></span>
<span id="cb7-8">    )</span>
<span id="cb7-9">    data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> response.json()</span>
<span id="cb7-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"current"</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"temperature_2m"</span>]</span>
<span id="cb7-11"></span>
<span id="cb7-12"></span>
<span id="cb7-13"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@tool</span></span>
<span id="cb7-14"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> check_guidelines(drafted_response: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb7-15">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Check if a given response follows the company guidelines"""</span></span>
<span id="cb7-16">    model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(model_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4.1-mini"</span>)</span>
<span id="cb7-17">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.invoke(</span>
<span id="cb7-18">        [</span>
<span id="cb7-19">            SystemMessage(</span>
<span id="cb7-20">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You're a helpful assistant. Your task is to check if a given response follows the company guidelines. The company guidelines are that responses should be written in the style of a haiku. You should reply with 'OK' or 'REQUIRES FIXING' and a short explanation."</span></span>
<span id="cb7-21">            ),</span>
<span id="cb7-22">            HumanMessage(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Current response: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>drafted_response<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>),</span>
<span id="cb7-23">        ]</span>
<span id="cb7-24">    )</span>
<span id="cb7-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response.content</span>
<span id="cb7-26"></span>
<span id="cb7-27"></span>
<span id="cb7-28">tools_mapping <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb7-29">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"get_weather"</span>: get_weather,</span>
<span id="cb7-30">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"check_guidelines"</span>: check_guidelines,</span>
<span id="cb7-31">}</span>
<span id="cb7-32"></span>
<span id="cb7-33">model_with_tools <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.bind_tools([get_weather, check_guidelines])</span></code></pre></div>
</div>
<p>This code defines the tools and binds them to the model. Just like we did before, you also need to define a mapping of the tools, so that you can call the right tool when the model decides to use it.</p>
<div id="cell-15" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@traceable</span></span>
<span id="cb8-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_response(question: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>):</span>
<span id="cb8-3">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb8-4">        SystemMessage(</span>
<span id="cb8-5">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You're a helpful assistant. Use the tools provided when relevant. Then draft a response and check if it follows the company guidelines. Only respond to the user after you've validated and modified the response if needed."</span></span>
<span id="cb8-6">        ),</span>
<span id="cb8-7">        HumanMessage(question),</span>
<span id="cb8-8">    ]</span>
<span id="cb8-9">    ai_message <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model_with_tools.invoke(messages)</span>
<span id="cb8-10">    messages.append(ai_message)</span>
<span id="cb8-11"></span>
<span id="cb8-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">while</span> ai_message.tool_calls:</span>
<span id="cb8-13">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> tool_call <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ai_message.tool_calls:</span>
<span id="cb8-14">            selected_tool <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tools_mapping[tool_call[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>]]</span>
<span id="cb8-15">            tool_msg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> selected_tool.invoke(tool_call)</span>
<span id="cb8-16">            messages.append(tool_msg)</span>
<span id="cb8-17">        ai_message <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model_with_tools.invoke(messages)</span>
<span id="cb8-18">        messages.append(ai_message)</span>
<span id="cb8-19"></span>
<span id="cb8-20">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> ai_message.content</span>
<span id="cb8-21"></span>
<span id="cb8-22"></span>
<span id="cb8-23">response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_response(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What is the temperature in Madrid?"</span>)</span>
<span id="cb8-24"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(response)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sunny Madrid basks,  
Thirty-six degrees embrace,  
Summer's warm caress.</code></pre>
</div>
</div>
<p>This code is pretty much the same as the previous example, but with two tools. There’s also a one small difference.</p>
<p>Previously, we checked for tool calls once. Now, we’ll use a while loop that keeps checking. So, instead of the model having to provide the final answer after one turn, it can now ask for tools multiple times in a row until it has all the information it needs.</p>
<p>This is the core idea behind how agents work. So, congratulations, you’ve just built a simple agent! If you check the process in LangSmith, you’ll see how these turns play out.</p>
<p>Next, let’s see how to use structured outputs.</p>
</section>
<section id="structured-outputs-1" class="level3">
<h3 class="anchored" data-anchor-id="structured-outputs-1">Structured outputs</h3>
<p>Structured outputs are a set of methods used to get model outputs that follow a specific structure. This is useful when you want to get a specific type of output, such as a JSON object.</p>
<p>It’s easy to set up with proprietary models. With LangChain, you can define a <code>dict</code> or a <a href="https://docs.pydantic.dev/latest/concepts/models/">Pydantic model</a> to describe the output. I recommend using Pydantic models.</p>
<p>For example, let’s define a Pydantic model that will help us classify document into categories:</p>
<div id="cell-19" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> DocumentInfo(BaseModel):</span>
<span id="cb10-2">    category: Literal[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"financial"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"legal"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"marketing"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pets"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"other"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(</span>
<span id="cb10-3">        description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The category of the document"</span></span>
<span id="cb10-4">    )</span>
<span id="cb10-5">    summary: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A short summary of the document"</span>)</span></code></pre></div>
</div>
<p>This model defines the structured output we’ll get from the model. It has two fields: <code>category</code> and <code>summary</code>.</p>
<p>Then, you can use the <code>with_structured_output</code> method to create a model that will return the structured output:</p>
<div id="cell-21" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4.1-mini"</span>, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb11-2"></span>
<span id="cb11-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_document_info(document: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> DocumentInfo:</span>
<span id="cb11-4">    model_with_structure <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.with_structured_output(DocumentInfo)</span>
<span id="cb11-5">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model_with_structure.invoke(document)</span>
<span id="cb11-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response</span>
<span id="cb11-7"></span>
<span id="cb11-8"></span>
<span id="cb11-9">document_text <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dedent(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb11-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">This is a document about cats. Very important document. It explain how cats will take over the world in 20230.</span></span>
<span id="cb11-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb11-12">)</span>
<span id="cb11-13">document_info <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_document_info(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I'm a document about a cat"</span>)</span>
<span id="cb11-14"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(document_info)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>category='pets' summary='A document about a cat.'</code></pre>
</div>
</div>
<p>After running this code, you’ll get a structured output with the category and summary of the document that you can then use in further steps of your workflow.</p>
<p>Depending on the provider, you’ll have different options to get structured outputs. OpenAI offers three different methods:</p>
<ul>
<li><code>function_calling</code>: This uses the tool calling mechanism to get the structured output.</li>
<li><code>json_mode</code>: This method ensures you get a valid JSON object, but it’s not clear how it works under the hood.</li>
<li><code>json_schema</code>: This is default method in LangChain. It ensures that the output is a valid JSON object and that it matches the schema you provide using <a href="https://openai.com/index/introducing-structured-outputs-in-the-api/">constrained decoding</a>.</li>
</ul>
<p><a href="https://ai.google.dev/gemini-api/docs/structured-output">Gemini</a> and <a href="https://docs.anthropic.com/en/docs/test-and-evaluate/strengthen-guardrails/increase-consistency">Anthropic</a> provide their own methods to get structured outputs.</p>
<p>One thing to keep in mind is that structured outputs can impact performance. I’ve <a href="https://dylancastillo.co/posts/llm-pydantic-order-matters.html">written</a> <a href="https://dylancastillo.co/posts/say-what-you-mean-sometimes.html">multiple</a> <a href="https://dylancastillo.co/posts/gemini-structured-outputs.html">posts</a> about this topic, so I won’t go into detail here.</p>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Function calling and structured outputs are powerful tools that can significantly enhance your LLM applications. They’re also the foundation of agents.</p>
<p>Function calling is a way to provide LLMs with tools to use. It’s the difference between building a chatbot that can only talk and building an AI assistant that can actually interact with the world. It opens up a world of possibilities, from connecting to databases, calling APIs, or automating workflows.</p>
<p>Structured outputs are just as important. They’re critical to integrating LLMs into existing systems. Instead of struggling with parsing free-form text, you get clean, predictable data structures that you can use in your code.</p>
<p>The examples in this tutorial should give you a sense of how to use these methods. But as usual, the real learning happens when you start applying these concepts to your own problems. Pick a task you’re working on, see if any of these methods can help you, and give it a try.</p>
<p>If you have any questions or comments, let me know in the comments below.</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p><a href="https://arxiv.org/abs/2404.07362">“We Need Structured Output”: Towards User-centered Constraints on LLM Output. MX Liu et al.&nbsp;2024</a>↩︎</p></li>
<li id="fn2"><p>Please don’t judge me. Companies do all sorts of weird things these days.↩︎</p></li>
</ol>
</section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2025,
  author = {Castillo, Dylan},
  title = {Function Calling and Structured Outputs in {LLMs} with
    {LangChain} and {OpenAI}},
  date = {2025-07-01},
  url = {https://dylancastillo.co/posts/function-calling-structured-outputs.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2025" class="csl-entry quarto-appendix-citeas">
Castillo, Dylan. 2025. <span>“Function Calling and Structured Outputs in
LLMs with LangChain and OpenAI.”</span> July 1, 2025. <a href="https://dylancastillo.co/posts/function-calling-structured-outputs.html">https://dylancastillo.co/posts/function-calling-structured-outputs.html</a>.
</div></div></section></div> ]]></description>
  <category>llm</category>
  <category>function-calling</category>
  <category>structured-outputs</category>
  <category>openai</category>
  <guid>https://dylancastillo.co/posts/function-calling-structured-outputs.html</guid>
  <pubDate>Tue, 01 Jul 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>What is Retrieval Augmented Generation (RAG)?</title>
  <dc:creator>Dylan Castillo</dc:creator>
  <link>https://dylancastillo.co/posts/what-is-rag.html</link>
  <description><![CDATA[ 




<p><a href="https://arxiv.org/abs/2005.11401">Retrieval Augmented Generation (RAG)</a> is the most popular approach to providing LLMs with external information before they generate a response.</p>
<p>RAG is a technique where you <strong>retrieve</strong> the information required to solve a user’s query, then <strong>augment</strong> the context of the LLM with that information, and <strong>generate</strong> a response. In this tutorial, you’ll learn why RAG is useful, when to use it, and how to build your own RAG pipeline, step-by-step, using Python.</p>
<p>Let’s get started!</p>
<section id="what-is-rag" class="level2">
<h2 class="anchored" data-anchor-id="what-is-rag">What is RAG?</h2>
<p>It’s a technique to improve LLM answers by providing them with external information before they generate a response. It consists of three steps:</p>
<ol type="1">
<li><strong>Retrieve:</strong> The system starts by searching a specific knowledge base for relevant information about the query.</li>
<li><strong>Augment:</strong> This retrieved information is added to context that’s used by the LLM to generate a response.</li>
<li><strong>Generate:</strong> The LLM uses both your question and the provided information to generate an answer.</li>
</ol>
<p>In addition to reducing costs and latency, RAG is useful because it reduces <a href="https://en.wikipedia.org/wiki/Hallucination_(artificial_intelligence)">hallucinations</a>, lets you use current data, and builds trust with users by (potentially) providing citations.</p>
</section>
<section id="vector-databases" class="level2">
<h2 class="anchored" data-anchor-id="vector-databases">Vector databases</h2>
<p>A vector database (VectorDB) is a database designed to store and query data as vector embeddings (numerical representations). So, provided with a user query, it’s the engine you use to find the most similar data in your database. It’s one of the most popular components of the retrieval step in RAG pipelines.</p>
<p>In recent years, many new vector databases have been created. But, in most cases, they had to <a href="https://qdrant.tech/articles/bm42/">re-discover</a> that many of the ideas in the old generation of vector databases such as BM25-based retrieval were still valid and useful.</p>
<p>Some popular vector databases are:</p>
<ol type="1">
<li><em>New generation:</em> <a href="https://qdrant.tech/">Qdrant</a>, <a href="https://www.trychroma.com/">Chroma</a>, <a href="https://www.pinecone.io/">Pinecone</a>, <a href="https://weaviate.io/">Weaviate</a>.</li>
<li><em>Old generation:</em> <a href="https://www.elastic.co/">Elasticsearch</a>/<a href="https://opensearch.org/">OpenSearch</a> and <a href="https://github.com/pgvector/pgvector">Postgres+PGVector</a></li>
</ol>
<p>In this tutorial, you’ll use Chroma. For client projects, I’ve used Elasticsearch, Postgres, Weaviate, and Qdrant. Many companies are already using Elasticsearch or Postgres, so it’s often easier to get started with them.</p>
<section id="why-use-a-vectordb" class="level3">
<h3 class="anchored" data-anchor-id="why-use-a-vectordb">Why use a VectorDB?</h3>
<p>If you have a small dataset, there’s no real reason to use a vector database. But if you’re dealing with thousands or millions of documents, you’ll need to use a vector database to efficiently retrieve the most relevant documents.</p>
<p>They’re useful because:</p>
<ol type="1">
<li>The <a href="https://arxiv.org/abs/2309.01431">more noise</a> in the context provided to the LLM, the more likely it is to produce bad output.</li>
<li>It takes more time to process a longer context</li>
<li>It costs more to process a longer context</li>
</ol>
</section>
<section id="retrieval" class="level3">
<h3 class="anchored" data-anchor-id="retrieval">Retrieval</h3>
<p>Retrieval is the process of finding the most relevant documents in the vector database. There are two main approaches when dealing with text-based data: term-based retrieval and embedding-based retrieval.</p>
<section id="term-based-retrieval" class="level4">
<h4 class="anchored" data-anchor-id="term-based-retrieval">Term-based retrieval</h4>
<p>Term-based retrieval is a technique that uses the terms in the query to find the most relevant documents in the vector database.</p>
<p>It’s based on the following ideas:</p>
<ol type="1">
<li><strong>TF-IDF:</strong> Counts how often a term appears in this document (TF). Measures how rare the word is across all documents (IDF). Highlights terms important and unique to this specific document.</li>
<li><strong>Okapi BM25:</strong> Expands TF-IDF to introduce a weighting mechanism for term saturation and document length.</li>
</ol>
</section>
<section id="embedding-based-retrieval" class="level4">
<h4 class="anchored" data-anchor-id="embedding-based-retrieval">Embedding-based retrieval</h4>
<p>Embedding-based retrieval is a technique that uses the embedding of the query to find the most relevant documents in the vector database.</p>
<p>For small datasets, you can use k Nearest Neighbors (k-NN) approach to find the most relevant documents, in which you calculate the similarity score between the query vector and every other vector stored in the VectorDB. Sort all the vectors based on these similarity scores and return the ‘k’ most similar vectors (relative to the query).</p>
<p>For larger datasets, you can use Approximate Nearest Neighbors (ANN) such as Locality-Sensitive Hashing (LSH) or Hierarchical Navigable Small World (HNSW) to find the most relevant documents.</p>
</section>
</section>
</section>
<section id="prerequisites" class="level2">
<h2 class="anchored" data-anchor-id="prerequisites">Prerequisites</h2>
<p>To follow this tutorial you’ll need to:</p>
<ol type="1">
<li>Sign up and generate an API key in <a href="https://platform.openai.com/docs/overview">OpenAI</a>.</li>
<li>Set the API key as an environment variable called <code>OPENAI_API_KEY</code>.</li>
<li>Create a virtual environment in Python and install the requirements:</li>
<li>Download the <a href="../_extras/what-is-rag/bbva.pdf">sample PDF file</a></li>
</ol>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span> venv venv</span>
<span id="cb1-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">source</span> venv/bin/activate</span>
<span id="cb1-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install langchain chromadb langchain-openai langchain-community python-dotenv pypdf jupyter</span></code></pre></div>
<p>Once you’ve completed the steps above, you can run copy and paste the code from the next sections. You can also download the notebook from <a href="https://github.com/dylanjcastillo/blog/tree/main/posts/what-is-rag.ipynb">here</a>.</p>
</section>
<section id="rag-without-vector-database" class="level2">
<h2 class="anchored" data-anchor-id="rag-without-vector-database">RAG without vector database</h2>
<p>Let’s go through an example without a VectorDB. We’ll simply <em>augment</em> with the full text of the document.</p>
<p>First, import the necessary libraries and load the required variables from the .env file.</p>
<div id="cell-4" class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb2-2"></span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> chromadb</span>
<span id="cb2-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> chromadb.utils.embedding_functions <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAIEmbeddingFunction</span>
<span id="cb2-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb2-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_community.document_loaders <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> PyPDFLoader</span>
<span id="cb2-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.messages <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> HumanMessage, SystemMessage</span>
<span id="cb2-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatOpenAI</span>
<span id="cb2-9"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_text_splitters <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> RecursiveCharacterTextSplitter</span>
<span id="cb2-10"></span>
<span id="cb2-11">load_dotenv()</span></code></pre></div>
</div>
<p>This code will import the necessary libraries and load the required variables from the .env file.</p>
<section id="read-the-document-retrieval" class="level3">
<h3 class="anchored" data-anchor-id="read-the-document-retrieval">Read the document (retrieval)</h3>
<p>Next, we’ll use a langchain DocumentLoader to load the document. Since, we’re dealing with a PDF file, we’ll use the PyPDFLoader.</p>
<p>There are many DocumentLoaders available in langchain. You can find the full list <a href="https://python.langchain.com/docs/integrations/document_loaders/">here</a>.</p>
<div id="cell-8" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1">file_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../_extras/what-is-rag/bbva.pdf"</span></span>
<span id="cb3-2">loader <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> PyPDFLoader(file_path)</span>
<span id="cb3-3">pages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb3-4"></span>
<span id="cb3-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> page <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> loader.lazy_load():</span>
<span id="cb3-6">    pages.append(page)</span></code></pre></div>
</div>
<p>A document loader is a class that processes a document and returns a list of Document objects. In the case of the PyPDFLoader, it will read each page of the PDF file and return the text of each page with some additional metadata.</p>
<p>A single page will look like this:</p>
<div id="cell-10" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1">pages[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].model_dump()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>{'id': None,
 'metadata': {'producer': 'Adobe PDF Library 15.0',
  'creator': 'Adobe InDesign 16.1 (Windows)',
  'creationdate': '2021-03-24T14:51:54+01:00',
  'moddate': '2021-03-24T14:51:54+01:00',
  'trapped': '/False',
  'source': '../_extras/what-is-rag/bbva.pdf',
  'total_pages': 4,
  'page': 0,
  'page_label': '1'},
 'page_content': "EDICIÓN AQUA PREP 01-01\nBANCO BILBAO VIZCAYA ARGENTARIA, S.A. - Plaza de San Nicolás, 4 - 48005 BILBAO\nReg. Mer. Vizcaya -T omo 3858, Folio 1, Hoja BI-17 BIS-A, Inscripción 1035ª C.I.F.: A48265169\n1 / 4\nThis document contains the Pre-contractual information and the Prior General Information of the Aqua Pre-paid Card contract \n(hereinafter, the Card) in accordance with the provisions of the Ministerial Order ECE/1263/2019, on the transparency of \ninformation conditions applicable to payment services, and Bank of Spain Circular 5/2012, on the transparency of banking services \nand responsibility in the granting of loans.\nThe information highlighted in bold is especially important, in accordance with Circular 5/2012\n1. ON THE PAYMENT SERVICE PROVIDER\n1.1 Details and registration\nBANCO BILBAO VIZCAYA ARGENTARIA, S.A.\nAddress: Plaza San Nicolás, 4 - 48005 BILBAO. \nPhone number: 900 102 801\nWebsite address: www.bbva.es\nRegistered in the Biscay Commercial Register, Volume 2083, \nFolio 1, Sheet BI-17-A, Entry 1\n1.2 Supervisory Authorities:\nBanco de España (Registry 0182)\n[Spanish National Securities Market Commission]\n2. ON THE USE OF THE PAYMENT SERVICES\n2.1 Main characteristics: PREPAID CARD .\nThe Holder may specify that the card be physical or virtual. \nT erms and conditions governing the availability of funds: in \nother words, when and how the holder will obtain the money:\na) The Card, against a balance previously loaded on it, \nmay be used to purchase goods or services in any of \nthe physical or virtual establishments affiliated with the \ncard systems to which the Card belongs and that are \nshown on it.\nb) T o make online payments with the Card, the Account \nHolder must consult the details pertaining to the card \nnumber, expiration date and CVV via the BBVA website \nor mobile app.\nc) Withdraw money from ATMs, Bank branches and \nany other entities that allow it against the balance \npreviously loaded on it.\nT ransactions carried out with the Card will reduce the \navailable balance.\nUnder no circumstances may transactions be carried out \nin excess of the current unused loaded balance at any time \n(available balance).\n2.2 Conducting transactions. Consent.\nT o withdraw money or pay with the Card in physical \nestablishments, you must present the Card and enter your \npersonal identification number (PIN).\nThe Card's contactless technology can be used to pay or \nwithdraw cash with the Card without having to enter the PIN for \ntransactions under 50 euros.\nFor online shop purchases, you must identify yourself in the \nmanner indicated by the Bank, enter the security password and \nfollow the procedure specified by the Bank..\n2.3 Execution period\nThe transactions will be charged to the Direct Debit Account on \nthe date on which they were executed.\nPre-contractual information and \ninformation  booklet  prior to \nconcluding the payment services \ncontract\nAQUA PRE-PAID CARD",
 'type': 'Document'}</code></pre>
</div>
</div>
<p>You can see that in addition to the page content, it includes metadata about the source file, the page number, etc.</p>
<p>This document is about the conditions of some specific banking product. We’ll use it to answer a question about it.</p>
</section>
<section id="augment-the-context" class="level3">
<h3 class="anchored" data-anchor-id="augment-the-context">Augment the context</h3>
<p>Now that we have all the pages of the PDF available as a text, let’s build the context we’ll use to generate a response.</p>
<p>We’ll define a system and a user prompt. In the system prompt, we’ll define the role of the assistant and in the user prompt, we’ll provide the user question and the documents.</p>
<div id="cell-14" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1">system_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb6-2"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">You are a helpful assistant that can answer questions about the provided context.</span></span>
<span id="cb6-3"></span>
<span id="cb6-4"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Please cite the page number used to answer the question. Write the page number in the format "Page X" at the end of your answer. </span></span>
<span id="cb6-5"></span>
<span id="cb6-6"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">If the answer is not found in the context, please say so.</span></span>
<span id="cb6-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb6-8">user_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb6-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Please answer the following question based on the context provided:</span></span>
<span id="cb6-10"></span>
<span id="cb6-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Question: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{question}</span></span>
<span id="cb6-12"></span>
<span id="cb6-13"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Documents:</span></span>
<span id="cb6-14"><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{documents}</span></span>
<span id="cb6-15"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb6-16"></span>
<span id="cb6-17">pages_str <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span></span>
<span id="cb6-18"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, page <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(pages):</span>
<span id="cb6-19">    pages_str <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"--- PAGE </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> ---</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>page<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>page_content<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span></code></pre></div>
</div>
<p>We’ve set up the system and user prompt, and a a variable that stores the pages we extracted as a single string. When we make a request to the model, we’ll combine all of these into messages and send them to the model.</p>
<p>Now, we’re ready to generate a response.</p>
</section>
<section id="generate-response" class="level3">
<h3 class="anchored" data-anchor-id="generate-response">Generate response</h3>
<p>To generate a response we’ll use <code>gpt-4.1-mini</code> and combine the system and user prompts we’ve built to augment the model’s context.</p>
<div id="cell-18" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4.1-mini"</span>, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb7-2"></span>
<span id="cb7-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_response(context_vars: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>):</span>
<span id="cb7-4">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb7-5">        SystemMessage(content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>system_prompt),</span>
<span id="cb7-6">        HumanMessage(content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>user_prompt.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>context_vars)),</span>
<span id="cb7-7">    ]</span>
<span id="cb7-8">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.invoke(messages)</span>
<span id="cb7-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response.content</span>
<span id="cb7-10"></span>
<span id="cb7-11"></span>
<span id="cb7-12">question <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What is the main idea of the document?"</span></span>
<span id="cb7-13">response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_response({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>: question, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"documents"</span>: pages_str})</span>
<span id="cb7-14"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(response)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The main idea of the document is to provide the pre-contractual and general information regarding the Aqua Pre-paid Card offered by Banco Bilbao Vizcaya Argentaria, S.A. (BBVA). It outlines the terms and conditions of the card, including its features, usage, fees, security measures, responsibilities of the cardholder and the bank, contract duration, amendments, termination, applicable law, dispute resolution procedures, and other important legal aspects. The document aims to ensure transparency and inform potential cardholders about their rights and obligations before entering into the contract. 

Page 1 to Page 4</code></pre>
</div>
</div>
<p>In this code, we’ve combined the system, user prompt, the pages extracted from the document, and a user question (“What is the main idea of the document?”) into messages the model can understand.</p>
<p>If you run the code, you’ll get an accurate answer from the model. Try running it with a different question.</p>
<div id="cell-20" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1">question <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What are the daily transaction limits?"</span></span>
<span id="cb9-2">response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_response({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>: question, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"documents"</span>: pages_str})</span>
<span id="cb9-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(response)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The daily transaction limits for the Aqua Pre-paid Card are as follows: The daily purchase limit will be determined by the Card's balance and up to a maximum of 1,000 euros per day. The Holder and the Bank may modify the initially specified limits. Additionally, the monthly limit for collecting lottery and gambling prizes is ten thousand euros. (Page 2)</code></pre>
</div>
</div>
<p>As long as the document contains the information you need, you will likely get an accurate answer from the model.</p>
<p>But you can do better. Right now, the model is using the full text of the document to answer the question. Most questions only require a few sentences from the document.</p>
<p>To answer the “What are the daily transaction limits?”, the model used 3,528 input tokens. While in reality, it only needed less than 500 input tokens.</p>
<p>For small documents such as this one, the difference isn’t a big deal. But when you’re dealing with thousands of documents and potentially millions of tokens, the difference can be significant in terms of costs, latency, and accuracy.</p>
<p>Let’s see how we can use a VectorDB to improve improve this.</p>
</section>
</section>
<section id="rag-with-vector-search" class="level2">
<h2 class="anchored" data-anchor-id="rag-with-vector-search">RAG with vector search</h2>
<p>You’ll need to start by doing two things: defining an embedding function, and creating a VectorDB.</p>
<p>In this example, we’ll use the OpenAIEmbeddingFunction to create embeddings and Chroma to store them.</p>
<div id="cell-24" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1">openai_ef <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAIEmbeddingFunction(api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>os.getenv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OPENAI_API_KEY"</span>))</span>
<span id="cb11-2">vector_db <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> chromadb.PersistentClient()</span>
<span id="cb11-3"></span>
<span id="cb11-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb11-5">    collection <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> vector_db.delete_collection(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bbva"</span>)</span>
<span id="cb11-6"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span>:</span>
<span id="cb11-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pass</span></span>
<span id="cb11-8"></span>
<span id="cb11-9">collection <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> vector_db.create_collection(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bbva"</span>, embedding_function<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>openai_ef)</span></code></pre></div>
</div>
<p>In this code, you’ve set up the embedding function and created a VectorDB. The embedding function converts chunks of text from the document into vectors. The VectorDB stores these vectors and allows you to query them based on similarity to the question.</p>
<p>Next, you’ll need to split the pages into smaller chunks that you can query the VectorDB with.</p>
<section id="split-and-index-documents" class="level3">
<h3 class="anchored" data-anchor-id="split-and-index-documents">Split and index documents</h3>
<p>The RecursiveCharacterTextSplitter is a class that splits text into chunks of a specified size. It’s a recursive approach that splits the text into smaller chunks using a hierarchy of delimiters (e.g., <code>"\\n\\n"</code>, <code>"\n"</code>, <code>"."</code>, etc.).</p>
<p>In this example, we’ll use a chunk size of 1,000 characters and an overlap of 200 characters. However, in practice bigger chunks seem to work better. Popular embedding functions can handle up to 8,192 tokens, which is ~32,000 characters. You might want to start there.</p>
<div id="cell-28" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1">text_splitter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RecursiveCharacterTextSplitter(chunk_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, chunk_overlap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)</span>
<span id="cb12-2">all_splits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> text_splitter.split_documents(pages)</span></code></pre></div>
</div>
<p>This code will split the documents and save those splits into <code>all_splits</code>. Then you need to add those chunks into your VectorDB.</p>
<p>ChromaDB provides you with a simple way to add chunks to your VectorDB:</p>
<div id="cell-30" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1">collection.add(</span>
<span id="cb13-2">    documents<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[split.page_content <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> split <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> all_splits],</span>
<span id="cb13-3">    metadatas<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[split.metadata <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> split <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> all_splits],</span>
<span id="cb13-4">    ids<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(i) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(all_splits))],</span>
<span id="cb13-5">)</span></code></pre></div>
</div>
<p>This will add the chunks to your VectorDB. In addition to the chunks, this will add the metadata of each chunk and generate unique IDs for each chunk.</p>
</section>
<section id="query-the-database" class="level3">
<h3 class="anchored" data-anchor-id="query-the-database">Query the database</h3>
<p>Once the chunks are in the VectorDB, you can query them with the question.</p>
<div id="cell-34" class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1">collection.query(</span>
<span id="cb14-2">    query_texts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What are the daily transaction limits?"</span>],</span>
<span id="cb14-3">    n_results<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb14-4">)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="38">
<pre><code>{'ids': [['4']],
 'embeddings': None,
 'documents': [["EDICIÓN AQUA PREP 01-01\nBANCO BILBAO VIZCAYA ARGENTARIA, S.A. - Plaza de San Nicolás, 4 - 48005 BILBAO\nReg. Mer. Vizcaya -T omo 3858, Folio 1, Hoja BI-17 BIS-A, Inscripción 1035ª C.I.F.: A48265169\n2 / 4 \n2.4 T ransaction limits. \nThe daily purchase limit will be determined by the Card's \nbalance and up to a maximum of 1,000 euros per day. The \nHolder and the Bank may modify the initially specified limits. \nThe monthly limit for collecting lottery and gambling prizes is \nten thousand euros.\n2.5 T o sign up for the card, you do not need to take out \nany other accessory service.\n3. ON COSTS AND INTEREST AND EXCHANGE RATES\nMonthly top-up limit: Minimum of 6, maximum of 1000\nThe applicable fees for using the card may be:\na) Pre-paid card issue and maintenance fee: 5 euros.\nb) Fee for issuance of duplicates: 4 euros.\nc) Fee for using the card outside the Eurozone: 3% \napplicable to the exchange value in euros.\nd) Fees to withdraw cash against the card balance at ATMs:"]],
 'uris': None,
 'included': ['metadatas', 'documents', 'distances'],
 'data': None,
 'metadatas': [[{'page_label': '2',
    'source': '../_extras/what-is-rag/bbva.pdf',
    'producer': 'Adobe PDF Library 15.0',
    'total_pages': 4,
    'trapped': '/False',
    'creationdate': '2021-03-24T14:51:54+01:00',
    'page': 1,
    'creator': 'Adobe InDesign 16.1 (Windows)',
    'moddate': '2021-03-24T14:51:54+01:00'}]],
 'distances': [[0.3241901397705078]]}</code></pre>
</div>
</div>
<p>You can even query it with multiple questions at once:</p>
<div id="cell-36" class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1">collection.query(</span>
<span id="cb16-2">    query_texts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What are the daily transaction limits?"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What is the maximum amount I can withdraw?"</span>],</span>
<span id="cb16-3">    n_results<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb16-4">)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<pre><code>{'ids': [['4'], ['4']],
 'embeddings': None,
 'documents': [["EDICIÓN AQUA PREP 01-01\nBANCO BILBAO VIZCAYA ARGENTARIA, S.A. - Plaza de San Nicolás, 4 - 48005 BILBAO\nReg. Mer. Vizcaya -T omo 3858, Folio 1, Hoja BI-17 BIS-A, Inscripción 1035ª C.I.F.: A48265169\n2 / 4 \n2.4 T ransaction limits. \nThe daily purchase limit will be determined by the Card's \nbalance and up to a maximum of 1,000 euros per day. The \nHolder and the Bank may modify the initially specified limits. \nThe monthly limit for collecting lottery and gambling prizes is \nten thousand euros.\n2.5 T o sign up for the card, you do not need to take out \nany other accessory service.\n3. ON COSTS AND INTEREST AND EXCHANGE RATES\nMonthly top-up limit: Minimum of 6, maximum of 1000\nThe applicable fees for using the card may be:\na) Pre-paid card issue and maintenance fee: 5 euros.\nb) Fee for issuance of duplicates: 4 euros.\nc) Fee for using the card outside the Eurozone: 3% \napplicable to the exchange value in euros.\nd) Fees to withdraw cash against the card balance at ATMs:"],
  ["EDICIÓN AQUA PREP 01-01\nBANCO BILBAO VIZCAYA ARGENTARIA, S.A. - Plaza de San Nicolás, 4 - 48005 BILBAO\nReg. Mer. Vizcaya -T omo 3858, Folio 1, Hoja BI-17 BIS-A, Inscripción 1035ª C.I.F.: A48265169\n2 / 4 \n2.4 T ransaction limits. \nThe daily purchase limit will be determined by the Card's \nbalance and up to a maximum of 1,000 euros per day. The \nHolder and the Bank may modify the initially specified limits. \nThe monthly limit for collecting lottery and gambling prizes is \nten thousand euros.\n2.5 T o sign up for the card, you do not need to take out \nany other accessory service.\n3. ON COSTS AND INTEREST AND EXCHANGE RATES\nMonthly top-up limit: Minimum of 6, maximum of 1000\nThe applicable fees for using the card may be:\na) Pre-paid card issue and maintenance fee: 5 euros.\nb) Fee for issuance of duplicates: 4 euros.\nc) Fee for using the card outside the Eurozone: 3% \napplicable to the exchange value in euros.\nd) Fees to withdraw cash against the card balance at ATMs:"]],
 'uris': None,
 'included': ['metadatas', 'documents', 'distances'],
 'data': None,
 'metadatas': [[{'source': '../_extras/what-is-rag/bbva.pdf',
    'page': 1,
    'total_pages': 4,
    'creator': 'Adobe InDesign 16.1 (Windows)',
    'creationdate': '2021-03-24T14:51:54+01:00',
    'moddate': '2021-03-24T14:51:54+01:00',
    'producer': 'Adobe PDF Library 15.0',
    'page_label': '2',
    'trapped': '/False'}],
  [{'page_label': '2',
    'trapped': '/False',
    'source': '../_extras/what-is-rag/bbva.pdf',
    'creator': 'Adobe InDesign 16.1 (Windows)',
    'total_pages': 4,
    'creationdate': '2021-03-24T14:51:54+01:00',
    'moddate': '2021-03-24T14:51:54+01:00',
    'producer': 'Adobe PDF Library 15.0',
    'page': 1}]],
 'distances': [[0.3241901397705078], [0.416978657245636]]}</code></pre>
</div>
</div>
<p>Now, let’s add the VectorDB into our RAG pipeline.</p>
</section>
<section id="rag-pipeline" class="level3">
<h3 class="anchored" data-anchor-id="rag-pipeline">RAG pipeline</h3>
<p>First, start by defining a function that does the retrieval of the most relevant documents.</p>
<div id="cell-40" class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_relevant_docs(question: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, top_k: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>):</span>
<span id="cb18-2">    relevant_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> collection.query(query_texts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>question, n_results<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>top_k)</span>
<span id="cb18-3">    documents <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> relevant_docs[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"documents"</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb18-4">    metadatas <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> relevant_docs[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"metadatas"</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb18-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> [</span>
<span id="cb18-6">        {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"page_content"</span>: doc, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Document"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"metadata"</span>: metadata}</span>
<span id="cb18-7">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc, metadata <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(documents, metadatas)</span>
<span id="cb18-8">    ]</span></code></pre></div>
</div>
<p>This function will take a question and return the <code>top_k</code> most relevant chunks from the document. Here’s an example:</p>
<div id="cell-42" class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1">get_relevant_docs(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What are the daily transaction limits?"</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="44">
<pre><code>[{'page_content': "EDICIÓN AQUA PREP 01-01\nBANCO BILBAO VIZCAYA ARGENTARIA, S.A. - Plaza de San Nicolás, 4 - 48005 BILBAO\nReg. Mer. Vizcaya -T omo 3858, Folio 1, Hoja BI-17 BIS-A, Inscripción 1035ª C.I.F.: A48265169\n2 / 4 \n2.4 T ransaction limits. \nThe daily purchase limit will be determined by the Card's \nbalance and up to a maximum of 1,000 euros per day. The \nHolder and the Bank may modify the initially specified limits. \nThe monthly limit for collecting lottery and gambling prizes is \nten thousand euros.\n2.5 T o sign up for the card, you do not need to take out \nany other accessory service.\n3. ON COSTS AND INTEREST AND EXCHANGE RATES\nMonthly top-up limit: Minimum of 6, maximum of 1000\nThe applicable fees for using the card may be:\na) Pre-paid card issue and maintenance fee: 5 euros.\nb) Fee for issuance of duplicates: 4 euros.\nc) Fee for using the card outside the Eurozone: 3% \napplicable to the exchange value in euros.\nd) Fees to withdraw cash against the card balance at ATMs:",
  'type': 'Document',
  'metadata': {'producer': 'Adobe PDF Library 15.0',
   'creationdate': '2021-03-24T14:51:54+01:00',
   'creator': 'Adobe InDesign 16.1 (Windows)',
   'moddate': '2021-03-24T14:51:54+01:00',
   'page': 1,
   'trapped': '/False',
   'source': '../_extras/what-is-rag/bbva.pdf',
   'page_label': '2',
   'total_pages': 4}}]</code></pre>
</div>
</div>
<p>After you’ve retrieved the relevant chunks, you’d want to combine them into a single string that you can pass to the model. You can use <code>get_context</code> to do that.</p>
<div id="cell-44" class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb21-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_context(relevant_docs: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>]):</span>
<span id="cb21-2">    context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span></span>
<span id="cb21-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> relevant_docs:</span>
<span id="cb21-4">        context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"--- PAGE </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>doc[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'metadata'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'page'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> ---</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>doc[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'page_content'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb21-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> context</span></code></pre></div>
</div>
<div id="cell-45" class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb22-1">docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_relevant_docs(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What are the daily transaction limits?"</span>, top_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb22-2">get_context(docs)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="47">
<pre><code>"--- PAGE 1 ---\nEDICIÓN AQUA PREP 01-01\nBANCO BILBAO VIZCAYA ARGENTARIA, S.A. - Plaza de San Nicolás, 4 - 48005 BILBAO\nReg. Mer. Vizcaya -T omo 3858, Folio 1, Hoja BI-17 BIS-A, Inscripción 1035ª C.I.F.: A48265169\n2 / 4 \n2.4 T ransaction limits. \nThe daily purchase limit will be determined by the Card's \nbalance and up to a maximum of 1,000 euros per day. The \nHolder and the Bank may modify the initially specified limits. \nThe monthly limit for collecting lottery and gambling prizes is \nten thousand euros.\n2.5 T o sign up for the card, you do not need to take out \nany other accessory service.\n3. ON COSTS AND INTEREST AND EXCHANGE RATES\nMonthly top-up limit: Minimum of 6, maximum of 1000\nThe applicable fees for using the card may be:\na) Pre-paid card issue and maintenance fee: 5 euros.\nb) Fee for issuance of duplicates: 4 euros.\nc) Fee for using the card outside the Eurozone: 3% \napplicable to the exchange value in euros.\nd) Fees to withdraw cash against the card balance at ATMs:\n\n--- PAGE 2 ---\nBBVA app or website, or via the phone numbers shown on the \ncards, and in any case within a maximum period of thirteen \nmonths after the date of the debit entry.\n5.3 Liability of the Bank in the event of unauthorized \npayment transactions.\nIf an unauthorized payment transaction is carried out, the \nBank will refund the amount of the unauthorized transaction.\n5.4 Liability of the Holder in the event of unauthorized \ntransactions.\nThe Account Holder will be liable for losses arising from \nunauthorized payment transactions made with the Card up \nto a maximum of 50 euros.\nThe Holder will be liable without any limitations in the \nevent of fraud or gross negligence on their part in meeting \ntheir obligations as respects the security credentials and \nsafekeeping if this situation is not reported to the Bank \nwithout delay.\n5.5 Blocking the Card.\nThe Bank reserves the right to block the Card on objectively \njustified grounds related to the security measures taken\n\n--- PAGE 2 ---\nEDICIÓN AQUA PREP 01-01\nBANCO BILBAO VIZCAYA ARGENTARIA, S.A. - Plaza de San Nicolás, 4 - 48005 BILBAO\nReg. Mer. Vizcaya -T omo 3858, Folio 1, Hoja BI-17 BIS-A, Inscripción 1035ª C.I.F.: A48265169\n3 / 4 \nd) Notify the Bank of any loss, theft or copying of the \nCard or misappropriation of the PIN and/or passwords \nwithout undue delay as soon as they become aware \nof it, at any of the Bank's branches during customer \nservice hours or via the phone numbers shown on the \nCard.\n5.2 Notify the Bank of any unauthorized transactions \nor incorrectly executed payment transactions.\nThe Holder must notify the Bank as soon as they become \naware of the posting of any unauthorized transaction to the \nDirect Debit Account of the Card without undue delay at any \nbranch of the Bank during customer service hours, on the \nBBVA app or website, or via the phone numbers shown on the \ncards, and in any case within a maximum period of thirteen \nmonths after the date of the debit entry.\n\n"</code></pre>
</div>
</div>
<p>This will generate a string similar to the one we used in the previous example.</p>
<p>Finally, you can adapt <code>get_response</code> to use these new steps in the RAG pipeline.</p>
<div id="cell-47" class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb24-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_messages(question: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, relevant_docs: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>):</span>
<span id="cb24-2">    context_vars <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>: question, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"documents"</span>: get_context(relevant_docs)}</span>
<span id="cb24-3">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb24-4">        SystemMessage(content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>system_prompt),</span>
<span id="cb24-5">        HumanMessage(content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>user_prompt.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>context_vars)),</span>
<span id="cb24-6">    ]</span>
<span id="cb24-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> messages</span>
<span id="cb24-8"></span>
<span id="cb24-9"></span>
<span id="cb24-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_response(question: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>):</span>
<span id="cb24-11">    relevant_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_relevant_docs(question)</span>
<span id="cb24-12">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_messages(question, relevant_docs)</span>
<span id="cb24-13">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.invoke(messages)</span>
<span id="cb24-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response.content</span>
<span id="cb24-15"></span>
<span id="cb24-16"></span>
<span id="cb24-17">question <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What are the daily transaction limits?"</span></span>
<span id="cb24-18">response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_response(question)</span>
<span id="cb24-19"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(response)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The daily purchase limit for transactions is determined by the Card's balance and can be up to a maximum of 1,000 euros per day. Additionally, the monthly limit for collecting lottery and gambling prizes is ten thousand euros. The Holder and the Bank may modify the initially specified limits. 

(Page 1)</code></pre>
</div>
</div>
<p>And, you’re done! You’ve built a RAG pipeline that can answer questions about a document.</p>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>In this post, you’ve learned about what RAG is, how it works, and how to implement it in Python. You’ve learned why you’d want to use it, and how to do it.</p>
<p>You’ve walked through the process of: - Extracting text from a PDF file - Creating embeddings for the chunks - Storing the embeddings in a VectorDB - Querying the VectorDB to find the most relevant chunks - Using the model to generate a response</p>
<p>Hope you find this article usefl. If you have any questions or comments, put them in the comments section below.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2025,
  author = {Castillo, Dylan},
  title = {What Is {Retrieval} {Augmented} {Generation} {(RAG)?}},
  date = {2025-06-29},
  url = {https://dylancastillo.co/posts/what-is-rag.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2025" class="csl-entry quarto-appendix-citeas">
Castillo, Dylan. 2025. <span>“What Is Retrieval Augmented Generation
(RAG)?”</span> June 29, 2025. <a href="https://dylancastillo.co/posts/what-is-rag.html">https://dylancastillo.co/posts/what-is-rag.html</a>.
</div></div></section></div> ]]></description>
  <category>llm</category>
  <category>rag</category>
  <category>python</category>
  <guid>https://dylancastillo.co/posts/what-is-rag.html</guid>
  <pubDate>Sun, 29 Jun 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Key parameters for LLMs</title>
  <dc:creator>Dylan Castillo</dc:creator>
  <link>https://dylancastillo.co/posts/key-parameters-llms.html</link>
  <description><![CDATA[ 




<p>I recently did a workshop about building agents. During the workshop I discussed the key parameters for LLMs, so I thought it’d be useful to write a short post about it.</p>
<p>These are the parameters that you will usually use when building LLM-based products:</p>
<ul>
<li>Model</li>
<li>Messages/prompts</li>
<li>Temperature</li>
<li>Seed</li>
<li>Top-P Sampling</li>
<li>Logprobs</li>
<li>Logit biases</li>
<li>Max completion tokens</li>
<li>Response format</li>
<li>Streaming</li>
<li>Tools</li>
</ul>
<p>In the next sections, I’ll go over each of these parameters in more detail and provide some suggestions about how to use them.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Ech provider has a slightly different name for the same parameter, but the concept is the same. You’ll have to check the documentation of the provider you’re using to see the exact name of the parameter.</p>
</div>
</div>
<section id="model" class="level2">
<h2 class="anchored" data-anchor-id="model">Model</h2>
<p>When choosing a model, consider the following factors:</p>
<ul>
<li>Complexity of task: Am I solving a problem that requires reasoning capabilities? Or is it a simple task?</li>
<li>Speed: How important is it that the model replies quickly? Is this something that I can run on the background?</li>
<li>Cost: How much do I want to spend on this task?</li>
<li>Provider: Which providers do I have access to? Do I need to self-host?</li>
</ul>
<p>Right now, my go-to models are Gemini 2.5 Pro or Claude 4 for complex tasks. For simpler tasks, I use Gemini 2.5 Flash or OpenAI’s gpt-4.1 family.</p>
<p>The best way to pick a model is to start with the most capable models and then scale down to the simplest models that still capable of solving the task. Otherwise, you could end up spending a lot of time trying to solve an issue that you simply cannot solve reliably with smaller models.</p>
</section>
<section id="messagesprompts" class="level2">
<h2 class="anchored" data-anchor-id="messagesprompts">Messages/prompts</h2>
<p>The messages/prompts you send to the LLM will determine the context and instructions for the LLM to follow. I wrote a guide on <a href="https://dylancastillo.co/posts/prompt-engineering-101.html">prompt engineering</a> that covers the basics of how to write good prompts.</p>
</section>
<section id="temperature" class="level2">
<h2 class="anchored" data-anchor-id="temperature">Temperature</h2>
<p>The temperature parameter controls the randomness of the model’s output. A temperature of 0 will make the model more deterministic, while a temperature of 1 will make the model more random.</p>
<p>I wrote a <a href="https://dylancastillo.co/posts/seed-temperature-llms.html">post</a> about how temperature affects the output of LLMs. For tasks where consistency is important, use a temperature of 0. For tasks where creativity is important, use a temperature above 0. I’ve found that anything above 1.3-4 is too random.</p>
</section>
<section id="seed" class="level2">
<h2 class="anchored" data-anchor-id="seed">Seed</h2>
<p>The seed parameter is used to initialize the random number generator that is then used to sample the next token. If you want to maximize reproducibility, set a seed value.</p>
<p>This is only available in OpenAI, Gemini, and open-weight models. Check my <a href="https://dylancastillo.co/posts/seed-temperature-llms.html">post</a> for more details.</p>
</section>
<section id="top-p-sampling" class="level2">
<h2 class="anchored" data-anchor-id="top-p-sampling">Top-P Sampling</h2>
<p>Top-p sampling is a technique that limits the number of tokens that can be selected from the vocabulary by first selecting the smallest group of tokens whose combined probability ≥ P. For example, top P = 0.9 picks the next token from the smallest group of tokens that together cover at least 90% probability.</p>
<p>I rarely use this parameter.</p>
</section>
<section id="logit-biases" class="level2">
<h2 class="anchored" data-anchor-id="logit-biases">Logit biases</h2>
<p>Logits are the raw scores that the model assigns to each token. You can use biases to change the odds of a token being selected. Positive biases increase the odds of the token being selected, while negative biases do the opposite.</p>
<p>This is often used for document classification tasks or <a href="https://cookbook.openai.com/examples/search_reranking_with_cross-encoders">LLM-based rerankers</a>.</p>
</section>
<section id="logprobs" class="level2">
<h2 class="anchored" data-anchor-id="logprobs">Logprobs</h2>
<p>Logprobs are the logaritmic probabilities of the tokens. They are defined as:</p>
<p><img src="https://latex.codecogs.com/png.latex?logprob(w_i)%20=%20ln(P(w_i))%20=%20ln(%5Cfrac%7Be%5E%7Bz_i%7D%7D%7B%5Csum_%7Bj=1%7D%5E%7Bn%7D%20e%5E%7Bz_j%7D%7D)%20"></p>
<p>Where:</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?w_i"> is the <img src="https://latex.codecogs.com/png.latex?i">-th token in the vocabulary.</li>
<li><img src="https://latex.codecogs.com/png.latex?P(w_i)"> is the probability of the <img src="https://latex.codecogs.com/png.latex?i">-th token.</li>
<li><img src="https://latex.codecogs.com/png.latex?z_i"> is the logit of the <img src="https://latex.codecogs.com/png.latex?i">-th token.</li>
<li><img src="https://latex.codecogs.com/png.latex?n"> is the number of tokens in the vocabulary.</li>
</ul>
<p>You can use this parameter in OpenAI models. Gemini provides a <a href="https://discuss.ai.google.dev/t/get-logprobs-at-output-token-level/54418/15">single request with logprobs per day</a> (yes, I’m not kidding 😅). Anthropic doesn’t provide them.</p>
<p>Open-weight models don’t provide logprobs. They provide logits instead, that you can use to calculate the probabilities of the tokens.</p>
</section>
<section id="max-completion-tokens" class="level2">
<h2 class="anchored" data-anchor-id="max-completion-tokens">Max completion tokens</h2>
<p>This parameter limits the number of tokens that the model can generate. This is useful to control costs and length of the output.</p>
</section>
<section id="response-format" class="level2">
<h2 class="anchored" data-anchor-id="response-format">Response format</h2>
<p>You can use this parameter to specify the format of the response. Anthropic, OpenAI, and Gemini support structured outputs in the form of JSON schemas. I’ve written multiple posts on this topic:</p>
<ul>
<li><a href="https://dylancastillo.co/posts/say-what-you-mean-sometimes.html">Structured outputs can hurt the performance of LLMs</a></li>
<li><a href="https://dylancastillo.co/posts/gemini-structured-outputs.html">The good, the bad, and the ugly of Gemini’s structured outputs</a></li>
<li><a href="https://dylancastillo.co/posts/llm-pydantic-order-matters.html">Structured outputs: don’t put the cart before the horse</a></li>
</ul>
<p>Open-weight models allow for more flexible structured output formats. For example, using <a href="https://dottxt-ai.github.io/outlines/latest/">outlines</a> lets you define custom regEx patterns to extract the data you need.</p>
</section>
<section id="streaming" class="level2">
<h2 class="anchored" data-anchor-id="streaming">Streaming</h2>
<p>This parameter is used to stream the response from the model. This improves the user experience as it allows you to see the output as it’s being generated.</p>
</section>
<section id="tools" class="level2">
<h2 class="anchored" data-anchor-id="tools">Tools</h2>
<p>Tools are a way to extend the capabilities of the model by providing it with external tools. This is critical for building agents.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>This was a very short post about the key parameters for LLMs. I hope you found it useful.</p>
<p>Let me know if you have any questions or feedback.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2025,
  author = {Castillo, Dylan},
  title = {Key Parameters for {LLMs}},
  date = {2025-06-29},
  url = {https://dylancastillo.co/posts/key-parameters-llms.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2025" class="csl-entry quarto-appendix-citeas">
Castillo, Dylan. 2025. <span>“Key Parameters for LLMs.”</span> June 29,
2025. <a href="https://dylancastillo.co/posts/key-parameters-llms.html">https://dylancastillo.co/posts/key-parameters-llms.html</a>.
</div></div></section></div> ]]></description>
  <category>llm</category>
  <category>openai</category>
  <category>anthropic</category>
  <category>gemini</category>
  <category>python</category>
  <guid>https://dylancastillo.co/posts/key-parameters-llms.html</guid>
  <pubDate>Sun, 29 Jun 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Japanese is the most expensive language in terms of input tokens</title>
  <dc:creator>Dylan Castillo</dc:creator>
  <link>https://dylancastillo.co/til/counting-tokens.html</link>
  <description><![CDATA[ 




<p>OpenAI mentions in their documentation that <a href="https://help.openai.com/en/articles/4936856-what-are-tokens-and-how-to-count-them">1 token corresponds to roughly 4 characters</a>.</p>
<p>I was curious how this would work for different languages, so:</p>
<ol type="1">
<li>I took a small section of Paul Graham’s <a href="https://www.paulgraham.com/greatwork.html">How to Do Great Work</a></li>
<li>Translated it into 7 different languages: English, Spanish, French, German, Japanese, Chinese, and Hindi</li>
<li>Counted the tokens</li>
<li>compared the results.</li>
</ol>
<section id="code" class="level2">
<h2 class="anchored" data-anchor-id="code">Code</h2>
<p>Here’s the code:</p>
<div id="cell-2" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tiktoken</span>
<span id="cb1-2"></span>
<span id="cb1-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> read_text(file_path):</span>
<span id="cb1-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(file_path, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r"</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">file</span>:</span>
<span id="cb1-5">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">file</span>.read()</span>
<span id="cb1-6"></span>
<span id="cb1-7">text_en <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> read_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../_extras/counting-tokens/en.md"</span>)</span>
<span id="cb1-8">text_es <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> read_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../_extras/counting-tokens/es.md"</span>)</span>
<span id="cb1-9">text_fr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> read_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../_extras/counting-tokens/fr.md"</span>)</span>
<span id="cb1-10">text_de <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> read_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../_extras/counting-tokens/de.md"</span>)</span>
<span id="cb1-11">text_jp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> read_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../_extras/counting-tokens/jp.md"</span>)</span>
<span id="cb1-12">text_zh <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> read_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../_extras/counting-tokens/zh.md"</span>)</span>
<span id="cb1-13">text_hi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> read_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../_extras/counting-tokens/hi.md"</span>)</span>
<span id="cb1-14">text_ru <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> read_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../_extras/counting-tokens/ru.md"</span>)</span>
<span id="cb1-15">text_pt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> read_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../_extras/counting-tokens/pt.md"</span>)</span>
<span id="cb1-16"></span>
<span id="cb1-17"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> count_tokens(text):</span>
<span id="cb1-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(tiktoken.encoding_for_model(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4o"</span>).encode(text))</span>
<span id="cb1-19"></span>
<span id="cb1-20">chars_count <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb1-21">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"en"</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(text_en),</span>
<span id="cb1-22">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"es"</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(text_es),</span>
<span id="cb1-23">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fr"</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(text_fr),</span>
<span id="cb1-24">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"de"</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(text_de),</span>
<span id="cb1-25">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jp"</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(text_jp),</span>
<span id="cb1-26">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"zh"</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(text_zh),</span>
<span id="cb1-27">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hi"</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(text_hi),</span>
<span id="cb1-28">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ru"</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(text_ru),</span>
<span id="cb1-29">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pt"</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(text_pt),</span>
<span id="cb1-30">}</span>
<span id="cb1-31"></span>
<span id="cb1-32">tokens_count <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb1-33">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"en"</span>: count_tokens(text_en),</span>
<span id="cb1-34">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"es"</span>: count_tokens(text_es),</span>
<span id="cb1-35">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fr"</span>: count_tokens(text_fr),</span>
<span id="cb1-36">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"de"</span>: count_tokens(text_de),</span>
<span id="cb1-37">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jp"</span>: count_tokens(text_jp),</span>
<span id="cb1-38">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"zh"</span>: count_tokens(text_zh),</span>
<span id="cb1-39">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hi"</span>: count_tokens(text_hi),</span>
<span id="cb1-40">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ru"</span>: count_tokens(text_ru),</span>
<span id="cb1-41">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pt"</span>: count_tokens(text_pt),</span>
<span id="cb1-42">}</span></code></pre></div>
</div>
<p>This reads the text from the file, and uses <code>tiktoken</code> to count the tokens. I also counted the number of characters in the text.</p>
<p>Then I calculated the ratio of tokens to characters for each language.</p>
<div id="cell-4" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> lang <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"en"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"es"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fr"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"de"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jp"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"zh"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hi"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ru"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pt"</span>]:</span>
<span id="cb2-2">    chars <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> chars_count[lang]</span>
<span id="cb2-3">    tokens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tokens_count[lang]</span>
<span id="cb2-4">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>lang<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>chars <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> tokens<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> chars per token, </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>chars<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> chars, </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>tokens<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> tokens"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>en: 4.75 chars per token, 2053 chars, 432 tokens
es: 4.56 chars per token, 2271 chars, 498 tokens
fr: 4.69 chars per token, 2689 chars, 573 tokens
de: 4.46 chars per token, 2479 chars, 556 tokens
jp: 1.41 chars per token, 1081 chars, 767 tokens
zh: 1.33 chars per token, 707 chars, 531 tokens
hi: 3.51 chars per token, 2194 chars, 625 tokens
ru: 4.02 chars per token, 2275 chars, 566 tokens
pt: 4.63 chars per token, 2200 chars, 475 tokens</code></pre>
</div>
</div>
</section>
<section id="results" class="level2">
<h2 class="anchored" data-anchor-id="results">Results</h2>
<p>I found this interesting:</p>
<ul>
<li>English is the most efficient language in terms of characters per token, with 4.75 characters per token.</li>
<li>Mandarin Chinese (1.33 characters per token) is the least efficient language in terms of characters per token, followed by Japanese (1.41 characters per token).</li>
<li>The same text in Japanese uses 77% more tokens than in English, making it the most expensive language in terms of input tokens.</li>
<li>Even though Chinese is less efficient than Japanese in terms of characters per token, it’s more efficient in terms of information conveyed per character. The article took 2053 characters in English, 707 characters in Chinese, and 1081 characters in Japanese. This explains why Chinese isn’t also the most expensive language.</li>
<li>Languages that use a latin alphabet (English, Spanish, French, German, Portuguese) are more efficient than languages that use a non-latin alphabet (Japanese, Chinese, Hindi, Russian). Russian is the most efficient language of these, with 4.02 characters per token.</li>
</ul>
</section>
<section id="limitations" class="level2">
<h2 class="anchored" data-anchor-id="limitations">Limitations</h2>
<p>This analysis has some clear limitations:</p>
<ol type="1">
<li>The text might not be a good example of the types of texts you’re working with.</li>
<li>The translations might not be good enough to truly reflect the information conveyed per character.</li>
</ol>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2025,
  author = {Castillo, Dylan},
  title = {Japanese Is the Most Expensive Language in Terms of Input
    Tokens},
  date = {2025-06-27},
  url = {https://dylancastillo.co/til/counting-tokens.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2025" class="csl-entry quarto-appendix-citeas">
Castillo, Dylan. 2025. <span>“Japanese Is the Most Expensive Language in
Terms of Input Tokens.”</span> June 27, 2025. <a href="https://dylancastillo.co/til/counting-tokens.html">https://dylancastillo.co/til/counting-tokens.html</a>.
</div></div></section></div> ]]></description>
  <category>til</category>
  <category>openai</category>
  <category>tiktoken</category>
  <guid>https://dylancastillo.co/til/counting-tokens.html</guid>
  <pubDate>Fri, 27 Jun 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Prompt engineering 101</title>
  <dc:creator>Dylan Castillo</dc:creator>
  <link>https://dylancastillo.co/posts/prompt-engineering-101.html</link>
  <description><![CDATA[ 




<p>I’ve tried every trick in the book to get Large Language Models (LLMs) to do what I want them to do.</p>
<p>I’ve resorted to threats of physical violence. I’ve offered bribes. I’ve even made Cursor agents call me <a href="https://www.reddit.com/r/cursor/comments/1joapwk/comment/mkqg8aw">big daddy</a> to ensure they follow my repo’s rules<sup>1</sup>.</p>
<p>All this trial and error has taught me a trick or two about writing prompts. This is a key part of using LLMs, but it’s also one of the most hyped and abused techniques. There are so many AI influencers selling and sharing their “ultimate prompt” that it often feels closer to astrology than to engineering.</p>
<p>This article is a no-BS guide to help you get the basics right. It won’t solve all the problems in your agentic workflow or LLM-based applications, but will avoid you making obvious mistakes.</p>
<p>Let’s get started!</p>
<section id="what-is-a-prompt" class="level2">
<h2 class="anchored" data-anchor-id="what-is-a-prompt">What is a prompt?</h2>
<p>Prompts are instructions sent as text to an LLM. Most models work with two types of instructions:</p>
<ol type="1">
<li><strong>System/developer prompt</strong>: Sets the “big picture” or high-level rules for the entire conversation. Examples: “You are a helpful assistant.”; “Always answer in haiku.”</li>
<li><strong>User prompt</strong>: The actual question end-user types and any additional context. Examples: “What’s today’s weather in Dublin?”; “Summarize the following documents”</li>
</ol>
<p>The system prompt gives the assistant a “role”, while the user prompt requests specific content within that framework.</p>
<p>Prompts are usually provided as messages, which are a list of objects with a role and a content:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1">messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb1-2">    {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"system"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are a helpful assistant."</span>},</span>
<span id="cb1-3">    {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What's the weather in Tokyo?"</span>}</span>
<span id="cb1-4">]</span></code></pre></div>
<p>Then, these are passed through a <a href="https://huggingface.co/docs/transformers/en/chat_templating">chat template</a> and converted into a single string that is sent to the model. For example, this is the resulting message text used by <em>Qwen3</em>, after combining the system and user prompts:</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource text number-lines code-with-copy"><code class="sourceCode"><span id="cb2-1">&lt;|im_start|&gt;system</span>
<span id="cb2-2">You are a helpful assistant.</span>
<span id="cb2-3">&lt;|im_end|&gt;</span>
<span id="cb2-4"></span>
<span id="cb2-5">&lt;|im_start|&gt;user</span>
<span id="cb2-6">What's the weather in Tokyo?</span>
<span id="cb2-7">&lt;|im_end|&gt;</span></code></pre></div>
<p>After you make the request, the model will respond with an <em>assistant</em> message that contains the model’s response<sup>2</sup>. It looks like this:</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource text number-lines code-with-copy"><code class="sourceCode"><span id="cb3-1">&lt;|im_start|&gt;assistant</span>
<span id="cb3-2">The weather in Tokyo is sunny.</span>
<span id="cb3-3">&lt;|im_end|&gt;</span></code></pre></div>
<p>You’ll generally use the system and user prompts to instruct the model. But for some prompting techniques, such as few-shot prompting, people often use assistant messages to simulate model responses.</p>
</section>
<section id="components-of-a-good-prompt" class="level2">
<h2 class="anchored" data-anchor-id="components-of-a-good-prompt">Components of a good prompt</h2>
<p>There are many useful free resources online you can use to learn more about prompt engineering. I recommend <a href="https://docs.anthropic.com/en/docs/build-with-claude/prompt-engineering/overview#prompt-engineering-tutorial">this article</a> by Anthropic or <a href="https://platform.openai.com/docs/guides/text?api-mode=responses">this one</a> by OpenAI.</p>
<p>Most of the advice boils down to these 6 principles:</p>
<ol type="1">
<li>Be clear and specific</li>
<li>Provide examples</li>
<li>Let models think</li>
<li>Structure prompts into sections and use clear delimiters</li>
<li>Split complex tasks into smaller steps</li>
<li>Repeat instructions when the context is long</li>
</ol>
<p>Let’s go through each of these principles in more detail.</p>
<section id="principle-1-be-clear-and-specific" class="level3">
<h3 class="anchored" data-anchor-id="principle-1-be-clear-and-specific">Principle 1: Be clear and specific</h3>
<p>This is the most important principle. If you cannot describe in detail the task you want to perform, the model will not be able to perform it. Whenever you write a prompt, ask yourself: “If I didn’t have any background knowledge in this domain, could I complete this task based on the text that I just wrote in this prompt?”</p>
<p>In addition to describing the task, you should also provide a role for the model. For example, if you’re classifying documents you can use a role like “You’re an expert in document classification” or if you’re dealing with financial data you can use a role like “You’re an expert in financial analysis”.</p>
<p>Here’s an example of a clear and specific prompt:</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource text number-lines code-with-copy"><code class="sourceCode"><span id="cb4-1">You're an expert in business writing. Please review and improve this email by addressing the following issues:</span>
<span id="cb4-2"></span>
<span id="cb4-3">- Fix any grammatical errors and typos</span>
<span id="cb4-4">- Improve clarity and conciseness</span>
<span id="cb4-5">- Ensure professional tone throughout</span>
<span id="cb4-6">- Strengthen the subject line to be more specific</span>
<span id="cb4-7">- Add a clear call-to-action if missing</span>
<span id="cb4-8">- Format for better readability (bullets, paragraphs, etc.)</span>
<span id="cb4-9"></span>
<span id="cb4-10">&lt;EMAIL CONTENT&gt;</span></code></pre></div>
<p>This information will let the LLM know which specific task you want it to perform. This should go in the system prompt.</p>
</section>
<section id="principle-2-provide-examples" class="level3">
<h3 class="anchored" data-anchor-id="principle-2-provide-examples">Principle 2: Provide examples</h3>
<p>One of the lowest hanging fruit in prompt engineering is to provide examples. It’s as simple as showing the model a few input and output pairs.</p>
<p>This technique is formally known as “few shot prompt”. It’s a simple but effective way to improve the <a href="https://arxiv.org/abs/2009.03300">quality of the output</a> in many tasks.</p>
<p>Here’s an example of a few-shot prompt:</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource text number-lines code-with-copy"><code class="sourceCode"><span id="cb5-1">You are an expert in solving simple word puzzles using reasoning steps. Provided with a list of 4 names, you will concatenate the last letters into a word.</span>
<span id="cb5-2">Examples:</span>
<span id="cb5-3"></span>
<span id="cb5-4">**Example 1**:</span>
<span id="cb5-5"></span>
<span id="cb5-6">Input: 'Ian Peter Bernard Stephen'</span>
<span id="cb5-7"></span>
<span id="cb5-8">Output: 'NRDN'</span>
<span id="cb5-9"></span>
<span id="cb5-10">**Example 2**:</span>
<span id="cb5-11"></span>
<span id="cb5-12">Input: 'Javier Dylan Christopher Joseph'</span>
<span id="cb5-13"></span>
<span id="cb5-14">Output: 'RNRH'</span></code></pre></div>
<p>In my experience, it’s better to provide these examples directly in the system prompt because it’s easier to read and keep everything close together. However, as mentioned above, some people prefer to use assistant messages to provide examples.</p>
</section>
<section id="principle-3-let-models-think" class="level3">
<h3 class="anchored" data-anchor-id="principle-3-let-models-think">Principle 3: Let models think</h3>
<p>LLMs think in tokens. If you want them to achieve better results, you should let them use tokens to reason about the problem before generating the final answer.</p>
<p>This process is formally known as “Chain of Thought” (CoT) prompting. Similar to few shot prompts, it’s a powerful way to improve the <a href="https://arxiv.org/abs/2201.11903">quality of results</a> in many tasks.</p>
<p>A 0-shot CoT prompt means that you explicitly ask the model to think step by step to solve the problem but don’t provide any examples of how it should reason about it. A few-shot CoT prompt means that you provide examples of how the model should reason about the problem (e.g., 1-shot means you provide one example, 2-shot means you provide two examples, etc.).</p>
<p>Here are two examples of CoT prompts:</p>
<section id="shot-cot-prompt" class="level4">
<h4 class="anchored" data-anchor-id="shot-cot-prompt">0-Shot CoT Prompt</h4>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource text number-lines code-with-copy"><code class="sourceCode"><span id="cb6-1">**Question:** A cinema sold 120 tickets at $8 each. What was the total revenue?</span>
<span id="cb6-2"></span>
<span id="cb6-3">**Note:** think about your answer step by step</span></code></pre></div>
</section>
<section id="shot-cot-prompt-1" class="level4">
<h4 class="anchored" data-anchor-id="shot-cot-prompt-1">1-Shot CoT Prompt</h4>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource text number-lines code-with-copy"><code class="sourceCode"><span id="cb7-1">&lt;example&gt;</span>
<span id="cb7-2">**Question:** Emily buys 3 notebooks at $4 each and 2 pens at $1.50 each. What's her total cost?</span>
<span id="cb7-3">**Reasoning:**</span>
<span id="cb7-4"></span>
<span id="cb7-5">1. Cost of notebooks = 3 × $4 = $12</span>
<span id="cb7-6">2. Cost of pens = 2 × $1.50 = $3</span>
<span id="cb7-7">3. Total cost = $12 + $3 = $15</span>
<span id="cb7-8"></span>
<span id="cb7-9">**Answer:** $15</span>
<span id="cb7-10">&lt;/example&gt;</span>
<span id="cb7-11"></span>
<span id="cb7-12">**Question:** A cinema sold 120 tickets at $8 each. What was the total revenue?</span></code></pre></div>
<p>These days, most providers have options to let models think without explicitly asking them to do so in the prompt. With OpenAI models you can use models from the o-family (e.g., o3, o3-mini, o4-mini). For Anthropic and Gemini, you can configure Claude 3.7/4 or Gemini 2.5 models to use thinking tokens by setting a specific parameter. However, as I’m writing this, only Gemini gives you access to the full thinking tokens in the response. OpenAI will give you a summarized version of the thinking process and Anthropic will only give you the final answer.</p>
</section>
</section>
<section id="principle-4-structure-prompts-into-sections" class="level3">
<h3 class="anchored" data-anchor-id="principle-4-structure-prompts-into-sections">Principle 4: Structure prompts into sections</h3>
<p>It’s a common practice to structure system and user prompts into sections. Some people like to use markdown formatting to make the prompt more readable, others use xml tags. You can also use reverse backticks (```) to delimit code blocks or JSON objects. Regardless of the method you use, make sure to do it consistently.</p>
<p>I really haven’t checked if there is any hard evidence that proves this really improves performance because it just <em>feels right</em>. It also helps with readability. You will spend a lot of time iterating on prompts, so making them easy to read is already a good investment on its own.</p>
<section id="system-prompt" class="level4">
<h4 class="anchored" data-anchor-id="system-prompt">System prompt</h4>
<p>For system prompts, you can use the following structure:</p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource text number-lines code-with-copy"><code class="sourceCode"><span id="cb8-1">**Role and objective**</span>
<span id="cb8-2"></span>
<span id="cb8-3">You’re an expert document classifier. Your goal is to classify this document…</span>
<span id="cb8-4"></span>
<span id="cb8-5">**Rules**</span>
<span id="cb8-6"></span>
<span id="cb8-7">1. Documents that contain information about medical treatments should be classified as …</span>
<span id="cb8-8">2. Do not classify documents into multiple categories</span>
<span id="cb8-9">3. …</span>
<span id="cb8-10"></span>
<span id="cb8-11">**Examples**</span>
<span id="cb8-12"></span>
<span id="cb8-13">Input: [document text]</span>
<span id="cb8-14">Classification: [document category]</span>
<span id="cb8-15">…</span>
<span id="cb8-16"></span>
<span id="cb8-17">**Output**</span>
<span id="cb8-18"></span>
<span id="cb8-19">You should generate a JSON object with this structure: [JSON schema]</span>
<span id="cb8-20"></span>
<span id="cb8-21">**(Optional) Reiterate objective and elicit thinking**</span>
<span id="cb8-22"></span>
<span id="cb8-23">Your goal is to XYZ… Before writing your answers, write your reasoning step by step.</span></code></pre></div>
<p>The headers are for reference only, you can skip them if you want. You also don’t need to include all of these sections in your prompt.</p>
</section>
<section id="user-prompt" class="level4">
<h4 class="anchored" data-anchor-id="user-prompt">User prompt</h4>
<p>I’d recommend to keep user prompts short:</p>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource text number-lines code-with-copy"><code class="sourceCode"><span id="cb9-1">**Context**</span>
<span id="cb9-2"></span>
<span id="cb9-3">Input: [document text]</span>
<span id="cb9-4"></span>
<span id="cb9-5">**Briefly reiterate objective**</span>
<span id="cb9-6"></span>
<span id="cb9-7">Please classify this document into a category.</span></code></pre></div>
<p>In it’s simplest form, you just provide the context the LLM needs to work with and reiterate the objective.</p>
</section>
</section>
<section id="principle-5-split-complex-tasks-into-smaller-steps" class="level3">
<h3 class="anchored" data-anchor-id="principle-5-split-complex-tasks-into-smaller-steps">Principle 5: Split complex tasks into smaller steps</h3>
<p>LLMs often get confused when the <a href="https://arxiv.org/abs/2307.03172">context is too long</a> and/or the instructions are complex.</p>
<p>For example, you might have a document classifier that precedes a conditional entity extraction. Instead of doing a single LLM call with a prompt that does the document classification and the entity extraction, you can split the task into two steps:</p>
<ol type="1">
<li>First, you classify the document into a category.</li>
<li>Then, you extract the entities from the document, based on the category.</li>
</ol>
<p>Here’s an example of the same task split into two steps.</p>
<section id="big-complex-prompt" class="level4">
<h4 class="anchored" data-anchor-id="big-complex-prompt">Big complex prompt</h4>
<p>This prompt tries (and likely fails) to do two complex tasks at once.</p>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource text number-lines code-with-copy"><code class="sourceCode"><span id="cb10-1">You're an expert document classifier. First, classify the document into the following categories:</span>
<span id="cb10-2"></span>
<span id="cb10-3">- Medical</span>
<span id="cb10-4">- Financial</span>
<span id="cb10-5">- Legal</span>
<span id="cb10-6"></span>
<span id="cb10-7">Then, if the document is classified as "Medical", extract the following entities:</span>
<span id="cb10-8">...</span>
<span id="cb10-9"></span>
<span id="cb10-10">If the document is classified as "Financial", extract the following entities:</span>
<span id="cb10-11">...</span>
<span id="cb10-12"></span>
<span id="cb10-13">If the document is classified as "Legal", extract the following entities:</span>
<span id="cb10-14">...</span></code></pre></div>
</section>
<section id="smaller-simpler-prompts" class="level4">
<h4 class="anchored" data-anchor-id="smaller-simpler-prompts">Smaller, simpler prompts</h4>
<p>This second approach splits the task into two smaller prompts that do each task separately.</p>
<p><strong>Prompt 1: Document classification</strong></p>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource text number-lines code-with-copy"><code class="sourceCode"><span id="cb11-1">You're an expert document classifier. First, classify the document into the following categories:</span>
<span id="cb11-2"></span>
<span id="cb11-3">- Medical</span>
<span id="cb11-4">- Financial</span>
<span id="cb11-5">- Legal</span></code></pre></div>
<p><strong>Prompt N: Entity extraction (one for each category)</strong></p>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource text number-lines code-with-copy"><code class="sourceCode"><span id="cb12-1">You're an expert in entity extraction in the &lt;CATEGORY&gt; domain. Your goal is to extract the entities from the document.</span>
<span id="cb12-2">...</span></code></pre></div>
</section>
</section>
<section id="principle-6-with-long-contexts-repeat-instructions" class="level3">
<h3 class="anchored" data-anchor-id="principle-6-with-long-contexts-repeat-instructions">Principle 6: With long contexts, repeat instructions</h3>
<p>LLMs often get confused when the context is too long and the instructions are complex. When context gets above a certain length, it’s better to repeat the instructions at the bottom of the prompt. Anthropic has reported up to <a href="https://docs.anthropic.com/en/docs/build-with-claude/prompt-engineering/overview#essential-tips-for-long-context-prompts">30% performance improvement</a> when using this technique.</p>
<p>You can use the following structure:</p>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource text number-lines code-with-copy"><code class="sourceCode"><span id="cb13-1">You're an expert in entity extraction in the &lt;CATEGORY&gt; domain. Your goal is to classify the document into the following categories: "Medical", "Financial", "Legal".</span>
<span id="cb13-2"></span>
<span id="cb13-3">&lt;VERY LONG CONTEXT&gt;</span>
<span id="cb13-4"></span>
<span id="cb13-5">Remember, your goal is to classify the document into the following categories: "Medical", "Financial", "Legal".</span></code></pre></div>
<p>When dealing with long contexts, I generally reiterate the objective at the bottom of the system and user prompts.</p>
</section>
</section>
<section id="other-advanced-prompting-techniques" class="level2">
<h2 class="anchored" data-anchor-id="other-advanced-prompting-techniques">Other advanced prompting techniques</h2>
<p>After you’ve mastered the basics, you’re 90% of the way there. There are other more advanced techniques that might also be worth trying out:</p>
<ol type="1">
<li><strong>Exemplar Selection KNN (ES-KNN):</strong> Instead of having a fixed selection of examples, you can embed the user query and the examples, and then use a KNN algorithm to select the most relevant examples. This has shown to <a href="https://arxiv.org/abs/2506.05614">improve the quality of the results</a> in many tasks.</li>
<li><strong>Self-consistency (SC):</strong> You use the model to generate multiple responses and then select the most consistent one by marginalizing over the noise. This has shown to <a href="https://arxiv.org/abs/2203.11171">boost the performance</a> of CoT prompting.</li>
<li><strong>Thread of Thought (ThoT):</strong> It’s a <a href="https://arxiv.org/abs/2311.08734">two-tiered prompting system</a> that first asks the LLM to do an analytical dissection of the context, step by step, and summarizing intermediate results. Then, it uses another prompt to distill the analysis into a final answer.</li>
</ol>
<p>There are more advanced techniques that I’m not going to cover here. This <a href="https://arxiv.org/abs/2506.05614">paper</a> by E.G. Santana et al is a good starting point.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>This article is a short guide to help you write better prompts. Good prompt engineering can be summarized in 6 key principles:</p>
<ol type="1">
<li>Be clear and specific</li>
<li>Provide examples</li>
<li>Let models think</li>
<li>Structure prompts into sections and use clear delimiters</li>
<li>Split complex tasks into smaller steps</li>
<li>Repeat instructions when the context is long</li>
</ol>
<p>These principles will not solve all the problems in your agentic workflow or LLM-based applications. But they will help you get started.</p>
<p>I hope you found this article useful. If you have any questions or feedback, leave a comment below.</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>It didn’t work, but I felt much better about myself.↩︎</p></li>
<li id="fn2"><p>I removed the thinking tokens for brevity.↩︎</p></li>
</ol>
</section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2025,
  author = {Castillo, Dylan},
  title = {Prompt Engineering 101},
  date = {2025-06-26},
  url = {https://dylancastillo.co/posts/prompt-engineering-101.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2025" class="csl-entry quarto-appendix-citeas">
Castillo, Dylan. 2025. <span>“Prompt Engineering 101.”</span> June 26,
2025. <a href="https://dylancastillo.co/posts/prompt-engineering-101.html">https://dylancastillo.co/posts/prompt-engineering-101.html</a>.
</div></div></section></div> ]]></description>
  <category>llm</category>
  <category>openai</category>
  <category>anthropic</category>
  <category>gemini</category>
  <category>python</category>
  <guid>https://dylancastillo.co/posts/prompt-engineering-101.html</guid>
  <pubDate>Thu, 26 Jun 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Controlling randomness in LLMs: Temperature and Seed</title>
  <dc:creator>Dylan Castillo</dc:creator>
  <link>https://dylancastillo.co/posts/seed-temperature-llms.html</link>
  <description><![CDATA[ 




<p>Temperature and seed are commonly used parameters when interacting with Large Language Models (LLMs). They’re also a source of confusion for many people. In this post, I’ll show you what they are and how they work.</p>
<p>Temperature is a parameter that controls the randomness of the output by scaling the logits of the tokens before applying the softmax function. Seed is also a parameter that controls the randomness of how the model selects tokens during text generation. It sets the initial state of the random number generator, which is then used for the sampling of the tokens during the generation process.</p>
<p>Temperature is available for most providers, while seed is only available for <a href="https://openai.com/api/">OpenAI</a>, Gemini on <a href="https://cloud.google.com/vertex-ai/generative-ai/docs/model-reference/inference">Vertex AI</a>, and open-weight models (that I know of).</p>
<p>Let’s get started.</p>
<section id="how-llms-generate-text" class="level2">
<h2 class="anchored" data-anchor-id="how-llms-generate-text">How LLMs generate text</h2>
<p>To understand how seed and temperature work, we first need to understand how LLMs generate text. Provided with a prompt, a model uses what’s called a <a href="https://huggingface.co/docs/transformers/en/generation_strategies">decoding strategy</a> to generate the next token.</p>
<p>There are many strategies, but for this post, we’ll focus on just two: <strong>greedy search</strong> and <strong>sampling</strong>.</p>
<p>In <strong>greedy search</strong>, the model picks the token with the highest probability at each step. In <strong>sampling</strong>, the model picks a token based on the probability distribution of the tokens in the vocabulary. In both cases, the model will calculate the probability of each token in the vocabulary<sup>1</sup>, and use that to pick the next token. Let’s see an example.</p>
<p>Take the following prompt:</p>
<blockquote class="blockquote">
<p>What’s the favorite dish of Chuck Norris?</p>
</blockquote>
<p>These might be the top 5 most likely next tokens:</p>
<table class="table">
<thead>
<tr class="header">
<th>Rank</th>
<th>Token</th>
<th>Probability</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>‘Dynamite’</td>
<td>0.5823</td>
</tr>
<tr class="even">
<td>2</td>
<td>‘Venom’</td>
<td>0.2891</td>
</tr>
<tr class="odd">
<td>3</td>
<td>‘Himself’</td>
<td>0.0788</td>
</tr>
<tr class="even">
<td>4</td>
<td>‘Radiation’</td>
<td>0.0354</td>
</tr>
<tr class="odd">
<td>5</td>
<td>‘You’</td>
<td>0.0144</td>
</tr>
</tbody>
</table>
<p>If the model uses <strong>greedy search</strong>, it will pick the token with the highest probability, which is ‘Dynamite’.</p>
<p>If it uses <strong>sampling</strong>, it will make a random selection based on those probabilities. So, the model has a 58% chance of picking ‘Dynamite’, a 29% chance of picking ‘Venom’, a 8% chance of picking ‘Himself’, a 4% chance of picking ‘Radiation’, and a 1% chance of picking ‘You’.</p>
</section>
<section id="temperature" class="level2">
<h2 class="anchored" data-anchor-id="temperature">Temperature</h2>
<p>Temperature is a parameter that usually goes from 0 to 1 or 0 to 2, and it’s used to influence the randomness of the output. It does so by scaling the logits of the tokens by the temperature value.</p>
<p>Logits are the raw scores that the model assigns to each token. To go from logits to probabilities, you must apply the softmax function:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Ctext%7BP%7D(w_i)%20=%20%5Ctext%7Bsoftmax%7D(z_i)%20=%20%5Cfrac%7Be%5E%7Bz_i%7D%7D%7B%5Csum_%7Bj=1%7D%5E%7Bn%7D%20e%5E%7Bz_j%7D%7D"></p>
<p>Where:</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?P(w_i)"> is the probability of token <img src="https://latex.codecogs.com/png.latex?w_i"></li>
<li><img src="https://latex.codecogs.com/png.latex?z_i"> is the logit for token <img src="https://latex.codecogs.com/png.latex?w_i"></li>
<li><img src="https://latex.codecogs.com/png.latex?n"> is the total number of possible tokens</li>
</ul>
<p>This is the non-scaled version of the probabilities. If you use Temperature (<img src="https://latex.codecogs.com/png.latex?T">) to scale the logits, you will change the probabilities of the tokens, as shown below:</p>
<p><img src="https://latex.codecogs.com/png.latex?P(w_i)%20=%20%5Cfrac%7Be%5E%7Bz_i%20/%20T%7D%7D%7B%5Csum_%7Bj=1%7D%5E%7Bn%7D%20e%5E%7Bz_j%20/%20T%7D%7D"></p>
<p>Even though you cannot know for sure how proprietary providers (OpenAI, Anthropic, etc.) implement temperature, you can get a good idea of how it works by looking at <a href="https://github.com/huggingface/transformers/blob/6bdd4ec95264e5d8f219cfe4ee29ea9b42474bb7/src/transformers/generation/logits_process.py#L231"><code>TemperatureLogitWrapper</code></a> in the <code>transformers</code> library.</p>
<p>Let’s see a practical example of how temperature affects the probabilities of the tokens:</p>
<div id="cell-4" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-2"></span>
<span id="cb1-3">tokens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Dynamite'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Venom'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Himself'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Radiation'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'You'</span>]</span>
<span id="cb1-4">logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.8</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>])</span>
<span id="cb1-5"></span>
<span id="cb1-6">temperatures <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.999999999</span>]</span>
<span id="cb1-7"></span>
<span id="cb1-8"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> temperature <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> temperatures:</span>
<span id="cb1-9">    probs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.exp(logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> temperature) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(np.exp(logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> temperature))</span>
<span id="cb1-10">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Temperature: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>temperature<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb1-11">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What's the favorite dish of Chuck Norris?"</span>)</span>
<span id="cb1-12">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Rank | Token      | Probability"</span>)</span>
<span id="cb1-13">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-----|------------|------------"</span>)</span>
<span id="cb1-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, (token, prob) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(tokens, probs), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>):</span>
<span id="cb1-15">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:4d}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> | '</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>token<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:10s}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">' | </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>prob<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb1-16">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Sum of probabilities: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>np<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(probs)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
</div>
<p>This code simulates the impact of different temperature values on the next token probability. Given some initial logits and assuming this is the full vocabulary, we can calculate the probabilities of the tokens for a given temperature.</p>
<p>For a temperature of <strong>0.1</strong>, you get the following probabilities:</p>
<table class="table">
<thead>
<tr class="header">
<th>Rank</th>
<th>Token</th>
<th>Probability</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>‘Dynamite’</td>
<td>0.9991</td>
</tr>
<tr class="even">
<td>2</td>
<td>‘Venom’</td>
<td>0.0009</td>
</tr>
<tr class="odd">
<td>3</td>
<td>‘Himself’</td>
<td>0.0000</td>
</tr>
<tr class="even">
<td>4</td>
<td>‘Radiation’</td>
<td>0.0000</td>
</tr>
<tr class="odd">
<td>5</td>
<td>‘You’</td>
<td>0.0000</td>
</tr>
</tbody>
</table>
<p>For a temperature of <strong>2</strong>, you get the following probabilities:</p>
<table class="table">
<thead>
<tr class="header">
<th>Rank</th>
<th>Token</th>
<th>Probability</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>‘Dynamite’</td>
<td>0.4038</td>
</tr>
<tr class="even">
<td>2</td>
<td>‘Venom’</td>
<td>0.2846</td>
</tr>
<tr class="odd">
<td>3</td>
<td>‘Himself’</td>
<td>0.1486</td>
</tr>
<tr class="even">
<td>4</td>
<td>‘Radiation’</td>
<td>0.0996</td>
</tr>
<tr class="odd">
<td>5</td>
<td>‘You’</td>
<td>0.0635</td>
</tr>
</tbody>
</table>
<p>You can see that for lower temperature values, the model becomes more deterministic. For temperature 0.1, the probability of picking ‘Dynamite’ is &gt;99.9%, while for temperature 2, it’s only 40%.</p>
<p>In essence, temperature impacts the randomness of the output by changing the probabilities of selecting the next token. This should give you a good idea of how temperature works. But let’s try it with a real LLM instead of a simulation.</p>
<p>First, let’s import the required libraries and load the model.</p>
<div id="cell-6" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb2-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch.nn.functional <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> F</span>
<span id="cb2-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> transformers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> AutoModelForCausalLM, AutoTokenizer</span>
<span id="cb2-5"></span>
<span id="cb2-6">model_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"unsloth/Qwen3-1.7B"</span></span>
<span id="cb2-7">tokenizer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> AutoTokenizer.from_pretrained(model_name)</span>
<span id="cb2-8">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> AutoModelForCausalLM.from_pretrained(</span>
<span id="cb2-9">    model_name,</span>
<span id="cb2-10">    torch_dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"auto"</span>,</span>
<span id="cb2-11">    device_map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"auto"</span></span>
<span id="cb2-12">)</span></code></pre></div>
</div>
<p>For the sake of this example, we’ll use <code>unsloth/Qwen3-1.7B</code>. But what you see here is applicable to most LLMs. We’ll use <code>generate_text</code> as our text generation function.</p>
<div id="cell-8" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> generate_text(prompt, temperature, seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, print_top_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>):</span>
<span id="cb3-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> seed:</span>
<span id="cb3-3">        torch.manual_seed(seed)</span>
<span id="cb3-4">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> torch.cuda.is_available():</span>
<span id="cb3-5">            torch.cuda.manual_seed(seed)</span>
<span id="cb3-6"></span>
<span id="cb3-7">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb3-8">        {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: prompt}</span>
<span id="cb3-9">    ]</span>
<span id="cb3-10">    text <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tokenizer.apply_chat_template(</span>
<span id="cb3-11">        messages,</span>
<span id="cb3-12">        tokenize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,</span>
<span id="cb3-13">        add_generation_prompt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb3-14">        enable_thinking<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span></span>
<span id="cb3-15">    )</span>
<span id="cb3-16">    model_inputs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tokenizer([text], return_tensors<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pt"</span>).to(model.device)</span>
<span id="cb3-17"></span>
<span id="cb3-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> temperature <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb3-19">        model_params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb3-20">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"do_sample"</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb3-21">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"temperature"</span>: temperature <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> temperature <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.9999999</span>,</span>
<span id="cb3-22">        }</span>
<span id="cb3-23">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb3-24">        model_params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb3-25">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"do_sample"</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,</span>
<span id="cb3-26">        }</span>
<span id="cb3-27">    outputs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.generate(</span>
<span id="cb3-28">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>model_inputs,</span>
<span id="cb3-29">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>model_params,</span>
<span id="cb3-30">        max_new_tokens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb3-31">        output_scores<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb3-32">        return_dict_in_generate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb3-33">        pad_token_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tokenizer.eos_token_id</span>
<span id="cb3-34">    )</span>
<span id="cb3-35"></span>
<span id="cb3-36">    output_token_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> outputs.sequences[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].tolist()</span>
<span id="cb3-37">    selected_token <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tokenizer.decode([output_token_id])</span>
<span id="cb3-38"></span>
<span id="cb3-39">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> print_top_k:</span>
<span id="cb3-40">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> selected_token</span>
<span id="cb3-41">    </span>
<span id="cb3-42">    probs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.softmax(outputs.scores[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb3-43">    top_k_probs, top_k_indices <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.topk(probs, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb3-44"></span>
<span id="cb3-45">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Top-10 most likely tokens:"</span>)</span>
<span id="cb3-46">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, (prob, idx) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(top_k_probs, top_k_indices)):</span>
<span id="cb3-47">        token_text <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tokenizer.decode([idx.item()])</span>
<span id="cb3-48">        is_selected <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"← SELECTED"</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> idx.item() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> output_token_id <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span></span>
<span id="cb3-49">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">. '</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>token_text<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">' (prob: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>prob<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>item()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, logit: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>outputs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>scores[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][idx.item()]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>item()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">) </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>is_selected<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb3-50"></span>
<span id="cb3-51">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> selected_token</span></code></pre></div>
</div>
<p>On a high-level, this function takes a prompt, a temperature value, and a seed, and returns the top 10 most likely tokens with their probabilities and logits. The implementation looks a bit complicated, so let’s break it down.</p>
<ol type="1">
<li><p><strong>Lines 2 to 16</strong>: It takes a prompt, a temperature value, and optionally a seed. If a seed is provided, it sets the random number generator to that value. Then, it processes the prompt to create the required input for the model.</p></li>
<li><p><strong>Lines 18 to 37</strong>: It chooses to sample from the model or not, based on the temperature value. If temperature is 0, the model will use to a greedy search strategy.</p></li>
<li><p><strong>Lines 39 to 50</strong>: It returns the completion token and optinally prints the top 10 most likely tokens with their probabilities and logits.</p></li>
</ol>
<p>Similar to what you saw in the previous example, you can try low and high temperature values.</p>
<p>This is what you get for a temperature of 0.1:</p>
<div id="cell-10" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1">token <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> generate_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tell me a joke about dogs"</span>, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, print_top_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Top-10 most likely tokens:
  1. 'Why' (prob: 1.0000, logit: 330.0000) ← SELECTED
  2. '!' (prob: 0.0000, logit: -inf) 
  3. '"' (prob: 0.0000, logit: -inf) 
  4. '#' (prob: 0.0000, logit: -inf) 
  5. '$' (prob: 0.0000, logit: -inf) 
  6. '%' (prob: 0.0000, logit: -inf) 
  7. '&amp;' (prob: 0.0000, logit: -inf) 
  8. ''' (prob: 0.0000, logit: -inf) 
  9. '(' (prob: 0.0000, logit: -inf) 
  10. ')' (prob: 0.0000, logit: -inf) </code></pre>
</div>
</div>
<div id="cell-11" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1">token <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> generate_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tell me a joke about dogs"</span>, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.99</span>, print_top_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Top-10 most likely tokens:
  1. 'Why' (prob: 0.5742, logit: 16.5829) ← SELECTED
  2. 'Sure' (prob: 0.3939, logit: 16.2060) 
  3. 'Here' (prob: 0.0319, logit: 13.6935) 
  4. '!' (prob: 0.0000, logit: -inf) 
  5. '"' (prob: 0.0000, logit: -inf) 
  6. '#' (prob: 0.0000, logit: -inf) 
  7. '$' (prob: 0.0000, logit: -inf) 
  8. '%' (prob: 0.0000, logit: -inf) 
  9. '&amp;' (prob: 0.0000, logit: -inf) 
  10. ''' (prob: 0.0000, logit: -inf) </code></pre>
</div>
</div>
<p>You should see similar results. For the “Tell me a joke about dogs” prompt, when using a temperature of 0.1, the model had ~100% probability of picking ‘Why’, while for temperature 2, it’s only 57%.</p>
<p>Note, that when temperature is 0, the model will use to a greedy search strategy, which is the same as picking the most likely token. So no sampling is done and results are deterministic.</p>
</section>
<section id="seed" class="level2">
<h2 class="anchored" data-anchor-id="seed">Seed</h2>
<p>The seed parameter controls the randomness of how a model selects tokens. It sets the initial state for the random number generator used in the token sampling process.</p>
<p>Let’s revisit the example from the previous section to see this in action. By setting the seed to a fixed value, you ensure the generation process is deterministic. This means you will get an identical result on every run, provided all other parameters (like temperature) remain the same in those runs.</p>
<p>We can start by setting our seed to 42 and temperature to 1 to verify which token is generated.</p>
<div id="cell-15" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1">generate_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tell me a joke about dogs"</span>, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>, print_top_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Top-10 most likely tokens:
  1. 'Why' (prob: 0.6792, logit: 33.0000) 
  2. 'Sure' (prob: 0.3208, logit: 32.2500) ← SELECTED
  3. '!' (prob: 0.0000, logit: -inf) 
  4. '"' (prob: 0.0000, logit: -inf) 
  5. '#' (prob: 0.0000, logit: -inf) 
  6. '$' (prob: 0.0000, logit: -inf) 
  7. '%' (prob: 0.0000, logit: -inf) 
  8. '&amp;' (prob: 0.0000, logit: -inf) 
  9. ''' (prob: 0.0000, logit: -inf) 
  10. '(' (prob: 0.0000, logit: -inf) </code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>'Sure'</code></pre>
</div>
</div>
<p>In this case, the model selected “Sure” as the next token, even though its probability is lower than ‘Why’. Now, we can verify that this stays the same over multiple runs.</p>
<div id="cell-17" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1">tokens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb11-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>):</span>
<span id="cb11-3">    token <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> generate_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tell me a joke about dogs"</span>, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb11-4">    tokens.append(token)</span>
<span id="cb11-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(tokens)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb11-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(tokens))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'Sure'}</code></pre>
</div>
</div>
<p>This code runs the text generation process 100 times and verifies that “Sure” was picked in all runs. Next, we should verify that this consistency is lost when we omit the seed parameter.</p>
<div id="cell-19" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1">tokens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb13-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>):</span>
<span id="cb13-3">    token <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> generate_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tell me a joke about dogs"</span>, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb13-4">    tokens.append(token)</span>
<span id="cb13-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(tokens)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb13-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(tokens))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'Sure', 'Why'}</code></pre>
</div>
</div>
<p>In this case, you see that after the 100 generations, the model picked two different tokens: ‘Sure’ and ‘Why’. This is expected due to not setting a seed.</p>
<p>You can also use test this with a propietary model. Let’s try it with <code>gpt-4.1-nano</code> from OpenAI.</p>
<div id="cell-21" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> openai</span>
<span id="cb15-2"></span>
<span id="cb15-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb15-4"></span>
<span id="cb15-5">load_dotenv()</span>
<span id="cb15-6"></span>
<span id="cb15-7">client <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> openai.OpenAI()</span>
<span id="cb15-8"></span>
<span id="cb15-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> generate_text_openai(prompt, temperature, seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, print_top_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>):</span>
<span id="cb15-10">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> client.chat.completions.create(</span>
<span id="cb15-11">        model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4.1-nano"</span>,</span>
<span id="cb15-12">        messages<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: prompt}],</span>
<span id="cb15-13">        temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>temperature,</span>
<span id="cb15-14">        seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>seed,</span>
<span id="cb15-15">        max_tokens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb15-16">        logprobs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb15-17">        top_logprobs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,</span>
<span id="cb15-18">    )</span>
<span id="cb15-19">    selected_token <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> response.choices[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].message.content</span>
<span id="cb15-20">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> print_top_k:</span>
<span id="cb15-21">        logprobs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> response.choices[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].logprobs.content[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].top_logprobs</span>
<span id="cb15-22">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Top 10 most likely tokens:"</span>)</span>
<span id="cb15-23">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> idx, token_info <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(logprobs):</span>
<span id="cb15-24">            token <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> token_info.token</span>
<span id="cb15-25">            logprob <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> token_info.logprob</span>
<span id="cb15-26">            prob <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">round</span>(np.exp(logprob)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb15-27">            token_text <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">. '</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>token<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">': </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>prob<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> (</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>logprob<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">)"</span></span>
<span id="cb15-28">            is_selected <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"← SELECTED"</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> token_info.token <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> selected_token <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span></span>
<span id="cb15-29">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>token_text<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>is_selected<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb15-30">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> selected_token</span></code></pre></div>
</div>
<p>Similar to the previous function, you provide a prompt, a temperature value, and a seed, and the model will return a completion token and will print the top 10 most likely tokens.</p>
<p>In this case, instead of providing you with the logits, OpenAI will provide you with <code>logprobs</code> which are the logaritmic probabilities of the tokens:</p>
<p><img src="https://latex.codecogs.com/png.latex?logprob(w_i)%20=%20ln(P(w_i))%20=%20ln(%5Cfrac%7Be%5E%7Bz_i%7D%7D%7B%5Csum_%7Bj=1%7D%5E%7Bn%7D%20e%5E%7Bz_j%7D%7D)%20"></p>
<p>First, let’s check the completion token we get for a temperature of 1 and a seed of 42.</p>
<div id="cell-23" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1">token <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> generate_text_openai(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tell me a joke about dogs"</span>, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>, print_top_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Top 10 most likely tokens:
1. 'Why': 59.2600 (-0.5232) ← SELECTED
2. 'Sure': 40.7300 (-0.8982) 
3. ' Why': 0.0000 (-10.6482) 
4. ' sure': 0.0000 (-11.0232) 
5. ' why': 0.0000 (-11.2732) 
6. '为什么': 0.0000 (-11.6482) 
7. ' Sure': 0.0000 (-11.8982) 
8. 'Pourquoi': 0.0000 (-12.2732) 
9. 'why': 0.0000 (-12.3982) 
10. 'sure': 0.0000 (-12.6482) </code></pre>
</div>
</div>
<p>In this case, we get ‘Why’ as the completion token. You can see that the top 10 most likely tokens are not the same as the ones we got with <code>Qwen3-1.7B</code>. This is expected, as the model is different.</p>
<p>Then, we can try to generate 100 tokens with a temperature of 1 and a seed of 42.</p>
<div id="cell-25" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1">tokens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb18-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>):</span>
<span id="cb18-3">    token <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> generate_text_openai(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tell me a joke about dogs"</span>, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb18-4">    tokens.append(token)</span>
<span id="cb18-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(tokens)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb18-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(tokens))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'Why'}</code></pre>
</div>
</div>
<p>Similar to the previous example, we run 100 generations with the same seed and temperature and check if the completion token is the same.</p>
<p>This should <em>generally</em> work, but OpenAI doesn’t guarantee that the same seed will always produce the same output. It might occur that your request is handled by a model with a <a href="https://cookbook.openai.com/examples/reproducible_outputs_with_the_seed_parameter">different configuration</a>, and you’ll get different results.</p>
<p>You can also verify that not using a seed will result in different tokens.</p>
<div id="cell-27" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb20-1">tokens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb20-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>):</span>
<span id="cb20-3">    token <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> generate_text_openai(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tell me a joke about dogs"</span>, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb20-4">    tokens.append(token)</span>
<span id="cb20-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(tokens)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb20-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(tokens))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'Sure', 'Why'}</code></pre>
</div>
</div>
<p>Now, you can see that the output is not the same in all runs. Some runs picked “Why”, and others picked “Sure”.</p>
<p>In essence, seed influences the output by setting the initial state of the random number generator, which is then used for the sampling of the tokens during the generation process.</p>
</section>
<section id="top-k-and-top-p" class="level2">
<h2 class="anchored" data-anchor-id="top-k-and-top-p"><code>top-k</code> and <code>top-p</code></h2>
<p>In addition to temperature, there are two other parameters that are commonly used to control the randomness of the output of a language model: <code>top-k</code> and <code>top-p</code>.</p>
<section id="top-k" class="level3">
<h3 class="anchored" data-anchor-id="top-k">top-k</h3>
<p>Top-k sampling is a technique that limits the number of tokens that can be selected from the vocabulary. It does so by keeping only the top-k tokens with the highest probabilities. This reduces the <a href="https://huyenchip.com/2024/01/16/sampling.html#top_k">computational workload</a> by getting the top-k logits and then calculating the softmax over these instead of using the complete vocabulary.</p>
<p>This parameter isn’t available for OpenAI models. They provide a <code>top_logprobs</code> parameter, but it’s not the same as top-k sampling. It’s a parameter that returns the top N most likely tokens with their logprobs, but it doesn’t change the sampling process.</p>
</section>
<section id="top-p" class="level3">
<h3 class="anchored" data-anchor-id="top-p">top-p</h3>
<p>Top-p sampling is a technique that limits the number of tokens that can be selected from the vocabulary. It does so including the smallest set of tokens whose combined probability ≥ P. For example, top P = 0.9 picks from the smallest group of tokens that together cover at least 90% probability.</p>
<p>This parameter is available for most providers.</p>
<div id="cell-30" class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb22-1">generate_text_openai(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tell me a joke about dogs"</span>, top_p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.50</span>, print_top_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Top 10 most likely tokens:
1. 'Why': 59.2600 (-0.5232) ← SELECTED
2. 'Sure': 40.7300 (-0.8982) 
3. ' Why': 0.0000 (-10.6482) 
4. ' sure': 0.0000 (-11.0232) 
5. ' why': 0.0000 (-11.2732) 
6. '为什么': 0.0000 (-11.6482) 
7. ' Sure': 0.0000 (-11.8982) 
8. 'Pourquoi': 0.0000 (-12.2732) 
9. 'why': 0.0000 (-12.3982) 
10. 'sure': 0.0000 (-12.6482) </code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="51">
<pre><code>'Why'</code></pre>
</div>
</div>
</section>
</section>
<section id="seed-and-temperature-in-practice" class="level2">
<h2 class="anchored" data-anchor-id="seed-and-temperature-in-practice">Seed and temperature in practice</h2>
<p>Now that you understand how seed and temperature work, here are some things to keep in mind when using them:</p>
<ol type="1">
<li><code>seed</code> is only available for <code>OpenAI</code>, <code>Gemini</code> on <code>Vertex AI</code>, and open-weight models.</li>
<li>To get the most deterministic output for a given prompt, set temperature to 0. This minimizes randomness.</li>
<li>If you want creative results that are still reproducible, set temperature to a value greater than 0 and use a fixed seed. This allows for varied outputs that you can generate again.</li>
<li>If you don’t need reproducible results and want unique outputs on every run, you can omit the seed parameter entirely.</li>
<li>Be aware that even if you set a temperature of 0 and a seed, outputs are not guaranteed to be identical. Providers <a href="https://platform.openai.com/docs/advanced-usage#reproducible-outputs">might change model configurations</a> that might impact the output. For OpenAI models, you can monitor such changes by keeping track of the <a href="https://platform.openai.com/docs/api-reference/backward-compatibility">system_fingerprint</a> provided in the responses.</li>
</ol>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>In this post, we explored how the temperature and seed parameters control the output of Large Language Models.</p>
<p>You learned that temperature adjusts the level of randomness: low values (near 0) produce more predictable, deterministic outputs, while high values (near 1) encourage more creative and varied results. In contrast, the seed makes the generation process reproducible. While the specific seed value isn’t important, fixing it ensures you get the same output for a given prompt and set of parameters.</p>
<p>Finally, remember that while temperature is a near-universal setting, seed is only available (at the time of writing) for OpenAI, Gemini on Vertex AI, and open-weight models.</p>
<p>I hope you found this post useful. If you have any questions, let me know in the comments below.</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Modern LLMs often have a vocabulary of 100k+ tokens↩︎</p></li>
</ol>
</section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2025,
  author = {Castillo, Dylan},
  title = {Controlling Randomness in {LLMs:} {Temperature} and {Seed}},
  date = {2025-06-25},
  url = {https://dylancastillo.co/posts/seed-temperature-llms.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2025" class="csl-entry quarto-appendix-citeas">
Castillo, Dylan. 2025. <span>“Controlling Randomness in LLMs:
Temperature and Seed.”</span> June 25, 2025. <a href="https://dylancastillo.co/posts/seed-temperature-llms.html">https://dylancastillo.co/posts/seed-temperature-llms.html</a>.
</div></div></section></div> ]]></description>
  <category>llm</category>
  <category>openai</category>
  <category>python</category>
  <guid>https://dylancastillo.co/posts/seed-temperature-llms.html</guid>
  <pubDate>Wed, 25 Jun 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>2024: Personal Snapshot</title>
  <dc:creator>Dylan Castillo</dc:creator>
  <link>https://dylancastillo.co/posts/2024-personal-snapshot.html</link>
  <description><![CDATA[ 




<p>This is my annual review. I use it as a way to reflect on the past year and get a snapshot of “who I am” at the time of writing.</p>
<p>If it’s me rereading this, welcome back. This is Dylan from 2024.</p>
<p>In previous snapshots, I listed what went well and what didn’t. This year, I’m trying something new: a chronological approach. 2024 went through three distinct phases, and I found it easier to reflect on each one.</p>
<section id="early-2024" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="early-2024">Early 2024</h2>
<p>This was my “I’m lost, and I don’t know what to do” phase.</p>
<p>In my last snapshot, I said that I was going to focus on building a consulting practice in 2024. Then I came up with a new product idea 😅 and spent a big chunk of the first two months of the year building a prototype.</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><a href="images/2024-personal-snapshot/aitheneum.webp" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="At least I generated some cool AI book covers."><img src="https://dylancastillo.co/posts/images/2024-personal-snapshot/aitheneum.webp" class="img-fluid figure-img" alt="At least I generated some cool AI book covers."></a></p>
<figcaption class="margin-caption">At least I generated some cool AI book covers.</figcaption>
</figure>
</div>
<p><a href="https://aitheneum.iwanalabs.com/">AItheneum</a><sup>1</sup> is a tool that helps you read classic philosophy books by making them easier to understand using AI. I pitched it as a way to make classic books more accessible to modern readers.</p>
<p>I had fun working on it, but it wasn’t really solving anyone’s problem. It was a vitamin, not a painkiller. By the time I released it, it was clear nobody cared about it (not even me!).</p>
<p>During this time, I was also contributing to <a href="https://github.com/django-components/django-components">django-components</a> and half-assing talking to potential clients for freelance work and doing cold outreach to get clients. The former was fun, the latter wasn’t.</p>
<p>Later in the year, after reading Alex Hormozi’s <a href="https://www.amazon.com/100M-Leads-Strangers-Stuff-Acquisition-com-ebook/dp/B0CFDR3TYV">100M Leads</a>, I realized that cold outreach at this stage was mostly a waste of time. When you’re just starting out, you should rely on warm introductions or referrals. If you haven’t built credibility yet, you’ll waste a lot of time trying to convince strangers to work with you.</p>
<p>I essentially spent the first two months of the year focusing on the wrong things.</p>
<p>On a more positive note, I was also doing open mic sets almost every week. I’m not sure if this was “good”, but I had a lot of fun performing stand-up comedy.</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><a href="images/2024-personal-snapshot/jokes.webp" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="My last stand-up set"><img src="https://dylancastillo.co/posts/images/2024-personal-snapshot/jokes.webp" class="img-fluid figure-img" alt="My last stand-up set"></a></p>
<figcaption class="margin-caption">My last stand-up set</figcaption>
</figure>
</div>
<p>As you might expect, I bombed a few times. But I also had a few good sets. A professional (but not famous) comedian even invited me to open for him at a show in a nearby city. I didn’t go, but it was flattering.</p>
<p>One thing that surprised me about stand-up comedy is that it follows a somewhat scientific process. Your joke is a hypothesis about what your audience will find funny. You test it by performing it in front of people. If it doesn’t work, you adjust it and test it again. You do this over and over until you find something that works.</p>
<p>The other thing I liked about it is that it’s very meritocratic. If you’re funny, you’ll get laughs. There’s no way to fake it. It’s very easy to figure out who’s good and who’s not. You might not like someone’s style, but if they’re good you cannot deny it.</p>
<p>However, after a few months, I realized it wasn’t sustainable:</p>
<ol type="1">
<li>To get good at stand-up, you have to make time for it. That means writing everyday, and performing as often as possible.</li>
<li>Open mics take a lot of time. To practice an 8 minute set, I’d often have to commute for 1 hour and stay for 1-2 hours of show (during which I did my 8 minutes).</li>
<li>As a beginner, you’ll only get spots during weekday evenings. Which isn’t great if you want to get enough sleep to be productive the next day.</li>
</ol>
<p>Even so, I didn’t fully decide to quit until we had a health crisis at home. My wife and I weren’t prioritizing our health in the first months of the year, and it took its toll.</p>
<p>Stand-up was fun, but it was distracting me from more important things. So I stopped.</p>
<p>I’m not sad or regretful about it, I’m happy that I’ve tried it and that I’ve learned that it’s not what I want to do right now. I’d love to return to it in the future, once I have less pressing things to focus on.</p>
</section>
<section id="mid-2024" class="level2">
<h2 class="anchored" data-anchor-id="mid-2024">Mid 2024</h2>
<p>This was the “work hard and mental health struggles” phase.</p>
<p>I worked with clients on AI projects in various industries, including legal, construction, consumer packaged goods, and finance. I also started blogging again.</p>
<p>I frequently put in 12-hour workdays and worked most weekends. I stopped going to the gym, and switched to home workouts. I rarely went to social events. Life passed by rapidly, and looking back, it all feels like a blur.</p>
<p>I struggled with my mental health. I experienced episodes of depression and anxiety.</p>
<p>Depression has been part of my life for the past twenty years. Though, I’m much better at dealing with it than I used to be. I’ve learned to recognize early warning signs and adjust my approach accordingly.</p>
<p>For that reason, I try to keep track of the “bad days”. Because when they occur too often, my brain is telling me I should take action. During this phase of the year, I had a lot more of those than I’d like.</p>
<p>Eventually, things settled down. I became more conscious of my own limits. I learned to regulate the intensity I put into things. I could push myself hard when I needed to, but also learned to feel comfortable with taking a break and not do anything when I needed to.</p>
<p>I also met some clients in person. While I’m a fan of remote work, seeing people face to face makes you more empathetic toward the people you’re working with. This was a lot more fun than I expected.</p>
<p>During this time I also hired external support to help me develop some of my product ideas and support my consulting work.</p>
</section>
<section id="late-2024" class="level2">
<h2 class="anchored" data-anchor-id="late-2024">Late 2024</h2>
<p>This was the “force myself to stay focused and in motion” phase.</p>
<p>The last few months were still intense, but less focused. I was working with clients while also making time to think about the future. I had a few moments of “what if I drop the consulting thing and go back to product development?”, but decided against it every time.</p>
<p>I did more sales outreach, managed multiple projects, and kept writing blog posts. I wrote a <a href="https://dylancastillo.co/posts/say-what-you-mean-sometimes.html">post about using Structured Outputs in LLMs</a> and fixed a security vulnerability in a <a href="https://github.com/instructor-ai/instructor/pull/1168">Python package</a> that gets more than 1M downloads per month.</p>
<p>I also traveled to Venezuela for the first time in eight years. It was both wonderful and unsettling.</p>
<p>During the first week of the trip, we stayed in a nice hotel in <a href="https://en.wikipedia.org/wiki/Margarita_Island">Margarita</a>, with great food, gym, pools, and a private beach. But if you talked with anyone working at the hotel, you’d learn they were making less than $200/month and did not routinely have access to clean water or electricity. After almost a decade of living in Europe, it felt strange to witness once again such a disparity.</p>
<p>I also met old friends and family there. It made me nostalgic for my childhood and university days, but it also made me realize how much I’ve changed since then. When I was a teenager, I often thought I might end up alone and without friends, as I had extreme social anxiety. Now I’m married, have a great group of friends, and can even tell jokes in public!</p>
<p>After I came back from Venezuela, I started going through more academic research and refreshing my <a href="https://mathacademy.com/">math skills</a>. I’ve always felt that some of my base math skills were lacking and I wanted to fix that. So far, it’s going great.</p>
<p>My father-in-law also moved with us for this part of the year. It was a big change for us, but it’s been a great experience.</p>
</section>
<section id="stats-photos" class="level2">
<h2 class="anchored" data-anchor-id="stats-photos">Stats &amp; Photos</h2>
<p>Here are the stats for the year:</p>
<ul>
<li><strong>💻 Code and blogging</strong>:
<ul>
<li>I committed code on 322 out of 365 days.</li>
<li>I wrote 14 blog posts.</li>
</ul></li>
<li><strong>💰 Financials</strong>:
<ul>
<li>Revenue doubled from last year. So far, my best year.</li>
<li>Costs increased by 155% from last year.</li>
<li>66% of my revenue comes from time-based billing (daily, hourly).</li>
<li>My biggest client represented 33% of my revenue.</li>
</ul></li>
<li><strong>📝 Sales</strong>:
<ul>
<li>I worked on 9 projects with 7 different clients.</li>
<li>I got 3 new clients.</li>
<li>Success rate of proposals: 67%.</li>
</ul></li>
<li><strong>💪 Health &amp; Fitness</strong>:
<ul>
<li>112 strength training sessions (2.2 sessions/week).</li>
<li>3,488 minutes of cardio (~60 minutes/week).</li>
<li>VO2 max: 46 ml/kg/min.</li>
<li>RHR: 57 bpm.</li>
</ul></li>
</ul>
<p>These are some photos from the year:</p>
<div class="custom-gallery-container" data-images="[
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/27394352-8BDD-47EF-AB8D-5B7EEABDD1BE_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;A good stand-up set&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/9BAE2624-4DB5-4D53-8F74-922E25AE2E11_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;A so-so stand-up set&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/281F5B0F-07D6-478C-83E9-73D136A31088_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;The day Edu and Leo decided to never do Airsoft again&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/24E61471-8D7B-4F37-992C-F3428FB46DCA_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;Morocco ❤️&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/4BCF78E3-3FE8-475B-AFB2-D2E9AC358234_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;Old friends 1&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/0CA7E896-69E6-4A2D-BC49-67B3DB5F6618_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;Primos&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/6D90D345-B819-4AD3-865E-249B86EAB6D3_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;Home team&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/08C29CCA-8FCF-4794-8A13-FA31F97CA59F_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;Venezuela, family 1&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/FDC40C8A-EA95-42D5-A927-8ED1801AD182_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;Venezuela, Margarita 😎&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/AE334898-D23D-4F3D-9004-FC1B489A33C9_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;Venezuela, old friends 2&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/451B688D-070E-4E92-BB27-25170A8973A4_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;Venezuela, old friends 3&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/D38E3BF7-4BAC-47B2-83BB-E2CD7216D2E3_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;Venezuela, humming-birds 🐦&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/EC982C3C-B649-4FE9-8E31-812AB9888C32_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;Venezuela, Home&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/D7F82391-78E2-4BDA-8B17-5584DF01F911_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;Venezuela, Zena ❤️&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/F8ECF562-9F0B-4B9E-9B0C-B922D0B826A9_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;Venezuela, Napo's getting old 😢&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/CE02055B-B5A9-454A-9736-B2D86DD17AA7_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;The Colombiano Libertario&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/29408D6A-A961-4004-853A-2959C7A5E636_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;High 🥩 Poker&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/A3D6DCF0-D65B-40C6-A630-FA219AAC0981_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;Tía Mary ❤️&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/2EB0D748-F8AF-49F9-BEF0-3906D7AB017E_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;Family 2&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/PHOTO-2024-12-20-10-02-34.jpg&quot;, &quot;caption&quot;: &quot;Old friends 4&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/609AB45C-8EFC-4DC6-9BFD-241245DD2269_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;Friends (Luciano's farewell 🇦🇷)&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/20A01D83-C0AB-4460-9484-6F32A72E703D_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;Family 3&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/E7FECC11-00B8-4124-9519-82F9ED68C0ED_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;The Dukes of Bocangel ❤️&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/6D91F2D8-D302-4467-A3DC-681CD5D372AE_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;Karaoke 😂&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/2B2543F7-F99E-4D44-BCEA-45AB683A55BF_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;Last run of the year 1&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/89B92C0E-C70F-4660-A0A4-3DA2EEA54B63_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;Last run of the year 2&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/C9917576-0866-46C3-A500-1E680A24E24F_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;❤️&quot;}
     ]">
<img class="gallery-image" src="" alt="">
<div class="gallery-caption">

</div>
</div>
<p>I don’t like taking pictures, but looking back, I regret not capturing more key moments from the year. That’s a small lesson I’ll take into next year.</p>
</section>
<section id="lessons-learned" class="level2">
<h2 class="anchored" data-anchor-id="lessons-learned">Lessons Learned</h2>
<p>The three biggest lessons I took away from 2024 are focus, intensity, and action.</p>
<p><strong>Focus</strong> is about figuring out what are the right things to prioritize. It’s easy to say that, but it’s hard to do. Life is full of distractions, and it’s easy to get lost in the noise.</p>
<p>When I’m not sure what to do, I use one heuristic that works well: I prioritize things that will help me on my way regardless of their outcome. For example, if I dedicate more time to writing technical posts, I learn through the act of writing, but I also attract clients who are interested in those posts. The same with sales: I might not get a client from a sales call, but I learn a lot about the process and get better at it. So, regardless of the outcome, I win.</p>
<p><strong>Intensity</strong> is about working hard and taking ownership. This year I handled more work than ever. My brain fought back. At times I felt anxious, depressed, out of energy, and unable to focus. Eventually, my brain accepted that I wouldn’t back down. It stopped fighting against me and began working for me.</p>
<p>It’s not pretty. It’s deeply uncomfortable. But it’s worth it.</p>
<p><strong>Action</strong> is about staying in motion. Being too busy is better than being too idle. When you’re busy, you’re constantly learning, forced to prioritize, and often become more creative under pressure.</p>
<p>I used to think that being “too busy” would prevent me from focusing on the right things. But I eventually realized it was the other way around. The busier I got, the clearer my priorities became. I learned more, and the better I became at what I was doing, the more time I had for the things I really wanted to do.</p>
<p>Being busy made me better and more productive.</p>
</section>
<section id="whats-next" class="level2">
<h2 class="anchored" data-anchor-id="whats-next">What’s Next?</h2>
<p>I’ve realized I’m not great at predicting what I’ll want to do, nor am I a great planner.</p>
<p>Right now, my biggest priority is growing my consulting practice. I also finally found a painkiller product idea that I’ve been slowly working on. If I find enough traction, I’ll pivot to it. But until then, my focus is on consulting.</p>
<p>The only thing I’m sure is that I’ll keep myself busy.</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>yes, I know, what a terrible name.↩︎</p></li>
</ol>
</section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2025,
  author = {Castillo, Dylan},
  title = {2024: {Personal} {Snapshot}},
  date = {2025-01-05},
  url = {https://dylancastillo.co/posts/2024-personal-snapshot.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2025" class="csl-entry quarto-appendix-citeas">
Castillo, Dylan. 2025. <span>“2024: Personal Snapshot.”</span> January
5, 2025. <a href="https://dylancastillo.co/posts/2024-personal-snapshot.html">https://dylancastillo.co/posts/2024-personal-snapshot.html</a>.
</div></div></section></div> ]]></description>
  <category>personal-snapshot</category>
  <guid>https://dylancastillo.co/posts/2024-personal-snapshot.html</guid>
  <pubDate>Sun, 05 Jan 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>The good, the bad, and the ugly of Gemini’s structured outputs</title>
  <dc:creator>Dylan Castillo</dc:creator>
  <link>https://dylancastillo.co/posts/gemini-structured-outputs.html</link>
  <description><![CDATA[ 




<p>For a long time, I didn’t pay much attention to the idea that structured outputs could have an impact on the performance of LLMs. But after reading <a href="https://arxiv.org/abs/2408.02442">Let Me Speak Freely?</a> and <a href="https://blog.dottxt.co/say-what-you-mean.html">.txt’s rebuttal</a>, I started to question my assumptions.</p>
<p>I decided to run some benchmarks myself using popular proprietary models, starting with <a href="https://dylancastillo.co/posts/say-what-you-mean-sometimes.html"><em>GPT-4o-mini</em></a>. During my analysis, I found that structured outputs did, in fact, decrease performance on some tasks.</p>
<p>After that, I was curious to see if the same was true for <em>Gemini 1.5 Flash</em>. This time, the answer wasn’t so straightforward, which is why I decided to write a separate post about it. In the process, I ran into an issue in Gemini’s Generative AI SDK that can break your application if you’re not careful.</p>
<p>In this article, I’ll share the results from running various benchmarks for <em>Gemini 1.5 Flash</em> comparing structured and unstructured outputs and the learnings I had along the way.</p>
<p>You can find the full code to run the benchmarks in this <a href="https://github.com/dylanjcastillo/blog/tree/main/_extras/gemini-structured-outputs">GitHub repository</a>.</p>
<section id="results-tldr" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="results-tldr">Results (TLDR)</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Google recently released a new <a href="https://github.com/googleapis/python-genai">Python SDK for Gemini</a>, which seems to address the automatically sorting keys issue.</p>
</div>
</div>
<p>If you’re in a hurry, here are my key findings:</p>
<ul>
<li><strong>The good</strong>: Overall, Gemini’s structured outputs performed on par with unstructured outputs.<sup>1</sup></li>
<li><strong>The bad</strong>: This only holds for the less rigid interpretation of “structured outputs”. When testing constrained decoding specifically, Gemini’s structured outputs performed worse than unstructured outputs.</li>
<li><strong>The ugly</strong>: Function calling and constrained decoding have a big design flaw. The order of the keys specified in the schema is not preserved when using the <a href="https://ai.google.dev/">Generative AI Python SDK</a>. This will break chain-of-thought reasoning in your applications unless you use a workaround (that only works for constrained decoding).</li>
</ul>
<p>The figure below shows the overall results for <em>Gemini 1.5 Flash</em>:</p>
<div id="cell-fig-gemini-flash-best" class="cell page-columns page-full" data-execution_count="1">
<div id="fig-gemini-flash-best" class="cell-output cell-output-display quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-gemini-flash-best-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div>                            <div id="8839e563-ec82-440c-897f-8c2d34e8d122" class="plotly-graph-div" style="height:400px; width:100%;"></div>            <script type="text/javascript">                require(["plotly"], function(Plotly) {                    window.PLOTLYENV=window.PLOTLYENV || {};                                    if (document.getElementById("8839e563-ec82-440c-897f-8c2d34e8d122")) {                    Plotly.newPlot(                        "8839e563-ec82-440c-897f-8c2d34e8d122",                        [{"hoverinfo":"skip","name":"Natural Language","text":["94.84","82.67","97.15"],"textfont":{"size":10},"textposition":"outside","texttemplate":"%{text:.2f}%","x":["GSM8k","Last Letter","Shuffled Objects"],"y":[94.84,82.67,97.15],"type":"bar"},{"hoverinfo":"skip","name":"JSON-Schema","text":["93.63","81.33","86.18"],"textfont":{"size":10},"textposition":"outside","texttemplate":"%{text:.2f}%","x":["GSM8k","Last Letter","Shuffled Objects"],"y":[93.63,81.33,86.18],"type":"bar"},{"hoverinfo":"skip","name":"JSON-Prompt","text":["94.16","82.0","98.37"],"textfont":{"size":10},"textposition":"outside","texttemplate":"%{text:.2f}%","x":["GSM8k","Last Letter","Shuffled Objects"],"y":[94.16,82.0,98.37],"type":"bar"}],                        {"template":{"data":{"barpolar":[{"marker":{"line":{"color":"rgb(17,17,17)","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"barpolar"}],"bar":[{"error_x":{"color":"#f2f5fa"},"error_y":{"color":"#f2f5fa"},"marker":{"line":{"color":"rgb(17,17,17)","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"bar"}],"carpet":[{"aaxis":{"endlinecolor":"#A2B1C6","gridcolor":"#506784","linecolor":"#506784","minorgridcolor":"#506784","startlinecolor":"#A2B1C6"},"baxis":{"endlinecolor":"#A2B1C6","gridcolor":"#506784","linecolor":"#506784","minorgridcolor":"#506784","startlinecolor":"#A2B1C6"},"type":"carpet"}],"choropleth":[{"colorbar":{"outlinewidth":0,"ticks":""},"type":"choropleth"}],"contourcarpet":[{"colorbar":{"outlinewidth":0,"ticks":""},"type":"contourcarpet"}],"contour":[{"colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"type":"contour"}],"heatmapgl":[{"colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"type":"heatmapgl"}],"heatmap":[{"colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"type":"heatmap"}],"histogram2dcontour":[{"colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"type":"histogram2dcontour"}],"histogram2d":[{"colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"type":"histogram2d"}],"histogram":[{"marker":{"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"histogram"}],"mesh3d":[{"colorbar":{"outlinewidth":0,"ticks":""},"type":"mesh3d"}],"parcoords":[{"line":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"parcoords"}],"pie":[{"automargin":true,"type":"pie"}],"scatter3d":[{"line":{"colorbar":{"outlinewidth":0,"ticks":""}},"marker":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"scatter3d"}],"scattercarpet":[{"marker":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"scattercarpet"}],"scattergeo":[{"marker":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"scattergeo"}],"scattergl":[{"marker":{"line":{"color":"#283442"}},"type":"scattergl"}],"scattermapbox":[{"marker":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"scattermapbox"}],"scatterpolargl":[{"marker":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"scatterpolargl"}],"scatterpolar":[{"marker":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"scatterpolar"}],"scatter":[{"marker":{"line":{"color":"#283442"}},"type":"scatter"}],"scatterternary":[{"marker":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"scatterternary"}],"surface":[{"colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"type":"surface"}],"table":[{"cells":{"fill":{"color":"#506784"},"line":{"color":"rgb(17,17,17)"}},"header":{"fill":{"color":"#2a3f5f"},"line":{"color":"rgb(17,17,17)"}},"type":"table"}]},"layout":{"annotationdefaults":{"arrowcolor":"#f2f5fa","arrowhead":0,"arrowwidth":1},"autotypenumbers":"strict","coloraxis":{"colorbar":{"outlinewidth":0,"ticks":""}},"colorscale":{"diverging":[[0,"#8e0152"],[0.1,"#c51b7d"],[0.2,"#de77ae"],[0.3,"#f1b6da"],[0.4,"#fde0ef"],[0.5,"#f7f7f7"],[0.6,"#e6f5d0"],[0.7,"#b8e186"],[0.8,"#7fbc41"],[0.9,"#4d9221"],[1,"#276419"]],"sequential":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"sequentialminus":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]},"colorway":["#636efa","#EF553B","#00cc96","#ab63fa","#FFA15A","#19d3f3","#FF6692","#B6E880","#FF97FF","#FECB52"],"font":{"color":"#f2f5fa"},"geo":{"bgcolor":"rgb(17,17,17)","lakecolor":"rgb(17,17,17)","landcolor":"rgb(17,17,17)","showlakes":true,"showland":true,"subunitcolor":"#506784"},"hoverlabel":{"align":"left"},"hovermode":"closest","mapbox":{"style":"dark"},"margin":{"b":0,"l":0,"r":0,"t":30},"paper_bgcolor":"rgb(17,17,17)","plot_bgcolor":"rgb(17,17,17)","polar":{"angularaxis":{"gridcolor":"#506784","linecolor":"#506784","ticks":""},"bgcolor":"rgb(17,17,17)","radialaxis":{"gridcolor":"#506784","linecolor":"#506784","ticks":""}},"scene":{"xaxis":{"backgroundcolor":"rgb(17,17,17)","gridcolor":"#506784","gridwidth":2,"linecolor":"#506784","showbackground":true,"ticks":"","zerolinecolor":"#C8D4E3"},"yaxis":{"backgroundcolor":"rgb(17,17,17)","gridcolor":"#506784","gridwidth":2,"linecolor":"#506784","showbackground":true,"ticks":"","zerolinecolor":"#C8D4E3"},"zaxis":{"backgroundcolor":"rgb(17,17,17)","gridcolor":"#506784","gridwidth":2,"linecolor":"#506784","showbackground":true,"ticks":"","zerolinecolor":"#C8D4E3"}},"shapedefaults":{"line":{"color":"#f2f5fa"}},"sliderdefaults":{"bgcolor":"#C8D4E3","bordercolor":"rgb(17,17,17)","borderwidth":1,"tickwidth":0},"ternary":{"aaxis":{"gridcolor":"#506784","linecolor":"#506784","ticks":""},"baxis":{"gridcolor":"#506784","linecolor":"#506784","ticks":""},"bgcolor":"rgb(17,17,17)","caxis":{"gridcolor":"#506784","linecolor":"#506784","ticks":""}},"title":{"x":0.05},"updatemenudefaults":{"bgcolor":"#506784","borderwidth":0},"xaxis":{"automargin":true,"gridcolor":"#283442","linecolor":"#506784","ticks":"","title":{"standoff":15},"zerolinecolor":"#283442","zerolinewidth":2},"yaxis":{"automargin":true,"gridcolor":"#283442","linecolor":"#506784","ticks":"","title":{"standoff":15},"zerolinecolor":"#283442","zerolinewidth":2}}},"margin":{"l":50,"r":50,"t":50,"b":50,"pad":10},"yaxis":{"title":{"text":"Score (%)"},"range":[0,105],"fixedrange":true},"xaxis":{"title":{"text":"Task"},"fixedrange":true},"legend":{"orientation":"h","yanchor":"bottom","y":1.05,"xanchor":"center","x":0.5},"modebar":{"remove":["autoScale2d","autoscale","editInChartStudio","editinchartstudio","hoverCompareCartesian","hovercompare","lasso","lasso2d","orbitRotation","orbitrotation","pan","pan2d","pan3d","reset","resetCameraDefault3d","resetCameraLastSave3d","resetGeo","resetSankeyGroup","resetScale2d","resetViewMap","resetViewMapbox","resetViews","resetcameradefault","resetcameralastsave","resetsankeygroup","resetscale","resetview","resetviews","select","select2d","sendDataToCloud","senddatatocloud","tableRotation","tablerotation","toImage","toggleHover","toggleSpikelines","togglehover","togglespikelines","toimage","zoom","zoom2d","zoom3d","zoomIn2d","zoomInGeo","zoomInMap","zoomInMapbox","zoomOut2d","zoomOutGeo","zoomOutMap","zoomOutMapbox","zoomin","zoomout"]},"barmode":"group","height":400,"showlegend":true},                        {"responsive": true}                    ).then(function(){
                            
var gd = document.getElementById('8839e563-ec82-440c-897f-8c2d34e8d122');
var x = new MutationObserver(function (mutations, observer) {{
        var display = window.getComputedStyle(gd).display;
        if (!display || display === 'none') {{
            console.log([gd, 'removed!']);
            Plotly.purge(gd);
            observer.disconnect();
        }}
}});

// Listen for the removal of the full notebook cells
var notebookContainer = gd.closest('#notebook-container');
if (notebookContainer) {{
    x.observe(notebookContainer, {childList: true});
}}

// Listen for the clearing of the current output cell
var outputEl = gd.closest('.output');
if (outputEl) {{
    x.observe(outputEl, {childList: true});
}}

                        })                };                });            </script>        </div>
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-gemini-flash-best-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Best results for Gemini 1.5 Flash.
</figcaption>
</figure>
</div>
</div>
<p>The figure above compares the performance of Gemini’s structured outputs to unstructured outputs. <strong>NL</strong> stands for <em>Natural Language</em>, which means the model writes the output in a free-form manner. In contrast, <strong>JSON-Prompt</strong> and <strong>JSON-Schema</strong> involve structured outputs that follow a predefined JSON schema.</p>
<p>For <strong>JSON-Prompt</strong>, the JSON schema is included in the prompt, instructing the model to generate JSON formatted output based on its MIME type configuration. <strong>JSON-Schema</strong> works similarly, but the schema is set directly in the model’s configuration instead of being included in the prompt.</p>
<p>When considering both <strong>JSON-Prompt</strong> and <strong>JSON-Schema</strong>, Gemini’s structured outputs performed comparably to unstructured outputs. However, with <strong>JSON-Schema</strong> alone (i.e., constrained decoding), performance drops compared to unstructured outputs. This difference is most evident in the <em>Shuffled Objects</em> task, where <strong>NL</strong> achieved a score of 97.15%, while <strong>JSON-Schema</strong> scored 86.18%.</p>
</section>
<section id="structured-outputs-101" class="level2">
<h2 class="anchored" data-anchor-id="structured-outputs-101">Structured outputs 101</h2>
<p>In case you’re not familiar with the concept, structured outputs are a group of methods that <a href="https://arxiv.org/abs/2404.07362">“ensure that the model outputs adhere to a specific structure”</a>. In Open weight models, a <em>structure</em> can mean anything from a JSON schema to a specific regex pattern. With proprietary models, it usually means a JSON schema.</p>
<p>In its less rigid interpretation, this includes any method that can generate LLM outputs adhering to a structured format, such as prompting, <a href="https://platform.openai.com/docs/guides/function-calling">function calling</a>, <a href="https://platform.openai.com/docs/guides/structured-outputs#json-mode">JSON mode</a>, or <a href="https://openai.com/index/introducing-structured-outputs-in-the-api/">constrained decoding</a>.</p>
<p>In its more rigid interpretation, this includes only constrained decoding, as it is the only method that will guarantee the output adheres to the schema you provide.</p>
</section>
<section id="study-design" class="level2">
<h2 class="anchored" data-anchor-id="study-design">Study design</h2>
<p>In Let Me Speak Freely?, Tam et al.&nbsp;evaluated structured and unstructured outputs across three reasoning tasks and six classification tasks. They used exact match to evaluate the reasoning tasks and accuracy to evaluate the classification tasks. They ran the experiments using the following models:</p>
<ol type="1">
<li><strong>Proprietary models</strong>: <em>gpt-3.5-turbo-0125</em>, <em>claude-3-haiku-20240307</em>, <em>gemini-1.5-flash</em>, and <em>gpt-4o-mini-2024-07-18</em>.</li>
<li><strong>Open-weight models</strong>: <em>LLaMA3-8B-Instruct</em>, and <em>Gemma-2-9B-Instruct</em>.</li>
</ol>
<p>For this article, I just focused on <em>Gemini 1.5 Flash</em> and the reasoning tasks. I already ran the benchmarks for <em>GPT-4o-mini</em> and <em>Llama3-8B-Instruct</em> in my <a href="https://dylancastillo.co/posts/say-what-you-mean-sometimes.html">previous post</a>.</p>
<p>I excluded the classification tasks because I believe structured outputs perform better in classification tasks, and this is also in line with the study’s original findings. So I just focused on the three reasoning tasks:</p>
<ol type="1">
<li><a href="https://huggingface.co/datasets/openai/gsm8k">GSM8K</a>: A dataset from of grade school math word problems.</li>
<li><a href="https://huggingface.co/datasets/ChilleD/LastLetterConcat">Last Letter</a>: A dataset of simple word puzzles that require concatening the last letters of a list of names.</li>
<li><a href="https://github.com/google/BIG-bench/tree/main/bigbench/benchmark_tasks/tracking_shuffled_objects">Shuffled Objects</a>: A dataset that requires reasoning about the state of a system after a sequence of shuffling operations.</li>
</ol>
<p>The rest of the article details the process of re-evaluating these benchmarks using <em>Gemini-1.5-Flash</em>.</p>
</section>
<section id="structured-outputs-with-gemini" class="level2">
<h2 class="anchored" data-anchor-id="structured-outputs-with-gemini">Structured outputs with Gemini</h2>
<p>Gemini has three ways of generating structured outputs:</p>
<ol type="1">
<li><a href="https://ai.google.dev/gemini-api/tutorials/extract_structured_data"><strong>Forced function calling (FC)</strong></a>: You force the model to call a “function” and that makes the model generate a JSON schema that matches the function’s arguments.</li>
<li><a href="https://ai.google.dev/gemini-api/docs/structured-output?lang=python#supply-schema-in-prompt"><strong>Schema in prompt (JSON-Prompt)</strong></a>: You include a JSON schema in the prompt, specify <code>mime_type='application/json'</code> and the model generates a response that matches the schema.</li>
<li><a href="https://ai.google.dev/gemini-api/docs/structured-output?lang=python#supply-schema-in-config"><strong>Schema in model configuration (JSON-Schema)</strong></a>: You provide a JSON schema in the model configuration, specify <code>mime_type='application/json'</code> in the request and the model generates a response that matches the schema. This is the only method that seems to use <a href="https://developers.googleblog.com/en/mastering-controlled-generation-with-gemini-15-schema-adherence/">controlled generation</a>.</li>
</ol>
<p>I’ve included <em>JSON-Prompt</em> and <em>JSON-Schema</em> in the analysis, but had to exclude <em>FC</em> because it’s not possible to use it for chain-of-thought reasoning, which is a requirement for the benchmarks.</p>
</section>
<section id="issues-with-geminis-structured-outputs" class="level2">
<h2 class="anchored" data-anchor-id="issues-with-geminis-structured-outputs">Issues with Gemini’s structured outputs</h2>
<p>When running the three benchmarks, I quickly ran into a performance issue with <em>FC</em> and <em>JSON-Schema</em>. In all tasks, both showed double-digit performance drops compared to <em>NL</em>.</p>
<p>This didn’t make a lot of sense, so I started investigating.</p>
<p>I was using the following response schema for all structured outputs:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Response(BaseModel):</span>
<span id="cb1-2">    reasoning: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb1-3">    answer: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span></code></pre></div>
<p>The prompts were similar to the one below, adjusted according to the task:</p>
<blockquote class="blockquote">
<p>You are an expert in solving grade school math tasks. You will be presented with a grade-school math word problem and be asked to solve it.</p>
<p>You will always respond with JSON matching the following schema:</p>
<p>[RESPONSE_SCHEMA]</p>
<p>First, provide your step by step reasoning in the “reasoning” field. Then, in the “answer” field, provide your final answer. Don’t include any other text in the “answer” field.</p>
</blockquote>
<p>I eventually realized that the performance drop in <em>JSON-Schema</em> was due to the keys in the schema being reversed when generating the response. I then noticed that Tam et al.&nbsp;briefly mentioned in Let Me Speak Freely? that <em>JSON-Schema</em> responses failed to produce valid JSON due to this exact problem, so they did not include it in their analysis.</p>
<p>I didn’t want to exclude it from the analysis, so I started looking for a way to control the order of the keys in the schema. I found that the order of the keys in the schema gets sorted alphabetically before the response is generated. To confirm this, I ran a test with 100 randomly generated schemas. Every resulting output had its keys sorted alphabetically, so it’s clear this is not by chance.</p>
<p>I also found that the Vertex AI documentation mentions a <a href="https://cloud.google.com/vertex-ai/generative-ai/docs/multimodal/control-generated-output"><code>propertyOrdering</code></a> parameter, which should allow control over the order of keys. However, this feature <a href="https://discuss.ai.google.dev/t/issue-with-key-ordering-in-controlled-generation-on-gemini-1-5/41737/3">doesn’t appear</a> <a href="https://github.com/google-gemini/generative-ai-python/issues/533">to work</a> with the Generative AI Python SDK.</p>
<p>Unable to use the <code>propertyOrdering</code> parameter, I resorted to a quick workaround: I named the keys in a way that forced the desired order alphabetically. Instead of using <code>reasoning</code> and <code>answer</code>, I used <code>reasoning</code> and <code>solution</code>. This preserved the chain-of-thought reasoning in the responses, and resolved the performance drop in <em>JSON-Schema</em>.</p>
<p>But <em>FC</em> was a different story. Unlike <em>JSON-Schema</em>, the order of the keys follow a less predictable pattern, and I couldn’t find a way to control it. So I decided to exclude <em>FC</em> from the analysis.</p>
</section>
<section id="benchmarks-of-gemini-1.5-flash" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="benchmarks-of-gemini-1.5-flash">Benchmarks of Gemini 1.5 Flash</h2>
<p>After applying the key ordering workaround, and additional improvements discussed in my <a href="https://dylancastillo.co/posts/say-what-you-mean-sometimes.html#replicating-.txts-rebuttal.html">previous post</a>, I recomputed the benchmarks.</p>
<p>The table below shows the results for Gemini 1.5 Flash compared to the original results from Tam et al.</p>
<div class="cell page-columns page-full" data-execution_count="2">
<div id="tbl-gemini-1.5-flash" class="cell quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-execution_count="2">
<figure class="quarto-float quarto-float-tbl figure page-columns page-full">
<div aria-describedby="tbl-gemini-1.5-flash-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display" data-execution_count="4">
<style type="text/css">
</style>

<table id="T_cfc97" class="do-not-create-environment cell table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th class="blank" data-quarto-table-cell-role="th">&nbsp;</th>
<th class="blank level0" data-quarto-table-cell-role="th">&nbsp;</th>
<th id="T_cfc97_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">NL</th>
<th id="T_cfc97_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">JSON-Prompt</th>
<th id="T_cfc97_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">JSON-Schema</th>
</tr>
<tr class="even">
<th class="index_name level0" data-quarto-table-cell-role="th">Task</th>
<th class="index_name level1" data-quarto-table-cell-role="th">Method</th>
<th class="blank col0" data-quarto-table-cell-role="th">&nbsp;</th>
<th class="blank col1" data-quarto-table-cell-role="th">&nbsp;</th>
<th class="blank col2" data-quarto-table-cell-role="th">&nbsp;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td rowspan="3" id="T_cfc97_level0_row0" class="row_heading level0 row0" data-quarto-table-cell-role="th">GSM8K</td>
<td id="T_cfc97_level1_row0" class="row_heading level1 row0" data-quarto-table-cell-role="th">Tam et al.</td>
<td id="T_cfc97_row0_col0" class="data row0 col0">89.33</td>
<td id="T_cfc97_row0_col1" class="data row0 col1">89.21</td>
<td id="T_cfc97_row0_col2" class="data row0 col2">47.78</td>
</tr>
<tr class="even">
<td id="T_cfc97_level1_row1" class="row_heading level1 row1" data-quarto-table-cell-role="th">Me, 0-shot</td>
<td id="T_cfc97_row1_col0" class="data row1 col0">93.71</td>
<td id="T_cfc97_row1_col1" class="data row1 col1">93.78</td>
<td id="T_cfc97_row1_col2" class="data row1 col2">93.03</td>
</tr>
<tr class="odd">
<td id="T_cfc97_level1_row2" class="row_heading level1 row2" data-quarto-table-cell-role="th">Me, 3-shot</td>
<td id="T_cfc97_row2_col0" class="data row2 col0">94.84</td>
<td id="T_cfc97_row2_col1" class="data row2 col1">94.16</td>
<td id="T_cfc97_row2_col2" class="data row2 col2">93.63</td>
</tr>
<tr class="even">
<td rowspan="3" id="T_cfc97_level0_row3" class="row_heading level0 row3" data-quarto-table-cell-role="th">Last Letter</td>
<td id="T_cfc97_level1_row3" class="row_heading level1 row3" data-quarto-table-cell-role="th">Tam et al.</td>
<td id="T_cfc97_row3_col0" class="data row3 col0">65.45</td>
<td id="T_cfc97_row3_col1" class="data row3 col1">77.02</td>
<td id="T_cfc97_row3_col2" class="data row3 col2">0.67</td>
</tr>
<tr class="odd">
<td id="T_cfc97_level1_row4" class="row_heading level1 row4" data-quarto-table-cell-role="th">Me, 0-shot</td>
<td id="T_cfc97_row4_col0" class="data row4 col0">82.67</td>
<td id="T_cfc97_row4_col1" class="data row4 col1">80.00</td>
<td id="T_cfc97_row4_col2" class="data row4 col2">81.33</td>
</tr>
<tr class="even">
<td id="T_cfc97_level1_row5" class="row_heading level1 row5" data-quarto-table-cell-role="th">Me, 3-shot</td>
<td id="T_cfc97_row5_col0" class="data row5 col0">80.00</td>
<td id="T_cfc97_row5_col1" class="data row5 col1">82.00</td>
<td id="T_cfc97_row5_col2" class="data row5 col2">80.67</td>
</tr>
<tr class="odd">
<td rowspan="3" id="T_cfc97_level0_row6" class="row_heading level0 row6" data-quarto-table-cell-role="th">Shuffled Obj.</td>
<td id="T_cfc97_level1_row6" class="row_heading level1 row6" data-quarto-table-cell-role="th">Tam et al.</td>
<td id="T_cfc97_row6_col0" class="data row6 col0">58.21</td>
<td id="T_cfc97_row6_col1" class="data row6 col1">65.07</td>
<td id="T_cfc97_row6_col2" class="data row6 col2">N/A</td>
</tr>
<tr class="even">
<td id="T_cfc97_level1_row7" class="row_heading level1 row7" data-quarto-table-cell-role="th">Me, 0-shot</td>
<td id="T_cfc97_row7_col0" class="data row7 col0">97.15</td>
<td id="T_cfc97_row7_col1" class="data row7 col1">92.28</td>
<td id="T_cfc97_row7_col2" class="data row7 col2">86.18</td>
</tr>
<tr class="odd">
<td id="T_cfc97_level1_row8" class="row_heading level1 row8" data-quarto-table-cell-role="th">Me, 3-shot</td>
<td id="T_cfc97_row8_col0" class="data row8 col0">92.68</td>
<td id="T_cfc97_row8_col1" class="data row8 col1">98.37</td>
<td id="T_cfc97_row8_col2" class="data row8 col2">84.96</td>
</tr>
</tbody>
</table>
</div>
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-tbl margin-caption" id="tbl-gemini-1.5-flash-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: Results for Gemini 1.5 Flash.
</figcaption>
</figure>
</div>
</div>
<p>Using a 0-shot prompt and 3-shot prompts, I was able to improve all the metrics on the tasks and methods Tam et al.&nbsp;used for their benchmarks. Which is great!</p>
<p><em>NL</em> and <em>JSON-Prompt</em> are tied, without a clear winner between them. Each method got a slight edge over in 3 out of 6 tasks. On the other hand, <em>JSON-Schema</em> performed worst than <em>NL</em> in 5 out of 6 tasks. Plus, in <em>Shuffled Objects</em>, it did so with a gap of more than 10 percentage points: 97.15% for <em>NL</em> vs.&nbsp;86.18% for <em>JSON-Schema</em>.</p>
<p>Tam et al.&nbsp;defined structured outputs as any method that “involves providing output in standardized formats like JSON or XML through format restriction.” which is in line with the less rigid interpretation of structured outputs. Using this definition, the results show no performance gap between structured and unstructured outputs. This directly contradicts the study’s original claim.</p>
<p>But if you take the also common interpretation that constrained decoding is the only form of structured generation, then the study’s original conclusion still applies: there is indeed a significant performance gap between structured and unstructured outputs.</p>
<p>Weird, I know. But that’s the way it is.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Results are mixed for Gemini 1.5 Flash.</p>
<p>The good news is that structured outputs perform on par with unstructured ones. The bad news is that this only holds if you adopt the more flexible definition of “structured outputs.” And the ugly news is that Gemini’s Generative AI SDK has a major issue in how it handles the order of keys in the provided schema.</p>
<p>Based on the results, I’d suggest the following when using Gemini:</p>
<ol type="1">
<li>Avoid FC for any tasks that require chain-of-thought reasoning.</li>
<li>Default to JSON-Prompt over JSON-Schema for reasoning tasks.</li>
</ol>
<p>Finally, I want to emphasize that I love working with structured outputs. They save a lot of time. But I know there are tasks where they might perform worse (or better!) than unstructured outputs. There’s not enough evidence to support one or the other, so what I should just run my own evals and decide based on that.</p>
<p>That’s the real takeaway: run your own evals and choose the approach that works best for you. Don’t blindly trust random posts online.</p>
<p>You can find the code to replicate my results in this <a href="https://github.com/dylanjcastillo/blog/tree/main/_extras/gemini-structured-outputs">GitHub repository</a>.</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Assuming the less rigid interpretation of “structured outputs”.↩︎</p></li>
</ol>
</section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2024,
  author = {Castillo, Dylan},
  title = {The Good, the Bad, and the Ugly of {Gemini’s} Structured
    Outputs},
  date = {2024-12-27},
  url = {https://dylancastillo.co/posts/gemini-structured-outputs.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2024" class="csl-entry quarto-appendix-citeas">
Castillo, Dylan. 2024. <span>“The Good, the Bad, and the Ugly of
Gemini’s Structured Outputs.”</span> December 27, 2024. <a href="https://dylancastillo.co/posts/gemini-structured-outputs.html">https://dylancastillo.co/posts/gemini-structured-outputs.html</a>.
</div></div></section></div> ]]></description>
  <category>llm</category>
  <category>gemini</category>
  <category>pydantic</category>
  <category>python</category>
  <guid>https://dylancastillo.co/posts/gemini-structured-outputs.html</guid>
  <pubDate>Fri, 27 Dec 2024 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Structured outputs can hurt the performance of LLMs</title>
  <dc:creator>Dylan Castillo</dc:creator>
  <link>https://dylancastillo.co/posts/say-what-you-mean-sometimes.html</link>
  <description><![CDATA[ 




<p>When I read <a href="https://arxiv.org/abs/2408.02442">Let Me Speak Freely?</a> by Tam et al.&nbsp;I thought they raised an interesting question: does constraining LLM outputs to structured formats impact the quality of their responses?</p>
<p>In both the original study and their recent update, Tam et al.&nbsp;concluded that is the case. They found that “structured generation constraints significantly impact LLM performance across various tasks”.</p>
<p>But the study had major flaws. The <a href="https://dottxt.co/">.txt</a> team wrote a very compelling <a href="https://dottxt.co/blog/let-me-speak-freely">rebuttal</a> to the paper. For <em>Llama-3-8B-Instruct</em>, they demonstrate that Tam, et al.&nbsp;results were mostly due to poor prompting, unfair comparisons and the improper use of an “AI parser” rather than the use of structured outputs.</p>
<p>I liked the rebuttal but it still left me wondering how well their results generalize. They focused on a single model<sup>1</sup>, which represents a small fraction of the LLMs powering applications in production today. Open-weight models offer more flexibility on how to <em>structure</em> your output, such as letting users specify <a href="https://dottxt-ai.github.io/outlines/latest/reference/generation/regex/">regex expressions</a> to constrain the output. Proprietary models lack this. Right now, JSON is the only structured output format guaranteed to work across most popular providers.</p>
<p>Given this constraint, would the .txt team’s results still hold?</p>
<p>Plus, both the original study and the rebuttal focused on tasks that might not be a good proxy for the full range of tasks people use LLMs for. Would the rebuttal results be different in settings outside of simple reasoning tasks?</p>
<p>So I decided to:</p>
<ol type="1">
<li>Replicate the results from .txt’s rebuttal using <em>LLaMA3-8B-Instruct</em>.</li>
<li>Replicate the same tasks using a proprietary model <em>GPT-4o-mini</em>.</li>
<li>Test results on a broader set of tasks such as <a href="https://livebench.ai/">LiveBench</a>.</li>
</ol>
<p>This article presents the results of the first two steps. All the code is available on <a href="https://github.com/dylanjcastillo/blog/tree/main/_extras/say-what-you-mean-sometimes">Github</a>.</p>
<section id="results" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="results">Results</h2>
<p>If you’re short on time, here are the key findings:</p>
<ol type="1">
<li>Tam et al.’s conclusions about structured outputs might still hold, even if they did not properly test for it. There are tasks where structured outputs perform worse than unstructured ones.</li>
<li>.txt’s rebuttal is accurate. It shows that structured outputs are as good or better than unstructured outputs for <em>LLaMA3-8B-Instruct</em> in the tasks considered. But a similar approach did not hold for <em>GPT-4o-mini</em> (and possibly other models).</li>
</ol>
<p>The figure below shows the results for <em>GPT-4o-mini</em> using .txt’s prompt fixes, along with additional improvements I made.</p>
<div id="cell-fig-gpt-4o-mini-best" class="cell page-columns page-full" data-execution_count="1">
<div id="fig-gpt-4o-mini-best" class="cell-output cell-output-display quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-gpt-4o-mini-best-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div>                            <div id="f57c9335-f6b7-416b-ba77-e8f2b57ff706" class="plotly-graph-div" style="height:400px; width:100%;"></div>            <script type="text/javascript">                require(["plotly"], function(Plotly) {                    window.PLOTLYENV=window.PLOTLYENV || {};                                    if (document.getElementById("f57c9335-f6b7-416b-ba77-e8f2b57ff706")) {                    Plotly.newPlot(                        "f57c9335-f6b7-416b-ba77-e8f2b57ff706",                        [{"hoverinfo":"skip","name":"Structured","text":["93.86","94.67","89.84"],"textposition":"outside","texttemplate":"%{text:.2f}%","x":["GSM8k","Last Letter","Shuffled Objects"],"y":[93.86,94.67,89.84],"type":"bar"},{"hoverinfo":"skip","name":"Unstructured","text":["94.31","92.0","95.12"],"textposition":"outside","texttemplate":"%{text:.2f}%","x":["GSM8k","Last Letter","Shuffled Objects"],"y":[94.31,92.0,95.12],"type":"bar"}],                        {"template":{"data":{"barpolar":[{"marker":{"line":{"color":"rgb(17,17,17)","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"barpolar"}],"bar":[{"error_x":{"color":"#f2f5fa"},"error_y":{"color":"#f2f5fa"},"marker":{"line":{"color":"rgb(17,17,17)","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"bar"}],"carpet":[{"aaxis":{"endlinecolor":"#A2B1C6","gridcolor":"#506784","linecolor":"#506784","minorgridcolor":"#506784","startlinecolor":"#A2B1C6"},"baxis":{"endlinecolor":"#A2B1C6","gridcolor":"#506784","linecolor":"#506784","minorgridcolor":"#506784","startlinecolor":"#A2B1C6"},"type":"carpet"}],"choropleth":[{"colorbar":{"outlinewidth":0,"ticks":""},"type":"choropleth"}],"contourcarpet":[{"colorbar":{"outlinewidth":0,"ticks":""},"type":"contourcarpet"}],"contour":[{"colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"type":"contour"}],"heatmapgl":[{"colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"type":"heatmapgl"}],"heatmap":[{"colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"type":"heatmap"}],"histogram2dcontour":[{"colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"type":"histogram2dcontour"}],"histogram2d":[{"colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"type":"histogram2d"}],"histogram":[{"marker":{"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"histogram"}],"mesh3d":[{"colorbar":{"outlinewidth":0,"ticks":""},"type":"mesh3d"}],"parcoords":[{"line":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"parcoords"}],"pie":[{"automargin":true,"type":"pie"}],"scatter3d":[{"line":{"colorbar":{"outlinewidth":0,"ticks":""}},"marker":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"scatter3d"}],"scattercarpet":[{"marker":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"scattercarpet"}],"scattergeo":[{"marker":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"scattergeo"}],"scattergl":[{"marker":{"line":{"color":"#283442"}},"type":"scattergl"}],"scattermapbox":[{"marker":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"scattermapbox"}],"scatterpolargl":[{"marker":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"scatterpolargl"}],"scatterpolar":[{"marker":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"scatterpolar"}],"scatter":[{"marker":{"line":{"color":"#283442"}},"type":"scatter"}],"scatterternary":[{"marker":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"scatterternary"}],"surface":[{"colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"type":"surface"}],"table":[{"cells":{"fill":{"color":"#506784"},"line":{"color":"rgb(17,17,17)"}},"header":{"fill":{"color":"#2a3f5f"},"line":{"color":"rgb(17,17,17)"}},"type":"table"}]},"layout":{"annotationdefaults":{"arrowcolor":"#f2f5fa","arrowhead":0,"arrowwidth":1},"autotypenumbers":"strict","coloraxis":{"colorbar":{"outlinewidth":0,"ticks":""}},"colorscale":{"diverging":[[0,"#8e0152"],[0.1,"#c51b7d"],[0.2,"#de77ae"],[0.3,"#f1b6da"],[0.4,"#fde0ef"],[0.5,"#f7f7f7"],[0.6,"#e6f5d0"],[0.7,"#b8e186"],[0.8,"#7fbc41"],[0.9,"#4d9221"],[1,"#276419"]],"sequential":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"sequentialminus":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]},"colorway":["#636efa","#EF553B","#00cc96","#ab63fa","#FFA15A","#19d3f3","#FF6692","#B6E880","#FF97FF","#FECB52"],"font":{"color":"#f2f5fa"},"geo":{"bgcolor":"rgb(17,17,17)","lakecolor":"rgb(17,17,17)","landcolor":"rgb(17,17,17)","showlakes":true,"showland":true,"subunitcolor":"#506784"},"hoverlabel":{"align":"left"},"hovermode":"closest","mapbox":{"style":"dark"},"margin":{"b":0,"l":0,"r":0,"t":30},"paper_bgcolor":"rgb(17,17,17)","plot_bgcolor":"rgb(17,17,17)","polar":{"angularaxis":{"gridcolor":"#506784","linecolor":"#506784","ticks":""},"bgcolor":"rgb(17,17,17)","radialaxis":{"gridcolor":"#506784","linecolor":"#506784","ticks":""}},"scene":{"xaxis":{"backgroundcolor":"rgb(17,17,17)","gridcolor":"#506784","gridwidth":2,"linecolor":"#506784","showbackground":true,"ticks":"","zerolinecolor":"#C8D4E3"},"yaxis":{"backgroundcolor":"rgb(17,17,17)","gridcolor":"#506784","gridwidth":2,"linecolor":"#506784","showbackground":true,"ticks":"","zerolinecolor":"#C8D4E3"},"zaxis":{"backgroundcolor":"rgb(17,17,17)","gridcolor":"#506784","gridwidth":2,"linecolor":"#506784","showbackground":true,"ticks":"","zerolinecolor":"#C8D4E3"}},"shapedefaults":{"line":{"color":"#f2f5fa"}},"sliderdefaults":{"bgcolor":"#C8D4E3","bordercolor":"rgb(17,17,17)","borderwidth":1,"tickwidth":0},"ternary":{"aaxis":{"gridcolor":"#506784","linecolor":"#506784","ticks":""},"baxis":{"gridcolor":"#506784","linecolor":"#506784","ticks":""},"bgcolor":"rgb(17,17,17)","caxis":{"gridcolor":"#506784","linecolor":"#506784","ticks":""}},"title":{"x":0.05},"updatemenudefaults":{"bgcolor":"#506784","borderwidth":0},"xaxis":{"automargin":true,"gridcolor":"#283442","linecolor":"#506784","ticks":"","title":{"standoff":15},"zerolinecolor":"#283442","zerolinewidth":2},"yaxis":{"automargin":true,"gridcolor":"#283442","linecolor":"#506784","ticks":"","title":{"standoff":15},"zerolinecolor":"#283442","zerolinewidth":2}}},"margin":{"l":50,"r":50,"t":50,"b":50,"pad":10},"yaxis":{"title":{"text":"Score (%)"},"range":[0,105],"fixedrange":true},"xaxis":{"title":{"text":"Task"},"fixedrange":true},"legend":{"orientation":"h","yanchor":"bottom","y":1.05,"xanchor":"center","x":0.5},"modebar":{"remove":["autoScale2d","autoscale","editInChartStudio","editinchartstudio","hoverCompareCartesian","hovercompare","lasso","lasso2d","orbitRotation","orbitrotation","pan","pan2d","pan3d","reset","resetCameraDefault3d","resetCameraLastSave3d","resetGeo","resetSankeyGroup","resetScale2d","resetViewMap","resetViewMapbox","resetViews","resetcameradefault","resetcameralastsave","resetsankeygroup","resetscale","resetview","resetviews","select","select2d","sendDataToCloud","senddatatocloud","tableRotation","tablerotation","toImage","toggleHover","toggleSpikelines","togglehover","togglespikelines","toimage","zoom","zoom2d","zoom3d","zoomIn2d","zoomInGeo","zoomInMap","zoomInMapbox","zoomOut2d","zoomOutGeo","zoomOutMap","zoomOutMapbox","zoomin","zoomout"]},"barmode":"group","height":400,"showlegend":true},                        {"responsive": true}                    ).then(function(){
                            
var gd = document.getElementById('f57c9335-f6b7-416b-ba77-e8f2b57ff706');
var x = new MutationObserver(function (mutations, observer) {{
        var display = window.getComputedStyle(gd).display;
        if (!display || display === 'none') {{
            console.log([gd, 'removed!']);
            Plotly.purge(gd);
            observer.disconnect();
        }}
}});

// Listen for the removal of the full notebook cells
var notebookContainer = gd.closest('#notebook-container');
if (notebookContainer) {{
    x.observe(notebookContainer, {childList: true});
}}

// Listen for the clearing of the current output cell
var outputEl = gd.closest('.output');
if (outputEl) {{
    x.observe(outputEl, {childList: true});
}}

                        })                };                });            </script>        </div>
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-gpt-4o-mini-best-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Overall results for GPT-4o-mini.
</figcaption>
</figure>
</div>
</div>
<p>For <strong>GSM8K</strong> and <strong>Last Letter</strong>, structured and unstructured methods scored similarly. But for <strong>Shuffled Objects</strong>, unstructured outputs clearly surpassed a structured format.</p>
<p>The rest of the article will explain the approach I took to get these results.</p>
</section>
<section id="study-design" class="level2">
<h2 class="anchored" data-anchor-id="study-design">Study design</h2>
<p>Tam et al.&nbsp;evaluated structured and unstructured outputs across three reasoning tasks and six classification tasks. They used exact match to evaluate the reasoning tasks and accuracy to evaluate the classification tasks. They ran the experiments using the following models:</p>
<ol type="1">
<li><strong>Proprietary models</strong>: <em>gpt-3.5-turbo-0125</em>, <em>claude-3-haiku-20240307</em>, <em>gemini-1.5-flash</em>, and <em>gpt-4o-mini-2024-07-18</em>.</li>
<li><strong>Open-weight models</strong>: <em>LLaMA3-8B-Instruct</em>, and <em>Gemma-2-9B-Instruct</em>.</li>
</ol>
<p>.txt used a similar setup, but only focused on the reasoning tasks using <em>LLaMA3-8B-Instruct</em>. They did not include classification tasks because Tam et al.&nbsp;observed that structured outputs resulted in better performance in these tasks, so there was no need to test for it.</p>
<p>I also believe that structured outputs are better for classification tasks. So, I excluded them from my analysis as well.</p>
<p>The reasoning tasks were:</p>
<ol type="1">
<li><a href="https://huggingface.co/datasets/openai/gsm8k">GSM8K</a>: A dataset from of grade school math word problems.</li>
<li><a href="https://huggingface.co/datasets/ChilleD/LastLetterConcat">Last Letter</a>: A dataset of simple word puzzles that require concatening the last letters of a list of names.</li>
<li><a href="https://github.com/google/BIG-bench/tree/main/bigbench/benchmark_tasks/tracking_shuffled_objects">Shuffled Objects</a>: A dataset that requires reasoning about the state of a system after a sequence of shuffling operations.</li>
</ol>
<p>The rest of the article details the process of replicating .txt’s rebuttal on these tasks and evaluating the same tasks using <em>GPT-4o-mini</em>.</p>
</section>
<section id="replicating-.txts-rebuttal" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="replicating-.txts-rebuttal">Replicating .txt’s rebuttal</h2>
<p>.txt made it very easy to reproduce their results by sharing their <a href="https://github.com/dottxt-ai/demos/tree/main/say-what-you-mean">code on Github</a>. I just set up a machine at <a href="https://modal.com/">Modal</a> and ran the code.</p>
<p>While going through the code, I noticed some small issues with the prompts. So I decided to tweak them a bit.</p>
<p>Below are .txt’s original results compared to mine, after the prompt adjustments:</p>
<div class="cell page-columns page-full" data-execution_count="2">
<div id="tbl-llama-3-8b-instruct" class="cell quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-execution_count="2">
<figure class="quarto-float quarto-float-tbl figure page-columns page-full">
<div aria-describedby="tbl-llama-3-8b-instruct-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display" data-execution_count="35">
<style type="text/css">
</style>

<table id="T_83ac5" class="do-not-create-environment cell table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th id="T_83ac5_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">Task</th>
<th colspan="2" id="T_83ac5_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">.txt</th>
<th colspan="2" id="T_83ac5_level0_col3" class="col_heading level0 col3" data-quarto-table-cell-role="th">me, 3-shot</th>
</tr>
<tr class="even">
<th id="T_83ac5_level1_col0" class="col_heading level1 col0" data-quarto-table-cell-role="th"></th>
<th id="T_83ac5_level1_col1" class="col_heading level1 col1" data-quarto-table-cell-role="th">Unstructured</th>
<th id="T_83ac5_level1_col2" class="col_heading level1 col2" data-quarto-table-cell-role="th">Structured</th>
<th id="T_83ac5_level1_col3" class="col_heading level1 col3" data-quarto-table-cell-role="th">Unstructured</th>
<th id="T_83ac5_level1_col4" class="col_heading level1 col4" data-quarto-table-cell-role="th">Structured</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_83ac5_row0_col0" class="data row0 col0">GSM8K</td>
<td id="T_83ac5_row0_col1" class="data row0 col1">77.18</td>
<td id="T_83ac5_row0_col2" class="data row0 col2">77.79</td>
<td id="T_83ac5_row0_col3" class="data row0 col3">79.98</td>
<td id="T_83ac5_row0_col4" class="data row0 col4">79.45</td>
</tr>
<tr class="even">
<td id="T_83ac5_row1_col0" class="data row1 col0">Last Letter</td>
<td id="T_83ac5_row1_col1" class="data row1 col1">73.33</td>
<td id="T_83ac5_row1_col2" class="data row1 col2">77.33</td>
<td id="T_83ac5_row1_col3" class="data row1 col3">74.00</td>
<td id="T_83ac5_row1_col4" class="data row1 col4">78.00</td>
</tr>
<tr class="odd">
<td id="T_83ac5_row2_col0" class="data row2 col0">Shuffled Objects</td>
<td id="T_83ac5_row2_col1" class="data row2 col1">40.72</td>
<td id="T_83ac5_row2_col2" class="data row2 col2">44.35</td>
<td id="T_83ac5_row2_col3" class="data row2 col3">42.68</td>
<td id="T_83ac5_row2_col4" class="data row2 col4">43.90</td>
</tr>
</tbody>
</table>
</div>
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-tbl margin-caption" id="tbl-llama-3-8b-instruct-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: Results for LLaMA3-8B-Instruct.
</figcaption>
</figure>
</div>
</div>
<p>Except for <strong>Structured</strong> in the <strong>Shuffled Objects</strong> task, I was able to improve all the metrics. In <strong>GSM8K’s</strong> case, even reversing .txt’s result, with <strong>Unstructured</strong> outperforming <strong>Structured</strong> by a small margin.</p>
<p>But I don’t think this matters much.</p>
<p>Their conclusion still holds: structured outputs are either as good as or better than unstructured outputs, in the tasks considered.</p>
<p>I’ll explain the prompt changes I made below, so that you can judge for yourself if they make sense.</p>
<section id="formatting-few-shot-examples" class="level3">
<h3 class="anchored" data-anchor-id="formatting-few-shot-examples">Formatting few-shot examples</h3>
<p>In the <strong>GSM8K</strong> and <strong>Last Letter</strong> tasks, the few-shot prompt for both unstructured and structured used examples formatted as JSON objects and asked the LLM to produce the output in the same format, from which the answer was extracted.</p>
<p>That felt unfair. Even though you’re not formally constraining the LLM to produce a JSON object, you’re still asking it to format its response in somewhat unnatural way.</p>
<p>I adjusted the prompts to be as similar as possible for both unstructured and structured outputs while still trying to get the most out of each approach.</p>
<p>For example, in <strong>GSM8K</strong>, the unstructured prompt is:</p>
<blockquote class="blockquote">
<p>You are an expert in solving grade school math tasks. You will be presented with a grade-school math word problem and be asked to solve it. You will always respond in the following format:</p>
<p>&lt;str, reasoning about the answer&gt;</p>
<p>ANSWER: &lt;int, final answer&gt;</p>
<p>First, provide your step by step reasoning. Then, in ANSWER, provide an integer that corresponds to the correct answer to the question. Don’t include any other text in ANSWER.</p>
</blockquote>
<p>And the structured prompt is:</p>
<blockquote class="blockquote">
<p>You are an expert in solving grade school math tasks. You will be presented with a grade-school math word problem and be asked to solve it. You will always respond in the following format:</p>
<p>{“reasoning”: &lt;str, reasoning about the answer&gt;, “answer”: &lt;int, final answer&gt;}</p>
<p>First, provide your step by step reasoning in the “reasoning” field. Then, in the “answer” field, provide an integer that corresponds to the correct answer to the question. Don’t include any other text in the “answer” field.</p>
</blockquote>
<p>Finally, for all the tasks, I used a 3-shot prompt.</p>
</section>
<section id="clarifying-the-task" class="level3">
<h3 class="anchored" data-anchor-id="clarifying-the-task">Clarifying the task</h3>
<p>I also tried to make the prompts clearer. The description of the task in the original <strong>Last Letter</strong> prompt was:</p>
<blockquote class="blockquote">
<p>You are an expert in solving simple word puzzles using reasoning steps. Your specific task is going to be to take a list of 4 names and reason about the last letter of each ., then you will concatenate those letters into a word.</p>
</blockquote>
<p>I changed it to:</p>
<blockquote class="blockquote">
<p>You are an expert in solving word puzzles. Your specific task is going to be to take a list of 4 names, get the last letter of each and concatenate these letters into a word.</p>
</blockquote>
<p>The original prompt was reasonable, but I thought the new version was clearer. Through trial and error, I’ve learned that when working with LLMs, it’s best to be as clear and direct as possible.</p>
</section>
</section>
<section id="evaluating-gpt-4o-mini" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="evaluating-gpt-4o-mini">Evaluating GPT-4o-mini</h2>
<p>Using the same setup as before, I ran the same tasks with <code>gpt-4o-mini-2024-07-18</code>.</p>
<p>In the table below, you can see the results, including the original results from Tam et al.&nbsp;for comparison:</p>
<div class="cell page-columns page-full" data-execution_count="3">
<div id="tbl-gpt-4o-mini" class="cell quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-execution_count="3">
<figure class="quarto-float quarto-float-tbl figure page-columns page-full">
<div aria-describedby="tbl-gpt-4o-mini-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display" data-execution_count="36">
<style type="text/css">
</style>

<table id="T_769d4" class="do-not-create-environment cell table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th class="blank" data-quarto-table-cell-role="th">&nbsp;</th>
<th class="blank level0" data-quarto-table-cell-role="th">&nbsp;</th>
<th id="T_769d4_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">NL</th>
<th id="T_769d4_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">FRI</th>
<th id="T_769d4_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">JSON-Mode</th>
<th id="T_769d4_level0_col3" class="col_heading level0 col3" data-quarto-table-cell-role="th">JSON-Schema</th>
</tr>
<tr class="even">
<th class="index_name level0" data-quarto-table-cell-role="th">Task</th>
<th class="index_name level1" data-quarto-table-cell-role="th">Method</th>
<th class="blank col0" data-quarto-table-cell-role="th">&nbsp;</th>
<th class="blank col1" data-quarto-table-cell-role="th">&nbsp;</th>
<th class="blank col2" data-quarto-table-cell-role="th">&nbsp;</th>
<th class="blank col3" data-quarto-table-cell-role="th">&nbsp;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td rowspan="3" id="T_769d4_level0_row0" class="row_heading level0 row0" data-quarto-table-cell-role="th">GSM8K</td>
<td id="T_769d4_level1_row0" class="row_heading level1 row0" data-quarto-table-cell-role="th">Tam et al.</td>
<td id="T_769d4_row0_col0" class="data row0 col0">94.57</td>
<td id="T_769d4_row0_col1" class="data row0 col1">87.17</td>
<td id="T_769d4_row0_col2" class="data row0 col2">86.95</td>
<td id="T_769d4_row0_col3" class="data row0 col3">91.71</td>
</tr>
<tr class="even">
<td id="T_769d4_level1_row1" class="row_heading level1 row1" data-quarto-table-cell-role="th">Me, 0-shot</td>
<td id="T_769d4_row1_col0" class="data row1 col0">94.31</td>
<td id="T_769d4_row1_col1" class="data row1 col1">92.12</td>
<td id="T_769d4_row1_col2" class="data row1 col2">93.33</td>
<td id="T_769d4_row1_col3" class="data row1 col3">93.48</td>
</tr>
<tr class="odd">
<td id="T_769d4_level1_row2" class="row_heading level1 row2" data-quarto-table-cell-role="th">Me, 3-shot</td>
<td id="T_769d4_row2_col0" class="data row2 col0">93.86</td>
<td id="T_769d4_row2_col1" class="data row2 col1">92.72</td>
<td id="T_769d4_row2_col2" class="data row2 col2">93.25</td>
<td id="T_769d4_row2_col3" class="data row2 col3">92.95</td>
</tr>
<tr class="even">
<td rowspan="3" id="T_769d4_level0_row3" class="row_heading level0 row3" data-quarto-table-cell-role="th">Last Letter</td>
<td id="T_769d4_level1_row3" class="row_heading level1 row3" data-quarto-table-cell-role="th">Tam et al.</td>
<td id="T_769d4_row3_col0" class="data row3 col0">83.11</td>
<td id="T_769d4_row3_col1" class="data row3 col1">84.73</td>
<td id="T_769d4_row3_col2" class="data row3 col2">76.00</td>
<td id="T_769d4_row3_col3" class="data row3 col3">86.07</td>
</tr>
<tr class="odd">
<td id="T_769d4_level1_row4" class="row_heading level1 row4" data-quarto-table-cell-role="th">Me, 0-shot</td>
<td id="T_769d4_row4_col0" class="data row4 col0">87.33</td>
<td id="T_769d4_row4_col1" class="data row4 col1">88.00</td>
<td id="T_769d4_row4_col2" class="data row4 col2">90.00</td>
<td id="T_769d4_row4_col3" class="data row4 col3">87.33</td>
</tr>
<tr class="even">
<td id="T_769d4_level1_row5" class="row_heading level1 row5" data-quarto-table-cell-role="th">Me, 3-shot</td>
<td id="T_769d4_row5_col0" class="data row5 col0">92.00</td>
<td id="T_769d4_row5_col1" class="data row5 col1">94.67</td>
<td id="T_769d4_row5_col2" class="data row5 col2">90.00</td>
<td id="T_769d4_row5_col3" class="data row5 col3">93.33</td>
</tr>
<tr class="odd">
<td rowspan="3" id="T_769d4_level0_row6" class="row_heading level0 row6" data-quarto-table-cell-role="th">Shuffled Obj.</td>
<td id="T_769d4_level1_row6" class="row_heading level1 row6" data-quarto-table-cell-role="th">Tam et al.</td>
<td id="T_769d4_row6_col0" class="data row6 col0">82.85</td>
<td id="T_769d4_row6_col1" class="data row6 col1">81.46</td>
<td id="T_769d4_row6_col2" class="data row6 col2">76.43</td>
<td id="T_769d4_row6_col3" class="data row6 col3">81.77</td>
</tr>
<tr class="even">
<td id="T_769d4_level1_row7" class="row_heading level1 row7" data-quarto-table-cell-role="th">Me, 0-shot</td>
<td id="T_769d4_row7_col0" class="data row7 col0">95.12</td>
<td id="T_769d4_row7_col1" class="data row7 col1">79.67</td>
<td id="T_769d4_row7_col2" class="data row7 col2">81.71</td>
<td id="T_769d4_row7_col3" class="data row7 col3">89.84</td>
</tr>
<tr class="odd">
<td id="T_769d4_level1_row8" class="row_heading level1 row8" data-quarto-table-cell-role="th">Me, 3-shot</td>
<td id="T_769d4_row8_col0" class="data row8 col0">92.68</td>
<td id="T_769d4_row8_col1" class="data row8 col1">69.51</td>
<td id="T_769d4_row8_col2" class="data row8 col2">62.60</td>
<td id="T_769d4_row8_col3" class="data row8 col3">65.85</td>
</tr>
</tbody>
</table>
</div>
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-tbl margin-caption" id="tbl-gpt-4o-mini-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2: Results for GPT-4o-mini.
</figcaption>
</figure>
</div>
</div>
<p><em>NL</em> stands for “Natural Language”, which would correspond to the <em>Unstructured</em> method in the previous table.</p>
<p><em>FRI</em> stands for “Format Restricting Instructions”, which is a JSON generated through the OpenAI’s <a href="https://platform.openai.com/docs/guides/function-calling">function calling</a>. <em>JSON-Mode</em> is a JSON generated through the OpenAI’s <a href="https://platform.openai.com/docs/guides/structured-outputs#json-mode">JSON mode</a>. <em>JSON-Schema</em> is a JSON generated using <a href="https://openai.com/index/introducing-structured-outputs-in-the-api/">constrained decoding</a>.</p>
<p><em>JSON-Schema</em> is the closest equivalent to <strong>Structured</strong> as referenced in the previous table. But, in real-life applications, you don’t really care about how the output was generated. You just want to get the output in the format you want. So, for the sake of comparison, I will consider the three other methods equivalent to <strong>Structured</strong> as well.</p>
<section id="adjusting-for-proprietary-models" class="level3">
<h3 class="anchored" data-anchor-id="adjusting-for-proprietary-models">Adjusting for proprietary models</h3>
<p>In this case, I allowed for 3 retries in the case of parsing errors. I allowed for this because function calling had high error rates in the zero-shot prompting scenario.</p>
<p>These retries primarily affected <strong>FRI</strong> results. This might make the comparisons in <strong>Last Letter</strong> biased in favor of structured outputs (<strong>FRI</strong> was the best method in this case). But since <strong>JSON-Schema</strong> also outperformed <strong>NL</strong> in this case, this adjustment does not alter the overall conclusions. The other methods maintained error rates of &lt;0.5% in <strong>GSM8K</strong> and 0% in <strong>Last Letter</strong> and <strong>Shuffled Objects</strong>.</p>
<p>I used slightly different parsing functions for <strong>Unstructured</strong> and <strong>Structured</strong> outputs. The <strong>Unstructured</strong> parser was more lenient, removing commas and periods at the end of responses. But I believe this remains a fair comparison given that in the <strong>Structured</strong> cases you provide a JSON schema which is more informative.</p>
</section>
<section id="analyzing-the-results" class="level3">
<h3 class="anchored" data-anchor-id="analyzing-the-results">Analyzing the results</h3>
<p>Similar to what the .txt team found, after adjusting the prompts, the performance of structured outputs increases substantially compared to Tam et al.</p>
<p>Except for <em>NL</em> in <strong>GSM8k</strong> and <em>FRI</em> in <strong>Last Letter</strong>, I was able to improve all the metrics for both unstructured and structured outputs using a 0-shot prompt. For 3-shot prompts, I improved <strong>GSM8k</strong> and <strong>Last Letter</strong> across all methods, and <em>NL</em> in <strong>Shuffled Objects</strong>.</p>
<p>For <strong>GSM8k</strong> and <strong>Last Letter</strong>, the results were very similar between unstructured and structured outputs. There was a slight edge for unstructured outputs in <strong>GSM8k</strong> and for structured outputs in <strong>Last Letter</strong>. In these cases, it’s not clear that one approach definitively outperforms the other.</p>
<p>On the other hand, <strong>Shuffled Objects</strong> shows a clear advantage for unstructured outputs over structured outputs. This was unexpected, and even after tweaking the prompts, I couldn’t fully close the gap.</p>
<p>Despite the issues in Tam et al.’s study, their conclusion appears to hold. In this particular scenario, using a fairly popular model with reasonable prompts, there is a significant difference in performance between structured and unstructured outputs.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>In <strong>GSM8k</strong> and <strong>Last Letter</strong>, few-shot prompting generally decreased performance. This is in line with <a href="https://python.useinstructor.com/blog/2024/09/26/bad-schemas-could-break-your-llm-structured-outputs/?h=bad+sc#modes-and-models">other analyses</a>.</p>
</div>
</div>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>You’re here because you want to know whether to use structured or unstructured outputs. As a developer, I’m glad to say the answer is: <a href="https://www.reddit.com/r/orlybooks/comments/50meb5/it_depends/">it depends</a>.</p>
<p>I love using structured outputs in my daily work, because it makes it much easier to work with the output of LLMs. I always encourage <a href="https://iwanalabs.com/">clients</a> who aren’t using them yet to give them a try.</p>
<p>That said, until there’s stronger evidence showing that both approaches are equivalent, the best course of action is to test things for yourself. Run your own <a href="https://hamel.dev/blog/posts/evals/">evals</a> and make a decision based on data.</p>
<p>I expect that in most cases, structured outputs will have similar performance to unstructured outputs. But, if you blindly assume that structured outputs are always equal to or better than unstructured ones, you might be missing out on easy performance gains.</p>
<p>Take the example of <strong>Shuffled Objects</strong> with <em>GPT-4o-mini</em>. You could potentially reduce the gap between the two methods by continuing improving the prompts or by switching to a more powerful model. But the costs, in terms of time and effort, might be more than simply switching to unstructured outputs.</p>
<p>And this cuts both ways. Unstructured outputs aren’t inherently better or worse than structured ones. Again, the right choice depends on your task, the model, and your prompt engineering skills. Test both approaches, identify if there are differences, and choose what works best.</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Although, they’ve also <a href="https://blog.dottxt.co/performance-gsm8k.html">shared results</a> of other open-weight models using a different setup.↩︎</p></li>
</ol>
</section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2024,
  author = {Castillo, Dylan},
  title = {Structured Outputs Can Hurt the Performance of {LLMs}},
  date = {2024-12-08},
  url = {https://dylancastillo.co/posts/say-what-you-mean-sometimes.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2024" class="csl-entry quarto-appendix-citeas">
Castillo, Dylan. 2024. <span>“Structured Outputs Can Hurt the
Performance of LLMs.”</span> December 8, 2024. <a href="https://dylancastillo.co/posts/say-what-you-mean-sometimes.html">https://dylancastillo.co/posts/say-what-you-mean-sometimes.html</a>.
</div></div></section></div> ]]></description>
  <category>llm</category>
  <category>openai</category>
  <category>pydantic</category>
  <category>python</category>
  <guid>https://dylancastillo.co/posts/say-what-you-mean-sometimes.html</guid>
  <pubDate>Sun, 08 Dec 2024 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Transform any image to WebP from the terminal</title>
  <dc:creator>Dylan Castillo</dc:creator>
  <link>https://dylancastillo.co/til/transforming-images-to-webp.html</link>
  <description><![CDATA[ 




<p>I was annoyed by the file size of my photo in the <a href="https://dylanjcastillo.com/about/">About page</a>, because it was slowing down the page load.</p>
<p>Is it important? No.</p>
<p>Don’t I have better things to do on a Saturday afternoon? Yes.</p>
<p>But it’s like going to bed with the closet door open—you know there’s nothing in there, but you just can’t shake the feeling that the devil (or <a href="https://es.wikipedia.org/wiki/Diosdado_Cabello">Diosdado Cabello</a>) might jump out and kill you in your sleep unless you get up and shut it.</p>
<p>So I got o1-mini to write a simple script for me, and thought others might find it useful.</p>
<p>Here it is:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"> img2webp()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">{</span></span>
<span id="cb1-2"></span>
<span id="cb1-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check if the input file is provided or if help is requested</span></span>
<span id="cb1-4">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[[</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$#</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">-lt</span> 1 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">||</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$1</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--help"</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">||</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$1</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-h"</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]];</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">then</span></span>
<span id="cb1-5">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Usage: img2webp input_image [quality]"</span></span>
<span id="cb1-6">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"  input_image: Path to the input image file"</span></span>
<span id="cb1-7">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"  quality: Quality of the output WebP image (0-100, default is 80)"</span></span>
<span id="cb1-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-9">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fi</span></span>
<span id="cb1-10"></span>
<span id="cb1-11">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">local</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">input</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$1</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb1-12">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">local</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">quality</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:-</span>80<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Default quality is 80 if not specified</span></span>
<span id="cb1-13">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">local</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">output</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${input</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>.<span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">*</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">.webp"</span></span>
<span id="cb1-14"></span>
<span id="cb1-15">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert the image to WebP using ffmpeg</span></span>
<span id="cb1-16">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ffmpeg</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-i</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$input</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-qscale:v</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$quality</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$output</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb1-17"></span>
<span id="cb1-18">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check if the conversion was successful</span></span>
<span id="cb1-19">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[[</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$?</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">-eq</span> 0 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]];</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">then</span></span>
<span id="cb1-20">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Successfully converted '</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$input</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">' to '</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$output</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">' with quality </span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$quality</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">."</span></span>
<span id="cb1-21">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span></span>
<span id="cb1-22">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Failed to convert '</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$input</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">' to WebP."</span></span>
<span id="cb1-23">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-24">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fi</span></span>
<span id="cb1-25"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">}</span></span></code></pre></div>
<p>If you’re using MacOS, you first need to install <code>ffmpeg</code> using Homebrew:</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">brew</span> install ffmpeg</span></code></pre></div>
<p>Then you can add it to your <code>.zshrc</code> and use it by running <code>img2webp &lt;path_to_image&gt; [quality]</code>.</p>
<p>Just as reference, keeping the same quality, I decreased my profile picture from 234KB to 36KB by just changing from PNG to WebP.</p>
<p>Hope you found this useful.</p>



<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2024,
  author = {Castillo, Dylan},
  title = {Transform Any Image to {WebP} from the Terminal},
  date = {2024-11-23},
  url = {https://dylancastillo.co/til/transforming-images-to-webp.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2024" class="csl-entry quarto-appendix-citeas">
Castillo, Dylan. 2024. <span>“Transform Any Image to WebP from the
Terminal.”</span> November 23, 2024. <a href="https://dylancastillo.co/til/transforming-images-to-webp.html">https://dylancastillo.co/til/transforming-images-to-webp.html</a>.
</div></div></section></div> ]]></description>
  <category>til</category>
  <category>webp</category>
  <category>bash</category>
  <category>ffmpeg</category>
  <guid>https://dylancastillo.co/til/transforming-images-to-webp.html</guid>
  <pubDate>Sat, 23 Nov 2024 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Structured outputs: don’t put the cart before the horse</title>
  <dc:creator>Dylan Castillo</dc:creator>
  <link>https://dylancastillo.co/posts/llm-pydantic-order-matters.html</link>
  <description><![CDATA[ 




<p>Not long ago, you couldn’t reliably ask an LLM to provide you with a response using a specific format. Building tools that used LLM outputs was painful.</p>
<p>Then, through <a href="https://platform.openai.com/docs/guides/function-calling">function calling</a> and <a href="https://platform.openai.com/docs/guides/structured-outputs">structured outputs</a>, we could instruct LLMs to respond in specific formats<sup>1</sup>. So, extracting information from LLM outputs stopped being a problem.</p>
<p>But then I started noticing that structured outputs also had their <a href="https://arxiv.org/abs/2408.02442">own set</a> <a href="https://arxiv.org/abs/2403.06988">of problems</a>. Most importantly, the apparent rigidity of a Pydantic model can make you forget that underneath, you’re still dealing with an LLM. Setting up a response model for your API calls is not the same as setting up a response model for your LLM outputs.</p>
<p>For example, take the following question from the <a href="https://huggingface.co/datasets/livebench/reasoning">LiveBench</a> dataset:</p>
<blockquote class="blockquote">
<p>Suppose I have a physical, solid, equilateral triangle, and I make two cuts. The two cuts are from two parallel lines, and both cuts pass through the interior of the triangle. How many pieces are there after the cuts? Think step by step, and then put your answer in <strong>bold</strong> as a single integer (for example, <strong>0</strong>). If you don’t know, guess.</p>
</blockquote>
<p>Let’s say I write a simple system prompt and two Pydantic models to format the responses:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1">system_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb1-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You're a helpful assistant. You will help me answer a question."</span></span>
<span id="cb1-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">You will use this JSON schema for your response:"</span></span>
<span id="cb1-4">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{response_format}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb1-5">)</span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> ResponseFormatA(BaseModel):</span>
<span id="cb1-8">    reasoning: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb1-9">    answer: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb1-10"></span>
<span id="cb1-11"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> ResponseFormatB(BaseModel):</span>
<span id="cb1-12">    answer: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb1-13">    reasoning: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span></code></pre></div>
<p>Do you think that there will be a difference in performance between <code>ResponseFormatA</code> and <code>ResponseFormatB</code>? If so, which one do you think will perform better?</p>
<p>Not sure? Well, you’re in luck! Let’s run some experiments to find out.</p>
<section id="set-up-the-environment" class="level2">
<h2 class="anchored" data-anchor-id="set-up-the-environment">Set up the environment</h2>
<p>First, start by importing the necessary libraries:</p>
<div id="cell-5" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> asyncio</span>
<span id="cb2-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> json</span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> asyncio <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Semaphore</span>
<span id="cb2-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> datetime <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> datetime</span>
<span id="cb2-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pathlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Path</span>
<span id="cb2-6"></span>
<span id="cb2-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb2-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb2-9"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb2-10"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langsmith <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> traceable</span>
<span id="cb2-11"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langsmith.wrappers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> wrap_openai</span>
<span id="cb2-12"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> AsyncOpenAI</span>
<span id="cb2-13"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pydantic <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> BaseModel</span>
<span id="cb2-14"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> scipy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> stats</span>
<span id="cb2-15"></span>
<span id="cb2-16">np.random.seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb2-17"></span>
<span id="cb2-18">load_dotenv()</span>
<span id="cb2-19"></span>
<span id="cb2-20">client <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> wrap_openai(AsyncOpenAI())</span></code></pre></div>
</div>
<p>This will set up all the necessary infrastructure to run the experiments. I like using <a href="https://www.langchain.com/langsmith">LangSmith</a> to track <a href="https://smith.langchain.com/public/11545ceb-70d3-4213-9f05-89891586b809/r?runtab=0">runs</a>.</p>
<p>To run the experiment, you need some data. I ended up using a subset of the <a href="https://huggingface.co/datasets/livebench/reasoning">reasoning questions</a> from LiveBench. You can download it and save it in the <code>data</code> directory.</p>
<p>Then, you can read it into a pandas <code>DataFrame</code>:</p>
<div id="cell-7" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1">data_dir <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Path().absolute().parent <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"live_bench"</span></span>
<span id="cb3-2">reasoning_dir <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data_dir <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"reasoning"</span></span>
<span id="cb3-3">live_bench_json <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> reasoning_dir <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question.jsonl"</span></span>
<span id="cb3-4"></span>
<span id="cb3-5">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb3-6">    pd.read_json(live_bench_json, lines<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb3-7">    .query(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"livebench_release_date == '2024-07-26'"</span>)</span>
<span id="cb3-8">    .assign(</span>
<span id="cb3-9">        turns_str<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x: x.turns.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], </span>
<span id="cb3-10">        expects_integer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x: x.turns.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>.contains(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"integer"</span>, case<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb3-11">    )</span>
<span id="cb3-12">    .reset_index()</span>
<span id="cb3-13">    .rename(columns<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"index"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data_point_id"</span>})</span>
<span id="cb3-14">)</span></code></pre></div>
</div>
<p>Next, define the system prompt and the Pydantic models you’ll use to format the responses:</p>
<div id="cell-9" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1">system_prompt_template <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb4-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You're a helpful assistant. You will help me answer a question."</span></span>
<span id="cb4-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">You will use this JSON schema for your response:"</span></span>
<span id="cb4-4">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{response_format}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb4-5">)</span>
<span id="cb4-6"></span>
<span id="cb4-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> ResponseFormatA(BaseModel):</span>
<span id="cb4-8">    reasoning: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb4-9">    answer: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> </span>
<span id="cb4-10"></span>
<span id="cb4-11"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> ResponseFormatB(BaseModel):</span>
<span id="cb4-12">    answer: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> </span>
<span id="cb4-13">    reasoning: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span></code></pre></div>
</div>
<p>In the system prompt you send to the LLM, you’ll replace <code>{response_format}</code> with the JSON schema of the response format you want to use.</p>
<p>Then, let’s define a few helper functions to run the experiment:</p>
<div id="cell-11" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> validate_response(response_json, response_format):</span>
<span id="cb5-2">    response_dict <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> json.loads(response_json)</span>
<span id="cb5-3">    expected_keys <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(response_format.model_json_schema()[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"properties"</span>].keys())</span>
<span id="cb5-4">    actual_keys <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(response_dict.keys())</span>
<span id="cb5-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> actual_keys <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> expected_keys:</span>
<span id="cb5-6">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Response keys </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>actual_keys<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> do not match expected keys </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>expected_keys<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb5-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response_format.model_validate_json(response_json)</span>
<span id="cb5-8"></span>
<span id="cb5-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@traceable</span></span>
<span id="cb5-10"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> process_row(</span>
<span id="cb5-11">    row: pd.Series, </span>
<span id="cb5-12">    response_format: ResponseFormatA <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> ResponseFormatB, </span>
<span id="cb5-13">    semaphore: Semaphore</span>
<span id="cb5-14">) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> ResponseFormatA <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> ResponseFormatB:</span>
<span id="cb5-15">    system_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> system_prompt_template.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(</span>
<span id="cb5-16">        response_format<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>response_format.model_json_schema()</span>
<span id="cb5-17">    )</span>
<span id="cb5-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> semaphore:</span>
<span id="cb5-19">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>):</span>
<span id="cb5-20">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb5-21">                response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> client.chat.completions.create(</span>
<span id="cb5-22">                    model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4o"</span>, </span>
<span id="cb5-23">                    messages<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[</span>
<span id="cb5-24">                        {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"system"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: system_prompt},</span>
<span id="cb5-25">                        {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Question:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>row<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>turns_str<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>}</span>
<span id="cb5-26">                    ],</span>
<span id="cb5-27">                    response_format<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"json_object"</span>}</span>
<span id="cb5-28">                )</span>
<span id="cb5-29">                response_json <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> response.choices[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].message.content</span>
<span id="cb5-30">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> validate_response(response_json, response_format)</span>
<span id="cb5-31">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span>:</span>
<span id="cb5-32">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pass</span></span>
<span id="cb5-33">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Failed to generate a valid response"</span>)</span>
<span id="cb5-34"></span>
<span id="cb5-35"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@traceable</span></span>
<span id="cb5-36"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> main(df, response_format, concurrency: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>):</span>
<span id="cb5-37">    semaphore <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Semaphore(concurrency)</span>
<span id="cb5-38">    tasks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [process_row(row, response_format, semaphore) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _, row <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> df.iterrows()]</span>
<span id="cb5-39">    responses <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> asyncio.gather(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tasks)</span>
<span id="cb5-40"></span>
<span id="cb5-41">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> responses</span>
<span id="cb5-42"></span>
<span id="cb5-43"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> extract_answer(answer):</span>
<span id="cb5-44">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(answer).replace(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"**"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>).strip()</span></code></pre></div>
</div>
<p>In this code, <code>validate_response</code> is used to check if the response is valid (i.e.&nbsp;it matches the JSON schema in the same order). If it is, it returns the response. Otherwise, it raises an exception.</p>
<p><code>extract_answer</code> is used to remove ** from the answer if it exists in the response. Some of the questions in the LiveBench dataset included instructions to put the answer in bold, which is why we need to remove it.</p>
<p><code>process_row</code> is used to process a single row of the DataFrame. It sends the system prompt to the LLM and validates the response. It includes a simple retry mechanism in case the validation fails. Each run is tracked in LangSmith.</p>
<p>Finally, <code>main</code> is used to run the experiment. It runs the <code>process_row</code> function concurrently for each row in the DataFrame.</p>
</section>
<section id="running-the-experiment" class="level2">
<h2 class="anchored" data-anchor-id="running-the-experiment">Running the experiment</h2>
<p>Now, you can run the experiment using the two response formats:</p>
<div id="cell-14" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1">n_runs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb6-2">df_runs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb6-3"></span>
<span id="cb6-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> run <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n_runs):</span>
<span id="cb6-5">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Run </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>run <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">/</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>n_runs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb6-6">    df_copy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.copy()</span>
<span id="cb6-7">    </span>
<span id="cb6-8">    responses_A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> asyncio.run(main(df_copy, ResponseFormatA))</span>
<span id="cb6-9">    df_copy[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"raw_answer_A"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [r.answer <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> r <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> responses_A]</span>
<span id="cb6-10">    df_copy[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"response_A"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df_copy[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"raw_answer_A"</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>(extract_answer)</span>
<span id="cb6-11">    df_copy[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"is_correct_A"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (df_copy[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"response_A"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> df_copy[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ground_truth"</span>]).astype(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>)</span>
<span id="cb6-12">    </span>
<span id="cb6-13">    responses_B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> asyncio.run(main(df_copy, ResponseFormatB))</span>
<span id="cb6-14">    df_copy[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"raw_answer_B"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [r.answer <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> r <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> responses_B]</span>
<span id="cb6-15">    df_copy[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"response_B"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df_copy[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"raw_answer_B"</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>(extract_answer)</span>
<span id="cb6-16">    df_copy[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"is_correct_B"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (df_copy[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"response_B"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> df_copy[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ground_truth"</span>]).astype(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>)</span>
<span id="cb6-17">    </span>
<span id="cb6-18">    df_copy[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"run"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> run</span>
<span id="cb6-19">    df_run <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df_copy[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data_point_id"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ground_truth"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"is_correct_A"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"is_correct_B"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"run"</span>]]</span>
<span id="cb6-20">    </span>
<span id="cb6-21">    df_runs.append(df_run)</span></code></pre></div>
</div>
<p>We run the experiment multiple times with the same inputs to account for the randomness in the LLM’s responses. Ideally, we should run it more than three times, but I’m poor. So, we’ll just do it 3 times.</p>
<div id="cell-16" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1">df_all_runs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.concat(df_runs, ignore_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb7-2"></span>
<span id="cb7-3">n_bootstraps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span></span>
<span id="cb7-4">bootstrap_accuracies_A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb7-5">bootstrap_accuracies_B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb7-6"></span>
<span id="cb7-7">data_point_ids <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df_all_runs[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'data_point_id'</span>].unique()</span>
<span id="cb7-8">n_data_points <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(data_point_ids)</span>
<span id="cb7-9"></span>
<span id="cb7-10">grouped_A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df_all_runs.groupby(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'data_point_id'</span>)[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_correct_A'</span>]</span>
<span id="cb7-11">grouped_B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df_all_runs.groupby(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'data_point_id'</span>)[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_correct_B'</span>]</span>
<span id="cb7-12"></span>
<span id="cb7-13">df_correct_counts_A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> grouped_A.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()</span>
<span id="cb7-14">df_total_counts_A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> grouped_A.count()</span>
<span id="cb7-15">df_correct_counts_B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> grouped_B.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()</span>
<span id="cb7-16">df_total_counts_B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> grouped_B.count()</span>
<span id="cb7-17"></span>
<span id="cb7-18"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n_bootstraps):</span>
<span id="cb7-19">    sampled_ids <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.choice(data_point_ids, size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n_data_points, replace<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb7-20">    sampled_counts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.Series(sampled_ids).value_counts()</span>
<span id="cb7-21">    counts_index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sampled_counts.index</span>
<span id="cb7-22">    </span>
<span id="cb7-23">    total_correct_counts_A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (df_correct_counts_A.loc[counts_index] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> sampled_counts).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()</span>
<span id="cb7-24">    total_observations_A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (df_total_counts_A.loc[counts_index] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> sampled_counts).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()</span>
<span id="cb7-25">    mean_accuracy_A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> total_correct_counts_A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> total_observations_A</span>
<span id="cb7-26">    bootstrap_accuracies_A.append(mean_accuracy_A)</span>
<span id="cb7-27">    </span>
<span id="cb7-28">    total_correct_counts_B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (df_correct_counts_B.loc[counts_index] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> sampled_counts).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()</span>
<span id="cb7-29">    total_observations_B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (df_total_counts_B.loc[counts_index] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> sampled_counts).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()</span>
<span id="cb7-30">    mean_accuracy_B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> total_correct_counts_B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> total_observations_B</span>
<span id="cb7-31">    bootstrap_accuracies_B.append(mean_accuracy_B)</span>
<span id="cb7-32"></span>
<span id="cb7-33">ci_A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.percentile(bootstrap_accuracies_A, [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">97.5</span>])</span>
<span id="cb7-34">ci_B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.percentile(bootstrap_accuracies_B, [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">97.5</span>])</span>
<span id="cb7-35"></span>
<span id="cb7-36">mean_accuracy_A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df_all_runs[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_correct_A'</span>].mean()</span>
<span id="cb7-37">mean_accuracy_B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df_all_runs[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_correct_B'</span>].mean()</span>
<span id="cb7-38"></span>
<span id="cb7-39"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(</span>
<span id="cb7-40">    <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Response format A - Mean: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>mean_accuracy_A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">% CI: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ci_A[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">% - </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ci_A[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">%"</span></span>
<span id="cb7-41">)</span>
<span id="cb7-42"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(</span>
<span id="cb7-43">    <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Response format B - Mean: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>mean_accuracy_B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">% CI: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ci_B[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">% - </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ci_B[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">%"</span></span>
<span id="cb7-44">)</span></code></pre></div>
</div>
<p>Then, you can build bootstrap confidence intervals for the accuracies of the two response formats. Given that I’m asking the LLM the same question multiple times, I went with an approach called <a href="https://pmc.ncbi.nlm.nih.gov/articles/PMC5965657/">cluster bootstrapping</a>, which accounts for the fact that the data points are not independent.</p>
<p>It should take a few seconds to run. Once it’s done, you should see output like the following:</p>
<table class="table">
<thead>
<tr class="header">
<th>Response Format</th>
<th>Accuracy (95% CI)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>A</td>
<td>46.67% (35.33% – 58.00%)</td>
</tr>
<tr class="even">
<td>B</td>
<td>33.33% (22.67% – 44.67%)</td>
</tr>
</tbody>
</table>
<p>These results suggest that the order of the fields in the JSON schema does matter.</p>
<p>But if you’re still unsure, you can perform a t-test to see if the two response formats are statistically different:</p>
<div id="cell-18" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1">accuracies_A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df_all_runs.pivot(index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'data_point_id'</span>, columns<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'run'</span>, values<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_correct_A'</span>)</span>
<span id="cb8-2">accuracies_B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df_all_runs.pivot(index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'data_point_id'</span>, columns<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'run'</span>, values<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_correct_B'</span>)</span>
<span id="cb8-3"></span>
<span id="cb8-4">mean_accuracies_A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> accuracies_A.mean(axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb8-5">mean_accuracies_B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> accuracies_B.mean(axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb8-6"></span>
<span id="cb8-7">t_stat, p_value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stats.ttest_rel(mean_accuracies_A, mean_accuracies_B, alternative<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'greater'</span>)</span>
<span id="cb8-8"></span>
<span id="cb8-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"t-statistic: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>t_stat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, p-value: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>p_value<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
</div>
<p>I got a p-value &lt;0.01, meaning I can reject the null hypothesis that the two response formats are the same.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Based on the results of the experiment, we can safely say that <code>ResponseFormatA</code> is better than <code>ResponseFormatB</code>.</p>
<p>But why?</p>
<p>In this case, it’s simple.</p>
<p>These response formats are meant to help the LLM reason step by step to arrive at the answer. This is known as <a href="https://en.wikipedia.org/wiki/Chain_of_thought_reasoning">chain of thought reasoning</a>. However, for it to work, we need the LLM to first provide us with the reasoning of how it arrived at the answer and then the answer.</p>
<p>In <code>ResponseFormatA</code>, we defined our Pydantic model with the reasoning first and the answer second. This means that the LLM will give us the reasoning first, and then provide the answer. Which is exactly what we want.</p>
<p><code>ResponseFormatB</code> works in the opposite way. This means that the LLM will give us the answer first, and then provide the reasoning. So our chain of thought reasoning becomes a <a href="https://www.promptingguide.ai/techniques/zeroshot">zero-shot prompt</a>. In this case, the reasoning is a byproduct of the answer.</p>
<p>So, to summarize, when using structured outputs, don’t put the cart before the horse.</p>
<p>That’s all! Let me know if you have any questions in the comments.</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>I’m referring to OpenAI models here. Open weight models allowed this using <a href="https://github.com/ggerganov/llama.cpp/blob/master/grammars/README.md">grammars</a>.↩︎</p></li>
</ol>
</section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2024,
  author = {Castillo, Dylan},
  title = {Structured Outputs: Don’t Put the Cart Before the Horse},
  date = {2024-11-09},
  url = {https://dylancastillo.co/posts/llm-pydantic-order-matters.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2024" class="csl-entry quarto-appendix-citeas">
Castillo, Dylan. 2024. <span>“Structured Outputs: Don’t Put the Cart
Before the Horse.”</span> November 9, 2024. <a href="https://dylancastillo.co/posts/llm-pydantic-order-matters.html">https://dylancastillo.co/posts/llm-pydantic-order-matters.html</a>.
</div></div></section></div> ]]></description>
  <category>llm</category>
  <category>openai</category>
  <category>pydantic</category>
  <category>python</category>
  <guid>https://dylancastillo.co/posts/llm-pydantic-order-matters.html</guid>
  <pubDate>Sat, 09 Nov 2024 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Deploying a FastAPI app with Kamal, AWS ECR, and Github Actions</title>
  <dc:creator>Dylan Castillo</dc:creator>
  <link>https://dylancastillo.co/posts/deploy-a-fastapi-app-with-kamal-aws-ecr-and-github-actions.html</link>
  <description><![CDATA[ 




<p>These days I use Kamal to deploy my FastAPI (or Django) projects. Kamal is a simpler alternative to <a href="https://kubernetes.io/">Kubernetes</a> that you can use to deploy containerized apps to a <a href="https://en.wikipedia.org/wiki/Virtual_private_server">VPS</a>.</p>
<p>Once you get the hang of it, it’ll only take you a few minutes to set up a CI/CD pipeline that automatically deploys your app to production with each push to the <em>main</em> branch.</p>
<p>In this tutorial, I’ll walk you through the process of deploying a FastAPI app with Kamal, AWS ECR, and Github Actions.</p>
<p>You can find the code for this tutorial in <a href="https://github.com/dylanjcastillo/fastapi-kamal-aws-gha-example">this repository</a>.</p>
<section id="prerequisites" class="level2">
<h2 class="anchored" data-anchor-id="prerequisites">Prerequisites</h2>
<p>To make the most of this tutorial, you should:</p>
<ul>
<li>Have a <a href="https://fastapi.tiangolo.com/">FastAPI</a> app ready to deploy.</li>
<li>Have an <a href="https://aws.amazon.com/">AWS</a> account and its <a href="https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html">CLI</a> installed.</li>
<li>Be comfortable with <a href="https://www.docker.com/">Docker</a>.</li>
<li>Have a basic understanding of <a href="https://kamal-deploy.org/">Kamal</a>. You’ll need to install version <code>1.9.0</code> for this tutorial.</li>
<li>Have a basic understanding of <a href="https://docs.github.com/en/actions">Github Actions</a>.</li>
<li>Have a VPS with Ubuntu ready to host your app.</li>
</ul>
</section>
<section id="prepare-your-vps" class="level2">
<h2 class="anchored" data-anchor-id="prepare-your-vps">Prepare your VPS</h2>
<p>You’ll need to install docker, curl, git, and snapd on your VPS, and create a non-root user called <code>kamal</code> that can sudo. You should also set the <code>UID</code> and <code>GID</code> of the user to 1000.</p>
<p>If you’re using Hetzner, you can use my <a href="https://dylancastillo.co/posts/create-a-kamal-ready-vps-on-hetzner-using-terraform.html">terraform script</a> to prepare the VPS.</p>
<p>Otherwise, you can run these commands on your VPS’s terminal:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Install docker, curl, and git, and snapd</span></span>
<span id="cb1-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">apt-get</span> update</span>
<span id="cb1-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">apt-get</span> install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-y</span> docker.io curl git snapd</span>
<span id="cb1-4"></span>
<span id="cb1-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Start and enable the docker service</span></span>
<span id="cb1-6"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">systemctl</span> start docker</span>
<span id="cb1-7"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">systemctl</span> enable docker</span>
<span id="cb1-8"></span>
<span id="cb1-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a non-root user called kamal</span></span>
<span id="cb1-10"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">useradd</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-s</span> /bin/bash <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-u</span> 1000 kamal</span>
<span id="cb1-11"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">usermod</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-aG</span> sudo kamal</span>
<span id="cb1-12"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"kamal ALL=(ALL) NOPASSWD:ALL"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;</span> /etc/sudoers.d/kamal</span>
<span id="cb1-13"></span>
<span id="cb1-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add SSH key to login as kamal user</span></span>
<span id="cb1-15"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mkdir</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-p</span> /home/kamal/.ssh</span>
<span id="cb1-16"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;YOUR_PUBLIC_SSH_KEY&gt;"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;</span> /home/kamal/.ssh/authorized_keys <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># you need a public key to login as the kamal user</span></span>
<span id="cb1-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chmod</span> 700 /home/kamal/.ssh</span>
<span id="cb1-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chmod</span> 600 /home/kamal/.ssh/authorized_keys</span>
<span id="cb1-19"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chown</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-R</span> kamal:kamal /home/kamal/.ssh</span>
<span id="cb1-20"></span>
<span id="cb1-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Disable root login</span></span>
<span id="cb1-22"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sed</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-i</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'/PermitRootLogin/d'</span> /etc/ssh/sshd_config</span>
<span id="cb1-23"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PermitRootLogin no"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;</span> /etc/ssh/sshd_config</span>
<span id="cb1-24"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">systemctl</span> restart sshd</span>
<span id="cb1-25"></span>
<span id="cb1-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add the kamal user to the docker group</span></span>
<span id="cb1-27"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">usermod</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-aG</span> docker kamal</span>
<span id="cb1-28"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">docker</span> network create <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--driver</span> bridge kamal_network</span>
<span id="cb1-29"></span>
<span id="cb1-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a folder for the Let's Encrypt ACME JSON</span></span>
<span id="cb1-31"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mkdir</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-p</span> /letsencrypt <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">touch</span> /letsencrypt/acme.json <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chmod</span> 600 /letsencrypt/acme.json</span>
<span id="cb1-32"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chown</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-R</span> kamal:kamal /letsencrypt</span>
<span id="cb1-33"></span>
<span id="cb1-34"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">reboot</span></span></code></pre></div>
<p>To run these commands, you need to login as root. This assumes that there isn’t already a non-root user with <code>UID</code> 1000. Otherwise, you’ll have to adjust the commands accordingly.</p>
<p>Also, if you don’t have a public SSH key for the “Add SSH key” step, you can generate one with the following command:</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ssh-keygen</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-t</span> ed25519 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-C</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"your-email@example.com"</span></span></code></pre></div>
<p>These commands will:</p>
<ol type="1">
<li>Install docker, curl, and git</li>
<li>Start and enable the docker service</li>
<li>Create a non-root user called kamal</li>
<li>Disable root login</li>
<li>Add the kamal user to the docker group (this allows the user to run docker without needing to use <code>sudo</code>)</li>
<li>Create a Docker bridge network for Traefik</li>
<li>Create a folder for the Let’s Encrypt ACME JSON file</li>
<li>Make the Let’s Encrypt ACME JSON folder writable by the kamal user</li>
<li>Restart the server</li>
</ol>
<p>Finally, configure the SSH key in your local <code>.ssh/config</code> file so you can login as the kamal user without using the root account.</p>
<pre><code>Host kamal
  HostName &lt;YOUR_VPS_IP&gt;
  User kamal
  IdentityFile ~/.ssh/&lt;YOUR_PRIVATE_SSH_KEY&gt;</code></pre>
</section>
<section id="create-a-dockerfile-for-your-fastapi-app" class="level2">
<h2 class="anchored" data-anchor-id="create-a-dockerfile-for-your-fastapi-app">Create a Dockerfile for your FastAPI app</h2>
<p>Kamal works with containerized apps, so you’ll need to have a Dockerfile. I also recommend using an <code>entrypoint.sh</code> script to run the application, because that also allows you to run commands in the container.</p>
<section id="dockerfile" class="level3">
<h3 class="anchored" data-anchor-id="dockerfile">Dockerfile</h3>
<p>Here’s the Dockerfile I’m using for my projects. You can use this as a template and adjust it to your needs.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Dockerfile</strong></pre>
</div>
<div class="sourceCode" id="cb4" data-filename="Dockerfile" style="background: #f1f3f5;"><pre class="sourceCode numberSource dockerfile number-lines code-with-copy"><code class="sourceCode dockerfile"><span id="cb4-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">FROM</span> python:3.10-slim <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AS</span> base</span>
<span id="cb4-2"></span>
<span id="cb4-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ENV</span> POETRY_HOME=/opt/poetry</span>
<span id="cb4-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ENV</span> POETRY_VERSION=1.8.3</span>
<span id="cb4-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ENV</span> PATH=${POETRY_HOME}/bin:${PATH}</span>
<span id="cb4-6"></span>
<span id="cb4-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">RUN</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">apt-get</span> update <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb4-8">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">apt-get</span> install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--no-install-recommends</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-y</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb4-9">    curl <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb4-10">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">apt-get</span> clean <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb4-11">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rm</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-rf</span> /var/lib/apt/lists/<span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb4-12"></span>
<span id="cb4-13"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">RUN</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">curl</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-sSL</span> https://install.python-poetry.org <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">|</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python3</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">poetry</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--version</span></span>
<span id="cb4-14"></span>
<span id="cb4-15"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">FROM</span> base <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AS</span> builder</span>
<span id="cb4-16"></span>
<span id="cb4-17"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">WORKDIR</span> /app</span>
<span id="cb4-18"></span>
<span id="cb4-19"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">COPY</span> poetry.lock pyproject.toml ./</span>
<span id="cb4-20"></span>
<span id="cb4-21"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">RUN</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">poetry</span> config virtualenvs.in-project true <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb4-22">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">poetry</span> install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--only</span> main <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--no-interaction</span></span>
<span id="cb4-23"></span>
<span id="cb4-24"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">FROM</span> base <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AS</span> runner</span>
<span id="cb4-25"></span>
<span id="cb4-26"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">WORKDIR</span> /app</span>
<span id="cb4-27"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">COPY</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--from=builder</span> /app/.venv/ /app/.venv/</span>
<span id="cb4-28"></span>
<span id="cb4-29"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">COPY</span> . /app</span>
<span id="cb4-30"></span>
<span id="cb4-31"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">RUN</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chmod</span> +x /app/entrypoint.sh</span>
<span id="cb4-32"></span>
<span id="cb4-33"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">FROM</span> runner <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AS</span> production</span>
<span id="cb4-34"></span>
<span id="cb4-35"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">EXPOSE</span> 8000</span>
<span id="cb4-36"></span>
<span id="cb4-37"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ARG</span> user=kamal</span>
<span id="cb4-38"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ARG</span> group=kamal</span>
<span id="cb4-39"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ARG</span> uid=1000</span>
<span id="cb4-40"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ARG</span> gid=1000</span>
<span id="cb4-41"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">RUN</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">groupadd</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-g</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${gid}</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${group}</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb4-42">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">useradd</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-u</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${uid}</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-g</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${group}</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-s</span> /bin/sh <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${user}</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb4-43">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chown</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-R</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${uid}</span>:<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${gid}</span> /app</span>
<span id="cb4-44"></span>
<span id="cb4-45"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">USER</span> ${uid}:${gid}</span>
<span id="cb4-46"></span>
<span id="cb4-47"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">WORKDIR</span> /app</span>
<span id="cb4-48"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">CMD</span> [ <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/app/entrypoint.sh"</span> , <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"app"</span>]</span></code></pre></div>
</div>
<p>This multi-stage Dockerfile does the following:</p>
<ol type="1">
<li>Installs poetry and sets up the virtual environment</li>
<li>Creates the user <code>kamal</code> with the <code>UID</code> and <code>GID</code> 1000 and runs the application with that user.</li>
<li>Exposes port 8000 and runs the application by executing the <code>entrypoint.sh</code> script. Kamal automatically detects that is the port the app runs on and <a href="https://github.com/basecamp/kamal/issues/58">will use that to set up the reverse proxy</a>.</li>
</ol>
<p>Feel free to adjust this Dockerfile to your needs.</p>
</section>
<section id="entrypoint.sh-script" class="level3">
<h3 class="anchored" data-anchor-id="entrypoint.sh-script"><code>entrypoint.sh</code> script</h3>
<p>I use an <code>entrypoint.sh</code> script to run the application because that makes it easier to collect static files, run migrations when the container starts, and also running commands in the container.</p>
<p>Here’s an example of a simple <code>entrypoint.sh</code> script:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>entrypoint.sh</strong></pre>
</div>
<div class="sourceCode" id="cb5" data-filename="entrypoint.sh" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#!/bin/sh</span></span>
<span id="cb5-2"></span>
<span id="cb5-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-e</span></span>
<span id="cb5-4"></span>
<span id="cb5-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">[</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$1</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"app"</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">]</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">;</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">then</span></span>
<span id="cb5-6">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Collecting static files"</span></span>
<span id="cb5-7">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">exec</span> poetry run gunicorn <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-c</span> gunicorn.conf.py</span>
<span id="cb5-8"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span></span>
<span id="cb5-9">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">exec</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$@</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb5-10"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fi</span></span></code></pre></div>
</div>
<p>This script starts the <code>gunicorn</code> server with <code>uvicorn</code> workers and some sensible defaults. It also allows you to pass other arguments to the script, which is useful if you want to run other commands in the container. You can add or remove commands to the script as needed.</p>
</section>
</section>
<section id="configure-an-ecr-registry-in-aws" class="level2">
<h2 class="anchored" data-anchor-id="configure-an-ecr-registry-in-aws">Configure an ECR registry in AWS</h2>
<p>Next, you’ll need a place to push and pull your Docker images. I use <a href="https://aws.amazon.com/ecr/">AWS ECR</a>, so that’s what I’ll show you how to do here. Kamal also supports <a href="https://kamal-deploy.org/docs/configuration/docker-registry/">other registries</a>.</p>
<p>Log in to the <a href="https://aws.amazon.com/console/">AWS Management Console</a> and go to Amazon ECR. Click on <code>Create repository</code> and set a name for your repository.</p>
<p>Then, create a new IAM user in your AWS account by going to Services &gt; IAM &gt; Users &gt; Add user.</p>
<p>During the process you’ll have to assign a permissions to the user. You can create a new policy with the following content and attach it to the user:</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource json number-lines code-with-copy"><code class="sourceCode json"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-2">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"Version"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2012-10-17"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-3">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"Statement"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb6-4">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-5">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"Sid"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ListImagesInRepository"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-6">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"Effect"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Allow"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-7">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"Action"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ecr:ListImages"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-8">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"Resource"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb6-9">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"arn:aws:ecr:&lt;REGION&gt;:&lt;ACCOUNT_ID&gt;:repository/&lt;REPOSITORY_NAME&gt;"</span></span>
<span id="cb6-10">      <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb6-11">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-12">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-13">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"Sid"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GetAuthorizationToken"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-14">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"Effect"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Allow"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-15">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"Action"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ecr:GetAuthorizationToken"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-16">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"Resource"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"*"</span></span>
<span id="cb6-17">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-18">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-19">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"Sid"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ManageRepositoryContents"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-20">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"Effect"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Allow"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-21">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"Action"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb6-22">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ecr:BatchCheckLayerAvailability"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-23">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ecr:GetDownloadUrlForLayer"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-24">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ecr:GetRepositoryPolicy"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-25">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ecr:DescribeRepositories"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-26">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ecr:ListImages"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-27">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ecr:DescribeImages"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-28">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ecr:BatchGetImage"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-29">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ecr:InitiateLayerUpload"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-30">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ecr:UploadLayerPart"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-31">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ecr:CompleteLayerUpload"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-32">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ecr:PutImage"</span></span>
<span id="cb6-33">      <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-34">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"Resource"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb6-35">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"arn:aws:ecr:&lt;REGION&gt;:&lt;ACCOUNT_ID&gt;:repository/&lt;REPOSITORY_NAME&gt;"</span></span>
<span id="cb6-36">      <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb6-37">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb6-38">  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb6-39"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>This policy enables users to list, access, and manage the ECR repository they have previously created, as well as obtain an authorization token necessary for pushing and pulling images. You must replace <code>&lt;REGION&gt;</code>, <code>&lt;ACCOUNT_ID&gt;</code>, and <code>&lt;REPOSITORY_NAME&gt;</code> with the specific details of your own repository.</p>
<p>Then, select the user you created and navigate to Security credentials &gt; Access keys &gt; Create access key. Download the generated CSV file and store it in a secure location.</p>
<p>The GitHub Actions workflow will use these credentials for pushing and pulling images from the ECR registry.</p>
</section>
<section id="set-up-kamal-in-your-project" class="level2">
<h2 class="anchored" data-anchor-id="set-up-kamal-in-your-project">Set up Kamal in your project</h2>
<p>Open your FastAPI project in your favorite code editor. Create a folder called <code>deploy</code> in the root directory. Then go into the folder and initialize Kamal:</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">kamal</span> init</span></code></pre></div>
<p>This will create two folders (<code>.kamal/</code> and <code>config/</code>) and an <code>.env</code> file. Inside <code>config/</code>, you’ll find a <code>deploy.yml</code> file. This is where you’ll provide the instructions for Kamal to build and deploy your app.</p>
<p>You can use the following <code>deploy.yml</code> file as a template for your FastAPI app:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>deploy.yml</strong></pre>
</div>
<div class="sourceCode" id="cb8" data-filename="deploy.yml" style="background: #f1f3f5;"><pre class="sourceCode numberSource yml number-lines code-with-copy"><code class="sourceCode yaml"><span id="cb8-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">service</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> example</span></span>
<span id="cb8-2"></span>
<span id="cb8-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">image</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> example</span></span>
<span id="cb8-4"></span>
<span id="cb8-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ssh</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb8-6"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">user</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> kamal</span></span>
<span id="cb8-7"></span>
<span id="cb8-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">env</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb8-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">secret</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb8-10"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> FASTAPI_ENV</span></span>
<span id="cb8-11"></span>
<span id="cb8-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">traefik</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb8-13"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">options</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb8-14"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">publish</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb8-15"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"443:443"</span></span>
<span id="cb8-16"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">volume</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb8-17"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/letsencrypt/:/letsencrypt/"</span></span>
<span id="cb8-18"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">memory</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> 500m</span></span>
<span id="cb8-19"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">network</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> private_network</span></span>
<span id="cb8-20"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">args</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb8-21"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">entryPoints.web.address</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">":80"</span></span>
<span id="cb8-22"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">entryPoints.websecure.address</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">":443"</span></span>
<span id="cb8-23"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">entryPoints.web.http.redirections.entryPoint.to</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> websecure</span></span>
<span id="cb8-24"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">entryPoints.web.http.redirections.entryPoint.scheme</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> https</span></span>
<span id="cb8-25"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">entryPoints.web.http.redirections.entrypoint.permanent</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">true</span></span>
<span id="cb8-26"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">certificatesResolvers.letsencrypt.acme.email</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> &lt;YOUR_EMAIL&gt;"</span></span>
<span id="cb8-27"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">certificatesResolvers.letsencrypt.acme.storage</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/letsencrypt/acme.json"</span></span>
<span id="cb8-28"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">certificatesResolvers.letsencrypt.acme.httpchallenge</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">true</span></span>
<span id="cb8-29"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">certificatesResolvers.letsencrypt.acme.httpchallenge.entrypoint</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> web</span></span>
<span id="cb8-30"></span>
<span id="cb8-31"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">servers</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb8-32"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">web</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb8-33"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hosts</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb8-34"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">128.140.0.209</span></span>
<span id="cb8-35"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">healthcheck</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb8-36"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">port</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8000</span></span>
<span id="cb8-37"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">interval</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> 5s</span></span>
<span id="cb8-38"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">options</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb8-39"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">network</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> private_network</span></span>
<span id="cb8-40"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labels</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb8-41"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">traefik.http.routers.app.tls</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">true</span></span>
<span id="cb8-42"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">traefik.http.routers.app.entrypoints</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> websecure</span></span>
<span id="cb8-43"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">traefik.http.routers.app.rule</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Host(`&lt;YOUR_DOMAIN&gt;`)</span></span>
<span id="cb8-44"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">traefik.http.routers.app.tls.certresolver</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> letsencrypt</span></span>
<span id="cb8-45"></span>
<span id="cb8-46"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">registry</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb8-47"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">server</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> &lt;account_id&gt;.dkr.ecr.&lt;region&gt;.amazonaws.com</span></span>
<span id="cb8-48"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">username</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> AWS</span></span>
<span id="cb8-49"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">password</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb8-50"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> KAMAL_REGISTRY_PASSWORD</span></span>
<span id="cb8-51"></span>
<span id="cb8-52"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">builder</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb8-53"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dockerfile</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../Dockerfile"</span></span>
<span id="cb8-54"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">context</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../"</span></span>
<span id="cb8-55"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">multiarch</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">false</span></span>
<span id="cb8-56"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cache</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb8-57"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">type</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> gha</span></span></code></pre></div>
</div>
<p>This will set up your app and a reverse proxy using Traefik (with automatic SSL certificates using Let’s Encrypt). Remember to replace the placeholders with your own values. It will also do a healthcheck on <code>/up</code> on port 8000.</p>
<section id="test-the-configuration-locally" class="level3">
<h3 class="anchored" data-anchor-id="test-the-configuration-locally">Test the configuration locally</h3>
<p>To test it locally, first, you must define the required environment variables in <code>.env</code>, such as keys for AI services, email providers, etc.</p>
<p>You’ll also need to get a temporary password to authenticate into the ECR registry. You can get this password by running the following command from your terminal:</p>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">aws</span> ecr get-login-password <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--region</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>YOUR_REGION<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span></code></pre></div>
<p>You should copy the output of this command and paste it in the <code>KAMAL_REGISTRY_PASSWORD</code> field in the <code>.env</code> file.</p>
<p>Then, run the following command to deploy your application to your VPS:</p>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">kamal</span> env push</span>
<span id="cb10-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">kamal</span> deploy</span></code></pre></div>
<p>The first command will push the environment variables to the VPS. The second command will build the Docker image, push it to the ECR registry, and deploy it to your VPS.</p>
<p>After a few minutes, your app should be live at <code>https://&lt;YOUR_DOMAIN&gt;</code>.</p>
<p>If you see any errors, you can:</p>
<ol type="1">
<li>Run <code>kamal app logs</code> to see the logs of the app.</li>
<li>Open a terminal in the container by running <code>kamal app exec -it bash</code>.</li>
</ol>
<p>This is how I usually debug the app.</p>
</section>
</section>
<section id="automate-the-deployment-with-github-actions" class="level2">
<h2 class="anchored" data-anchor-id="automate-the-deployment-with-github-actions">Automate the deployment with Github Actions</h2>
<p>Now that you have a working deployment process in your local environment, you can set up your CI/CD pipeline using GitHub Actions.</p>
<p>Create a new file in the <code>.github/workflows</code> folder called <code>deploy.yml</code> and add the following code:</p>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource yml number-lines code-with-copy"><code class="sourceCode yaml"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Deploy FastAPI app to VPS</span></span>
<span id="cb11-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">concurrency</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb11-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> ${{ github.workflow }}-${{ github.ref }}</span></span>
<span id="cb11-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cancel-in-progress</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">true</span></span>
<span id="cb11-5"></span>
<span id="cb11-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">on</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb11-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">push</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb11-8"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">branches</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"main"</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]</span></span>
<span id="cb11-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">workflow_dispatch</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb11-10"></span>
<span id="cb11-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">jobs</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb11-12"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">deploy</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb11-13"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">runs-on</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> ubuntu-latest</span></span>
<span id="cb11-14"></span>
<span id="cb11-15"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">steps</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb11-16"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Checkout</span></span>
<span id="cb11-17"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">uses</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> actions/checkout@v3</span></span>
<span id="cb11-18"></span>
<span id="cb11-19"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">uses</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> webfactory/ssh-agent@v0.7.0</span></span>
<span id="cb11-20"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">with</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb11-21"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ssh-private-key</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> ${{ secrets.VPS_SSH_PRIVATE_KEY }}</span></span>
<span id="cb11-22"></span>
<span id="cb11-23"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Set up Ruby and install kamal</span></span>
<span id="cb11-24"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">uses</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> ruby/setup-ruby@v1</span></span>
<span id="cb11-25"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">with</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb11-26"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ruby-version</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.2.2</span></span>
<span id="cb11-27"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">run</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> gem install kamal -v 1.9.0</span></span>
<span id="cb11-28"></span>
<span id="cb11-29"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Configure AWS credentials</span></span>
<span id="cb11-30"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">uses</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> aws-actions/configure-aws-credentials@v4</span></span>
<span id="cb11-31"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">with</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb11-32"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aws-access-key-id</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> ${{ secrets.AWS_ACCESS_KEY_ID_ECR }}</span></span>
<span id="cb11-33"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aws-secret-access-key</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> ${{ secrets.AWS_SECRET_ACCESS_KEY_ECR }}</span></span>
<span id="cb11-34"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aws-region</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> us-east-1</span></span>
<span id="cb11-35"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mask-aws-account-id</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">false</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> # otherwise the mask will hide your account ID and cause errors in the deployment</span></span>
<span id="cb11-36"></span>
<span id="cb11-37"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Login to AWS ECR</span></span>
<span id="cb11-38"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">id</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> login-ecr</span></span>
<span id="cb11-39"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">uses</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> aws-actions/amazon-ecr-login@v2</span></span>
<span id="cb11-40"></span>
<span id="cb11-41"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Set up Docker Buildx for cache</span></span>
<span id="cb11-42"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">uses</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> docker/setup-buildx-action@v3</span></span>
<span id="cb11-43"></span>
<span id="cb11-44"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Expose GitHub Runtime for cache</span></span>
<span id="cb11-45"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">uses</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> crazy-max/ghaction-github-runtime@v3</span></span>
<span id="cb11-46"></span>
<span id="cb11-47"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Create .env file</span></span>
<span id="cb11-48"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">        run</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">: </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">|</span></span>
<span id="cb11-49">          cd &lt;YOUR_PROJECT_ROOT&gt;/deploy</span>
<span id="cb11-50">          touch .env</span>
<span id="cb11-51">          echo KAMAL_REGISTRY_PASSWORD="${{ steps.login-ecr.outputs.docker_password_&lt;YOUR_ACCOUNT_ID&gt;_dkr_ecr_&lt;YOUR_REGION&gt;_amazonaws_com }}" &gt;&gt; .env</span>
<span id="cb11-52">          # if you have other secrets, add them here</span>
<span id="cb11-53">          cat .env</span>
<span id="cb11-54"></span>
<span id="cb11-55"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Kamal Deploy</span></span>
<span id="cb11-56"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">id</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> kamal-deploy</span></span>
<span id="cb11-57"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">        run</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">: </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">|</span></span>
<span id="cb11-58">          cd &lt;YOUR_PROJECT_ROOT&gt;/deploy</span>
<span id="cb11-59">          kamal lock release</span>
<span id="cb11-60">          kamal env push</span>
<span id="cb11-61">          kamal deploy</span></code></pre></div>
<p>This workflow will:</p>
<ol type="1">
<li>Checkout the code</li>
<li>Set up the Ruby environment and install Kamal</li>
<li>Configure the AWS credentials</li>
<li>Login to the AWS ECR registry</li>
<li>Set up Docker Buildx for cache</li>
<li>Expose GitHub Runtime for cache</li>
<li>Create the <code>.env</code> file</li>
<li>Run Kamal deploy</li>
</ol>
<p>It will run everytime you make a push to the main branch or by manually triggering the workflow. It’ll cancel any in-progress runs to avoid conflicts.</p>
<p>Also, before you push your code to the repository, you’ll need to add the following secrets to the repository:</p>
<ul>
<li><code>VPS_SSH_PRIVATE_KEY</code>: The private key to connect to your VPS</li>
<li><code>AWS_ACCESS_KEY_ID_ECR</code>: The access key ID for the AWS ECR registry</li>
<li><code>AWS_SECRET_ACCESS_KEY_ECR</code>: The secret access key for the AWS ECR registry</li>
</ul>
<p>Finally, to speed up the deployment, add these options to the <code>builder</code> section of the <code>deploy.yml</code> file:</p>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource yml number-lines code-with-copy"><code class="sourceCode yaml"><span id="cb12-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">builder</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb12-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dockerfile</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../Dockerfile"</span></span>
<span id="cb12-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">context</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../"</span></span>
<span id="cb12-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">multiarch</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">false</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> # new</span></span>
<span id="cb12-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cache</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> # new</span></span>
<span id="cb12-6"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">type</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> gha</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> # new</span></span></code></pre></div>
<p>This will enable the Docker Buildx cache for the build process in Github Actions. You can set <code>multiarch</code> to <code>false</code> if your CI pipeline shares the same architecture as your VPS, which was the case for me.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>You now have a fully automated deployment pipeline for your FastAPI app. A push to the <code>main</code> branch will trigger the workflow, that will build the Docker image, push it to the ECR registry, and deploy it to your VPS.</p>
<p>Break free from the tyranny of manual deployments and expensive cloud services. Sleep like a baby and let Kamal handle your deployments.</p>
<p>If you have any questions or feedback, please feel free to leave a comment below.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2024,
  author = {Castillo, Dylan},
  title = {Deploying a {FastAPI} App with {Kamal,} {AWS} {ECR,} and
    {Github} {Actions}},
  date = {2024-09-21},
  url = {https://dylancastillo.co/posts/deploy-a-fastapi-app-with-kamal-aws-ecr-and-github-actions.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2024" class="csl-entry quarto-appendix-citeas">
Castillo, Dylan. 2024. <span>“Deploying a FastAPI App with Kamal, AWS
ECR, and Github Actions.”</span> September 21, 2024. <a href="https://dylancastillo.co/posts/deploy-a-fastapi-app-with-kamal-aws-ecr-and-github-actions.html">https://dylancastillo.co/posts/deploy-a-fastapi-app-with-kamal-aws-ecr-and-github-actions.html</a>.
</div></div></section></div> ]]></description>
  <category>fastapi</category>
  <category>kamal</category>
  <category>aws</category>
  <guid>https://dylancastillo.co/posts/deploy-a-fastapi-app-with-kamal-aws-ecr-and-github-actions.html</guid>
  <pubDate>Sat, 21 Sep 2024 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Deploying a Django app with Kamal 2, AWS ECR, and Github Actions</title>
  <dc:creator>Dylan Castillo</dc:creator>
  <link>https://dylancastillo.co/posts/deploy-a-django-app-with-kamal-aws-ecr-and-github-actions.html</link>
  <description><![CDATA[ 




<p>Every other night, my wife wakes me up to tell me I’m muttering unintelligible phrases in my sleep: “restart nginx,” “the SSL certificate failed to validate,” or “how do I exit vim?”</p>
<p>I still suffer from PTSD from the days of manually deploying web apps. But since switching to Kamal, I’ve been sleeping like a baby<sup>1</sup>.</p>
<p>Kamal is sort of a lightweight version of <a href="https://kubernetes.io/">Kubernetes</a> that you can use to deploy containerized apps to a <a href="https://en.wikipedia.org/wiki/Virtual_private_server">VPS</a>. It has a bit of a learning curve, but once you get the hang of it, it’ll take you less than 5 minutes to get an app in production with a CI/CD pipeline.</p>
<p>A single push to main, and that green GitHub Actions checkmark confirms that your 2-pixel padding change is live for the world to admire.</p>
<p>In this tutorial, I’ll walk you through the process of deploying a Django app with Kamal, AWS ECR, and Github Actions.</p>
<p>You can find the code for this tutorial in <a href="https://github.com/dylanjcastillo/django-kamal-aws-gha-example">this repository</a>.</p>
<section id="prerequisites" class="level2">
<h2 class="anchored" data-anchor-id="prerequisites">Prerequisites</h2>
<p>To make the most of this tutorial, you should:</p>
<ul>
<li>Have an <a href="https://aws.amazon.com/">AWS</a> account and its <a href="https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html">CLI</a> installed.</li>
<li>Be comfortable with <a href="https://www.docker.com/">Docker</a>.</li>
<li>Have a basic understanding of <a href="https://kamal-deploy.org/">Kamal</a>. You’ll need to install version <code>1.9.0</code> for this tutorial.</li>
<li>Have a basic understanding of <a href="https://docs.github.com/en/actions">Github Actions</a>.</li>
<li>Have a VPS with Ubuntu ready to host your app.</li>
</ul>
<p>Ideally, you should also have a Django project ready to deploy. But if you don’t have one, you can use this sample <a href="https://github.com/dylanjcastillo/django-kamal-aws-gha-example">Django project</a> for the tutorial.</p>
</section>
<section id="prepare-the-vps-for-kamal" class="level2">
<h2 class="anchored" data-anchor-id="prepare-the-vps-for-kamal">Prepare the VPS for Kamal</h2>
<p>At a minimum, you’ll need to install docker, curl, git, and snapd on your VPS, and create a non-root user called <code>kamal</code> that can sudo. That user should have a 1000 <code>UID</code> and <code>GID</code>.</p>
<p>I have a <a href="https://dylancastillo.co/posts/create-a-kamal-ready-vps-on-hetzner-using-terraform.html">terraform script</a> that will take care of this for you if you’re using Hetzner.</p>
<p>But if you’d like to do it manually, you can run these commands on your VPS’s terminal:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Install docker, curl, and git, and snapd</span></span>
<span id="cb1-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">apt-get</span> update</span>
<span id="cb1-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">apt-get</span> install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-y</span> docker.io curl git snapd</span>
<span id="cb1-4"></span>
<span id="cb1-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Start and enable the docker service</span></span>
<span id="cb1-6"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">systemctl</span> start docker</span>
<span id="cb1-7"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">systemctl</span> enable docker</span>
<span id="cb1-8"></span>
<span id="cb1-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a non-root user called kamal</span></span>
<span id="cb1-10"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">useradd</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-s</span> /bin/bash <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-u</span> 1000 kamal</span>
<span id="cb1-11"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">usermod</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-aG</span> sudo kamal</span>
<span id="cb1-12"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"kamal ALL=(ALL) NOPASSWD:ALL"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;</span> /etc/sudoers.d/kamal</span>
<span id="cb1-13"></span>
<span id="cb1-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># SSH key to login as kamal user</span></span>
<span id="cb1-15"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mkdir</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-p</span> /home/kamal/.ssh</span>
<span id="cb1-16"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;YOUR_PUBLIC_SSH_KEY&gt;"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;</span> /home/kamal/.ssh/authorized_keys</span>
<span id="cb1-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chmod</span> 700 /home/kamal/.ssh</span>
<span id="cb1-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chmod</span> 600 /home/kamal/.ssh/authorized_keys</span>
<span id="cb1-19"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chown</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-R</span> kamal:kamal /home/kamal/.ssh</span>
<span id="cb1-20"></span>
<span id="cb1-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Disable root login</span></span>
<span id="cb1-22"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sed</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-i</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'/PermitRootLogin/d'</span> /etc/ssh/sshd_config</span>
<span id="cb1-23"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PermitRootLogin no"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;</span> /etc/ssh/sshd_config</span>
<span id="cb1-24"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">systemctl</span> restart sshd</span>
<span id="cb1-25"></span>
<span id="cb1-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add the kamal user to the docker group</span></span>
<span id="cb1-27"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">usermod</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-aG</span> docker kamal</span>
<span id="cb1-28"></span>
<span id="cb1-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a folder for the Let's Encrypt ACME JSON</span></span>
<span id="cb1-30"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mkdir</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-p</span> /letsencrypt <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">touch</span> /letsencrypt/acme.json <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chmod</span> 600 /letsencrypt/acme.json</span>
<span id="cb1-31"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chown</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-R</span> kamal:kamal /letsencrypt</span>
<span id="cb1-32"></span>
<span id="cb1-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a folder for the SQLite database (skip this if you're using a different database)</span></span>
<span id="cb1-34"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mkdir</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-p</span> /db</span>
<span id="cb1-35"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chown</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-R</span> 1000:1000 /db</span>
<span id="cb1-36"></span>
<span id="cb1-37"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a folder for the redis data (skip this if you're not using redis)</span></span>
<span id="cb1-38"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mkdir</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-p</span> /data</span>
<span id="cb1-39"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chown</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-R</span> 1000:1000 /data</span>
<span id="cb1-40"></span>
<span id="cb1-41"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">reboot</span></span></code></pre></div>
<p>This assumes that you’re using a root user to connect to your server and that there isn’t a non-root user with <code>UID</code> 1000 already. Otherwise, adjust the commands accordingly.</p>
<p>Also, if you don’t have a public SSH key for the “Add SSH key” step, you can generate one with the following command:</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ssh-keygen</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-t</span> ed25519 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-C</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"your-email@example.com"</span></span></code></pre></div>
<p>These commands will:</p>
<ol type="1">
<li>Install docker, curl, git, and snapd</li>
<li>Start and enable the docker service</li>
<li>Create a non-root user called kamal</li>
<li>Remove the root login</li>
<li>Add the kamal user to the docker group</li>
<li>Create a bridge network for Traefik, SQLite, and redis</li>
<li>Create a folder for the Let’s Encrypt ACME JSON</li>
<li>Make the Let’s Encrypt ACME JSON folder writable by the kamal user</li>
<li>Create a folder for the SQLite database and redis data</li>
<li>Make the SQLite database and redis data folders writable by the kamal user</li>
<li>Restart the server</li>
</ol>
<p>If you’re not using SQLite or redis, you can skip the database and redis data folder steps.</p>
<p>Finally, configure the SSH key in your local <code>.ssh/config</code> file so you can login as the kamal user without using the root account.</p>
<pre><code>Host kamal
  HostName &lt;YOUR_VPS_IP&gt;
  User kamal
  IdentityFile ~/.ssh/&lt;YOUR_PRIVATE_SSH_KEY&gt;</code></pre>
</section>
<section id="create-a-dockerfile-for-your-app" class="level2">
<h2 class="anchored" data-anchor-id="create-a-dockerfile-for-your-app">Create a Dockerfile for your app</h2>
<p>Kamal is meant to deploy containerized apps, so you’ll need to have a Dockerfile for your app. I also recommend using an <code>entrypoint.sh</code> script to run the application.</p>
<section id="dockerfile" class="level3">
<h3 class="anchored" data-anchor-id="dockerfile">Dockerfile</h3>
<p>Here’s the Dockerfile I’m using for my projects. You can use this as a template and adjust it to your needs.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>Dockerfile</strong></pre>
</div>
<div class="sourceCode" id="cb4" data-filename="Dockerfile" style="background: #f1f3f5;"><pre class="sourceCode numberSource dockerfile number-lines code-with-copy"><code class="sourceCode dockerfile"><span id="cb4-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">FROM</span> python:3.10-slim <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AS</span> base</span>
<span id="cb4-2"></span>
<span id="cb4-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ENV</span> POETRY_HOME=/opt/poetry</span>
<span id="cb4-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ENV</span> POETRY_VERSION=1.8.3</span>
<span id="cb4-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ENV</span> PATH=${POETRY_HOME}/bin:${PATH}</span>
<span id="cb4-6"></span>
<span id="cb4-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">RUN</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">apt-get</span> update <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb4-8">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">apt-get</span> install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--no-install-recommends</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-y</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb4-9">    curl <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb4-10">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">apt-get</span> clean <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb4-11">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rm</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-rf</span> /var/lib/apt/lists/<span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb4-12"></span>
<span id="cb4-13"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">RUN</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">curl</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-sSL</span> https://install.python-poetry.org <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">|</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python3</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">poetry</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--version</span></span>
<span id="cb4-14"></span>
<span id="cb4-15"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">FROM</span> base <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AS</span> builder</span>
<span id="cb4-16"></span>
<span id="cb4-17"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">WORKDIR</span> /app</span>
<span id="cb4-18"></span>
<span id="cb4-19"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">COPY</span> poetry.lock pyproject.toml ./</span>
<span id="cb4-20"></span>
<span id="cb4-21"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">RUN</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">poetry</span> config virtualenvs.in-project true <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb4-22">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">poetry</span> install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--only</span> main <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--no-interaction</span></span>
<span id="cb4-23"></span>
<span id="cb4-24"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">FROM</span> base <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AS</span> runner</span>
<span id="cb4-25"></span>
<span id="cb4-26"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">WORKDIR</span> /app</span>
<span id="cb4-27"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">COPY</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--from=builder</span> /app/.venv/ /app/.venv/</span>
<span id="cb4-28"></span>
<span id="cb4-29"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">COPY</span> . /app</span>
<span id="cb4-30"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">RUN</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mkdir</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-p</span> /data /db</span>
<span id="cb4-31"></span>
<span id="cb4-32"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">RUN</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chmod</span> +x /app/src/entrypoint.sh</span>
<span id="cb4-33"></span>
<span id="cb4-34"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">FROM</span> runner <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AS</span> production</span>
<span id="cb4-35"></span>
<span id="cb4-36"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">EXPOSE</span> 8000</span>
<span id="cb4-37"></span>
<span id="cb4-38"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ARG</span> user=django</span>
<span id="cb4-39"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ARG</span> group=django</span>
<span id="cb4-40"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ARG</span> uid=1000</span>
<span id="cb4-41"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ARG</span> gid=1000</span>
<span id="cb4-42"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">RUN</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">groupadd</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-g</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${gid}</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${group}</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb4-43">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">useradd</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-u</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${uid}</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-g</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${group}</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-s</span> /bin/sh <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${user}</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb4-44">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chown</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-R</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${uid}</span>:<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${gid}</span> /app /data /db</span>
<span id="cb4-45"></span>
<span id="cb4-46"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">USER</span> ${uid}:${gid}</span>
<span id="cb4-47"></span>
<span id="cb4-48"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">WORKDIR</span> /app/src</span>
<span id="cb4-49"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">CMD</span> [ <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/app/src/entrypoint.sh"</span> , <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"app"</span>]</span></code></pre></div>
</div>
<p>This is a multi-stage Dockerfile that:</p>
<ol type="1">
<li>Installs poetry and sets up the virtual environment</li>
<li>Creates the user <code>django</code> with the <code>UID</code> and <code>GID</code> 1000 and runs the application with that user. It’s important that this user has the same <code>UID</code> and <code>GID</code> as the owner of the folders outside the container. Otherwise, you’ll have issues with <a href="https://medium.com/@nielssj/docker-volumes-and-file-system-permissions-772c1aee23ca">file permissions</a> and the app won’t persist data.</li>
<li>Exposes port 8000 and runs the application by executing the <code>entrypoint.sh</code> script. By exposing the port, Kamal will automatically detect that is the port the app runs on and <a href="https://github.com/basecamp/kamal/issues/58">will use that to set up the reverse proxy</a>.</li>
</ol>
<p>Feel free to adjust this Dockerfile to your needs. If you are not planning on using redis or a SQLite database in your same VPS, you can remove those parts from the Dockerfile.</p>
</section>
<section id="entrypoint.sh-script" class="level3">
<h3 class="anchored" data-anchor-id="entrypoint.sh-script"><code>entrypoint.sh</code> script</h3>
<p>I use an <code>entrypoint.sh</code> script to run the application because that makes it easier to collect static files, run migrations when the container starts, and also running commands in the container.</p>
<p>Here’s an example of a simple <code>entrypoint.sh</code> script:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>entrypoint.sh</strong></pre>
</div>
<div class="sourceCode" id="cb5" data-filename="entrypoint.sh" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#!/bin/sh</span></span>
<span id="cb5-2"></span>
<span id="cb5-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-e</span></span>
<span id="cb5-4"></span>
<span id="cb5-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">[</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$1</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"app"</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">]</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">;</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">then</span></span>
<span id="cb5-6">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Collecting static files"</span></span>
<span id="cb5-7">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">poetry</span> run python manage.py collectstatic <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--clear</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--noinput</span></span>
<span id="cb5-8"></span>
<span id="cb5-9">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Running migrations"</span></span>
<span id="cb5-10">    <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">poetry</span> run python manage.py migrate</span>
<span id="cb5-11"></span>
<span id="cb5-12">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Running in production mode"</span></span>
<span id="cb5-13">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">exec</span> poetry run gunicorn <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-c</span> gunicorn.conf.py</span>
<span id="cb5-14"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span></span>
<span id="cb5-15">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">exec</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$@</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb5-16"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fi</span></span></code></pre></div>
</div>
<p>This script just collects static files, runs migrations, and starts the Gunicorn server with the configuration in the <code>gunicorn.conf.py</code> file. You can add or remove commands to the script as needed.</p>
</section>
</section>
<section id="configure-an-ecr-registry-in-aws" class="level2">
<h2 class="anchored" data-anchor-id="configure-an-ecr-registry-in-aws">Configure an ECR registry in AWS</h2>
<p>Next, you’ll need a place to push and pull your Docker images. I like using AWS, so that’s what I’ll show you how to do. If you prefer other services, take a look at the instructions for other registries in the <a href="https://kamal-deploy.org/docs/configuration/docker-registry/">Kamal documentation</a>.</p>
<p>Log in to the <a href="https://aws.amazon.com/console/">AWS Management Console</a> and go to Amazon ECR. Click on <code>Create repository</code> and set a name for your repository.</p>
<p>Then, create a new IAM user in your AWS account by going to Services &gt; IAM &gt; Users &gt; Add user.</p>
<p>Instead of using a predefined policy, create a new one with the following JSON and attach it to the user:</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource json number-lines code-with-copy"><code class="sourceCode json"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-2">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"Version"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2012-10-17"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-3">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"Statement"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb6-4">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-5">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"Sid"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ListImagesInRepository"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-6">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"Effect"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Allow"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-7">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"Action"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ecr:ListImages"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-8">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"Resource"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb6-9">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"arn:aws:ecr:&lt;REGION&gt;:&lt;ACCOUNT_ID&gt;:repository/&lt;REPOSITORY_NAME&gt;"</span></span>
<span id="cb6-10">      <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb6-11">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-12">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-13">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"Sid"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GetAuthorizationToken"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-14">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"Effect"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Allow"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-15">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"Action"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ecr:GetAuthorizationToken"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-16">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"Resource"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"*"</span></span>
<span id="cb6-17">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-18">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-19">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"Sid"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ManageRepositoryContents"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-20">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"Effect"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Allow"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-21">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"Action"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb6-22">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ecr:BatchCheckLayerAvailability"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-23">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ecr:GetDownloadUrlForLayer"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-24">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ecr:GetRepositoryPolicy"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-25">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ecr:DescribeRepositories"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-26">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ecr:ListImages"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-27">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ecr:DescribeImages"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-28">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ecr:BatchGetImage"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-29">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ecr:InitiateLayerUpload"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-30">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ecr:UploadLayerPart"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-31">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ecr:CompleteLayerUpload"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-32">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ecr:PutImage"</span></span>
<span id="cb6-33">      <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb6-34">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"Resource"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb6-35">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"arn:aws:ecr:&lt;REGION&gt;:&lt;ACCOUNT_ID&gt;:repository/&lt;REPOSITORY_NAME&gt;"</span></span>
<span id="cb6-36">      <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb6-37">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb6-38">  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb6-39"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>This policy allows the user to list, get, and manage the ECR repository you created earlier and get the authorization token to push and pull the image. You will need to replace the <code>&lt;REGION&gt;</code>, <code>&lt;ACCOUNT_ID&gt;</code>, and <code>&lt;REPOSITORY_NAME&gt;</code> with the values for your repository.</p>
<p>Next, select the user you created and go to Security credentials &gt; Access keys &gt; Create access key. Download the CSV file and keep it in a secure location.</p>
<p>You will use those credentials in your Github Actions pipeline to push and pull the image from the ECR registry.</p>
</section>
<section id="set-up-kamal-in-your-project" class="level2">
<h2 class="anchored" data-anchor-id="set-up-kamal-in-your-project">Set up Kamal in your project</h2>
<p>Open your Django project in your favorite code editor. Create a folder called <code>deploy</code> in the root directory. Then go into the folder and initialize Kamal:</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">kamal</span> init</span></code></pre></div>
<p>This will create two folders (<code>.kamal/</code> and <code>config/</code>), a <code>deploy.yml</code> file, and a <code>secrets</code> file, and a <code>.hooks/</code> folder that contains the hooks for the deployment. This is where you’ll provide the instructions for Kamal to build and deploy your app.</p>
<p>You can use the following <code>deploy.yml</code> file as a template for your Django app:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>deploy.yml</strong></pre>
</div>
<div class="sourceCode" id="cb8" data-filename="deploy.yml" style="background: #f1f3f5;"><pre class="sourceCode numberSource yml number-lines code-with-copy"><code class="sourceCode yaml"><span id="cb8-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">service</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> example</span></span>
<span id="cb8-2"></span>
<span id="cb8-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">image</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> example</span></span>
<span id="cb8-4"></span>
<span id="cb8-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ssh</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb8-6"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">user</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> kamal</span></span>
<span id="cb8-7"></span>
<span id="cb8-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">env</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb8-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">secret</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb8-10"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> DJANGO_SECRET_KEY</span></span>
<span id="cb8-11"></span>
<span id="cb8-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">proxy</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb8-13"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ssl</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">true</span></span>
<span id="cb8-14"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">host</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> example.iwanalabs.com</span></span>
<span id="cb8-15"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">app_port</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8000</span></span>
<span id="cb8-16"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">healthcheck</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb8-17"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">path</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> /kamal/up/</span></span>
<span id="cb8-18"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">interval</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb8-19"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">timeout</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb8-20"></span>
<span id="cb8-21"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">servers</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb8-22"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">web</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb8-23"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">128.140.0.209</span></span>
<span id="cb8-24"></span>
<span id="cb8-25"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">accessories</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb8-26"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">redis</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb8-27"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">image</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> redis:7.0</span></span>
<span id="cb8-28"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">roles</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb8-29"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> web</span></span>
<span id="cb8-30"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cmd</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> --maxmemory 200m --maxmemory-policy allkeys-lru</span></span>
<span id="cb8-31"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">volumes</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb8-32"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> /var/redis/data:/data/redis</span></span>
<span id="cb8-33"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">options</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb8-34"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">memory</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> 250m</span></span>
<span id="cb8-35"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">network</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> private_network</span></span>
<span id="cb8-36"></span>
<span id="cb8-37"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">volumes</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb8-38"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/db/:/app/db/"</span></span>
<span id="cb8-39"></span>
<span id="cb8-40"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">registry</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb8-41"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">server</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> &lt;account_id&gt;.dkr.ecr.&lt;region&gt;.amazonaws.com</span></span>
<span id="cb8-42"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">username</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> AWS</span></span>
<span id="cb8-43"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">password</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb8-44"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> KAMAL_REGISTRY_PASSWORD</span></span>
<span id="cb8-45"></span>
<span id="cb8-46"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">builder</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb8-47"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arch</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> amd64</span></span>
<span id="cb8-48"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dockerfile</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../Dockerfile"</span></span>
<span id="cb8-49"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">context</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../"</span></span>
<span id="cb8-50"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cache</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb8-51"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">type</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> gha</span></span></code></pre></div>
</div>
<p>This will set up your app and a <a href="https://github.com/basecamp/kamal-proxy">Kamal’s proxy server</a> (with automatic SSL certificates using Let’s Encrypt), a Redis database, and a volume to persist the SQLite database. It will also do a healthcheck on <code>/kamal/up/</code> on port <code>8000</code>. Remember to replace the placeholders with your own values.</p>
<p>To pass the healthcheck, you will need to add a small middleware that bypasses Django’s built-in <a href="https://github.com/basecamp/kamal/issues/992">security middleware</a>.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/config/middleware.py</strong></pre>
</div>
<div class="sourceCode" id="cb9" data-filename="src/config/middleware.py" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> django.http <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> HttpResponse</span>
<span id="cb9-2"></span>
<span id="cb9-3"></span>
<span id="cb9-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> HealthCheckMiddleware:</span>
<span id="cb9-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, get_response):</span>
<span id="cb9-6">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.get_response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_response</span>
<span id="cb9-7"></span>
<span id="cb9-8">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__call__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, request):</span>
<span id="cb9-9">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> request.path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/kamal/up/"</span>:</span>
<span id="cb9-10">            response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> HttpResponse(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OK"</span>)</span>
<span id="cb9-11">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb9-12">            response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.get_response(request)</span>
<span id="cb9-13"></span>
<span id="cb9-14">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response</span></code></pre></div>
</div>
<p>And add it to the <code>MIDDLEWARE</code> list in the <code>settings.py</code> file.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>src/config/settings.py</strong></pre>
</div>
<div class="sourceCode" id="cb10" data-filename="src/config/settings.py" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1">MIDDLEWARE <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb10-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"config.middleware.HealthCheckMiddleware"</span>,</span>
<span id="cb10-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># other middlewares...</span></span>
<span id="cb10-4">]</span></code></pre></div>
</div>
<section id="test-the-configuration-locally" class="level3">
<h3 class="anchored" data-anchor-id="test-the-configuration-locally">Test the configuration locally</h3>
<p>To test it locally, first, you’ll have to define the required environment variables in the <code>.env</code> file, such as the Django secret key, OpenAI API key, and any other secrets you need.</p>
<p>You’ll also need to get a temporary password for the ECR registry. You can get this password by running the following command:</p>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">aws</span> ecr get-login-password <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--region</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>YOUR_REGION<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span></code></pre></div>
<p>You should copy the output of this command and paste it in the <code>KAMAL_REGISTRY_PASSWORD</code> field in the <code>.env</code> file.</p>
<p>Then, you should define the required environment variables in <code>.kamal/secrets</code> as follows:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>.kamal/secrets</strong></pre>
</div>
<div class="sourceCode" id="cb12" data-filename=".kamal/secrets" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">KAMAL_REGISTRY_PASSWORD</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$KAMAL_REGISTRY_PASSWORD</span></span>
<span id="cb12-2"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">DJANGO_SECRET_KEY</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$DJANGO_SECRET_KEY</span></span>
<span id="cb12-3"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">OPENAI_API_KEY</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$OPENAI_API_KEY</span></span></code></pre></div>
</div>
<p>Then, run the following command to deploy your application to your VPS:</p>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">kamal</span> deploy</span></code></pre></div>
<p>The first command will push the environment variables to the VPS. The second command will build the Docker image, push it to the ECR registry, and deploy it to your VPS.</p>
<p>After a few minutes, your app should be live at <code>https://&lt;YOUR_DOMAIN&gt;</code>.</p>
<p>If you see any errors, there are two things you can do:</p>
<ol type="1">
<li>Run <code>kamal app logs</code> to see the logs of the app.</li>
<li>Open a terminal in the container by running <code>kamal app exec -it bash</code>.</li>
</ol>
<p>This is how I usually debug the app.</p>
</section>
</section>
<section id="automate-the-deployment-with-github-actions" class="level2">
<h2 class="anchored" data-anchor-id="automate-the-deployment-with-github-actions">Automate the deployment with Github Actions</h2>
<p>Now that you have a working deployment process in your local environment, you can automate the deployment with Github Actions.</p>
<p>Create a new file in the <code>.github/workflows</code> folder called <code>deploy.yml</code> and add the following code:</p>
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource yml number-lines code-with-copy"><code class="sourceCode yaml"><span id="cb14-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Deploy webapp to VPS</span></span>
<span id="cb14-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">concurrency</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb14-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> ${{ github.workflow }}-${{ github.ref }}</span></span>
<span id="cb14-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cancel-in-progress</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">true</span></span>
<span id="cb14-5"></span>
<span id="cb14-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">on</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb14-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">push</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb14-8"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">branches</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"main"</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]</span></span>
<span id="cb14-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">workflow_dispatch</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb14-10"></span>
<span id="cb14-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">jobs</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb14-12"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">deploy</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb14-13"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">runs-on</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> ubuntu-latest</span></span>
<span id="cb14-14"></span>
<span id="cb14-15"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">steps</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb14-16"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Checkout</span></span>
<span id="cb14-17"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">uses</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> actions/checkout@v3</span></span>
<span id="cb14-18"></span>
<span id="cb14-19"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">uses</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> webfactory/ssh-agent@v0.7.0</span></span>
<span id="cb14-20"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">with</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb14-21"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ssh-private-key</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> ${{ secrets.VPS_SSH_PRIVATE_KEY }}</span></span>
<span id="cb14-22"></span>
<span id="cb14-23"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Set up Ruby and install kamal</span></span>
<span id="cb14-24"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">uses</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> ruby/setup-ruby@v1</span></span>
<span id="cb14-25"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">with</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb14-26"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ruby-version</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.2.2</span></span>
<span id="cb14-27"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">run</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> gem install kamal -v 1.9.0</span></span>
<span id="cb14-28"></span>
<span id="cb14-29"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Configure AWS credentials</span></span>
<span id="cb14-30"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">uses</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> aws-actions/configure-aws-credentials@v4</span></span>
<span id="cb14-31"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">with</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb14-32"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aws-access-key-id</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> ${{ secrets.AWS_ACCESS_KEY_ID_ECR }}</span></span>
<span id="cb14-33"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aws-secret-access-key</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> ${{ secrets.AWS_SECRET_ACCESS_KEY_ECR }}</span></span>
<span id="cb14-34"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aws-region</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> us-east-1</span></span>
<span id="cb14-35"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mask-aws-account-id</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">false</span></span>
<span id="cb14-36"></span>
<span id="cb14-37"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Login to AWS ECR</span></span>
<span id="cb14-38"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">id</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> login-ecr</span></span>
<span id="cb14-39"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">uses</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> aws-actions/amazon-ecr-login@v2</span></span>
<span id="cb14-40"></span>
<span id="cb14-41"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Set up Docker Buildx for cache</span></span>
<span id="cb14-42"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">uses</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> docker/setup-buildx-action@v3</span></span>
<span id="cb14-43"></span>
<span id="cb14-44"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Expose GitHub Runtime for cache</span></span>
<span id="cb14-45"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">uses</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> crazy-max/ghaction-github-runtime@v3</span></span>
<span id="cb14-46"></span>
<span id="cb14-47"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> Kamal Deploy</span></span>
<span id="cb14-48"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">id</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> kamal-deploy</span></span>
<span id="cb14-49"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">env</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb14-50"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">KAMAL_REGISTRY_PASSWORD</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> ${{ steps.login-ecr.outputs.docker_password_&lt;account_id&gt;_dkr_ecr_&lt;region&gt;_amazonaws_com }}</span></span>
<span id="cb14-51"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">DJANGO_SECRET_KEY</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> ${{ secrets.DJANGO_SECRET_KEY }}</span></span>
<span id="cb14-52"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">        run</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">: </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">|</span></span>
<span id="cb14-53">          cd deploy</span>
<span id="cb14-54">          kamal lock release</span>
<span id="cb14-55">          kamal deploy</span></code></pre></div>
<p>This workflow will:</p>
<ol type="1">
<li>Checkout the code</li>
<li>Set up the Ruby environment and install Kamal</li>
<li>Configure the AWS credentials</li>
<li>Login to the AWS ECR registry</li>
<li>Set up Docker Buildx for cache</li>
<li>Expose GitHub Runtime for cache</li>
<li>Run Kamal deploy with the secrets defined in the environment</li>
</ol>
<p>It will run everytime you make a push to the main branch or by manually triggering the workflow. It’ll cancel any in-progress runs to avoid conflicts.</p>
<p>Also, before you push your code to the repository, you’ll need to add the following secrets to the repository:</p>
<ul>
<li><code>VPS_SSH_PRIVATE_KEY</code>: The private key to connect to your VPS</li>
<li><code>AWS_ACCESS_KEY_ID_ECR</code>: The access key ID for the AWS ECR registry</li>
<li><code>AWS_SECRET_ACCESS_KEY_ECR</code>: The secret access key for the AWS ECR registry</li>
<li><code>DJANGO_SECRET_KEY</code>: The Django secret key</li>
</ul>
<p>Finally, to speed up the deployment, add these options to the <code>builder</code> section of the <code>deploy.yml</code> file:</p>
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource yml number-lines code-with-copy"><code class="sourceCode yaml"><span id="cb15-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">builder</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb15-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dockerfile</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../Dockerfile"</span></span>
<span id="cb15-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">context</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../"</span></span>
<span id="cb15-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">multiarch</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">false</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> # new</span></span>
<span id="cb15-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cache</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> # new</span></span>
<span id="cb15-6"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">type</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> gha</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> # new</span></span></code></pre></div>
<p>This will enable the Docker Buildx cache for the build process in Github Actions. You can set <code>multiarch</code> to <code>false</code> if your CI pipeline shares the same architecture as your VPS, which was the case for me.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>You now have a fully automated deployment pipeline for your Django app. A push to the <code>main</code> branch will trigger the workflow, which will build the Docker image, push it to the ECR registry, and deploy it to your VPS.</p>
<p>Break free from the tyranny of manual deployments and expensive cloud services. Sleep like a baby and let Kamal handle your deployments.</p>
<p>If you have any questions or feedback, please feel free to leave a comment below.</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>crying and sh*tting my diapers?↩︎</p></li>
</ol>
</section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2024,
  author = {Castillo, Dylan},
  title = {Deploying a {Django} App with {Kamal} 2, {AWS} {ECR,} and
    {Github} {Actions}},
  date = {2024-09-15},
  url = {https://dylancastillo.co/posts/deploy-a-django-app-with-kamal-aws-ecr-and-github-actions.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2024" class="csl-entry quarto-appendix-citeas">
Castillo, Dylan. 2024. <span>“Deploying a Django App with Kamal 2, AWS
ECR, and Github Actions.”</span> September 15, 2024. <a href="https://dylancastillo.co/posts/deploy-a-django-app-with-kamal-aws-ecr-and-github-actions.html">https://dylancastillo.co/posts/deploy-a-django-app-with-kamal-aws-ecr-and-github-actions.html</a>.
</div></div></section></div> ]]></description>
  <category>django</category>
  <category>kamal</category>
  <category>aws</category>
  <guid>https://dylancastillo.co/posts/deploy-a-django-app-with-kamal-aws-ecr-and-github-actions.html</guid>
  <pubDate>Sun, 15 Sep 2024 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Classifying images with Gemini Flash 1.5</title>
  <dc:creator>Dylan Castillo</dc:creator>
  <link>https://dylancastillo.co/posts/classify-images-with-gemini-flash-1.5.html</link>
  <description><![CDATA[ 




<p>Most people think of <a href="https://arxiv.org/abs/2301.00234">In-Context Learning (ICL)</a> — the ability of LLMs to learn from examples provided in the context — only as a component of RAG applications.</p>
<p>I used to think of it that way too. Until I recently found out that Multimodal Large Language Models (MLLMs) with ICL can be used to perform more traditional ML tasks such as image classification.</p>
<p>I was skeptical at first, but was surprised to see that it worked pretty well both in the literature (see <a href="https://arxiv.org/abs/2405.09798">here</a> and <a href="https://arxiv.org/abs/2403.07407">here</a>) and in my own experiments.</p>
<p>You shouldn’t expect state-of-the-art results with it, but it can often give you pretty good results with very little effort and data.</p>
<p>In this tutorial, I’ll show you how to use ICL to classify images using Gemini Flash 1.5.</p>
<section id="why-gemini-flash-1.5" class="level2">
<h2 class="anchored" data-anchor-id="why-gemini-flash-1.5">Why Gemini Flash 1.5?</h2>
<p>You can use any MLLM for this task, but I chose Gemini Flash 1.5 because:</p>
<ol type="1">
<li>It’s cheaper than <a href="https://ai.google.dev/pricing">Gemini Pro 1.5</a>, <a href="https://platform.openai.com/pricing">GPT-4o</a>, and <a href="https://docs.anthropic.com/en/docs/build-with-claude/vision#calculate-image-costs">Sonnet 3.5</a>. For an image of <em>512x512</em> pixels, Gemini Flash 1.5 is 50x cheaper than Gemini Pro 1.5, 5x to 16x cheaper than GPT-4o, and 26x cheaper than Sonnet 3.5<sup>1</sup>.</li>
<li>It lets you use up to 3,000 images per request. By trial and error, I found that GPT-4o seems to have a hard limit at 250 images per request and Sonnet 3.5’s documentation mentions a limit of 20 images per request.</li>
<li>It works well. If you really want to squeeze the last bit of performance out of your model, you can use a bigger model, but for the purposes of this tutorial, Gemini Flash 1.5 will do just fine.</li>
</ol>
<p>Regardless of the model you choose, this tutorial will be a good starting point for you to classify images using ICL.</p>
</section>
<section id="prerequisites" class="level2">
<h2 class="anchored" data-anchor-id="prerequisites">Prerequisites</h2>
<p>To follow this tutorial you’ll need to:</p>
<ol type="1">
<li>Sign up and generate an API key in <a href="https://aistudio.google.com/app/apikey">Google AI Studio</a>.</li>
<li>Set the API key as an environment variable called <code>GEMINI_API_KEY</code>.</li>
<li>Download <a href="https://www.kaggle.com/datasets/gpiosenka/butterfly-images40-species?resource=download">this dataset</a> and save it to <code>data/</code>.</li>
<li>Create a virtual environment and install the requirements:</li>
</ol>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span> venv venv</span>
<span id="cb1-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">source</span> venv/bin/activate</span>
<span id="cb1-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install pandas numpy scikit-learn google-generativeai pillow</span></code></pre></div>
</section>
<section id="set-up" class="level2">
<h2 class="anchored" data-anchor-id="set-up">Set up</h2>
<p>As usual, you start by importing the necessary libraries:</p>
<div id="cell-7" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> json</span>
<span id="cb2-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> warnings</span>
<span id="cb2-4"></span>
<span id="cb2-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> google.generativeai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> genai</span>
<span id="cb2-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb2-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb2-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.metrics <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> accuracy_score, f1_score</span>
<span id="cb2-9"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> PIL <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Image</span>
<span id="cb2-10"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pathlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Path</span>
<span id="cb2-11"></span>
<span id="cb2-12">warnings.filterwarnings(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ignore"</span>)</span>
<span id="cb2-13"></span>
<span id="cb2-14">np.random.seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span></code></pre></div>
</div>
<p>In addition to the usual popular libraries (e.g.&nbsp;<code>pandas</code>, <code>sklearn</code>), you’ll need:</p>
<ul>
<li><code>google.generativeai</code> for interacting with the Gemini API</li>
<li><code>PIL</code> for handling images</li>
<li><code>sklearn</code> for calculating performance metrics</li>
</ul>
<p>Then, you’ll need to configure the Gemini API client with your API key:</p>
<div id="cell-9" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1">genai.configure(api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>os.environ[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GEMINI_API_KEY"</span>])</span></code></pre></div>
</div>
<p>This will take the <code>GEMINI_API_KEY</code> environment variable and use it to authenticate your requests to the Gemini API.</p>
</section>
<section id="read-data" class="level2">
<h2 class="anchored" data-anchor-id="read-data">Read data</h2>
<p>To make a fair evaluation of the model’s performance, you should split the dataset into separate training and testing sets. The training set is used to provide context or examples to the model during inference. The testing set, comprised of unseen images, is then used to measure the model’s performance.</p>
<p>This process is different from the traditional “training” process, where you update the model’s weights or parameters. Here, you’re only providing the model with a set of images and asking it to learn from them at inference time.</p>
<p>This function will help you create the datasets:</p>
<div id="cell-13" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> create_datasets(train_dir, test_dir, selected_classes, n_images_icl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>):</span>
<span id="cb4-2">    train_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb4-3">    test_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb4-4"></span>
<span id="cb4-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> class_id, class_name <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(selected_classes):</span>
<span id="cb4-6">        train_class_dir <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train_dir <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> class_name</span>
<span id="cb4-7">        test_class_dir <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> test_dir <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> class_name</span>
<span id="cb4-8"></span>
<span id="cb4-9">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> train_class_dir.is_dir() <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> test_class_dir.is_dir():</span>
<span id="cb4-10">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span></span>
<span id="cb4-11"></span>
<span id="cb4-12">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Train dataset</span></span>
<span id="cb4-13">        train_image_files <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(train_class_dir.glob(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"*.jpg"</span>))</span>
<span id="cb4-14">        selected_train_images <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.choice(</span>
<span id="cb4-15">            train_image_files,</span>
<span id="cb4-16">            size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>(n_images_icl, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(train_image_files)),</span>
<span id="cb4-17">            replace<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,</span>
<span id="cb4-18">        )</span>
<span id="cb4-19">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> img_path <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> selected_train_images:</span>
<span id="cb4-20">            train_data.append(</span>
<span id="cb4-21">                {</span>
<span id="cb4-22">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"image_path"</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(img_path),</span>
<span id="cb4-23">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"class_id"</span>: <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"class_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>class_id<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb4-24">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"class_name"</span>: class_name,</span>
<span id="cb4-25">                }</span>
<span id="cb4-26">            )</span>
<span id="cb4-27"></span>
<span id="cb4-28">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Test dataset</span></span>
<span id="cb4-29">        test_image_files <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(test_class_dir.glob(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"*.jpg"</span>))</span>
<span id="cb4-30">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> img_path <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> test_image_files:</span>
<span id="cb4-31">            test_data.append(</span>
<span id="cb4-32">                {</span>
<span id="cb4-33">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"image_path"</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(img_path),</span>
<span id="cb4-34">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"class_id"</span>: <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"class_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>class_id<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb4-35">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"class_name"</span>: class_name,</span>
<span id="cb4-36">                }</span>
<span id="cb4-37">            )</span>
<span id="cb4-38"></span>
<span id="cb4-39">    df_train <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.DataFrame(train_data)</span>
<span id="cb4-40">    df_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.DataFrame(test_data).sample(frac<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).reset_index(drop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb4-41"></span>
<span id="cb4-42">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> df_train, df_test</span></code></pre></div>
</div>
<p>This function will get a random selection of <code>n_images_icl</code> images per class from the <code>train</code> folder (that you’ll later use in the model’s context). For the testing set, which you’ll use to measure the model’s performance, you’ll use all the available images in the <code>test</code> folder from those classes.</p>
<p>To keep things simple, you’ll start by selecting 15 different classes and 1 image per class for the context (i.e., <code>n_images_icl=1</code>)</p>
<div id="cell-15" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1">DATA_DIR <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../data/"</span></span>
<span id="cb5-2">TRAIN_DIR <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Path(DATA_DIR) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"train"</span></span>
<span id="cb5-3">TEST_DIR <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Path(DATA_DIR) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test"</span></span>
<span id="cb5-4"></span>
<span id="cb5-5">all_classes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(os.listdir(TRAIN_DIR))</span>
<span id="cb5-6">selected_classes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.choice(all_classes, size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>, replace<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb5-7"></span>
<span id="cb5-8">df_train, df_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> create_datasets(TRAIN_DIR, TEST_DIR, selected_classes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>selected_classes, n_images_icl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
</div>
<p>There will be 15 classes with 1 image in the training set and 15 classes with 5 images in the testing set.</p>
</section>
<section id="gemini-flash-1.5" class="level2">
<h2 class="anchored" data-anchor-id="gemini-flash-1.5">Gemini Flash 1.5</h2>
<p>Next, you’ll need to define a system prompt and configure the model to use it.</p>
<section id="define-prompt" class="level3">
<h3 class="anchored" data-anchor-id="define-prompt">Define prompt</h3>
<p>You’ll use a system prompt that will tell the model how to classify the images and the format you want the output to be in:</p>
<div id="cell-21" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1">CLASSIFIER_SYSTEM_PROMPT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""You are an expert lepidopterist.</span></span>
<span id="cb6-2"></span>
<span id="cb6-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Your task is to classify images of butterflies into one of the provided labels.</span></span>
<span id="cb6-4"></span>
<span id="cb6-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Provide your output as a JSON object using this format:</span></span>
<span id="cb6-6"></span>
<span id="cb6-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-8"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    "number_of_labeled_images": &lt;integer&gt;,</span></span>
<span id="cb6-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    "output": [</span></span>
<span id="cb6-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        {</span></span>
<span id="cb6-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">            "image_id": &lt;image id, integer, starts at 0&gt;,</span></span>
<span id="cb6-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">            "confidence": &lt;number between 0 and 10, the higher the more confident, integer&gt;,</span></span>
<span id="cb6-13"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">            "label": &lt;label of the correct butterfly species, string&gt;</span></span>
<span id="cb6-14"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        }, </span></span>
<span id="cb6-15"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        ...</span></span>
<span id="cb6-16"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    ]</span></span>
<span id="cb6-17"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb6-18"></span>
<span id="cb6-19"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">## Guidelines</span></span>
<span id="cb6-20"></span>
<span id="cb6-21"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">- ALWAYS produce valid JSON.</span></span>
<span id="cb6-22"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">- Generate ONLY a single prediction per input image.</span></span>
<span id="cb6-23"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">- The `number_of_labeled_images` MUST be the same as the number of input images.</span></span>
<span id="cb6-24"></span>
<span id="cb6-25"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">This is an example of a valid output:</span></span>
<span id="cb6-26"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">```</span></span>
<span id="cb6-27"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb6-28"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  "number_of_labeled_images": 5,</span></span>
<span id="cb6-29"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  "output": [</span></span>
<span id="cb6-30"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      {</span></span>
<span id="cb6-31"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        "image_id": 0,</span></span>
<span id="cb6-32"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        "confidence": 10,</span></span>
<span id="cb6-33"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        "correct_label": "class_B"</span></span>
<span id="cb6-34"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      },</span></span>
<span id="cb6-35"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      {</span></span>
<span id="cb6-36"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        "image_id": 1,</span></span>
<span id="cb6-37"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        "confidence": 9,</span></span>
<span id="cb6-38"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        "correct_label": "class_C"</span></span>
<span id="cb6-39"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      },</span></span>
<span id="cb6-40"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      {</span></span>
<span id="cb6-41"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        "image_id": 2,</span></span>
<span id="cb6-42"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        "confidence": 4,</span></span>
<span id="cb6-43"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        "correct_label": "class_A"</span></span>
<span id="cb6-44"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      },</span></span>
<span id="cb6-45"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      {</span></span>
<span id="cb6-46"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        "image_id": 3,</span></span>
<span id="cb6-47"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        "confidence": 2,</span></span>
<span id="cb6-48"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        "correct_label": "class_B"</span></span>
<span id="cb6-49"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      },</span></span>
<span id="cb6-50"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      {</span></span>
<span id="cb6-51"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        "image_id": 4,</span></span>
<span id="cb6-52"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        "confidence": 10,</span></span>
<span id="cb6-53"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        "correct_label": "class_C"</span></span>
<span id="cb6-54"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      }</span></span>
<span id="cb6-55"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  ]</span></span>
<span id="cb6-56"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb6-57"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">```</span></span>
<span id="cb6-58"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span>.strip()</span></code></pre></div>
</div>
<p>This prompt explains the task to the model. You’re providing it with a set of labels with corresponding images, and a set of images that should be classified into one of those labels. The model needs to output a single label for each image.</p>
<p>I included an additional field called <code>number_of_labeled_images</code> because I noticed that the model would often “forget” to include all the labels in the output, and this was a simple way to ensure that it did so.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Fun fact: I didn’t know that <em>lepidopterist</em> was a word until I wrote this prompt.</p>
</div>
</div>
</section>
<section id="configure-model" class="level3">
<h3 class="anchored" data-anchor-id="configure-model">Configure model</h3>
<p>Then, you can define and configure the model:</p>
<div id="cell-25" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1">generation_config <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb7-2">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"temperature"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb7-3">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"max_output_tokens"</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8192</span>,</span>
<span id="cb7-4">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"response_mime_type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"application/json"</span>,</span>
<span id="cb7-5">}</span>
<span id="cb7-6">classification_model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> genai.GenerativeModel(</span>
<span id="cb7-7">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gemini-1.5-flash"</span>, </span>
<span id="cb7-8">    system_instruction<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>CLASSIFIER_SYSTEM_PROMPT, </span>
<span id="cb7-9">    generation_config<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>generation_config</span>
<span id="cb7-10">)</span></code></pre></div>
</div>
<p>This sets up the model with the following configuration:</p>
<ul>
<li><code>temperature=1</code>: Controls the randomness of the model’s output.</li>
<li><code>max_output_tokens=8192</code>: The maximum number of tokens the model can generate.</li>
<li><code>response_mime_type="application/json"</code>: Tells the model to produce JSON.</li>
</ul>
<p>It also sets the <code>system_instruction</code> using the prompt you defined earlier and uses <code>gemini-1.5-flash</code> as the model.</p>
</section>
<section id="building-the-context" class="level3">
<h3 class="anchored" data-anchor-id="building-the-context">Building the context</h3>
<p>Gemini has a slightly different way of building the messages (context) used by the model.</p>
<p>Most providers have adjusted their API to match OpenAI’s <code>messages</code> format. Gemini, however, uses a list of strings and media files (if you’re including images).</p>
<p>You can use these functions for that:</p>
<div id="cell-29" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> create_context_images_message(df):</span>
<span id="cb8-2">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Possible labels:"</span>]</span>
<span id="cb8-3">    grouped <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.groupby(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'class_id'</span>)</span>
<span id="cb8-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> class_id, group <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> grouped:</span>
<span id="cb8-5">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _, row <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> group.iterrows():</span>
<span id="cb8-6">            base64_img <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Image.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(row[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"image_path"</span>])</span>
<span id="cb8-7">            messages.append(base64_img)</span>
<span id="cb8-8">        messages.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"label: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>class_id<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb8-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> messages</span>
<span id="cb8-10">    </span>
<span id="cb8-11">context_images_message <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> create_context_images_message(df_train)</span></code></pre></div>
</div>
<p>First, you’ll create a message with the context images and their corresponding labels. This is the “training” part of ICL.</p>
<p>In <code>create_context_images_message</code>, you’re iterating over the training dataset, grouping the images by class and appending the images and labels to the messages list.</p>
<p>The resulting message will look something like this:</p>
<div id="cell-31" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1">context_images_message[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>['Possible labels:',
 &lt;PIL.JpegImagePlugin.JpegImageFile image mode=RGB size=224x224&gt;,
 'label: class_0',
 &lt;PIL.JpegImagePlugin.JpegImageFile image mode=RGB size=224x224&gt;,
 'label: class_1']</code></pre>
</div>
</div>
<p>You might have noticed that instead of the actual names of the classes, you’re using <code>class_0</code>, <code>class_1</code>, etc. This is because I want to make the model prediction as “fair” as possible, see the baseline performance section for more details.</p>
<p>Then, you’ll create a message with the input images. This are the images for which the model will generate predictions.</p>
<p>Simlar to the context images message, you’re iterating over the test dataset and appending the images to the messages list.</p>
<div id="cell-33" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> create_input_images_message(df):</span>
<span id="cb11-2">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Input images:"</span>]</span>
<span id="cb11-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, image_path <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(df.image_path):</span>
<span id="cb11-4">        base64_img <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Image.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(image_path)</span>
<span id="cb11-5">        image_message <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb11-6">            base64_img,</span>
<span id="cb11-7">            <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"input_image_id: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb11-8">        ]</span>
<span id="cb11-9">        messages.extend(image_message)</span>
<span id="cb11-10">    messages.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Please correctly classify all </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> images."</span>)</span>
<span id="cb11-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> messages</span>
<span id="cb11-12"></span>
<span id="cb11-13">input_images_message <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> create_input_images_message(df_test)</span></code></pre></div>
</div>
<p>The resulting message will look something like this:</p>
<div id="cell-35" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1">input_images_message[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>['Input images:',
 &lt;PIL.JpegImagePlugin.JpegImageFile image mode=RGB size=224x224&gt;,
 'input_image_id: 0',
 &lt;PIL.JpegImagePlugin.JpegImageFile image mode=RGB size=224x224&gt;,
 'input_image_id: 1']</code></pre>
</div>
</div>
</section>
<section id="results" class="level3">
<h3 class="anchored" data-anchor-id="results">Results</h3>
<p>Now, you can combine the context images message and the input images message to create the contents you’ll pass to the model:</p>
<div id="cell-38" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1">contents <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> context_images_message <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> input_images_message</span>
<span id="cb14-2">response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> classification_model.generate_content(</span>
<span id="cb14-3">    contents<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>contents</span>
<span id="cb14-4">)</span>
<span id="cb14-5">response_json <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> json.loads(response.text)</span></code></pre></div>
</div>
<p>It’ll take a few seconds to run. But after that you’ll have a JSON response with the model’s predictions:</p>
<div id="cell-40" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1">response_json[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output"</span>][:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>[{'image_id': 0, 'confidence': 10, 'label': 'class_7'},
 {'image_id': 1, 'confidence': 10, 'label': 'class_2'},
 {'image_id': 2, 'confidence': 10, 'label': 'class_4'}]</code></pre>
</div>
</div>
<p>Then, you can calculate the accuracy and F1-score to evaluate the model’s performance:</p>
<div id="cell-42" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> calculate_metrics(df_test, response_json):</span>
<span id="cb17-2">    predictions <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [item[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'label'</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> item <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> response_json[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'output'</span>]]</span>
<span id="cb17-3">    accuracy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> accuracy_score(df_test.class_id, predictions)</span>
<span id="cb17-4">    f1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f1_score(df_test.class_id, predictions, average<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'weighted'</span>)</span>
<span id="cb17-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> accuracy, f1</span>
<span id="cb17-6"></span>
<span id="cb17-7">accuracy, f1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> calculate_metrics(df_test, response_json)</span>
<span id="cb17-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Accuracy: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>accuracy<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb17-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"F1-score: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>f1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Accuracy: 0.7333
F1-score: 0.7229</code></pre>
</div>
</div>
<p>Using a single image in the context per class, you should get an accuracy around 73% and F1-score around 72%.</p>
<p>Not bad, but you can probably do better.</p>
<section id="using-5-images-per-class-in-the-context" class="level4">
<h4 class="anchored" data-anchor-id="using-5-images-per-class-in-the-context">Using 5 images per class in the context</h4>
<p>One quick way to improve the performance of the model is to use more images per class in the context. Try with 5 images per class:</p>
<div id="cell-46" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1">df_train, df_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> create_datasets(TRAIN_DIR, TEST_DIR, selected_classes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>selected_classes, n_images_icl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb19-2"></span>
<span id="cb19-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create the context and input messages</span></span>
<span id="cb19-4">context_images_message <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> create_context_images_message(df_train)</span>
<span id="cb19-5">input_images_message <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> create_input_images_message(df_test)</span>
<span id="cb19-6">contents <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> context_images_message <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> input_images_message</span>
<span id="cb19-7"></span>
<span id="cb19-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate the response</span></span>
<span id="cb19-9">response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> classification_model.generate_content(</span>
<span id="cb19-10">    contents<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>contents</span>
<span id="cb19-11">)</span>
<span id="cb19-12">response_json <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> json.loads(response.text)</span>
<span id="cb19-13"></span>
<span id="cb19-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate the metrics</span></span>
<span id="cb19-15">accuracy, f1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> calculate_metrics(df_test, response_json)</span>
<span id="cb19-16"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Accuracy: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>accuracy<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb19-17"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"F1-score: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>f1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Accuracy: 0.9067
F1-score: 0.9013</code></pre>
</div>
</div>
<p>With this change, you should get an accuracy and F1-score around 90%.</p>
<p>Nice gains in performance for such a small change!</p>
</section>
</section>
<section id="data-leakage-and-baseline-performance" class="level3">
<h3 class="anchored" data-anchor-id="data-leakage-and-baseline-performance">Data leakage and baseline performance</h3>
<p>You might be thinking, “MLLMs have been trained on a lot of data, so they already know a lot of the images in the dataset, which means that these results are inflated”.</p>
<p>Which is a good point, and for that purpose I’ve done two things:</p>
<ol type="1">
<li>Anonymize the names of the classes (e.g., <code>class_0</code> instead of <code>Sleepy Orange</code>), so that the model doesn’t have any information about the actual labels.</li>
<li>Run a quick experiment using a zero-shot<sup>2</sup> model without anonymizing the labels to see the model’s performance.</li>
</ol>
<p>Here’s the code for the zero-shot baseline and the results:</p>
<div id="cell-49" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb21-1">possible_labels <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Possible labels: "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">", "</span>.join(df_train.class_name.unique().tolist())</span>
<span id="cb21-2">class_name_to_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(df_train[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'class_name'</span>], df_train[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'class_id'</span>]))</span>
<span id="cb21-3"></span>
<span id="cb21-4">response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> classification_model.generate_content(</span>
<span id="cb21-5">    contents<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[possible_labels] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> input_images_message</span>
<span id="cb21-6">)</span>
<span id="cb21-7">response_json <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> json.loads(response.text)</span>
<span id="cb21-8"></span>
<span id="cb21-9"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> item <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> response_json[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output"</span>]:</span>
<span id="cb21-10">    item[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'label'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> class_name_to_id.get(item[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'label'</span>], item[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'label'</span>])</span>
<span id="cb21-11"></span>
<span id="cb21-12">accuracy, f1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> calculate_metrics(df_test, response_json)</span>
<span id="cb21-13"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Accuracy: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>accuracy<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb21-14"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"F1-score: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>f1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Accuracy: 0.4800
F1-score: 0.4619</code></pre>
</div>
</div>
<p>You should get a 48% accuracy and a 46% F1-score. Both significantly higher than the ~7% you’d expect from random guessing, but still far from the 90%+ accuracy you obtained earlier.</p>
<p>This demonstrates that ICL can indeed enhance the model’s performance.</p>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>That’s all!</p>
<p>I still find it amazing that without any “real” training and just a few minutes of work, you can achieve pretty good results in a non-trivial image classification task using ICL with Gemini Flash 1.5 (or most other MLLMs).</p>
<p>This is a mostly unexplored area. There’s a lot of room for trying out different ideas and seeing what works best. This tutorial is just a starting point.</p>
<p>Hope you found it useful! Let me know if you have any questions in the comments below.</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Estimated costs as of September 8, 2024:</p>
<table class="table">
<thead>
<tr class="header">
<th>Model</th>
<th>Cost (512x512 image)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Gemini Flash 1.5</td>
<td>$0.000039</td>
</tr>
<tr class="even">
<td>Gemini Pro 1.5</td>
<td>$0.0018</td>
</tr>
<tr class="odd">
<td>GPT-4o</td>
<td>$0.000213 - $0.000638</td>
</tr>
<tr class="even">
<td>Sonnet 3.5</td>
<td>$0.001047</td>
</tr>
</tbody>
</table>
↩︎</li>
<li id="fn2"><p>That is, without providing any context images.↩︎</p></li>
</ol>
</section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2024,
  author = {Castillo, Dylan and Castillo, Dylan},
  title = {Classifying Images with {Gemini} {Flash} 1.5},
  date = {2024-09-08},
  url = {https://dylancastillo.co/posts/classify-images-with-gemini-flash-1.5.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2024" class="csl-entry quarto-appendix-citeas">
Castillo, Dylan, and Dylan Castillo. 2024. <span>“Classifying Images
with Gemini Flash 1.5.”</span> September 8, 2024. <a href="https://dylancastillo.co/posts/classify-images-with-gemini-flash-1.5.html">https://dylancastillo.co/posts/classify-images-with-gemini-flash-1.5.html</a>.
</div></div></section></div> ]]></description>
  <category>llm</category>
  <category>gemini</category>
  <guid>https://dylancastillo.co/posts/classify-images-with-gemini-flash-1.5.html</guid>
  <pubDate>Sun, 08 Sep 2024 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Fixing missing ‘python’ error in macOS</title>
  <dc:creator>Dylan Castillo</dc:creator>
  <link>https://dylancastillo.co/til/fixing-python-not-found-error-in-macos.html</link>
  <description><![CDATA[ 




<p>After the last macOS update, I started getting the following error when trying to run <code>poetry install</code>:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource shell number-lines code-with-copy"><code class="sourceCode"><span id="cb1-1">[Errno 2] No such file or directory: 'python'</span></code></pre></div>
<p>I went through GitHub issues, StackOverflow questions, and blog posts, but none of the suggested solutions worked.</p>
<p>Finally, I found the solution somewhat hidden in this <a href="https://mac.install.guide/python/brew">blog post</a>.</p>
<p>So, what’s the fix?</p>
<p>🥁 🥁 🥁</p>
<p>Just add the following line to your <code>.zshrc</code> file:</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">export</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">PATH</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$(</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">brew</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--prefix</span> python<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">)</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">/libexec/bin:</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$PATH</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span></code></pre></div>
<p>This gets the installation prefix for <code>python</code> installed via Homebrew (e.g.&nbsp;<code>/opt/homebrew/opt/python@3.12</code>), gets the <code>libexec/bin</code> directory, and adds it to the PATH.</p>
<p>In that <code>libexec/bin</code>, there’s a <code>python</code> executable that gets called when you run <code>python</code> in the terminal.</p>
<p>That’s all. Hope that helps!</p>



<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2024,
  author = {Castillo, Dylan},
  title = {Fixing Missing “Python” Error in {macOS}},
  date = {2024-08-12},
  url = {https://dylancastillo.co/til/fixing-python-not-found-error-in-macos.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2024" class="csl-entry quarto-appendix-citeas">
Castillo, Dylan. 2024. <span>“Fixing Missing <span>‘Python’</span> Error
in macOS.”</span> August 12, 2024. <a href="https://dylancastillo.co/til/fixing-python-not-found-error-in-macos.html">https://dylancastillo.co/til/fixing-python-not-found-error-in-macos.html</a>.
</div></div></section></div> ]]></description>
  <category>til</category>
  <category>python</category>
  <category>poetry</category>
  <guid>https://dylancastillo.co/til/fixing-python-not-found-error-in-macos.html</guid>
  <pubDate>Mon, 12 Aug 2024 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Create a Kamal-ready VPS on Hetzner using Terraform</title>
  <dc:creator>Dylan Castillo</dc:creator>
  <link>https://dylancastillo.co/posts/create-a-kamal-ready-vps-on-hetzner-using-terraform.html</link>
  <description><![CDATA[ 




<p>These days, I deploy all my side projects using Kamal and GitHub Actions on Hetzner. Once you get the hang of it, it’s easy to maintain, fast, and cheap.</p>
<p>You can run your app with a database (SQLite), caching (Redis), background jobs (Celery), and SSL certificates (Let’s Encrypt) for roughly €5/month. Plus, if you feel the need, you can easily scale up to a more powerful Virtual Private Server (VPS).</p>
<p>But setting up a VPS with the right configuration takes a bit of time. You have to:</p>
<ol type="1">
<li>Manually create the VPS using the UI.</li>
<li>Create the necessary SSH keys.</li>
<li>Create and apply the firewall rules.</li>
<li>Create a new non-root user.</li>
<li>Install Docker and other necessary software.</li>
<li>Configure unattended-upgrades.</li>
<li>Create a directory and set permissions for Let’s Encrypt SSL certificates.</li>
<li>Reboot the system to apply all changes.</li>
</ol>
<p>I already had a small script to do most of these steps, but I wanted to automate it to a single command. So I created a Terraform script to do it for me.</p>
<p>I took <a href="https://github.com/luizkowalski/terraform-hetzner">terraform-hetzner</a> and modified it to work with a single VPS instance. My updated version is available <a href="https://github.com/dylanjcastillo/terraform-kamal-single-vps">here</a>.</p>
<section id="set-up" class="level2">
<h2 class="anchored" data-anchor-id="set-up">Set up</h2>
<p>First, set up an <a href="https://docs.hetzner.com/cloud/api/getting-started/generating-api-token/">API key</a> with <strong>read and write</strong> permissions in Hetzner Cloud.</p>
<p>Second, install <a href="https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli">terraform</a>.</p>
<p>Third, clone the repo:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> clone https://github.com/dylanjcastillo/terraform-kamal-single-vps</span></code></pre></div>
<p>Fourth, create a <code>terraform.tfvars</code> file with the following variables:</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource hcl number-lines code-with-copy"><code class="sourceCode"><span id="cb2-1">hetzner_api_key = "your-api-key"</span>
<span id="cb2-2">ssh_vps_root_key = "&lt;your-ssh-root-public-key&gt;"</span>
<span id="cb2-3">ssh_vps_kamal_key = "&lt;your-ssh-kamal-public-key&gt;"</span></code></pre></div>
<p>The <code>ssh_vps_root_key</code> and <code>ssh_vps_kamal_key</code> are the public keys for the root and kamal users, respectively. You can generate them with the <code>make generate-ssh-key USER_NAME=root</code> or <code>make generate-ssh-key USER_NAME=kamal</code> commands I added to the repo.</p>
<p>Store your SSH keys in a secure location. You’ll need them to access the VPS.</p>
</section>
<section id="run-the-script" class="level2">
<h2 class="anchored" data-anchor-id="run-the-script">Run the script</h2>
<p>Once the <code>terraform.tfvars</code> file is set up, you can see what changes will be applied with the following command:</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">terraform</span> plan</span></code></pre></div>
<p>This will show in detail what changes will be applied to create a Kamal-ready VPS. If you’re happy with it, you can apply the changes with the following command:</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">terraform</span> apply</span></code></pre></div>
<p>This will create a VPS with the following configuration:</p>
<ul>
<li>Ubuntu 22.04 LTS</li>
<li>2 VCPU</li>
<li>2 GB RAM</li>
<li>40 GB SSD</li>
</ul>
<p>It’ll cost you roughly €5/month and will be located in Nuremberg (Germany).</p>
<p>In addition, after the VPS is created, it will automatically:</p>
<ul>
<li>Create a non-root user (kamal) with sudo privileges.</li>
<li>Install the required software (Git, Docker, curl, etc.)</li>
<li>Create a directory for Let’s Encrypt SSL certificates.</li>
<li>Create a firewall rule to allow HTTP, HTTPS, and SSH traffic.</li>
<li>Create a directory for the database (SQLite) and the cache (Redis) (<code>db/</code> and <code>data/</code>)</li>
</ul>
</section>
<section id="customizing-the-script" class="level2">
<h2 class="anchored" data-anchor-id="customizing-the-script">Customizing the script</h2>
<p>You can customize the script to fit your needs. Here are a couple of things you can change:</p>
<section id="change-the-software-to-install" class="level3">
<h3 class="anchored" data-anchor-id="change-the-software-to-install">Change the software to install</h3>
<p>If you want to change the software to install, you can modify the <code>packages</code> section in <code>cloudinit/vps.yml</code>.</p>
</section>
<section id="run-other-commands-after-the-vps-is-created" class="level3">
<h3 class="anchored" data-anchor-id="run-other-commands-after-the-vps-is-created">Run other commands after the VPS is created</h3>
<p>If you want to run other commands after the VPS is created, you can add them to the <code>runcmd</code> section in the <code>cloudinit/vps.yml</code> file.</p>
</section>
<section id="use-already-existing-firewall-rules" class="level3">
<h3 class="anchored" data-anchor-id="use-already-existing-firewall-rules">Use already existing firewall rules</h3>
<p>If you want to use already existing firewall rules, you can modify how the firewalls are attached in <code>cloud.tf</code>. Take a look at <a href="https://github.com/dylanjcastillo/terraform-kamal-single-vps/blob/4a1a6edafc1c9e927f20906298ccd083718bc97e/cloud.tf#L72C1-L91C4">this section</a> of <code>cloud.tf</code>.</p>
</section>
<section id="use-a-different-server-type-operating-system-or-region" class="level3">
<h3 class="anchored" data-anchor-id="use-a-different-server-type-operating-system-or-region">Use a different server type, operating system, or region</h3>
<p>If you want to use a different server type, operating system, or region, you can modify the <code>server_type</code>, <code>region</code>, <code>operating_system</code> variables in <code>variables.tf</code>.</p>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>This script is a great way to create a Kamal-ready VPS on Hetzner using Terraform. It’s easy to maintain, fast, and cheap.</p>
<p>All the code is available in the <a href="https://github.com/dylanjcastillo/terraform-kamal-single-vps">repo</a>.</p>
<p>Hope you find this useful!</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2024,
  author = {Castillo, Dylan and Castillo, Dylan},
  title = {Create a {Kamal-ready} {VPS} on {Hetzner} Using {Terraform}},
  date = {2024-08-11},
  url = {https://dylancastillo.co/posts/create-a-kamal-ready-vps-on-hetzner-using-terraform.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2024" class="csl-entry quarto-appendix-citeas">
Castillo, Dylan, and Dylan Castillo. 2024. <span>“Create a Kamal-Ready
VPS on Hetzner Using Terraform.”</span> August 11, 2024. <a href="https://dylancastillo.co/posts/create-a-kamal-ready-vps-on-hetzner-using-terraform.html">https://dylancastillo.co/posts/create-a-kamal-ready-vps-on-hetzner-using-terraform.html</a>.
</div></div></section></div> ]]></description>
  <category>kamal</category>
  <category>hetzner</category>
  <category>terraform</category>
  <guid>https://dylancastillo.co/posts/create-a-kamal-ready-vps-on-hetzner-using-terraform.html</guid>
  <pubDate>Sun, 11 Aug 2024 00:00:00 GMT</pubDate>
</item>
<item>
  <title>A Dockerfile for a Django app using Poetry</title>
  <dc:creator>Dylan Castillo</dc:creator>
  <link>https://dylancastillo.co/til/django-poetry-dockerfile.html</link>
  <description><![CDATA[ 




<p><a href="https://levels.io/">Pieter Levels</a> makes over $100k/month with a single VPS using PHP and jQuery. And until very recently, his deployment process was simply <a href="https://news.ycombinator.com/item?id=28838537">uploading files via FTP</a>.</p>
<p>If you focus on what your users want and know how to market your product, you can make a lot of money.</p>
<p>Which is why I decided to stay poor and spent an inordinate amount of time improving my deployment process.</p>
<p>Who needs money when you can get the satisfaction of that beautiful green check mark after you’ve run your CI/CD pipeline?</p>
<p>Anyways…</p>
<p>These days, I’m using <a href="https://kamal-deploy.org/">kamal</a> to deploy most of my projects.</p>
<p>I used to hate Docker. But, like with Gollum, I’ve come to realize that it’s not that bad after all.</p>
<p>I wanted to create a simple Dockerfile to run a Django app using Poetry, with a SQLite database, and hot reload. Additionally, I wanted to switch between the development and production versions of the container.</p>
<p>So here’s a simple Dockerfile that does just that.</p>
<section id="project-structure" class="level2">
<h2 class="anchored" data-anchor-id="project-structure">Project structure</h2>
<p>This is my project structure:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">.</span></span>
<span id="cb1-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">├──</span> db/</span>
<span id="cb1-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">├──</span> src/</span>
<span id="cb1-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">├──</span> entrypoint.sh</span>
<span id="cb1-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">├──</span> Dockerfile</span>
<span id="cb1-6"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">├──</span> docker-compose.yml</span>
<span id="cb1-7"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">├──</span> poetry.lock</span>
<span id="cb1-8"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">└──</span> pyproject.toml</span></code></pre></div>
<p>The <code>src/</code> directory contains the Django project. The <code>db/</code> directory contains the SQLite database. The <code>entrypoint.sh</code> file is the entrypoint for the Docker container.</p>
<p>If your project is not structured in a similar way, you might need to adapt the files below to your needs.</p>
</section>
<section id="dockerfile" class="level2">
<h2 class="anchored" data-anchor-id="dockerfile">Dockerfile</h2>
<p>I created a <code>Dockerfile</code> that fulfilled this:</p>
<ol type="1">
<li>A base stage with Python 3.10 and Poetry installed.</li>
<li>A builder stage that installs the dependencies.</li>
<li>A runner stage that copies the virtual environment from the builder stage.</li>
<li>A development stage that runs the entrypoint as a root user.</li>
<li>A production stage that runs the entrypoint as a non-root user.</li>
</ol>
<p>Here’s the full <code>Dockerfile</code>:</p>
<details>
<summary>
Dockerfile
</summary>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource dockerfile number-lines code-with-copy"><code class="sourceCode dockerfile"><span id="cb2-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">FROM</span> python:3.10-slim <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AS</span> base</span>
<span id="cb2-2"></span>
<span id="cb2-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ENV</span> POETRY_HOME=/opt/poetry</span>
<span id="cb2-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ENV</span> PATH=${POETRY_HOME}/bin:${PATH}</span>
<span id="cb2-5"></span>
<span id="cb2-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">RUN</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">apt-get</span> update <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb2-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">apt-get</span> install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--no-install-recommends</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-y</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb2-8">    curl <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb2-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">apt-get</span> clean <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb2-10">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rm</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-rf</span> /var/lib/apt/lists/<span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb2-11"></span>
<span id="cb2-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">RUN</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">curl</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-sSL</span> https://install.python-poetry.org <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">|</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python3</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">&amp;&amp;</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">poetry</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--version</span></span>
<span id="cb2-13"></span>
<span id="cb2-14"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">FROM</span> base <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AS</span> builder</span>
<span id="cb2-15"></span>
<span id="cb2-16"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">WORKDIR</span> /app</span>
<span id="cb2-17"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">COPY</span> poetry.lock pyproject.toml ./</span>
<span id="cb2-18"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">RUN</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">poetry</span> config virtualenvs.in-project true</span>
<span id="cb2-19"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">RUN</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">poetry</span> install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--only</span> main <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--no-interaction</span></span>
<span id="cb2-20"></span>
<span id="cb2-21"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">FROM</span> base <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AS</span> runner</span>
<span id="cb2-22"></span>
<span id="cb2-23"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">WORKDIR</span> /app</span>
<span id="cb2-24"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">COPY</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--from=builder</span> /app/.venv/ /app/.venv/</span>
<span id="cb2-25"></span>
<span id="cb2-26"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">COPY</span> . /app</span>
<span id="cb2-27"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">RUN</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mkdir</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-p</span> /db</span>
<span id="cb2-28"></span>
<span id="cb2-29"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">EXPOSE</span> 8000</span>
<span id="cb2-30"></span>
<span id="cb2-31"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">RUN</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chmod</span> +x /app/src/entrypoint.sh</span>
<span id="cb2-32"></span>
<span id="cb2-33"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">FROM</span> runner <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AS</span> development</span>
<span id="cb2-34"></span>
<span id="cb2-35"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">WORKDIR</span> /app/src</span>
<span id="cb2-36"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ENTRYPOINT</span> [ <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/app/src/entrypoint.sh"</span> ]</span>
<span id="cb2-37"></span>
<span id="cb2-38"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">FROM</span> runner <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AS</span> production</span>
<span id="cb2-39"></span>
<span id="cb2-40"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set user and group</span></span>
<span id="cb2-41"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ARG</span> user=django</span>
<span id="cb2-42"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ARG</span> group=django</span>
<span id="cb2-43"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ARG</span> uid=1000</span>
<span id="cb2-44"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ARG</span> gid=1000</span>
<span id="cb2-45"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">RUN</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">groupadd</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-g</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${gid}</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${group}</span></span>
<span id="cb2-46"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">RUN</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">useradd</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-u</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${uid}</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-g</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${group}</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-s</span> /bin/sh <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${user}</span></span>
<span id="cb2-47"></span>
<span id="cb2-48"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Switch to user</span></span>
<span id="cb2-49"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">RUN</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chown</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-R</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${uid}</span>:<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${gid}</span> /app</span>
<span id="cb2-50"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">RUN</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chown</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-R</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${uid}</span>:<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${gid}</span> /db</span>
<span id="cb2-51"></span>
<span id="cb2-52"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">USER</span> ${uid}:${gid}</span>
<span id="cb2-53"></span>
<span id="cb2-54"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">WORKDIR</span> /app/src</span>
<span id="cb2-55"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ENTRYPOINT</span> [ <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/app/src/entrypoint.sh"</span> ]</span></code></pre></div>
</details>
</section>
<section id="entrypoint" class="level2">
<h2 class="anchored" data-anchor-id="entrypoint">Entrypoint</h2>
<p>For <code>entrypoint.sh</code> I use this:</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#!/bin/sh</span></span>
<span id="cb3-2"></span>
<span id="cb3-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">[</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$ENVIRONMENT</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"production"</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">]</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">;</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">then</span></span>
<span id="cb3-4">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Running in production mode"</span></span>
<span id="cb3-5">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">exec</span> poetry run gunicorn <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-c</span> gunicorn.conf.py</span>
<span id="cb3-6"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">[</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$ENVIRONMENT</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"development"</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">]</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">;</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">then</span></span>
<span id="cb3-7">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Running in development mode"</span></span>
<span id="cb3-8">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">exec</span> poetry run python manage.py runserver 0.0.0.0:8000</span>
<span id="cb3-9"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span></span>
<span id="cb3-10">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ENVIRONMENT variable is not set"</span></span>
<span id="cb3-11"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fi</span></span></code></pre></div>
<p>If <code>ENVIRONMENT</code> is set to <code>production</code>, the container will run the production server using gunicorn. If it is <code>development</code>, the container will run Django’s development server.</p>
</section>
<section id="docker-compose" class="level2">
<h2 class="anchored" data-anchor-id="docker-compose">Docker-compose</h2>
<p>Then, I have a docker-compose that lets you run the development and production containers:</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource yaml number-lines code-with-copy"><code class="sourceCode yaml"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">services</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb4-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">app</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb4-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">build</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb4-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">context</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> .</span></span>
<span id="cb4-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">target</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> ${ENVIRONMENT}</span></span>
<span id="cb4-6"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">platform</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> linux/amd64</span></span>
<span id="cb4-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">environment</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb4-8"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY}</span></span>
<span id="cb4-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> DJANGO_DEBUG=${DJANGO_DEBUG}</span></span>
<span id="cb4-10"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> DJANGO_SECURE_SSL_REDIRECT=${DJANGO_SECURE_SSL_REDIRECT}</span></span>
<span id="cb4-11"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> DJANGO_SECURE_HSTS_SECONDS=${DJANGO_SECURE_HSTS_SECONDS}</span></span>
<span id="cb4-12"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> DJANGO_SECURE_HSTS_INCLUDE_SUBDOMAINS=${DJANGO_SECURE_HSTS_INCLUDE_SUBDOMAINS}</span></span>
<span id="cb4-13"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> DJANGO_SECURE_HSTS_PRELOAD=${DJANGO_SECURE_HSTS_PRELOAD}</span></span>
<span id="cb4-14"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> DJANGO_SESSION_COOKIE_SECURE=${DJANGO_SESSION_COOKIE_SECURE}</span></span>
<span id="cb4-15"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> DJANGO_CSRF_COOKIE_SECURE=${DJANGO_CSRF_COOKIE_SECURE}</span></span>
<span id="cb4-16"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> CACHE_REDIS_URL=${CACHE_REDIS_URL}</span></span>
<span id="cb4-17"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> ENVIRONMENT=${ENVIRONMENT}</span></span>
<span id="cb4-18"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">env_file</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb4-19"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> .env</span></span>
<span id="cb4-20"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ports</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb4-21"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"8000:8000"</span></span>
<span id="cb4-22"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">volumes</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb4-23"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"./db/:/app/db/"</span></span>
<span id="cb4-24"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">develop</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb4-25"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">watch</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb4-26"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">action</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> sync</span></span>
<span id="cb4-27"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">path</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> ./src/</span></span>
<span id="cb4-28"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">target</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> /app/src</span></span>
<span id="cb4-29"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">        </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">action</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> rebuild</span></span>
<span id="cb4-30"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">          </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">path</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> pyproject.toml</span></span></code></pre></div>
<p>In this <code>docker-compose</code>, I use <code>ENVIRONMENT</code> to switch between the development and production containers.</p>
<p>I also use the <a href="https://docs.docker.com/compose/file-watch/">Compose Watch</a> to reload the container when I make changes to the code and to rebuild the container when I make changes to the <code>pyproject.toml</code> file.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>That’s it. I hope you find this useful.</p>
<p>And remember, while Pieter is busy counting his cash, here you are counting the number of successful builds.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2024,
  author = {Castillo, Dylan},
  title = {A {Dockerfile} for a {Django} App Using {Poetry}},
  date = {2024-06-22},
  url = {https://dylancastillo.co/til/django-poetry-dockerfile.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2024" class="csl-entry quarto-appendix-citeas">
Castillo, Dylan. 2024. <span>“A Dockerfile for a Django App Using
Poetry.”</span> June 22, 2024. <a href="https://dylancastillo.co/til/django-poetry-dockerfile.html">https://dylancastillo.co/til/django-poetry-dockerfile.html</a>.
</div></div></section></div> ]]></description>
  <category>til</category>
  <category>python</category>
  <category>django</category>
  <guid>https://dylancastillo.co/til/django-poetry-dockerfile.html</guid>
  <pubDate>Sat, 22 Jun 2024 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Migrate a blog from Ghost to Quarto</title>
  <dc:creator>Dylan Castillo</dc:creator>
  <link>https://dylancastillo.co/til/migrate-blog-from-ghost-to-quarto.html</link>
  <description><![CDATA[ 




<p>When I started blogging five years ago, I read all reddit posts comparing blogging platforms and concluded that <a href="https://ghost.org/">Ghost</a> was the best choice because I needed a powerful tool for all those millions of visitors my blog would get.</p>
<p>I saw myself as the <a href="https://es.wikipedia.org/wiki/Gabriel_Garc%C3%ADa_M%C3%A1rquez">García Márquez</a> of technical writing.</p>
<p>Fast forward five years, and I’ve paid $2,000 for hosting a blog that barely gets 8k visits per month. Plus, I’m forced to write it in an interface that I hate.</p>
<p>With that kind of money, I could have funded a moderately extravagant hamster-only summer party.</p>
<p>Not that I should, but I could.</p>
<p>Yes, I’m not proud of that decision<sup>1</sup>. So I’m migrating my blog from Ghost to Quarto.</p>
<p>Here’s a short guide on how to migrate your blog from Ghost to Quarto.</p>
<section id="migrate-blog-from-ghost-to-quarto" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="migrate-blog-from-ghost-to-quarto">Migrate blog from Ghost to Quarto</h2>
<section id="setting-up-your-blog" class="level3">
<h3 class="anchored" data-anchor-id="setting-up-your-blog">Setting up your blog</h3>
<p>First, install <a href="https://quarto.org/">Quarto</a> and create a blog in an empty repository:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">quarto</span> create project blog myblog</span></code></pre></div>
<p>The resulting <code>myblog</code> folder will contain the barebones configuration for a Quarto blog and a <code>posts</code> folder with some example posts. You can remove those posts. Later on, you’ll add your own.</p>
</section>
<section id="exporting-your-ghosts-blog-content" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="exporting-your-ghosts-blog-content">Exporting your Ghost’s blog content</h3>
<p>Then, you need to download a copy of your Ghost’s blog content.</p>
<p>Go to <code>&lt;YOUR_BLOG_URL&gt;/ghost/#/settings/migration</code> and click on <code>Export</code>, then <code>Export JSON</code>.</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><a href="images/ghost-export.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="Exporting my blog"><img src="https://dylancastillo.co/til/images/ghost-export.png" class="img-fluid figure-img" alt="Exporting my blog"></a></p>
<figcaption class="margin-caption">Exporting my blog</figcaption>
</figure>
</div>
<p>This is pretty obvious, but remember to replace <code>&lt;YOUR_BLOG_URL&gt;</code> with your blog’s URL.</p>
<p>You’ll get a JSON file with all the posts and pages in your blog. You’ll need to process it to convert your posts to Quarto posts.</p>
<p>This small Python script did the heavy lifting for me:</p>
<details>
<summary>
Show the code
</summary>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> json</span>
<span id="cb2-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> datetime <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> datetime</span>
<span id="cb2-4"></span>
<span id="cb2-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> requests</span>
<span id="cb2-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> bs4 <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> BeautifulSoup</span>
<span id="cb2-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> markdownify <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> markdownify <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> md</span>
<span id="cb2-8"></span>
<span id="cb2-9"></span>
<span id="cb2-10">BLOG_URL <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://dylancastillo.co"</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Replace with your blog's URL</span></span>
<span id="cb2-11">BLOG_JSON_DUMP <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"./dylan-castillo.ghost.2024-05-28-10-39-09.json"</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Replace with the path to the JSON file you downloaded</span></span>
<span id="cb2-12">BLOG_AUTHOR_NAME <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Dylan Castillo"</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Replace with your name</span></span>
<span id="cb2-13"></span>
<span id="cb2-14"></span>
<span id="cb2-15"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> download_images(markdown_content, post_slug):</span>
<span id="cb2-16">    soup <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> BeautifulSoup(markdown_content, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"html.parser"</span>)</span>
<span id="cb2-17">    images <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> soup.find_all(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"img"</span>)</span>
<span id="cb2-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> images:</span>
<span id="cb2-19">        os.makedirs(post_slug, exist_ok<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb2-20">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> img <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> images:</span>
<span id="cb2-21">            img_url_raw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> img[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"src"</span>]</span>
<span id="cb2-22">            img_url <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> img_url_raw.replace(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"__GHOST_URL__"</span>, BLOG_URL)</span>
<span id="cb2-23">            img_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> os.path.basename(img_url)</span>
<span id="cb2-24">            response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> requests.get(img_url, stream<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb2-25">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> response.status_code <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>:</span>
<span id="cb2-26">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Downloading image: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>img_url<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> to </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>post_slug<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">/</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>img_name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb2-27">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(os.path.join(post_slug, img_name), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"wb"</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> f:</span>
<span id="cb2-28">                    f.write(response.content)</span>
<span id="cb2-29">                markdown_content <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> markdown_content.replace(</span>
<span id="cb2-30">                    img_url_raw, os.path.join(post_slug, img_name)</span>
<span id="cb2-31">                )</span>
<span id="cb2-32">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb2-33">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Failed to download image: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>img_url<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb2-34">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> markdown_content</span>
<span id="cb2-35"></span>
<span id="cb2-36"></span>
<span id="cb2-37"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> process_posts(data):</span>
<span id="cb2-38">    posts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"db"</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data"</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"posts"</span>]</span>
<span id="cb2-39">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> post <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> posts:</span>
<span id="cb2-40">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Processing post:"</span>, post[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"title"</span>])</span>
<span id="cb2-41">        title <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> post[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"title"</span>]</span>
<span id="cb2-42">        description <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> post[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"custom_excerpt"</span>]</span>
<span id="cb2-43">        author <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> BLOG_AUTHOR_NAME</span>
<span id="cb2-44">        date <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb2-45">            datetime.strptime(post[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"published_at"</span>], <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%Y-%m-</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%d</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">T%H:%M:%S.</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%f</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Z"</span>).strftime(</span>
<span id="cb2-46">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%m/</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%d</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">/%Y"</span></span>
<span id="cb2-47">            )</span>
<span id="cb2-48">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> post[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"published_at"</span>]</span>
<span id="cb2-49">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span></span>
<span id="cb2-50">        )</span>
<span id="cb2-51">        date_modified <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb2-52">            datetime.strptime(post[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"updated_at"</span>], <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%Y-%m-</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%d</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">T%H:%M:%S.</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%f</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Z"</span>).strftime(</span>
<span id="cb2-53">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%m/</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%d</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">/%Y"</span></span>
<span id="cb2-54">            )</span>
<span id="cb2-55">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> post[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"updated_at"</span>]</span>
<span id="cb2-56">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span></span>
<span id="cb2-57">        )</span>
<span id="cb2-58"></span>
<span id="cb2-59">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert HTML content to Markdown</span></span>
<span id="cb2-60">        markdown_content <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> download_images(</span>
<span id="cb2-61">            post[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"html"</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> post[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"html"</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, post[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"slug"</span>]</span>
<span id="cb2-62">        )</span>
<span id="cb2-63">        markdown_content <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> md(markdown_content, code_language<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"python"</span>)</span>
<span id="cb2-64">        markdown_content <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> markdown_content.replace(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"__GHOST_URL__"</span>, BLOG_URL)</span>
<span id="cb2-65">        markdown_content <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"""---</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">title: "</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>title<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">description: "</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>description<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">author: "</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>author<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">date: "</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>date<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">date-modified: "</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>date_modified<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">---</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>markdown_content<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb2-66"></span>
<span id="cb2-67">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save the markdown content to a file</span></span>
<span id="cb2-68">        filename <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>post[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'slug'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">.md"</span></span>
<span id="cb2-69">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(filename, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"w"</span>, encoding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"utf-8"</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">file</span>:</span>
<span id="cb2-70">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">file</span>.write(markdown_content)</span>
<span id="cb2-71"></span>
<span id="cb2-72"></span>
<span id="cb2-73"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">__name__</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"__main__"</span>:</span>
<span id="cb2-74">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(BLOG_JSON_DUMP) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">file</span>:</span>
<span id="cb2-75">        data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> json.load(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">file</span>)</span>
<span id="cb2-76">    process_posts(data)</span></code></pre></div>
</details>
<p>When you run the script, it will create a folder with all the posts in .md format and their images. Feel free to adapt it to your needs.</p>
</section>
<section id="customizing-your-blog" class="level3">
<h3 class="anchored" data-anchor-id="customizing-your-blog">Customizing your blog</h3>
<p>Through trial and error, I found some settings that helped me customize the look and feel of my blog.</p>
<p>Here are some of the things I modified:</p>
<ol type="1">
<li>Added RSS, favicon, and customized the navbar:</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>_quarto.yml</strong></pre>
</div>
<div class="sourceCode" id="cb3" data-filename="_quarto.yml" style="background: #f1f3f5;"><pre class="sourceCode numberSource yml number-lines code-with-copy"><code class="sourceCode yaml"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">website</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb3-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">title</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> # The title of your blog</span></span>
<span id="cb3-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">site-url</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> # For the RSS feed that no one will read</span></span>
<span id="cb3-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">favicon</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> # Add a favicon to the blog</span></span>
<span id="cb3-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">navbar</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> # Customize the navbar if you want</span></span>
<span id="cb3-6"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">page-footer</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> # Add a page footer like "Copyright 2024, Saul Goodman" to sound legit</span></span></code></pre></div>
</div>
<ol start="2" type="1">
<li>Added custom CSS and JS and a custom theme:</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>_quarto.yml</strong></pre>
</div>
<div class="sourceCode" id="cb4" data-filename="_quarto.yml" style="background: #f1f3f5;"><pre class="sourceCode numberSource yml number-lines code-with-copy"><code class="sourceCode yaml"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">format</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb4-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb4-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">include-in-header</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb4-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">      - </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">text</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">|</span></span>
<span id="cb4-5">          &lt;link href="&lt;YOUR_CUSTOM_FONT_URL&gt;" rel="stylesheet"&gt;</span>
<span id="cb4-6">          &lt;script src="&lt;YOUR_CUSTOM_JS_URL&gt;" defer&gt;&lt;/script&gt;</span>
<span id="cb4-7"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">page-layout</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"article"</span></span>
<span id="cb4-8"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> # Pick a theme and customize it in `custom.scss`</span></span>
<span id="cb4-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> &lt;YOUR_THEME&gt;</span></span>
<span id="cb4-10"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">      </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> custom.scss</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> # Add your custom CSS here</span></span>
<span id="cb4-11"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">code-line-numbers</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">true</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> # Add line numbers to code blocks</span></span></code></pre></div>
</div>
<ol start="3" type="1">
<li>For each post, I used this front matter:</li>
</ol>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>&lt;POST_SLUG&gt;.md</strong></pre>
</div>
<div class="sourceCode" id="cb5" data-filename="<POST_SLUG>.md" style="background: #f1f3f5;"><pre class="sourceCode numberSource yml number-lines code-with-copy"><code class="sourceCode yaml"><span id="cb5-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">---</span></span>
<span id="cb5-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">title</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;POST_TITLE&gt;"</span></span>
<span id="cb5-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aliases</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb5-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> /&lt;POST_SLUG&gt;/</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> # Add an alias to the previous post's URL</span></span>
<span id="cb5-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">description-meta</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;POST_DESCRIPTION&gt;"</span></span>
<span id="cb5-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">date</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;POST_DATE&gt;"</span></span>
<span id="cb5-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">date-modified</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> last-modified</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> # Automatically set to the last modified date</span></span>
<span id="cb5-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">toc</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">true</span></span>
<span id="cb5-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">toc-depth</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb5-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lightbox</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">true</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> # For images</span></span>
<span id="cb5-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fig-cap-location</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> margin</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> # Captions for images</span></span>
<span id="cb5-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">categories</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb5-13"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> &lt;CATEGORY&gt;</span></span>
<span id="cb5-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">author</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb5-15"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">name</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> &lt;AUTHOR_NAME&gt;</span></span>
<span id="cb5-16"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">url</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> &lt;AUTHOR_URL&gt;</span></span>
<span id="cb5-17"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">affiliation</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> &lt;AUTHOR_AFFILIATION&gt;</span></span>
<span id="cb5-18"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">affiliation-url</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> &lt;AUTHOR_AFFILIATION_URL&gt;</span></span>
<span id="cb5-19"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">citation</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">true</span></span>
<span id="cb5-20"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">comments</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb5-21"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">utterances</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> # For comments</span></span>
<span id="cb5-22"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">repo</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> &lt;YOUR_GITHUB_USERNAME&gt;/&lt;YOUR_GITHUB_REPO&gt;</span></span>
<span id="cb5-23"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">issue-term</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> pathname</span></span>
<span id="cb5-24"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">---</span></span></code></pre></div>
</div>
<p>See my <a href="https://github.com/dylanjcastillo/blog/blob/main/_quarto.yml">settings</a> for an example and a recent post <a href="https://github.com/dylanjcastillo/blog/blob/main/posts/create-a-kamal-ready-vps-on-hetzner-using-terraform.qmd">source</a> for reference.</p>
<p>For the CSS, I copied <a href="https://github.com/quarto-dev/quarto-cli/blob/main/src/resources/formats/html/bootstrap/themes/darkly.scss">darkly</a> and created a custom <code>custom.scss</code> file to modify some Bootstrap styles. I just changed some colors and a couple of styles to make the blog look closer to my Ghost theme. It was super easy.</p>
</section>
<section id="deployment-using-github-pages-github-actions" class="level3">
<h3 class="anchored" data-anchor-id="deployment-using-github-pages-github-actions">Deployment using GitHub Pages + GitHub Actions</h3>
<p>Quarto offers multiple <a href="https://quarto.org/docs/publishing/">deployment options</a>. I wanted one where I could push changes to a GitHub repository, and have the blog automatically deployed. I went with GitHub Pages combined with GitHub Actions.</p>
<p>To deploy the blog, I created a <a href="https://github.com/dylanjcastillo/blog">GitHub repository</a>, added the blog’s content, updated <code>.gitignore</code> to ignore the <code>/.quarto/</code> and <code>/_site/</code> and updated <code>_quarto.yml</code> to only compute code locally (otherwise you’d need a Python kernel running on your GitHub Actions runner):</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>_quarto.yml</strong></pre>
</div>
<div class="sourceCode" id="cb6" data-filename="_quarto.yml" style="background: #f1f3f5;"><pre class="sourceCode numberSource yml number-lines code-with-copy"><code class="sourceCode yaml"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">execute</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb6-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">freeze</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> auto</span></span></code></pre></div>
</div>
<p>Then I ran this command to automatically generate the workflow <code>.github/workflows/publish.yml</code> for me:</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">quarto</span> publish gh-pages</span></code></pre></div>
<p>Since then, every time I push changes to the <code>main</code> branch, GitHub Actions automatically renders the website and updates the <code>gh-pages</code> branch.</p>
</section>
<section id="using-a-custom-domain" class="level3">
<h3 class="anchored" data-anchor-id="using-a-custom-domain">Using a custom domain</h3>
<p>That seemed to work at first, but very quickly I noticed that whenever I pushed changes to the <code>main</code> branch, the site would no longer be served from my custom domain <a href="https://dylancastillo.co">dylancastillo.co</a>.</p>
<p>When you render your website, Quarto recreates the CNAME file in the <code>gh-pages</code> branch, which seems to break the custom domain setup in GitHub Pages.</p>
<p>I found a solution in this <a href="https://github.com/quarto-dev/quarto-cli/discussions/5341">discussion</a> and added a CNAME file to the root of the repository with my custom domain:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>CNAME</strong></pre>
</div>
<div class="sourceCode" id="cb8" data-filename="CNAME" style="background: #f1f3f5;"><pre class="sourceCode numberSource txt number-lines code-with-copy"><code class="sourceCode default"><span id="cb8-1">dylancastillo.co</span></code></pre></div>
</div>
<p>Then, I added this to <code>_quarto.yml</code>:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>_quarto.yml</strong></pre>
</div>
<div class="sourceCode" id="cb9" data-filename="_quarto.yml" style="background: #f1f3f5;"><pre class="sourceCode numberSource yml number-lines code-with-copy"><code class="sourceCode yaml"><span id="cb9-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">project</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span></span>
<span id="cb9-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">type</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> website</span></span>
<span id="cb9-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">  </span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">resources</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> # New</span></span>
<span id="cb9-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">    </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">-</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;"> CNAME</span></span></code></pre></div>
</div>
<p>And that worked!</p>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>There you go, my friend.</p>
<p>Now you can also break free from Ghost.</p>
<p>See you in the next post.</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Choosing Ghost. No regrets about the hypothetical hamster party.↩︎</p></li>
</ol>
</section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2024,
  author = {Castillo, Dylan},
  title = {Migrate a Blog from {Ghost} to {Quarto}},
  date = {2024-06-16},
  url = {https://dylancastillo.co/til/migrate-blog-from-ghost-to-quarto.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2024" class="csl-entry quarto-appendix-citeas">
Castillo, Dylan. 2024. <span>“Migrate a Blog from Ghost to
Quarto.”</span> June 16, 2024. <a href="https://dylancastillo.co/til/migrate-blog-from-ghost-to-quarto.html">https://dylancastillo.co/til/migrate-blog-from-ghost-to-quarto.html</a>.
</div></div></section></div> ]]></description>
  <category>til</category>
  <category>quarto</category>
  <guid>https://dylancastillo.co/til/migrate-blog-from-ghost-to-quarto.html</guid>
  <pubDate>Sun, 16 Jun 2024 00:00:00 GMT</pubDate>
</item>
</channel>
</rss>
