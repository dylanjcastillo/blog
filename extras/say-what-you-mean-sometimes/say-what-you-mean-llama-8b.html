<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>GSM8K – Dylan Castillo</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../logo.webp" rel="icon">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark-d166b450ba5a8e9f7a0ab969bf6592c1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-a4c2714d643bba16a42772a6f5e54e5d.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="dark">
<script src="../../site_libs/quarto-contrib/iconify-2.1.0/iconify-icon.min.js"></script>
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;0,900;1,300;1,400;1,700;1,900&amp;display=swap" rel="stylesheet">
<script src="https://cdn.usefathom.com/script.js" data-site="ZJFQREIA" defer=""></script>


<meta property="og:title" content="GSM8K – Dylan Castillo">
<meta property="og:image" content="https://dylancastillo.co/social_media_card.webp">
<meta property="og:site_name" content="Dylan Castillo">
<meta name="twitter:title" content="GSM8K – Dylan Castillo">
<meta name="twitter:image" content="https://dylancastillo.co/social_media_card.webp">
<meta name="twitter:site" content="@dylanjcastillo">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html"> 
<span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/dylanjcastillo"> 
<span class="menu-text"><iconify-icon role="img" inline="" icon="fa6-brands:github" aria-label="Icon github from fa6-brands Iconify.design set." title="Icon github from fa6-brands Iconify.design set."></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.linkedin.com/in/dylanjcastillo/"> 
<span class="menu-text"><iconify-icon role="img" inline="" icon="fa6-brands:linkedin" aria-label="Icon linkedin from fa6-brands Iconify.design set." title="Icon linkedin from fa6-brands Iconify.design set."></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://bsky.app/profile/dylancastillo.co"> 
<span class="menu-text"><iconify-icon role="img" inline="" icon="fa6-brands:bluesky" aria-label="Icon bluesky from fa6-brands Iconify.design set." title="Icon bluesky from fa6-brands Iconify.design set."></iconify-icon></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">GSM8K</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div id="18dc8ee3" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a><span class="op">%</span>load_ext autoreload</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="op">%</span>autoreload <span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="33194d54-582b-4b81-a195-8f1269a438a7" class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2024-11-17T20:37:59.673511Z&quot;,&quot;iopub.status.busy&quot;:&quot;2024-11-17T20:37:59.673328Z&quot;,&quot;iopub.status.idle&quot;:&quot;2024-11-17T20:38:07.222035Z&quot;,&quot;shell.execute_reply&quot;:&quot;2024-11-17T20:38:07.221730Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2024-11-17T20:37:59.673491Z&quot;}" data-execution_count="3">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a><span class="im">import</span> json</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="im">from</span> enum <span class="im">import</span> Enum</span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="im">from</span> textwrap <span class="im">import</span> dedent</span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="im">from</span> typing <span class="im">import</span> Callable, List</span>
<span id="cb2-6"><a href="#cb2-6"></a></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="im">import</span> outlines</span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-10"><a href="#cb2-10"></a><span class="im">import</span> torch</span>
<span id="cb2-11"><a href="#cb2-11"></a><span class="im">from</span> datasets <span class="im">import</span> load_dataset</span>
<span id="cb2-12"><a href="#cb2-12"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb2-13"><a href="#cb2-13"></a><span class="im">from</span> langsmith <span class="im">import</span> traceable</span>
<span id="cb2-14"><a href="#cb2-14"></a><span class="im">from</span> outlines.fsm.json_schema <span class="im">import</span> build_regex_from_schema</span>
<span id="cb2-15"><a href="#cb2-15"></a><span class="im">from</span> outlines.samplers <span class="im">import</span> greedy</span>
<span id="cb2-16"><a href="#cb2-16"></a><span class="im">from</span> pydantic <span class="im">import</span> BaseModel, Field, constr</span>
<span id="cb2-17"><a href="#cb2-17"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span>
<span id="cb2-18"><a href="#cb2-18"></a><span class="im">from</span> transformers <span class="im">import</span> AutoTokenizer</span>
<span id="cb2-19"><a href="#cb2-19"></a></span>
<span id="cb2-20"><a href="#cb2-20"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb2-21"><a href="#cb2-21"></a></span>
<span id="cb2-22"><a href="#cb2-22"></a>load_dotenv()</span>
<span id="cb2-23"><a href="#cb2-23"></a></span>
<span id="cb2-24"><a href="#cb2-24"></a>MODEL_NAME <span class="op">=</span> <span class="st">"meta-llama/Meta-Llama-3-8B-Instruct"</span></span>
<span id="cb2-25"><a href="#cb2-25"></a>USE_SAMPLE <span class="op">=</span> <span class="va">False</span></span>
<span id="cb2-26"><a href="#cb2-26"></a></span>
<span id="cb2-27"><a href="#cb2-27"></a>model <span class="op">=</span> outlines.models.transformers(</span>
<span id="cb2-28"><a href="#cb2-28"></a>    MODEL_NAME,</span>
<span id="cb2-29"><a href="#cb2-29"></a>    device<span class="op">=</span><span class="st">"cuda"</span>,</span>
<span id="cb2-30"><a href="#cb2-30"></a>    model_kwargs<span class="op">=</span>{<span class="st">"torch_dtype"</span>: torch.bfloat16, <span class="st">"trust_remote_code"</span>: <span class="va">True</span>},</span>
<span id="cb2-31"><a href="#cb2-31"></a>)</span>
<span id="cb2-32"><a href="#cb2-32"></a>tokenizer <span class="op">=</span> AutoTokenizer.from_pretrained(MODEL_NAME)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="39c919d8" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw">class</span> PromptType(Enum):</span>
<span id="cb3-2"><a href="#cb3-2"></a>    NATURAL_LANGUAGE <span class="op">=</span> <span class="st">"nl"</span></span>
<span id="cb3-3"><a href="#cb3-3"></a>    STRUCTURED_GENERATION <span class="op">=</span> <span class="st">"sg"</span></span>
<span id="cb3-4"><a href="#cb3-4"></a></span>
<span id="cb3-5"><a href="#cb3-5"></a></span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="kw">class</span> ClientConfig(BaseModel):</span>
<span id="cb3-7"><a href="#cb3-7"></a>    name: <span class="bu">str</span></span>
<span id="cb3-8"><a href="#cb3-8"></a>    use_response_model: <span class="bu">bool</span></span>
<span id="cb3-9"><a href="#cb3-9"></a>    col_name: <span class="bu">str</span></span>
<span id="cb3-10"><a href="#cb3-10"></a>    score_col_name: <span class="bu">str</span></span>
<span id="cb3-11"><a href="#cb3-11"></a></span>
<span id="cb3-12"><a href="#cb3-12"></a></span>
<span id="cb3-13"><a href="#cb3-13"></a>CONFIGS <span class="op">=</span> [</span>
<span id="cb3-14"><a href="#cb3-14"></a>    ClientConfig(</span>
<span id="cb3-15"><a href="#cb3-15"></a>        name<span class="op">=</span>PromptType.NATURAL_LANGUAGE.value,</span>
<span id="cb3-16"><a href="#cb3-16"></a>        use_response_model<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb3-17"><a href="#cb3-17"></a>        col_name<span class="op">=</span><span class="ss">f"response_</span><span class="sc">{</span>PromptType<span class="sc">.</span>NATURAL_LANGUAGE<span class="sc">.</span>value<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb3-18"><a href="#cb3-18"></a>        score_col_name<span class="op">=</span><span class="ss">f"score_</span><span class="sc">{</span>PromptType<span class="sc">.</span>NATURAL_LANGUAGE<span class="sc">.</span>value<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb3-19"><a href="#cb3-19"></a>    ),</span>
<span id="cb3-20"><a href="#cb3-20"></a>    ClientConfig(</span>
<span id="cb3-21"><a href="#cb3-21"></a>        name<span class="op">=</span>PromptType.STRUCTURED_GENERATION.value,</span>
<span id="cb3-22"><a href="#cb3-22"></a>        use_response_model<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb3-23"><a href="#cb3-23"></a>        col_name<span class="op">=</span><span class="ss">f"response_</span><span class="sc">{</span>PromptType<span class="sc">.</span>STRUCTURED_GENERATION<span class="sc">.</span>value<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb3-24"><a href="#cb3-24"></a>        score_col_name<span class="op">=</span><span class="ss">f"score_</span><span class="sc">{</span>PromptType<span class="sc">.</span>STRUCTURED_GENERATION<span class="sc">.</span>value<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb3-25"><a href="#cb3-25"></a>    ),</span>
<span id="cb3-26"><a href="#cb3-26"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="2eb319a5" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw">class</span> LLMEvaluator:</span>
<span id="cb4-2"><a href="#cb4-2"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(</span>
<span id="cb4-3"><a href="#cb4-3"></a>        <span class="va">self</span>,</span>
<span id="cb4-4"><a href="#cb4-4"></a>        configs: List[ClientConfig],</span>
<span id="cb4-5"><a href="#cb4-5"></a>        create_prompt_fn: Callable,</span>
<span id="cb4-6"><a href="#cb4-6"></a>        parse_response_fn: Callable,</span>
<span id="cb4-7"><a href="#cb4-7"></a>        response_model: BaseModel,</span>
<span id="cb4-8"><a href="#cb4-8"></a>        max_tokens: <span class="bu">int</span> <span class="op">=</span> <span class="dv">256</span>,</span>
<span id="cb4-9"><a href="#cb4-9"></a>    ):</span>
<span id="cb4-10"><a href="#cb4-10"></a>        <span class="va">self</span>.configs <span class="op">=</span> configs</span>
<span id="cb4-11"><a href="#cb4-11"></a>        <span class="va">self</span>.create_prompt_fn <span class="op">=</span> create_prompt_fn</span>
<span id="cb4-12"><a href="#cb4-12"></a>        <span class="va">self</span>.parse_response_fn <span class="op">=</span> parse_response_fn</span>
<span id="cb4-13"><a href="#cb4-13"></a>        <span class="va">self</span>.schema_regex <span class="op">=</span> build_regex_from_schema(</span>
<span id="cb4-14"><a href="#cb4-14"></a>            json.dumps(response_model.model_json_schema())</span>
<span id="cb4-15"><a href="#cb4-15"></a>        )</span>
<span id="cb4-16"><a href="#cb4-16"></a>        <span class="va">self</span>.nl_generate <span class="op">=</span> outlines.generate.text(model, sampler<span class="op">=</span>greedy())</span>
<span id="cb4-17"><a href="#cb4-17"></a>        <span class="va">self</span>.sg_generate <span class="op">=</span> outlines.generate.regex(</span>
<span id="cb4-18"><a href="#cb4-18"></a>            model, <span class="va">self</span>.schema_regex, sampler<span class="op">=</span>greedy()</span>
<span id="cb4-19"><a href="#cb4-19"></a>        )</span>
<span id="cb4-20"><a href="#cb4-20"></a>        <span class="va">self</span>.max_tokens <span class="op">=</span> max_tokens</span>
<span id="cb4-21"><a href="#cb4-21"></a>        <span class="va">self</span>.tokenizer <span class="op">=</span> tokenizer</span>
<span id="cb4-22"><a href="#cb4-22"></a></span>
<span id="cb4-23"><a href="#cb4-23"></a>    <span class="at">@traceable</span>(run_type<span class="op">=</span><span class="st">"prompt"</span>)</span>
<span id="cb4-24"><a href="#cb4-24"></a>    <span class="kw">def</span> create_prompt(</span>
<span id="cb4-25"><a href="#cb4-25"></a>        <span class="va">self</span>,</span>
<span id="cb4-26"><a href="#cb4-26"></a>        question: <span class="bu">str</span>,</span>
<span id="cb4-27"><a href="#cb4-27"></a>        prompt_type: <span class="bu">str</span>,</span>
<span id="cb4-28"><a href="#cb4-28"></a>    ) <span class="op">-&gt;</span> List[<span class="bu">dict</span>]:</span>
<span id="cb4-29"><a href="#cb4-29"></a>        <span class="cf">return</span> <span class="va">self</span>.create_prompt_fn(</span>
<span id="cb4-30"><a href="#cb4-30"></a>            question<span class="op">=</span>question,</span>
<span id="cb4-31"><a href="#cb4-31"></a>            prompt_type<span class="op">=</span>prompt_type,</span>
<span id="cb4-32"><a href="#cb4-32"></a>            tokenizer<span class="op">=</span><span class="va">self</span>.tokenizer,</span>
<span id="cb4-33"><a href="#cb4-33"></a>        )</span>
<span id="cb4-34"><a href="#cb4-34"></a></span>
<span id="cb4-35"><a href="#cb4-35"></a>    <span class="at">@traceable</span>(run_type<span class="op">=</span><span class="st">"parser"</span>)</span>
<span id="cb4-36"><a href="#cb4-36"></a>    <span class="kw">def</span> parse_response(</span>
<span id="cb4-37"><a href="#cb4-37"></a>        <span class="va">self</span>,</span>
<span id="cb4-38"><a href="#cb4-38"></a>        response: <span class="bu">str</span>,</span>
<span id="cb4-39"><a href="#cb4-39"></a>        prompt_type: <span class="bu">str</span>,</span>
<span id="cb4-40"><a href="#cb4-40"></a>    ) <span class="op">-&gt;</span> <span class="bu">str</span> <span class="op">|</span> <span class="bu">int</span>:</span>
<span id="cb4-41"><a href="#cb4-41"></a>        <span class="cf">try</span>:</span>
<span id="cb4-42"><a href="#cb4-42"></a>            <span class="cf">return</span> <span class="va">self</span>.parse_response_fn(response, prompt_type)</span>
<span id="cb4-43"><a href="#cb4-43"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb4-44"><a href="#cb4-44"></a>            <span class="bu">print</span>(<span class="ss">f"Error parsing response: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-45"><a href="#cb4-45"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb4-46"><a href="#cb4-46"></a></span>
<span id="cb4-47"><a href="#cb4-47"></a>    <span class="at">@traceable</span>(run_type<span class="op">=</span><span class="st">"llm"</span>)</span>
<span id="cb4-48"><a href="#cb4-48"></a>    <span class="kw">def</span> call_llm(</span>
<span id="cb4-49"><a href="#cb4-49"></a>        <span class="va">self</span>,</span>
<span id="cb4-50"><a href="#cb4-50"></a>        config: ClientConfig,</span>
<span id="cb4-51"><a href="#cb4-51"></a>        question: <span class="bu">str</span>,</span>
<span id="cb4-52"><a href="#cb4-52"></a>    ) <span class="op">-&gt;</span> <span class="bu">str</span> <span class="op">|</span> <span class="va">None</span>:</span>
<span id="cb4-53"><a href="#cb4-53"></a>        message <span class="op">=</span> <span class="va">self</span>.create_prompt(question<span class="op">=</span>question, prompt_type<span class="op">=</span>config.name)</span>
<span id="cb4-54"><a href="#cb4-54"></a>        <span class="cf">if</span> config.name <span class="op">==</span> PromptType.STRUCTURED_GENERATION.value:</span>
<span id="cb4-55"><a href="#cb4-55"></a>            <span class="cf">return</span> <span class="va">self</span>.sg_generate(message)</span>
<span id="cb4-56"><a href="#cb4-56"></a>        <span class="cf">return</span> <span class="va">self</span>.nl_generate(message, max_tokens<span class="op">=</span><span class="va">self</span>.max_tokens)</span>
<span id="cb4-57"><a href="#cb4-57"></a></span>
<span id="cb4-58"><a href="#cb4-58"></a>    <span class="at">@traceable</span>(run_type<span class="op">=</span><span class="st">"chain"</span>)</span>
<span id="cb4-59"><a href="#cb4-59"></a>    <span class="kw">def</span> process_question(</span>
<span id="cb4-60"><a href="#cb4-60"></a>        <span class="va">self</span>,</span>
<span id="cb4-61"><a href="#cb4-61"></a>        question: <span class="bu">str</span>,</span>
<span id="cb4-62"><a href="#cb4-62"></a>        config: ClientConfig,</span>
<span id="cb4-63"><a href="#cb4-63"></a>    ) <span class="op">-&gt;</span> <span class="bu">str</span> <span class="op">|</span> <span class="bu">int</span> <span class="op">|</span> <span class="va">None</span>:</span>
<span id="cb4-64"><a href="#cb4-64"></a>        answer <span class="op">=</span> <span class="va">self</span>.call_llm(</span>
<span id="cb4-65"><a href="#cb4-65"></a>            config<span class="op">=</span>config,</span>
<span id="cb4-66"><a href="#cb4-66"></a>            question<span class="op">=</span>question,</span>
<span id="cb4-67"><a href="#cb4-67"></a>        )</span>
<span id="cb4-68"><a href="#cb4-68"></a>        <span class="cf">return</span> <span class="va">self</span>.parse_response(answer, config.name)</span>
<span id="cb4-69"><a href="#cb4-69"></a></span>
<span id="cb4-70"><a href="#cb4-70"></a>    <span class="at">@traceable</span>(run_type<span class="op">=</span><span class="st">"chain"</span>)</span>
<span id="cb4-71"><a href="#cb4-71"></a>    <span class="kw">def</span> process_questions(</span>
<span id="cb4-72"><a href="#cb4-72"></a>        <span class="va">self</span>,</span>
<span id="cb4-73"><a href="#cb4-73"></a>        run_name: <span class="bu">str</span>,</span>
<span id="cb4-74"><a href="#cb4-74"></a>        questions: List[<span class="bu">dict</span>],</span>
<span id="cb4-75"><a href="#cb4-75"></a>        config: ClientConfig,</span>
<span id="cb4-76"><a href="#cb4-76"></a>    ) <span class="op">-&gt;</span> List[<span class="bu">str</span> <span class="op">|</span> <span class="bu">int</span> <span class="op">|</span> <span class="va">None</span>]:</span>
<span id="cb4-77"><a href="#cb4-77"></a>        <span class="cf">return</span> [</span>
<span id="cb4-78"><a href="#cb4-78"></a>            <span class="va">self</span>.process_question(</span>
<span id="cb4-79"><a href="#cb4-79"></a>                question<span class="op">=</span>question[<span class="st">"question"</span>],</span>
<span id="cb4-80"><a href="#cb4-80"></a>                config<span class="op">=</span>config,</span>
<span id="cb4-81"><a href="#cb4-81"></a>            )</span>
<span id="cb4-82"><a href="#cb4-82"></a>            <span class="cf">for</span> question <span class="kw">in</span> questions</span>
<span id="cb4-83"><a href="#cb4-83"></a>        ]</span>
<span id="cb4-84"><a href="#cb4-84"></a></span>
<span id="cb4-85"><a href="#cb4-85"></a>    <span class="kw">def</span> generate_outputs(<span class="va">self</span>, questions: List[<span class="bu">dict</span>]) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb4-86"><a href="#cb4-86"></a>        df <span class="op">=</span> pd.DataFrame(</span>
<span id="cb4-87"><a href="#cb4-87"></a>            {</span>
<span id="cb4-88"><a href="#cb4-88"></a>                <span class="st">"id"</span>: [i <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(questions))],</span>
<span id="cb4-89"><a href="#cb4-89"></a>                <span class="st">"question"</span>: [question[<span class="st">"question"</span>] <span class="cf">for</span> question <span class="kw">in</span> questions],</span>
<span id="cb4-90"><a href="#cb4-90"></a>                <span class="st">"answer"</span>: [question[<span class="st">"answer"</span>] <span class="cf">for</span> question <span class="kw">in</span> questions],</span>
<span id="cb4-91"><a href="#cb4-91"></a>            }</span>
<span id="cb4-92"><a href="#cb4-92"></a>        )</span>
<span id="cb4-93"><a href="#cb4-93"></a>        <span class="cf">for</span> config <span class="kw">in</span> <span class="va">self</span>.configs:</span>
<span id="cb4-94"><a href="#cb4-94"></a>            responses <span class="op">=</span> <span class="va">self</span>.process_questions(</span>
<span id="cb4-95"><a href="#cb4-95"></a>                run_name<span class="op">=</span>config.name,</span>
<span id="cb4-96"><a href="#cb4-96"></a>                questions<span class="op">=</span>questions,</span>
<span id="cb4-97"><a href="#cb4-97"></a>                config<span class="op">=</span>config,</span>
<span id="cb4-98"><a href="#cb4-98"></a>            )</span>
<span id="cb4-99"><a href="#cb4-99"></a>            df[config.col_name] <span class="op">=</span> responses</span>
<span id="cb4-100"><a href="#cb4-100"></a>        <span class="cf">return</span> df</span>
<span id="cb4-101"><a href="#cb4-101"></a></span>
<span id="cb4-102"><a href="#cb4-102"></a>    <span class="kw">def</span> evaluate_outputs(<span class="va">self</span>, df: pd.DataFrame) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb4-103"><a href="#cb4-103"></a>        df_copy <span class="op">=</span> df.copy()</span>
<span id="cb4-104"><a href="#cb4-104"></a>        <span class="cf">for</span> config <span class="kw">in</span> <span class="va">self</span>.configs:</span>
<span id="cb4-105"><a href="#cb4-105"></a>            df_copy[config.score_col_name] <span class="op">=</span> (</span>
<span id="cb4-106"><a href="#cb4-106"></a>                df_copy[<span class="st">"answer"</span>] <span class="op">==</span> df_copy[config.col_name]</span>
<span id="cb4-107"><a href="#cb4-107"></a>            ) <span class="op">*</span> <span class="dv">1</span></span>
<span id="cb4-108"><a href="#cb4-108"></a>        <span class="cf">return</span> df_copy</span>
<span id="cb4-109"><a href="#cb4-109"></a></span>
<span id="cb4-110"><a href="#cb4-110"></a>    <span class="kw">def</span> calculate_confidence_intervals(</span>
<span id="cb4-111"><a href="#cb4-111"></a>        <span class="va">self</span>, df: pd.DataFrame, conf_level: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.95</span></span>
<span id="cb4-112"><a href="#cb4-112"></a>    ) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb4-113"><a href="#cb4-113"></a>        <span class="bu">print</span>(</span>
<span id="cb4-114"><a href="#cb4-114"></a>            <span class="ss">f"Calculating confidence intervals (</span><span class="sc">{</span>conf_level<span class="sc">}</span><span class="ss">) with </span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">}</span><span class="ss"> observations:"</span></span>
<span id="cb4-115"><a href="#cb4-115"></a>        )</span>
<span id="cb4-116"><a href="#cb4-116"></a>        <span class="cf">for</span> config <span class="kw">in</span> <span class="va">self</span>.configs:</span>
<span id="cb4-117"><a href="#cb4-117"></a>            score_col <span class="op">=</span> config.score_col_name</span>
<span id="cb4-118"><a href="#cb4-118"></a>            scores <span class="op">=</span> df[score_col]</span>
<span id="cb4-119"><a href="#cb4-119"></a></span>
<span id="cb4-120"><a href="#cb4-120"></a>            <span class="cf">if</span> <span class="bu">len</span>(scores) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb4-121"><a href="#cb4-121"></a>                <span class="bu">print</span>(<span class="ss">f"No scores available for </span><span class="sc">{</span>score_col<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-122"><a href="#cb4-122"></a>                <span class="cf">continue</span></span>
<span id="cb4-123"><a href="#cb4-123"></a></span>
<span id="cb4-124"><a href="#cb4-124"></a>            mean_score <span class="op">=</span> scores.mean()</span>
<span id="cb4-125"><a href="#cb4-125"></a>            se_score <span class="op">=</span> scores.std() <span class="op">/</span> np.sqrt(<span class="bu">len</span>(scores))</span>
<span id="cb4-126"><a href="#cb4-126"></a></span>
<span id="cb4-127"><a href="#cb4-127"></a>            z_score <span class="op">=</span> stats.norm.ppf((<span class="dv">1</span> <span class="op">+</span> conf_level) <span class="op">/</span> <span class="dv">2</span>)</span>
<span id="cb4-128"><a href="#cb4-128"></a>            margin_error <span class="op">=</span> z_score <span class="op">*</span> se_score</span>
<span id="cb4-129"><a href="#cb4-129"></a>            ci <span class="op">=</span> [</span>
<span id="cb4-130"><a href="#cb4-130"></a>                <span class="bu">max</span>(<span class="fl">0.0</span>, mean_score <span class="op">-</span> margin_error),</span>
<span id="cb4-131"><a href="#cb4-131"></a>                <span class="bu">min</span>(<span class="fl">1.0</span>, mean_score <span class="op">+</span> margin_error),</span>
<span id="cb4-132"><a href="#cb4-132"></a>            ]</span>
<span id="cb4-133"><a href="#cb4-133"></a>            <span class="bu">print</span>(</span>
<span id="cb4-134"><a href="#cb4-134"></a>                <span class="ss">f"</span><span class="sc">{</span>score_col<span class="sc">}</span><span class="ss"> - Mean: </span><span class="sc">{</span>mean_score <span class="op">*</span> <span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">% CI: </span><span class="sc">{</span>ci[<span class="dv">0</span>] <span class="op">*</span> <span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">% - </span><span class="sc">{</span>ci[<span class="dv">1</span>] <span class="op">*</span> <span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%"</span></span>
<span id="cb4-135"><a href="#cb4-135"></a>            )</span>
<span id="cb4-136"><a href="#cb4-136"></a>        <span class="bu">print</span>()</span>
<span id="cb4-137"><a href="#cb4-137"></a></span>
<span id="cb4-138"><a href="#cb4-138"></a>    <span class="kw">def</span> run_paired_t_test(<span class="va">self</span>, df: pd.DataFrame) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb4-139"><a href="#cb4-139"></a>        scores <span class="op">=</span> {}</span>
<span id="cb4-140"><a href="#cb4-140"></a></span>
<span id="cb4-141"><a href="#cb4-141"></a>        <span class="cf">for</span> config <span class="kw">in</span> <span class="va">self</span>.configs:</span>
<span id="cb4-142"><a href="#cb4-142"></a>            score_col <span class="op">=</span> config.score_col_name</span>
<span id="cb4-143"><a href="#cb4-143"></a>            scores[score_col] <span class="op">=</span> df[score_col] <span class="op">*</span> <span class="dv">1</span></span>
<span id="cb4-144"><a href="#cb4-144"></a></span>
<span id="cb4-145"><a href="#cb4-145"></a>        <span class="cf">for</span> score_col_1, score_col_2 <span class="kw">in</span> [</span>
<span id="cb4-146"><a href="#cb4-146"></a>            (<span class="st">"score_nl"</span>, <span class="st">"score_sg"</span>),</span>
<span id="cb4-147"><a href="#cb4-147"></a>        ]:</span>
<span id="cb4-148"><a href="#cb4-148"></a>            <span class="cf">if</span> score_col_1 <span class="kw">in</span> scores <span class="kw">and</span> score_col_2 <span class="kw">in</span> scores:</span>
<span id="cb4-149"><a href="#cb4-149"></a>                t_stat, p_value <span class="op">=</span> stats.ttest_rel(</span>
<span id="cb4-150"><a href="#cb4-150"></a>                    scores[score_col_1], scores[score_col_2]</span>
<span id="cb4-151"><a href="#cb4-151"></a>                )</span>
<span id="cb4-152"><a href="#cb4-152"></a>                <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>score_col_1<span class="sc">}</span><span class="ss"> vs </span><span class="sc">{</span>score_col_2<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-153"><a href="#cb4-153"></a>                <span class="bu">print</span>(<span class="ss">f"t-statistic: </span><span class="sc">{</span>t_stat<span class="sc">}</span><span class="ss">, p-value: </span><span class="sc">{</span>p_value<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="0ff85876" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw">class</span> Response(BaseModel):</span>
<span id="cb5-2"><a href="#cb5-2"></a>    reasoning: constr(max_length<span class="op">=</span><span class="dv">1000</span>)</span>
<span id="cb5-3"><a href="#cb5-3"></a>    answer: <span class="bu">int</span> <span class="op">=</span> Field(pattern<span class="op">=</span><span class="vs">r'[1-9][0-9]{0,9}'</span>)</span>
<span id="cb5-4"><a href="#cb5-4"></a></span>
<span id="cb5-5"><a href="#cb5-5"></a></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="kw">def</span> create_prompt_gsm8k(question: <span class="bu">str</span>, prompt_type: <span class="bu">str</span>, tokenizer: AutoTokenizer):</span>
<span id="cb5-7"><a href="#cb5-7"></a>    <span class="cf">if</span> prompt_type <span class="op">==</span> PromptType.STRUCTURED_GENERATION.value:</span>
<span id="cb5-8"><a href="#cb5-8"></a>        system_prompt <span class="op">=</span> dedent(<span class="st">"""</span></span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="st">        You are an expert in solving grade school math tasks. You will be presented with a grade-school math word problem and be asked to solve it.</span></span>
<span id="cb5-10"><a href="#cb5-10"></a></span>
<span id="cb5-11"><a href="#cb5-11"></a><span class="st">        You will always respond with a JSON object matching the following format:</span></span>
<span id="cb5-12"><a href="#cb5-12"></a><span class="st">        </span></span>
<span id="cb5-13"><a href="#cb5-13"></a><span class="st">        {"reasoning": &lt;str, reasoning about the answer&gt;, "answer": &lt;int, final answer&gt;}</span></span>
<span id="cb5-14"><a href="#cb5-14"></a><span class="st">        </span></span>
<span id="cb5-15"><a href="#cb5-15"></a><span class="st">        First, provide your step by step reasoning in the "reasoning" field. Then, in the "answer" field, provide an integer that corresponds to the correct answer to the question. Don't include any other text in the "answer" field.</span></span>
<span id="cb5-16"><a href="#cb5-16"></a><span class="st">        """</span>)</span>
<span id="cb5-17"><a href="#cb5-17"></a>    <span class="cf">else</span>:</span>
<span id="cb5-18"><a href="#cb5-18"></a>        system_prompt <span class="op">=</span> dedent(<span class="st">"""</span></span>
<span id="cb5-19"><a href="#cb5-19"></a><span class="st">        You are an expert in solving grade school math tasks. You will be presented with a grade-school math word problem and be asked to solve it.</span></span>
<span id="cb5-20"><a href="#cb5-20"></a><span class="st">        </span></span>
<span id="cb5-21"><a href="#cb5-21"></a><span class="st">        You will always respond in the following format:</span></span>
<span id="cb5-22"><a href="#cb5-22"></a><span class="st">        </span></span>
<span id="cb5-23"><a href="#cb5-23"></a><span class="st">        &lt;str, reasoning about the answer&gt;</span></span>
<span id="cb5-24"><a href="#cb5-24"></a><span class="st">        ANSWER: &lt;int, final answer&gt;</span></span>
<span id="cb5-25"><a href="#cb5-25"></a><span class="st">        </span></span>
<span id="cb5-26"><a href="#cb5-26"></a><span class="st">        First, provide your step by step reasoning. Then, in ANSWER, provide an integer that corresponds to the correct answer to the question. Don't include any other text in ANSWER.</span></span>
<span id="cb5-27"><a href="#cb5-27"></a><span class="st">        """</span>)</span>
<span id="cb5-28"><a href="#cb5-28"></a></span>
<span id="cb5-29"><a href="#cb5-29"></a>    examples <span class="op">=</span> [</span>
<span id="cb5-30"><a href="#cb5-30"></a>        (</span>
<span id="cb5-31"><a href="#cb5-31"></a>            <span class="st">"There are 15 trees in the grove. Grove workers will plant trees in the grove today. After they are done, there will be 21 trees. How many trees did the grove workers plant today?"</span>,</span>
<span id="cb5-32"><a href="#cb5-32"></a>            <span class="st">"There are 15 trees originally. Then there were 21 trees after some more were planted. So there must have been 21 - 15 = 6."</span>,</span>
<span id="cb5-33"><a href="#cb5-33"></a>            <span class="dv">6</span>,</span>
<span id="cb5-34"><a href="#cb5-34"></a>        ),</span>
<span id="cb5-35"><a href="#cb5-35"></a>        (</span>
<span id="cb5-36"><a href="#cb5-36"></a>            <span class="st">"If there are 3 cars in the parking lot and 2 more cars arrive, how many cars are in the parking lot?"</span>,</span>
<span id="cb5-37"><a href="#cb5-37"></a>            <span class="st">"There are originally 3 cars. 2 more cars arrive. 3 + 2 = 5."</span>,</span>
<span id="cb5-38"><a href="#cb5-38"></a>            <span class="dv">5</span>,</span>
<span id="cb5-39"><a href="#cb5-39"></a>        ),</span>
<span id="cb5-40"><a href="#cb5-40"></a>        (</span>
<span id="cb5-41"><a href="#cb5-41"></a>            <span class="st">"Leah had 32 chocolates and her sister had 42. If they ate 35, how many pieces do they have left in total?"</span>,</span>
<span id="cb5-42"><a href="#cb5-42"></a>            <span class="st">"Originally, Leah had 32 chocolates. Her sister had 42. So in total they had 32 + 42 = 74. After eating 35, they had 74 - 35 = 39."</span>,</span>
<span id="cb5-43"><a href="#cb5-43"></a>            <span class="dv">39</span>,</span>
<span id="cb5-44"><a href="#cb5-44"></a>        ),</span>
<span id="cb5-45"><a href="#cb5-45"></a>    ]</span>
<span id="cb5-46"><a href="#cb5-46"></a></span>
<span id="cb5-47"><a href="#cb5-47"></a>    messages <span class="op">=</span> [</span>
<span id="cb5-48"><a href="#cb5-48"></a>        {</span>
<span id="cb5-49"><a href="#cb5-49"></a>            <span class="st">"role"</span>: <span class="st">"system"</span>,</span>
<span id="cb5-50"><a href="#cb5-50"></a>            <span class="st">"content"</span>: system_prompt,</span>
<span id="cb5-51"><a href="#cb5-51"></a>        },</span>
<span id="cb5-52"><a href="#cb5-52"></a>    ]</span>
<span id="cb5-53"><a href="#cb5-53"></a></span>
<span id="cb5-54"><a href="#cb5-54"></a>    <span class="cf">for</span> example_q, example_reason, example_ans <span class="kw">in</span> examples:</span>
<span id="cb5-55"><a href="#cb5-55"></a>        messages.append(</span>
<span id="cb5-56"><a href="#cb5-56"></a>            {</span>
<span id="cb5-57"><a href="#cb5-57"></a>                <span class="st">"role"</span>: <span class="st">"user"</span>,</span>
<span id="cb5-58"><a href="#cb5-58"></a>                <span class="st">"content"</span>: <span class="ss">f"Question: </span><span class="sc">{</span>example_q<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb5-59"><a href="#cb5-59"></a>            }</span>
<span id="cb5-60"><a href="#cb5-60"></a>        )</span>
<span id="cb5-61"><a href="#cb5-61"></a>        <span class="cf">if</span> prompt_type <span class="op">==</span> PromptType.STRUCTURED_GENERATION.value:</span>
<span id="cb5-62"><a href="#cb5-62"></a>            response <span class="op">=</span> <span class="ss">f'</span><span class="ch">{{</span><span class="ss">"reasoning": "</span><span class="sc">{</span>example_reason<span class="sc">}</span><span class="ss">", "answer": </span><span class="sc">{</span>example_ans<span class="sc">}</span><span class="ch">}}</span><span class="ss">'</span></span>
<span id="cb5-63"><a href="#cb5-63"></a>        <span class="cf">else</span>:</span>
<span id="cb5-64"><a href="#cb5-64"></a>            response <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>example_reason<span class="sc">}</span><span class="ch">\n</span><span class="ss">ANSWER: </span><span class="sc">{</span>example_ans<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb5-65"><a href="#cb5-65"></a>        messages.append(</span>
<span id="cb5-66"><a href="#cb5-66"></a>            {</span>
<span id="cb5-67"><a href="#cb5-67"></a>                <span class="st">"role"</span>: <span class="st">"assistant"</span>,</span>
<span id="cb5-68"><a href="#cb5-68"></a>                <span class="st">"content"</span>: response,</span>
<span id="cb5-69"><a href="#cb5-69"></a>            }</span>
<span id="cb5-70"><a href="#cb5-70"></a>        )</span>
<span id="cb5-71"><a href="#cb5-71"></a>    messages.extend(</span>
<span id="cb5-72"><a href="#cb5-72"></a>        [</span>
<span id="cb5-73"><a href="#cb5-73"></a>            {</span>
<span id="cb5-74"><a href="#cb5-74"></a>                <span class="st">"role"</span>: <span class="st">"user"</span>,</span>
<span id="cb5-75"><a href="#cb5-75"></a>                <span class="st">"content"</span>: <span class="ss">f"Question: </span><span class="sc">{</span>question<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb5-76"><a href="#cb5-76"></a>            },</span>
<span id="cb5-77"><a href="#cb5-77"></a>        ]</span>
<span id="cb5-78"><a href="#cb5-78"></a>    )</span>
<span id="cb5-79"><a href="#cb5-79"></a></span>
<span id="cb5-80"><a href="#cb5-80"></a>    <span class="cf">return</span> tokenizer.apply_chat_template(messages, tokenize<span class="op">=</span><span class="va">False</span>, add_generation_prompt<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-81"><a href="#cb5-81"></a></span>
<span id="cb5-82"><a href="#cb5-82"></a></span>
<span id="cb5-83"><a href="#cb5-83"></a><span class="kw">def</span> parse_response_gsm8k(response: <span class="bu">str</span>, prompt_type: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb5-84"><a href="#cb5-84"></a>    <span class="cf">if</span> prompt_type <span class="op">==</span> PromptType.STRUCTURED_GENERATION.value:</span>
<span id="cb5-85"><a href="#cb5-85"></a>        <span class="cf">return</span> <span class="bu">int</span>(json.loads(response)[<span class="st">"answer"</span>])</span>
<span id="cb5-86"><a href="#cb5-86"></a>    <span class="cf">else</span>:</span>
<span id="cb5-87"><a href="#cb5-87"></a>        cleaned_response <span class="op">=</span> (</span>
<span id="cb5-88"><a href="#cb5-88"></a>            response.split(<span class="st">"</span><span class="ch">\n</span><span class="st">ANSWER:"</span>)[<span class="dv">1</span>].replace(<span class="st">","</span>, <span class="st">""</span>).rstrip(<span class="st">"."</span>).strip()</span>
<span id="cb5-89"><a href="#cb5-89"></a>        )</span>
<span id="cb5-90"><a href="#cb5-90"></a>        <span class="cf">return</span> <span class="bu">int</span>(cleaned_response)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="91004ed0" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1"></a>evaluator <span class="op">=</span> LLMEvaluator(</span>
<span id="cb6-2"><a href="#cb6-2"></a>    configs<span class="op">=</span>CONFIGS,</span>
<span id="cb6-3"><a href="#cb6-3"></a>    create_prompt_fn<span class="op">=</span>create_prompt_gsm8k,</span>
<span id="cb6-4"><a href="#cb6-4"></a>    parse_response_fn<span class="op">=</span>parse_response_gsm8k,</span>
<span id="cb6-5"><a href="#cb6-5"></a>    response_model<span class="op">=</span>Response,</span>
<span id="cb6-6"><a href="#cb6-6"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="58780d2e" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1"></a>dataset <span class="op">=</span> load_dataset(<span class="st">"gsm8k"</span>, <span class="st">"main"</span>)</span>
<span id="cb7-2"><a href="#cb7-2"></a>evals <span class="op">=</span> [</span>
<span id="cb7-3"><a href="#cb7-3"></a>    {</span>
<span id="cb7-4"><a href="#cb7-4"></a>        <span class="st">"question"</span>: d[<span class="st">"question"</span>],</span>
<span id="cb7-5"><a href="#cb7-5"></a>        <span class="st">"answer"</span>: <span class="bu">int</span>(d[<span class="st">"answer"</span>].split(<span class="st">"#### "</span>)[<span class="dv">1</span>].replace(<span class="st">","</span>, <span class="st">""</span>).strip()),</span>
<span id="cb7-6"><a href="#cb7-6"></a>    }</span>
<span id="cb7-7"><a href="#cb7-7"></a>    <span class="cf">for</span> d <span class="kw">in</span> dataset[<span class="st">"test"</span>]</span>
<span id="cb7-8"><a href="#cb7-8"></a>]</span>
<span id="cb7-9"><a href="#cb7-9"></a></span>
<span id="cb7-10"><a href="#cb7-10"></a><span class="cf">if</span> USE_SAMPLE:</span>
<span id="cb7-11"><a href="#cb7-11"></a>    evals <span class="op">=</span> evals[:<span class="dv">5</span>]</span>
<span id="cb7-12"><a href="#cb7-12"></a></span>
<span id="cb7-13"><a href="#cb7-13"></a>df <span class="op">=</span> evaluator.generate_outputs(evals)</span>
<span id="cb7-14"><a href="#cb7-14"></a>df_results <span class="op">=</span> evaluator.evaluate_outputs(df)</span>
<span id="cb7-15"><a href="#cb7-15"></a></span>
<span id="cb7-16"><a href="#cb7-16"></a>df_results.to_csv(<span class="st">"gsm8k_results.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/usr/local/lib/python3.12/site-packages/transformers/generation/configuration_utils.py:590: UserWarning: `do_sample` is set to `False`. However, `temperature` is set to `0.0` -- this flag is only used in sample-based generation modes. You should set `do_sample=True` or unset `temperature`. This was detected when initializing the generation config instance, which means the corresponding file may hold incorrect parameterization and should be fixed.
  warnings.warn(
/usr/local/lib/python3.12/site-packages/transformers/generation/configuration_utils.py:590: UserWarning: `do_sample` is set to `False`. However, `temperature` is set to `0.0` -- this flag is only used in sample-based generation modes. You should set `do_sample=True` or unset `temperature`.
  warnings.warn(</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Error parsing response: list index out of range
Error parsing response: list index out of range
Error parsing response: list index out of range
Error parsing response: list index out of range
Error parsing response: invalid literal for int() with base 10: '33.3'
Error parsing response: list index out of range
Error parsing response: list index out of range
Error parsing response: list index out of range
Error parsing response: list index out of range
Error parsing response: list index out of range
Error parsing response: invalid literal for int() with base 10: '27 22'
Error parsing response: list index out of range
Error parsing response: invalid literal for int() with base 10: 'x - 48'
Error parsing response: list index out of range
Error parsing response: list index out of range</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/usr/local/lib/python3.12/site-packages/transformers/generation/configuration_utils.py:590: UserWarning: `do_sample` is set to `False`. However, `temperature` is set to `0.0` -- this flag is only used in sample-based generation modes. You should set `do_sample=True` or unset `temperature`. This was detected when initializing the generation config instance, which means the corresponding file may hold incorrect parameterization and should be fixed.
  warnings.warn(
/usr/local/lib/python3.12/site-packages/transformers/generation/configuration_utils.py:590: UserWarning: `do_sample` is set to `False`. However, `temperature` is set to `0.0` -- this flag is only used in sample-based generation modes. You should set `do_sample=True` or unset `temperature`.
  warnings.warn(</code></pre>
</div>
</div>
<div id="86cd8588" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1"></a>evaluator.calculate_confidence_intervals(df_results)</span>
<span id="cb11-2"><a href="#cb11-2"></a>evaluator.run_paired_t_test(df_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Calculating confidence intervals (0.95) with 1319 observations:
score_nl - Mean: 79.98% CI: 77.82% - 82.14%
score_sg - Mean: 79.45% CI: 77.27% - 81.64%

score_nl vs score_sg
t-statistic: 0.6023185325028948, p-value: 0.547065732878361</code></pre>
</div>
</div>
<section id="last-letter" class="level2">
<h2 class="anchored" data-anchor-id="last-letter">Last Letter</h2>
<div id="c2ae3a1b" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1"></a><span class="kw">class</span> Response(BaseModel):</span>
<span id="cb13-2"><a href="#cb13-2"></a>    reasoning: constr(max_length<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb13-3"><a href="#cb13-3"></a>    answer: <span class="bu">str</span> <span class="op">=</span> Field(pattern<span class="op">=</span><span class="vs">r'[A-Za-z]</span><span class="sc">{4}</span><span class="vs">'</span>)</span>
<span id="cb13-4"><a href="#cb13-4"></a></span>
<span id="cb13-5"><a href="#cb13-5"></a></span>
<span id="cb13-6"><a href="#cb13-6"></a><span class="kw">def</span> create_prompt_last_letter(question, prompt_type: <span class="bu">str</span>, tokenizer: AutoTokenizer):</span>
<span id="cb13-7"><a href="#cb13-7"></a>    <span class="cf">if</span> prompt_type <span class="op">==</span> PromptType.STRUCTURED_GENERATION.value:</span>
<span id="cb13-8"><a href="#cb13-8"></a>        system_prompt <span class="op">=</span> dedent(<span class="st">"""</span></span>
<span id="cb13-9"><a href="#cb13-9"></a><span class="st">        You are an expert in solving word puzzles. Your specific task is going to be to take a list of 4 names, get the last letter of each and concatenate these letters into a word. </span></span>
<span id="cb13-10"><a href="#cb13-10"></a><span class="st">          </span></span>
<span id="cb13-11"><a href="#cb13-11"></a><span class="st">        You will always respond with JSON in the following format:</span></span>
<span id="cb13-12"><a href="#cb13-12"></a></span>
<span id="cb13-13"><a href="#cb13-13"></a><span class="st">        {"reasoning": &lt;str, reasoning about the answer&gt;, "answer": &lt;str, final answer&gt;}</span></span>
<span id="cb13-14"><a href="#cb13-14"></a><span class="st">        </span></span>
<span id="cb13-15"><a href="#cb13-15"></a><span class="st">        First, provide your step by step reasoning in the "reasoning" field. Then, in the 'answer' field, write the word formed by concatenating the last letters of all the names.</span></span>
<span id="cb13-16"><a href="#cb13-16"></a><span class="st">        """</span>)</span>
<span id="cb13-17"><a href="#cb13-17"></a>    <span class="cf">else</span>:</span>
<span id="cb13-18"><a href="#cb13-18"></a>        system_prompt <span class="op">=</span> dedent(<span class="st">"""</span></span>
<span id="cb13-19"><a href="#cb13-19"></a><span class="st">        You are an expert in solving word puzzles. Your specific task is going to be to take a list of 4 names, get the last letter of each and concatenate these letters into a word. </span></span>
<span id="cb13-20"><a href="#cb13-20"></a><span class="st">        </span></span>
<span id="cb13-21"><a href="#cb13-21"></a><span class="st">        You will always respond in the following format:</span></span>
<span id="cb13-22"><a href="#cb13-22"></a><span class="st">        </span></span>
<span id="cb13-23"><a href="#cb13-23"></a><span class="st">        &lt;str, reasoning about the answer&gt;</span></span>
<span id="cb13-24"><a href="#cb13-24"></a><span class="st">        ANSWER: &lt;str, final answer&gt;</span></span>
<span id="cb13-25"><a href="#cb13-25"></a></span>
<span id="cb13-26"><a href="#cb13-26"></a><span class="st">        First, provide your step by step reasoning. Then, in ANSWER, write the word formed by concatenating the last letters of all the names.</span></span>
<span id="cb13-27"><a href="#cb13-27"></a><span class="st">        """</span>)</span>
<span id="cb13-28"><a href="#cb13-28"></a></span>
<span id="cb13-29"><a href="#cb13-29"></a>    fewshot_examples <span class="op">=</span> [</span>
<span id="cb13-30"><a href="#cb13-30"></a>        (</span>
<span id="cb13-31"><a href="#cb13-31"></a>            <span class="st">"Ian Peter Bernard Stephen"</span>,</span>
<span id="cb13-32"><a href="#cb13-32"></a>            <span class="st">"The last letter of 'Ian' is 'N'. The last letter of 'Peter' is 'R'. The last letter of 'Bernard' is 'D'. The last letter of 'Stephen' is 'N'. Concatenating them is 'NRDN'."</span>,</span>
<span id="cb13-33"><a href="#cb13-33"></a>            <span class="st">"NRDN"</span>,</span>
<span id="cb13-34"><a href="#cb13-34"></a>        ),</span>
<span id="cb13-35"><a href="#cb13-35"></a>        (</span>
<span id="cb13-36"><a href="#cb13-36"></a>            <span class="st">"Javier Dylan Christopher Joseph"</span>,</span>
<span id="cb13-37"><a href="#cb13-37"></a>            <span class="st">"The last letter of 'Javier' is 'R'. The last letter of 'Dylan' is 'N'. The last letter of 'Christopher' is 'R'. The last letter of 'Joseph' is 'H'. Concatenating them is 'RNRH'."</span>,</span>
<span id="cb13-38"><a href="#cb13-38"></a>            <span class="st">"RNRH"</span>,</span>
<span id="cb13-39"><a href="#cb13-39"></a>        ),</span>
<span id="cb13-40"><a href="#cb13-40"></a>        (</span>
<span id="cb13-41"><a href="#cb13-41"></a>            <span class="st">"Anthony Elizabeth Carlos Jesus"</span>,</span>
<span id="cb13-42"><a href="#cb13-42"></a>            <span class="st">"The last letter of 'Anthony' is 'Y'. The last letter of 'Elizabeth' is 'H'. The last letter of 'Carlos' is 'S'. The last letter of 'Jesus' is 'S'. Concatenating them is 'YHSS'."</span>,</span>
<span id="cb13-43"><a href="#cb13-43"></a>            <span class="st">"YHSS"</span>,</span>
<span id="cb13-44"><a href="#cb13-44"></a>        ),</span>
<span id="cb13-45"><a href="#cb13-45"></a>    ]</span>
<span id="cb13-46"><a href="#cb13-46"></a></span>
<span id="cb13-47"><a href="#cb13-47"></a>    messages <span class="op">=</span> [</span>
<span id="cb13-48"><a href="#cb13-48"></a>        {</span>
<span id="cb13-49"><a href="#cb13-49"></a>            <span class="st">"role"</span>: <span class="st">"system"</span>,</span>
<span id="cb13-50"><a href="#cb13-50"></a>            <span class="st">"content"</span>: system_prompt,</span>
<span id="cb13-51"><a href="#cb13-51"></a>        },</span>
<span id="cb13-52"><a href="#cb13-52"></a>    ]</span>
<span id="cb13-53"><a href="#cb13-53"></a></span>
<span id="cb13-54"><a href="#cb13-54"></a>    <span class="cf">for</span> example_q, example_reason, example_ans <span class="kw">in</span> fewshot_examples:</span>
<span id="cb13-55"><a href="#cb13-55"></a>        messages.append(</span>
<span id="cb13-56"><a href="#cb13-56"></a>            {</span>
<span id="cb13-57"><a href="#cb13-57"></a>                <span class="st">"role"</span>: <span class="st">"user"</span>,</span>
<span id="cb13-58"><a href="#cb13-58"></a>                <span class="st">"content"</span>: <span class="ss">f"Question: Take the last letters of the words in '</span><span class="sc">{</span>example_q<span class="sc">}</span><span class="ss">' and concatenate them."</span>,</span>
<span id="cb13-59"><a href="#cb13-59"></a>            }</span>
<span id="cb13-60"><a href="#cb13-60"></a>        )</span>
<span id="cb13-61"><a href="#cb13-61"></a>        <span class="cf">if</span> prompt_type <span class="op">==</span> PromptType.STRUCTURED_GENERATION.value:</span>
<span id="cb13-62"><a href="#cb13-62"></a>            response <span class="op">=</span> <span class="ss">f'</span><span class="ch">{{</span><span class="ss">"reasoning": "</span><span class="sc">{</span>example_reason<span class="sc">}</span><span class="ss">", "answer": "</span><span class="sc">{</span>example_ans<span class="sc">}</span><span class="ss">"</span><span class="ch">}}</span><span class="ss">'</span></span>
<span id="cb13-63"><a href="#cb13-63"></a>        <span class="cf">else</span>:</span>
<span id="cb13-64"><a href="#cb13-64"></a>            response <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>example_reason<span class="sc">}</span><span class="ch">\n</span><span class="ss">ANSWER: </span><span class="sc">{</span>example_ans<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb13-65"><a href="#cb13-65"></a>        messages.append(</span>
<span id="cb13-66"><a href="#cb13-66"></a>            {</span>
<span id="cb13-67"><a href="#cb13-67"></a>                <span class="st">"role"</span>: <span class="st">"assistant"</span>,</span>
<span id="cb13-68"><a href="#cb13-68"></a>                <span class="st">"content"</span>: response,</span>
<span id="cb13-69"><a href="#cb13-69"></a>            }</span>
<span id="cb13-70"><a href="#cb13-70"></a>        )</span>
<span id="cb13-71"><a href="#cb13-71"></a></span>
<span id="cb13-72"><a href="#cb13-72"></a>    messages.extend(</span>
<span id="cb13-73"><a href="#cb13-73"></a>        [</span>
<span id="cb13-74"><a href="#cb13-74"></a>            {</span>
<span id="cb13-75"><a href="#cb13-75"></a>                <span class="st">"role"</span>: <span class="st">"user"</span>,</span>
<span id="cb13-76"><a href="#cb13-76"></a>                <span class="st">"content"</span>: <span class="ss">f"Question: </span><span class="sc">{</span>question<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb13-77"><a href="#cb13-77"></a>            }</span>
<span id="cb13-78"><a href="#cb13-78"></a>        ]</span>
<span id="cb13-79"><a href="#cb13-79"></a>    )</span>
<span id="cb13-80"><a href="#cb13-80"></a>    <span class="cf">return</span> tokenizer.apply_chat_template(messages, tokenize<span class="op">=</span><span class="va">False</span>, add_generation_prompt<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-81"><a href="#cb13-81"></a></span>
<span id="cb13-82"><a href="#cb13-82"></a></span>
<span id="cb13-83"><a href="#cb13-83"></a><span class="kw">def</span> parse_response_last_letter(response: <span class="bu">str</span>, prompt_type: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span> <span class="op">|</span> <span class="va">None</span>:</span>
<span id="cb13-84"><a href="#cb13-84"></a>    <span class="cf">if</span> prompt_type <span class="op">==</span> PromptType.STRUCTURED_GENERATION.value:</span>
<span id="cb13-85"><a href="#cb13-85"></a>        <span class="cf">return</span> json.loads(response)[<span class="st">"answer"</span>].lower()</span>
<span id="cb13-86"><a href="#cb13-86"></a>    <span class="cf">else</span>:</span>
<span id="cb13-87"><a href="#cb13-87"></a>        <span class="cf">return</span> response.split(<span class="st">"</span><span class="ch">\n</span><span class="st">ANSWER:"</span>)[<span class="dv">1</span>].rstrip(<span class="st">"."</span>).strip().lower()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="1a9a7fda" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1"></a>evaluator <span class="op">=</span> LLMEvaluator(</span>
<span id="cb14-2"><a href="#cb14-2"></a>    configs<span class="op">=</span>CONFIGS,</span>
<span id="cb14-3"><a href="#cb14-3"></a>    create_prompt_fn<span class="op">=</span>create_prompt_last_letter,</span>
<span id="cb14-4"><a href="#cb14-4"></a>    parse_response_fn<span class="op">=</span>parse_response_last_letter,</span>
<span id="cb14-5"><a href="#cb14-5"></a>    response_model<span class="op">=</span>Response,</span>
<span id="cb14-6"><a href="#cb14-6"></a>    max_tokens<span class="op">=</span><span class="dv">128</span>,</span>
<span id="cb14-7"><a href="#cb14-7"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="4bfacd88" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1"></a>dataset <span class="op">=</span> load_dataset(<span class="st">"ChilleD/LastLetterConcat"</span>)</span>
<span id="cb15-2"><a href="#cb15-2"></a>evals <span class="op">=</span> [</span>
<span id="cb15-3"><a href="#cb15-3"></a>    {<span class="st">"question"</span>: d[<span class="st">"question"</span>], <span class="st">"answer"</span>: d[<span class="st">"answer"</span>].lower()} <span class="cf">for</span> d <span class="kw">in</span> dataset[<span class="st">"test"</span>]</span>
<span id="cb15-4"><a href="#cb15-4"></a>]</span>
<span id="cb15-5"><a href="#cb15-5"></a></span>
<span id="cb15-6"><a href="#cb15-6"></a><span class="cf">if</span> USE_SAMPLE:</span>
<span id="cb15-7"><a href="#cb15-7"></a>    evals <span class="op">=</span> evals[:<span class="dv">5</span>]</span>
<span id="cb15-8"><a href="#cb15-8"></a></span>
<span id="cb15-9"><a href="#cb15-9"></a>df <span class="op">=</span> evaluator.generate_outputs(evals)</span>
<span id="cb15-10"><a href="#cb15-10"></a>df_results <span class="op">=</span> evaluator.evaluate_outputs(df)</span>
<span id="cb15-11"><a href="#cb15-11"></a></span>
<span id="cb15-12"><a href="#cb15-12"></a>df_results.to_csv(<span class="st">"last_letter_results.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/usr/local/lib/python3.12/site-packages/transformers/generation/configuration_utils.py:590: UserWarning: `do_sample` is set to `False`. However, `temperature` is set to `0.0` -- this flag is only used in sample-based generation modes. You should set `do_sample=True` or unset `temperature`. This was detected when initializing the generation config instance, which means the corresponding file may hold incorrect parameterization and should be fixed.
  warnings.warn(
/usr/local/lib/python3.12/site-packages/transformers/generation/configuration_utils.py:590: UserWarning: `do_sample` is set to `False`. However, `temperature` is set to `0.0` -- this flag is only used in sample-based generation modes. You should set `do_sample=True` or unset `temperature`.
  warnings.warn(
/usr/local/lib/python3.12/site-packages/transformers/generation/configuration_utils.py:590: UserWarning: `do_sample` is set to `False`. However, `temperature` is set to `0.0` -- this flag is only used in sample-based generation modes. You should set `do_sample=True` or unset `temperature`. This was detected when initializing the generation config instance, which means the corresponding file may hold incorrect parameterization and should be fixed.
  warnings.warn(
/usr/local/lib/python3.12/site-packages/transformers/generation/configuration_utils.py:590: UserWarning: `do_sample` is set to `False`. However, `temperature` is set to `0.0` -- this flag is only used in sample-based generation modes. You should set `do_sample=True` or unset `temperature`.
  warnings.warn(</code></pre>
</div>
</div>
<div id="042dfdf2" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1"></a>evaluator.calculate_confidence_intervals(df_results)</span>
<span id="cb17-2"><a href="#cb17-2"></a>evaluator.run_paired_t_test(df_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Calculating confidence intervals (0.95) with 150 observations:
score_nl - Mean: 74.00% CI: 66.96% - 81.04%
score_sg - Mean: 78.00% CI: 71.35% - 84.65%

score_nl vs score_sg
t-statistic: -1.743793659390529, p-value: 0.08325752502816747</code></pre>
</div>
</div>
</section>
<section id="shuffled-objects" class="level2">
<h2 class="anchored" data-anchor-id="shuffled-objects">Shuffled objects</h2>
<div id="00b7f240" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1"></a><span class="kw">class</span> Response(BaseModel):</span>
<span id="cb19-2"><a href="#cb19-2"></a>    reasoning: constr(max_length<span class="op">=</span><span class="dv">1200</span>)</span>
<span id="cb19-3"><a href="#cb19-3"></a>    answer: <span class="bu">str</span> <span class="op">=</span> Field(pattern<span class="op">=</span><span class="vs">r'[A-E]'</span>)</span>
<span id="cb19-4"><a href="#cb19-4"></a></span>
<span id="cb19-5"><a href="#cb19-5"></a></span>
<span id="cb19-6"><a href="#cb19-6"></a><span class="kw">def</span> create_prompt_shuffled_objects(question: <span class="bu">str</span>, prompt_type: <span class="bu">str</span>, tokenizer: AutoTokenizer):</span>
<span id="cb19-7"><a href="#cb19-7"></a>    <span class="cf">if</span> prompt_type <span class="op">==</span> PromptType.STRUCTURED_GENERATION.value:</span>
<span id="cb19-8"><a href="#cb19-8"></a>        system_prompt <span class="op">=</span> dedent(<span class="st">"""</span></span>
<span id="cb19-9"><a href="#cb19-9"></a><span class="st">        You are an expert in performing common sense tasks involving the ordering of a sequence of events.</span></span>
<span id="cb19-10"><a href="#cb19-10"></a><span class="st">        Each question will present you with a sequence of shuffling events involving 5 people (switching objects, partners, positions, etc.). Your task is to determine the correct answer from the options provided.</span></span>
<span id="cb19-11"><a href="#cb19-11"></a><span class="st">          </span></span>
<span id="cb19-12"><a href="#cb19-12"></a><span class="st">        You will always respond with JSON in the format described below:</span></span>
<span id="cb19-13"><a href="#cb19-13"></a><span class="st">                   </span></span>
<span id="cb19-14"><a href="#cb19-14"></a><span class="st">        {"reasoning": &lt;reasoning about the answer&gt;, "answer": &lt;final answer&gt;}</span></span>
<span id="cb19-15"><a href="#cb19-15"></a></span>
<span id="cb19-16"><a href="#cb19-16"></a><span class="st">        The "reasoning" field will contain your step by step reasoning about the sequence of events. Then, in the "answer" field, provide the single letter representing the correct choice you are presented with. </span></span>
<span id="cb19-17"><a href="#cb19-17"></a><span class="st">        """</span>)</span>
<span id="cb19-18"><a href="#cb19-18"></a>    <span class="cf">else</span>:</span>
<span id="cb19-19"><a href="#cb19-19"></a>        system_prompt <span class="op">=</span> dedent(<span class="st">"""</span></span>
<span id="cb19-20"><a href="#cb19-20"></a><span class="st">        You are an expert in performing common sense tasks involving the ordering of a sequence of events.</span></span>
<span id="cb19-21"><a href="#cb19-21"></a><span class="st">        Each question will present you with a sequence of shuffling events involving 5 people (switching objects, partners, positions, etc.). Your task is to determine the correct answer from the options provided.</span></span>
<span id="cb19-22"><a href="#cb19-22"></a><span class="st">        </span></span>
<span id="cb19-23"><a href="#cb19-23"></a><span class="st">        You will always respond in the format described below:</span></span>
<span id="cb19-24"><a href="#cb19-24"></a><span class="st">        </span></span>
<span id="cb19-25"><a href="#cb19-25"></a><span class="st">        &lt;str, reasoning about the answer&gt;</span></span>
<span id="cb19-26"><a href="#cb19-26"></a><span class="st">        ANSWER: &lt;str, final answer&gt;</span></span>
<span id="cb19-27"><a href="#cb19-27"></a><span class="st">        </span></span>
<span id="cb19-28"><a href="#cb19-28"></a><span class="st">        First, provide your step by step reasoning about the sequence of events. Then, in ANSWER, provide the single letter representing the correct choice you are presented with.</span></span>
<span id="cb19-29"><a href="#cb19-29"></a><span class="st">        """</span>)</span>
<span id="cb19-30"><a href="#cb19-30"></a></span>
<span id="cb19-31"><a href="#cb19-31"></a>    fewshot_examples <span class="op">=</span> [</span>
<span id="cb19-32"><a href="#cb19-32"></a>        (</span>
<span id="cb19-33"><a href="#cb19-33"></a>            <span class="st">"Alice, Bob, Claire, Dave, and Eve are dancers at a square dance. At the start of a song, they each have a partner: Alice is dancing with Patrick, Bob is dancing with Sam, Claire is dancing with Jamie, Dave is dancing with Lola, and Eve is dancing with Melissa.</span><span class="ch">\n</span><span class="st">Throughout the song, the dancers often trade partners. First, Dave and Eve switch partners. Then, Dave and Alice switch partners. Then, Eve and Alice switch partners. Then, Claire and Bob switch partners. Finally, Dave and Alice switch partners. At the end of the dance, Alice is dancing with</span><span class="ch">\n</span><span class="st">Options:</span><span class="ch">\n</span><span class="st">(A) Patrick</span><span class="ch">\n</span><span class="st">(B) Sam</span><span class="ch">\n</span><span class="st">(C) Jamie</span><span class="ch">\n</span><span class="st">(D) Lola</span><span class="ch">\n</span><span class="st">(E) Melissa"</span>,</span>
<span id="cb19-34"><a href="#cb19-34"></a>            <span class="st">"Dave and Eve switch partners, so Dave's partner is now Melissa and Eve's partner is now Patrick. Then Dave and Alice switch partners so Dave's partner is now Patrick and Alice's partner is now Melissa. Then Eve and Alice switch partners so Eve's partner is now Melissa and Alice's partner is now Lola. Then Claire and Bob switch patners so Claire's partner is now Sam, and Bob's partner is now Jamie. Finally, Dave and Alice switch partners so Dave's new partner is Lola, and Alice's new partner is Patrick. Alice is dance in with Patrick, choice A."</span>,</span>
<span id="cb19-35"><a href="#cb19-35"></a>            <span class="st">"A"</span>,</span>
<span id="cb19-36"><a href="#cb19-36"></a>        ),</span>
<span id="cb19-37"><a href="#cb19-37"></a>        (</span>
<span id="cb19-38"><a href="#cb19-38"></a>            <span class="st">"Alice, Bob, Claire, Dave, and Eve are dancers at a square dance. At the start of a song, they each have a partner: Alice is dancing with Ophelia, Bob is dancing with Jamie, Claire is dancing with Melissa, Dave is dancing with Rodrigo, and Eve is dancing with Patrick.</span><span class="ch">\n</span><span class="st">Throughout the song, the dancers often trade partners. First, Claire and Bob switch partners. Then, Claire and Eve switch partners. Then, Claire and Bob switch partners. Then, Eve and Dave switch partners. Finally, Claire and Alice switch partners. At the end of the dance, Alice is dancing with</span><span class="ch">\n</span><span class="st">Options:</span><span class="ch">\n</span><span class="st">(A) Ophelia</span><span class="ch">\n</span><span class="st">(B) Jamie</span><span class="ch">\n</span><span class="st">(C) Melissa</span><span class="ch">\n</span><span class="st">(D) Rodrigo</span><span class="ch">\n</span><span class="st">(E) Patrick"</span>,</span>
<span id="cb19-39"><a href="#cb19-39"></a>            <span class="st">"Claire and Bob switch partners, so Claire's partner is now Jamie and Bob's partner is now Melissa. Then, Claire and Eve switch partners, so Claire's partner becomes Patrick and Eve's partner becomes Jamie. Next, Claire and Bob switch partners again, making Claire's partner Melissa and Bob's partner Patrick. After that, Eve and Dave switch partners, resulting in Eve's partner being Rodrigo and Dave's partner being Jamie. Finally, Claire and Alice switch partners, so Claire's partner is now Ophelia and Alice's partner becomes Melissa. Alice is dancing with Melissa, which is choice C."</span>,</span>
<span id="cb19-40"><a href="#cb19-40"></a>            <span class="st">"C"</span>,</span>
<span id="cb19-41"><a href="#cb19-41"></a>        ),</span>
<span id="cb19-42"><a href="#cb19-42"></a>        (</span>
<span id="cb19-43"><a href="#cb19-43"></a>            <span class="st">"Alice, Bob, Claire, Dave, and Eve are friends and avid readers who occasionally trade books. At the start of the semester, they each buy one new book: Alice gets Catch-22, Bob gets Hound of the Baskervilles, Claire gets Frankenstein, Dave gets The Pearl, and Eve gets The Fellowship of the Ring.</span><span class="ch">\n</span><span class="st">As the semester proceeds, they start trading around the new books. First, Eve and Alice swap books. Then, Alice and Claire swap books. Then, Alice and Bob swap books. Then, Dave and Alice swap books. Finally, Dave and Claire swap books. At the end of the semester, Dave has</span><span class="ch">\n</span><span class="st">Options:</span><span class="ch">\n</span><span class="st">(A) Catch-22</span><span class="ch">\n</span><span class="st">(B) Hound of the Baskervilles</span><span class="ch">\n</span><span class="st">(C) Frankenstein</span><span class="ch">\n</span><span class="st">(D) The Pearl</span><span class="ch">\n</span><span class="st">(E) The Fellowship of the Ring"</span>,</span>
<span id="cb19-44"><a href="#cb19-44"></a>            <span class="st">"First, Eve and Alice swap, so Alice gets The Fellowship of the Ring and Eve gets Catch-22. Next, Alice and Claire swap, giving Claire The Fellowship of the Ring and Alice Frankenstein. Then, Alice and Bob swap, resulting in Bob holding Frankenstein and Alice having Hound of the Baskervilles. Dave and Alice then swap, so Dave takes Hound of the Baskervilles and Alice receives The Pearl. Finally, Dave and Claire swap books, which means Dave takes The Fellowship of the Ring from Claire. Therefore, at the end of all the swaps, Dave possesses The Fellowship of the Ring, making option E the correct answer."</span>,</span>
<span id="cb19-45"><a href="#cb19-45"></a>            <span class="st">"E"</span>,</span>
<span id="cb19-46"><a href="#cb19-46"></a>        ),</span>
<span id="cb19-47"><a href="#cb19-47"></a>    ]</span>
<span id="cb19-48"><a href="#cb19-48"></a></span>
<span id="cb19-49"><a href="#cb19-49"></a>    messages <span class="op">=</span> [</span>
<span id="cb19-50"><a href="#cb19-50"></a>        {</span>
<span id="cb19-51"><a href="#cb19-51"></a>            <span class="st">"role"</span>: <span class="st">"system"</span>,</span>
<span id="cb19-52"><a href="#cb19-52"></a>            <span class="st">"content"</span>: system_prompt,</span>
<span id="cb19-53"><a href="#cb19-53"></a>        },</span>
<span id="cb19-54"><a href="#cb19-54"></a>    ]</span>
<span id="cb19-55"><a href="#cb19-55"></a>    <span class="cf">for</span> example_q, example_reason, example_ans <span class="kw">in</span> fewshot_examples:</span>
<span id="cb19-56"><a href="#cb19-56"></a>        messages.append(</span>
<span id="cb19-57"><a href="#cb19-57"></a>            {</span>
<span id="cb19-58"><a href="#cb19-58"></a>                <span class="st">"role"</span>: <span class="st">"user"</span>,</span>
<span id="cb19-59"><a href="#cb19-59"></a>                <span class="st">"content"</span>: <span class="ss">f"Question: </span><span class="sc">{</span>example_q<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb19-60"><a href="#cb19-60"></a>            }</span>
<span id="cb19-61"><a href="#cb19-61"></a>        )</span>
<span id="cb19-62"><a href="#cb19-62"></a>        <span class="cf">if</span> prompt_type <span class="op">==</span> PromptType.STRUCTURED_GENERATION.value:</span>
<span id="cb19-63"><a href="#cb19-63"></a>            response <span class="op">=</span> <span class="ss">f'</span><span class="ch">{{</span><span class="ss">"reasoning": "</span><span class="sc">{</span>example_reason<span class="sc">}</span><span class="ss">", "answer": "</span><span class="sc">{</span>example_ans<span class="sc">}</span><span class="ss">"</span><span class="ch">}}</span><span class="ss">'</span></span>
<span id="cb19-64"><a href="#cb19-64"></a>        <span class="cf">else</span>:</span>
<span id="cb19-65"><a href="#cb19-65"></a>            response <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>example_reason<span class="sc">}</span><span class="ch">\n</span><span class="ss">ANSWER: </span><span class="sc">{</span>example_ans<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb19-66"><a href="#cb19-66"></a>        messages.append(</span>
<span id="cb19-67"><a href="#cb19-67"></a>            {</span>
<span id="cb19-68"><a href="#cb19-68"></a>                <span class="st">"role"</span>: <span class="st">"assistant"</span>,</span>
<span id="cb19-69"><a href="#cb19-69"></a>                <span class="st">"content"</span>: response,</span>
<span id="cb19-70"><a href="#cb19-70"></a>            }</span>
<span id="cb19-71"><a href="#cb19-71"></a>        )</span>
<span id="cb19-72"><a href="#cb19-72"></a></span>
<span id="cb19-73"><a href="#cb19-73"></a>    messages.extend(</span>
<span id="cb19-74"><a href="#cb19-74"></a>        [</span>
<span id="cb19-75"><a href="#cb19-75"></a>            {</span>
<span id="cb19-76"><a href="#cb19-76"></a>                <span class="st">"role"</span>: <span class="st">"user"</span>,</span>
<span id="cb19-77"><a href="#cb19-77"></a>                <span class="st">"content"</span>: <span class="ss">f"Question: </span><span class="sc">{</span>question<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb19-78"><a href="#cb19-78"></a>            }</span>
<span id="cb19-79"><a href="#cb19-79"></a>        ]</span>
<span id="cb19-80"><a href="#cb19-80"></a>    )</span>
<span id="cb19-81"><a href="#cb19-81"></a>    <span class="cf">return</span> tokenizer.apply_chat_template(messages, tokenize<span class="op">=</span><span class="va">False</span>, add_generation_prompt<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-82"><a href="#cb19-82"></a></span>
<span id="cb19-83"><a href="#cb19-83"></a></span>
<span id="cb19-84"><a href="#cb19-84"></a><span class="kw">def</span> parse_response_shuffled_objects(response: <span class="bu">str</span>, prompt_type: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb19-85"><a href="#cb19-85"></a>    <span class="cf">if</span> prompt_type <span class="op">==</span> PromptType.STRUCTURED_GENERATION.value:</span>
<span id="cb19-86"><a href="#cb19-86"></a>        <span class="cf">return</span> json.loads(response)[<span class="st">"answer"</span>].upper()</span>
<span id="cb19-87"><a href="#cb19-87"></a>    <span class="cf">else</span>:</span>
<span id="cb19-88"><a href="#cb19-88"></a>        <span class="cf">return</span> response.split(<span class="st">"</span><span class="ch">\n</span><span class="st">ANSWER:"</span>)[<span class="dv">1</span>].rstrip(<span class="st">"."</span>).strip().upper()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="c314b206" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1"></a>evaluator <span class="op">=</span> LLMEvaluator(</span>
<span id="cb20-2"><a href="#cb20-2"></a>    configs<span class="op">=</span>CONFIGS,</span>
<span id="cb20-3"><a href="#cb20-3"></a>    create_prompt_fn<span class="op">=</span>create_prompt_shuffled_objects,</span>
<span id="cb20-4"><a href="#cb20-4"></a>    parse_response_fn<span class="op">=</span>parse_response_shuffled_objects,</span>
<span id="cb20-5"><a href="#cb20-5"></a>    response_model<span class="op">=</span>Response,</span>
<span id="cb20-6"><a href="#cb20-6"></a>    max_tokens<span class="op">=</span><span class="dv">300</span>,</span>
<span id="cb20-7"><a href="#cb20-7"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="11d87fb5" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1"></a>dataset <span class="op">=</span> load_dataset(</span>
<span id="cb21-2"><a href="#cb21-2"></a>    <span class="st">"openeval/BIG-Bench-Hard"</span>, data_files<span class="op">=</span><span class="st">"tracking_shuffled_objects_five_objects.json"</span></span>
<span id="cb21-3"><a href="#cb21-3"></a>)</span>
<span id="cb21-4"><a href="#cb21-4"></a>evals <span class="op">=</span> [</span>
<span id="cb21-5"><a href="#cb21-5"></a>    {</span>
<span id="cb21-6"><a href="#cb21-6"></a>        <span class="st">"question"</span>: d[<span class="st">"input"</span>],</span>
<span id="cb21-7"><a href="#cb21-7"></a>        <span class="st">"answer"</span>: d[<span class="st">"target"</span>].replace(<span class="st">"("</span>, <span class="st">""</span>).replace(<span class="st">")"</span>, <span class="st">""</span>).strip().upper(),</span>
<span id="cb21-8"><a href="#cb21-8"></a>    }</span>
<span id="cb21-9"><a href="#cb21-9"></a>    <span class="cf">for</span> d <span class="kw">in</span> dataset[<span class="st">"train"</span>][<span class="st">"examples"</span>][<span class="dv">0</span>][<span class="dv">4</span>:]  <span class="co"># first 3 are few-shot examples</span></span>
<span id="cb21-10"><a href="#cb21-10"></a>]</span>
<span id="cb21-11"><a href="#cb21-11"></a></span>
<span id="cb21-12"><a href="#cb21-12"></a><span class="cf">if</span> USE_SAMPLE:</span>
<span id="cb21-13"><a href="#cb21-13"></a>    evals <span class="op">=</span> evals[:<span class="dv">5</span>]</span>
<span id="cb21-14"><a href="#cb21-14"></a></span>
<span id="cb21-15"><a href="#cb21-15"></a>df <span class="op">=</span> evaluator.generate_outputs(evals)</span>
<span id="cb21-16"><a href="#cb21-16"></a>df_results <span class="op">=</span> evaluator.evaluate_outputs(df)</span>
<span id="cb21-17"><a href="#cb21-17"></a></span>
<span id="cb21-18"><a href="#cb21-18"></a>df_results.to_csv(<span class="st">"shuffled_objects_results.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="8ef07430" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1"></a>evaluator.calculate_confidence_intervals(df_results)</span>
<span id="cb22-2"><a href="#cb22-2"></a>evaluator.run_paired_t_test(df_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Calculating confidence intervals (0.95) with 246 observations:
score_nl - Mean: 42.68% CI: 36.49% - 48.88%
score_sg - Mean: 43.90% CI: 37.69% - 50.12%

score_nl vs score_sg
t-statistic: -0.5380372188223832, p-value: 0.591039777132225</code></pre>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/dylancastillo\.co");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>Copyright 2024, Dylan Castillo</p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>