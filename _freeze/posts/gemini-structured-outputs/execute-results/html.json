{
  "hash": "2091491edb1cc29817b7b3c9767f2d70",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"The good, the bad, and the ugly of Gemini's structured outputs\"\ndate: \"12/27/2024\"\ndescription-meta: \"This article will go over Gemini's structured outputs and how they compare to unstructured outputs.\"\ncategories:\n  - llm\n  - gemini\n  - pydantic\n  - python\n---\n\n\nI've always wanted to believe that structured outputs don't have any impact on the performance of LLMs. For a long time, I actively ignored any suggestion they might.\n\nBut after reading [Let Me Speak Freely?](https://arxiv.org/abs/2408.02442) and [.txt's rebuttal](https://blog.dottxt.co/say-what-you-mean.html), I decided to run some benchmarks myself using popular proprietary models. I started with [_GPT-4o-mini_](https://dylancastillo.co/posts/say-what-you-mean-sometimes.html), and found that structured outputs could indeed decrease performance in some tasks.\n\nI was also curious to see if the same was true for _Gemini 1.5 Flash_. The answer is not so straightforward. Plus, I found some unexpected behaviors of Gemini's Generative AI SDK.\n\nIn this article, I'll share the results from running various benchmarks for _Gemini 1.5 Flash_ comparing structured and unstructured outputs and the learnings I had along the way. You can find the full code to run the benchmarks yourself in this [GitHub repository](https://github.com/dylanjcastillo/blog/tree/main/_extras/gemini-structured-outputs).\n\n## Results (TLDR)\n\nIf you're in a hurry, here are my key findings:\n\n- **The good**: Gemini's structured outputs performed on par with unstructured outputs.^[Assuming “structured outputs” refers to any method that generates LLM output adhering to a JSON schema.]\n- **The bad**: This only holds for the less rigid interpretation of \"structured outputs\". When testing constrained decoding specifically, Gemini’s structured outputs performed worse than unstructured outputs.\n- **The ugly**: Function calling and constrained decoding have a big design flaw. The order of the keys specified in the schema is not preserved when using the [Generative AI Python SDK](https://ai.google.dev/). This will break chain-of-thought reasoning in your applications unless you use a workaround (that only works for constrained decoding).\n\nThe figure below shows the overall results for _Gemini 1.5 Flash_:\n\n::: {#cell-fig-gemini-flash-best .cell execution_count=1}\n\n::: {#fig-gemini-flash-best .cell-output .cell-output-display}\n```{=html}\n<div>                            <div id=\"bbf90715-1536-48bf-af36-d0f900b4ab0e\" class=\"plotly-graph-div\" style=\"height:400px; width:100%;\"></div>            <script type=\"text/javascript\">                require([\"plotly\"], function(Plotly) {                    window.PLOTLYENV=window.PLOTLYENV || {};                                    if (document.getElementById(\"bbf90715-1536-48bf-af36-d0f900b4ab0e\")) {                    Plotly.newPlot(                        \"bbf90715-1536-48bf-af36-d0f900b4ab0e\",                        [{\"hoverinfo\":\"skip\",\"name\":\"Natural Language\",\"text\":[\"94.84\",\"82.67\",\"97.15\"],\"textfont\":{\"size\":10},\"textposition\":\"outside\",\"texttemplate\":\"%{text:.2f}%\",\"x\":[\"GSM8k\",\"Last Letter\",\"Shuffled Objects\"],\"y\":[94.84,82.67,97.15],\"type\":\"bar\"},{\"hoverinfo\":\"skip\",\"name\":\"JSON-Schema\",\"text\":[\"93.63\",\"81.33\",\"86.18\"],\"textfont\":{\"size\":10},\"textposition\":\"outside\",\"texttemplate\":\"%{text:.2f}%\",\"x\":[\"GSM8k\",\"Last Letter\",\"Shuffled Objects\"],\"y\":[93.63,81.33,86.18],\"type\":\"bar\"},{\"hoverinfo\":\"skip\",\"name\":\"JSON-Prompt\",\"text\":[\"94.16\",\"82.0\",\"98.37\"],\"textfont\":{\"size\":10},\"textposition\":\"outside\",\"texttemplate\":\"%{text:.2f}%\",\"x\":[\"GSM8k\",\"Last Letter\",\"Shuffled Objects\"],\"y\":[94.16,82.0,98.37],\"type\":\"bar\"}],                        {\"template\":{\"data\":{\"barpolar\":[{\"marker\":{\"line\":{\"color\":\"rgb(17,17,17)\",\"width\":0.5},\"pattern\":{\"fillmode\":\"overlay\",\"size\":10,\"solidity\":0.2}},\"type\":\"barpolar\"}],\"bar\":[{\"error_x\":{\"color\":\"#f2f5fa\"},\"error_y\":{\"color\":\"#f2f5fa\"},\"marker\":{\"line\":{\"color\":\"rgb(17,17,17)\",\"width\":0.5},\"pattern\":{\"fillmode\":\"overlay\",\"size\":10,\"solidity\":0.2}},\"type\":\"bar\"}],\"carpet\":[{\"aaxis\":{\"endlinecolor\":\"#A2B1C6\",\"gridcolor\":\"#506784\",\"linecolor\":\"#506784\",\"minorgridcolor\":\"#506784\",\"startlinecolor\":\"#A2B1C6\"},\"baxis\":{\"endlinecolor\":\"#A2B1C6\",\"gridcolor\":\"#506784\",\"linecolor\":\"#506784\",\"minorgridcolor\":\"#506784\",\"startlinecolor\":\"#A2B1C6\"},\"type\":\"carpet\"}],\"choropleth\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"type\":\"choropleth\"}],\"contourcarpet\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"type\":\"contourcarpet\"}],\"contour\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"type\":\"contour\"}],\"heatmapgl\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"type\":\"heatmapgl\"}],\"heatmap\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"type\":\"heatmap\"}],\"histogram2dcontour\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"type\":\"histogram2dcontour\"}],\"histogram2d\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"type\":\"histogram2d\"}],\"histogram\":[{\"marker\":{\"pattern\":{\"fillmode\":\"overlay\",\"size\":10,\"solidity\":0.2}},\"type\":\"histogram\"}],\"mesh3d\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"type\":\"mesh3d\"}],\"parcoords\":[{\"line\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"parcoords\"}],\"pie\":[{\"automargin\":true,\"type\":\"pie\"}],\"scatter3d\":[{\"line\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scatter3d\"}],\"scattercarpet\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scattercarpet\"}],\"scattergeo\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scattergeo\"}],\"scattergl\":[{\"marker\":{\"line\":{\"color\":\"#283442\"}},\"type\":\"scattergl\"}],\"scattermapbox\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scattermapbox\"}],\"scatterpolargl\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scatterpolargl\"}],\"scatterpolar\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scatterpolar\"}],\"scatter\":[{\"marker\":{\"line\":{\"color\":\"#283442\"}},\"type\":\"scatter\"}],\"scatterternary\":[{\"marker\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"type\":\"scatterternary\"}],\"surface\":[{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"},\"colorscale\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"type\":\"surface\"}],\"table\":[{\"cells\":{\"fill\":{\"color\":\"#506784\"},\"line\":{\"color\":\"rgb(17,17,17)\"}},\"header\":{\"fill\":{\"color\":\"#2a3f5f\"},\"line\":{\"color\":\"rgb(17,17,17)\"}},\"type\":\"table\"}]},\"layout\":{\"annotationdefaults\":{\"arrowcolor\":\"#f2f5fa\",\"arrowhead\":0,\"arrowwidth\":1},\"autotypenumbers\":\"strict\",\"coloraxis\":{\"colorbar\":{\"outlinewidth\":0,\"ticks\":\"\"}},\"colorscale\":{\"diverging\":[[0,\"#8e0152\"],[0.1,\"#c51b7d\"],[0.2,\"#de77ae\"],[0.3,\"#f1b6da\"],[0.4,\"#fde0ef\"],[0.5,\"#f7f7f7\"],[0.6,\"#e6f5d0\"],[0.7,\"#b8e186\"],[0.8,\"#7fbc41\"],[0.9,\"#4d9221\"],[1,\"#276419\"]],\"sequential\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]],\"sequentialminus\":[[0.0,\"#0d0887\"],[0.1111111111111111,\"#46039f\"],[0.2222222222222222,\"#7201a8\"],[0.3333333333333333,\"#9c179e\"],[0.4444444444444444,\"#bd3786\"],[0.5555555555555556,\"#d8576b\"],[0.6666666666666666,\"#ed7953\"],[0.7777777777777778,\"#fb9f3a\"],[0.8888888888888888,\"#fdca26\"],[1.0,\"#f0f921\"]]},\"colorway\":[\"#636efa\",\"#EF553B\",\"#00cc96\",\"#ab63fa\",\"#FFA15A\",\"#19d3f3\",\"#FF6692\",\"#B6E880\",\"#FF97FF\",\"#FECB52\"],\"font\":{\"color\":\"#f2f5fa\"},\"geo\":{\"bgcolor\":\"rgb(17,17,17)\",\"lakecolor\":\"rgb(17,17,17)\",\"landcolor\":\"rgb(17,17,17)\",\"showlakes\":true,\"showland\":true,\"subunitcolor\":\"#506784\"},\"hoverlabel\":{\"align\":\"left\"},\"hovermode\":\"closest\",\"mapbox\":{\"style\":\"dark\"},\"margin\":{\"b\":0,\"l\":0,\"r\":0,\"t\":30},\"paper_bgcolor\":\"rgb(17,17,17)\",\"plot_bgcolor\":\"rgb(17,17,17)\",\"polar\":{\"angularaxis\":{\"gridcolor\":\"#506784\",\"linecolor\":\"#506784\",\"ticks\":\"\"},\"bgcolor\":\"rgb(17,17,17)\",\"radialaxis\":{\"gridcolor\":\"#506784\",\"linecolor\":\"#506784\",\"ticks\":\"\"}},\"scene\":{\"xaxis\":{\"backgroundcolor\":\"rgb(17,17,17)\",\"gridcolor\":\"#506784\",\"gridwidth\":2,\"linecolor\":\"#506784\",\"showbackground\":true,\"ticks\":\"\",\"zerolinecolor\":\"#C8D4E3\"},\"yaxis\":{\"backgroundcolor\":\"rgb(17,17,17)\",\"gridcolor\":\"#506784\",\"gridwidth\":2,\"linecolor\":\"#506784\",\"showbackground\":true,\"ticks\":\"\",\"zerolinecolor\":\"#C8D4E3\"},\"zaxis\":{\"backgroundcolor\":\"rgb(17,17,17)\",\"gridcolor\":\"#506784\",\"gridwidth\":2,\"linecolor\":\"#506784\",\"showbackground\":true,\"ticks\":\"\",\"zerolinecolor\":\"#C8D4E3\"}},\"shapedefaults\":{\"line\":{\"color\":\"#f2f5fa\"}},\"sliderdefaults\":{\"bgcolor\":\"#C8D4E3\",\"bordercolor\":\"rgb(17,17,17)\",\"borderwidth\":1,\"tickwidth\":0},\"ternary\":{\"aaxis\":{\"gridcolor\":\"#506784\",\"linecolor\":\"#506784\",\"ticks\":\"\"},\"baxis\":{\"gridcolor\":\"#506784\",\"linecolor\":\"#506784\",\"ticks\":\"\"},\"bgcolor\":\"rgb(17,17,17)\",\"caxis\":{\"gridcolor\":\"#506784\",\"linecolor\":\"#506784\",\"ticks\":\"\"}},\"title\":{\"x\":0.05},\"updatemenudefaults\":{\"bgcolor\":\"#506784\",\"borderwidth\":0},\"xaxis\":{\"automargin\":true,\"gridcolor\":\"#283442\",\"linecolor\":\"#506784\",\"ticks\":\"\",\"title\":{\"standoff\":15},\"zerolinecolor\":\"#283442\",\"zerolinewidth\":2},\"yaxis\":{\"automargin\":true,\"gridcolor\":\"#283442\",\"linecolor\":\"#506784\",\"ticks\":\"\",\"title\":{\"standoff\":15},\"zerolinecolor\":\"#283442\",\"zerolinewidth\":2}}},\"margin\":{\"l\":50,\"r\":50,\"t\":50,\"b\":50,\"pad\":10},\"yaxis\":{\"title\":{\"text\":\"Score (%)\"},\"range\":[0,105],\"fixedrange\":true},\"xaxis\":{\"title\":{\"text\":\"Task\"},\"fixedrange\":true},\"legend\":{\"orientation\":\"h\",\"yanchor\":\"bottom\",\"y\":1.05,\"xanchor\":\"center\",\"x\":0.5},\"modebar\":{\"remove\":[\"autoScale2d\",\"autoscale\",\"editInChartStudio\",\"editinchartstudio\",\"hoverCompareCartesian\",\"hovercompare\",\"lasso\",\"lasso2d\",\"orbitRotation\",\"orbitrotation\",\"pan\",\"pan2d\",\"pan3d\",\"reset\",\"resetCameraDefault3d\",\"resetCameraLastSave3d\",\"resetGeo\",\"resetSankeyGroup\",\"resetScale2d\",\"resetViewMap\",\"resetViewMapbox\",\"resetViews\",\"resetcameradefault\",\"resetcameralastsave\",\"resetsankeygroup\",\"resetscale\",\"resetview\",\"resetviews\",\"select\",\"select2d\",\"sendDataToCloud\",\"senddatatocloud\",\"tableRotation\",\"tablerotation\",\"toImage\",\"toggleHover\",\"toggleSpikelines\",\"togglehover\",\"togglespikelines\",\"toimage\",\"zoom\",\"zoom2d\",\"zoom3d\",\"zoomIn2d\",\"zoomInGeo\",\"zoomInMap\",\"zoomInMapbox\",\"zoomOut2d\",\"zoomOutGeo\",\"zoomOutMap\",\"zoomOutMapbox\",\"zoomin\",\"zoomout\"]},\"barmode\":\"group\",\"height\":400,\"showlegend\":true},                        {\"responsive\": true}                    ).then(function(){\n                            \nvar gd = document.getElementById('bbf90715-1536-48bf-af36-d0f900b4ab0e');\nvar x = new MutationObserver(function (mutations, observer) {{\n        var display = window.getComputedStyle(gd).display;\n        if (!display || display === 'none') {{\n            console.log([gd, 'removed!']);\n            Plotly.purge(gd);\n            observer.disconnect();\n        }}\n}});\n\n// Listen for the removal of the full notebook cells\nvar notebookContainer = gd.closest('#notebook-container');\nif (notebookContainer) {{\n    x.observe(notebookContainer, {childList: true});\n}}\n\n// Listen for the clearing of the current output cell\nvar outputEl = gd.closest('.output');\nif (outputEl) {{\n    x.observe(outputEl, {childList: true});\n}}\n\n                        })                };                });            </script>        </div>\n```\n\nBest results for Gemini 1.5 Flash.\n:::\n:::\n\n\nThe figure above compares the performance of Gemini's structured outputs to unstructured outputs. **NL** stands for _Natural Language_, which means the model writes the output in a free-form manner. In contrast, **JSON-Prompt** and **JSON-Schema** involve structured outputs that follow a predefined JSON schema.\n\nFor **JSON-Prompt**, the JSON schema is included in the prompt, instructing the model to generate JSON formatted output based on its MIME type configuration. **JSON-Schema** works similarly, but the schema is set directly in the model's configuration instead of being included in the prompt.\n\nWhen considering both **JSON-Prompt** and **JSON-Schema**, Gemini's structured outputs performed comparably to unstructured outputs. However, with **JSON-Schema** alone (i.e., constrained decoding), performance drops compared to unstructured outputs. This difference is most evident in the _Shuffled Objects_ task, where **NL** achieved a score of 97.15%, while **JSON-Schema** scored 86.18%.\n\n## Study design\n\nIn Let Me Speak Freely?, Tam et al. evaluated structured and unstructured outputs across three reasoning tasks and six classification tasks. They used exact match to evaluate the reasoning tasks and accuracy to evaluate the classification tasks. They ran the experiments using the following models:\n\n1.  **Proprietary models**: _gpt-3.5-turbo-0125_, _claude-3-haiku-20240307_, _gemini-1.5-flash_, and _gpt-4o-mini-2024-07-18_.\n2.  **Open-weight models**: _LLaMA3-8B-Instruct_, and _Gemma-2-9B-Instruct_.\n\nFor this article, I just focused on _Gemini 1.5 Flash_ and the reasoning tasks. I already ran the benchmarks for _GPT-4o-mini_ and _Llama3-8B-Instruct_ in my [previous post](https://dylancastillo.co/posts/say-what-you-mean-sometimes.html).\n\nI excluded the classification tasks because I believe structured outputs perform better in classification tasks, and this is also in line with the study's original findings. So I just focused on the three reasoning tasks:\n\n1.  [GSM8K](https://huggingface.co/datasets/openai/gsm8k): A dataset from of grade school math word problems.\n2.  [Last Letter](https://huggingface.co/datasets/ChilleD/LastLetterConcat): A dataset of simple word puzzles that require concatening the last letters of a list of names.\n3.  [Shuffled Objects](https://github.com/google/BIG-bench/tree/main/bigbench/benchmark_tasks/tracking_shuffled_objects): A dataset that requires reasoning about the state of a system after a sequence of shuffling operations.\n\nThe rest of the article details the process of re-evaluating these benchmarks using _Gemini-1.5-Flash_.\n\n## Generating structured outputs with Gemini\n\nGemini has three ways of generating structured outputs:\n\n1. [**Forced function calling (FC)**](https://ai.google.dev/gemini-api/tutorials/extract_structured_data): You force the model to call a \"function\" and that makes the model generate a JSON schema that matches the function's arguments.\n2. [**Schema in prompt (JSON-Prompt)**](https://ai.google.dev/gemini-api/docs/structured-output?lang=python#supply-schema-in-prompt): You include a JSON schema in the prompt, specify `mime_type='application/json'` and the model generates a response that matches the schema.\n3. [**Schema in model configuration (JSON-Schema)**](https://ai.google.dev/gemini-api/docs/structured-output?lang=python#supply-schema-in-config): You provide a JSON schema in the model configuration, specify `mime_type='application/json'` in the request and the model generates a response that matches the schema. This is the only method that seems to use [controlled generation](https://developers.googleblog.com/en/mastering-controlled-generation-with-gemini-15-schema-adherence/).\n\nI've included _JSON-Prompt_ and _JSON-Schema_ in the analysis, but had to exclude _FC_ because it's not possible to use it for chain-of-thought reasoning, which is a requirement for the benchmarks.\n\n## Figuring out Gemini's flawed structured outputs\n\nWhen running the three benchmarks, I quickly ran into a performance issue with _FC_ and _JSON-Schema_. In all tasks, both showed double-digit performance drops compared to _NL_.\n\nThis didn't make a lot of sense, so I started investigating.\n\nI was using the following response schema for all structured outputs:\n\n```python\nclass Response(BaseModel):\n    reasoning: str\n    answer: str\n```\n\nThe prompts were similar to the one below, adjusted according to the task:\n\n> You are an expert in solving grade school math tasks. You will be presented with a grade-school math word problem and be asked to solve it.\n>\n> You will always respond with JSON matching the following schema:\n>\n> [RESPONSE_SCHEMA]\n>\n> First, provide your step by step reasoning in the \"reasoning\" field. Then, in the \"answer\" field, provide your final answer. Don't include any other text in the \"answer\" field.\n\nI eventually realized that the performance drop in _JSON-Schema_ was due to the keys in the schema being reversed when generating the response. I then noticed that Tam et al. briefly mentioned in Let Me Speak Freely? that _JSON-Schema_ responses failed to produce valid JSON due to this exact problem, so they did not include it in their analysis.\n\nI didn't want to exclude it from the analysis, so I started looking for a way to control the order of the keys in the schema. I found that the order of the keys in the schema gets sorted alphabetically before the response is generated. To confirm this, I ran a test with 100 randomly generated schemas. Every resulting output had its keys sorted alphabetically, so it's clear this is not by chance.\n\nI also found that the Vertex AI documentation mentions a [`propertyOrdering`](https://cloud.google.com/vertex-ai/generative-ai/docs/multimodal/control-generated-output) parameter, which should allow control over the order of keys. However, this feature [doesn’t appear](https://discuss.ai.google.dev/t/issue-with-key-ordering-in-controlled-generation-on-gemini-1-5/41737/3) [to work](https://github.com/google-gemini/generative-ai-python/issues/533) with the Generative AI Python SDK.\n\nUnable to use the `propertyOrdering` parameter, I resorted to a quick workaround: I named the keys in a way that forced the desired order alphabetically. Instead of using `reasoning` and `answer`, I used `reasoning` and `solution`. This preserved the chain-of-thought reasoning in the responses, and resolved the performance drop in _JSON-Schema_.\n\nBut _FC_ was a different story. Unlike _JSON-Schema_, the order of the keys follow a less predictable pattern, and I couldn’t find a way to control it. So I decided to exclude _FC_ from the analysis.\n\n## Evaluating Gemini 1.5 Flash\n\nAfter applying the key ordering workaround, and [additional improvements](https://dylancastillo.co/posts/say-what-you-mean-sometimes.html#replicating-.txts-rebuttal.html) discussed in my analysis of GPT-4o-mini's structured outputs, I recomputed the benchmarks.\n\nThe table below shows the results for Gemini 1.5 Flash compared to the original results from Tam et al.\n\n::: {#tbl-gemini-1.5-flash .cell tbl-cap='Results for Gemini 1.5 Flash.' execution_count=2}\n\n::: {.cell-output .cell-output-display execution_count=88}\n```{=html}\n<style type=\"text/css\">\n</style>\n<table id=\"T_bf836\">\n  <thead>\n    <tr>\n      <th class=\"blank\" >&nbsp;</th>\n      <th class=\"blank level0\" >&nbsp;</th>\n      <th id=\"T_bf836_level0_col0\" class=\"col_heading level0 col0\" >NL</th>\n      <th id=\"T_bf836_level0_col1\" class=\"col_heading level0 col1\" >JSON-Prompt</th>\n      <th id=\"T_bf836_level0_col2\" class=\"col_heading level0 col2\" >JSON-Schema</th>\n    </tr>\n    <tr>\n      <th class=\"index_name level0\" >Task</th>\n      <th class=\"index_name level1\" >Method</th>\n      <th class=\"blank col0\" >&nbsp;</th>\n      <th class=\"blank col1\" >&nbsp;</th>\n      <th class=\"blank col2\" >&nbsp;</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th id=\"T_bf836_level0_row0\" class=\"row_heading level0 row0\" rowspan=\"3\">GSM8K</th>\n      <th id=\"T_bf836_level1_row0\" class=\"row_heading level1 row0\" >Tam et al.</th>\n      <td id=\"T_bf836_row0_col0\" class=\"data row0 col0\" >89.33</td>\n      <td id=\"T_bf836_row0_col1\" class=\"data row0 col1\" >89.21</td>\n      <td id=\"T_bf836_row0_col2\" class=\"data row0 col2\" >47.78</td>\n    </tr>\n    <tr>\n      <th id=\"T_bf836_level1_row1\" class=\"row_heading level1 row1\" >Me, 0-shot</th>\n      <td id=\"T_bf836_row1_col0\" class=\"data row1 col0\" >93.71</td>\n      <td id=\"T_bf836_row1_col1\" class=\"data row1 col1\" >93.78</td>\n      <td id=\"T_bf836_row1_col2\" class=\"data row1 col2\" >93.03</td>\n    </tr>\n    <tr>\n      <th id=\"T_bf836_level1_row2\" class=\"row_heading level1 row2\" >Me, 3-shot</th>\n      <td id=\"T_bf836_row2_col0\" class=\"data row2 col0\" >94.84</td>\n      <td id=\"T_bf836_row2_col1\" class=\"data row2 col1\" >94.16</td>\n      <td id=\"T_bf836_row2_col2\" class=\"data row2 col2\" >93.63</td>\n    </tr>\n    <tr>\n      <th id=\"T_bf836_level0_row3\" class=\"row_heading level0 row3\" rowspan=\"3\">Last Letter</th>\n      <th id=\"T_bf836_level1_row3\" class=\"row_heading level1 row3\" >Tam et al.</th>\n      <td id=\"T_bf836_row3_col0\" class=\"data row3 col0\" >65.45</td>\n      <td id=\"T_bf836_row3_col1\" class=\"data row3 col1\" >77.02</td>\n      <td id=\"T_bf836_row3_col2\" class=\"data row3 col2\" >0.67</td>\n    </tr>\n    <tr>\n      <th id=\"T_bf836_level1_row4\" class=\"row_heading level1 row4\" >Me, 0-shot</th>\n      <td id=\"T_bf836_row4_col0\" class=\"data row4 col0\" >82.67</td>\n      <td id=\"T_bf836_row4_col1\" class=\"data row4 col1\" >80.00</td>\n      <td id=\"T_bf836_row4_col2\" class=\"data row4 col2\" >81.33</td>\n    </tr>\n    <tr>\n      <th id=\"T_bf836_level1_row5\" class=\"row_heading level1 row5\" >Me, 3-shot</th>\n      <td id=\"T_bf836_row5_col0\" class=\"data row5 col0\" >80.00</td>\n      <td id=\"T_bf836_row5_col1\" class=\"data row5 col1\" >82.00</td>\n      <td id=\"T_bf836_row5_col2\" class=\"data row5 col2\" >80.67</td>\n    </tr>\n    <tr>\n      <th id=\"T_bf836_level0_row6\" class=\"row_heading level0 row6\" rowspan=\"3\">Shuffled Obj.</th>\n      <th id=\"T_bf836_level1_row6\" class=\"row_heading level1 row6\" >Tam et al.</th>\n      <td id=\"T_bf836_row6_col0\" class=\"data row6 col0\" >58.21</td>\n      <td id=\"T_bf836_row6_col1\" class=\"data row6 col1\" >65.07</td>\n      <td id=\"T_bf836_row6_col2\" class=\"data row6 col2\" >N/A</td>\n    </tr>\n    <tr>\n      <th id=\"T_bf836_level1_row7\" class=\"row_heading level1 row7\" >Me, 0-shot</th>\n      <td id=\"T_bf836_row7_col0\" class=\"data row7 col0\" >97.15</td>\n      <td id=\"T_bf836_row7_col1\" class=\"data row7 col1\" >92.28</td>\n      <td id=\"T_bf836_row7_col2\" class=\"data row7 col2\" >86.18</td>\n    </tr>\n    <tr>\n      <th id=\"T_bf836_level1_row8\" class=\"row_heading level1 row8\" >Me, 3-shot</th>\n      <td id=\"T_bf836_row8_col0\" class=\"data row8 col0\" >92.68</td>\n      <td id=\"T_bf836_row8_col1\" class=\"data row8 col1\" >98.37</td>\n      <td id=\"T_bf836_row8_col2\" class=\"data row8 col2\" >84.96</td>\n    </tr>\n  </tbody>\n</table>\n```\n:::\n:::\n\n\nUsing a 0-shot prompt and 3-shot prompts, I was able to improve all the metrics on the tasks and methods Tam et al. used for their benchmarks. Which is great!\n\n_NL_ and _JSON-Prompt_ behave similarly, without a clear winner between them. Each method got a slight edge over the other half the time. On the other hand, _JSON-Schema_ performed worst than _NL_ in 5 out of 6 tasks. Plus, in _Shuffled Objects_, it did so with a gap of more than 10 percentage points: 97.15% for _NL_ vs. 86.18% for _JSON-Schema_.\n\nTam et al. defined structured outputs as any method that \"involves providing output in standardized formats like JSON or XML through format restriction.\" Using this definition, the results show no performance gap between structured and unstructured outputs. This directly contradicts the study's original claim.\n\nBut if you take the also common interpretation that constrained decoding is the only form of structured generation, then the study's original conclusion still applies: there is indeed a significant performance gap between structured and unstructured outputs.\n\nWeird, I know. But that's the way it is.\n\n## Conclusion\n\nSimilar to my [previous post](https://dylancastillo.co/posts/say-what-you-mean-sometimes.html), the results are also mixed for Gemini 1.5 Flash.\n\nThe good news is that structured outputs perform on par with unstructured ones. The bad news is that this only holds if you adopt a more flexible definition of “structured outputs.” And the ugly news is that they have a major issue in how they handle the order of keys in the schema you provide to the model.\n\nBut you shouldn't be disappointed. For me, it only reinforces the idea that you shouldn’t blindly trust random posts or papers on arXiv. If you want to improve your LLM workflows, you need to test things for yourself.\n\nStructured outputs are great. They make my life easier when working with LLMs. But there are tasks where they might perform worse (or better!) than unstructured outputs, and that's something I need to keep in mind.\n\nSo, this long post is just a reminder to run your own evals and choose the approach that works best for you.\n\nYou can find the code to replicate my results in this [GitHub repository](https://github.com/dylanjcastillo/blog/tree/main/_extras/gemini-structured-outputs).\n\n",
    "supporting": [
      "gemini-structured-outputs_files"
    ],
    "filters": [],
    "includes": {
      "include-in-header": [
        "<script src=\"https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js\" integrity=\"sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==\" crossorigin=\"anonymous\"></script>\n<script src=\"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js\" integrity=\"sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==\" crossorigin=\"anonymous\" data-relocate-top=\"true\"></script>\n<script type=\"application/javascript\">define('jquery', [],function() {return window.jQuery;})</script>\n<script type=\"text/javascript\">\nwindow.PlotlyConfig = {MathJaxConfig: 'local'};\nif (window.MathJax && window.MathJax.Hub && window.MathJax.Hub.Config) {window.MathJax.Hub.Config({SVG: {font: \"STIX-Web\"}});}\nif (typeof require !== 'undefined') {\nrequire.undef(\"plotly\");\nrequirejs.config({\n    paths: {\n        'plotly': ['https://cdn.plot.ly/plotly-2.35.2.min']\n    }\n});\nrequire(['plotly'], function(Plotly) {\n    window._Plotly = Plotly;\n});\n}\n</script>\n\n"
      ]
    }
  }
}