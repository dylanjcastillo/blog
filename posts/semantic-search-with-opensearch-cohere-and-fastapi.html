<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Dylan Castillo">
<meta name="dcterms.date" content="2023-04-11">
<meta name="description" content="In this tutorial, I’ll you’ll learn how to build a semantic search service using OpenSearch, Cohere, and FastAPI. You’ll create an app that lets users search through news articles to find the ones that are most relevant to their query.">

<title>Semantic Search with OpenSearch, Cohere, and FastAPI – Dylan Castillo</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../images/logo.webp" rel="icon">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark-2fef5ea3f8957b3e4ecc936fc74692ca.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-7087bcf82a3c6fa223fe00ad8f3b6ef0.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="dark">
<script src="../site_libs/quarto-contrib/iconify-2.1.0/iconify-icon.min.js"></script>
<script src="../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;0,900;1,300;1,400;1,700;1,900&amp;display=swap" rel="stylesheet">
<script src="https://cdn.usefathom.com/script.js" data-site="ZJFQREIA" defer=""></script>


<meta property="og:title" content="Semantic Search with OpenSearch, Cohere, and FastAPI – Dylan Castillo">
<meta property="og:description" content="">
<meta property="og:image" content="https://dylancastillo.co/posts/semantic-search-with-opensearch-cohere-and-fastapi/image.png">
<meta property="og:site_name" content="Dylan Castillo">
<meta name="twitter:title" content="Semantic Search with OpenSearch, Cohere, and FastAPI – Dylan Castillo">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="https://dylancastillo.co/posts/semantic-search-with-opensearch-cohere-and-fastapi/image.png">
<meta name="twitter:creator" content="@dylanjcastillo">
<meta name="twitter:site" content="@dylanjcastillo">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../projects.html"> 
<span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/dylanjcastillo"> 
<span class="menu-text"><iconify-icon role="img" inline="" icon="fa6-brands:github" aria-label="Icon github from fa6-brands Iconify.design set." title="Icon github from fa6-brands Iconify.design set."></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.linkedin.com/in/dylanjcastillo/"> 
<span class="menu-text"><iconify-icon role="img" inline="" icon="fa6-brands:linkedin" aria-label="Icon linkedin from fa6-brands Iconify.design set." title="Icon linkedin from fa6-brands Iconify.design set."></iconify-icon></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#prerequisites" id="toc-prerequisites" class="nav-link active" data-scroll-target="#prerequisites">Prerequisites</a></li>
  <li><a href="#keyword-based-search-vs.-semantic-search" id="toc-keyword-based-search-vs.-semantic-search" class="nav-link" data-scroll-target="#keyword-based-search-vs.-semantic-search">Keyword-based Search vs.&nbsp;Semantic Search</a></li>
  <li><a href="#architecting-a-semantic-search-service" id="toc-architecting-a-semantic-search-service" class="nav-link" data-scroll-target="#architecting-a-semantic-search-service">Architecting a Semantic Search Service</a></li>
  <li><a href="#set-up-your-local-environment" id="toc-set-up-your-local-environment" class="nav-link" data-scroll-target="#set-up-your-local-environment">Set Up Your Local Environment</a></li>
  <li><a href="#run-a-local-opensearch-cluster" id="toc-run-a-local-opensearch-cluster" class="nav-link" data-scroll-target="#run-a-local-opensearch-cluster">Run a Local OpenSearch Cluster</a></li>
  <li><a href="#vectorize-the-articles" id="toc-vectorize-the-articles" class="nav-link" data-scroll-target="#vectorize-the-articles">Vectorize the Articles</a></li>
  <li><a href="#index-the-vectors-and-metadata" id="toc-index-the-vectors-and-metadata" class="nav-link" data-scroll-target="#index-the-vectors-and-metadata">Index the Vectors and Metadata</a></li>
  <li><a href="#create-a-search-client" id="toc-create-a-search-client" class="nav-link" data-scroll-target="#create-a-search-client">Create a Search Client</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
</nav>
    <div class="quarto-margin-footer"><div class="margin-footer-item">
<button onclick="window.location.href='https://subscribe.dylancastillo.co'" style="background-color: #eb841b; color: white; padding: 12px 24px; border: none; border-radius: 6px; font-size: 12px; font-weight: bold; cursor: pointer; transition: background-color 0.3s ease;">
Subscribe to my newsletter
</button>
</div></div></div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Semantic Search with OpenSearch, Cohere, and FastAPI</h1>
  <div class="quarto-categories">
    <div class="quarto-category">python</div>
    <div class="quarto-category">ml</div>
    <div class="quarto-category">nlp</div>
  </div>
  </div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author"><a href="https://dylancastillo.co">Dylan Castillo</a> </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            <a href="https://iwanalabs.com">
            Iwana Labs
            </a>
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">April 11, 2023</p>
    </div>
  </div>
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">July 13, 2024</p>
    </div>
  </div>
    
  </div>
  


</header>


<p>Semantic search is a <a href="https://trends.google.com/trends/explore?date=today%205-y&amp;q=semantic%20search">hot topic</a> right now. The fast-paced progress of Large Language Models (LLMs), as well as the availability and quality of embeddings, the key technology behind semantic search, have piqued the interest of many people in this field.</p>
<p>I’ve worked on a number of projects involving semantic search (before it was cool!), and have been closely following the progress in LLMs. So I decided to write a step-by-step tutorial that combined these two technologies.</p>
<p>In this tutorial, I’ll show you how to build a semantic search service using <a href="https://opensearch.org/">OpenSearch</a>, <a href="https://cohere.ai/">Cohere</a>, and <a href="fastapi.tiangolo.com/">FastAPI</a>. You’ll create an app that lets users search through news articles to find the ones that are most relevant to their query.</p>
<p>Let’s get started!</p>
<section id="prerequisites" class="level2">
<h2 class="anchored" data-anchor-id="prerequisites">Prerequisites</h2>
<p>There are a few things you need to know to get the most out of this tutorial:</p>
<ol type="1">
<li>What <a href="https://blog.dataiku.com/semantic-search-an-overlooked-nlp-superpower?ref=dylancastillo.co">semantic search</a> is.</li>
<li>How <a href="https://dylancastillo.co/opensearch-python/">OpenSearch</a> works.</li>
<li>What <a href="https://en.wikipedia.org/wiki/Large_language_model">LLMs</a> are.</li>
</ol>
<p>Don’t feel discouraged if some of these concepts are new to you. A basic understanding of these topics should be enough to complete this tutorial.</p>
<p>In addition, you must install <a href="https://docs.docker.com/get-docker/">Docker</a> and create an account at <a href="https://cohere.ai/">Cohere</a>.</p>
</section>
<section id="keyword-based-search-vs.-semantic-search" class="level2">
<h2 class="anchored" data-anchor-id="keyword-based-search-vs.-semantic-search">Keyword-based Search vs.&nbsp;Semantic Search</h2>
<p>Search engines have evolved over time to provide users with more relevant results. In the past, search engines relied on keyword matching to deliver these results. For example, if a user searched for “AI chatbot,” the search engine would find documents that included that phrase and show them based on a ranking system like <a href="https://en.wikipedia.org/wiki/PageRank">PageRank</a>.</p>
<p>This method worked well for finding results that contained specific keywords but fell short when users sought information that was related to, but not identical to, their initial query. For example, a search for “machine learning” might yield more relevant results if it also considered semantically similar terms such as “artificial intelligence” or “deep learning”.</p>
<p>Enter <a href="https://en.wikipedia.org/wiki/Semantic_search">semantic search</a>. It is a more sophisticated method that takes into account factors like synonyms, user context, and concept relationships when generating search results. By considering these factors, this approach provides users with better sets of results.</p>
</section>
<section id="architecting-a-semantic-search-service" class="level2">
<h2 class="anchored" data-anchor-id="architecting-a-semantic-search-service">Architecting a Semantic Search Service</h2>
<p>Aside from the data extraction pipeline, which I’m not including here, the semantic search service you’ll create has four parts:</p>
<ol type="1">
<li><strong>Vectorizer:</strong> This takes care of creating numerical vectors, called <a href="https://en.wikipedia.org/wiki/Word_embedding">embeddings</a>, from the documents (news articles) in your dataset.</li>
<li><strong>Indexer:</strong> This adds the embeddings and the metadata such as URL, title, and author to the vector database.</li>
<li><strong>Vector database:</strong> This is a database that stores and retrieves vectors representing documents.</li>
<li><strong>Search client:</strong> This is a FastAPI-based backend service that processes the user’s query, vectorizes it, and searches the vector database for the most similar vectors.</li>
</ol>
<p>Here’s a diagram of all the components:</p>
<p><a href="semantic-search-with-opensearch-cohere-and-fastapi/image.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="semantic-search-with-opensearch-cohere-and-fastapi/image.png" class="img-fluid"></a></p>
<p>Architecture diagram</p>
<p>Next, you’ll set up your local environment to run the project.</p>
</section>
<section id="set-up-your-local-environment" class="level2">
<h2 class="anchored" data-anchor-id="set-up-your-local-environment">Set Up Your Local Environment</h2>
<p>Follow these steps to set up your local environment:</p>
<ol type="1">
<li>Install <a href="https://www.python.org/downloads/">Python 3.11</a>.</li>
<li>Clone the repository with the sample app:</li>
</ol>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">git</span> clone https://github.com/dylanjcastillo/opensearch-cohere-semantic-search</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="3" type="1">
<li>Go to the root folder of the project and create a virtual environment with the dependencies using <strong>venv and pip:</strong></li>
</ol>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1"></a><span class="ex">python3.11</span> <span class="at">-m</span> venv .venv <span class="kw">&amp;&amp;</span> <span class="bu">source</span> .venv/bin/activate</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="ex">pip</span> install <span class="at">-r</span> requirements.txt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Assuming all went smoothly, you should have a virtual environment set up with the required libraries and the following project structure:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1"></a><span class="ex">opensearch-cohere-semantic-search</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="ex">├──</span> LICENSE</span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="ex">├──</span> README.md</span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="ex">├──</span> data</span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="ex">│</span>   ├── news.csv</span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="ex">│</span>   ├── news_sample.csv</span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="ex">│</span>   └── news_sample_with_vectors.csv</span>
<span id="cb3-8"><a href="#cb3-8"></a><span class="ex">├──</span> notebooks</span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="ex">│</span>   └── generate_sample.ipynb</span>
<span id="cb3-10"><a href="#cb3-10"></a><span class="ex">├──</span> requirements.txt</span>
<span id="cb3-11"><a href="#cb3-11"></a><span class="ex">├──</span> run_opensearch_docker.sh</span>
<span id="cb3-12"><a href="#cb3-12"></a><span class="ex">└──</span> src</span>
<span id="cb3-13"><a href="#cb3-13"></a><span class="ex">│</span>   ├── app.py</span>
<span id="cb3-14"><a href="#cb3-14"></a><span class="ex">│</span>   ├── config.py</span>
<span id="cb3-15"><a href="#cb3-15"></a><span class="ex">│</span>   ├── indexer.py</span>
<span id="cb3-16"><a href="#cb3-16"></a><span class="ex">│</span>   └── vectorizer.py</span>
<span id="cb3-17"><a href="#cb3-17"></a><span class="ex">├──</span> .env-example</span>
<span id="cb3-18"><a href="#cb3-18"></a><span class="ex">└──</span> .venv/</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The project is organized into several key files and directories, as described below</p>
<ul>
<li><code>data/</code>: This directory contains the project’s data. It contains the <a href="https://www.kaggle.com/datasets/szymonjanowski/internet-articles-data-with-users-engagement">original dataset</a> downloaded from Kaggle, and a sample, which you’ll use in the tutorial.</li>
<li><code>requirements.txt</code>: This file contains a list of Python packages required by the project and their respective versions.</li>
<li><code>run_opensearch_docker.sh</code>: This file contains a bash script used to run an OpenSearch cluster locally.</li>
<li><code>src/app.py</code>: This file contains the code of the FastAPI application.</li>
<li><code>src/config.py</code>: This file contains project configuration specifications such as Cohere’s API key (read from a <code>.env</code> file), the paths to the data, and the name of the index.</li>
<li><code>src/indexer.py</code>: This file contains the code you use to create an index and insert the documents in OpenSearch.</li>
<li><code>src/vectorizer.py</code>: This file contains the code to transform the input data into embeddings.</li>
<li><code>.env-example</code>: This file is an example of the environment variables you must provide.</li>
<li><code>.venv/</code>: This directory contains the project’s virtual environment.</li>
</ul>
<p>All done! Let’s get going.</p>
</section>
<section id="run-a-local-opensearch-cluster" class="level2">
<h2 class="anchored" data-anchor-id="run-a-local-opensearch-cluster">Run a Local OpenSearch Cluster</h2>
<p>Before we get into the code, you should start a local OpenSearch cluster. Open a new terminal, navigate to the project’s root folder, and run:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1"></a><span class="fu">sh</span> run_opensearch_docker.sh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This will launch a local OpenSearch cluster. If everything went well, the terminal will show a long string of text. Keep the terminal open in the background and move on to the next step.</p>
</section>
<section id="vectorize-the-articles" class="level2">
<h2 class="anchored" data-anchor-id="vectorize-the-articles">Vectorize the Articles</h2>
<p>You’ll start by transforming the news articles into vectors (embeddings). There are many approaches you could take such as using <a href="https://dylancastillo.co/nlp-snippets-cluster-documents-using-word2vec/#cluster-documents-using--mini-batches--k-means">Word2Vec</a>, <a href="https://sbert.net/docs/pretrained_models.html">Sentence-Transformers</a>, or LLM-based <a href="https://platform.openai.com/docs/guides/embeddings">embedding</a> <a href="https://docs.cohere.ai/reference/embed">services</a>. In this case, you’ll use <a href="https://cohere.ai/">Cohere</a>.</p>
<p>Use <code>src/vectorizer.py</code> for that:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1"></a><span class="im">import</span> cohere</span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm</span>
<span id="cb5-4"><a href="#cb5-4"></a></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="im">from</span> config <span class="im">import</span> COHERE_API_KEY, NEWS_SAMPLE_DATASET, DATA</span>
<span id="cb5-6"><a href="#cb5-6"></a></span>
<span id="cb5-7"><a href="#cb5-7"></a></span>
<span id="cb5-8"><a href="#cb5-8"></a><span class="kw">def</span> main():</span>
<span id="cb5-9"><a href="#cb5-9"></a>    df <span class="op">=</span> pd.read_csv(NEWS_SAMPLE_DATASET)</span>
<span id="cb5-10"><a href="#cb5-10"></a>    cohere_client <span class="op">=</span> cohere.Client(COHERE_API_KEY)</span>
<span id="cb5-11"><a href="#cb5-11"></a></span>
<span id="cb5-12"><a href="#cb5-12"></a>    model <span class="op">=</span> <span class="st">"small"</span></span>
<span id="cb5-13"><a href="#cb5-13"></a>    batch_size <span class="op">=</span> <span class="dv">96</span></span>
<span id="cb5-14"><a href="#cb5-14"></a>    batch <span class="op">=</span> []</span>
<span id="cb5-15"><a href="#cb5-15"></a>    vectors <span class="op">=</span> []</span>
<span id="cb5-16"><a href="#cb5-16"></a></span>
<span id="cb5-17"><a href="#cb5-17"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> tqdm(df.iterrows(), total<span class="op">=</span><span class="bu">len</span>(df)):</span>
<span id="cb5-18"><a href="#cb5-18"></a>        batch.append(row[<span class="st">"text"</span>])</span>
<span id="cb5-19"><a href="#cb5-19"></a></span>
<span id="cb5-20"><a href="#cb5-20"></a>        <span class="cf">if</span> <span class="bu">len</span>(batch) <span class="op">&gt;=</span> batch_size:</span>
<span id="cb5-21"><a href="#cb5-21"></a>            response <span class="op">=</span> cohere_client.embed(texts<span class="op">=</span>batch, model<span class="op">=</span>model)</span>
<span id="cb5-22"><a href="#cb5-22"></a>            vectors.append(response.embeddings)</span>
<span id="cb5-23"><a href="#cb5-23"></a>            batch <span class="op">=</span> []</span>
<span id="cb5-24"><a href="#cb5-24"></a></span>
<span id="cb5-25"><a href="#cb5-25"></a>    <span class="cf">if</span> <span class="bu">len</span>(batch) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb5-26"><a href="#cb5-26"></a>        response <span class="op">=</span> cohere_client.embed(texts<span class="op">=</span>batch, model<span class="op">=</span>model)</span>
<span id="cb5-27"><a href="#cb5-27"></a>        vectors.append(response.embeddings)</span>
<span id="cb5-28"><a href="#cb5-28"></a>        batch <span class="op">=</span> []</span>
<span id="cb5-29"><a href="#cb5-29"></a></span>
<span id="cb5-30"><a href="#cb5-30"></a>    df[<span class="st">"vector"</span>] <span class="op">=</span> [item <span class="cf">for</span> sublist <span class="kw">in</span> vectors <span class="cf">for</span> item <span class="kw">in</span> sublist]</span>
<span id="cb5-31"><a href="#cb5-31"></a></span>
<span id="cb5-32"><a href="#cb5-32"></a>    df.to_csv(DATA <span class="op">/</span> <span class="st">"news_sample_with_vectors.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb5-33"><a href="#cb5-33"></a></span>
<span id="cb5-34"><a href="#cb5-34"></a></span>
<span id="cb5-35"><a href="#cb5-35"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb5-36"><a href="#cb5-36"></a>    main()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This code reads the news articles dataset, splits it into batches, and generates embeddings for each individual article. It works as follows:</p>
<ul>
<li><strong>Lines 1 to 5</strong> import the required Python libraries and the configuration settings from <code>config.py</code>.</li>
<li><strong>Lines 9 to 28</strong> read the news articles sample, start the Cohere client, split the dataset into batches of 96 documents (as this is the maximum accepted by Cohere), and uses the client to get embeddings for each document.</li>
<li><strong>Lines 30 to 32</strong> create a new column in the DataFrame to store the vectors and save the new dataset into your filesystem.</li>
</ul>
<p>You can run this script by opening a terminal in <code>src</code> and running:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1"></a>python vectorizer.py</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Next, you’ll create an index to store the embeddings.</p>
</section>
<section id="index-the-vectors-and-metadata" class="level2">
<h2 class="anchored" data-anchor-id="index-the-vectors-and-metadata">Index the Vectors and Metadata</h2>
<p>After you’ve created embeddings of each article, you’ll store them, and their metadata (title, content, description), in an index in your OpenSearch cluster.</p>
<p>You can use <code>src/indexer.py</code> for that:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="im">from</span> opensearchpy <span class="im">import</span> OpenSearch, NotFoundError</span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="im">from</span> config <span class="im">import</span> NEWS_WITH_VECTORS_DATASET, INDEX_NAME</span>
<span id="cb7-4"><a href="#cb7-4"></a></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm</span>
<span id="cb7-6"><a href="#cb7-6"></a></span>
<span id="cb7-7"><a href="#cb7-7"></a></span>
<span id="cb7-8"><a href="#cb7-8"></a><span class="kw">def</span> main():</span>
<span id="cb7-9"><a href="#cb7-9"></a>    client <span class="op">=</span> OpenSearch(</span>
<span id="cb7-10"><a href="#cb7-10"></a>        hosts<span class="op">=</span>[{<span class="st">"host"</span>: <span class="st">"localhost"</span>, <span class="st">"port"</span>: <span class="dv">9200</span>}],</span>
<span id="cb7-11"><a href="#cb7-11"></a>        http_auth<span class="op">=</span>(<span class="st">"admin"</span>, <span class="st">"admin"</span>),</span>
<span id="cb7-12"><a href="#cb7-12"></a>        use_ssl<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb7-13"><a href="#cb7-13"></a>        verify_certs<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb7-14"><a href="#cb7-14"></a>        ssl_assert_hostname<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb7-15"><a href="#cb7-15"></a>        ssl_show_warn<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb7-16"><a href="#cb7-16"></a>    )</span>
<span id="cb7-17"><a href="#cb7-17"></a></span>
<span id="cb7-18"><a href="#cb7-18"></a>    df <span class="op">=</span> pd.read_csv(NEWS_WITH_VECTORS_DATASET)</span>
<span id="cb7-19"><a href="#cb7-19"></a></span>
<span id="cb7-20"><a href="#cb7-20"></a>    body <span class="op">=</span> {</span>
<span id="cb7-21"><a href="#cb7-21"></a>        <span class="st">"settings"</span>: {</span>
<span id="cb7-22"><a href="#cb7-22"></a>            <span class="st">"index"</span>: {<span class="st">"knn"</span>: <span class="va">True</span>},</span>
<span id="cb7-23"><a href="#cb7-23"></a>        },</span>
<span id="cb7-24"><a href="#cb7-24"></a>        <span class="st">"mappings"</span>: {</span>
<span id="cb7-25"><a href="#cb7-25"></a>            <span class="st">"properties"</span>: {</span>
<span id="cb7-26"><a href="#cb7-26"></a>                <span class="st">"id"</span>: {<span class="st">"type"</span>: <span class="st">"integer"</span>},</span>
<span id="cb7-27"><a href="#cb7-27"></a>                <span class="st">"title"</span>: {<span class="st">"type"</span>: <span class="st">"keyword"</span>},</span>
<span id="cb7-28"><a href="#cb7-28"></a>                <span class="st">"content"</span>: {<span class="st">"type"</span>: <span class="st">"keyword"</span>},</span>
<span id="cb7-29"><a href="#cb7-29"></a>                <span class="st">"description"</span>: {<span class="st">"type"</span>: <span class="st">"keyword"</span>},</span>
<span id="cb7-30"><a href="#cb7-30"></a>                <span class="st">"embedding"</span>: {<span class="st">"type"</span>: <span class="st">"knn_vector"</span>, <span class="st">"dimension"</span>: <span class="dv">1024</span>},</span>
<span id="cb7-31"><a href="#cb7-31"></a>            }</span>
<span id="cb7-32"><a href="#cb7-32"></a>        },</span>
<span id="cb7-33"><a href="#cb7-33"></a>    }</span>
<span id="cb7-34"><a href="#cb7-34"></a></span>
<span id="cb7-35"><a href="#cb7-35"></a>    <span class="cf">try</span>:</span>
<span id="cb7-36"><a href="#cb7-36"></a>        client.indices.delete(index<span class="op">=</span>INDEX_NAME)</span>
<span id="cb7-37"><a href="#cb7-37"></a>    <span class="cf">except</span> NotFoundError:</span>
<span id="cb7-38"><a href="#cb7-38"></a>        <span class="cf">pass</span></span>
<span id="cb7-39"><a href="#cb7-39"></a>    client.indices.create(INDEX_NAME, body<span class="op">=</span>body)</span>
<span id="cb7-40"><a href="#cb7-40"></a></span>
<span id="cb7-41"><a href="#cb7-41"></a>    <span class="cf">for</span> i, row <span class="kw">in</span> tqdm(df.iterrows(), total<span class="op">=</span><span class="bu">len</span>(df)):</span>
<span id="cb7-42"><a href="#cb7-42"></a>        embedding <span class="op">=</span> [</span>
<span id="cb7-43"><a href="#cb7-43"></a>            <span class="bu">float</span>(x) <span class="cf">for</span> x <span class="kw">in</span> row[<span class="st">"vector"</span>].replace(<span class="st">"["</span>, <span class="st">""</span>).replace(<span class="st">"]"</span>, <span class="st">""</span>).split(<span class="st">","</span>)</span>
<span id="cb7-44"><a href="#cb7-44"></a>        ]</span>
<span id="cb7-45"><a href="#cb7-45"></a>        client.index(</span>
<span id="cb7-46"><a href="#cb7-46"></a>            index<span class="op">=</span>INDEX_NAME,</span>
<span id="cb7-47"><a href="#cb7-47"></a>            body<span class="op">=</span>{</span>
<span id="cb7-48"><a href="#cb7-48"></a>                <span class="st">"source_id"</span>: i,</span>
<span id="cb7-49"><a href="#cb7-49"></a>                <span class="st">"title"</span>: row[<span class="st">"title"</span>],</span>
<span id="cb7-50"><a href="#cb7-50"></a>                <span class="st">"content"</span>: row[<span class="st">"content"</span>],</span>
<span id="cb7-51"><a href="#cb7-51"></a>                <span class="st">"description"</span>: row[<span class="st">"description"</span>],</span>
<span id="cb7-52"><a href="#cb7-52"></a>                <span class="st">"embedding"</span>: embedding,</span>
<span id="cb7-53"><a href="#cb7-53"></a>            },</span>
<span id="cb7-54"><a href="#cb7-54"></a>        )</span>
<span id="cb7-55"><a href="#cb7-55"></a></span>
<span id="cb7-56"><a href="#cb7-56"></a>    client.indices.refresh(index<span class="op">=</span>INDEX_NAME)</span>
<span id="cb7-57"><a href="#cb7-57"></a>    <span class="bu">print</span>(<span class="st">"Done"</span>, client.cat.count(index<span class="op">=</span>INDEX_NAME, <span class="bu">format</span><span class="op">=</span><span class="st">"json"</span>))</span>
<span id="cb7-58"><a href="#cb7-58"></a></span>
<span id="cb7-59"><a href="#cb7-59"></a></span>
<span id="cb7-60"><a href="#cb7-60"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb7-61"><a href="#cb7-61"></a>    main()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This code will create a new index in your OpenSearch cluster, and store the vectors and metadata in it. Here’s how it works:</p>
<ul>
<li><strong>Lines 1 to 5</strong> import the required Python libraries and the predefined configuration settings from <code>config.py</code>.</li>
<li><strong>Lines 9 to 16</strong> start the OpenSearch client.</li>
<li><strong>Lines 20 to 33</strong> define the settings and mappings of the index you’ll create. You set <code>"knn": True</code> so that OpenSearch knows that you’ll be using the <a href="https://opensearch.org/docs/latest/search-plugins/knn/index/">k-NN plugin</a> to store and retrieve vectors. Very importantly, you also need to define the size of the vector in the <code>mappings</code>, based on the model you use. Cohere’s <a href="https://docs.cohere.ai/reference/embed"><code>small</code></a> embeddings generate vectors of 1024 dimensions.</li>
<li><strong>Lines 35 to 54</strong> create the index (and delete any previous ones), and add each document one by one. You index the <code>id</code>, <code>title</code>, <code>description</code>, and <code>embedding</code> for each document.</li>
</ul>
<p>You can run this script by opening a terminal in <code>src</code> and running:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1"></a>python indexer.py</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>So far, you’ve created embeddings for each document and indexed them in your OpenSearch cluster. Next, you’ll run a search client to interact with them.</p>
</section>
<section id="create-a-search-client" class="level2">
<h2 class="anchored" data-anchor-id="create-a-search-client">Create a Search Client</h2>
<p>Finally, you’ll create a search client so that users can search the articles you indexed using FastAPI. It’ll let users provide a search term, and give them back the 10 most similar documents based on that term.</p>
<p>The code is available in <code>src/app.py</code>:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1"></a><span class="im">import</span> cohere</span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="im">from</span> fastapi <span class="im">import</span> FastAPI</span>
<span id="cb9-3"><a href="#cb9-3"></a></span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="im">from</span> config <span class="im">import</span> COHERE_API_KEY, INDEX_NAME</span>
<span id="cb9-5"><a href="#cb9-5"></a></span>
<span id="cb9-6"><a href="#cb9-6"></a><span class="im">from</span> opensearchpy <span class="im">import</span> OpenSearch</span>
<span id="cb9-7"><a href="#cb9-7"></a></span>
<span id="cb9-8"><a href="#cb9-8"></a></span>
<span id="cb9-9"><a href="#cb9-9"></a>app <span class="op">=</span> FastAPI()</span>
<span id="cb9-10"><a href="#cb9-10"></a></span>
<span id="cb9-11"><a href="#cb9-11"></a>opensearch_client <span class="op">=</span> OpenSearch(</span>
<span id="cb9-12"><a href="#cb9-12"></a>    hosts<span class="op">=</span>[{<span class="st">"host"</span>: <span class="st">"localhost"</span>, <span class="st">"port"</span>: <span class="dv">9200</span>}],</span>
<span id="cb9-13"><a href="#cb9-13"></a>    http_auth<span class="op">=</span>(<span class="st">"admin"</span>, <span class="st">"admin"</span>),</span>
<span id="cb9-14"><a href="#cb9-14"></a>    use_ssl<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb9-15"><a href="#cb9-15"></a>    verify_certs<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb9-16"><a href="#cb9-16"></a>    ssl_assert_hostname<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb9-17"><a href="#cb9-17"></a>    ssl_show_warn<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb9-18"><a href="#cb9-18"></a>)</span>
<span id="cb9-19"><a href="#cb9-19"></a></span>
<span id="cb9-20"><a href="#cb9-20"></a>cohere_client <span class="op">=</span> cohere.Client(COHERE_API_KEY)</span>
<span id="cb9-21"><a href="#cb9-21"></a></span>
<span id="cb9-22"><a href="#cb9-22"></a></span>
<span id="cb9-23"><a href="#cb9-23"></a><span class="at">@app.get</span>(<span class="st">"/"</span>)</span>
<span id="cb9-24"><a href="#cb9-24"></a><span class="kw">def</span> index():</span>
<span id="cb9-25"><a href="#cb9-25"></a>    <span class="cf">return</span> {<span class="st">"message"</span>: <span class="st">"Make a post request to /search to search through news articles"</span>}</span>
<span id="cb9-26"><a href="#cb9-26"></a></span>
<span id="cb9-27"><a href="#cb9-27"></a></span>
<span id="cb9-28"><a href="#cb9-28"></a><span class="at">@app.post</span>(<span class="st">"/search"</span>)</span>
<span id="cb9-29"><a href="#cb9-29"></a><span class="kw">def</span> search(query: <span class="bu">str</span>):</span>
<span id="cb9-30"><a href="#cb9-30"></a>    query_embedding <span class="op">=</span> cohere_client.embed(texts<span class="op">=</span>[query], model<span class="op">=</span><span class="st">"small"</span>).embeddings[<span class="dv">0</span>]</span>
<span id="cb9-31"><a href="#cb9-31"></a></span>
<span id="cb9-32"><a href="#cb9-32"></a>    similar_news <span class="op">=</span> opensearch_client.search(</span>
<span id="cb9-33"><a href="#cb9-33"></a>        index<span class="op">=</span>INDEX_NAME,</span>
<span id="cb9-34"><a href="#cb9-34"></a>        body<span class="op">=</span>{</span>
<span id="cb9-35"><a href="#cb9-35"></a>            <span class="st">"query"</span>: {<span class="st">"knn"</span>: {<span class="st">"embedding"</span>: {<span class="st">"vector"</span>: query_embedding, <span class="st">"k"</span>: <span class="dv">10</span>}}},</span>
<span id="cb9-36"><a href="#cb9-36"></a>        },</span>
<span id="cb9-37"><a href="#cb9-37"></a>    )</span>
<span id="cb9-38"><a href="#cb9-38"></a>    response <span class="op">=</span> [</span>
<span id="cb9-39"><a href="#cb9-39"></a>        {</span>
<span id="cb9-40"><a href="#cb9-40"></a>            <span class="st">"title"</span>: r[<span class="st">"_source"</span>][<span class="st">"title"</span>],</span>
<span id="cb9-41"><a href="#cb9-41"></a>            <span class="st">"description"</span>: r[<span class="st">"_source"</span>][<span class="st">"description"</span>],</span>
<span id="cb9-42"><a href="#cb9-42"></a>            <span class="st">"content"</span>: r[<span class="st">"_source"</span>][<span class="st">"content"</span>],</span>
<span id="cb9-43"><a href="#cb9-43"></a>        }</span>
<span id="cb9-44"><a href="#cb9-44"></a>        <span class="cf">for</span> r <span class="kw">in</span> similar_news[<span class="st">"hits"</span>][<span class="st">"hits"</span>]</span>
<span id="cb9-45"><a href="#cb9-45"></a>    ]</span>
<span id="cb9-46"><a href="#cb9-46"></a></span>
<span id="cb9-47"><a href="#cb9-47"></a>    <span class="cf">return</span> {</span>
<span id="cb9-48"><a href="#cb9-48"></a>        <span class="st">"response"</span>: response,</span>
<span id="cb9-49"><a href="#cb9-49"></a>    }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This code lets users search through the index. It works as follows:</p>
<ul>
<li><strong>Lines 1 to 6</strong> import the required Python libraries, and the configuration defined in <code>config.py</code>.</li>
<li><strong>Lines 9 to 20</strong> initialize the FastAPI app, and the OpenSearch and Cohere clients.</li>
<li><strong>Lines 23 to 25</strong> define an endpoint that provides the user with a message explaining how to use the app if they make a <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods/GET">GET</a> request to “/”.</li>
<li><strong>Lines 28 to 49</strong> define a<code>**/**search</code> endpoint that accepts a query string parameter. It uses Cohere to generate an embedding from a query and then searches the OpenSearch index for the ten most similar documents. Finally, it formats the results as a user response.</li>
</ul>
<p>To run the app, you can use <code>uvicorn app:app --reload</code>. You can test the app by opening your browser, navigating to <code>localhost:8000/docs</code>, and clicking on <code>POST /search</code>:</p>
<p><a href="images/semantic-search-with-opensearch-cohere-and-fastapi/image-5.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="images/semantic-search-with-opensearch-cohere-and-fastapi/image-5.png" class="img-fluid"></a></p>
<p>For instance, if you search for “Nicolas Maduro,” the current president of Venezuela who is widely regarded as a dictator. You’ll get results for articles about authoritarian governments or power abuses:</p>
<p><a href="images/semantic-search-with-opensearch-cohere-and-fastapi/image-4.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="images/semantic-search-with-opensearch-cohere-and-fastapi/image-4.png" class="img-fluid"></a></p>
<p>That’s it! If you want to know how to deploy this app, check out a <a href="https://dylancastillo.co/fastapi-nginx-gunicorn/">previous article</a> I wrote.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Congrats! You’ve built your own semantic search service. In this tutorial, you’ve learned:</p>
<ul>
<li>What is semantic search, and how it is different from keyword-based search.</li>
<li>What are the main components of a semantic search service.</li>
<li>How to use Cohere to vectorize text data.</li>
<li>How to use OpenSearch to store embeddings.</li>
</ul>
<p>Hope you found this tutorial useful. Let me know if you have any questions!</p>
<p>All the code for this tutorial is <a href="https://github.com/dylanjcastillo/opensearch-cohere-semantic-search">available on GitHub</a>.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2023,
  author = {Castillo, Dylan},
  title = {Semantic {Search} with {OpenSearch,} {Cohere,} and {FastAPI}},
  date = {2023-04-11},
  url = {https://dylancastillo.co/posts/semantic-search-with-opensearch-cohere-and-fastapi.html},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2023" class="csl-entry quarto-appendix-citeas" role="listitem">
Castillo, Dylan. 2023. <span>“Semantic Search with OpenSearch, Cohere,
and FastAPI.”</span> April 11, 2023. <a href="https://dylancastillo.co/posts/semantic-search-with-opensearch-cohere-and-fastapi.html">https://dylancastillo.co/posts/semantic-search-with-opensearch-cohere-and-fastapi.html</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/dylancastillo\.co");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<script src="https://utteranc.es/client.js" repo="dylanjcastillo/blog_comments" issue-term="pathname" theme="dark-blue" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>Copyright 2025, Dylan Castillo</p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>