<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.33">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Dylan Castillo">
<meta name="dcterms.date" content="2023-02-03">
<meta name="description" content="In this tutorial, you’ll learn how to use NGINX, and Gunicorn+Uvicorn to deploy a FastAPI app, and generate a free SSL certificate for it.">

<title>How to Securely Deploy a FastAPI app with NGINX and Gunicorn – Dylan Castillo</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../images/logo.webp" rel="icon">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark-bc185b5c5bdbcb35c2eb49d8a876ef70.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-0208502c2bc785d7f8760c6f758d0dc8.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="dark">
<script src="../site_libs/quarto-contrib/iconify-2.1.0/iconify-icon.min.js"></script>
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;0,900;1,300;1,400;1,700;1,900&amp;display=swap" rel="stylesheet">
<script src="https://cdn.usefathom.com/script.js" data-site="ZJFQREIA" defer=""></script>


<meta property="og:title" content="How to Securely Deploy a FastAPI app with NGINX and Gunicorn – Dylan Castillo">
<meta property="og:description" content="">
<meta property="og:image" content="https://dylancastillo.co/posts/images/social_media_card.webp">
<meta property="og:site_name" content="Dylan Castillo">
<meta name="twitter:title" content="How to Securely Deploy a FastAPI app with NGINX and Gunicorn – Dylan Castillo">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="https://dylancastillo.co/posts/images/social_media_card.webp">
<meta name="twitter:creator" content="@dylanjcastillo">
<meta name="twitter:site" content="@dylanjcastillo">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../projects.html"> 
<span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/dylanjcastillo"> 
<span class="menu-text"><iconify-icon role="img" inline="" icon="fa6-brands:github" aria-label="Icon github from fa6-brands Iconify.design set." title="Icon github from fa6-brands Iconify.design set."></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.linkedin.com/in/dylanjcastillo/"> 
<span class="menu-text"><iconify-icon role="img" inline="" icon="fa6-brands:linkedin" aria-label="Icon linkedin from fa6-brands Iconify.design set." title="Icon linkedin from fa6-brands Iconify.design set."></iconify-icon></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#prerequisites" id="toc-prerequisites" class="nav-link active" data-scroll-target="#prerequisites">Prerequisites</a></li>
  <li><a href="#tech-stack" id="toc-tech-stack" class="nav-link" data-scroll-target="#tech-stack">Tech Stack</a></li>
  <li><a href="#optional-step-1-secure-your-server" id="toc-optional-step-1-secure-your-server" class="nav-link" data-scroll-target="#optional-step-1-secure-your-server">(Optional) Step 1: Secure Your Server</a>
  <ul class="collapse">
  <li><a href="#enable-automatic-updates" id="toc-enable-automatic-updates" class="nav-link" data-scroll-target="#enable-automatic-updates">Enable Automatic Updates</a></li>
  <li><a href="#create-a-non-root-user" id="toc-create-a-non-root-user" class="nav-link" data-scroll-target="#create-a-non-root-user">Create a Non-root User</a></li>
  <li><a href="#other-security-measures" id="toc-other-security-measures" class="nav-link" data-scroll-target="#other-security-measures">Other Security Measures</a></li>
  </ul></li>
  <li><a href="#step-2-install-software-tools" id="toc-step-2-install-software-tools" class="nav-link" data-scroll-target="#step-2-install-software-tools">Step 2: Install Software Tools</a></li>
  <li><a href="#step-3-set-up-your-fastapi-app" id="toc-step-3-set-up-your-fastapi-app" class="nav-link" data-scroll-target="#step-3-set-up-your-fastapi-app">Step 3: Set Up Your FastAPI App</a></li>
  <li><a href="#step-4-configure-gunicorn" id="toc-step-4-configure-gunicorn" class="nav-link" data-scroll-target="#step-4-configure-gunicorn">Step 4: Configure Gunicorn</a>
  <ul class="collapse">
  <li><a href="#set-up-gunicorn" id="toc-set-up-gunicorn" class="nav-link" data-scroll-target="#set-up-gunicorn">Set Up Gunicorn</a></li>
  <li><a href="#configure-supervisor" id="toc-configure-supervisor" class="nav-link" data-scroll-target="#configure-supervisor">Configure <strong>Supervisor</strong></a></li>
  </ul></li>
  <li><a href="#step-5-configure-nginx" id="toc-step-5-configure-nginx" class="nav-link" data-scroll-target="#step-5-configure-nginx">Step 5: Configure NGINX</a>
  <ul class="collapse">
  <li><a href="#permissions-error" id="toc-permissions-error" class="nav-link" data-scroll-target="#permissions-error">Permissions Error</a></li>
  </ul></li>
  <li><a href="#optional-step-6-obtain-a-free-ssl-certificate-using-certbot" id="toc-optional-step-6-obtain-a-free-ssl-certificate-using-certbot" class="nav-link" data-scroll-target="#optional-step-6-obtain-a-free-ssl-certificate-using-certbot">(Optional) Step 6: Obtain a Free SSL Certificate Using Certbot</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
</nav>
    <div class="quarto-margin-footer"><div class="margin-footer-item">
<button onclick="window.location.href='https://subscribe.dylancastillo.co'" style="background-color: #eb841b; color: white; padding: 12px 24px; border: none; border-radius: 6px; font-size: 12px; font-weight: bold; cursor: pointer; transition: background-color 0.3s ease;">
Subscribe to my newsletter
</button>
</div></div></div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">How to Securely Deploy a FastAPI app with NGINX and Gunicorn</h1>
  <div class="quarto-categories">
    <div class="quarto-category">python</div>
    <div class="quarto-category">web</div>
  </div>
  </div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author"><a href="https://dylancastillo.co">Dylan Castillo</a> </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            <a href="https://iwanalabs.com">
            Iwana Labs
            </a>
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 3, 2023</p>
    </div>
  </div>
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">July 13, 2024</p>
    </div>
  </div>
    
  </div>
  


</header>


<p>Deploying a <a href="https://fastapi.tiangolo.com/">FastAPI</a> web app to a Virtual Private Server (VPS) is tricky. If you’re not familiar with technologies such as NGINX, Gunicorn, and Uvicorn, it can easily overwhelm you. I wrote this tutorial so you won’t have to spend as much time on your first deployment as I did.</p>
<p>FastAPI is one of the most popular Python libraries for developing APIs, thanks to its performance and ease of use. If you’re using machine learning models in your web app, it’s likely the go-to tool for you.</p>
<p><a href="https://www.nginx.com/">NGINX</a> , <a href="https://gunicorn.org/">Gunicorn</a>, and <a href="https://www.uvicorn.org/">Uvicorn</a> are battle-tested technologies that are frequently used as a reverse proxy and ASGI server when deploying Python web apps. If you’re familiar with Django or Flask, you’ve probably heard about some of them before.</p>
<p>In this tutorial, I’ll show you how to combine these tools to deploy a FastAPI web app. You will:</p>
<ul>
<li>Learn the basics about FastAPI, NGINX, Gunicorn, and Uvicorn.</li>
<li>Set up Gunicorn + Uvicorn as an ASGI server.</li>
<li>Configure NGINX as a reverse proxy server.</li>
<li>Generate a free SSL certificate for your app using Let’s Encrypt.</li>
</ul>
<p>Let’s get to it!</p>
<section id="prerequisites" class="level2">
<h2 class="anchored" data-anchor-id="prerequisites">Prerequisites</h2>
<ul>
<li>You should have access to a Debian-based VPS. I will use Ubuntu 20.04.</li>
<li>You should be familiar with basic shell commands, such as <code>sudo</code>, <code>mkdir</code>, or <code>cd</code>.</li>
<li>You should know how to <a href="https://stackoverflow.com/a/11828573">exit</a> vim 😜</li>
</ul>
</section>
<section id="tech-stack" class="level2">
<h2 class="anchored" data-anchor-id="tech-stack">Tech Stack</h2>
<p>Before we go any further, I’ll give you a quick rundown of the technologies you’ll be using:</p>
<ul>
<li><strong>FastAPI</strong> is one of the most popular Python frameworks for building APIs.<br>
It’s built on top of <a href="https://www.starlette.io/">Starlette</a> and <a href="https://docs.pydantic.dev/">Pydantic</a> and uses standard Python type hints. It’s loved by developers because of it is performant, easy to learn, and provides a great developer experience.</li>
<li><strong>Gunicorn</strong> is a popular web server used to deploy Python web apps. Typically, it’s used as a WSGI server, but it’s possible to combine it with Uvicorn to work as an ASGI server.</li>
<li><strong>Uvicorn</strong> is an ASGI web server implementation for Python. It’s the recommended web server for Starlette and FastAPI.</li>
<li><strong>NGINX</strong> is an open-source tool with many uses. It started out as a web server but can now be used as a reverse proxy server, a load balancer, and more.<br>
NGINX is often used as a reverse proxy in front of the app’s web server when working with Python web frameworks.</li>
</ul>
<p>Now, let’s get to the interesting part!</p>
</section>
<section id="optional-step-1-secure-your-server" class="level2">
<h2 class="anchored" data-anchor-id="optional-step-1-secure-your-server">(Optional) Step 1: Secure Your Server</h2>
<p>This step isn’t required, but it’s still a good idea to at least skim it. Even more so if you’re not sure what you’re doing. This will make your application more secure.</p>
<section id="enable-automatic-updates" class="level3">
<h3 class="anchored" data-anchor-id="enable-automatic-updates">Enable Automatic Updates</h3>
<p>First, you should make sure your server has the latest software:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">sudo</span> apt update <span class="kw">&amp;&amp;</span> <span class="fu">sudo</span> apt upgrade <span class="at">-y</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These are common commands you’ll see when working with Debian-based servers:</p>
<ul>
<li><code>sudo apt update</code> updates the package list index on the user’s system.</li>
<li><code>sudo apt upgrade</code> upgrades the installed packages to their latest versions. You provide the <code>-y</code> flag to proceed with the installation without requiring confirmation.</li>
</ul>
<p>Next, you should set up automatic security updates, so that you don’t have to do them manually. For that, you’ll need to install and enable <code>unnattended-upgrades</code>:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">sudo</span> apt install unattended-upgrades</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Once the installation is finished, edit <code>/etc/apt/apt.conf.d/20auto-upgrades</code> to include the following lines:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1"></a><span class="ex">APT::Periodic::Update-Package-Lists</span> <span class="st">"1"</span><span class="kw">;</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="ex">APT::Periodic::Unattended-Upgrade</span> <span class="st">"1"</span><span class="kw">;</span></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="ex">APT::Periodic::AutocleanInterval</span> <span class="st">"7"</span><span class="kw">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These lines configure <code>unattended-upgrades</code> so that it runs automatically. Here’s what they do:</p>
<ul>
<li><code>APT::Periodic::Update-Package-Lists "1"</code> means that the list of packages will be automatically updated every day.</li>
<li><code>APT::Periodic::Unattended-Upgrade "1"</code> means that the system will be updated to the latest version of the packages without the user having to intervene.</li>
<li><code>"APT::Periodic::AutocleanInterval "7"</code> means that the auto-clean operation, which gets rid of old and unnecessary package files, will run once a week.</li>
</ul>
<p>Lastly, edit <code>/etc/apt/apt.conf.d/50unattended-upgrades</code> to make sure the system automatically reboots when kernel updates require it:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1"></a><span class="ex">Unattended-Upgrade::Automatic-Reboot</span> <span class="st">"true"</span><span class="kw">;</span> <span class="co"># change to true</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You can also configure your system to send emails when there are issues with the upgrades. If you want to do that, take a look at <a href="https://www.cyberciti.biz/faq/ubuntu-enable-setup-automatic-unattended-security-updates/">this</a> article.</p>
<p>Whew! You’ve now ensured that your system is up to date and will remain so. Next, you’ll create a user to make sure you don’t give your app more permissions than it needs to run.</p>
</section>
<section id="create-a-non-root-user" class="level3">
<h3 class="anchored" data-anchor-id="create-a-non-root-user">Create a Non-root User</h3>
<p>If your server ever gets hacked, having a non-root user reduces the damage the malicious actor can do. That, <a href="https://askubuntu.com/questions/1127174/purpose-of-creating-non-root-user">among other reasons</a>, justifies the creation of a non-root user.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1"></a><span class="fu">sudo</span> adduser fastapi-user <span class="co"># replace fastapi-user with your preferred name</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="fu">sudo</span> gpasswd <span class="at">-a</span> fastapi-user sudo <span class="co"># add to sudoers</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="fu">su</span> <span class="at">-</span> fastapi-user <span class="co"># login as fastapi-user</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These commands will create a user name <code>fastapi-user</code>, add it to the <code>sudo</code> group (which contains all users with root privileges), and then log in as that user.</p>
<p>Then, you will set up your server so that you connect to it using an SSH key instead of a password. It’s safer and faster, so you have nothing to lose.</p>
<p>If you don’t already have an SSH key, open a new terminal <strong>on your local machine</strong> and run the following command. Otherwise, skip this step, and move directly to copy your public SSH key.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1"></a><span class="fu">ssh-keygen</span> <span class="at">-t</span> ed25519 <span class="at">-C</span> <span class="st">"username@email.com"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>‌This command will create and store an SSH key in your local machine. You employ two parameters:</p>
<ol type="1">
<li><code>-t ed25519</code> to specify which algorithm to use to generate the key. You went with <a href="https://ed25519.cr.yp.to/">ED25519</a>, which is a very safe and efficient algorithm.</li>
<li><code>-C username@email.com</code> to append your email as a comment at the end of the key. Make sure to replace <code>username@email.com</code> it with your actual email.</li>
</ol>
<p>Then, copy your public SSH key by using this command and copying the output:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1"></a><span class="fu">cat</span> ~/.ssh/id_ed25519.pub</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Go back to the <strong>remote server’s</strong> terminal and type in the following commands:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1"></a><span class="fu">mkdir</span> ~/.ssh/</span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="fu">chmod</span> 700 <span class="at">-R</span> ~/.ssh/</span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="fu">sudo</span> vim ~/.ssh/authorized_keys</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These commands will:</p>
<ol type="1">
<li>Create a <code>.ssh</code> directory</li>
<li>Set the necessary permissions (the owner of <code>.ssh/</code> has full read, write, and execute permissions, but other users and groups shouldn’t).</li>
<li>Open <code>authorized_keys</code> with an editor</li>
</ol>
<p>Paste your public SSH key into <code>authorized_keys</code>. Save the changes and close the editor. Make sure the changes worked by closing the terminal and logging back into your machine using the following command:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1"></a><span class="fu">ssh</span> fastapi-user@your-server-ip</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Once you’ve tested that it works, you should disable the root login and use password authentication for SSH connections. To do this, you’ll have to update the following values in <code>/etc/ssh/sshd_config</code> using <strong>vim</strong> (or any other editor) using <code>sudo</code> privileges:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1"></a><span class="ex">PermitRootLogin</span> no <span class="co"># change to no</span></span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="ex">...</span></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="ex">PasswordAuthentication</span> no <span class="co"># change to no</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These modifications will prohibit users from logging in as <code>root</code> and also disable the option of authenticating using a password rather than an SSH key.</p>
</section>
<section id="other-security-measures" class="level3">
<h3 class="anchored" data-anchor-id="other-security-measures">Other Security Measures</h3>
<p>Most cloud providers offer firewall services, but if yours doesn’t, you should <a href="https://www.linode.com/docs/guides/configure-firewall-with-ufw/">configure one</a> and only allow incoming traffic to the necessary ports: 80, 443, and 22.</p>
<p>Also, you can install <a href="https://www.digitalocean.com/community/tutorials/how-to-protect-ssh-with-fail2ban-on-ubuntu-20-04">fail2ban</a> to prevent brute-force authentication attacks. To learn more about the best practices to secure a Linux server, check out <a href="https://www.linode.com/docs/guides/set-up-and-secure/">this guide</a> from Linode.</p>
</section>
</section>
<section id="step-2-install-software-tools" class="level2">
<h2 class="anchored" data-anchor-id="step-2-install-software-tools">Step 2: Install Software Tools</h2>
<p>You will require a few software tools. Begin by running the following commands to install Python:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1"></a><span class="fu">sudo</span> add-apt-repository ppa:deadsnakes/ppa</span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="fu">sudo</span> apt update</span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="fu">sudo</span> apt install python3.11 python3.11-venv <span class="at">-y</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then, install <strong>Supervisor</strong> and <strong>NGINX</strong>:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1"></a><span class="fu">sudo</span> apt install supervisor nginx <span class="at">-y</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Supervisor is a process control system for Unix-like operating systems, including Linux. It’s intended to monitor and manage the processes of programs, ensuring that they are always running and restarting them if they crash or shut down.</p>
<p>NGINX,as mentioned before, is a popular multifaceted software, that’s often used as a reverse proxy when deploying web applications.</p>
<p>Enable and start Supervisor:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1"></a><span class="fu">sudo</span> systemctl enable supervisor</span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="fu">sudo</span> systemctl start supervisor</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>enable</code> will make sure Supervisor starts on boot, and <code>start</code> will start Supervisor right away.</p>
</section>
<section id="step-3-set-up-your-fastapi-app" class="level2">
<h2 class="anchored" data-anchor-id="step-3-set-up-your-fastapi-app">Step 3: Set Up Your FastAPI App</h2>
<p>Start by cloning the sample app into <code>/home/fastapi-user</code>:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1"></a><span class="fu">git</span> clone https://github.com/dylanjcastillo/fastapi-nginx-gunicorn</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This will work with public repositories. If you want to deploy an app from a private GitHub repository, you should set up a <a href="https://dylancastillo.co/how-to-use-github-deploy-keys/">GitHub deploy key</a> and clone the repository using it.</p>
<p>Next, create a virtual environment and activate it in the project directory:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1"></a><span class="bu">cd</span> /home/fastapi-user/fastapi-nginx-gunicorn</span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="ex">python3.11</span> <span class="at">-m</span> venv .venv</span>
<span id="cb15-3"><a href="#cb15-3"></a><span class="bu">source</span> .venv/bin/activate</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These commands will change your current location to the project directory, create a virtual environment in it, and activate it. From now on, you should see a <code>(.venv)</code> prefix in your command line.</p>
<p>Now, use <code>pip</code> to install the libraries specified in <code>requirements.txt</code>:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1"></a><span class="ex">pip</span> install <span class="at">-r</span> requirements.txt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This will install the packages in <code>requirements.txt</code>: <code>fastapi</code>, <code>gunicorn</code>, and <code>uvicorn</code>, in your current virtual environment.</p>
<p>Verify that everything went well by running the application:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1"></a><span class="ex">uvicorn</span> main:app</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You shouldn’t get any errors when you run this command. You can also verify that it’s working by opening a new terminal window, connecting to the server, and making a request with <code>curl</code>:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1"></a><span class="ex">curl</span> http://localhost:8000</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You should get the following response:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1"></a><span class="ex">{</span><span class="st">"message"</span><span class="ex">:</span><span class="st">"It's working!"</span><span class="ex">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You’re halfway there. You got your FastAPI app running, next you’ll configure Gunicorn to serve as a WSGI server.</p>
</section>
<section id="step-4-configure-gunicorn" class="level2">
<h2 class="anchored" data-anchor-id="step-4-configure-gunicorn">Step 4: Configure Gunicorn</h2>
<p>There are two parts to configuring Gunicorn. First, specifying the configuration requirements of <code>gunicorn</code>. Second, setting up a <strong>Supervisor</strong> program to run it.</p>
<section id="set-up-gunicorn" class="level3">
<h3 class="anchored" data-anchor-id="set-up-gunicorn">Set Up Gunicorn</h3>
<p>You’ll first create a file to define the parameters you’ll use when running Gunicorn. For that, create a file called <code>gunicorn_start</code> in the project directory:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1"></a><span class="ex">vim</span> gunicorn_start</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then, add the following content to it:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb21-2"><a href="#cb21-2"></a></span>
<span id="cb21-3"><a href="#cb21-3"></a><span class="va">NAME</span><span class="op">=</span>fastapi-app</span>
<span id="cb21-4"><a href="#cb21-4"></a><span class="va">DIR</span><span class="op">=</span>/home/fastapi-user/fastapi-nginx-gunicorn</span>
<span id="cb21-5"><a href="#cb21-5"></a><span class="va">USER</span><span class="op">=</span>fastapi-user</span>
<span id="cb21-6"><a href="#cb21-6"></a><span class="va">GROUP</span><span class="op">=</span>fastapi-user</span>
<span id="cb21-7"><a href="#cb21-7"></a><span class="va">WORKERS</span><span class="op">=</span>3</span>
<span id="cb21-8"><a href="#cb21-8"></a><span class="va">WORKER_CLASS</span><span class="op">=</span>uvicorn.workers.UvicornWorker</span>
<span id="cb21-9"><a href="#cb21-9"></a><span class="va">VENV</span><span class="op">=</span><span class="va">$DIR</span>/.venv/bin/activate</span>
<span id="cb21-10"><a href="#cb21-10"></a><span class="va">BIND</span><span class="op">=</span>unix:<span class="va">$DIR</span>/run/gunicorn.sock</span>
<span id="cb21-11"><a href="#cb21-11"></a><span class="va">LOG_LEVEL</span><span class="op">=</span>error</span>
<span id="cb21-12"><a href="#cb21-12"></a></span>
<span id="cb21-13"><a href="#cb21-13"></a><span class="bu">cd</span> <span class="va">$DIR</span></span>
<span id="cb21-14"><a href="#cb21-14"></a><span class="bu">source</span> <span class="va">$VENV</span></span>
<span id="cb21-15"><a href="#cb21-15"></a></span>
<span id="cb21-16"><a href="#cb21-16"></a><span class="bu">exec</span> gunicorn main:app <span class="dt">\</span></span>
<span id="cb21-17"><a href="#cb21-17"></a>  <span class="at">--name</span> <span class="va">$NAME</span> <span class="dt">\</span></span>
<span id="cb21-18"><a href="#cb21-18"></a>  <span class="at">--workers</span> <span class="va">$WORKERS</span> <span class="dt">\</span></span>
<span id="cb21-19"><a href="#cb21-19"></a>  <span class="at">--worker-class</span> <span class="va">$WORKER_CLASS</span> <span class="dt">\</span></span>
<span id="cb21-20"><a href="#cb21-20"></a>  <span class="at">--user</span><span class="op">=</span><span class="va">$USER</span> <span class="dt">\</span></span>
<span id="cb21-21"><a href="#cb21-21"></a>  <span class="at">--group</span><span class="op">=</span><span class="va">$GROUP</span> <span class="dt">\</span></span>
<span id="cb21-22"><a href="#cb21-22"></a>  <span class="at">--bind</span><span class="op">=</span><span class="va">$BIND</span> <span class="dt">\</span></span>
<span id="cb21-23"><a href="#cb21-23"></a>  <span class="at">--log-level</span><span class="op">=</span><span class="va">$LOG_LEVEL</span> <span class="dt">\</span></span>
<span id="cb21-24"><a href="#cb21-24"></a>  <span class="at">--log-file</span><span class="op">=</span>-</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Here’s what you’re defining:</p>
<ul>
<li><strong>Line 1</strong> indicates that the script is to be run by the bash shell.</li>
<li><strong>Lines 3 to 11</strong> specify the configuration options that you’ll pass to Gunicorn. Most parameters are self-explanatory, except for <code>WORKERS</code>, <code>WORKER_CLASS</code>, and <code>BIND</code>:
<ul>
<li><strong><code>WORKERS</code>:</strong> defines the number of workers that Gunicorn will use, it’s usually recommended to use the number of CPU cores + 1.</li>
<li><strong><code>WORKER_CLASS</code>:</strong> type of worker used. In this case, you specify Uvicorn workers, which allows you to <a href="https://fastapi.tiangolo.com/deployment/server-workers/#gunicorn-with-uvicorn-workers">use it as an ASGI server</a>.</li>
<li><strong><code>BIND</code>:</strong> Specifies the <a href="https://docs.oracle.com/javase/tutorial/networking/sockets/definition.html">server socket</a> that Gunicorn binds to.</li>
</ul></li>
<li><strong>Lines 13 and 14</strong> change the location to the project directory and activate the virtual environment.</li>
<li><strong>Lines 16 to 24</strong> run Gunicorn with the specified parameters.</li>
</ul>
<p>Save and close the fine. Then, make it executable by running the following:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1"></a><span class="fu">chmod</span> u+x gunicorn_start</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Finally, make a <code>run</code> folder in your project directory for the Unix socket file you defined in the <code>BIND</code> parameter:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1"></a><span class="fu">mkdir</span> run</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>When you have multiple servers communicating on the same machine, <a href="https://stackoverflow.com/questions/19916016/gunicorn-nginx-server-via-socket-or-proxy">using a Unix socket file is better</a>.</p>
</section>
<section id="configure-supervisor" class="level3">
<h3 class="anchored" data-anchor-id="configure-supervisor">Configure <strong>Supervisor</strong></h3>
<p>First, create a directory called <code>logs</code> in the project directory to store your application’s error logs:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1"></a><span class="fu">mkdir</span> logs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Next, create a Supervisor’sconfiguration file by running the following command:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1"></a><span class="fu">sudo</span> vim /etc/supervisor/conf.d/fastapi-app.conf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>There copy and paste the following:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1"></a><span class="ex">[program:fastapi-app]</span></span>
<span id="cb26-2"><a href="#cb26-2"></a><span class="va">command</span><span class="op">=</span>/home/fastapi-user/fastapi-nginx-gunicorn/gunicorn_start</span>
<span id="cb26-3"><a href="#cb26-3"></a><span class="va">user</span><span class="op">=</span>fastapi-user</span>
<span id="cb26-4"><a href="#cb26-4"></a><span class="va">autostart</span><span class="op">=</span>true</span>
<span id="cb26-5"><a href="#cb26-5"></a><span class="va">autorestart</span><span class="op">=</span>true</span>
<span id="cb26-6"><a href="#cb26-6"></a><span class="va">redirect_stderr</span><span class="op">=</span>true</span>
<span id="cb26-7"><a href="#cb26-7"></a><span class="va">stdout_logfile</span><span class="op">=</span>/home/fastapi-user/fastapi-nginx-gunicorn/logs/gunicorn-error.log</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This configuration file runs the file you created earlier, <code>gunicorn_start</code>, using the <code>fastapi-user</code>. Supervisor will start the application anytime the server starts, and will also restart it if it fails.</p>
<p>This configuration file executes the <code>gunicorn_start</code> file you created earlier using <code>fastapi-user</code> as the user. Supervisor will launch the application whenever the server boots up and will restart it if the application fails. The errors are logged into <code>gunicorn-error.log</code> in <code>logs</code> in the project directory.</p>
<p>Reread Supervisor’s configuration file and restart the service by running these commands:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1"></a><span class="fu">sudo</span> supervisorctl reread</span>
<span id="cb27-2"><a href="#cb27-2"></a><span class="fu">sudo</span> supervisorctl update</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Finally, you can check the status of the program by running this command:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1"></a><span class="fu">sudo</span> supervisorctl status fastapi-app</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If everything went well, the <code>fastapi-app</code> service status should be set to <code>RUNNING</code>.</p>
<p>You can also test it by opening a new terminal window, connecting to the server, and issuing a GET request using <code>curl</code>:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1"></a><span class="ex">curl</span> <span class="at">--unix-socket</span> /home/fastapi-user/fastapi-nginx-gunicorn/run/gunicorn.sock localhost</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You should see the following output:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode numberSource json number-lines code-with-copy"><code class="sourceCode json"><span id="cb30-1"><a href="#cb30-1"></a><span class="fu">{</span> <span class="dt">"message"</span><span class="fu">:</span> <span class="st">"It's working!"</span> <span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Finally, if you make changes to the code, you can restart the service to apply to changes by running this command:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1"></a><span class="fu">sudo</span> supervisorctl restart fastapi-app</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Way to go! You’ve got an ASGI server running using Gunicorn and Uvicorn. Next, you’ll set up a reverse proxy server using NGINX.</p>
</section>
</section>
<section id="step-5-configure-nginx" class="level2">
<h2 class="anchored" data-anchor-id="step-5-configure-nginx">Step 5: Configure NGINX</h2>
<p>Create a new NGINX configuration file for your project:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1"></a><span class="fu">sudo</span> vim /etc/nginx/sites-available/fastapi-app</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Open the NGINX configuration file and paste the following content:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb33-1"><a href="#cb33-1"></a><span class="ex">upstream</span> app_server {</span>
<span id="cb33-2"><a href="#cb33-2"></a>    <span class="ex">server</span> unix:/home/fastapi-user/fastapi-nginx-gunicorn/run/gunicorn.sock fail_timeout=0<span class="kw">;</span></span>
<span id="cb33-3"><a href="#cb33-3"></a><span class="er">}</span></span>
<span id="cb33-4"><a href="#cb33-4"></a></span>
<span id="cb33-5"><a href="#cb33-5"></a><span class="ex">server</span> {</span>
<span id="cb33-6"><a href="#cb33-6"></a>    <span class="ex">listen</span> 80<span class="kw">;</span></span>
<span id="cb33-7"><a href="#cb33-7"></a></span>
<span id="cb33-8"><a href="#cb33-8"></a>    <span class="co"># add here the ip address of your server</span></span>
<span id="cb33-9"><a href="#cb33-9"></a>    <span class="co"># or a domain pointing to that ip (like example.com or www.example.com)</span></span>
<span id="cb33-10"><a href="#cb33-10"></a>    <span class="ex">server_name</span> XXXX<span class="kw">;</span></span>
<span id="cb33-11"><a href="#cb33-11"></a></span>
<span id="cb33-12"><a href="#cb33-12"></a>    <span class="ex">keepalive_timeout</span> 5<span class="kw">;</span></span>
<span id="cb33-13"><a href="#cb33-13"></a>    <span class="ex">client_max_body_size</span> 4G<span class="kw">;</span></span>
<span id="cb33-14"><a href="#cb33-14"></a></span>
<span id="cb33-15"><a href="#cb33-15"></a>    <span class="ex">access_log</span> /home/fastapi-user/fastapi-nginx-gunicorn/logs/nginx-access.log<span class="kw">;</span></span>
<span id="cb33-16"><a href="#cb33-16"></a>    <span class="ex">error_log</span> /home/fastapi-user/fastapi-nginx-gunicorn/logs/nginx-error.log<span class="kw">;</span></span>
<span id="cb33-17"><a href="#cb33-17"></a></span>
<span id="cb33-18"><a href="#cb33-18"></a>    <span class="ex">location</span> / {</span>
<span id="cb33-19"><a href="#cb33-19"></a>        <span class="ex">proxy_set_header</span> X-Forwarded-For <span class="va">$proxy_add_x_forwarded_for</span><span class="kw">;</span></span>
<span id="cb33-20"><a href="#cb33-20"></a>        <span class="ex">proxy_set_header</span> Host <span class="va">$http_host</span><span class="kw">;</span></span>
<span id="cb33-21"><a href="#cb33-21"></a>        <span class="ex">proxy_redirect</span> off<span class="kw">;</span></span>
<span id="cb33-22"><a href="#cb33-22"></a></span>
<span id="cb33-23"><a href="#cb33-23"></a>        <span class="cf">if</span> <span class="kw">(</span><span class="ex">!-f</span> <span class="va">$request_filename</span><span class="kw">)</span> <span class="kw">{</span></span>
<span id="cb33-24"><a href="#cb33-24"></a>            <span class="ex">proxy_pass</span> http://app_server<span class="kw">;</span></span>
<span id="cb33-25"><a href="#cb33-25"></a>            <span class="cf">break</span><span class="kw">;</span></span>
<span id="cb33-26"><a href="#cb33-26"></a>        <span class="kw">}</span></span>
<span id="cb33-27"><a href="#cb33-27"></a>    <span class="er">}</span></span>
<span id="cb33-28"><a href="#cb33-28"></a><span class="er">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This is the NGINX configuration file. Here’s how it works:</p>
<ul>
<li><strong>Lines 1 to 3</strong> define a cluster of servers called <code>app_server</code> that NGINX will proxy requests to. The requests are redirected to the Unix socket file located at <code>/home/fastapi-user/fastapi-nginx-gunicorn/run/gunicorn.sock</code>. Setting <code>fail_timeout=0</code> tells NGINX not to consider the server as failed even if it does not respond.</li>
<li><strong>Lines 1 to 5</strong> define the configuration for the virtual server that NGINX will use to serve requests. In this case, it listens on port 80. Replace XXXX by the IP or the site’s name.</li>
<li><strong>Lines 12 and 13</strong> specify <code>keepalive_timeout</code> to set the maximum amount of time that a client can keep a persistent connection open, and <code>client_max_body_size</code> to set a limit to size of the client request body that NGINX will allow.</li>
<li><strong>Lines 15 and 16</strong> specify the locations where NGINX will write its access and error logs.</li>
<li><strong>Lines 18 to 27</strong> defines how NGINX will handle requests to the root directory <code>/</code>. You provide some specifications to handle headers, and set a directive to proxy the requests to the <code>app_server</code> you defined earlier.</li>
</ul>
<p>Enable the configuration of your site by creating a symbolic link from the file in <code>sites-available</code> into <code>sites-enabled</code> by running this command:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb34-1"><a href="#cb34-1"></a><span class="fu">sudo</span> ln <span class="at">-s</span> /etc/nginx/sites-available/fastapi-app /etc/nginx/sites-enabled/</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Test that the configuration file is OK and restart NGINX:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb35-1"><a href="#cb35-1"></a><span class="fu">sudo</span> nginx <span class="at">-t</span></span>
<span id="cb35-2"><a href="#cb35-2"></a><span class="fu">sudo</span> systemctl restart nginx</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If everything went well, now you should be able to make a GET request successfully to the IP of your server from your browser or using <code>curl</code>. Once again, you should see the following output:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode numberSource json number-lines code-with-copy"><code class="sourceCode json"><span id="cb36-1"><a href="#cb36-1"></a><span class="fu">{</span> <span class="dt">"message"</span><span class="fu">:</span> <span class="st">"It's working!"</span> <span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You should have your FastAPI app running by now, as well as Gunicorn+Uvicorn as an ASGI server and NGINX in front of them as a reverse proxy.</p>
<section id="permissions-error" class="level3">
<h3 class="anchored" data-anchor-id="permissions-error">Permissions Error</h3>
<p>If you get a permission error telling you that NGINX cannot access the unix socket, you can add the <code>www-data</code> user (which typically is the user running the NGINX processes) to the <code>fastapi-user</code> group. You can use the following command:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1"></a><span class="fu">sudo</span> usermod <span class="at">-aG</span> fastapi-user www-data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Good job! If you haven’t bought a domain name for your API, you can stop reading here. If you have one, proceed to the next step to obtain an SSL certificate and enable HTTPS.</p>
</section>
</section>
<section id="optional-step-6-obtain-a-free-ssl-certificate-using-certbot" class="level2">
<h2 class="anchored" data-anchor-id="optional-step-6-obtain-a-free-ssl-certificate-using-certbot">(Optional) Step 6: Obtain a Free SSL Certificate Using Certbot</h2>
<p>This only applies if you have a domain for which you want to obtain an SSL certificate.</p>
<p>If you’re using Ubuntu, you can skip this step. Otherwise, you first need to install <code>snapd</code>:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb38-1"><a href="#cb38-1"></a><span class="fu">sudo</span> apt install snapd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Next, make sure you have the latest version available:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb39-1"><a href="#cb39-1"></a><span class="fu">sudo</span> snap install core<span class="kw">;</span> <span class="fu">sudo</span> snap refresh core</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Install certbot and make sure the <code>cerbot</code> command is executable:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb40-1"><a href="#cb40-1"></a><span class="fu">sudo</span> snap install <span class="at">--classic</span> certbot</span>
<span id="cb40-2"><a href="#cb40-2"></a><span class="fu">sudo</span> ln <span class="at">-s</span> /snap/bin/certbot /usr/bin/certbot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Next, generate a certificate for your domain interactively by running the following command:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb41-1"><a href="#cb41-1"></a><span class="fu">sudo</span> certbot <span class="at">--nginx</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Finally, Certbot will automatically handle the renewal of your certificate. To test that it works run the following:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb42-1"><a href="#cb42-1"></a><span class="fu">sudo</span> certbot renew <span class="at">--dry-run</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If it worked as expected, you should see a <code>Congratulations, all simulated renewals succeeded...</code> message.</p>
<p>If everything went well, you should be able to make a successful get request using HTTPS.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>That’s all there is to it! This tutorial showed you how to use NGINX, Gunicorn, and Uvicorn to deploy a FastAPI application. FastAPI is one of the most popular Python web frameworks. It’s become the go-to option for deploying machine learning-powered web apps, so becoming acquainted with it is a wise career move.</p>
<p>In this article you’ve learned:</p>
<ul>
<li>Why and when should you use FastAPI, NGINX, Gunicorn, and Uvicorn.</li>
<li>How to <strong>set up Gunicorn+Uvicorn as an ASGI server</strong>.</li>
<li>How to <strong>use Supervisor to run Gunicorn.</strong></li>
<li>How to <strong>configure NGINX and generate a free SSL certificate using certbot.</strong></li>
</ul>
<p>If you have any questions or feedback, let me know in the comments!</p>
<p>All the code for this tutorial is <a href="https://github.com/dylanjcastillo/fastapi-nginx-gunicorn">available on GitHub</a>.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2023,
  author = {Castillo, Dylan},
  title = {How to {Securely} {Deploy} a {FastAPI} App with {NGINX} and
    {Gunicorn}},
  date = {2023-02-03},
  url = {https://dylancastillo.co/posts/fastapi-nginx-gunicorn.html},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2023" class="csl-entry quarto-appendix-citeas" role="listitem">
Castillo, Dylan. 2023. <span>“How to Securely Deploy a FastAPI App with
NGINX and Gunicorn.”</span> February 3, 2023. <a href="https://dylancastillo.co/posts/fastapi-nginx-gunicorn.html">https://dylancastillo.co/posts/fastapi-nginx-gunicorn.html</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/dylancastillo\.co");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<script src="https://utteranc.es/client.js" repo="dylanjcastillo/blog_comments" issue-term="pathname" theme="dark-blue" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>Copyright 2025, Dylan Castillo</p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>