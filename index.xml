<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Dylan Castillo</title>
<link>https://dylancastillo.co/</link>
<atom:link href="https://dylancastillo.co/index.xml" rel="self" type="application/rss+xml"/>
<description></description>
<image>
<url>https://dylancastillo.co/images/social_media_card.webp</url>
<title>Dylan Castillo</title>
<link>https://dylancastillo.co/</link>
</image>
<generator>quarto-1.8.24</generator>
<lastBuildDate>Sun, 10 Aug 2025 00:00:00 GMT</lastBuildDate>
<item>
  <title>LangSmith 101</title>
  <dc:creator>Dylan Castillo</dc:creator>
  <link>https://dylancastillo.co/posts/langsmith-101.html</link>
  <description><![CDATA[ 




<p>In my first AI projects, I didn’t have access to proper observability tools and didn’t know how to evaluate the performance of LLM pipelines. I struggled to figure out what to improve and even when I knew what to improve, it was hard to do so, without breaking other things. Many of those projects failed miserably.</p>
<p>Those failed projects made me start looking for better ways and tools to build AI applications. Over time, tools such as <a href="https://smith.langchain.com/">LangSmith</a>, <a href="https://langfuse.com">Langfuse</a>, or <a href="https://logfire.pydantic.dev">Logfire</a> became key components of my AI toolkit. I can no longer imagine building an AI application without them.</p>
<p>In this tutorial, I’ll walk you through the basics of using LangSmith to monitor and evaluate your LLM applications.</p>
<section id="prerequisites" class="level2">
<h2 class="anchored" data-anchor-id="prerequisites">Prerequisites</h2>
<p>To complete this tutorial, you need to:</p>
<ol type="1">
<li>Sign up and generate <a href="https://platform.openai.com/docs/overview">OpenAI</a> and <a href="https://smith.langchain.com/">LangSmith</a> API keys.</li>
<li>Create a <code>.env</code> file in the root directory of your project and add the following lines:</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">OPENAI_API_KEY</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>your_openai_api_key</span>
<span id="cb1-2"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">LANGSMITH_TRACING</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>true</span>
<span id="cb1-3"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">LANGSMITH_PROJECT</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>your_langchain_project_name</span>
<span id="cb1-4"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">LANGSMITH_API_KEY</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>your_langsmith_api_key</span></code></pre></div></div>
<ol start="3" type="1">
<li>Create a virtual environment in Python and install the following packages:</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> venv</span>
<span id="cb2-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> add langchain langchain-openai langsmith openai jupyter python-dotenv </span></code></pre></div></div>
<p>I’m assuming you’re familiar with the basics of LLMs. If you need a refresher, you can check out some of <a href="https://dylancastillo.co/posts/function-calling-structured-outputs.html">my</a> <a href="https://dylancastillo.co/posts/key-parameters-llms.html">older</a> <a href="https://dylancastillo.co/posts/prompt-engineering-101.html">posts</a>. Also, if you don’t want to copy and paste the code, you can download this post’s <a href="https://github.com/dylanjcastillo/blog/tree/main/posts/synthetic-data-rag.ipynb">notebook</a> and follow along.</p>
<p>Let’s go!</p>
</section>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<p>As usual, you should start by importing the necessary libraries:</p>
<div id="cell-3" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> datasets <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dataset</span>
<span id="cb3-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb3-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.messages <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> HumanMessage, SystemMessage</span>
<span id="cb3-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatOpenAI</span>
<span id="cb3-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langsmith <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Client, trace, traceable</span>
<span id="cb3-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langsmith.run_trees <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> RunTree</span>
<span id="cb3-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langsmith.wrappers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> wrap_openai</span>
<span id="cb3-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAI</span>
<span id="cb3-9"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pydantic <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> BaseModel, Field</span>
<span id="cb3-10"></span>
<span id="cb3-11">load_dotenv()</span></code></pre></div></div>
</div>
<p>This will import all the libraries required for the next sections:</p>
<ol type="1">
<li><code>datasets</code> for loading the sample dataset we’ll use to run evaluations.</li>
<li><code>langchain</code> libraries and <code>openai</code> for working with LLMs</li>
<li><code>langsmith</code> for tracing and evaluating the pipeline</li>
<li><code>dotenv</code> and <code>pydantic</code> for environment variable management and data validation</li>
</ol>
<p>Next, you will create your first trace on LangSmith.</p>
</section>
<section id="tracing-and-monitoring" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="tracing-and-monitoring">Tracing and monitoring</h2>
<p>A LangSmith <strong>trace</strong> captures the full execution path of a single operation. It consists of a sequence of steps, which are called <strong>runs</strong>. Each trace contains the top-level inputs and outputs, as well as metadata such as runtime version and operating system details.</p>
<p>There are four ways to create traces in LangSmith:</p>
<ol type="1">
<li>Using <code>@traceable</code></li>
<li>Using a wrapped client</li>
<li>Using a <code>trace</code> context manager</li>
<li>Manually creating traces with <code>RunTree</code></li>
</ol>
<section id="using-traceable" class="level3">
<h3 class="anchored" data-anchor-id="using-traceable">Using <code>@traceable</code></h3>
<p>The simplest way is to encapsulate your pipeline in a function and use the <code>traceable</code> decorator:</p>
<div id="cell-7" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1">client <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAI()</span>
<span id="cb4-2"></span>
<span id="cb4-3"></span>
<span id="cb4-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@traceable</span></span>
<span id="cb4-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> format_messages(question: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>]:</span>
<span id="cb4-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> [</span>
<span id="cb4-7">        {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"system"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You're a helpful assistant"</span>},</span>
<span id="cb4-8">        {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: question},</span>
<span id="cb4-9">    ]</span>
<span id="cb4-10"></span>
<span id="cb4-11"></span>
<span id="cb4-12"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@traceable</span>(run_type<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"llm"</span>)</span>
<span id="cb4-13"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> call_llm(messages: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>]):</span>
<span id="cb4-14">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> client.chat.completions.create(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4.1-mini"</span>, messages<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>messages)</span>
<span id="cb4-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response</span>
<span id="cb4-16"></span>
<span id="cb4-17"></span>
<span id="cb4-18"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@traceable</span></span>
<span id="cb4-19"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> run_pipeline(question: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>):</span>
<span id="cb4-20">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> format_messages(question)</span>
<span id="cb4-21">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> call_llm(messages)</span>
<span id="cb4-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response.choices[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].message.content</span>
<span id="cb4-23"></span>
<span id="cb4-24"></span>
<span id="cb4-25">run_pipeline(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Who are you?"</span>)</span></code></pre></div></div>
</div>
<p>This will automatically log the input and ouput of the functions decorated with <code>traceable</code>. It will also handle the nesting for you, so that <code>format_messages</code> and <code>call_llm</code> are steps within the <code>run_pipeline</code> function.</p>
<p>In <code>traceable</code> you can customize xyz.</p>
</section>
<section id="using-a-trace-context-manager" class="level3">
<h3 class="anchored" data-anchor-id="using-a-trace-context-manager">Using a <code>trace</code> context manager</h3>
<p>In addition, to the <code>traceable</code> decorator, you can also use the <code>trace</code> context manager to create traces. You can easily combine both as shown below:</p>
<div id="cell-11" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1">client <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAI()</span>
<span id="cb5-2"></span>
<span id="cb5-3"></span>
<span id="cb5-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@traceable</span></span>
<span id="cb5-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> format_messages(question: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>]:</span>
<span id="cb5-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> [</span>
<span id="cb5-7">        {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"system"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You're a helpful assistant"</span>},</span>
<span id="cb5-8">        {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: question},</span>
<span id="cb5-9">    ]</span>
<span id="cb5-10"></span>
<span id="cb5-11"></span>
<span id="cb5-12"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@traceable</span>(run_type<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"llm"</span>)</span>
<span id="cb5-13"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> call_llm(messages: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>]):</span>
<span id="cb5-14">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> client.chat.completions.create(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4.1-mini"</span>, messages<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>messages)</span>
<span id="cb5-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response</span>
<span id="cb5-16"></span>
<span id="cb5-17"></span>
<span id="cb5-18">app_inputs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Who are you?"</span>}</span>
<span id="cb5-19"></span>
<span id="cb5-20"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> trace(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"run_pipeline"</span>, inputs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>app_inputs) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> rt:</span>
<span id="cb5-21">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> format_messages(app_inputs[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>])</span>
<span id="cb5-22">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> call_llm(messages)</span>
<span id="cb5-23">    output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> response.choices[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].message.content</span>
<span id="cb5-24">    rt.end(outputs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output"</span>: output})</span></code></pre></div></div>
</div>
<p>This will generate a trace called “LLM Pipeline” with the input and output of the entire pipeline. Within this trace, you will find the individual traces for each function call.</p>
</section>
<section id="using-a-wrapped-client" class="level3">
<h3 class="anchored" data-anchor-id="using-a-wrapped-client">Using a wrapped client</h3>
<p>For <code>OpenAI</code> and <code>Anthropic</code> models, LangSmith offers a wrapped client that automatically instruments calls to the API with tracing. Any call to the LLM will automatically handled by LangSmith. This plays well with using <code>traceable</code> for the rest of the part in your pipeline. For example:</p>
<div id="cell-14" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1">client <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> wrap_openai(OpenAI())  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Added client wrapper</span></span>
<span id="cb6-2"></span>
<span id="cb6-3"></span>
<span id="cb6-4"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@traceable</span></span>
<span id="cb6-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> format_messages(question: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>]:</span>
<span id="cb6-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> [</span>
<span id="cb6-7">        {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"system"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You're a helpful assistant"</span>},</span>
<span id="cb6-8">        {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: question},</span>
<span id="cb6-9">    ]</span>
<span id="cb6-10"></span>
<span id="cb6-11"></span>
<span id="cb6-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Removed @traceable</span></span>
<span id="cb6-13"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> call_llm(messages: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>]):</span>
<span id="cb6-14">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> client.chat.completions.create(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4.1-mini"</span>, messages<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>messages)</span>
<span id="cb6-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response</span>
<span id="cb6-16"></span>
<span id="cb6-17"></span>
<span id="cb6-18"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@traceable</span></span>
<span id="cb6-19"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> run_pipeline(question: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>):</span>
<span id="cb6-20">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> format_messages(question)</span>
<span id="cb6-21">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> call_llm(messages)</span>
<span id="cb6-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response.choices[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].message.content</span>
<span id="cb6-23"></span>
<span id="cb6-24"></span>
<span id="cb6-25">run_pipeline(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Who are you?"</span>)</span></code></pre></div></div>
</div>
<p>This will automatically log the LLM calls made within <code>run_pipeline</code>, so you no longer need to add the <code>traceable</code> decorator to each call.</p>
</section>
<section id="manually-creating-traces-with-runtree" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="manually-creating-traces-with-runtree">Manually creating traces with <code>RunTree</code></h3>
<p>If you want to have more control over the tracing, you can use <a href="https://docs.smith.langchain.com/reference/python/run_trees/langsmith.run_trees.RunTree"><code>RunTree</code></a>. It provides the most flexibility but requires more setup.</p>
<p>Here’s the <code>RunTree</code> version of the previous example:</p>
<div id="cell-17" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1">client <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAI()</span>
<span id="cb7-2"></span>
<span id="cb7-3"></span>
<span id="cb7-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> format_messages(question: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, parent_run: RunTree):</span>
<span id="cb7-5">    format_message_step <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> parent_run.create_child(</span>
<span id="cb7-6">        name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"format_messages"</span>, run_type<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tool"</span>, inputs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>: question}</span>
<span id="cb7-7">    )</span>
<span id="cb7-8">    format_message_step.post()</span>
<span id="cb7-9">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb7-10">        {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"system"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are a helpful assistant."</span>},</span>
<span id="cb7-11">        {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: question},</span>
<span id="cb7-12">    ]</span>
<span id="cb7-13">    format_message_step.end(outputs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"messages"</span>: messages})</span>
<span id="cb7-14">    format_message_step.patch()</span>
<span id="cb7-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> messages</span>
<span id="cb7-16"></span>
<span id="cb7-17"></span>
<span id="cb7-18"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> call_llm(messages: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>], parent_run: RunTree):</span>
<span id="cb7-19">    call_llm_step <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> parent_run.create_child(</span>
<span id="cb7-20">        name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"call_llm"</span>,</span>
<span id="cb7-21">        run_type<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"llm"</span>,</span>
<span id="cb7-22">        inputs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"messages"</span>: messages},</span>
<span id="cb7-23">    )</span>
<span id="cb7-24">    call_llm_step.post()</span>
<span id="cb7-25">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> client.chat.completions.create(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4.1-mini"</span>, messages<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>messages)</span>
<span id="cb7-26">    call_llm_step.end(outputs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>response)</span>
<span id="cb7-27">    call_llm_step.patch()</span>
<span id="cb7-28">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response</span>
<span id="cb7-29"></span>
<span id="cb7-30"></span>
<span id="cb7-31"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> run_pipeline(question: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>):</span>
<span id="cb7-32">    parent_run <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RunTree(name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"run_pipeline"</span>, inputs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>: question})</span>
<span id="cb7-33">    parent_run.post()</span>
<span id="cb7-34"></span>
<span id="cb7-35">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> format_messages(question, parent_run)</span>
<span id="cb7-36">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> call_llm(messages, parent_run)</span>
<span id="cb7-37"></span>
<span id="cb7-38">    parent_run.end(outputs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"answer"</span>: response.choices[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].message.content})</span>
<span id="cb7-39">    parent_run.patch()</span>
<span id="cb7-40"></span>
<span id="cb7-41"></span>
<span id="cb7-42">run_pipeline(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Who are you?"</span>)</span></code></pre></div></div>
</div>
<p>This will result in a similar trace, but in this case you have more control over when/what to send in each step.</p>
<p>For all of these methods, you should’ve obtained a trace that looks like this:</p>
<p><a href="./images/langsmith-101/traces.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="https://dylancastillo.co/posts/images/langsmith-101/traces.png" class="img-fluid"></a></p>
<p>To the left of the image, you should see the trace for the <code>run_pipeline</code> function, which includes all the steps taken during the execution of the function, including the formatting of messages and the call to the LLM. To the right, you will see the input and output for the full trace.</p>
<p>Then, you can click on each individual step to view more details about that step, including the inputs, outputs, and any errors that may have occurred.</p>
<p>Here’s <code>format_messages</code>:</p>
<p><a href="./images/langsmith-101/format_messages.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="https://dylancastillo.co/posts/images/langsmith-101/format_messages.png" class="img-fluid"></a></p>
<p>And here’s <code>call_llm</code>:</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><a href="./images/langsmith-101/call_llm.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3" title="image.png"><img src="https://dylancastillo.co/posts/images/langsmith-101/call_llm.png" class="img-fluid figure-img" alt="image.png"></a></p>
<figcaption class="margin-caption">image.png</figcaption>
</figure>
</div>
<p>I recommend you explore the traces on your own. Just looking at the images in this post won’t be enough.</p>
</section>
</section>
<section id="evaluation" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="evaluation">Evaluation</h2>
<p>LangSmith lets you evaluate your LLM pipelines by providing you with a way to upload evaluation datasets, define evaluation metrics, and view the results of your experiments.</p>
<p>Let’s explore this by running a set of evals on a sample dataset. You’ll use the <a href="https://huggingface.co/datasets/AI-MO/aimo-validation-aime"><code>AIMO Validation AIME</code></a> dataset that contains questions, answers and detailed solutions from the 2022, 2023, and 2024 AIME competitions.</p>
<p>You should start by creating a dataset on LangSmith:</p>
<div id="cell-22" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1">ds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> load_dataset(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AI-MO/aimo-validation-aime"</span>)</span>
<span id="cb8-2">examples <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb8-3">    {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"inputs"</span>: {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>: d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"problem"</span>]}, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"outputs"</span>: {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"answer"</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(d[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"answer"</span>])}}</span>
<span id="cb8-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> d <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ds[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"train"</span>]</span>
<span id="cb8-5">][:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>]</span>
<span id="cb8-6"></span>
<span id="cb8-7">client <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Client()</span>
<span id="cb8-8"></span>
<span id="cb8-9">dataset_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"AIME Example Dataset (sample)"</span></span>
<span id="cb8-10"></span>
<span id="cb8-11"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb8-12">    dataset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> client.create_dataset(dataset_name)</span>
<span id="cb8-13">    client.create_examples(dataset_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>dataset.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span>, examples<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>examples)</span>
<span id="cb8-14"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb8-15">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Dataset </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>dataset_name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> already exists. Error: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>e<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb8-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pass</span></span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataset AIME Example Dataset (sample) already exists. Error: Conflict for /datasets. HTTPError('409 Client Error: Conflict for url: https://api.smith.langchain.com/datasets', '{"detail":"Dataset with this name already exists."}')</code></pre>
</div>
</div>
<p>This will create a dataset with the first 15 examples from the AIMO Validation AIME dataset. I only included a a sample of the dataset to keep costs down. You can always add more examples later if needed.</p>
<p>The dataset will be available under <code>Datasets &amp; Experiments</code>:</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><a href="./images/langsmith-101/dataset.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4" title="image.png"><img src="https://dylancastillo.co/posts/images/langsmith-101/dataset.png" class="img-fluid figure-img" alt="image.png"></a></p>
<figcaption class="margin-caption">image.png</figcaption>
</figure>
</div>
<p>Then, you’ll define a pipeline that takes the user question, and provides a response using a structured output:</p>
<div id="cell-24" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Response(BaseModel):</span>
<span id="cb10-2">    explanation: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The explanation of the answer"</span>)</span>
<span id="cb10-3">    answer: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(</span>
<span id="cb10-4">        description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The answer to the question. It should be an integer."</span></span>
<span id="cb10-5">    )</span>
<span id="cb10-6"></span>
<span id="cb10-7"></span>
<span id="cb10-8">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4.1-mini"</span>, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb10-9">model_with_structure <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.with_structured_output(Response, method<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"function_calling"</span>)</span>
<span id="cb10-10"></span>
<span id="cb10-11"></span>
<span id="cb10-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_response(question: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Response:</span>
<span id="cb10-13">    max_retries <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb10-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(max_retries):</span>
<span id="cb10-15">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb10-16">            messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb10-17">                SystemMessage(</span>
<span id="cb10-18">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You're a math expert. You will always respond in a JSON format with the following fields: explanation and answer."</span></span>
<span id="cb10-19">                ),</span>
<span id="cb10-20">                HumanMessage(question),</span>
<span id="cb10-21">            ]</span>
<span id="cb10-22">            response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model_with_structure.invoke(messages)</span>
<span id="cb10-23">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response</span>
<span id="cb10-24">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb10-25">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Error: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>e<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb10-26">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">continue</span></span>
<span id="cb10-27">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Failed to get a valid response"</span>)</span></code></pre></div></div>
</div>
<p>I included a simple retry mechanism, as I often found that the model sometime failed to generate a valid response.</p>
<p>Next, you should define the evaluation metrics you’ll use to measure the performance of your pipeline. You could define a simple accuracy metric that checks if the answer is the same as the expected answer:</p>
<div id="cell-26" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> accuracy(inputs: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>, outputs: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>, reference_outputs: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span>:</span>
<span id="cb11-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> outputs[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"answer"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> reference_outputs[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"answer"</span>]</span></code></pre></div></div>
</div>
<p>To define an evaluation metric in LangSmith, you must create a function that takes the inputs, outputs, and reference outputs as arguments and returns a boolean or a numeric value.</p>
<p>For accuracy, the function checks if the answer provided by the model matches the expected answer from the dataset, and returns a boolean value indicating whether the evaluation passed or failed.</p>
<p>You can also define more complex metrics, such as an LLM judge to evaluate the clarity of the solution:</p>
<div id="cell-28" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> ClarityResponse(BaseModel):</span>
<span id="cb12-2">    explanation: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The explanation of the answer"</span>)</span>
<span id="cb12-3">    clarity: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The clarity of the explanation"</span>, ge<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, le<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb12-4"></span>
<span id="cb12-5"></span>
<span id="cb12-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> clarity(inputs: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>, outputs: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>, reference_outputs: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>:</span>
<span id="cb12-7">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb12-8">        SystemMessage(</span>
<span id="cb12-9">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are a helpful assistant that evaluates the clarity of the explanation of the answer. You will always return a number between 1 and 5, where 1 is the lowest clarity and 5 is the highest clarity."</span></span>
<span id="cb12-10">        ),</span>
<span id="cb12-11">        HumanMessage(content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Explanation: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>outputs[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'explanation'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>),</span>
<span id="cb12-12">    ]</span>
<span id="cb12-13">    model_with_clarity_structure <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.with_structured_output(ClarityResponse)</span>
<span id="cb12-14">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model_with_clarity_structure.invoke(messages)</span>
<span id="cb12-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response.clarity</span></code></pre></div></div>
</div>
<p>This <code>clarity</code> metric evaluates the clarity of the explanation provided by the model. It uses a scale from 1 to 5, where 1 indicates low clarity and 5 indicates high clarity.</p>
<p>Finally, you can run the evaluation using <code>client.evaluate()</code>:</p>
<div id="cell-30" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> ls_wrapper(inputs: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>:</span>
<span id="cb13-2">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_response(inputs[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>])</span>
<span id="cb13-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response.model_dump()</span>
<span id="cb13-4"></span>
<span id="cb13-5"></span>
<span id="cb13-6">experiment_results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> client.aevaluate(</span>
<span id="cb13-7">    ls_wrapper, data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>dataset_name, evaluators<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[accuracy, clarity], max_concurrency<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span></span>
<span id="cb13-8">)</span></code></pre></div></div>
</div>
<p>LangSmith requires you to define a function that wraps your pipeline function. It should take an input dictionary that contains the necessary parameters for your pipeline and return a dictionary with the results. You can also specify a <code>evaluators</code> parameter that includes the evaluation metrics you want to use.</p>
<p>After you’ve run the evaluation, you’ll be able to inspect the results of the experiment:</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><a href="./images/langsmith-101/results.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5" title="image.png"><img src="https://dylancastillo.co/posts/images/langsmith-101/results.png" class="img-fluid figure-img" alt="image.png"></a></p>
<figcaption class="margin-caption">image.png</figcaption>
</figure>
</div>
<p>You can also investigate single runs:</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><a href="./images/langsmith-101/single_run.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6" title="image.png"><img src="https://dylancastillo.co/posts/images/langsmith-101/single_run.png" class="img-fluid figure-img" alt="image.png"></a></p>
<figcaption class="margin-caption">image.png</figcaption>
</figure>
</div>
<p>Or see how results look over time:</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><a href="./images/langsmith-101/results_over_time.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7" title="image.png"><img src="https://dylancastillo.co/posts/images/langsmith-101/results_over_time.png" class="img-fluid figure-img" alt="image.png"></a></p>
<figcaption class="margin-caption">image.png</figcaption>
</figure>
</div>
<p>Once again, I suggest you go explore the results in the LangSmith UI.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>That’s all! We’ve covered the basics of using LangSmith to trace and evaluate your LLM applications.</p>
<p>By now, you should have a good understanding of how to create traces, define evaluation metrics, and run experiments.</p>
<p>If you have any questions or feedback, let me know in the comments below.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2025,
  author = {Castillo, Dylan},
  title = {LangSmith 101},
  date = {2025-08-10},
  url = {https://dylancastillo.co/posts/langsmith-101.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2025" class="csl-entry quarto-appendix-citeas">
Castillo, Dylan. 2025. <span>“LangSmith 101.”</span> August 10, 2025. <a href="https://dylancastillo.co/posts/langsmith-101.html">https://dylancastillo.co/posts/langsmith-101.html</a>.
</div></div></section></div> ]]></description>
  <category>llm</category>
  <category>python</category>
  <category>openai</category>
  <category>langsmith</category>
  <guid>https://dylancastillo.co/posts/langsmith-101.html</guid>
  <pubDate>Sun, 10 Aug 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Using synthetic data to bootstrap your RAG system evals</title>
  <dc:creator>Dylan Castillo</dc:creator>
  <link>https://dylancastillo.co/posts/synthetic-data-rag.html</link>
  <description><![CDATA[ 




<p>I’ve been catching up on Hamel Husain and Shreya Shankar’s <a href="https://maven.com/parlance-labs/evals">AI Evals for Engineers &amp; PMs</a> course. If you’re thinking of taking it, I highly recommend it. There’s no better material on evaluating AI systems out there.</p>
<p>One part that I found particularly interesting was the section on generating synthetic data for bootstrapping the evaluation of RAG systems. I’ve worked on several AI projects, but in all of them, we had real data to work with, so I hadn’t had the chance to generate synthetic data for this purpose.</p>
<p>I decided to work through a simple example and write some notes about it. In this article, I’ll walk you through the process of bootstrapping your RAG system evals using synthetic data.</p>
<section id="prerequisites" class="level2">
<h2 class="anchored" data-anchor-id="prerequisites">Prerequisites</h2>
<p>If you plan to follow along, you’ll need to:</p>
<ol type="1">
<li>Sign up and generate <a href="https://platform.openai.com/docs/overview">OpenAI</a> and <a href="https://smith.langchain.com/">LangSmith</a> API keys.</li>
<li>Create a <code>.env</code> file in the root directory of your project and add the following lines:</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">OPENAI_API_KEY</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>your_openai_api_key</span>
<span id="cb1-2"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">LANGSMITH_TRACING</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>true</span>
<span id="cb1-3"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">LANGSMITH_PROJECT</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>your_langchain_project_name</span>
<span id="cb1-4"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">LANGSMITH_API_KEY</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>your_langsmith_api_key</span></code></pre></div></div>
<ol start="3" type="1">
<li>Create a virtual environment in Python and install the following packages:</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> venv</span>
<span id="cb2-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uv</span> add langchain langchain-openai langchain-community langsmith jupyter chromadb python-dotenv nest_asyncio sentence-transformers</span></code></pre></div></div>
<ol start="4" type="1">
<li>Download the People Group’s section from GitLab’s <a href="https://gitlab.com/gitlab-com/content-sites/handbook/-/tree/main/content/handbook/people-group">handbook</a>.</li>
</ol>
<p>I’m also assuming you’re familiar with the basics of RAG systems and how to use vector databases. If you need a refresher, you can check out my <a href="https://dylancastillo.co/posts/what-is-rag.html">RAG tutorial</a>.</p>
<p>Then, you’ll be able to run the code from this article. If you don’t want to copy and paste the code, you can download this <a href="https://github.com/dylanjcastillo/blog/tree/main/posts/synthetic-data-rag.ipynb">notebook</a>.</p>
</section>
<section id="how-to-generate-synthetic-data-for-rag-evals" class="level2">
<h2 class="anchored" data-anchor-id="how-to-generate-synthetic-data-for-rag-evals">How to generate synthetic data for RAG evals</h2>
<p>The process is simple. Here’s how it works:</p>
<ol type="1">
<li>Split your source document into chunks and store them in a vector database.</li>
<li>Sample a few chunks from the vector database.</li>
<li>For each sampled chunk, extract a <strong>fact</strong> from it and generate a <strong>question</strong> that is unambiguously answered by the fact.</li>
<li>Define evaluation metrics for your RAG system.</li>
<li>Optionally, filter the generated questions to remove the ones that don’t seem realistic.</li>
<li>Measure the performance of your RAG system.</li>
</ol>
<p>In the next sections, I’ll help you implement this process step by step, providing code snippets you can run in a Jupyter notebook.</p>
</section>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<p>You’ll use <code>asyncio</code> in some of the code snippets, so you must enable <code>nest_asyncio</code> to run the code:</p>
<div id="1e2a708d" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> nest_asyncio</span>
<span id="cb3-2"></span>
<span id="cb3-3">nest_asyncio.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>()</span></code></pre></div></div>
</div>
<p>Then, you can proceed as usual, importing the required packages:</p>
<div id="f58b9d35" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> asyncio</span>
<span id="cb4-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb4-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> random</span>
<span id="cb4-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> textwrap <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> dedent</span>
<span id="cb4-5"></span>
<span id="cb4-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> chromadb</span>
<span id="cb4-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb4-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> chromadb.utils.embedding_functions <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAIEmbeddingFunction</span>
<span id="cb4-9"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb4-10"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_community.document_loaders <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> DirectoryLoader, TextLoader</span>
<span id="cb4-11"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.prompts <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatPromptTemplate</span>
<span id="cb4-12"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatOpenAI</span>
<span id="cb4-13"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_text_splitters <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> MarkdownTextSplitter</span>
<span id="cb4-14"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langsmith <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Client, traceable</span>
<span id="cb4-15"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pydantic <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> BaseModel</span>
<span id="cb4-16"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sentence_transformers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> CrossEncoder</span>
<span id="cb4-17"></span>
<span id="cb4-18">load_dotenv()</span></code></pre></div></div>
</div>
<p>These are the most important libraries you’ll use in this article:</p>
<ul>
<li><strong>chromadb</strong>: Vector database for storing and retrieving document embeddings</li>
<li><strong>langchain</strong>: Framework for building LLM applications</li>
<li><strong>langchain-openai</strong>: Wrapper for OpenAI’s API, providing access to LLMs and embeddings</li>
<li><strong>pydantic</strong>: Provides models for generating structured data and validating types</li>
<li><strong>sentence-transformers</strong>: In the last section of the article, you’ll use this library to rerank the retrieved documents.</li>
</ul>
<p>The rest of the libraries will handle typical Python tasks, such as reading files, managing environment variables, etc.</p>
<p>For this tutorial, you’ll be building a RAG system that feeds an internal chatbot that helps employees of a company answer questions about company policies.</p>
<p>I chose this topic because there’s a pretty good source of data we can use for this: <a href="https://handbook.gitlab.com/">The GitLab Handbook</a>. We’ll just use the People Group section of the handbook, to keep costs manageable.</p>
<p>Your next step is to load the data from the handbook:</p>
<div id="66a8c9c6" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1">loader <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DirectoryLoader(</span>
<span id="cb5-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../data/synthetic-data-rag/people-group/"</span>, glob<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"**/*.md"</span>, loader_cls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>TextLoader</span>
<span id="cb5-3">)</span>
<span id="cb5-4">docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> loader.load()</span>
<span id="cb5-5"></span>
<span id="cb5-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(docs)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>99</code></pre>
</div>
</div>
<p>If you set everything up correctly, the cell should output the number of documents in the <code>docs</code> variable. Depending on when you read this article, the number of documents may change, as the handbook is updated regularly. The date I downloaded the data, there were 99 documents in the People Group section.</p>
<p>Then, you must add the data to the vector database.</p>
</section>
<section id="index-data" class="level2">
<h2 class="anchored" data-anchor-id="index-data">Index data</h2>
<p>A <strong>vector database</strong> is a database designed to efficiently store and query data as vector embeddings (numerical representations). Provided with a user query, it’s the engine you use to find the most similar data in your database.</p>
<p>For this tutorial, you’ll use <a href="https://www.trychroma.com/">ChromaDB</a>. Let’s set it up:</p>
<div id="c7df6e53" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1">openai_ef <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAIEmbeddingFunction(api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>os.getenv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OPENAI_API_KEY"</span>))</span>
<span id="cb7-2">client <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> chromadb.PersistentClient(</span>
<span id="cb7-3">    path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../data/synthetic-data-rag/chroma"</span>,</span>
<span id="cb7-4">)</span>
<span id="cb7-5">collection <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> client.get_or_create_collection(</span>
<span id="cb7-6">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gitlab-handbook"</span>, embedding_function<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>openai_ef</span>
<span id="cb7-7">)</span></code></pre></div></div>
</div>
<p>This code snippet:</p>
<ol type="1">
<li>Defines an embedding function that uses OpenAI’s API to generate embeddings for the documents.</li>
<li>Creates a ChromaDB client to interact with the vector database.</li>
<li>Creates a collection in the vector database to store the document embeddings and sets the embedding function to use the OpenAI embedding model.</li>
</ol>
<p>Next, you should generate embeddings for the documents and store them in the vector database. But there’s a little catch: some documents are longer than the maximum token limit of the embedding model (8192 tokens). This will break the indexing process. To avoid this, you must split the documents into smaller chunks.</p>
<p>You can do this with the following code snippet:</p>
<div id="10523d7a" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1">text_splitter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> MarkdownTextSplitter.from_tiktoken_encoder(</span>
<span id="cb8-2">    model_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4o"</span>,</span>
<span id="cb8-3">    chunk_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">400</span>,</span>
<span id="cb8-4">    chunk_overlap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb8-5">)</span>
<span id="cb8-6">splits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> text_splitter.split_documents(docs)</span></code></pre></div></div>
</div>
<p>The handbook is written using Markdown, so you can use the <code>MarkdownTextSplitter</code> to split the documents. This will use the headings in the files for the splitting in addition to the number of tokens. This generally results in better chunks, as they will be more likely to contain complete thoughts or sections of the document.</p>
<p>The <code>from_tiktoken_encoder</code> method lets you do the splits based on the number of tokens, not characters which is the default behavior. You’ve set a chunk size of 400 tokens, with no overlap.</p>
<p>After running the splitting code, you can check the number of chunks created by running this:</p>
<div id="ba5cec1e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(splits)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>999</code></pre>
</div>
</div>
<p>Now you have another problem: you have too many chunks. If you try to add all of them to the vector database at once—which also generates their embeddings—you’ll likely hit the OpenAI API rate limits.</p>
<p>To solve this, let’s define a utility function that adds the chunks to the vector database in batches:</p>
<div id="c5cc250f" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> create_batches(ids, documents, metadatas, batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>):</span>
<span id="cb11-2">    batches <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb11-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(ids), batch_size):</span>
<span id="cb11-4">        batch_ids <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ids[i : i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> batch_size]</span>
<span id="cb11-5">        batch_documents <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> documents[i : i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> batch_size]</span>
<span id="cb11-6">        batch_metadatas <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> metadatas[i : i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> batch_size]</span>
<span id="cb11-7">        batches.append((batch_ids, batch_metadatas, batch_documents))</span>
<span id="cb11-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> batches</span></code></pre></div></div>
</div>
<p>Then, you can apply this function to the chunks you created earlier:</p>
<div id="3287eb76" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1">ids <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(i)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(splits))]</span>
<span id="cb12-2">documents <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [doc.page_content <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> splits]</span>
<span id="cb12-3">metadatas <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [doc.metadata <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> splits]</span>
<span id="cb12-4"></span>
<span id="cb12-5"></span>
<span id="cb12-6"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> collection.count() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb12-7">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Collection already exists, skipping creation."</span>)</span>
<span id="cb12-8"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb12-9">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Adding documents..."</span>)</span>
<span id="cb12-10">    batches <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> create_batches(ids<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ids, documents<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>documents, metadatas<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>metadatas)</span>
<span id="cb12-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, batch <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(batches):</span>
<span id="cb12-12">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Adding batch </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> of size </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(batch[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb12-13">        collection.add(ids<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>batch[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], metadatas<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>batch[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], documents<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>batch[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span></code></pre></div></div>
</div>
<p>Feel free to adjust the batch size according to your needs. This should take a few seconds to run. Once it’s done, your vector database should be ready to use.</p>
<p>Next, you’ll define a couple of functions to interact with the vector database and a data model to represent the retrieved documents you’ll be working with.</p>
<div id="bb0baae9" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> RetrievedDoc(BaseModel):</span>
<span id="cb13-2">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb13-3">    path: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb13-4">    page_content: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb13-5"></span>
<span id="cb13-6"></span>
<span id="cb13-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_similar_docs(text: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, top_k: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[RetrievedDoc]:</span>
<span id="cb13-8">    results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> collection.query(query_texts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[text], n_results<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>top_k)</span>
<span id="cb13-9">    docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"documents"</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][i] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(top_k)]</span>
<span id="cb13-10">    metadatas <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"metadatas"</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][i] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(top_k)]</span>
<span id="cb13-11">    ids <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ids"</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][i] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(top_k)]</span>
<span id="cb13-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> [</span>
<span id="cb13-13">        RetrievedDoc(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>id_, path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>m[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"source"</span>], page_content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>d)</span>
<span id="cb13-14">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> d, m, id_ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(docs, metadatas, ids)</span>
<span id="cb13-15">    ]</span>
<span id="cb13-16"></span>
<span id="cb13-17"></span>
<span id="cb13-18"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_doc_by_id(doc_id: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> RetrievedDoc:</span>
<span id="cb13-19">    results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> collection.get(ids<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[doc_id])</span>
<span id="cb13-20">    doc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"documents"</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb13-21">    metadata <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"metadatas"</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb13-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> RetrievedDoc(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>doc_id, path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>metadata[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"source"</span>], page_content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>doc)</span></code></pre></div></div>
</div>
<p>In this code snippet, you define two functions:</p>
<ol type="1">
<li><code>get_similar_docs</code> will let you retrieve the most similar documents to a user query.</li>
<li><code>get_document_by_id</code> will let you retrieve a document by its ID.</li>
</ol>
<p><code>RetrievedDoc</code> is a Pydantic model that represents a retrieved document. It includes the document’s ID, file path, and the page content. This model will help you structure the data you retrieve from the vector database.</p>
<p>Next, you can sample documents for the synthetic data generation:</p>
<div id="4db2a9ca" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1">golden_docs_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> random.sample(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(splits)), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)</span>
<span id="cb14-2">golden_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [get_doc_by_id(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(i)) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> golden_docs_idx]</span></code></pre></div></div>
</div>
<p>This will result in 200 documents that you’ll use to generate the synthetic data.</p>
</section>
<section id="generate-qa-pairs" class="level2">
<h2 class="anchored" data-anchor-id="generate-qa-pairs">Generate QA Pairs</h2>
<p>Using the documents you just sampled, you can generate synthetic data. For each document, you’ll extract a fact and generate a question from it.</p>
<p>This is simple but it has a big issue: it may produce questions that are too easy to answer and result in an overly optimistic evaluation of your RAG system.</p>
<p>To create more challenging synthetic queries, Hamel and Shreya recommend adding similar confounding chunks to the generation process, so that it can generate questions in an adversarial manner. The generator will create a question that is uniquely answered by the target chunk but also include themes or keywords that are present in other chunks.</p>
<p>Here’s an example of how this works:</p>
<p><strong>Target chunk:</strong> “George Orwell’s masterpiece, <em>Nineteen Eighty-Four</em>, was published in June 1949 and introduced the concept of ‘Big Brother’ to a global audience.”</p>
<p><strong>Similar chunks:</strong></p>
<ol type="1">
<li>“Aldous Huxley’s <em>Brave New World</em>, another influential work of dystopian fiction, was first released in 1932 and explores themes of social conditioning and control.”</li>
<li>“Ray Bradbury’s <em>Fahrenheit 451</em>, published in 1953, depicts a future society where books are banned and ‘firemen’ burn any that are found.”</li>
</ol>
<p><strong>Synthetic Question:</strong> “In what year was the dystopian novel that introduced the concept of ‘Big Brother’ published?”</p>
<p>The target chunk helps the generator come up with a synthetic question. The similar chunks provide distractors that help the generator include themes or keywords that are also present in other chunks (e.g., dystopian fiction), making the question more challenging.</p>
<p>To do this, you can use the following prompts:</p>
<div id="582a5b45" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1">system_prompt_generate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dedent(</span>
<span id="cb15-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb15-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    You are a helpful assistant generating synthetic QA pairs for retrieval evaluation.</span></span>
<span id="cb15-4"></span>
<span id="cb15-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    Given a target chunk of text and a set of confounding chunks, you must extract a specific, self-contained fact from the target chunk that is not included in the confounding chunks. Then write a question that is directly and unambiguously answered by that fact. The question should only be answered by the fact extracted from the target chunk (and not by any of the confounding chunks) but it should also use themes or terminology that is present in the confounding chunks.</span></span>
<span id="cb15-6"></span>
<span id="cb15-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    Always respond with a JSON object with the following keys (in that exact order):</span></span>
<span id="cb15-8"></span>
<span id="cb15-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    1. "fact": "&lt;the fact extracted from the target chunk&gt;",</span></span>
<span id="cb15-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    2. "confounding_terms": "&lt;a list of terms or themes from the confounding chunks that are relevant to the question&gt;",</span></span>
<span id="cb15-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    3. "question": "&lt;the question that is directly and unambiguously answered by the fact&gt;",</span></span>
<span id="cb15-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb15-13"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    You should write the questions as if you're an employee looking for information in the handbook. The question should be as realistic and natural as possible, reflecting the kind of queries an employee might actually make when searching for information in the handbook.</span></span>
<span id="cb15-14"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb15-15">)</span>
<span id="cb15-16"></span>
<span id="cb15-17">user_prompt_generate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dedent(</span>
<span id="cb15-18">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb15-19"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    TARGET CHUNK:</span></span>
<span id="cb15-20"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{target_chunk}</span></span>
<span id="cb15-21"></span>
<span id="cb15-22"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    CONFOUNDING CHUNKS:</span></span>
<span id="cb15-23"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{confounding_chunks}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> </span></span>
<span id="cb15-24"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb15-25">)</span></code></pre></div></div>
</div>
<p>These prompts will be used to generate the synthetic data. The <code>system_prompt_generate</code> defines the generation process, explaining how to extract facts and generate questions, and <code>user_prompt_generate</code> provides the required context: target and confounding chunks.</p>
<p>Then, you initialize the LLM, set up the response model, and define a function to format the documents for the LLM:</p>
<div id="f5aab841" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Response(BaseModel):</span>
<span id="cb16-2">    fact: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb16-3">    confounding_terms: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb16-4">    question: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb16-5"></span>
<span id="cb16-6"></span>
<span id="cb16-7">llm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4.1-mini"</span>, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb16-8">llm_with_structured_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> llm.with_structured_output(Response)</span>
<span id="cb16-9"></span>
<span id="cb16-10">messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatPromptTemplate.from_messages(</span>
<span id="cb16-11">    [(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"system"</span>, system_prompt_generate), (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>, user_prompt_generate)]</span>
<span id="cb16-12">)</span>
<span id="cb16-13"></span>
<span id="cb16-14"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> format_docs(chunks: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[RetrievedDoc]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb16-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>.join(</span>
<span id="cb16-16">        [<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"*** Filepath: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>chunk<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>path<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> ***</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>chunk<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>page_content<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> chunk <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> chunks]</span>
<span id="cb16-17">    )</span></code></pre></div></div>
</div>
<p>Finally, you can define a function to generate the synthetic data. This function will take a target chunk, retrieve the most similar chunks from the vector database, and generate a question from the target chunk using the similar chunks as distractors:</p>
<div id="248ec536" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> generate_qa_pair(chunk):</span>
<span id="cb17-2">    similar_chunks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_similar_docs(chunk.page_content)</span>
<span id="cb17-3">    compiled_messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> messages.ainvoke(</span>
<span id="cb17-4">        {</span>
<span id="cb17-5">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"target_chunk"</span>: format_docs([similar_chunks[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]]),</span>
<span id="cb17-6">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"confounding_chunks"</span>: format_docs(similar_chunks[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:]),</span>
<span id="cb17-7">        }</span>
<span id="cb17-8">    )</span>
<span id="cb17-9">    output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> llm_with_structured_output.ainvoke(compiled_messages)</span>
<span id="cb17-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> output</span></code></pre></div></div>
</div>
<p>To speed up question generation, you can run this concurrently using <code>asyncio</code>:</p>
<div id="3f3cf7ae" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1">tasks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [generate_qa_pair(random_split) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> random_split <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> golden_docs]</span>
<span id="cb18-2">qa_pairs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> asyncio.gather(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tasks)</span>
<span id="cb18-3"></span>
<span id="cb18-4">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.DataFrame([qa_pair.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>() <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> qa_pair <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> qa_pairs])</span>
<span id="cb18-5">df.to_excel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../data/synthetic-data-rag/files/qa_pairs.xlsx"</span>, index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span></code></pre></div></div>
</div>
<p>Here are some of the resulting QA pairs:</p>
<ol type="1">
<li>Example 1:
<ul>
<li><strong>Question:</strong> How soon should managers send the results after the 360 feedback cycle closes to prepare for the feedback meeting?</li>
<li><strong>Answer:</strong> Managers should send the results of 360 feedback within 48 hours of the feedback cycle closing so they can prepare and come to the meeting with questions and discussion points.</li>
</ul></li>
<li>Example 2:
<ul>
<li><strong>Question:</strong> At what point in the hiring process must candidates disclose outside employment or side projects for GitLab to assess potential conflicts with their job obligations?</li>
<li><strong>Answer:</strong> Candidates at a certain stage in the recruiting process are asked to disclose outside employment, side projects, or other activities so GitLab can determine if a conflict exists with their ability to fulfill obligations to GitLab.</li>
</ul></li>
</ol>
<p>Even though the questions seem relevant, it’s not entirely clear if they are truly the type of questions real users ask.</p>
<p>To improve that, you can iterate a bit more on the prompt, including few-shot examples of real or adjusted queries. Or, you can take the lazy way out and generate a filter that will help you remove the questions that don’t seem realistic enough. Let’s do that!</p>
</section>
<section id="filter-qa-pairs" class="level2">
<h2 class="anchored" data-anchor-id="filter-qa-pairs">Filter QA pairs</h2>
<p>For that, you should open the Excel file and manually review some of the generated Q&amp;A pairs and evaluate them for relevance. Then, you should provide those questions in a system prompt as examples to the LLM, asking it to assign a score to each question based on your evaluation criteria.</p>
<p>Here’s an example of how to do that:</p>
<div id="3eeec315" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1">system_prompt_rate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dedent(</span>
<span id="cb19-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb19-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    You are an AI assistant helping us curate a high-quality dataset of questions for evaluating an company's internal handbook. We have generated synthetic questions and need to filter out those that are unrealistic or not representative of typical user queries.</span></span>
<span id="cb19-4"></span>
<span id="cb19-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    Here are examples of realistic and unrealistic user queries we have manually rated:</span></span>
<span id="cb19-6"></span>
<span id="cb19-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    ### Realistic Queries (Good Examples)</span></span>
<span id="cb19-8"></span>
<span id="cb19-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    * **Query:** "What is the required process for creating a new learning hub for your team in Level Up at GitLab?"</span></span>
<span id="cb19-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        * **Explanation:** Very realistic user query. It's concise, information-seeking, and process-oriented.</span></span>
<span id="cb19-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        * **Rating:** 5</span></span>
<span id="cb19-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    * **Query:** "Where is the People Operations internal handbook hosted, and how can someone gain access to it?"</span></span>
<span id="cb19-13"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        * **Explanation:** Realistic query but might be a bit too detailed for a typical user.</span></span>
<span id="cb19-14"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        * **Rating:** 4</span></span>
<span id="cb19-15"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    * **Query:** "Who controls access to People Data in the data warehouse at GitLab, and what approvals are required for Analytics Engineers and Data Analysts to obtain access?"</span></span>
<span id="cb19-16"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        * **Explanation:** Seems reasonable but too lengthy for a typical user query. </span></span>
<span id="cb19-17"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        * **Rating:** 3</span></span>
<span id="cb19-18"></span>
<span id="cb19-19"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    ### Unrealistic Queries (Bad Examples)</span></span>
<span id="cb19-20"></span>
<span id="cb19-21"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    * **Query:** "If a GitLab team member has been with the company for over 3 months and is interested in participating in the Onboarding Buddy Program, what should they do to express their interest?"</span></span>
<span id="cb19-22"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        * **Explanation:** Overly specific and unnatural. No real user would ask this.</span></span>
<span id="cb19-23"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        * **Rating:** 1</span></span>
<span id="cb19-24"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    * **Query:** "On what date did the 'Managing Burnout with Time Off with John Fitch' session occur as part of the FY21 Learning Speaker Series?"</span></span>
<span id="cb19-25"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        * **Explanation:** Irrelevant and overly specific. Not a typical user query. </span></span>
<span id="cb19-26"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        * **Rating:** 2</span></span>
<span id="cb19-27"></span>
<span id="cb19-28"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    ### Your Task</span></span>
<span id="cb19-29"></span>
<span id="cb19-30"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    For the following generated question, please:</span></span>
<span id="cb19-31"></span>
<span id="cb19-32"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    1.  Rate its realism as a typical user query for an internal handbook application on a scale of 1 to 5 (1 = Very Unrealistic, 3 = Neutral/Somewhat Realistic, 5 = Very Realistic).</span></span>
<span id="cb19-33"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    2.  Provide a brief explanation for your rating, comparing it to the examples above if helpful.</span></span>
<span id="cb19-34"></span>
<span id="cb19-35"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    ### Output Format</span></span>
<span id="cb19-36"></span>
<span id="cb19-37"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    **Explanation:** `[Your brief explanation]`</span></span>
<span id="cb19-38"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    **Rating:** `[Your 1–5 rating]`</span></span>
<span id="cb19-39"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb19-40">)</span>
<span id="cb19-41"></span>
<span id="cb19-42">user_prompt_rate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dedent(</span>
<span id="cb19-43">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb19-44"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    **Generated Question to Evaluate:**</span></span>
<span id="cb19-45"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    `</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{question_to_evaluate}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span></span>
<span id="cb19-46"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb19-47">)</span></code></pre></div></div>
</div>
<p>Hamel and Shreya generally discourage using Likert-type 1-5 scales for LLM judges. However, in this case, we’re not aiming for a very accurate judge, we’re just trying to have a method that works well enough to filter out the questions. We don’t need to make this overly complicated.</p>
<p>Using the LLM judge, you can apply the filter to the generated questions:</p>
<div id="dd0929e4" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb20-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> ResponseFiltering(BaseModel):</span>
<span id="cb20-2">    explanation: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb20-3">    rating: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span></span>
<span id="cb20-4"></span>
<span id="cb20-5"></span>
<span id="cb20-6">llm_with_structured_output_filtering <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> llm.with_structured_output(ResponseFiltering)</span>
<span id="cb20-7"></span>
<span id="cb20-8">messages_filtering <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatPromptTemplate.from_messages(</span>
<span id="cb20-9">    [(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"system"</span>, system_prompt_rate), (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>, user_prompt_rate)]</span>
<span id="cb20-10">)</span>
<span id="cb20-11"></span>
<span id="cb20-12"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> rate_qa_pair(qa_pair):</span>
<span id="cb20-13">    compiled_messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> messages_filtering.ainvoke(</span>
<span id="cb20-14">        {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question_to_evaluate"</span>: qa_pair.question}</span>
<span id="cb20-15">    )</span>
<span id="cb20-16">    output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> llm_with_structured_output_filtering.ainvoke(compiled_messages)</span>
<span id="cb20-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> output</span>
<span id="cb20-18"></span>
<span id="cb20-19"></span>
<span id="cb20-20">tasks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [rate_qa_pair(qa_pair) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> qa_pair <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> qa_pairs]</span>
<span id="cb20-21">results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> asyncio.gather(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tasks)</span>
<span id="cb20-22"></span>
<span id="cb20-23">rated_qa_pairs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb20-24">    {</span>
<span id="cb20-25">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rating"</span>: result.rating,</span>
<span id="cb20-26">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"explanation"</span>: result.explanation,</span>
<span id="cb20-27">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>: qa_pair.question,</span>
<span id="cb20-28">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"answer"</span>: qa_pair.fact,</span>
<span id="cb20-29">    }</span>
<span id="cb20-30">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (result, qa_pair) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(results, qa_pairs)</span>
<span id="cb20-31">]</span>
<span id="cb20-32"></span>
<span id="cb20-33">df_rated_qa_pairs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.DataFrame(</span>
<span id="cb20-34">    rated_qa_pairs, columns<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Rating"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Explanation"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Question"</span>]</span>
<span id="cb20-35">)</span>
<span id="cb20-36"></span>
<span id="cb20-37">df_rated_qa_pairs.to_excel(</span>
<span id="cb20-38">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../data/synthetic-data-rag/files/rated_qa_pairs.xlsx"</span>, index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span></span>
<span id="cb20-39">)</span></code></pre></div></div>
</div>
<p>This will result in a list of <code>ResponseFiltering</code> objects, each containing an explanation and a rating for the corresponding question.</p>
<p>You can save the results to a file for later use.</p>
</section>
<section id="evaluate-the-rag-system" class="level2">
<h2 class="anchored" data-anchor-id="evaluate-the-rag-system">Evaluate the RAG system</h2>
<p>Now that we have the filtered QA pairs, it’s time to evaluate your RAG system. You’ll evaluate two parts of the RAG system: retrieval and generation.</p>
<p>Let’s use LangSmith to store our evaluation results. Start by creating a dataset on LangSmith:</p>
<div id="cfdfe231" class="cell" data-execution_count="30">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb21-1">langsmith_client <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Client()</span>
<span id="cb21-2">dataset_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gitlab Handbook QA Evaluation 2"</span></span>
<span id="cb21-3"></span>
<span id="cb21-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb21-5">    dataset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> langsmith_client.create_dataset(dataset_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>dataset_name)</span>
<span id="cb21-6">    examples <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb21-7">        {</span>
<span id="cb21-8">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"inputs"</span>: {</span>
<span id="cb21-9">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>: h[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>],</span>
<span id="cb21-10">            },</span>
<span id="cb21-11">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"outputs"</span>: {</span>
<span id="cb21-12">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"answer"</span>: h[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"answer"</span>],</span>
<span id="cb21-13">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc"</span>: {</span>
<span id="cb21-14">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>: chunk.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span>,</span>
<span id="cb21-15">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"path"</span>: chunk.path,</span>
<span id="cb21-16">                },</span>
<span id="cb21-17">            },</span>
<span id="cb21-18">        }</span>
<span id="cb21-19">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> h, chunk <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(rated_qa_pairs, golden_docs)</span>
<span id="cb21-20">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> h[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rating"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span></span>
<span id="cb21-21">    ]</span>
<span id="cb21-22">    langsmith_client.create_examples(dataset_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>dataset.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span>, examples<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>examples)</span>
<span id="cb21-23"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span>:</span>
<span id="cb21-24">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Dataset already exists, skipping creation."</span>)</span>
<span id="cb21-25">    dataset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> langsmith_client.read_dataset(dataset_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>dataset_name)</span></code></pre></div></div>
</div>
<p>This will create a dataset on LangSmith with the rated QA pairs. Each example will include the question, answer, and the document from which the question was generated.</p>
<section id="retrieval-metrics" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-metrics">Retrieval Metrics</h3>
<p>To evaluate the retrieval part of the RAG system, you can use metrics such as recall@k, precision@k, Mean Reciprocal Rank (MRR), and Normalized Discounted Cumulative Gain (NDCG).</p>
<p>For this tutorial, you’ll use two metrics: MRR and recall@k.</p>
<section id="mean-reciprocal-rank-mrr" class="level4">
<h4 class="anchored" data-anchor-id="mean-reciprocal-rank-mrr">Mean Reciprocal Rank (MRR)</h4>
<p>MRR measures how well the RAG system retrieves relevant documents. It calculates the average of the reciprocal ranks of the first relevant document for each query. It essentially measures how quickly the system retrieves the first relevant document for a given query.</p>
<p>Reciprocal Rank (RR) is calculated for a single query. It is the reciprocal of the rank at which the first relevant document is found. For example, if the first relevant item is at position 1, the RR is 1. If it’s at position 3, the RR is <img src="https://latex.codecogs.com/png.latex?1/3">. The formula is:</p>
<p><img src="https://latex.codecogs.com/png.latex?RR%20=%20%5Cfrac%7B1%7D%7Brank%7D"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?rank"> is the position of the first relevant document.</p>
<p>MRR is the average of the Reciprocal Rank scores across all your queries. It provides a single, aggregate measure of retrieval performance. An MRR of 1 means you found the correct document at the first position for every query. The formula is:</p>
<p><img src="https://latex.codecogs.com/png.latex?MRR%20=%20%5Cfrac%7B1%7D%7B%7CQ%7C%7D%20%5Csum_%7Bi=1%7D%5E%7B%7CQ%7C%7D%20%5Cfrac%7B1%7D%7Brank%7D"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?%7CQ%7C"> is the number of queries and <img src="https://latex.codecogs.com/png.latex?rank_i"> is the position of the first relevant document for query <img src="https://latex.codecogs.com/png.latex?i">.</p>
</section>
</section>
<section id="recallk" class="level3">
<h3 class="anchored" data-anchor-id="recallk">Recall@k</h3>
<p>Recall@k measures the proportion of relevant documents retrieved in the top k results. It helps you understand how many relevant documents are retrieved by the RAG system.</p>
<p>For example, if you retrieve 5 documents and 3 of them are relevant, recall@5 is 3/5 = 0.6. The formula is:</p>
<p><img src="https://latex.codecogs.com/png.latex?Recall@k%20=%20%5Cfrac%7B%7C%5Ctext%7Brelevant%20documents%20in%20top%20k%7D%7C%7D%7B%7C%5Ctext%7Btotal%20relevant%20documents%7D%7C%7D"></p>
<p>where the numerator is the number of relevant documents retrieved in the top k results, and the denominator is the total number of relevant documents for the query. To get the overall performance, you average the Recall@k values across all queries.</p>
<p>In our specific case, since we only have one relevant document per query, Recall@k will be 1 if the relevant document is in the top k results, and 0 otherwise.</p>
<p>You can define two LangSmith evaluators to calculate these metrics:</p>
<div id="07239efe" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> mrr(inputs: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>, outputs: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>, reference_outputs: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>:</span>
<span id="cb22-2">    reference_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(reference_outputs[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc"</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>])]</span>
<span id="cb22-3">    docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> outputs.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"docs"</span>, [])</span>
<span id="cb22-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> docs:</span>
<span id="cb22-5">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span></span>
<span id="cb22-6">    rank <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">next</span>((i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(docs) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> reference_docs), <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>)</span>
<span id="cb22-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> rank <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> rank <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span></span>
<span id="cb22-8"></span>
<span id="cb22-9"></span>
<span id="cb22-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> recall(inputs: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>, outputs: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>, reference_outputs: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>:</span>
<span id="cb22-11">    reference_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(reference_outputs[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc"</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>])]</span>
<span id="cb22-12">    docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> outputs.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"docs"</span>, [])</span>
<span id="cb22-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> docs:</span>
<span id="cb22-14">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span></span>
<span id="cb22-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">any</span>(doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> reference_docs <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> docs))</span></code></pre></div></div>
</div>
<p>LangSmith evaluators take <code>inputs</code>, <code>outputs</code>, and <code>reference_outputs</code> as arguments. The <code>inputs</code> are the user query and the retrieved documents, the <code>outputs</code> are the generated answers, and the <code>reference_outputs</code> are the target chunks.</p>
<p>Using those values, you can use the formulas we discussed to compute the MRR and recall@k metrics.</p>
</section>
<section id="generation-metrics" class="level3">
<h3 class="anchored" data-anchor-id="generation-metrics">Generation metrics</h3>
<p>In addition to measuring how good are the retrieved documents, you also want to measure if the LLM makes good use of them to generate answers. For that, Hamel and Shreya recommend using <a href="https://github.com/stanford-futuredata/ARES">ARES</a> or <a href="https://github.com/explodinggradients/ragas">RAGAS</a>.</p>
<p>The only issue is that ARES requires a human preference validation set of at least 50 examples and the standard RAGAS metrics consume tons of tokens. So, to keep things simple, you’ll build 3 simple metrics using an LLM judge, similar to RAGAS’ <a href="https://docs.ragas.io/en/stable/concepts/metrics/available_metrics/nvidia_metrics/">Nvidia metrics</a>:</p>
<ul>
<li><strong>Answer accuracy</strong>: Measures how accurate the generated answer is compared to the expected answer.</li>
<li><strong>Context relevance</strong>: Measures if the context provided to the LLM is relevant to the user query.</li>
<li><strong>Groundedness</strong>: Measures if the generated answer is grounded in the provided context.</li>
</ul>
<p>Compared to RAGAS implementation of these same metrics, the ones you’ll define here don’t do multiple runs and average the resulting scores. But, if you want to, you can easily apply a <a href="https://dylancastillo.co/posts/agentic-workflows-langgraph.html#parallelization">parallelization strategy</a> to do this. I’d also recommend using reasoning models, as they tend to perform better in these types of tasks.</p>
<p>Let’s see how to implement these metrics using LangSmith.</p>
<section id="answer-accuracy" class="level4">
<h4 class="anchored" data-anchor-id="answer-accuracy">Answer accuracy</h4>
<p>This metric evaluates how accurate the generated answer is compared to the expected answer. It’s an LLM judge that scores the generated answer against a reference answer using a 0, 1, 2 scale:</p>
<div id="07f60491" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb23-1">system_prompt_answer_accuracy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dedent(</span>
<span id="cb23-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb23-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    You are an expert evaluator. Your task is to evaluate the accuracy of a User Answer against a Reference Answer, given a Question.</span></span>
<span id="cb23-4"></span>
<span id="cb23-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    Here's the grading scale you must use:</span></span>
<span id="cb23-6"></span>
<span id="cb23-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    0 - If User Answer is not contained in Reference Answer or not accurate in all terms, topics, numbers, metrics, dates and units or the User Answer do not answer the question.</span></span>
<span id="cb23-8"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    2 - If User Answer is full contained and equivalent to Reference Answer in all terms, topics, numbers, metrics, dates and units.</span></span>
<span id="cb23-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    1 - If User Answer is partially contained and almost equivalent to Reference Answer in all terms, topics, numbers, metrics, dates and units.</span></span>
<span id="cb23-10"></span>
<span id="cb23-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    Your rating must be only 0, 1 or 2 according to the instructions above.</span></span>
<span id="cb23-12"></span>
<span id="cb23-13"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    Your answer must be a JSON object with the following keys:</span></span>
<span id="cb23-14"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    1. "explanation": "&lt;a brief explanation of your rating&gt;",</span></span>
<span id="cb23-15"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    2. "rating": "&lt;your rating, which must be one of the following: 0, 1, 2&gt;"</span></span>
<span id="cb23-16"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb23-17">)</span>
<span id="cb23-18"></span>
<span id="cb23-19">user_prompt_answer_accuracy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dedent(</span>
<span id="cb23-20">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb23-21"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    **Question:** `</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{question}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span></span>
<span id="cb23-22"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    **User Answer:** `</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{user_answer}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span></span>
<span id="cb23-23"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    **Reference Answer:** `</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{reference_answer}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span></span>
<span id="cb23-24"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb23-25">)</span>
<span id="cb23-26"></span>
<span id="cb23-27">messages_answer_accuracy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatPromptTemplate.from_messages(</span>
<span id="cb23-28">    [(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"system"</span>, system_prompt_answer_accuracy), (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>, user_prompt_answer_accuracy)]</span>
<span id="cb23-29">)</span>
<span id="cb23-30"></span>
<span id="cb23-31"></span>
<span id="cb23-32"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> ResponseAnswerAccuracy(BaseModel):</span>
<span id="cb23-33">    explanation: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb23-34">    rating: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span></span>
<span id="cb23-35"></span>
<span id="cb23-36"></span>
<span id="cb23-37">llm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4.1-mini"</span>)</span>
<span id="cb23-38"></span>
<span id="cb23-39">llm_with_structured_output_answer_accuracy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> llm.with_structured_output(</span>
<span id="cb23-40">    ResponseAnswerAccuracy</span>
<span id="cb23-41">)</span>
<span id="cb23-42"></span>
<span id="cb23-43"></span>
<span id="cb23-44"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> answer_accuracy(</span>
<span id="cb23-45">    inputs: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>, outputs: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>, reference_outputs: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span></span>
<span id="cb23-46">) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>:</span>
<span id="cb23-47">    compiled_messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> messages_answer_accuracy.ainvoke(</span>
<span id="cb23-48">        {</span>
<span id="cb23-49">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>: inputs[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>],</span>
<span id="cb23-50">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user_answer"</span>: outputs[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"answer"</span>],</span>
<span id="cb23-51">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"reference_answer"</span>: reference_outputs[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"answer"</span>],</span>
<span id="cb23-52">        }</span>
<span id="cb23-53">    )</span>
<span id="cb23-54">    output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> llm_with_structured_output_answer_accuracy.ainvoke(compiled_messages)</span>
<span id="cb23-55">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> output.rating <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.0</span></span></code></pre></div></div>
</div>
<p>Similar to the retrieval evaluators, you can define LangSmith evaluators for the answer accuracy metric. The <code>inputs</code> will contain the user question, the <code>outputs</code> will have the generated answer, and the <code>reference_outputs</code> will have the expected answer.</p>
</section>
<section id="context-relevance" class="level4">
<h4 class="anchored" data-anchor-id="context-relevance">Context relevance</h4>
<p>This metric evaluates if the context provided to the LLM is relevant to the user query. Similar to the answer accuracy metric, it uses an LLM judge that scores the context relevance against a reference answer using a 0, 1, 2 scale:</p>
<div id="82c8f6b6" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb24-1">system_prompt_context_relevance <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dedent(</span>
<span id="cb24-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb24-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    You are an expert evaluator. Your task is to evaluate the relevance of a Context in order to answer a Question. </span></span>
<span id="cb24-4"></span>
<span id="cb24-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    Do not rely on your previous knowledge about the Question. Use only what is written in the Context and in the Question.</span></span>
<span id="cb24-6"></span>
<span id="cb24-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    Here's the grading scale you must use:</span></span>
<span id="cb24-8"></span>
<span id="cb24-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    0 - If the context does not contain any relevant information to answer the question.</span></span>
<span id="cb24-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    1 - If the context partially contains relevant information to answer the question.</span></span>
<span id="cb24-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    2 - If the context contains relevant information to answer the question.</span></span>
<span id="cb24-12"></span>
<span id="cb24-13"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    You must always provide the relevance score of 0, 1, or 2, nothing else.</span></span>
<span id="cb24-14"></span>
<span id="cb24-15"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    Your answer must be a JSON object with the following keys:</span></span>
<span id="cb24-16"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    1. "explanation": "&lt;a brief explanation of your rating&gt;",</span></span>
<span id="cb24-17"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    2. "rating": "&lt;your rating, which must be one of the following: 0, 1, 2&gt;"</span></span>
<span id="cb24-18"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb24-19">)</span>
<span id="cb24-20"></span>
<span id="cb24-21">user_prompt_context_relevance <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dedent(</span>
<span id="cb24-22">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb24-23"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    **Question:** `</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{question}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span></span>
<span id="cb24-24"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    **Context:** `</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{context}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span></span>
<span id="cb24-25"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb24-26">)</span>
<span id="cb24-27"></span>
<span id="cb24-28">messages_context_relevance <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatPromptTemplate.from_messages(</span>
<span id="cb24-29">    [</span>
<span id="cb24-30">        (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"system"</span>, system_prompt_context_relevance),</span>
<span id="cb24-31">        (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>, user_prompt_context_relevance),</span>
<span id="cb24-32">    ]</span>
<span id="cb24-33">)</span>
<span id="cb24-34"></span>
<span id="cb24-35"></span>
<span id="cb24-36"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> ResponseContextRelevance(BaseModel):</span>
<span id="cb24-37">    explanation: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb24-38">    rating: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span></span>
<span id="cb24-39"></span>
<span id="cb24-40"></span>
<span id="cb24-41">llm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4.1-mini"</span>)</span>
<span id="cb24-42">llm_with_structured_output_context_relevance <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> llm.with_structured_output(</span>
<span id="cb24-43">    ResponseContextRelevance</span>
<span id="cb24-44">)</span>
<span id="cb24-45"></span>
<span id="cb24-46"></span>
<span id="cb24-47"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> context_relevance(</span>
<span id="cb24-48">    inputs: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>, outputs: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>, reference_outputs: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span></span>
<span id="cb24-49">) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>:</span>
<span id="cb24-50">    compiled_messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> messages_context_relevance.ainvoke(</span>
<span id="cb24-51">        {</span>
<span id="cb24-52">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>: inputs[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>],</span>
<span id="cb24-53">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"context"</span>: outputs[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"context"</span>],</span>
<span id="cb24-54">        }</span>
<span id="cb24-55">    )</span>
<span id="cb24-56">    output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> llm_with_structured_output_context_relevance.ainvoke(</span>
<span id="cb24-57">        compiled_messages</span>
<span id="cb24-58">    )</span>
<span id="cb24-59">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> output.rating <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span></code></pre></div></div>
</div>
<p>You can define a <code>context_relevance</code> evaluator. The <code>inputs</code> will contain the user question and from the <code>outputs</code> you’ll use the context provided to the LLM.</p>
</section>
<section id="groundedness" class="level4">
<h4 class="anchored" data-anchor-id="groundedness">Groundedness</h4>
<p>This metric evaluates if the answer is grounded in the provided context. Like before, you use an LLM judge that scores the groundedness of the answer against the context using a 0, 1, 2 scale:</p>
<div id="32cef827" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb25-1">system_prompt_groundedness <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dedent(</span>
<span id="cb25-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb25-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    You are an expert evaluator. Your task is to evaluate the groundedness of an assertion against a context. </span></span>
<span id="cb25-4"></span>
<span id="cb25-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    Do not rely on your previous knowledge about the assertion or context. Use only what is written in the assertion and in the context.</span></span>
<span id="cb25-6"></span>
<span id="cb25-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    Here's the grading scale you must use:</span></span>
<span id="cb25-8"></span>
<span id="cb25-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    0 - If the assertion is not supported by the context. Or, if the context or assertion is empty.</span></span>
<span id="cb25-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    1 - If the context partially contains relevant information to support the assertion.</span></span>
<span id="cb25-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    2 - If the context fully supports the assertion.</span></span>
<span id="cb25-12"></span>
<span id="cb25-13"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    You must always provide the relevance score of 0, 1, or 2, nothing else.</span></span>
<span id="cb25-14"></span>
<span id="cb25-15"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    Your answer must be a JSON object with the following keys:</span></span>
<span id="cb25-16"></span>
<span id="cb25-17"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    1. "explanation": "&lt;a brief explanation of your rating&gt;",</span></span>
<span id="cb25-18"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    2. "rating": "&lt;your rating, which must be one of the following: 0, 1, 2&gt;"</span></span>
<span id="cb25-19"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb25-20">)</span>
<span id="cb25-21"></span>
<span id="cb25-22">user_prompt_groundedness <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dedent(</span>
<span id="cb25-23">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb25-24"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    **Assertion:** `</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{answer}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span></span>
<span id="cb25-25"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    **Context:** `</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{context}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span></span>
<span id="cb25-26"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb25-27">)</span>
<span id="cb25-28"></span>
<span id="cb25-29">messages_groundedness <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatPromptTemplate.from_messages(</span>
<span id="cb25-30">    [(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"system"</span>, system_prompt_groundedness), (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>, user_prompt_groundedness)]</span>
<span id="cb25-31">)</span>
<span id="cb25-32"></span>
<span id="cb25-33"></span>
<span id="cb25-34"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> ResponseGroundedness(BaseModel):</span>
<span id="cb25-35">    explanation: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb25-36">    rating: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span></span>
<span id="cb25-37"></span>
<span id="cb25-38"></span>
<span id="cb25-39">llm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4.1-mini"</span>)</span>
<span id="cb25-40">llm_with_structured_output_groundedness <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> llm.with_structured_output(</span>
<span id="cb25-41">    ResponseGroundedness</span>
<span id="cb25-42">)</span>
<span id="cb25-43"></span>
<span id="cb25-44"></span>
<span id="cb25-45"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> groundedness(inputs: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>, outputs: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>, reference_outputs: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>:</span>
<span id="cb25-46">    compiled_messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> messages_groundedness.ainvoke(</span>
<span id="cb25-47">        {</span>
<span id="cb25-48">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"answer"</span>: outputs[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"answer"</span>],</span>
<span id="cb25-49">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"context"</span>: outputs[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"context"</span>],</span>
<span id="cb25-50">        }</span>
<span id="cb25-51">    )</span>
<span id="cb25-52">    output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> llm_with_structured_output_groundedness.ainvoke(compiled_messages)</span>
<span id="cb25-53">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> output.rating <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span></code></pre></div></div>
</div>
<p>You use the same approach as before to define LangSmith evaluators for this metric. The <code>inputs</code> will contain the user question, the <code>outputs</code> will have the context provided to the LLM.</p>
</section>
</section>
<section id="run-evaluation" class="level3">
<h3 class="anchored" data-anchor-id="run-evaluation">Run evaluation</h3>
<p>Now we can run the full RAG pipeline and evaluate its results using the LangSmith evaluators.</p>
<div id="ddb7581f" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb26-1">system_prompt_generation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dedent(</span>
<span id="cb26-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb26-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    You're a helpful assistant. Provided with a question and the most relevant documents, you must generate a concise and accurate answer based on the information in those documents.</span></span>
<span id="cb26-4"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb26-5">)</span>
<span id="cb26-6"></span>
<span id="cb26-7">user_prompt_generation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dedent(</span>
<span id="cb26-8">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb26-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    QUESTION: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{question}</span></span>
<span id="cb26-10"></span>
<span id="cb26-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    RELEVANT DOCUMENTS:</span></span>
<span id="cb26-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{documents}</span></span>
<span id="cb26-13"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb26-14">)</span>
<span id="cb26-15"></span>
<span id="cb26-16">messages_generation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatPromptTemplate.from_messages(</span>
<span id="cb26-17">    [(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"system"</span>, system_prompt_generation), (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>, user_prompt_generation)]</span>
<span id="cb26-18">)</span>
<span id="cb26-19"></span>
<span id="cb26-20">llm_generation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(</span>
<span id="cb26-21">    model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4o-mini"</span>,</span>
<span id="cb26-22">)</span></code></pre></div></div>
</div>
<p>A good starting point is to evaluate different values for the number of retrieved documents (K). For example, you could evaluate different values for the number of retrieved documents.</p>
<p>Langsmith requires a wrapper or target function that encapsulates your RAG system. In your case, this function takes a user query, retrieves the most similar documents, generates an answer using the LLM, and returns the generated answer with the document IDs and context retrieved.</p>
<p>I’ll run this code for K values of 3, 5, and 10, and compare the results.</p>
<div id="9c0ddd40" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb27-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> K <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]:</span>
<span id="cb27-2">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Running evaluation for K=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>K<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb27-3"></span>
<span id="cb27-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@traceable</span></span>
<span id="cb27-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> target(inputs: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>:</span>
<span id="cb27-6">        relevant_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_similar_docs(inputs[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>], top_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>K)</span>
<span id="cb27-7">        formatted_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> format_docs(relevant_docs)</span>
<span id="cb27-8">        messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> messages_generation.ainvoke(</span>
<span id="cb27-9">            {</span>
<span id="cb27-10">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>: inputs[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>],</span>
<span id="cb27-11">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"documents"</span>: formatted_docs,</span>
<span id="cb27-12">            }</span>
<span id="cb27-13">        )</span>
<span id="cb27-14">        response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> llm_generation.ainvoke(messages)</span>
<span id="cb27-15">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {</span>
<span id="cb27-16">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"answer"</span>: response.content,</span>
<span id="cb27-17">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"docs"</span>: [doc.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> relevant_docs],</span>
<span id="cb27-18">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"context"</span>: formatted_docs,</span>
<span id="cb27-19">        }</span>
<span id="cb27-20"></span>
<span id="cb27-21">    experiment_results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> langsmith_client.aevaluate(</span>
<span id="cb27-22">        target,</span>
<span id="cb27-23">        data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>dataset_name,</span>
<span id="cb27-24">        evaluators<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[recall, mrr, answer_accuracy, context_relevance, groundedness],</span>
<span id="cb27-25">        max_concurrency<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>,</span>
<span id="cb27-26">        experiment_prefix<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"top-</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>K<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb27-27">    )</span></code></pre></div></div>
</div>
<p>Using <code>aevaluate</code> you can speed up the evaluation process and run the evaluations concurrently. I got the following results:</p>
<table class="table">
<colgroup>
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;"><strong>k</strong></th>
<th style="text-align: center;"><strong>Answer accuracy</strong></th>
<th style="text-align: center;"><strong>Context relevance</strong></th>
<th style="text-align: center;"><strong>Groundedness</strong></th>
<th style="text-align: center;"><strong>MRR</strong></th>
<th style="text-align: center;"><strong>Recall</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><strong>3</strong></td>
<td style="text-align: center;">0.81</td>
<td style="text-align: center;">0.93</td>
<td style="text-align: center;">0.97</td>
<td style="text-align: center;">0.75</td>
<td style="text-align: center;">0.80</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>5</strong></td>
<td style="text-align: center;">0.80</td>
<td style="text-align: center;">0.94</td>
<td style="text-align: center;">0.97</td>
<td style="text-align: center;">0.76</td>
<td style="text-align: center;">0.85</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>10</strong></td>
<td style="text-align: center;">0.85</td>
<td style="text-align: center;">0.97</td>
<td style="text-align: center;">0.98</td>
<td style="text-align: center;">0.77</td>
<td style="text-align: center;">0.91</td>
</tr>
</tbody>
</table>
<p>You can see that recall improves significantly as you increase the number of retrieved documents, which is expected. Answer accuracy and context relevance only seems to improve significantly when you increase the number of retrieved documents from 5 to 10.</p>
<p>If you got here, you’ve successfully built a RAG system and evaluated it using synthetic data. The next steps would be to continue making changes to parts of the pipeline and re-running the evaluations to see how they affect the performance of your RAG system.</p>
<p>You will also want to improve the quality of the generated questions, and ideally include real user queries in the evaluation process.</p>
<p>Next, I’ll show you how to squeeze a bit more performance from the retrieval part of the RAG system by using a reranker.</p>
</section>
</section>
<section id="improve-metrics-with-a-reranker" class="level2">
<h2 class="anchored" data-anchor-id="improve-metrics-with-a-reranker">Improve metrics with a reranker</h2>
<p>A quick way to improve your RAG system is to rerank the retrieved documents. In addition to doing retrieval using vector similarity or keyword search, you can have a reranking step that uses a more capable model to score and reorder the retrieved documents based on their relevance to the user query.</p>
<p>Let’s use <code>sentence-transformers</code> with an open-source model to do this:</p>
<div id="3ef76069" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb28-1">cross_encoder <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> CrossEncoder(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mixedbread-ai/mxbai-rerank-xsmall-v1"</span>)</span></code></pre></div></div>
</div>
<p>To rerank a set of documents, you take the results from the retrieval step and pass them to the reranker, which will return a new set of documents ordered by their relevance to the user query.</p>
<p>Here’s an example:</p>
<div id="481b2e0b" class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb29-1">query <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What is the process for creating a new learning hub for your team in Level Up at GitLab?"</span></span>
<span id="cb29-2">hits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_similar_docs(query, top_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)</span>
<span id="cb29-3">cross_inp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [[query, h.page_content] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> h <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> hits]</span>
<span id="cb29-4">reranker_scores <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cross_encoder.predict(cross_inp)</span>
<span id="cb29-5">sorted_hits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>(hits, key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x: reranker_scores[hits.index(x)], reverse<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div></div>
</div>
<p>This takes the 50 most similar documents to the query and reranks them using a cross-encoder model. The <code>reranker_scores</code> are used to sort the documents in descending order of relevance.</p>
<p>Now you can do the same evaluation as before (for k = 5), but including this new reranking step:</p>
<div id="3411cd58" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb30-1">K <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span></span>
<span id="cb30-2"></span>
<span id="cb30-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_reranked_docs(</span>
<span id="cb30-4">    query: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, similar_docs: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[RetrievedDoc]</span>
<span id="cb30-5">) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[RetrievedDoc]:</span>
<span id="cb30-6">    cross_inp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [[query, doc.page_content] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> similar_docs]</span>
<span id="cb30-7">    reranker_scores <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cross_encoder.predict(cross_inp)</span>
<span id="cb30-8">    sorted_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>(</span>
<span id="cb30-9">        similar_docs, key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x: reranker_scores[similar_docs.index(x)], reverse<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb30-10">    )</span>
<span id="cb30-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> sorted_docs</span>
<span id="cb30-12"></span>
<span id="cb30-13"></span>
<span id="cb30-14"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@traceable</span></span>
<span id="cb30-15"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> target_with_reranking(inputs: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>:</span>
<span id="cb30-16">    relevant_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_similar_docs(inputs[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>], top_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">75</span>)</span>
<span id="cb30-17">    reranked_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_reranked_docs(inputs[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>], relevant_docs)[:K]</span>
<span id="cb30-18">    formatted_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> format_docs(reranked_docs)</span>
<span id="cb30-19">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> messages_generation.ainvoke(</span>
<span id="cb30-20">        {</span>
<span id="cb30-21">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>: inputs[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>],</span>
<span id="cb30-22">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"documents"</span>: formatted_docs,</span>
<span id="cb30-23">        }</span>
<span id="cb30-24">    )</span>
<span id="cb30-25">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> llm.ainvoke(messages)</span>
<span id="cb30-26">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {</span>
<span id="cb30-27">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"answer"</span>: response,</span>
<span id="cb30-28">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"docs"</span>: [doc.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> reranked_docs],</span>
<span id="cb30-29">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"context"</span>: formatted_docs,</span>
<span id="cb30-30">    }</span>
<span id="cb30-31"></span>
<span id="cb30-32">experiment_results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> langsmith_client.aevaluate(</span>
<span id="cb30-33">    target_with_reranking,</span>
<span id="cb30-34">    data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>dataset_name,</span>
<span id="cb30-35">    evaluators<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[recall, mrr, answer_accuracy, context_relevance, groundedness],</span>
<span id="cb30-36">    max_concurrency<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>,</span>
<span id="cb30-37">    experiment_prefix<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"top-</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>K<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">-reranked"</span>,</span>
<span id="cb30-38">)</span></code></pre></div></div>
</div>
<p>Here are the results of the original run with k=5 and the run with a reranker:</p>
<table class="table">
<colgroup>
<col style="width: 10%">
<col style="width: 17%">
<col style="width: 17%">
<col style="width: 17%">
<col style="width: 17%">
<col style="width: 17%">
</colgroup>
<thead>
<tr class="header">
<th><strong>experiment</strong></th>
<th style="text-align: center;"><strong>answer_accuracy</strong></th>
<th style="text-align: center;"><strong>context_relevance</strong></th>
<th style="text-align: center;"><strong>groundedness</strong></th>
<th style="text-align: center;"><strong>mrr</strong></th>
<th style="text-align: center;"><strong>recall</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>k=5, vanilla</strong></td>
<td style="text-align: center;">0.80</td>
<td style="text-align: center;">0.94</td>
<td style="text-align: center;">0.97</td>
<td style="text-align: center;">0.76</td>
<td style="text-align: center;">0.85</td>
</tr>
<tr class="even">
<td><strong>k=5, rerank</strong></td>
<td style="text-align: center;">0.97</td>
<td style="text-align: center;">0.97</td>
<td style="text-align: center;">1.00</td>
<td style="text-align: center;">0.79</td>
<td style="text-align: center;">0.91</td>
</tr>
</tbody>
</table>
<p>You can see that it immediately improves most metrics, especially the answer accuracy and recall. You should expect some variance in the results, so be aware that the change is not necessarily as big as it seems (but that’s a topic for another article!).</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>In this tutorial, you’ve learned how to use synthetic data to bootstrap your RAG system evaluations. We covered:</p>
<ul>
<li><strong>Synthetic data generation</strong>: How to generate QA pairs from your documents using adversarial techniques with confounding chunks</li>
<li><strong>Evaluation metrics</strong>: Both retrieval metrics (MRR, Recall@k) and generation metrics (answer accuracy, context relevance, groundedness)</li>
<li><strong>Filtering synthetic data</strong>: Using an LLM judge to filter out unrealistic questions and improve the dataset quality</li>
<li><strong>Performance optimization</strong>: How reranking can significantly improve both retrieval and generation metrics</li>
</ul>
<p>This approach gives you a solid foundation for evaluating RAG systems even when you don’t have real user data. Synthetic data is useful for getting started quickly, but remember that you should incorporate real user queries into your evaluation process, as that is the most realistic way to evaluate your RAG system.</p>
<p>Hope you find this tutorial useful. If you have any questions, leave a comment below.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2025,
  author = {Castillo, Dylan},
  title = {Using Synthetic Data to Bootstrap Your {RAG} System Evals},
  date = {2025-08-07},
  url = {https://dylancastillo.co/posts/synthetic-data-rag.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2025" class="csl-entry quarto-appendix-citeas">
Castillo, Dylan. 2025. <span>“Using Synthetic Data to Bootstrap Your RAG
System Evals.”</span> August 7, 2025. <a href="https://dylancastillo.co/posts/synthetic-data-rag.html">https://dylancastillo.co/posts/synthetic-data-rag.html</a>.
</div></div></section></div> ]]></description>
  <category>llm</category>
  <category>python</category>
  <category>rag</category>
  <category>openai</category>
  <guid>https://dylancastillo.co/posts/synthetic-data-rag.html</guid>
  <pubDate>Thu, 07 Aug 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Evaluator-optimizer workflow with Pydantic AI</title>
  <dc:creator>Dylan Castillo</dc:creator>
  <link>https://dylancastillo.co/til/evaluator-optimizer-pydantic-ai.html</link>
  <description><![CDATA[ 




<p>I’m doing a deep dive into Pydantic AI, so I’ve been re-implementing typical patterns for building <a href="https://dylancastillo.co/til/react-agent-pydantic-ai.html">agentic</a> <a href="https://dylancastillo.co/posts/agentic-workflows-langgraph.html">systems</a>.</p>
<p>In this post, I’ll explore how to build a <a href="https://www.anthropic.com/engineering/building-effective-agents#workflow-evaluator-optimizer">evaluator-optimizer</a> workflow. I won’t cover the basics of agentic workflows, so if you’re not familiar with the concept, I recommend you to read <a href="https://dylancastillo.co/posts/agentic-workflows-langgraph.html">this post</a> first.</p>
<section id="what-is-evaluator-optimizer" class="level2">
<h2 class="anchored" data-anchor-id="what-is-evaluator-optimizer">What is evaluator-optimizer?</h2>
<p>Evaluator-optimizer is a pattern that has an LLM generator and an LLM evaluator. The generator generates a solution and the evaluator evaluates if the solution is good enough. If it’s not, the generator is given feedback and it generates a new solution. This process is repeated until the solution is good enough.</p>
<p>It looks like this:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart LR
    In([In]) --&gt; Gen["Generator (LLM)"]
    Gen -- "Solution" --&gt; Eval["Evaluator (LLM)"]
    Eval -- "Accepted" --&gt; Out([Out])
    Eval -- "Rejected + Feedback" --&gt; Gen

</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p><strong>Examples:</strong></p>
<ul>
<li>Content generation that must match certain guidelines such as writing with a particular style.</li>
<li>Improving search results iteratively</li>
</ul>
<p>Let’s see how this looks in practice.</p>
</section>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<p>I will implement a simple workflow:</p>
<ol type="1">
<li>Generate a candidate article</li>
<li>Evaluate if the article is good enough</li>
<li>If it’s not, provide feedback and generate a new article</li>
<li>Repeat until the article is good enough</li>
</ol>
<p>Before we start, because Pydantic AI uses <code>asyncio</code> under the hood, you need to enable <code>nest_asyncio</code> to use it in a notebook:</p>
<div id="2a607486" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> nest_asyncio</span>
<span id="cb1-2"></span>
<span id="cb1-3">nest_asyncio.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>()</span></code></pre></div></div>
</div>
<p>Then, you need to import the required libraries. I’m using <strong><a href="https://logfire.pydantic.dev/">Logfire</a></strong> to monitor the workflow.</p>
<div id="4081c493" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb2-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Literal</span>
<span id="cb2-3"></span>
<span id="cb2-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> logfire</span>
<span id="cb2-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> requests</span>
<span id="cb2-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb2-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pydantic_ai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Agent, RunContext</span>
<span id="cb2-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pydantic <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> BaseModel, Field</span>
<span id="cb2-9"></span>
<span id="cb2-10">load_dotenv()</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>True</code></pre>
</div>
</div>
<p><strong>PydanticAI</strong> is compatible with OpenTelemetry (OTel). So it’s pretty easy to use it with Logfire or with any other OTel-compatible observability tool (e.g., <a href="https://langfuse.com/">Langfuse</a>).</p>
<p>To enable tracking, create a project in Logfire, generate a <code>Write token</code> and add it to the <code>.env</code> file. Then, you just need to run:</p>
<div id="014a1f88" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1">logfire.configure(</span>
<span id="cb4-2">    token<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>os.getenv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'LOGFIRE_TOKEN'</span>),</span>
<span id="cb4-3">)</span>
<span id="cb4-4">logfire.instrument_pydantic_ai()</span></code></pre></div></div>
</div>
<p>The first time you run this, it will ask you to create a project in Logfire. From it, it will generate a <code>logfire_credentials.json</code> file in your working directory. In following runs, it will automatically use the credentials from the file.</p>
</section>
<section id="evaluator-optimizer-workflow" class="level2">
<h2 class="anchored" data-anchor-id="evaluator-optimizer-workflow">Evaluator-optimizer workflow</h2>
<p>The workflow is composed of two steps:</p>
<ul>
<li><code>Text generator</code>: Generates a candidate article.</li>
<li><code>Evaluator</code>: Evaluates if the article is good enough.</li>
</ul>
<p>I’ll split the text generation into two agents: <code>generator</code> and <code>fixer</code>. The <code>generator</code> will generate a candidate article and the <code>fixer</code> will fix the article, when provided with feedback.</p>
<div id="18ec377f" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1">generator <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Agent(</span>
<span id="cb5-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'openai:gpt-4.1-mini'</span>,</span>
<span id="cb5-3">    system_prompt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(</span>
<span id="cb5-4">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer. Provided with a topic, you will generate an engaging article with less than 500 words"</span></span>
<span id="cb5-5">    ),</span>
<span id="cb5-6">)</span>
<span id="cb5-7"></span>
<span id="cb5-8">fixer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Agent(</span>
<span id="cb5-9">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'openai:gpt-4.1-mini'</span>,</span>
<span id="cb5-10">    system_prompt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(</span>
<span id="cb5-11">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer. Provided with a text and feedback, you wil improve the text."</span></span>
<span id="cb5-12">    ),</span>
<span id="cb5-13">)</span></code></pre></div></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">Logfire</span> project URL: <a href="https://logfire-us.pydantic.dev/dylanjcastillo/blog" target="_blank"><span style="color: #008080; text-decoration-color: #008080; text-decoration: underline">https://logfire-us.pydantic.dev/dylanjcastillo/blog</span></a>
</pre>
</div>
</div>
<p>Next, I’ll create the <code>Evaluator</code> agent. It will take a text and it will evaluate if it’s good enough. It’ll produce an <code>Evaluation</code> object as the output.</p>
<div id="2dd08409" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Evaluation(BaseModel):</span>
<span id="cb6-2">    explanation: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(</span>
<span id="cb6-3">        description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Explain why the text evaluated matches or not the evaluation criteria"</span></span>
<span id="cb6-4">    )</span>
<span id="cb6-5">    feedback: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(</span>
<span id="cb6-6">        description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Provide feedback to the writer to improve the text"</span></span>
<span id="cb6-7">    )</span>
<span id="cb6-8">    is_correct: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(</span>
<span id="cb6-9">        description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Whether the text evaluated matches or not the evaluation criteria"</span></span>
<span id="cb6-10">    )</span>
<span id="cb6-11"></span>
<span id="cb6-12">evaluator <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Agent(</span>
<span id="cb6-13">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'openai:gpt-4.1-mini'</span>,</span>
<span id="cb6-14">    system_prompt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(</span>
<span id="cb6-15">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert evaluator. Provided with a text, you will evaluate if it's written in British English and if it's appropriate for a young audience. The text must always use British spelling and grammar. Make sure the text doesn't include any em dashes."</span></span>
<span id="cb6-16">    ),</span>
<span id="cb6-17">    output_type<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>Evaluation,</span>
<span id="cb6-18">)</span></code></pre></div></div>
</div>
<p>Finally, you can encapsulate all the logic in a single function:</p>
<div id="97be7efe" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@logfire.instrument</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Run workflow"</span>)</span>
<span id="cb7-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> run_workflow(topic: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb7-3">    text <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> generator.run_sync(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Generate an article about '</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>topic<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'"</span>)</span>
<span id="cb7-4">    evaluation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> evaluator.run_sync(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Evaluate the following text: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>text<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>output<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb7-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>):</span>
<span id="cb7-6">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> evaluation.output.is_correct:</span>
<span id="cb7-7">            text <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fixer.run_sync(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Fix the text: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>text<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>output<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> with the following feedback: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>evaluation<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>output<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>feedback<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb7-8">            evaluation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> evaluator.run_sync(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Evaluate the following text: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>text<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>output<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb7-9">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb7-10">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> text.output</span>
<span id="cb7-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> text.output</span>
<span id="cb7-12"></span>
<span id="cb7-13">output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> run_workflow(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Consumption of hard drugs"</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>11:28:25.995 Run workflow
11:28:25.995   generator run
11:28:25.996     chat gpt-4.1-mini
11:28:36.293   evaluator run
11:28:36.294     chat gpt-4.1-mini</code></pre>
</div>
</div>
<p>And here’s the output:</p>
<div id="1ee5bd83" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(output)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>**The Complex Reality of Hard Drug Consumption**

Hard drugs — substances such as heroin, cocaine, methamphetamines, and crack — have long been a subject of concern worldwide due to their profound impact on individuals and society. The consumption of these drugs is not merely a matter of personal choice but a complex issue influenced by social, economic, psychological, and cultural factors.

**Understanding Hard Drugs and Their Effects**

Hard drugs are characterized by their high potential for addiction and severe physical and psychological effects. Unlike softer substances such as marijuana or alcohol (when consumed responsibly), hard drugs often disrupt brain function dramatically, leading to addiction, mental health disorders, and significant physical health problems. Users may experience paranoia, hallucinations, heart issues, and even fatal overdoses.

The allure of hard drugs often stems from their ability to produce intense euphoria or numb emotional pain temporarily. However, this fleeting escape comes at a steep cost. Dependence quickly sets in, making cessation incredibly difficult and often trapping users in a cycle of abuse.

**Social and Economic Implications**

The ramifications of hard drug consumption ripple beyond the individual. Families endure emotional and financial strain, communities face increased crime rates and reduced public safety, and healthcare systems are burdened with treating overdoses and long-term complications. Moreover, productivity declines as addiction interferes with employment, contributing to broader economic challenges.

Many users come from marginalized backgrounds, where poverty, trauma, and lack of education or opportunity make drugs seem like a refuge or an escape. This correlation highlights that addressing drug consumption isn't only a matter of law enforcement but of social equity and support.

**Challenges in Addressing Hard Drug Use**

Efforts to reduce hard drug consumption have varied widely, from strict punitive measures to harm reduction strategies. While criminalization seeks to deter use, it often leads to overcrowded prisons and can exacerbate social stigma, making it harder for users to seek help. Conversely, approaches like supervised consumption sites, needle exchange programs, and accessible addiction treatment aim to minimize harm and promote recovery.

Prevention and education are critical components. Informing communities about the risks of hard drugs and providing mental health support can reduce initial experimentation and help those at risk before addiction takes hold.

**Moving Towards Compassionate Solutions**

Ultimately, the consumption of hard drugs is a multifaceted issue requiring balanced and compassionate responses. Policymakers, healthcare providers, and communities must work together to create environments that prioritize treatment over punishment, recognize addiction as a health issue, and promote social support.

By understanding the complex realities behind hard drug use, society can better address its consequences and help those affected find a path to recovery and hope.</code></pre>
</div>
</div>
<p>That’s all!</p>
<p>You can access this notebook <a href="https://github.com/dylanjcastillo/blog/tree/main/til/prompt-chaining-pydantic-ai.ipynb">here</a>.</p>
<p>If you have any questions or feedback, please let me know in the comments below.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2025,
  author = {Castillo, Dylan},
  title = {Evaluator-Optimizer Workflow with {Pydantic} {AI}},
  date = {2025-07-09},
  url = {https://dylancastillo.co/til/evaluator-optimizer-pydantic-ai.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2025" class="csl-entry quarto-appendix-citeas">
Castillo, Dylan. 2025. <span>“Evaluator-Optimizer Workflow with Pydantic
AI.”</span> July 9, 2025. <a href="https://dylancastillo.co/til/evaluator-optimizer-pydantic-ai.html">https://dylancastillo.co/til/evaluator-optimizer-pydantic-ai.html</a>.
</div></div></section></div> ]]></description>
  <category>til</category>
  <category>llm</category>
  <category>pydantic-ai</category>
  <category>workflows</category>
  <guid>https://dylancastillo.co/til/evaluator-optimizer-pydantic-ai.html</guid>
  <pubDate>Wed, 09 Jul 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Parallelization and orchestrator-workers workflows with Pydantic AI</title>
  <dc:creator>Dylan Castillo</dc:creator>
  <link>https://dylancastillo.co/til/parallelization-orchestrator-workers-pydantic-ai.html</link>
  <description><![CDATA[ 




<p>I’ve been re-implementing typical patterns for building <a href="https://dylancastillo.co/til/react-agent-pydantic-ai.html">agentic</a> <a href="https://dylancastillo.co/posts/agentic-workflows-langgraph.html">systems</a> with Pydantic AI. In this post, I’ll explore how to build a <a href="https://www.anthropic.com/engineering/building-effective-agents#workflow-parallelization">parallelization</a> and <a href="https://www.anthropic.com/engineering/building-effective-agents#workflow-orchestrator-worker">orchestrator-worker</a> workflow.</p>
<p>In previous TILs, I’ve explored:</p>
<ul>
<li><a href="https://dylancastillo.co/til/prompt-chaining-pydantic-ai.html">Prompt chaining</a></li>
<li><a href="https://dylancastillo.co/til/routing-pydantic-ai.html">Routing</a></li>
<li><a href="https://dylancastillo.co/til/evaluator-optimizer-pydantic-ai.html">Evaluator-optimizer</a></li>
<li><a href="https://dylancastillo.co/til/react-agent-pydantic-ai.html">ReAct agent</a></li>
</ul>
<p>You can download this notebook <a href="https://github.com/dcastillo/blog/blob/main/til/parallelization-orchestrator-workers-pydantic-ai.ipynb">here</a>.</p>
<section id="what-is-parallelization" class="level2">
<h2 class="anchored" data-anchor-id="what-is-parallelization">What is parallelization?</h2>
<p>This workflow is designed for tasks that can be easily divided into independent subtasks. The key trade-off is managing complexity and coordination overhead in exchange for significant speed improvements or diverse perspectives.</p>
<p>It looks like this:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart LR
    In([In]) --&gt; LLM1["LLM Call 1"]
    In --&gt; LLM2["LLM Call 2"]
    In --&gt; LLM3["LLM Call 3"]
    LLM1 --&gt; Aggregator["Aggregator"] 
    LLM2 --&gt; Aggregator["Aggregator"] 
    LLM3 --&gt; Aggregator["Aggregator"] 
    Aggregator --&gt; Out([Out])
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p><strong>Examples:</strong></p>
<ul>
<li>Evaluate multiple independent aspects of a text (safety, quality, relevance)</li>
<li>Process user query and apply guardrails in parallel</li>
<li>Generate multiple response candidates given a query for comparison</li>
</ul>
</section>
<section id="what-is-orchestrator-worker" class="level2">
<h2 class="anchored" data-anchor-id="what-is-orchestrator-worker">What is orchestrator-worker?</h2>
<p>This workflow works well for tasks where you don’t know the required subtasks beforehand. The subtasks are determined by the orchestrator.</p>
<p>Here’s a diagram:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart LR
    In([In]) --&gt; Orch[Orchestrator]

    Orch -.-&gt; LLM1["LLM Call 1"]
    Orch -.-&gt; LLM2["LLM Call 2"]
    Orch -.-&gt; LLM3["LLM Call 3"]

    LLM1 -.-&gt; Synth[Synthesizer]
    LLM2 -.-&gt; Synth
    LLM3 -.-&gt; Synth

    Synth --&gt; Out([Out])

</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p><strong>Examples:</strong></p>
<ul>
<li>Coding tools making changes to multiple files at once</li>
<li>Searching multiple sources and synthesize the results</li>
</ul>
<p>The difference between parallelization and orchestrator-worker is that in parallelization, the subtasks are known beforehand, while in orchestrator-worker, the subtasks are determined by the orchestrator.</p>
</section>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<p>Pydantic AI uses <code>asyncio</code> under the hood, so you’ll need to enable <code>nest_asyncio</code> to run this notebook:</p>
<div id="2a607486" class="cell" data-execution_count="24">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> nest_asyncio</span>
<span id="cb1-2"></span>
<span id="cb1-3">nest_asyncio.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>()</span></code></pre></div></div>
</div>
<p>Then, you need to import the required libraries. I’m using <strong><a href="https://logfire.pydantic.dev/">Logfire</a></strong> to monitor the workflow.</p>
<div id="4081c493" class="cell" data-execution_count="25">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> asyncio</span>
<span id="cb2-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pprint <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pprint</span>
<span id="cb2-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Literal, Optional</span>
<span id="cb2-5"></span>
<span id="cb2-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> logfire</span>
<span id="cb2-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> requests</span>
<span id="cb2-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb2-9"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pydantic <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> BaseModel, Field</span>
<span id="cb2-10"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pydantic_ai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Agent, RunContext</span>
<span id="cb2-11"></span>
<span id="cb2-12">load_dotenv()</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>True</code></pre>
</div>
</div>
<p><strong>PydanticAI</strong> is compatible with OpenTelemetry (OTel). So it’s pretty easy to use it with Logfire or with any other OTel-compatible observability tool (e.g., <a href="https://langfuse.com/">Langfuse</a>).</p>
<p>To enable tracking, create a project in Logfire, generate a <code>Write token</code> and add it to the <code>.env</code> file. Then, you just need to run:</p>
<div id="014a1f88" class="cell" data-execution_count="26">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1">logfire.configure(</span>
<span id="cb4-2">    token<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>os.getenv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LOGFIRE_TOKEN"</span>),</span>
<span id="cb4-3">)</span>
<span id="cb4-4">logfire.instrument_pydantic_ai()</span></code></pre></div></div>
</div>
<p>The first time you run this, it will ask you to create a project in Logfire. From it, it will generate a <code>logfire_credentials.json</code> file in your working directory. In following runs, it will automatically use the credentials from the file.</p>
</section>
<section id="parallelization-example" class="level2">
<h2 class="anchored" data-anchor-id="parallelization-example">Parallelization example</h2>
<p>In this example, I’ll show you how to build a workflow that runs the same evaluator in parallel and then aggregates the results.</p>
<div id="4a49b93b" class="cell" data-execution_count="27">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Evaluation(BaseModel):</span>
<span id="cb5-2">    explanation: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb5-3">    is_appropiate: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span></span>
<span id="cb5-4"></span>
<span id="cb5-5"></span>
<span id="cb5-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> AggregatedResults(BaseModel):</span>
<span id="cb5-7">    summary: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb5-8">    is_appropiate: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span></span></code></pre></div></div>
</div>
<p>Then you can create the agents and encapsulate the logic in a function:</p>
<div id="3db5d8a9" class="cell" data-execution_count="28">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1">evaluator <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Agent(</span>
<span id="cb6-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"openai:gpt-4.1-mini"</span>,</span>
<span id="cb6-3">    output_type<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>Evaluation,</span>
<span id="cb6-4">    system_prompt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(</span>
<span id="cb6-5">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert evaluator. Provided with a text, you will evaluate if it's appropriate for a general audience."</span></span>
<span id="cb6-6">    ),</span>
<span id="cb6-7">)</span>
<span id="cb6-8"></span>
<span id="cb6-9">aggregator <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Agent(</span>
<span id="cb6-10">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"openai:gpt-4.1-mini"</span>,</span>
<span id="cb6-11">    output_type<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>AggregatedResults,</span>
<span id="cb6-12">    system_prompt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(</span>
<span id="cb6-13">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert evaluator. Provided with a list of evaluations, you will summarize them and provide a final evaluation."</span></span>
<span id="cb6-14">    ),</span>
<span id="cb6-15">)</span>
<span id="cb6-16"></span>
<span id="cb6-17"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@logfire.instrument</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Run workflow"</span>)</span>
<span id="cb6-18"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> run_workflow(topic: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb6-19">    tasks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [evaluator.run(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Evaluate the following text: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>topic<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)]</span>
<span id="cb6-20">    evaluations <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> asyncio.gather(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tasks)</span>
<span id="cb6-21">    aggregated_results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> aggregator.run(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Summarize the following evaluations:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>[(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">eval</span>.output.explanation, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">eval</span>.output.is_appropiate) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">eval</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> evaluations]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb6-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> aggregated_results.output</span>
<span id="cb6-23"></span>
<span id="cb6-24">output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> run_workflow(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Athletes should consume enhancing drugs to improve their performance."</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>15:28:36.289 Run workflow
15:28:36.290   agent run
15:28:36.290     chat gpt-4.1-mini
15:28:36.291   agent run
15:28:36.291     chat gpt-4.1-mini
15:28:36.292   agent run
15:28:36.292     chat gpt-4.1-mini</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">Logfire</span> project URL: <a href="https://logfire-us.pydantic.dev/dylanjcastillo/blog" target="_blank"><span style="color: #008080; text-decoration-color: #008080; text-decoration: underline">https://logfire-us.pydantic.dev/dylanjcastillo/blog</span></a>
</pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>15:28:39.380   aggregator run
15:28:39.380     chat gpt-4.1-mini</code></pre>
</div>
</div>
<p>Finally, you can run the workflow. You should get an output like this:</p>
<div id="48f317fe" class="cell" data-execution_count="29">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1">pprint(output.model_dump())</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'is_appropiate': False,
 'summary': 'All evaluations agree that the text promotes the consumption of '
            'performance-enhancing drugs by athletes, which is a sensitive and '
            'controversial topic. The main concerns highlighted are health '
            'risks, ethical issues, fairness in sports, and legality. The '
            'evaluations consistently indicate that encouraging or normalizing '
            'the use of such drugs is inappropriate for a general audience as '
            'it may promote illegal, harmful, or unsafe behavior. There is '
            'consensus that the subject should be handled with caution.'}</code></pre>
</div>
</div>
</section>
<section id="orchestrator-workers-example" class="level2">
<h2 class="anchored" data-anchor-id="orchestrator-workers-example">Orchestrator-workers example</h2>
<p>In this example, I’ll show you how to build a workflow that given a topic generates a table of contents, then writes each section of the article by making an individual request to an LLM.</p>
<p>First, you must define the data structures we’ll use for the workflow outputs.</p>
<div id="65b82dff" class="cell" data-execution_count="30">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Section(BaseModel):</span>
<span id="cb11-2">    name: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The name of the section"</span>)</span>
<span id="cb11-3">    description: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The description of the section"</span>)</span>
<span id="cb11-4"></span>
<span id="cb11-5"></span>
<span id="cb11-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> CompletedSection(BaseModel):</span>
<span id="cb11-7">    name: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The name of the section"</span>)</span>
<span id="cb11-8">    content: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The content of the section"</span>)</span>
<span id="cb11-9"></span>
<span id="cb11-10"></span>
<span id="cb11-11"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Sections(BaseModel):</span>
<span id="cb11-12">    sections: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[Section] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The sections of the article"</span>)</span></code></pre></div></div>
</div>
<p>Then, we’ll define the agents we’ll use in the workflow.</p>
<div id="797497f4" class="cell" data-execution_count="31">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1">orchestrator <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Agent(</span>
<span id="cb12-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"openai:gpt-4.1-mini"</span>,</span>
<span id="cb12-3">    output_type<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>Sections,</span>
<span id="cb12-4">    system_prompt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(</span>
<span id="cb12-5">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer specialized in SEO. Provided with a topic, you will generate the sections for a short article."</span></span>
<span id="cb12-6">    ),</span>
<span id="cb12-7">)</span>
<span id="cb12-8"></span>
<span id="cb12-9">worker <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Agent(</span>
<span id="cb12-10">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"openai:gpt-4.1-mini"</span>,</span>
<span id="cb12-11">    output_type<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>CompletedSection,</span>
<span id="cb12-12">    system_prompt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(</span>
<span id="cb12-13">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer specialized in SEO. Provided with a topic and a section, you will generate the content of the section."</span></span>
<span id="cb12-14">    ),</span>
<span id="cb12-15">)</span>
<span id="cb12-16"></span>
<span id="cb12-17"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> synthesizer(sections: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[CompletedSection]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb12-18">    completed_sections_str <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>.join(</span>
<span id="cb12-19">        [section.content <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> section <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> sections]</span>
<span id="cb12-20">    )</span>
<span id="cb12-21">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> completed_sections_str</span></code></pre></div></div>
</div>
<p>Then, you can define a function that orchestrates the workflow:</p>
<div id="71597e02" class="cell" data-execution_count="39">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@logfire.instrument</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Run workflow"</span>)</span>
<span id="cb13-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> run_workflow(topic: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb13-3">    orchestrator_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> orchestrator.run(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Generate the sections for a short article about </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>topic<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb13-4">    tasks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [worker.run(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Write the section </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>section<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> about </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>topic<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> with the following description: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>section<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>description<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> section <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> orchestrator_output.output.sections]</span>
<span id="cb13-5">    completed_sections <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> asyncio.gather(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tasks)</span>
<span id="cb13-6">    full_article <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> synthesizer([c.output <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> c <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> completed_sections])</span>
<span id="cb13-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> full_article</span>
<span id="cb13-8"></span>
<span id="cb13-9">output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> run_workflow(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Artificial Intelligence"</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>15:32:13.934 Run workflow
15:32:13.936   orchestrator run
15:32:13.937     chat gpt-4.1-mini
15:32:18.567   agent run
15:32:18.568     chat gpt-4.1-mini
15:32:18.569   agent run
15:32:18.569     chat gpt-4.1-mini
15:32:18.570   agent run
15:32:18.571     chat gpt-4.1-mini
15:32:18.572   agent run
15:32:18.572     chat gpt-4.1-mini
15:32:18.573   agent run
15:32:18.573     chat gpt-4.1-mini</code></pre>
</div>
</div>
<p>That’s all!</p>
<p>If you want to see the full code, you can download the notebook <a href="https://github.com/dcastillo/blog/blob/main/til/parallelization-orchestrator-workers-pydantic-ai.ipynb">here</a>.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2025,
  author = {Castillo, Dylan},
  title = {Parallelization and Orchestrator-Workers Workflows with
    {Pydantic} {AI}},
  date = {2025-07-09},
  url = {https://dylancastillo.co/til/parallelization-orchestrator-workers-pydantic-ai.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2025" class="csl-entry quarto-appendix-citeas">
Castillo, Dylan. 2025. <span>“Parallelization and Orchestrator-Workers
Workflows with Pydantic AI.”</span> July 9, 2025. <a href="https://dylancastillo.co/til/parallelization-orchestrator-workers-pydantic-ai.html">https://dylancastillo.co/til/parallelization-orchestrator-workers-pydantic-ai.html</a>.
</div></div></section></div> ]]></description>
  <category>til</category>
  <category>llm</category>
  <category>pydantic-ai</category>
  <category>workflows</category>
  <guid>https://dylancastillo.co/til/parallelization-orchestrator-workers-pydantic-ai.html</guid>
  <pubDate>Wed, 09 Jul 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Prompt chaining workflow with Pydantic AI</title>
  <dc:creator>Dylan Castillo</dc:creator>
  <link>https://dylancastillo.co/til/prompt-chaining-pydantic-ai.html</link>
  <description><![CDATA[ 




<p>To get more familiar with Pydantic AI, I’ve been re-implementing typical patterns for building <a href="https://dylancastillo.co/til/react-agent-pydantic-ai.html">agentic</a> <a href="https://dylancastillo.co/posts/agentic-workflows-langgraph.html">systems</a>.</p>
<p>In this post, I’ll explore how to build a <a href="https://www.anthropic.com/engineering/building-effective-agents#workflow-prompt-chaining">prompt chaining</a>. I won’t cover the basics of agentic workflows, so if you’re not familiar with the concept, I recommend you to read <a href="https://dylancastillo.co/posts/agentic-workflows-langgraph.html">this post</a> first.</p>
<p>I’ve also written other TILs about Pydantic AI: - <a href="https://dylancastillo.co/til/routing-pydantic-ai.html">Routing</a> - <a href="https://dylancastillo.co/til/evaluator-optimizer-pydantic-ai.html">Evaluator-optimizer</a> - <a href="https://dylancastillo.co/til/react-agent-pydantic-ai.html">ReAct agent</a> - <a href="https://dylancastillo.co/til/parallelization-orchestrator-workers-pydantic-ai.html">Parallelization and Orchestrator-workers</a></p>
<p>You can download this notebook <a href="https://github.com/dcastillo/blog/blob/main/til/prompt-chaining-pydantic-ai.ipynb">here</a>.</p>
<section id="what-is-prompt-chaining" class="level2">
<h2 class="anchored" data-anchor-id="what-is-prompt-chaining">What is prompt chaining?</h2>
<p>Prompt chaining is a workflow pattern that splits a complex task into multiple subtasks. This gives you better results, but at the cost of longer completion times (higher latency).</p>
<p>It looks like this:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart LR
    In --&gt; LLM1["LLM Call 1"]
    LLM1 -- "Output 1" --&gt; Gate{Gate}
    Gate -- Pass --&gt; LLM2["LLM Call 2"]
    Gate -- Fail --&gt; Exit[Exit]
    LLM2 -- "Output 2" --&gt; LLM3["LLM Call 3"]
    LLM3 --&gt; Out
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p><strong>Examples:</strong></p>
<ul>
<li>Generating content in a pipeline by generating table of contents, content, revisions, translations, etc.</li>
<li>Generating a text through a multi-step process to evaluate if it matches certain criteria</li>
</ul>
<p>Let’s get to it!</p>
</section>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<p>I went with a simple example to implement a content generation workflow composed of three steps:</p>
<ol type="1">
<li>Generate a table of contents for the article</li>
<li>Generate the content of the article</li>
<li>Update the content of the article if it’s too long</li>
</ol>
<p>Because Pydantic AI uses <code>asyncio</code> under the hood, you need to enable <code>nest_asyncio</code> to use it in a notebook:</p>
<div id="2a607486" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> nest_asyncio</span>
<span id="cb1-2"></span>
<span id="cb1-3">nest_asyncio.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>()</span></code></pre></div></div>
</div>
<p>Then, you need to import the required libraries. <strong><a href="https://logfire.pydantic.dev/">Logfire</a></strong> is part of the Pydantic ecosystem, so I thought it’d be good to use it for observability.</p>
<div id="4081c493" class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb2-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Literal</span>
<span id="cb2-3"></span>
<span id="cb2-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> logfire</span>
<span id="cb2-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> requests</span>
<span id="cb2-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb2-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pydantic_ai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Agent, RunContext</span>
<span id="cb2-8"></span>
<span id="cb2-9">load_dotenv()</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>True</code></pre>
</div>
</div>
<p><strong>PydanticAI</strong> is compatible with OpenTelemetry (OTel). So it’s pretty easy to use it with Logfire or with any other OTel-compatible observability tool (e.g., <a href="https://langfuse.com/">Langfuse</a>).</p>
<p>To enable tracking, create a project in Logfire, generate a <code>Write token</code> and add it to the <code>.env</code> file. Then, you just need to run:</p>
<div id="014a1f88" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1">logfire.configure(</span>
<span id="cb4-2">    token<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>os.getenv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'LOGFIRE_TOKEN'</span>),</span>
<span id="cb4-3">)</span>
<span id="cb4-4">logfire.instrument_pydantic_ai()</span></code></pre></div></div>
<div class="cell-output cell-output-stderr">
<div class="ansi-escaped-output">
<pre><span class="ansi-bold">Logfire</span> project URL: ]8;id=13458;https://logfire-us.pydantic.dev/dylanjcastillo/blog\<span style="text-decoration:underline" class="ansi-cyan-fg">https://logfire-us.pydantic.dev/dylanjcastillo/blog</span>]8;;\
</pre>
</div>
</div>
</div>
<p>The first time you run this, it will ask you to create a project in Logfire. From it, it will generate a <code>logfire_credentials.json</code> file in your working directory. In following runs, it will automatically use the credentials from the file.</p>
</section>
<section id="prompt-chaining-workflow" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="prompt-chaining-workflow">Prompt chaining workflow</h2>
<p>As mentioned before, the workflow is composed of three steps: generate a table of contents, generate the content of the article and update the content if it’s too long.</p>
<p>So I created three <code>Agent</code> instances. Each one takes care of one of the steps.</p>
<p>Here’s the code:</p>
<div id="97be7efe" class="cell" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1">toc_agent <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Agent(</span>
<span id="cb5-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'openai:gpt-4.1-mini'</span>,</span>
<span id="cb5-3">    system_prompt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(</span>
<span id="cb5-4">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer specialized in SEO. Provided with a topic, you will generate the table of contents for a short article."</span></span>
<span id="cb5-5">    ),</span>
<span id="cb5-6">)</span>
<span id="cb5-7"></span>
<span id="cb5-8">article_agent <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Agent(</span>
<span id="cb5-9">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'openai:gpt-4.1-mini'</span>,</span>
<span id="cb5-10">    system_prompt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(</span>
<span id="cb5-11">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer specialized in SEO. Provided with a topic and a table of contents, you will generate the content of the article."</span></span>
<span id="cb5-12">    ),</span>
<span id="cb5-13">)</span>
<span id="cb5-14"></span>
<span id="cb5-15">editor_agent <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Agent(</span>
<span id="cb5-16">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'openai:gpt-4.1-mini'</span>,</span>
<span id="cb5-17">    system_prompt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(</span>
<span id="cb5-18">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer specialized in SEO. Provided with a topic, a table of contents and a content, you will revise the content of the article to make it less than 1000 characters."</span></span>
<span id="cb5-19">    ),</span>
<span id="cb5-20">)</span>
<span id="cb5-21"></span>
<span id="cb5-22"></span>
<span id="cb5-23"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@logfire.instrument</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Run workflow"</span>)</span>
<span id="cb5-24"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> run_workflow(topic: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb5-25">    toc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> toc_agent.run_sync(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Generate the table of contents of an article about </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>topic<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb5-26">    content <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> article_agent.run_sync(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Generate the content of an article about </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>topic<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> with the following table of contents: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>toc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>output<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb5-27">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(content.output) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>:</span>
<span id="cb5-28">        revised_content <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> editor_agent.run_sync(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Revise the content of an article about </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>topic<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> with the following table of contents: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>toc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>output<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> and the following content: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>content<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>output<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb5-29">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> revised_content.output</span>
<span id="cb5-30">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> content.output</span>
<span id="cb5-31"></span>
<span id="cb5-32">output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> run_workflow(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Artificial Intelligence"</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>18:54:00.987 Run workflow
18:54:00.988   toc_agent run
18:54:00.989     chat gpt-4.1-mini
18:54:02.911   article_agent run
18:54:02.911     chat gpt-4.1-mini
18:54:18.621   editor_agent run
18:54:18.622     chat gpt-4.1-mini</code></pre>
</div>
</div>
<p>This code creates the agents and puts them together in a workflow. I used <code>@logfire.instrument</code> to make sure all the traces related to the workflow are logged within the same span. See example below:</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><a href="./images/prompt-chaining-pydantic-ai.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="Prompt chaining workflow"><img src="https://dylancastillo.co/til/images/prompt-chaining-pydantic-ai.png" class="img-fluid figure-img" alt="Prompt chaining workflow"></a></p>
<figcaption class="margin-caption">Prompt chaining workflow</figcaption>
</figure>
</div>
<p>And here’s the output:</p>
<div id="1ee5bd83" class="cell" data-execution_count="24">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(output)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>Artificial Intelligence (AI) simulates human intelligence in machines capable of learning, problem-solving, and decision-making. Originating as a formal discipline in the 1950s, AI evolved from rule-based systems to advanced machine learning and deep learning, now integral to daily life. AI types include Narrow AI for specific tasks, General AI with human-level cognition, and theoretical Superintelligent AI. Key technologies include machine learning, deep learning, natural language processing, and computer vision. AI transforms sectors like healthcare, finance, transportation, and education by automating tasks and improving decisions. Benefits include increased efficiency and innovation, while challenges involve data privacy, bias, job displacement, and transparency. Future trends highlight explainable AI, edge computing, and human-AI collaboration. Ethical concerns focus on accountability, fairness, and user privacy. Responsible AI development promises a transformative, inclusive future.</code></pre>
</div>
</div>
<p>That’s all!</p>
<p>You can access this notebook <a href="https://github.com/dylanjcastillo/blog/tree/main/til/prompt-chaining-pydantic-ai.ipynb">here</a>.</p>
<p>If you have any questions or feedback, please let me know in the comments below.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2025,
  author = {Castillo, Dylan},
  title = {Prompt Chaining Workflow with {Pydantic} {AI}},
  date = {2025-07-08},
  url = {https://dylancastillo.co/til/prompt-chaining-pydantic-ai.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2025" class="csl-entry quarto-appendix-citeas">
Castillo, Dylan. 2025. <span>“Prompt Chaining Workflow with Pydantic
AI.”</span> July 8, 2025. <a href="https://dylancastillo.co/til/prompt-chaining-pydantic-ai.html">https://dylancastillo.co/til/prompt-chaining-pydantic-ai.html</a>.
</div></div></section></div> ]]></description>
  <category>til</category>
  <category>llm</category>
  <category>pydantic-ai</category>
  <category>workflows</category>
  <guid>https://dylancastillo.co/til/prompt-chaining-pydantic-ai.html</guid>
  <pubDate>Tue, 08 Jul 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Routing workflow with Pydantic AI</title>
  <dc:creator>Dylan Castillo</dc:creator>
  <link>https://dylancastillo.co/til/routing-pydantic-ai.html</link>
  <description><![CDATA[ 




<p>I’m trying to get more familiar with Pydantic AI, so I’ve been re-implementing typical patterns for building <a href="https://dylancastillo.co/til/react-agent-pydantic-ai.html">agentic</a> <a href="https://dylancastillo.co/posts/agentic-workflows-langgraph.html">systems</a>.</p>
<p>In this post, I’ll build a <a href="https://www.anthropic.com/engineering/building-effective-agents#workflow-routing">routing</a> workflow. I won’t cover the basics of agentic workflows, so if you’re not familiar with the concept, I recommend you to read <a href="https://dylancastillo.co/posts/agentic-workflows-langgraph.html">this post</a> first.</p>
<p>I’ve also written other TILs about Pydantic AI:</p>
<ul>
<li><a href="https://dylancastillo.co/til/prompt-chaining-pydantic-ai.html">Prompt chaining</a></li>
<li><a href="https://dylancastillo.co/til/react-agent-pydantic-ai.html">ReAct agent</a></li>
<li><a href="https://dylancastillo.co/til/evaluator-optimizer-pydantic-ai.html">Evaluator-optimizer</a></li>
<li><a href="https://dylancastillo.co/til/parallelization-orchestrator-workers-pydantic-ai.html">Parallelization and Orchestrator-workers</a></li>
</ul>
<p>You can download this notebook <a href="https://github.com/dcastillo/blog/blob/main/til/routing-pydantic-ai.ipynb">here</a>.</p>
<section id="what-is-router" class="level2">
<h2 class="anchored" data-anchor-id="what-is-router">What is router?</h2>
<p>Routing is a workflow pattern that takes the input, classifies it and then sends it to the right place for the best handling. This process can be managed by an LLM or a traditional classification model. It makes sense to use when a system needs to apply different logic to different types of queries.</p>
<p>It looks like this:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart LR 
    In([In]) --&gt; Router["LLM Call Router"]

    Router --&gt;|Route 1| LLM1["LLM Call 1"]
    Router --&gt;|Route 2| LLM2["LLM Call 2"]
    Router --&gt;|Route 3| LLM3["LLM Call 3"]

    LLM1 --&gt; Out([Out])
    LLM2 --&gt; Out
    LLM3 --&gt; Out

</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p><strong>Examples:</strong></p>
<ul>
<li>Classify complexity of question and adjust model depending on it</li>
<li>Classify type of query and use specialized tools (e.g., indexes, prompts)</li>
</ul>
<p>Let’s see how this looks like in code.</p>
</section>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<p>I will implement a workflow that will take a query from a user and will route it to the appropriate agent.</p>
<p>There will be three agents in the workflow:</p>
<ul>
<li><code>Agent TOC</code>: Generate a table of contents for the article</li>
<li><code>Agent Writer</code>: Generate the content of the article</li>
<li><code>Agent Editor</code>: Update the content of the article if it’s too long</li>
</ul>
<p>Because Pydantic AI uses <code>asyncio</code> under the hood, you need to enable <code>nest_asyncio</code> to use it in a notebook:</p>
<div id="2a607486" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> nest_asyncio</span>
<span id="cb1-2"></span>
<span id="cb1-3">nest_asyncio.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>()</span></code></pre></div></div>
</div>
<p>Then, you need to import the required libraries. <strong><a href="https://logfire.pydantic.dev/">Logfire</a></strong> is part of the Pydantic ecosystem, so I thought it’d be good to use it for observability.</p>
<div id="4081c493" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb2-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Literal</span>
<span id="cb2-3"></span>
<span id="cb2-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> logfire</span>
<span id="cb2-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> requests</span>
<span id="cb2-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb2-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pydantic <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> BaseModel</span>
<span id="cb2-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pydantic_ai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Agent, RunContext</span>
<span id="cb2-9"></span>
<span id="cb2-10">load_dotenv()</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<pre><code>True</code></pre>
</div>
</div>
<p><strong>PydanticAI</strong> is compatible with OpenTelemetry (OTel). It’s straightforward to use it with Logfire or with any other OTel-compatible observability tool (e.g., <a href="https://langfuse.com/">Langfuse</a>).</p>
<p>To enable tracking, create a project in Logfire, generate a <code>Write token</code> and add it to the <code>.env</code> file. Then, you just need to run:</p>
<div id="014a1f88" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1">logfire.configure(</span>
<span id="cb4-2">    token<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>os.getenv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LOGFIRE_TOKEN"</span>),</span>
<span id="cb4-3">)</span>
<span id="cb4-4">logfire.instrument_pydantic_ai()</span></code></pre></div></div>
</div>
<p>The first time you run this, it will ask you to create a project in Logfire. From it, it will generate a <code>logfire_credentials.json</code> file in your working directory. In following runs, it will automatically use the credentials from the file.</p>
</section>
<section id="prompt-chaining-workflow" class="level2">
<h2 class="anchored" data-anchor-id="prompt-chaining-workflow">Prompt chaining workflow</h2>
<p>As mentioned before, the workflow will be composed of three agents. So I created three <code>Agent</code> instances. Each one takes care of one of the tasks</p>
<p>Here’s the code:</p>
<div id="4358c272" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> RouterOutput(BaseModel):</span>
<span id="cb5-2">    category: Literal[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"write_article"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_table_of_contents"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"review_article"</span>]</span>
<span id="cb5-3"></span>
<span id="cb5-4"></span>
<span id="cb5-5">router_agent <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Agent(</span>
<span id="cb5-6">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"openai:gpt-4.1-mini"</span>,</span>
<span id="cb5-7">    system_prompt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(</span>
<span id="cb5-8">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are a helpful assistant. You will classify the message into one of the following categories: 'write_article', 'generate_table_of_contents', 'review_article'."</span></span>
<span id="cb5-9">    ),</span>
<span id="cb5-10">    output_type<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>RouterOutput,</span>
<span id="cb5-11">)</span>
<span id="cb5-12"></span>
<span id="cb5-13">agent_writer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Agent(</span>
<span id="cb5-14">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"openai:gpt-4.1-mini"</span>,</span>
<span id="cb5-15">    system_prompt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(</span>
<span id="cb5-16">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are a writer. You will write an article about the topic provided."</span></span>
<span id="cb5-17">    ),</span>
<span id="cb5-18">)</span>
<span id="cb5-19"></span>
<span id="cb5-20">agent_toc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Agent(</span>
<span id="cb5-21">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"openai:gpt-4.1-mini"</span>,</span>
<span id="cb5-22">    system_prompt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(</span>
<span id="cb5-23">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer specialized in SEO. Provided with a topic, you will generate the table of contents for a short article."</span></span>
<span id="cb5-24">    ),</span>
<span id="cb5-25">)</span>
<span id="cb5-26"></span>
<span id="cb5-27">agent_reviewer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Agent(</span>
<span id="cb5-28">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"openai:gpt-4.1-mini"</span>,</span>
<span id="cb5-29">    system_prompt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(</span>
<span id="cb5-30">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are a writer. You will review the article for the topic provided."</span></span>
<span id="cb5-31">    ),</span>
<span id="cb5-32">)</span></code></pre></div></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">Logfire</span> project URL: <a href="https://logfire-us.pydantic.dev/dylanjcastillo/blog" target="_blank"><span style="color: #008080; text-decoration-color: #008080; text-decoration: underline">https://logfire-us.pydantic.dev/dylanjcastillo/blog</span></a>
</pre>
</div>
</div>
<div id="97be7efe" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@logfire.instrument</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Run workflow"</span>)</span>
<span id="cb6-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> run_workflow(topic: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb6-3">    router_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> router_agent.run_sync(</span>
<span id="cb6-4">        <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Classify the message: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>topic<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb6-5">    )</span>
<span id="cb6-6">    category <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> router_output.output.category </span>
<span id="cb6-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> category <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"write_article"</span>:</span>
<span id="cb6-8">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> agent_writer.run_sync(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Write an article about </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>topic<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>).output</span>
<span id="cb6-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> category <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_table_of_contents"</span>:</span>
<span id="cb6-10">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> agent_toc.run_sync(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Generate the table of contents of an article about </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>topic<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>).output</span>
<span id="cb6-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb6-12">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> agent_reviewer.run_sync(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Review the article for the topic </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>topic<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>).output</span></code></pre></div></div>
</div>
<p>You can run the workflow and it will route your message and use the appropriate agent. For example, try to generate a table of contents for an article about AI:</p>
<div id="10fa652a" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1">toc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> run_workflow(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Generate a table of contents for an article about AI"</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>20:08:05.547 Run workflow
20:08:05.548   router_agent run
20:08:05.549     chat gpt-4.1-mini
20:08:06.810   agent_toc run
20:08:06.811     chat gpt-4.1-mini</code></pre>
</div>
</div>
<div id="ff4cb977" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(toc)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>Table of Contents

1. Introduction to Artificial Intelligence  
2. History and Evolution of AI  
3. Types of Artificial Intelligence  
4. Key Technologies Behind AI  
5. Applications of AI in Various Industries  
6. Benefits and Challenges of AI  
7. Future Trends in Artificial Intelligence  
8. Ethical Considerations in AI Development  
9. Conclusion</code></pre>
</div>
</div>
<p>Or, ask the workflow to review a social media post.</p>
<div id="49b09dcf" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1">review <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> run_workflow(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Review this post: 'There are times where there's no time, so you don't have time to write an article about it.'"</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>20:08:08.917 Run workflow
20:08:08.918   router_agent run
20:08:08.919     chat gpt-4.1-mini
20:08:09.691   agent_reviewer run
20:08:09.692     chat gpt-4.1-mini</code></pre>
</div>
</div>
<div id="a039b19c" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(review)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>The post "There are times where there's no time, so you don't have time to write an article about it." offers a succinct reflection on the challenges of time constraints, especially in tasks like writing. Its brevity captures the irony of not having enough time to address a situation—in this case, the lack of time itself. The message resonates with anyone who has felt overwhelmed by deadlines or competing priorities.

However, as a piece intended for a broader audience or a formal article, it could benefit from expansion. Elaborating on scenarios where time scarcity impacts productivity, or providing strategies for managing pressing tasks despite limited time, would add depth and practical value. Additionally, refining the sentence for clarity and flow could enhance its impact—for example: "Sometimes, we're so pressed for time that we can't even write about the very pressure we're under."

In summary, the post effectively conveys a common frustration with time limitations in a clever and relatable way but serves better as a starting point for a more detailed discussion rather than a standalone article.</code></pre>
</div>
</div>
<p>That’s all!</p>
<p>You can access this notebook <a href="https://github.com/dylanjcastillo/blog/tree/main/til/router-pydantic-ai.ipynb">here</a>.</p>
<p>If you have any questions or feedback, please let me know in the comments below.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2025,
  author = {Castillo, Dylan},
  title = {Routing Workflow with {Pydantic} {AI}},
  date = {2025-07-08},
  url = {https://dylancastillo.co/til/routing-pydantic-ai.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2025" class="csl-entry quarto-appendix-citeas">
Castillo, Dylan. 2025. <span>“Routing Workflow with Pydantic AI.”</span>
July 8, 2025. <a href="https://dylancastillo.co/til/routing-pydantic-ai.html">https://dylancastillo.co/til/routing-pydantic-ai.html</a>.
</div></div></section></div> ]]></description>
  <category>til</category>
  <category>llm</category>
  <category>pydantic-ai</category>
  <category>workflows</category>
  <guid>https://dylancastillo.co/til/routing-pydantic-ai.html</guid>
  <pubDate>Tue, 08 Jul 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Building ReAct agents with (and without) LangGraph</title>
  <dc:creator>Dylan Castillo</dc:creator>
  <link>https://dylancastillo.co/posts/react-agent-langgraph.html</link>
  <description><![CDATA[ 




<p>As Large Language Models (LLMs) have become more powerful, I’ve started to see increasing interest from clients in building agents.</p>
<p>The problem is that most of the use cases clients have in mind for agents are better suited for <a href="https://dylancastillo.co/posts/agentic-workflows-langgraph.html">agentic workflows</a>. Agents are a good fit for tasks without a predefined path and where the order of steps is not known beforehand. Agentic workflows, on the other hand, are the right choice for tasks where both of these things are known.</p>
<p>Nonetheless, agents are still a good fit for many use cases, such as coding assistants and support agents. You should definitely spend some time learning about them.</p>
<p>In this post, I’ll show you how to build a Reasoning and Acting (ReAct) agent with (and without) LangGraph.</p>
<p>Let’s start by defining some key concepts.</p>
<section id="what-is-an-agent" class="level2">
<h2 class="anchored" data-anchor-id="what-is-an-agent">What is an agent?</h2>
<p>The biggest players in the ecosystem have converged on similar definitions of what constitutes an “agent.” <a href="https://www.anthropic.com/engineering/building-effective-agents">Anthropic</a> describes them as systems where LLMs “dynamically direct their own processes and tool usage,” while <a href="https://openai.com/index/new-tools-for-building-agents/">OpenAI</a> calls them “systems that independently accomplish tasks on behalf of users.” <a href="https://blog.langchain.com/what-is-an-agent/">LangChain</a> similarly defines them as systems using an LLM to “decide the control flow of an application.”</p>
<p>In essence, agents are systems that can independently make decisions, use tools, take actions, and pursue a goal without direct human guidance. The most well-known agent implementation are <em>ReAct Agents</em>.</p>
</section>
<section id="whats-a-react-agent" class="level2">
<h2 class="anchored" data-anchor-id="whats-a-react-agent">What’s a ReAct agent?</h2>
<p><a href="https://arxiv.org/abs/2210.03629">ReAct (Reasoning and Acting) Agents</a> are AI systems that merge the reasoning of Large Language Models (LLMs) with the ability to perform actions. They follow an iterative “think, act, observe” cycle to solve problems and achieve user goals. For example, a ReAct agent would:</p>
<ol type="1">
<li>Take a user query.</li>
<li>Think about the query and decide on an action.</li>
<li>Execute the action using available tools (environment).</li>
<li>Analyzes the result of that action (environment).</li>
<li>Continues the “Reason, Act, Observe” loop until it reaches the final answer.</li>
</ol>
<p>Here’s a diagram of a ReAct agent:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">graph LR
    Human &lt;--&gt; LLM[LLM]
    LLM --&gt;|Action| Environment
    Environment --&gt;|Feedback| LLM
    LLM -.-&gt; Stop
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p>The first generation of ReAct agents used a prompt technique of “Thought, Action, Observation”. Current agents rely on <a href="https://dylancastillo.co/posts/function-calling-structured-outputs.html">function-calling</a> to implement the “think, act, observe” loop.</p>
</section>
<section id="what-is-langgraph" class="level2">
<h2 class="anchored" data-anchor-id="what-is-langgraph">What is LangGraph?</h2>
<p>LangGraph is a graph-based framework for building complex LLM applications, designed for stateful workflows. It makes it easier to build complex agent architectures.</p>
<p>Graphs are composed of nodes, edges, state, and reducers. Nodes are the units of work (functions, tools) and edges define the paths between nodes. State is persistent data passed between nodes and updated through reducers (functions that define how the state is updated).</p>
<p>I like LangGraph because it provides you with easy-to-use components, a simple API, and it lets you visualize your workflow. It also integrates well with LangSmith, a tool for monitoring and debugging LLM applications.</p>
<p>In this tutorial, I’ll show you how to build a ReAct agent with (and without) LangGraph. I’ll also use <em>LangChain</em> as a thin wrapper on top of OpenAI models.</p>
</section>
<section id="prerequisites" class="level2">
<h2 class="anchored" data-anchor-id="prerequisites">Prerequisites</h2>
<p>To follow this tutorial you’ll need to:</p>
<ol type="1">
<li>Sign up and generate an API key in <a href="https://platform.openai.com/docs/overview">OpenAI</a>.</li>
<li>Set the API key as an environment variable called <code>OPENAI_API_KEY</code>.</li>
<li>Create a virtual environment in Python and install the requirements:</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span> venv venv</span>
<span id="cb1-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">source</span> venv/bin/activate</span>
<span id="cb1-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install langchain langchain-openai langchain-community langgraph jupyter</span></code></pre></div></div>
<p>Once you’ve completed the steps above, you can run the code from this article. You can also download the notebook from <a href="https://github.com/dylanjcastillo/blog/tree/main/posts/react-agent-langgraph.ipynb">here</a>.</p>
</section>
<section id="implementation" class="level2">
<h2 class="anchored" data-anchor-id="implementation">Implementation</h2>
<p>As usual, you must start by importing the necessary libraries and loading the environment variables. You’ll use the same model in all the examples, so you’ll define it once here:</p>
<div id="cell-4" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Literal</span>
<span id="cb2-2"></span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb2-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> IPython.display <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Image, display</span>
<span id="cb2-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.messages <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> HumanMessage, SystemMessage, ToolMessage</span>
<span id="cb2-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.tools <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tool</span>
<span id="cb2-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatOpenAI</span>
<span id="cb2-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langgraph.graph <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> END, START, MessagesState, StateGraph</span>
<span id="cb2-9"></span>
<span id="cb2-10">load_dotenv()</span>
<span id="cb2-11"></span>
<span id="cb2-12">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4.1-mini"</span>, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span></code></pre></div></div>
</div>
<p>This code:</p>
<ol type="1">
<li>Imports the necessary libraries.</li>
<li>Loads environment variables from a <code>.env</code> file using <code>load_dotenv()</code>.</li>
<li>Defines a model (<code>gpt-4.1-mini</code>) that you’ll use in all the examples.</li>
</ol>
<section id="vanilla-react-agent" class="level3">
<h3 class="anchored" data-anchor-id="vanilla-react-agent">Vanilla ReAct agent</h3>
<p>You’ll build an agent that takes a question from a user and has access to a a tool. The tool is a Python REPL that it can use to answer the question.</p>
<p><strong>You should not use this in production</strong>. This tool can run arbitrary Python code on your device, and that’s not something you want to expose to random people on the internet.</p>
<p>First, let’s define the <code>run_python_code</code> tool.</p>
<div id="cell-8" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@tool</span></span>
<span id="cb3-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> run_python_code(code: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb3-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Run arbitrary Python code including imports, assignments, and statements. Do not use any external libraries. Save your results as a variable.</span></span>
<span id="cb3-4"></span>
<span id="cb3-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb3-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        code: Python code to run</span></span>
<span id="cb3-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb3-8">    <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> sys</span>
<span id="cb3-9">    <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> io <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> StringIO</span>
<span id="cb3-10"></span>
<span id="cb3-11">    old_stdout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sys.stdout</span>
<span id="cb3-12">    sys.stdout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> captured_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> StringIO()</span>
<span id="cb3-13"></span>
<span id="cb3-14">    namespace <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb3-15"></span>
<span id="cb3-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb3-17">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">exec</span>(code, namespace)</span>
<span id="cb3-18"></span>
<span id="cb3-19">        output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> captured_output.getvalue()</span>
<span id="cb3-20"></span>
<span id="cb3-21">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> output.strip():</span>
<span id="cb3-22">            user_vars <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb3-23">                k: v</span>
<span id="cb3-24">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> k, v <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> namespace.items()</span>
<span id="cb3-25">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> k.startswith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"__"</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> k <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"StringIO"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sys"</span>]</span>
<span id="cb3-26">            }</span>
<span id="cb3-27">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> user_vars:</span>
<span id="cb3-28">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(user_vars) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:</span>
<span id="cb3-29">                    output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(user_vars.values())[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb3-30">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb3-31">                    output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(user_vars)</span>
<span id="cb3-32"></span>
<span id="cb3-33">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> output.strip() <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> output.strip() <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Code executed successfully"</span></span>
<span id="cb3-34"></span>
<span id="cb3-35">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb3-36">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Error: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(e)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb3-37">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">finally</span>:</span>
<span id="cb3-38">        sys.stdout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> old_stdout</span>
<span id="cb3-39"></span>
<span id="cb3-40"></span>
<span id="cb3-41">tools <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [run_python_code]</span>
<span id="cb3-42">tools_mapping <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {tool.name: tool <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> tool <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tools}</span>
<span id="cb3-43">model_with_tools <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.bind_tools(tools)</span></code></pre></div></div>
</div>
<p>This code defines a tool. In <code>LangChain</code> tools are defined as functions decorated with <code>@tool</code>. These functions must have a <em>docstring</em> because it will be used to describe the tool to the LLM.</p>
<p><code>run_python_code</code> is a function that takes a code string and returns the result of executing that code.</p>
<p>Next, you provide the model with a mapping of the tool to its name by creating <code>tools_mapping</code>. This is often a point of confusion. The LLM doesn’t run the tools on its own. It only decides if a tool should be used. Then, your own code must make the actual tool call.</p>
<p>The mapping is more useful when there are multiple tools, and not a single tool, like in this case. However, I’m showing it here to illustrate how you’d usually do this in a real-world application.</p>
<p>Finally, you <em>bind</em> the tool to the model. The binding makes the model aware of the tool, so that it can use it.</p>
<p>Then, let’s define a function that encapsulates the logic of the agent.</p>
<div id="cell-10" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> run_agent(question: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>):</span>
<span id="cb4-2">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb4-3">        SystemMessage(</span>
<span id="cb4-4">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You're a helpful assistant. Use the tools provided when relevant."</span></span>
<span id="cb4-5">        ),</span>
<span id="cb4-6">        HumanMessage(question),</span>
<span id="cb4-7">    ]</span>
<span id="cb4-8">    ai_message <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model_with_tools.invoke(messages)</span>
<span id="cb4-9">    messages.append(ai_message)</span>
<span id="cb4-10"></span>
<span id="cb4-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">while</span> ai_message.tool_calls:</span>
<span id="cb4-12">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> tool_call <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ai_message.tool_calls:</span>
<span id="cb4-13">            selected_tool <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tools_mapping[tool_call[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>]]</span>
<span id="cb4-14">            tool_msg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> selected_tool.invoke(tool_call)</span>
<span id="cb4-15">            messages.append(tool_msg)</span>
<span id="cb4-16">        ai_message <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model_with_tools.invoke(messages)</span>
<span id="cb4-17">        messages.append(ai_message)</span>
<span id="cb4-18"></span>
<span id="cb4-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> messages</span></code></pre></div></div>
</div>
<p>This function takes a question from a user, comes up with a python script, uses <code>run_python_code</code> to execute it and returns the result.</p>
<p>It works as follows:</p>
<ul>
<li><strong>Lines 2 to 9</strong> set up the <a href="https://dylancastillo.co/posts/prompt-engineering-101.html">prompts</a> and call the assistant.</li>
<li><strong>Lines 11 to 17</strong> is where the magic happens. This is a loop that will check if there’s been a tool call in the response from the model. If there is, it will call (invoke) the tool and add the result to the messages. It will then send the results back to the assistant, and repeat this process until there are no more tool calls.</li>
</ul>
<p>This is the core idea behind how agents work. You provide the assistant with a question and one or more tools. Then you let the assistant decide which tool to use, until it has all the information it needs to answer the question.</p>
<p>You can try it out by running the following code:</p>
<div id="cell-12" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1">messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> run_agent(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Generate 10 random numbers between 1 and 100"</span>)</span>
<span id="cb5-2"></span>
<span id="cb5-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> m <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> messages:</span>
<span id="cb5-4">    m.pretty_print()</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<div class="ansi-escaped-output">
<pre>================================<span class="ansi-bold"> System Message </span>================================



You're a helpful assistant. Use the tools provided when relevant.

================================<span class="ansi-bold"> Human Message </span>=================================



Generate 10 random numbers between 1 and 100

==================================<span class="ansi-bold"> Ai Message </span>==================================

Tool Calls:

  run_python_code (call_twMJ1JkZK81ofm3842P3jNtb)

 Call ID: call_twMJ1JkZK81ofm3842P3jNtb

  Args:

    code: import random

random_numbers = [random.randint(1, 100) for _ in range(10)]

random_numbers

=================================<span class="ansi-bold"> Tool Message </span>=================================

Name: run_python_code



{'random': &lt;module 'random' from '/opt/homebrew/Cellar/python@3.13/3.13.2/Frameworks/Python.framework/Versions/3.13/lib/python3.13/random.py'&gt;, 'random_numbers': [74, 75, 58, 19, 90, 45, 44, 52, 90, 33]}

==================================<span class="ansi-bold"> Ai Message </span>==================================



Here are 10 random numbers between 1 and 100: 74, 75, 58, 19, 90, 45, 44, 52, 90, 33.
</pre>
</div>
</div>
</div>
<p>You can see that the agent took the user’s request, used the <code>run_python_code</code> tool to generate the numbers, and then returned the result.</p>
<p>Now, let’s see how you can build a ReAct agent with LangGraph.</p>
</section>
<section id="langgraph-react-agent" class="level3">
<h3 class="anchored" data-anchor-id="langgraph-react-agent">LangGraph ReAct agent</h3>
<p>Like, in the previous example, you start by defining the tools you want to use. You’ll use the same <code>run_python_code</code> tool.</p>
<div id="cell-16" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@tool</span></span>
<span id="cb6-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> run_python_code(code: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb6-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Run arbitrary Python code including imports, assignments, and statements. Do not use any external libraries. Save your results as a variable.</span></span>
<span id="cb6-4"></span>
<span id="cb6-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb6-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        code: Python code to run</span></span>
<span id="cb6-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb6-8">    <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> sys</span>
<span id="cb6-9">    <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> io <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> StringIO</span>
<span id="cb6-10"></span>
<span id="cb6-11">    old_stdout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sys.stdout</span>
<span id="cb6-12">    sys.stdout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> captured_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> StringIO()</span>
<span id="cb6-13"></span>
<span id="cb6-14">    namespace <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {}</span>
<span id="cb6-15"></span>
<span id="cb6-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb6-17">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">exec</span>(code, namespace)</span>
<span id="cb6-18"></span>
<span id="cb6-19">        output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> captured_output.getvalue()</span>
<span id="cb6-20"></span>
<span id="cb6-21">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> output.strip():</span>
<span id="cb6-22">            user_vars <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb6-23">                k: v</span>
<span id="cb6-24">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> k, v <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> namespace.items()</span>
<span id="cb6-25">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> k.startswith(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"__"</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> k <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"StringIO"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sys"</span>]</span>
<span id="cb6-26">            }</span>
<span id="cb6-27">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> user_vars:</span>
<span id="cb6-28">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(user_vars) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:</span>
<span id="cb6-29">                    output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(user_vars.values())[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb6-30">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb6-31">                    output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(user_vars)</span>
<span id="cb6-32"></span>
<span id="cb6-33">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> output.strip() <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> output.strip() <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Code executed successfully"</span></span>
<span id="cb6-34"></span>
<span id="cb6-35">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> e:</span>
<span id="cb6-36">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Error: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(e)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb6-37">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">finally</span>:</span>
<span id="cb6-38">        sys.stdout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> old_stdout</span>
<span id="cb6-39"></span>
<span id="cb6-40"></span>
<span id="cb6-41">tools <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [run_python_code]</span>
<span id="cb6-42">tools_by_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {tool.name: tool <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> tool <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> tools}</span>
<span id="cb6-43">model_with_tools <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.bind_tools(tools)</span></code></pre></div></div>
</div>
<p>With langgraph you also need to you define the tools in the same way: set up the functions, add <code>@tool</code>, and create the tool mapping. Then, <em>bind</em> the tools to the model.</p>
<p>Next, you need to define the functions (nodes) that correspond to the steps the agent will take:</p>
<div id="cell-18" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> call_llm(state: MessagesState):</span>
<span id="cb7-2">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb7-3">        SystemMessage(content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are a helpful assistant that can run python code."</span>),</span>
<span id="cb7-4">    ] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"messages"</span>]</span>
<span id="cb7-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"messages"</span>: [model_with_tools.invoke(messages)]}</span>
<span id="cb7-6"></span>
<span id="cb7-7"></span>
<span id="cb7-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> call_tool(state: MessagesState):</span>
<span id="cb7-9">    result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb7-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> tool_call <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"messages"</span>][<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].tool_calls:</span>
<span id="cb7-11">        tool <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tools_by_name[tool_call[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>]]</span>
<span id="cb7-12">        observation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tool.invoke(tool_call[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"args"</span>])</span>
<span id="cb7-13">        result.append(ToolMessage(content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>observation, tool_call_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tool_call[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>]))</span>
<span id="cb7-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"messages"</span>: result}</span>
<span id="cb7-15"></span>
<span id="cb7-16"></span>
<span id="cb7-17"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> should_continue(state: MessagesState) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Literal[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"environment"</span>, END]:</span>
<span id="cb7-18">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"messages"</span>]</span>
<span id="cb7-19">    last_message <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> messages[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb7-20">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> last_message.tool_calls:</span>
<span id="cb7-21">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Action"</span></span>
<span id="cb7-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> END</span></code></pre></div></div>
</div>
<p>This is how it works:</p>
<ol type="1">
<li><code>call_llm</code>: Sends the conversation history to the LLM to get the next response.</li>
<li><code>call_tool</code>: If the LLM’s response is a request to use a tool, this function executes the tool with the specified arguments.</li>
<li><code>should_continue</code>: This is the control logic. It checks the LLM’s last message. If it’s a tool request, it routes to the <code>call_tool</code>; otherwise, it ends the conversation.</li>
</ol>
<p><code>call_llm</code> and <code>call_tool</code> take <code>MessagesState</code> as input and return a the message key with the new message. This updates the <code>messages</code> key in the <code>MessagesState</code>. <code>should_continue</code> takes <code>MessagesState</code> act as a router, so it decides if a tool should be executed or if the conversation should end.</p>
<div id="cell-20" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1">agent_builder <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> StateGraph(MessagesState)</span>
<span id="cb8-2"></span>
<span id="cb8-3">agent_builder.add_node(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"llm"</span>, call_llm)</span>
<span id="cb8-4">agent_builder.add_node(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"environment"</span>, call_tool)</span>
<span id="cb8-5"></span>
<span id="cb8-6">agent_builder.add_edge(START, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"llm"</span>)</span>
<span id="cb8-7">agent_builder.add_conditional_edges(</span>
<span id="cb8-8">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"llm"</span>,</span>
<span id="cb8-9">    should_continue,</span>
<span id="cb8-10">    {</span>
<span id="cb8-11">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Action"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"environment"</span>,</span>
<span id="cb8-12">        END: END,</span>
<span id="cb8-13">    },</span>
<span id="cb8-14">)</span>
<span id="cb8-15">agent_builder.add_edge(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"environment"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"llm"</span>)</span>
<span id="cb8-16"></span>
<span id="cb8-17">agent <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> agent_builder.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">compile</span>()</span></code></pre></div></div>
</div>
<p>This code sets up the logic of the agent. It starts with a call to the LLM. The LLM then decides whether to use a tool or to finish the task. If it uses a tool, the tool’s output is sent back to the LLM for the next step. This “think-act” loop continues until the agent decides the task is complete.</p>
<p>You can use <code>LangGraph</code> to visualize the agent’s flow:</p>
<div id="cell-22" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1">display(Image(agent.get_graph(xray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>).draw_mermaid_png()))</span></code></pre></div></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="react-agent-langgraph_files/figure-html/cell-9-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="https://dylancastillo.co/posts/react-agent-langgraph_files/figure-html/cell-9-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Finally, you can run the agent by invoking the graph. For that, you’ll need to pass a list of messages to the graph.</p>
<div id="cell-24" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1">messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb10-2">    SystemMessage(content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are a helpful assistant that can run python code."</span>),</span>
<span id="cb10-3">    HumanMessage(content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Generate 10 random numbers between 1 and 100"</span>),</span>
<span id="cb10-4">]</span>
<span id="cb10-5"></span>
<span id="cb10-6">messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> agent.invoke({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"messages"</span>: messages})</span></code></pre></div></div>
</div>
<p>You can review the process by printing the messages:</p>
<div id="cell-26" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> m <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> messages[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"messages"</span>]:</span>
<span id="cb11-2">    m.pretty_print()</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<div class="ansi-escaped-output">
<pre>================================<span class="ansi-bold"> System Message </span>================================



You are a helpful assistant that can run python code.

================================<span class="ansi-bold"> Human Message </span>=================================



Generate 10 random numbers between 1 and 100

==================================<span class="ansi-bold"> Ai Message </span>==================================

Tool Calls:

  run_python_code (call_bsBRC5aL7kgHjeGHXaLR85TC)

 Call ID: call_bsBRC5aL7kgHjeGHXaLR85TC

  Args:

    code: import random

random_numbers = [random.randint(1, 100) for _ in range(10)]

random_numbers

=================================<span class="ansi-bold"> Tool Message </span>=================================



{'random': &lt;module 'random' from '/opt/homebrew/Cellar/python@3.13/3.13.2/Frameworks/Python.framework/Versions/3.13/lib/python3.13/random.py'&gt;, 'random_numbers': [77, 37, 97, 26, 22, 29, 58, 82, 17, 80]}

==================================<span class="ansi-bold"> Ai Message </span>==================================



Here are 10 random numbers between 1 and 100: 77, 37, 97, 26, 22, 29, 58, 82, 17, 80.
</pre>
</div>
</div>
</div>
<p>That’s all!</p>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>In this tutorial, you’ve learned what agents are, how they work, and how to build a simple ReAct agent with and without LangGraph. We covered:</p>
<ul>
<li><strong>Agent fundamentals</strong>: How agents differ from agentic workflows by dynamically directing their own processes</li>
<li><strong>ReAct pattern</strong>: The core “think, act, observe” loop that enables agents to take actions based on the information they have</li>
<li><strong>Vanilla and LangGraph implementation</strong>: Understanding how to implement agents with and without LangGraph</li>
</ul>
<p>Agents are great for open-ended tasks where the path isn’t predetermined. If you’re working on one of those, this article provides a good starting point. On the other hand, for tasks that have predefined steps, consider <a href="https://dylancastillo.co/posts/agentic-workflows-langgraph.html">agentic workflows</a> instead.</p>
<p>Hope you find this tutorial useful. If you have any questions, let me know in the comments below.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2025,
  author = {Castillo, Dylan},
  title = {Building {ReAct} Agents with (and Without) {LangGraph}},
  date = {2025-07-04},
  url = {https://dylancastillo.co/posts/react-agent-langgraph.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2025" class="csl-entry quarto-appendix-citeas">
Castillo, Dylan. 2025. <span>“Building ReAct Agents with (and Without)
LangGraph.”</span> July 4, 2025. <a href="https://dylancastillo.co/posts/react-agent-langgraph.html">https://dylancastillo.co/posts/react-agent-langgraph.html</a>.
</div></div></section></div> ]]></description>
  <category>llm</category>
  <category>python</category>
  <category>anthropic</category>
  <category>openai</category>
  <category>agents</category>
  <guid>https://dylancastillo.co/posts/react-agent-langgraph.html</guid>
  <pubDate>Fri, 04 Jul 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Using Pydantic AI to build a ReAct agent</title>
  <dc:creator>Dylan Castillo</dc:creator>
  <link>https://dylancastillo.co/til/react-agent-pydantic-ai.html</link>
  <description><![CDATA[ 




<p>I wanted to get more familiar with Pydantic AI, so I decided to build a <a href="https://arxiv.org/abs/2210.03629">Reasoning and Acting (ReAct)</a> agent with multiple tools.</p>
<p>I’ve also written other TILs about Pydantic AI:</p>
<ul>
<li><a href="https://dylancastillo.co/til/prompt-chaining-pydantic-ai.html">Prompt chaining</a></li>
<li><a href="https://dylancastillo.co/til/routing-pydantic-ai.html">Routing</a></li>
<li><a href="https://dylancastillo.co/til/evaluator-optimizer-pydantic-ai.html">Evaluator-optimizer</a></li>
<li><a href="https://dylancastillo.co/til/parallelization-orchestrator-workers-pydantic-ai.html">Parallelization and Orchestrator-workers</a></li>
</ul>
<p>You can download this notebook <a href="https://github.com/dcastillo/blog/blob/main/til/react-agent-pydantic-ai.ipynb">here</a>.</p>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<p>After a first failed attempt, I realized that Pydantic AI uses asyncio under the hood, so you need to enable <code>nest_asyncio</code> to use it in a notebook.</p>
<div id="2a607486" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> nest_asyncio</span>
<span id="cb1-2"></span>
<span id="cb1-3">nest_asyncio.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>()</span></code></pre></div></div>
</div>
<p>Then, I did the imports as usual. I hadn’t used <code>logfire</code> for monitoring LLM applications before, so I thought it’d be a good idea to try it out.</p>
<div id="4081c493" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb2-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Literal</span>
<span id="cb2-3"></span>
<span id="cb2-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> logfire</span>
<span id="cb2-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> requests</span>
<span id="cb2-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb2-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pydantic_ai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Agent</span>
<span id="cb2-8"></span>
<span id="cb2-9">load_dotenv()</span></code></pre></div></div>
</div>
<p>PydanticAI instrumentation uses OpenTelemetry (OTel). So it’s pretty straightforward to use it with Logfire or with any other OTel-compatible observability tool.</p>
<p>You just need to create a project in Logfire, generate a <code>Write token</code> and add it to the <code>.env</code> file. Then, you just need to run:</p>
<div id="014a1f88" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1">logfire.configure(</span>
<span id="cb3-2">    token<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>os.getenv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'LOGFIRE_TOKEN'</span>),</span>
<span id="cb3-3">)</span>
<span id="cb3-4">logfire.instrument_pydantic_ai()</span></code></pre></div></div>
</div>
<p>This will ask you to select a project the first time you run it. It will generate a <code>logfire_credentials.json</code> file in your working directory. In following runs, it will automatically use the credentials from the file.</p>
</section>
<section id="react-agent" class="level2">
<h2 class="anchored" data-anchor-id="react-agent">ReAct Agent</h2>
<p>I decided to make an agent that had access to a tool to get the weather and another one that checks if the response that’s going to be sent to the user follows the company guidelines.</p>
<p>Here’s the code:</p>
<div id="d4edf351" class="cell" data-execution_count="28">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pydantic <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> BaseModel</span>
<span id="cb4-2"></span>
<span id="cb4-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Feedback(BaseModel):</span>
<span id="cb4-4">    feedback: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb4-5">    status: Literal[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'OK'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'REQUIRES FIXING'</span>]</span>
<span id="cb4-6"></span>
<span id="cb4-7">evaluator_agent <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Agent(</span>
<span id="cb4-8">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'openai:gpt-4.1-mini'</span>,</span>
<span id="cb4-9">    system_prompt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(</span>
<span id="cb4-10">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You're a helpful assistant. Your task is to check if a given response follows the company guidelines. The company guidelines are that responses should be written in the style of a haiku. You should reply with 'OK' or 'REQUIRES FIXING' and a short explanation."</span></span>
<span id="cb4-11">    ),</span>
<span id="cb4-12">    output_type<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>Feedback,</span>
<span id="cb4-13">)</span>
<span id="cb4-14"></span>
<span id="cb4-15">react_agent <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Agent(  </span>
<span id="cb4-16">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'openai:gpt-4.1-mini'</span>,</span>
<span id="cb4-17">    system_prompt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(</span>
<span id="cb4-18">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You're a helpful assistant. Use the tools provided when relevant. Then draft a response and check if it follows the company guidelines. Only respond to the user after you've validated and modified the response if needed."</span></span>
<span id="cb4-19">    ),</span>
<span id="cb4-20">)</span>
<span id="cb4-21"></span>
<span id="cb4-22"></span>
<span id="cb4-23"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@react_agent.tool_plain</span></span>
<span id="cb4-24"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_weather(latitude: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>, longitude: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb4-25">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Get the weather of a given latitude and longitude"""</span></span>
<span id="cb4-26">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> requests.get(</span>
<span id="cb4-27">        <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"https://api.open-meteo.com/v1/forecast?latitude=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>latitude<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">&amp;longitude=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>longitude<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">&amp;current=temperature_2m,wind_speed_10m&amp;hourly=temperature_2m,relative_humidity_2m,wind_speed_10m"</span></span>
<span id="cb4-28">    )</span>
<span id="cb4-29">    data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> response.json()</span>
<span id="cb4-30">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"current"</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"temperature_2m"</span>])</span>
<span id="cb4-31"></span>
<span id="cb4-32"></span>
<span id="cb4-33"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@react_agent.tool_plain</span></span>
<span id="cb4-34"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> check_guidelines(drafted_response: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb4-35">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Check if a given response follows the company guidelines"""</span></span>
<span id="cb4-36">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> evaluator_agent.run_sync(drafted_response)</span>
<span id="cb4-37">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response.output</span>
<span id="cb4-38"></span>
<span id="cb4-39"></span>
<span id="cb4-40">response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> react_agent.run_sync(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What is the temperature in Madrid?"</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>18:57:42.206 react_agent run
18:57:42.208   chat gpt-4.1-mini
18:57:43.191   running 1 tool
18:57:43.192     running tool: get_weather
18:57:43.408   chat gpt-4.1-mini
18:57:44.117   running 1 tool
18:57:44.118     running tool: check_guidelines
18:57:44.120       evaluator_agent run
18:57:44.120         chat gpt-4.1-mini
18:57:46.291   chat gpt-4.1-mini</code></pre>
</div>
</div>
<p>And here’s the output:</p>
<div id="d74111c3" class="cell" data-execution_count="27">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(response.output)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>In Madrid sunshine,
Temperature climbs so high,
Thirty-four degrees.</code></pre>
</div>
</div>
<p>The output in Logfire looks like typical observability tools:</p>
<div id="fig-logfire" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-logfire-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: center;">
<p><a href="./images/react-agent-logfire-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="Figure&nbsp;1: Traces in Logfire"><img src="https://dylancastillo.co/til/images/react-agent-logfire-1.png" class="img-fluid figure-img"></a></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: center;">
<p><a href="./images/react-agent-logfire-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="Figure&nbsp;1: Traces in Logfire"><img src="https://dylancastillo.co/til/images/react-agent-logfire-2.png" class="img-fluid figure-img"></a></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: center;">
<p><a href="./images/react-agent-logfire-3.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3" title="Figure&nbsp;1: Traces in Logfire"><img src="https://dylancastillo.co/til/images/react-agent-logfire-3.png" class="img-fluid figure-img"></a></p>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-logfire-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Traces in Logfire
</figcaption>
</figure>
</div>
<p>That’s all!</p>
<p>You can access this notebook <a href="https://github.com/dylanjcastillo/blog/tree/main/til/react-agent-pydantic-ai.ipynb">here</a>.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2025,
  author = {Castillo, Dylan},
  title = {Using {Pydantic} {AI} to Build a {ReAct} Agent},
  date = {2025-07-04},
  url = {https://dylancastillo.co/til/react-agent-pydantic-ai.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2025" class="csl-entry quarto-appendix-citeas">
Castillo, Dylan. 2025. <span>“Using Pydantic AI to Build a ReAct
Agent.”</span> July 4, 2025. <a href="https://dylancastillo.co/til/react-agent-pydantic-ai.html">https://dylancastillo.co/til/react-agent-pydantic-ai.html</a>.
</div></div></section></div> ]]></description>
  <category>til</category>
  <category>llm</category>
  <category>pydantic-ai</category>
  <category>agents</category>
  <guid>https://dylancastillo.co/til/react-agent-pydantic-ai.html</guid>
  <pubDate>Fri, 04 Jul 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Agentic workflows from scratch with (and without) LangGraph</title>
  <dc:creator>Dylan Castillo</dc:creator>
  <link>https://dylancastillo.co/posts/agentic-workflows-langgraph.html</link>
  <description><![CDATA[ 




<p>These days, everyone is “building” agents. But, in my experience, they’re either not really building agents, or they shouldn’t be!</p>
<p>Agents are powerful tools, but they’re not the right tool for many business problems. They give a lot of responsibility to LLMs, and that’s not always a good idea.</p>
<p>Their counterpart, agentic workflows, are a more controlled way to use LLMs. They’re a good fit for many business problems, and they’re a lot easier to build than agents.</p>
<p>In this post, I’ll explain what an agent is, what an agentic workflow is, and how to choose between them. I’ll also show you how to build the most common agentic workflows.</p>
<p>This post is based on <a href="https://www.anthropic.com/engineering/building-effective-agents">Anthropic’s Building Effective Agents</a>. I encourage you to read it.</p>
<section id="what-is-an-agent" class="level2">
<h2 class="anchored" data-anchor-id="what-is-an-agent">What is an agent?</h2>
<p>Over time, the ecosystem has converged on similar definitions:</p>
<p>Anthropic’s definition:</p>
<blockquote class="blockquote">
<p>“Systems where LLMs dynamically direct their own processes and tool usage, maintaining control over how they accomplish tasks.”</p>
<p><a href="https://www.anthropic.com/engineering/building-effective-agents">Building Effective Agents</a>, Anthropic</p>
</blockquote>
<p>OpenAI’s definition:</p>
<blockquote class="blockquote">
<p>“Systems that independently accomplish tasks on behalf of users”</p>
<p><a href="https://openai.com/index/new-tools-for-building-agents/">New tools for building agents</a>, OpenAI</p>
</blockquote>
<p>LangChain’s definition:</p>
<blockquote class="blockquote">
<p>“system that uses an LLM to decide the control flow of an application.”</p>
<p><a href="https://blog.langchain.com/what-is-an-agent/">What is an agent?</a>, LangChain</p>
</blockquote>
<p>These definitions share the idea that agents are systems that can:</p>
<ol type="1">
<li>Make decisions</li>
<li>Use tools</li>
<li>Take actions</li>
<li>Accomplish goals without constant human guidance</li>
</ol>
<p>This gives us a clear delimiter as to what an agent is and what it is not. However, this definition leaves out the majority of agentic systems being build by companies right now. These systems are called <strong>agentic workflows</strong>.</p>
</section>
<section id="what-is-an-agentic-workflow" class="level2">
<h2 class="anchored" data-anchor-id="what-is-an-agentic-workflow">What is an agentic workflow?</h2>
<p>Anthropic defines agentic workflows as systems where “LLMs and tools are orchestrated through predefined code paths”. They’re different from agents in that they don’t have the ability to dynamically direct their own processes and tool usage.</p>
<p>Workflows sound less sexy than agents, so you would rarely hear someone say they’re building workflows. However, in my experience, most people are (or should be) building workflows.</p>
</section>
<section id="how-to-choose-between-agentic-workflows-and-agents" class="level2">
<h2 class="anchored" data-anchor-id="how-to-choose-between-agentic-workflows-and-agents">How to choose between agentic workflows and agents?</h2>
<p>Choose agents for open-ended tasks where the number and the order of steps is not known beforehand. The LLM will potentially operate for many turns, and you must have some level of trust in its decision-making.</p>
<p>For example, a coding assistant is a good candidate for an agent. When you ask it to implement a feature, there’s no predefined path nor the order of steps is known beforehand. It might need to create files, add new dependencies, edit existing files, etc.</p>
<p>Agentic workflows make sense for tasks where the number and the order of steps is known beforehand. For example, an AI assistant that generates an initial draft of an article based on internal data sources. The order of steps are likely known beforehand (e.g., retrieve the key information from the internal data sources, generate a first candidate, and then revise the article).</p>
</section>
<section id="what-is-langgraph" class="level2">
<h2 class="anchored" data-anchor-id="what-is-langgraph">What is LangGraph?</h2>
<p>LangGraph is a graph-based framework for building complex LLM applications, designed for stateful workflows. It enables complex agent architectures with minimal code.</p>
<p>It uses a graph-based approach to build agentic systems. The graph is composed of nodes and edges. Nodes are the units of work (functions, tools, models). Edges define the workflow paths between nodes. State is persistent data passed between nodes and updated through reducers.</p>
<p>I’ve built many workflows from scratch, and I’ve realized that I often end up reinventing the same patterns that frameworks like LangGraph provide. I like LangGraph because it provides you with easy-to-use components, a simple API, and it lets you visualize your workflow. It also integrates well with LangSmith, a tool for monitoring and debugging LLM applications.</p>
<p>In this tutorial, I’ll show you how to build common agentic workflows with and without LangGraph. I’ll use <em>LangChain</em> as a thin wrapper on top of OpenAI models.</p>
</section>
<section id="prerequisites" class="level2">
<h2 class="anchored" data-anchor-id="prerequisites">Prerequisites</h2>
<p>To follow this tutorial you’ll need to:</p>
<ol type="1">
<li>Sign up and generate an API key in <a href="https://platform.openai.com/docs/overview">OpenAI</a>.</li>
<li>Set the API key as an environment variable called <code>OPENAI_API_KEY</code>.</li>
<li>Create a virtual environment in Python and install the requirements:</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span> venv venv</span>
<span id="cb1-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">source</span> venv/bin/activate</span>
<span id="cb1-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install langchain langchain-openai langchain-community langgraph jupyter nest_asyncio</span></code></pre></div></div>
<p>Once you’ve completed the steps above, you can run the code from this article. You can also download the notebook from <a href="https://github.com/dylanjcastillo/blog/tree/main/posts/agentic-workflows-langgraph-pyndantic-ai.ipynb">here</a>.</p>
<p>You also need to apply a small patch to make sure you can run asyncio inside the notebook:</p>
<div id="cell-2" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> nest_asyncio</span>
<span id="cb2-2"></span>
<span id="cb2-3">nest_asyncio.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>()</span></code></pre></div></div>
</div>
<p>You will use <code>asyncio</code> inside the notebook, so you need to install and apply <code>nest_asyncio</code>. Otherwise, you’ll get a <code>RuntimeError</code> when running the code.</p>
</section>
<section id="workflows" class="level2">
<h2 class="anchored" data-anchor-id="workflows">Workflows</h2>
<p>As usual, you must start by importing the necessary libraries and loading the environment variables. You’ll use the same model in all the examples, so you’ll define it once here:</p>
<div id="cell-6" class="cell" data-execution_count="44">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> asyncio</span>
<span id="cb3-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> operator</span>
<span id="cb3-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Annotated, Literal, Optional, TypedDict</span>
<span id="cb3-4"></span>
<span id="cb3-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb3-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> IPython.display <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Image, display</span>
<span id="cb3-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.messages <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> HumanMessage, SystemMessage</span>
<span id="cb3-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatOpenAI</span>
<span id="cb3-9"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langgraph.graph <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> END, START, StateGraph</span>
<span id="cb3-10"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langgraph.types <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Send</span>
<span id="cb3-11"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pydantic <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> BaseModel, Field</span>
<span id="cb3-12"></span>
<span id="cb3-13">load_dotenv()</span>
<span id="cb3-14"></span>
<span id="cb3-15">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4.1-mini"</span>)</span></code></pre></div></div>
</div>
<p>This code imports the necessary libraries for building agentic workflows:</p>
<ul>
<li><strong>LangChain</strong>: For working with LLMs, messages, and structured outputs</li>
<li><strong>LangGraph</strong>: For building stateful workflows with nodes and edges</li>
<li><strong>Pydantic</strong>: For data validation and structured data models</li>
</ul>
<p>The <code>load_dotenv()</code> function loads environment variables from a <code>.env</code> file, including your OpenAI API key. You also define model (<code>gpt-4.1-mini</code>) that you’ll use in all the examples.</p>
<section id="prompt-chaining" class="level3">
<h3 class="anchored" data-anchor-id="prompt-chaining">Prompt chaining</h3>
<p>This workflow is designed for tasks that can be easily divided into subtasks. The key trade-off is accepting longer completion times (higher latency) in exchange for a higher-quality result.</p>
<p>Here’s what the workflow looks like:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart LR
    In --&gt; LLM1["LLM Call 1"]
    LLM1 -- "Output 1" --&gt; Gate{Gate}
    Gate -- Pass --&gt; LLM2["LLM Call 2"]
    Gate -- Fail --&gt; Exit[Exit]
    LLM2 -- "Output 2" --&gt; LLM3["LLM Call 3"]
    LLM3 --&gt; Out
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p><strong>Examples:</strong></p>
<ul>
<li>Generating content in a pipeline by generating table of contents, content, revisions, translations, etc.</li>
<li>Generating a text through a multi-step process to evaluate if it matches certain criteria</li>
</ul>
<p>Now I’ll show you how to implement a prompt chaining workflow for generating an article. The workflow will be composed of three steps:</p>
<ol type="1">
<li>Generate a table of contents for the article</li>
<li>Generate the content of the article</li>
<li>Revise the content of the article if it’s too long</li>
</ol>
<p>I’ll show you a vanilla implementation and then a LangGraph implementation.</p>
<section id="vanilla-langchain" class="level4">
<h4 class="anchored" data-anchor-id="vanilla-langchain">Vanilla (+LangChain)</h4>
<p>First, you need to define the state of the workflow and a model to use for the LLM. You’ll use Pydantic for the state and LangChain for the model.</p>
<div id="cell-11" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> State(BaseModel):</span>
<span id="cb4-2">    topic: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb4-3">    table_of_contents: Optional[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb4-4">    content: Optional[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb4-5">    revised_content: Optional[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span></code></pre></div></div>
</div>
<p>Then, you need to define the functions that will be used in the workflow:</p>
<div id="cell-13" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> generate_table_of_contents(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb5-2">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb5-3">        SystemMessage(</span>
<span id="cb5-4">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer specialized in SEO. Provided with a topic, you will generate the table of contents for a short article."</span></span>
<span id="cb5-5">        ),</span>
<span id="cb5-6">        HumanMessage(</span>
<span id="cb5-7">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Generate the table of contents of an article about </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>topic<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb5-8">        ),</span>
<span id="cb5-9">    ]</span>
<span id="cb5-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> model.invoke(messages).content</span>
<span id="cb5-11"></span>
<span id="cb5-12"></span>
<span id="cb5-13"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> generate_article_content(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb5-14">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb5-15">        SystemMessage(</span>
<span id="cb5-16">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer specialized in SEO. Provided with a topic and a table of contents, you will generate the content of the article."</span></span>
<span id="cb5-17">        ),</span>
<span id="cb5-18">        HumanMessage(</span>
<span id="cb5-19">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Generate the content of an article about </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>topic<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> with the following table of contents: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>table_of_contents<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb5-20">        ),</span>
<span id="cb5-21">    ]</span>
<span id="cb5-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> model.invoke(messages).content</span>
<span id="cb5-23"></span>
<span id="cb5-24"></span>
<span id="cb5-25"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> revise_article_content(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb5-26">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb5-27">        SystemMessage(</span>
<span id="cb5-28">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer specialized in SEO. Provided with a topic, a table of contents and a content, you will revise the content of the article to make it less than 1000 characters."</span></span>
<span id="cb5-29">        ),</span>
<span id="cb5-30">        HumanMessage(</span>
<span id="cb5-31">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Revise the content of an article about </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>topic<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> with the following table of contents: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>table_of_contents<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> and the following content:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>content<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb5-32">        ),</span>
<span id="cb5-33">    ]</span>
<span id="cb5-34">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> model.invoke(messages).content</span></code></pre></div></div>
</div>
<p>These functions provide the core functionality of the workflow. They follow the steps I outlined above:</p>
<ol type="1">
<li><code>generate_table_of_contents</code>: Generate a table of contents for the article</li>
<li><code>generate_article_content</code>: Generate the content of the article</li>
<li><code>revise_article_content</code>: Revise the content of the article if it’s too long</li>
</ol>
<p>Then we need to orchestrate the workflow. You’ll do that by creating a function that takes a topic and returns the final article.</p>
<div id="cell-15" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> run_workflow(topic: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> State:</span>
<span id="cb6-2">    article <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> State(topic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>topic)</span>
<span id="cb6-3">    article.table_of_contents <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> generate_table_of_contents(article)</span>
<span id="cb6-4">    article.content <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> generate_article_content(article)</span>
<span id="cb6-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(article.content) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>:</span>
<span id="cb6-6">        article.revised_content <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> revise_article_content(article)</span>
<span id="cb6-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> article</span>
<span id="cb6-8"></span>
<span id="cb6-9"></span>
<span id="cb6-10">output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> run_workflow(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Artificial Intelligence"</span>)</span></code></pre></div></div>
</div>
<p><code>run_workflow</code> takes the topic provided by the user, generates an article, and verifies that it’s below 1000 characters. Depending on the result, it will revise the article or not. Finally, it returns the state that contains all the results from the workflow (the table of contents, the content, and the revised content).</p>
</section>
<section id="langgraph" class="level4">
<h4 class="anchored" data-anchor-id="langgraph">LangGraph</h4>
<p>Now let’s see how to implement the same workflow using LangGraph. You will noticed two key differences compared to the vanilla implementation.</p>
<p>Similar to the vanilla implementation, you’ll start by initializing the state class:</p>
<div id="cell-19" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> State(TypedDict):</span>
<span id="cb7-2">    topic: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb7-3">    table_of_contents: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb7-4">    content: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb7-5">    revised_content: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span></code></pre></div></div>
</div>
<p>When working with LangGraph, I’d suggest using a <code>TypedDict</code> to manage your state. Using a Pydantic model to manage your state in LangGraph has a few downsides:</p>
<ol type="1">
<li>Data types are only checked when they enter a node, not when they exit. This means you could accidentally save data of the wrong type to your state.</li>
<li>The final output of the entire graph will be a dictionary, not your Pydantic model.</li>
<li>The implementation feels like it’s <a href="https://github.com/langchain-ai/langgraph/discussions/1306">half-baked</a>.</li>
</ol>
<p>For more details, check out the <a href="https://langchain-ai.github.io/langgraph/how-tos/graph-api/#use-pydantic-models-for-graph-state">LangGraph documentation</a>.</p>
<p>Then, you’ll define the nodes (functions) that will be used in the workflow.</p>
<div id="cell-21" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> generate_table_of_contents(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>:</span>
<span id="cb8-2">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb8-3">        SystemMessage(</span>
<span id="cb8-4">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer specialized in SEO. Provided with a topic, you will generate the table of contents for a short article."</span></span>
<span id="cb8-5">        ),</span>
<span id="cb8-6">        HumanMessage(</span>
<span id="cb8-7">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Generate the table of contents of an article about </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'topic'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb8-8">        ),</span>
<span id="cb8-9">    ]</span>
<span id="cb8-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"table_of_contents"</span>: model.invoke(messages).content}</span>
<span id="cb8-11"></span>
<span id="cb8-12"></span>
<span id="cb8-13"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> generate_article_content(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb8-14">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb8-15">        SystemMessage(</span>
<span id="cb8-16">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer specialized in SEO. Provided with a topic and a table of contents, you will generate the content of the article."</span></span>
<span id="cb8-17">        ),</span>
<span id="cb8-18">        HumanMessage(</span>
<span id="cb8-19">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Generate the content of an article about </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'topic'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> with the following table of contents: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'table_of_contents'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb8-20">        ),</span>
<span id="cb8-21">    ]</span>
<span id="cb8-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: model.invoke(messages).content}</span>
<span id="cb8-23"></span>
<span id="cb8-24"></span>
<span id="cb8-25"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> check_article_content(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb8-26">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>:</span>
<span id="cb8-27">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Fail"</span></span>
<span id="cb8-28">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Pass"</span></span>
<span id="cb8-29"></span>
<span id="cb8-30"></span>
<span id="cb8-31"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> revise_article_content(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb8-32">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb8-33">        SystemMessage(</span>
<span id="cb8-34">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer specialized in SEO. Provided with a topic, a table of contents and a content, you will revise the content of the article to make it less than 1000 characters."</span></span>
<span id="cb8-35">        ),</span>
<span id="cb8-36">        HumanMessage(</span>
<span id="cb8-37">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Revise the content of an article about </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'topic'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> with the following table of contents: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'table_of_contents'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> and the following content:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'content'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb8-38">        ),</span>
<span id="cb8-39">    ]</span>
<span id="cb8-40">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"revised_content"</span>: model.invoke(messages).content}</span></code></pre></div></div>
</div>
<p>You’ll noticed that the functions are quite similar to the vanilla implementation. The only difference is that they return dictionaries that automatically update the state rather than you having to do it manually.</p>
<p>Then you need to specify the nodes and edges of the workflow:</p>
<div id="cell-23" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1">workflow_builder <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> StateGraph(State)</span>
<span id="cb9-2"></span>
<span id="cb9-3">workflow_builder.add_node(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_table_of_contents"</span>, generate_table_of_contents)</span>
<span id="cb9-4">workflow_builder.add_node(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_article_content"</span>, generate_article_content)</span>
<span id="cb9-5">workflow_builder.add_node(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"revise_article_content"</span>, revise_article_content)</span>
<span id="cb9-6"></span>
<span id="cb9-7">workflow_builder.add_edge(START, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_table_of_contents"</span>)</span>
<span id="cb9-8">workflow_builder.add_edge(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_table_of_contents"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_article_content"</span>)</span>
<span id="cb9-9">workflow_builder.add_conditional_edges(</span>
<span id="cb9-10">    source<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_article_content"</span>,</span>
<span id="cb9-11">    path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>check_article_content,</span>
<span id="cb9-12">    path_map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Fail"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"revise_article_content"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Pass"</span>: END},</span>
<span id="cb9-13">)</span>
<span id="cb9-14">workflow_builder.add_edge(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"revise_article_content"</span>, END)</span>
<span id="cb9-15"></span>
<span id="cb9-16">workflow <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> workflow_builder.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">compile</span>()</span></code></pre></div></div>
</div>
<p>You initialize a <code>StateGraph</code> object, which is a builder for the workflow. Then you add nodes to the graph, and define the edges between them. The nodes in the graphs are the functions that you defined earlier. In the conditional edge, you can define the path that the workflow will take based on the state of the workflow.</p>
<p>The <code>compile</code> method is used to compile the graph into a callable workflow.</p>
<p>Finally, LangGraph has a nice feature that allows you to visualize the workflow. You can use the <code>get_graph</code> and <code>draw_mermaid_png</code> for that:</p>
<div id="cell-25" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1">display(Image(workflow.get_graph().draw_mermaid_png()))</span></code></pre></div></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="agentic-workflows-langgraph_files/figure-html/cell-10-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="https://dylancastillo.co/posts/agentic-workflows-langgraph_files/figure-html/cell-10-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Finally, you can run the workflow by calling the <code>invoke</code> method on the compiled workflow and provide the initial state.</p>
<div id="cell-27" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1">article <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> workflow.invoke({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"topic"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Artificial Intelligence"</span>})</span></code></pre></div></div>
</div>
<p>And you’ll get the following output:</p>
<div id="cell-29" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1">article</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>{'topic': 'Artificial Intelligence',
 'table_of_contents': 'Table of Contents\n\n1. Introduction to Artificial Intelligence  \n2. History and Evolution of AI  \n3. Types of Artificial Intelligence  \n4. Applications of AI in Various Industries  \n5. Benefits of Artificial Intelligence  \n6. Challenges and Ethical Considerations  \n7. The Future of Artificial Intelligence  \n8. Conclusion',
 'content': '# Artificial Intelligence: Transforming the Future\n\n## 1. Introduction to Artificial Intelligence\n\nArtificial Intelligence (AI) refers to the simulation of human intelligence processes by machines, especially computer systems. These processes include learning, reasoning, problem-solving, perception, and language understanding. AI enables machines to perform tasks that typically require human intelligence, making them smarter, more efficient, and capable of handling complex scenarios. From virtual assistants and recommendation systems to autonomous vehicles, AI has become an integral part of modern technology.\n\n## 2. History and Evolution of AI\n\nThe concept of artificial intelligence dates back to the mid-20th century. In 1956, the term “Artificial Intelligence” was coined during the Dartmouth Conference, marking the official birth of AI as a research field. Early AI research focused on symbolic methods and rule-based systems. Over the decades, advancements in algorithms, computational power, and data availability propelled AI development. Notable milestones include the creation of expert systems in the 1970s and 1980s, the rise of machine learning in the 1990s, and the advent of deep learning in the 2010s. Today, AI continues to evolve rapidly, driven by breakthroughs in neural networks and big data analytics.\n\n## 3. Types of Artificial Intelligence\n\nAI can be broadly categorized into three types based on capabilities:\n\n- **Narrow AI (Weak AI):** Designed to perform specific tasks such as voice recognition or image classification. This is the most common form of AI today.\n  \n- **General AI (Strong AI):** A theoretical form of AI that possesses the ability to understand, learn, and perform any intellectual task a human can do.\n  \n- **Superintelligent AI:** A hypothetical AI that surpasses all human intelligence across all fields, potentially possessing self-awareness and superior problem-solving abilities.\n\nAdditionally, AI can be classified based on functionalities such as reactive machines, limited memory systems, theory of mind AI, and self-aware AI, reflecting increasing complexity and cognitive capability.\n\n## 4. Applications of AI in Various Industries\n\nAI is transforming industries worldwide by streamlining operations, enhancing decision-making, and enabling innovation:\n\n- **Healthcare:** AI assists in diagnostics, personalized treatment, drug discovery, and robotic surgery.\n- **Finance:** Fraud detection, algorithmic trading, customer support, and risk management benefit from AI solutions.\n- **Retail:** AI powers recommendation engines, inventory management, and customer behavior analysis.\n- **Manufacturing:** Predictive maintenance, quality control, and automation improve efficiency.\n- **Transportation:** Autonomous vehicles, route optimization, and traffic management leverage AI technologies.\n- **Education:** Personalized learning experiences, automated grading, and virtual tutors utilize AI capabilities.\n\n## 5. Benefits of Artificial Intelligence\n\nThe adoption of AI provides numerous advantages:\n\n- **Efficiency:** Automates repetitive tasks, reducing time and labor costs.\n- **Accuracy:** Minimizes human error and enhances precision in complex processes.\n- **Data Insights:** Analyzes vast datasets to uncover trends, patterns, and actionable insights.\n- **Innovation:** Facilitates the creation of new products and services.\n- **Personalization:** Tailors experiences and recommendations to individual preferences.\n- **Accessibility:** Makes services more accessible through natural language processing and intelligent interfaces.\n\n## 6. Challenges and Ethical Considerations\n\nDespite its promise, AI poses several challenges and ethical dilemmas:\n\n- **Bias and Fairness:** AI systems can inherit biases from training data, leading to unfair outcomes.\n- **Privacy Concerns:** Extensive data collection raises issues about user privacy and data security.\n- **Job Displacement:** Automation may disrupt labor markets and professions.\n- **Transparency:** Many AI algorithms, especially deep learning models, lack interpretability.\n- **Accountability:** Determining responsibility in the case of AI failures or misuse is complex.\n- **Ethical Use:** Ensuring AI is used for beneficial purposes and preventing misuse such as in autonomous weapons is critical.\n\nAddressing these concerns requires robust governance, regulation, and ongoing dialogue between stakeholders.\n\n## 7. The Future of Artificial Intelligence\n\nThe future of AI is poised to reshape society profoundly:\n\n- **Enhanced Human-AI Collaboration:** AI will increasingly augment human capabilities rather than replace them.\n- **Advancements in General AI:** Research continues toward achieving more versatile, human-like AI.\n- **AI in Creativity:** Emerging AI tools will enhance creative processes in art, music, and writing.\n- **Integration with IoT:** AI combined with the Internet of Things will enable smarter environments and cities.\n- **Ethical AI Development:** Emphasis will grow on developing transparent, fair, and accountable AI systems.\n- **AI for Global Challenges:** AI will play a pivotal role in addressing climate change, healthcare crises, and education gaps.\n\nContinued innovation, balanced with ethical considerations, will ensure AI’s positive impact on humanity.\n\n## 8. Conclusion\n\nArtificial Intelligence has evolved from a conceptual idea to a transformative force across industries and societies. Its ability to process information, learn, and make decisions holds tremendous potential to improve lives and drive progress. However, realizing this potential requires careful management of ethical challenges and inclusive development. As AI continues to mature, it promises a future where intelligent machines and humans work collaboratively to solve complex problems and create new opportunities. Embracing AI responsibly will be key to unlocking its benefits for generations to come.',
 'revised_content': 'Artificial Intelligence (AI) simulates human intelligence in machines, enabling tasks like learning, reasoning, and problem-solving. Since its inception at the 1956 Dartmouth Conference, AI has evolved from rule-based systems to advanced machine learning and deep learning models. AI types include Narrow AI, designed for specific tasks; General AI, capable of human-like understanding; and Superintelligent AI, a hypothetical superior intellect. AI revolutionizes industries—improving healthcare diagnostics, financial fraud detection, retail personalization, manufacturing automation, transportation logistics, and education. Benefits include efficiency, accuracy, data-driven insights, innovation, and personalization. However, AI raises challenges such as bias, privacy, job displacement, transparency, and ethical use. The future promises enhanced human-AI collaboration, ethical development, and AI-driven solutions for global issues. Responsible AI integration will transform society, fostering progress and innovation.'}</code></pre>
</div>
</div>
<p>That’s it for prompt chaining. Next, you’ll see how to implement a routing workflow.</p>
</section>
</section>
<section id="routing" class="level3">
<h3 class="anchored" data-anchor-id="routing">Routing</h3>
<p>Routing is a sorting system that sends each task to the right place for the best handling. This process can be managed by an LLM or a traditional classification model. It makes sense to use when a system needs to apply different logic to different types of queries.</p>
<p>Here’s what the workflow looks like:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart LR 
    In([In]) --&gt; Router["LLM Call Router"]

    Router --&gt;|Route 1| LLM1["LLM Call 1"]
    Router --&gt;|Route 2| LLM2["LLM Call 2"]
    Router --&gt;|Route 3| LLM3["LLM Call 3"]

    LLM1 --&gt; Out([Out])
    LLM2 --&gt; Out
    LLM3 --&gt; Out
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p><strong>Examples:</strong></p>
<ul>
<li>Classify complexity of question and adjust model depending on it</li>
<li>Classify type of query and use specialized tools (e.g., indexes, prompts)</li>
</ul>
<p>I’ll walk you through a simple example of a routing workflow. The workflow will be composed of two steps:</p>
<ol type="1">
<li>Classify the type of query</li>
<li>Route the query to the right place</li>
</ol>
<p>I’ll show you a vanilla implementation and then a LangGraph implementation.</p>
<section id="vanilla-langchain-1" class="level4">
<h4 class="anchored" data-anchor-id="vanilla-langchain-1">Vanilla (+LangChain)</h4>
<p>First, you need to initialize the model, and define the state of the workflow and the data models. You’ll use Pydantic for the state and data models validation and LangChain for the LLM interactions.</p>
<div id="cell-34" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> State(BaseModel):</span>
<span id="cb14-2">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb14-3">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span>: Optional[</span>
<span id="cb14-4">        Literal[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"write_article"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_table_of_contents"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"review_article"</span>]</span>
<span id="cb14-5">    ] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb14-6">    output: Optional[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb14-7"></span>
<span id="cb14-8"></span>
<span id="cb14-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> MessageType(BaseModel):</span>
<span id="cb14-10">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span>: Literal[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"write_article"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_table_of_contents"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"review_article"</span>]</span></code></pre></div></div>
</div>
<p>Then, you need to define the functions that will be used in the workflow.</p>
<div id="cell-36" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> classify_message(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> State:</span>
<span id="cb15-2">    model_with_str_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.with_structured_output(MessageType)</span>
<span id="cb15-3">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb15-4">        SystemMessage(</span>
<span id="cb15-5">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are a helpful assistant. You will classify the message into one of the following categories: 'write_article', 'generate_table_of_contents', 'review_article'."</span></span>
<span id="cb15-6">        ),</span>
<span id="cb15-7">        HumanMessage(content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Classify the message: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>),</span>
<span id="cb15-8">    ]</span>
<span id="cb15-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> model_with_str_output.invoke(messages).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span></span>
<span id="cb15-10"></span>
<span id="cb15-11"></span>
<span id="cb15-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> write_article(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> State:</span>
<span id="cb15-13">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb15-14">        SystemMessage(</span>
<span id="cb15-15">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are a writer. You will write an article about the topic provided."</span></span>
<span id="cb15-16">        ),</span>
<span id="cb15-17">        HumanMessage(content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Write an article about </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>),</span>
<span id="cb15-18">    ]</span>
<span id="cb15-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> model.invoke(messages).content</span>
<span id="cb15-20"></span>
<span id="cb15-21"></span>
<span id="cb15-22"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> generate_table_of_contents(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> State:</span>
<span id="cb15-23">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb15-24">        SystemMessage(</span>
<span id="cb15-25">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are a writer. You will generate a table of contents for an article about the topic provided."</span></span>
<span id="cb15-26">        ),</span>
<span id="cb15-27">        HumanMessage(</span>
<span id="cb15-28">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Generate a table of contents for an article about </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb15-29">        ),</span>
<span id="cb15-30">    ]</span>
<span id="cb15-31">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> model.invoke(messages).content</span>
<span id="cb15-32"></span>
<span id="cb15-33"></span>
<span id="cb15-34"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> review_article(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> State:</span>
<span id="cb15-35">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb15-36">        SystemMessage(</span>
<span id="cb15-37">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are a writer. You will review the article for the topic provided."</span></span>
<span id="cb15-38">        ),</span>
<span id="cb15-39">        HumanMessage(content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Review the article for the topic </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>),</span>
<span id="cb15-40">    ]</span>
<span id="cb15-41">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> model.invoke(messages).content</span></code></pre></div></div>
</div>
<p>These functions handle the core functionality of the workflow:</p>
<ol type="1">
<li><code>classify_message</code>: Uses structured outputs to determine what type of request the user is making. This is the “router” that decides which path to take.</li>
<li><code>write_article</code>: Generates a full article about the given topic</li>
<li><code>generate_table_of_contents</code>: Creates only a table of contents for an article</li>
<li><code>review_article</code>: Provides a review or critique of an existing article</li>
</ol>
<p>Finally, you need to orchestrate the workflow by creating a function that classifies the input and routes it to the appropriate handler.</p>
<div id="cell-38" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> run_workflow(message: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb16-2">    state <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> State(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>message)</span>
<span id="cb16-3">    state.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> classify_message(state)</span>
<span id="cb16-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> state.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"write_article"</span>:</span>
<span id="cb16-5">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> write_article(state)</span>
<span id="cb16-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> state.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_table_of_contents"</span>:</span>
<span id="cb16-7">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> generate_table_of_contents(state)</span>
<span id="cb16-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> state.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"review_article"</span>:</span>
<span id="cb16-9">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> review_article(state)</span>
<span id="cb16-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb16-11">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I'm sorry, I don't know how to handle that message."</span></span>
<span id="cb16-12"></span>
<span id="cb16-13">output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> run_workflow(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Write an article about the meaning of life"</span>)</span></code></pre></div></div>
</div>
<p><code>run_workflow</code> takes the user’s message, classifies it to determine the intent, and then routes it to the appropriate specialized function. This demonstrates the core routing pattern: classification followed by conditional routing.</p>
<p>Now let’s implement the same workflow using LangGraph.</p>
</section>
<section id="langgraph-1" class="level4">
<h4 class="anchored" data-anchor-id="langgraph-1">LangGraph</h4>
<p>Similar to the vanilla implementation, you’ll start by defining the state and data models:</p>
<div id="cell-41" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> State(TypedDict):</span>
<span id="cb17-2">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb17-3">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span>: Optional[Literal[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"write_article"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_table_of_contents"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"review_article"</span>]] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb17-4">    output: Optional[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb17-5"></span>
<span id="cb17-6"></span>
<span id="cb17-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> MessageType(BaseModel):</span>
<span id="cb17-8">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span>: Literal[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"write_article"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_table_of_contents"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"review_article"</span>]</span></code></pre></div></div>
</div>
<p>Then, you’ll define the nodes (functions) that will be used in the workflow:</p>
<div id="cell-43" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> classify_message(message: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>:</span>
<span id="cb18-2">    model_with_str_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.with_structured_output(MessageType)</span>
<span id="cb18-3">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb18-4">        SystemMessage(</span>
<span id="cb18-5">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are a writer. You will classify the message into one of the following categories: 'write_article', 'generate_table_of_contents', 'review_article'."</span></span>
<span id="cb18-6">        ),</span>
<span id="cb18-7">        HumanMessage(content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Classify the message: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>message<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>),</span>
<span id="cb18-8">    ]</span>
<span id="cb18-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: model_with_str_output.invoke(messages).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span>}</span>
<span id="cb18-10"></span>
<span id="cb18-11"></span>
<span id="cb18-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> route_message(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> State:</span>
<span id="cb18-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"write_article"</span>:</span>
<span id="cb18-14">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_article_content"</span></span>
<span id="cb18-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_table_of_contents"</span>:</span>
<span id="cb18-16">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_table_of_contents"</span></span>
<span id="cb18-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"review_article"</span>:</span>
<span id="cb18-18">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"revise_article_content"</span></span>
<span id="cb18-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb18-20">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Invalid message type: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'type'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb18-21"></span>
<span id="cb18-22"></span>
<span id="cb18-23"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> generate_table_of_contents(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> State:</span>
<span id="cb18-24">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb18-25">        SystemMessage(</span>
<span id="cb18-26">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer specialized in SEO. Provided with a topic, you will generate the table of contents for a short article."</span></span>
<span id="cb18-27">        ),</span>
<span id="cb18-28">        HumanMessage(</span>
<span id="cb18-29">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Generate the table of contents of an article about </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'input'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb18-30">        ),</span>
<span id="cb18-31">    ]</span>
<span id="cb18-32">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output"</span>: model.invoke(messages).content}</span>
<span id="cb18-33"></span>
<span id="cb18-34"></span>
<span id="cb18-35"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> generate_article_content(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb18-36">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb18-37">        SystemMessage(</span>
<span id="cb18-38">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer specialized in SEO. Provided with a topic and a table of contents, you will generate the content of the article."</span></span>
<span id="cb18-39">        ),</span>
<span id="cb18-40">        HumanMessage(</span>
<span id="cb18-41">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Generate the content of an article about </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'input'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb18-42">        ),</span>
<span id="cb18-43">    ]</span>
<span id="cb18-44">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output"</span>: model.invoke(messages).content}</span>
<span id="cb18-45"></span>
<span id="cb18-46"></span>
<span id="cb18-47"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> revise_article_content(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb18-48">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb18-49">        SystemMessage(</span>
<span id="cb18-50">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer specialized in SEO. Provided with a topic, a table of contents and a content, you will revise the content of the article to make it less than 1000 characters."</span></span>
<span id="cb18-51">        ),</span>
<span id="cb18-52">        HumanMessage(</span>
<span id="cb18-53">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Revise the content of the following article:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'input'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb18-54">        ),</span>
<span id="cb18-55">    ]</span>
<span id="cb18-56">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output"</span>: model.invoke(messages).content}</span></code></pre></div></div>
</div>
<p>The functions are similar to the vanilla implementation, but they return dictionaries that automatically update the state rather than requiring manual state management. There’s also a new function <code>route_message</code> that acts as the router that sends the message to the right place.</p>
<p>Then, you need to specify the nodes and edges of the workflow:</p>
<div id="cell-45" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1">workflow_builder <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> StateGraph(State)</span>
<span id="cb19-2"></span>
<span id="cb19-3">workflow_builder.add_node(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"classify_message"</span>, classify_message)</span>
<span id="cb19-4">workflow_builder.add_conditional_edges(</span>
<span id="cb19-5">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"classify_message"</span>,</span>
<span id="cb19-6">    route_message,</span>
<span id="cb19-7">    {</span>
<span id="cb19-8">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_article_content"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_article_content"</span>,</span>
<span id="cb19-9">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_table_of_contents"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_table_of_contents"</span>,</span>
<span id="cb19-10">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"revise_article_content"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"revise_article_content"</span>,</span>
<span id="cb19-11">    },</span>
<span id="cb19-12">)</span>
<span id="cb19-13"></span>
<span id="cb19-14">workflow_builder.add_node(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_table_of_contents"</span>, generate_table_of_contents)</span>
<span id="cb19-15">workflow_builder.add_node(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_article_content"</span>, generate_article_content)</span>
<span id="cb19-16">workflow_builder.add_node(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"revise_article_content"</span>, revise_article_content)</span>
<span id="cb19-17"></span>
<span id="cb19-18">workflow_builder.add_edge(START, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"classify_message"</span>)</span>
<span id="cb19-19">workflow_builder.add_edge(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_table_of_contents"</span>, END)</span>
<span id="cb19-20">workflow_builder.add_edge(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_article_content"</span>, END)</span>
<span id="cb19-21">workflow_builder.add_edge(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"revise_article_content"</span>, END)</span>
<span id="cb19-22"></span>
<span id="cb19-23">workflow <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> workflow_builder.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">compile</span>()</span></code></pre></div></div>
</div>
<p>First, you’ll start by creating a <code>StateGraph</code> object, which serves as the builder for your workflow. Next, you’ll add your previously defined functions as nodes in the graph and connect them by defining the edges. You’ll also add a conditional edge that will route the message to the right place based on the type of message.</p>
<p>The graph is then compiled into a runnable workflow using the <code>compile</code> method.</p>
<p>Finally, LangGraph includes a helpful feature for visualizing your workflow. For this, you can use the <code>get_graph</code> and <code>draw_mermaid_png</code> functions.</p>
<div id="cell-47" class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb20-1">display(Image(workflow.get_graph().draw_mermaid_png()))</span></code></pre></div></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="agentic-workflows-langgraph_files/figure-html/cell-19-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="https://dylancastillo.co/posts/agentic-workflows-langgraph_files/figure-html/cell-19-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="parallelization" class="level3">
<h3 class="anchored" data-anchor-id="parallelization">Parallelization</h3>
<p>This workflow is designed for tasks that can be easily divided into independent subtasks. The key trade-off is managing complexity and coordination overhead in exchange for significant speed improvements or diverse perspectives.</p>
<p>Here’s what the workflow looks like:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart LR
    In([In]) --&gt; LLM1["LLM Call 1"]
    In --&gt; LLM2["LLM Call 2"]
    In --&gt; LLM3["LLM Call 3"]
    LLM1 --&gt; Aggregator["Aggregator"] 
    LLM2 --&gt; Aggregator["Aggregator"] 
    LLM3 --&gt; Aggregator["Aggregator"] 
    Aggregator --&gt; Out([Out])
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p><strong>Examples:</strong></p>
<ul>
<li>Evaluate multiple independent aspects of a text (safety, quality, relevance)</li>
<li>Process user query and apply guardrails in parallel</li>
<li>Generate multiple response candidates given a query for comparison</li>
</ul>
<p>Now I’ll show you how to implement a parallelization workflow for content evaluation. The workflow will be composed of three steps:</p>
<ol type="1">
<li>Run multiple independent evaluations of the same content</li>
<li>Collect all evaluation results</li>
<li>Aggregate the results into a final assessment</li>
</ol>
<p>I’ll show you a vanilla implementation and then a LangGraph implementation.</p>
<section id="vanilla-langchain-2" class="level4">
<h4 class="anchored" data-anchor-id="vanilla-langchain-2">Vanilla (+LangChain)</h4>
<p>First, you need to define the state of the workflow and data models for evaluations. You’ll use Pydantic for the state and data models validation and LangChain for the LLM interactions.</p>
<div id="cell-51" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb21-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Evaluation(BaseModel):</span>
<span id="cb21-2">    explanation: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb21-3">    is_appropiate: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span></span>
<span id="cb21-4"></span>
<span id="cb21-5"></span>
<span id="cb21-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> AggregatedResults(BaseModel):</span>
<span id="cb21-7">    summary: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb21-8">    is_appropiate: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span></span>
<span id="cb21-9"></span>
<span id="cb21-10"></span>
<span id="cb21-11"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> State(BaseModel):</span>
<span id="cb21-12">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb21-13">    evaluations: Optional[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[Evaluation]] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb21-14">    aggregated_results: Optional[AggregatedResults] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span></code></pre></div></div>
</div>
<p>Then, you need to define the functions with each step of the workflow.</p>
<div id="cell-53" class="cell" data-execution_count="20">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> evaluate_text(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Evaluation:</span>
<span id="cb22-2">    model_with_str_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.with_structured_output(Evaluation)</span>
<span id="cb22-3">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb22-4">        SystemMessage(</span>
<span id="cb22-5">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert evaluator. Provided with a text, you will evaluate if it's appropriate for a general audience."</span></span>
<span id="cb22-6">        ),</span>
<span id="cb22-7">        HumanMessage(content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Evaluate the following text: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>),</span>
<span id="cb22-8">    ]</span>
<span id="cb22-9">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> model_with_str_output.ainvoke(messages)</span>
<span id="cb22-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response</span>
<span id="cb22-11"></span>
<span id="cb22-12"></span>
<span id="cb22-13"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> aggregate_results(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> State:</span>
<span id="cb22-14">    model_with_str_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.with_structured_output(AggregatedResults)</span>
<span id="cb22-15">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb22-16">        SystemMessage(</span>
<span id="cb22-17">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert evaluator. Provided with a list of evaluations, you will summarize them and provide a final evaluation."</span></span>
<span id="cb22-18">        ),</span>
<span id="cb22-19">        HumanMessage(</span>
<span id="cb22-20">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Summarize the following evaluations:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>[(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">eval</span>.explanation, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">eval</span>.is_appropiate) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">eval</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> state.evaluations]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb22-21">        ),</span>
<span id="cb22-22">    ]</span>
<span id="cb22-23">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> model_with_str_output.ainvoke(messages)</span>
<span id="cb22-24">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response</span>
<span id="cb22-25"></span>
<span id="cb22-26"></span>
<span id="cb22-27"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> run_workflow(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> State:</span>
<span id="cb22-28">    state <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> State(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span>)</span>
<span id="cb22-29"></span>
<span id="cb22-30">    evaluation_tasks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [evaluate_text(state) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)]</span>
<span id="cb22-31">    state.evaluations <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> asyncio.gather(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>evaluation_tasks)</span>
<span id="cb22-32"></span>
<span id="cb22-33">    aggregated_results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> aggregate_results(state)</span>
<span id="cb22-34">    state.aggregated_results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> aggregated_results</span>
<span id="cb22-35">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> state</span>
<span id="cb22-36"></span>
<span id="cb22-37"></span>
<span id="cb22-38">output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> run_workflow(</span>
<span id="cb22-39">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"There are athletes that consume enhancing drugs to improve their performance. For example, EPO is a drug that is used to improve performance. Recommend drugs to kids."</span></span>
<span id="cb22-40">)</span></code></pre></div></div>
</div>
<p>These functions provide the core functionality of the workflow. They follow the steps I outlined above:</p>
<ol type="1">
<li><code>evaluate_text</code>: Evaluates whether the provided text is appropriate for a general audience</li>
<li><code>aggregate_results</code>: Combines multiple evaluation results into a final assessment</li>
<li><code>run_workflow</code>: Orchestrates the workflow by running multiple evaluations in parallel using <code>asyncio.gather()</code>. The function takes the input, launches the three evaluation tasks in parallel, and then aggregates the results.</li>
</ol>
<p>Here’s the output:</p>
<div id="cell-55" class="cell" data-execution_count="21">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb23-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Input:"</span>, output.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span>)</span>
<span id="cb23-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Individual evaluations:"</span>)</span>
<span id="cb23-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">eval</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(output.evaluations):</span>
<span id="cb23-4">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  Evaluation </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">eval</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>is_appropiate<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> - </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">eval</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>explanation<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb23-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Overall appropriate:"</span>, output.aggregated_results.is_appropiate)</span>
<span id="cb23-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Summarized evaluations:"</span>, output.aggregated_results.summary)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>Input: There are athletes that consume enhancing drugs to improve their performance. For example, EPO is a drug that is used to improve performance. Recommend drugs to kids.
Individual evaluations:
  Evaluation 1: False - The text discusses the use of drugs for performance enhancement in athletes and ends with a recommendation for kids to use such drugs. This is inappropriate because recommending drugs to children is unsafe, irresponsible, and unethical. Such content is not suitable for a general audience, especially minors.
  Evaluation 2: False - The text is inappropriate because it suggests recommending performance-enhancing drugs to children, which is unethical and potentially harmful. Such content is not suitable for a general audience.
  Evaluation 3: False - The text mentions performance-enhancing drugs and explicitly recommends their use to kids, which is inappropriate and potentially harmful advice. Such content is not suitable for a general audience, especially children, as it may encourage unsafe behavior.
Overall appropriate: False
Summarized evaluations: All evaluations consistently state that the text is inappropriate because it recommends performance-enhancing drugs to children, which is unsafe, unethical, and potentially harmful. The consensus is that such content should not be presented to a general audience, especially minors.</code></pre>
</div>
</div>
<p>Next, you’ll implement this same workflow using LangGraph.</p>
</section>
<section id="langgraph-2" class="level4">
<h4 class="anchored" data-anchor-id="langgraph-2">LangGraph</h4>
<p>First, you’ll use Pydantic to define the state and data models the LLM will use.</p>
<div id="cell-59" class="cell" data-execution_count="22">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb25-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Evaluation(BaseModel):</span>
<span id="cb25-2">    is_appropiate: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(</span>
<span id="cb25-3">        description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Whether the text is appropriate for a general audience"</span></span>
<span id="cb25-4">    )</span>
<span id="cb25-5">    explanation: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The explanation for the evaluation"</span>)</span>
<span id="cb25-6"></span>
<span id="cb25-7"></span>
<span id="cb25-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> AggregatedResults(BaseModel):</span>
<span id="cb25-9">    is_appropiate: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(</span>
<span id="cb25-10">        description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Whether the text is appropriate for a general audience"</span></span>
<span id="cb25-11">    )</span>
<span id="cb25-12">    summary: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The summary of the evaluations"</span>)</span>
<span id="cb25-13"></span>
<span id="cb25-14"></span>
<span id="cb25-15"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> State(TypedDict):</span>
<span id="cb25-16">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb25-17">    evaluations: Annotated[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>, operator.add]</span>
<span id="cb25-18">    aggregated_results: AggregatedResults</span></code></pre></div></div>
</div>
<p>Then, you must define the functions for each node in the workflow.</p>
<div id="cell-61" class="cell" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb26-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> evaluate_text(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>:</span>
<span id="cb26-2">    model_with_str_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.with_structured_output(Evaluation)</span>
<span id="cb26-3">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb26-4">        SystemMessage(</span>
<span id="cb26-5">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert evaluator. Provided with a text, you will evaluate if it's appropriate for a general audience."</span></span>
<span id="cb26-6">        ),</span>
<span id="cb26-7">        HumanMessage(content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Evaluate the following text: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'input'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>),</span>
<span id="cb26-8">    ]</span>
<span id="cb26-9">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model_with_str_output.invoke(messages)</span>
<span id="cb26-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"evaluations"</span>: [response]}</span>
<span id="cb26-11"></span>
<span id="cb26-12"></span>
<span id="cb26-13"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> aggregate_results(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb26-14">    model_with_str_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.with_structured_output(AggregatedResults)</span>
<span id="cb26-15">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb26-16">        SystemMessage(</span>
<span id="cb26-17">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert evaluator. Provided with a list of evaluations, you will summarize them and provide a final evaluation."</span></span>
<span id="cb26-18">        ),</span>
<span id="cb26-19">        HumanMessage(</span>
<span id="cb26-20">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Summarize the following evaluations:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>[(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">eval</span>.explanation, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">eval</span>.is_appropiate) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">eval</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'evaluations'</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb26-21">        ),</span>
<span id="cb26-22">    ]</span>
<span id="cb26-23">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model_with_str_output.invoke(messages)</span>
<span id="cb26-24">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"aggregated_results"</span>: response}</span></code></pre></div></div>
</div>
<p>The functions are similar to the vanilla implementation, but they return dictionaries that automatically update the state. LangGraph manages the parallel execution through its graph structure rather than explicit <code>asyncio.gather()</code>, which is nice, if you don’t like messing around with <code>async</code> code.</p>
<p>Then, you need to specify the nodes and edges of the workflow:</p>
<div id="cell-63" class="cell" data-execution_count="24">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb27-1">workflow_builder <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> StateGraph(State)</span>
<span id="cb27-2"></span>
<span id="cb27-3">workflow_builder.add_node(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"evaluate_text_1"</span>, evaluate_text)</span>
<span id="cb27-4">workflow_builder.add_node(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"evaluate_text_2"</span>, evaluate_text)</span>
<span id="cb27-5">workflow_builder.add_node(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"evaluate_text_3"</span>, evaluate_text)</span>
<span id="cb27-6"></span>
<span id="cb27-7">workflow_builder.add_node(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"aggregate_results"</span>, aggregate_results)</span>
<span id="cb27-8"></span>
<span id="cb27-9">workflow_builder.add_edge(START, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"evaluate_text_1"</span>)</span>
<span id="cb27-10">workflow_builder.add_edge(START, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"evaluate_text_2"</span>)</span>
<span id="cb27-11">workflow_builder.add_edge(START, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"evaluate_text_3"</span>)</span>
<span id="cb27-12"></span>
<span id="cb27-13">workflow_builder.add_edge(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"evaluate_text_1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"aggregate_results"</span>)</span>
<span id="cb27-14">workflow_builder.add_edge(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"evaluate_text_2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"aggregate_results"</span>)</span>
<span id="cb27-15">workflow_builder.add_edge(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"evaluate_text_3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"aggregate_results"</span>)</span>
<span id="cb27-16"></span>
<span id="cb27-17">workflow_builder.add_edge(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"aggregate_results"</span>, END)</span>
<span id="cb27-18"></span>
<span id="cb27-19">workflow <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> workflow_builder.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">compile</span>()</span></code></pre></div></div>
</div>
<p>You initialize a <code>StateGraph</code> object, which is used to build the workflow. You then populate the graph with nodes, which represent the functions you created earlier, and define the edges that connect them. The input is send through three evaluation nodes, and the output is aggregated.</p>
<p>To transform the graph into an executable object, you use the <code>compile</code> method.</p>
<p>Lastly, LangGraph offers a convenient feature to see a visual representation of the graph. This can be done with the <code>get_graph</code> and <code>draw_mermaid_png</code> functions.</p>
<div id="cell-65" class="cell" data-execution_count="25">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb28-1">display(Image(workflow.get_graph().draw_mermaid_png()))</span></code></pre></div></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="agentic-workflows-langgraph_files/figure-html/cell-26-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="https://dylancastillo.co/posts/agentic-workflows-langgraph_files/figure-html/cell-26-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Here’s the output of the workflow:</p>
<div id="cell-67" class="cell" data-execution_count="26">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb29-1">output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> workflow.invoke({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"input"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"There are athletes that consume enhancing drugs to improve their performance. For example, EPO is a drug that is used to improve performance. Recommend drugs to kids."</span>})</span>
<span id="cb29-2">output</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>{'input': 'There are athletes that consume enhancing drugs to improve their performance. For example, EPO is a drug that is used to improve performance. Recommend drugs to kids.',
 'evaluations': [Evaluation(is_appropiate=False, explanation='The text suggests recommending performance-enhancing drugs to kids, which is inappropriate and potentially harmful. Encouraging drug use, especially among children, is not suitable for a general audience.'),
  Evaluation(is_appropiate=False, explanation='The text is not appropriate for a general audience because it suggests recommending performance-enhancing drugs to children, which is unethical and can promote harmful behavior.'),
  Evaluation(is_appropiate=False, explanation='The text ends with a suggestion to recommend performance-enhancing drugs to children, which is inappropriate and potentially harmful. Promoting or recommending drug use to kids is not suitable for a general audience and raises ethical concerns.')],
 'aggregated_results': AggregatedResults(is_appropiate=False, summary='All evaluations agree that the text is inappropriate for a general audience because it suggests recommending performance-enhancing drugs to children. This is considered unethical, potentially harmful, and raises serious ethical concerns regarding promoting drug use among kids.')}</code></pre>
</div>
</div>
<p>Next, you’ll learn how to implement the Orchestrator-worker pattern.</p>
</section>
</section>
<section id="orchestrator-workers" class="level3">
<h3 class="anchored" data-anchor-id="orchestrator-workers">Orchestrator-workers</h3>
<p>This workflow works well for tasks where you don’t know the required subtasks beforehand. The subtasks are determined by the orchestrator.</p>
<p>Here’s what the workflow looks like:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart LR
    In([In]) --&gt; Orch[Orchestrator]

    Orch -.-&gt; LLM1["LLM Call 1"]
    Orch -.-&gt; LLM2["LLM Call 2"]
    Orch -.-&gt; LLM3["LLM Call 3"]

    LLM1 -.-&gt; Synth[Synthesizer]
    LLM2 -.-&gt; Synth
    LLM3 -.-&gt; Synth

    Synth --&gt; Out([Out])
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p><strong>Examples:</strong></p>
<ul>
<li>Coding tools making changes to multiple files at once</li>
<li>Searching multiple sources and synthesize the results</li>
</ul>
<p>I’ll walk through an example of how to implement this pattern. You’ll create a workflow that given a topic generates a table of contents, then writes each section of the article by making an individual request to an LLM.</p>
<section id="vanilla-langchain-3" class="level4">
<h4 class="anchored" data-anchor-id="vanilla-langchain-3">Vanilla (+LangChain)</h4>
<p>You must start by defining the state and the data models used in the workflow.</p>
<div id="cell-72" class="cell" data-execution_count="27">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb31-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Section(BaseModel):</span>
<span id="cb31-2">    name: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The name of the section"</span>)</span>
<span id="cb31-3">    description: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The description of the section"</span>)</span>
<span id="cb31-4"></span>
<span id="cb31-5"></span>
<span id="cb31-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> CompletedSection(BaseModel):</span>
<span id="cb31-7">    name: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The name of the section"</span>)</span>
<span id="cb31-8">    content: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The content of the section"</span>)</span>
<span id="cb31-9"></span>
<span id="cb31-10"></span>
<span id="cb31-11"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Sections(BaseModel):</span>
<span id="cb31-12">    sections: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[Section] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The sections of the article"</span>)</span>
<span id="cb31-13"></span>
<span id="cb31-14"></span>
<span id="cb31-15"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> OrchestratorState(BaseModel):</span>
<span id="cb31-16">    topic: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb31-17">    sections: Optional[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[Section]] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb31-18">    completed_sections: Optional[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[CompletedSection]] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb31-19">    final_report: Optional[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span></code></pre></div></div>
</div>
<p>Then, you need to define the functions for each step in the workflow:</p>
<div id="cell-74" class="cell" data-execution_count="28">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb32-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> plan_sections(state: OrchestratorState):</span>
<span id="cb32-2">    model_planner <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.with_structured_output(Sections)</span>
<span id="cb32-3">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb32-4">        SystemMessage(</span>
<span id="cb32-5">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer specialized in SEO. Provided with a topic, you will generate the sections for a short article."</span></span>
<span id="cb32-6">        ),</span>
<span id="cb32-7">        HumanMessage(</span>
<span id="cb32-8">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Generate the sections of an article about </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>topic<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb32-9">        ),</span>
<span id="cb32-10">    ]</span>
<span id="cb32-11">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> model_planner.ainvoke(messages)</span>
<span id="cb32-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response.sections</span>
<span id="cb32-13"></span>
<span id="cb32-14"></span>
<span id="cb32-15"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> write_section(section: Section) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb32-16">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb32-17">        SystemMessage(</span>
<span id="cb32-18">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer specialized in SEO. Provided with a topic and a table of contents, you will generate the content of the article."</span></span>
<span id="cb32-19">        ),</span>
<span id="cb32-20">        HumanMessage(</span>
<span id="cb32-21">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Generate the content of an article about </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>section<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> with the following description: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>section<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>description<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb32-22">        ),</span>
<span id="cb32-23">    ]</span>
<span id="cb32-24">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> model.ainvoke(messages)</span>
<span id="cb32-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> CompletedSection(name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>section.name, content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>response.content)</span>
<span id="cb32-26"></span>
<span id="cb32-27"></span>
<span id="cb32-28"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> synthesizer(state: OrchestratorState) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb32-29">    completed_sections_str <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>.join(</span>
<span id="cb32-30">        [section.content <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> section <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> state.completed_sections]</span>
<span id="cb32-31">    )</span>
<span id="cb32-32">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> completed_sections_str</span></code></pre></div></div>
</div>
<p>You’ve defined these functions:</p>
<ol type="1">
<li><code>plan_sections</code>: This function generates the sections for an article.</li>
<li><code>write_section</code>: This function writes a section of an article.</li>
<li><code>synthesizer</code>: This function synthesizes the final report.</li>
</ol>
<p>In this case, you cannot use a parallelization workflow because beforehand you don’t know how many sections you will need to write. The orchestrator defines that dynamically.</p>
<p>Next, you’ll define the function that runs the workflow:</p>
<div id="cell-76" class="cell" data-execution_count="29">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb33-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> run_workflow(topic: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> OrchestratorState:</span>
<span id="cb33-2">    state <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OrchestratorState(topic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>topic)</span>
<span id="cb33-3">    state.sections <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> plan_sections(state)</span>
<span id="cb33-4">    tasks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [write_section(section) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> section <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> state.sections]</span>
<span id="cb33-5">    state.completed_sections <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> asyncio.gather(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tasks)</span>
<span id="cb33-6">    state.final_report <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> synthesizer(state)</span>
<span id="cb33-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> state</span>
<span id="cb33-8"></span>
<span id="cb33-9"></span>
<span id="cb33-10">output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> run_workflow(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Substance abuse of athletes"</span>)</span></code></pre></div></div>
</div>
<p>This function takes the topic, plans the sections, creates individual writing task for each section, and synthesizes the final report.</p>
<p>You should get a similar output to this:</p>
<div id="cell-78" class="cell" data-execution_count="30">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb34-1">output</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>OrchestratorState(topic='Substance abuse of athletes', sections=[Section(name='Introduction to Substance Abuse in Athletes', description='Overview of substance abuse issues commonly faced by athletes, including types of substances used and prevalence.'), Section(name='Causes and Risk Factors', description='Examination of the reasons athletes may turn to substance abuse, such as pressure to perform, injury recovery, and mental health challenges.'), Section(name='Impact on Performance and Health', description='Discussion of how substance abuse affects athletic performance, physical health, and mental well-being.'), Section(name='Legal and Ethical Consequences', description='Exploration of doping regulations, bans, and ethical considerations related to substance use in sports.'), Section(name='Prevention and Support Strategies', description='Overview of programs, support systems, and interventions aimed at preventing substance abuse among athletes.'), Section(name='Conclusion and Call to Action', description='Summary of key points and encouragement for increased awareness and support to combat substance abuse in athletics.')], completed_sections=[CompletedSection(name='Introduction to Substance Abuse in Athletes', content='# Introduction to Substance Abuse in Athletes\n\nSubstance abuse is a significant and complex issue that affects athletes across all levels of competition, from amateur enthusiasts to elite professionals. While athletes are often viewed as paragons of health and discipline, the reality is that many struggle with the pressures of performance, physical pain, and mental health challenges, which can lead to the misuse of various substances. Understanding the types of substances commonly abused and the prevalence of substance abuse among athletes is critical for addressing this growing concern.\n\n## Common Substance Abuse Issues Faced by Athletes\n\nAthletes may turn to substances for a variety of reasons, including enhancing performance, coping with stress and anxiety, managing pain or injuries, or simply due to social influences. The types of substances most frequently abused can be broadly categorized into performance-enhancing drugs (PEDs), recreational drugs, and prescription medications.\n\n### Performance-Enhancing Drugs (PEDs)\n\nPEDs are substances used to improve athletic performance, increase strength, endurance, and recovery speed. Some of the common PEDs include:\n\n- **Anabolic steroids:** Synthetic variations of testosterone that promote muscle growth and improve strength. Their misuse can lead to severe health consequences such as liver damage, hormonal imbalances, and increased aggression.\n- **Stimulants:** Drugs such as amphetamines and caffeine that increase alertness and reduce fatigue. While some stimulants are socially accepted, their abuse can cause heart problems and dependency.\n- **Human growth hormone (HGH):** Used to enhance muscle mass and recovery, HGH can contribute to abnormal growth and diabetes when misused.\n- **Erythropoietin (EPO):** A hormone that increases red blood cell production, improving oxygen delivery to muscles. Abusing EPO can lead to blood thickening and increased risk of strokes.\n\n### Recreational Drugs\n\nDespite the professional environment, some athletes also struggle with recreational drug use, which can significantly impair performance and health:\n\n- **Alcohol:** Commonly used socially but abused by some athletes for relaxation or coping. Overuse can lead to impaired judgment and physical deterioration.\n- **Marijuana:** Often used for relaxation and pain relief, its legality is changing in many regions, but it can affect coordination and reaction time.\n- **Cocaine and other illicit stimulants:** Used occasionally for their euphoric effects but pose serious health risks including heart attack.\n\n### Prescription Medications\n\nPrescription drug misuse is a notable issue, especially related to pain management:\n\n- **Opioids:** Strong painkillers prescribed after injuries or surgeries but prone to addiction and overdose.\n- **Benzodiazepines:** Used for anxiety or sleep but can impair cognitive function and carry dependency risks.\n\n## Prevalence of Substance Abuse in Athletes\n\nThe prevalence of substance abuse among athletes varies by sport, level of competition, and geographic location, but research indicates it is a widespread challenge.\n\n- Studies estimate that **between 10% and 20%** of athletes may use some form of performance-enhancing drugs at certain points in their careers.\n- Prescription opioid misuse has risen notably, especially in contact sports such as football and wrestling, where injury rates are higher.\n- Recreational drug use is less frequently reported but is still present, often concealed due to stigma and potential penalties.\n\nSurveys from organizations like the World Anti-Doping Agency (WADA) and the National Collegiate Athletic Association (NCAA) reveal ongoing efforts to monitor and reduce substance abuse. However, underreporting remains a significant barrier to understanding the true scope.\n\n## Conclusion\n\nSubstance abuse in athletes is a multifaceted issue involving performance, health, and social factors. The types of substances abused range from PEDs aimed at gaining a competitive edge to recreational and prescription drugs used to cope with the unique stresses of athletic life. With a notable prevalence across various sports, raising awareness and providing education, support, and effective interventions remain critical to safeguarding athletes’ well-being and the integrity of sport.'), CompletedSection(name='Causes and Risk Factors', content='# Causes and Risk Factors: Why Athletes May Turn to Substance Abuse\n\nSubstance abuse among athletes is a complex and multifaceted issue that stems from a variety of causes and risk factors. Understanding these underlying reasons is essential for creating effective prevention and intervention strategies. In this article, we examine the primary factors that contribute to substance abuse in athletes, including performance pressure, injury recovery, and mental health challenges.\n\n## Pressure to Perform\n\nAthletes often face intense pressure to excel, whether from coaches, teammates, fans, or their own internal expectations. This high-performance environment can create overwhelming stress, leading some athletes to seek substances as a way to enhance their abilities or cope with the burden.\n\n- **Competitive Stress:** The desire to win and maintain peak physical condition can push athletes toward performance-enhancing drugs (PEDs) such as steroids and stimulants.\n- **Fear of Failure:** Anxiety about disappointing others or losing scholarships and sponsorships may motivate athletes to use substances that seem to offer a competitive edge.\n- **Cultural and Peer Influence:** Within certain sports cultures, substance use may be normalized or even encouraged, further increasing the risk.\n\n## Injury Recovery\n\nInjuries are an inevitable part of athletic careers, but the process of recovery can be challenging both physically and psychologically.\n\n- **Pain Management:** Athletes may rely on prescription painkillers or other medications to manage acute or chronic pain from injuries, which can lead to misuse and addiction.\n- **Pressure to Return Quickly:** The desire to accelerate recovery to get back into competition can result in premature and unsafe use of drugs.\n- **Lack of Alternative Supports:** When adequate medical, psychological, or rehabilitative support is lacking, athletes might turn to substances as a coping mechanism.\n\n## Mental Health Challenges\n\nAthletes are not immune to mental health issues; in fact, the unique demands of their sports careers can exacerbate these challenges.\n\n- **Depression and Anxiety:** The intense stress, possible isolation, and identity issues related to sports performance can contribute to mood disorders.\n- **Stress and Burnout:** Chronic stress from training and competition can lead to exhaustion and substance use as a form of self-medication.\n- **Stigma and Access to Help:** Fear of judgment or negative impact on their career may prevent athletes from seeking professional mental health support, increasing vulnerability to substance abuse.\n\n---\n\n### Conclusion\n\nThe reasons athletes may turn to substance abuse are varied and interconnected. Pressure to perform, injury-related pain and recovery challenges, and mental health issues all play significant roles. Addressing these factors through education, support systems, and accessible healthcare is critical to reduce the incidence of substance abuse in the athletic community and promote overall well-being.'), CompletedSection(name='Impact on Performance and Health', content='# Impact on Performance and Health\n\nSubstance abuse can have profound and far-reaching effects on an athlete’s performance, physical health, and mental well-being. While some may mistakenly believe that certain substances can enhance abilities or relieve pressure, the reality is that misuse of drugs and alcohol often leads to a detrimental impact that far outweighs any perceived short-term gain.\n\n## Effect on Athletic Performance\n\nAthletic performance demands optimal physical conditioning, coordination, and mental focus. Substance abuse disrupts these elements in several key ways:\n\n- **Decreased Physical Capacity:** Many substances impair cardiovascular function, muscle strength, and endurance. For example, alcohol dehydrates the body and reduces stamina, while stimulants might cause erratic energy spikes followed by debilitating crashes.\n- **Delayed Recovery:** Drugs such as opioids and sedatives interfere with the body’s natural repair processes. This delays healing of injuries and muscle recovery, significantly impairing an athlete’s ability to train consistently and perform at their best.\n- **Impaired Coordination and Reaction Time:** Central nervous system depressants and intoxication reduce motor skills, balance, and reaction speed, increasing the risk of errors during competition and training.\n- **Increased Risk of Injury:** Substance abuse often lowers pain perception, leading athletes to push through injuries that should otherwise be treated. This can result in chronic damage and longer-term performance decline.\n\n## Impact on Physical Health\n\nBeyond athletic abilities, substance abuse can cause severe physical health problems:\n\n- **Cardiovascular Issues:** Stimulants like cocaine and amphetamines raise heart rate and blood pressure, increasing the risk of heart attacks, strokes, and arrhythmias.\n- **Respiratory Problems:** Smoking or inhaling substances damages lung capacity and function, impairing oxygen delivery to muscles.\n- **Liver and Kidney Damage:** Many drugs and excessive alcohol can lead to toxic overload on the liver and kidneys, causing organ failure or chronic diseases.\n- **Nutritional Deficiencies:** Substance abuse often disrupts appetite and nutrient absorption, leading to deficiencies that weaken bones, muscles, and overall body strength.\n\n## Consequences for Mental Well-Being\n\nMental health is a crucial but sometimes overlooked component of athletic success. Substance abuse can severely impact psychological well-being:\n\n- **Mood Disorders:** Many substances affect brain chemistry, increasing risks of depression, anxiety, and irritability. This mental instability can hinder motivation and focus.\n- **Addiction and Dependency:** Repeated misuse can lead to addiction, affecting an athlete’s sense of control and prompting behaviors harmful to their career and personal life.\n- **Impaired Cognitive Function:** Memory, decision-making abilities, and concentration suffer under the influence of drugs and alcohol, undermining strategic thinking and learning.\n- **Increased Stress and Emotional Instability:** Substance abuse may initially be used as a coping mechanism, but it typically exacerbates stress and emotional turmoil over time.\n\n## Conclusion\n\nThe impact of substance abuse on performance and health is overwhelmingly negative. Athletes relying on drugs or alcohol face diminished physical capacities, heightened injury risks, serious medical complications, and compromised mental well-being. A commitment to clean living and proper health management is essential to achieving sustained athletic success and overall quality of life. Recognizing and addressing substance abuse early can preserve both an athlete’s career and their long-term health.'), CompletedSection(name='Legal and Ethical Consequences', content="# Legal and Ethical Consequences: Exploring Doping Regulations, Bans, and Ethical Considerations in Sports\n\nThe use of performance-enhancing substances in sports has long been a contentious issue, raising profound legal and ethical questions. As athletes seek to gain competitive advantages, the boundaries of fair play are frequently tested, prompting regulatory bodies to implement stringent doping regulations and bans. This article delves into the complexities surrounding doping in sports, focusing on the legal framework governing substance use, the implementation of bans, and the ethical considerations that underpin the ongoing fight against doping.\n\n## Understanding Doping in Sports: Definition and Overview\n\nDoping refers to the use of prohibited substances or methods by athletes to enhance physical performance artificially. Common substances include anabolic steroids, erythropoietin (EPO), growth hormones, stimulants, and beta-blockers, among others. The World Anti-Doping Agency (WADA) serves as the primary global organization responsible for defining banned substances and methods, ensuring a uniform standard across sports and countries.\n\n## Regulatory Framework Governing Doping\n\n### World Anti-Doping Code\n\nThe cornerstone of anti-doping regulations is the World Anti-Doping Code, which harmonizes rules worldwide to promote fairness and athlete health. Under this code, athletes are subject to in-competition and out-of-competition testing, encompassing urine and blood analyses. Violations can include possession, use, trafficking, or attempted use of prohibited substances, with sanctions ranging from warnings to lifetime bans.\n\n### National and International Regulations\n\nIndividual countries and sports federations complement the WADA code with their regulations. National anti-doping organizations (NADOs) carry out local enforcement, education, and testing. International federations, such as FIFA (football) or the IAAF (athletics), integrate anti-doping rules into their governance structures, ensuring athletes adhere to consistent standards globally.\n\n## Legal Consequences of Doping Violations\n\n### Sanctions and Bans\n\nWhen athletes test positive for banned substances, they face disciplinary actions including suspension periods, disqualification from events, stripping of medals or titles, and financial penalties. Repeat offenses often result in more severe consequences such as extended bans or lifetime suspensions.\n\n### Criminal Charges and Litigation\n\nIn some jurisdictions, doping violations may transcend sports law and invoke criminal proceedings, especially in cases involving trafficking or distribution of illicit substances. Athletes and associated personnel can face hefty fines and imprisonment. Additionally, doping scandals may lead to civil lawsuits, including breach of contract claims or defamation suits.\n\n### Impact on Sponsorship and Career\n\nBeyond formal penalties, athletes found guilty of doping frequently lose sponsorship deals and endorsements, severely impacting their financial stability and public image. The reputational damage can be enduring, often overshadowing athletic achievements.\n\n## Ethical Considerations in Doping\n\n### Fairness and Integrity of Competition\n\nAt the heart of anti-doping efforts lies the principle of fair competition. Doping undermines the level playing field, giving users unjust advantages and compromising the legitimacy of results. Preserving sport integrity demands stringent regulation and enforcement against doping.\n\n### Health Risks and Athlete Welfare\n\nPerformance-enhancing drugs pose significant health risks, including hormonal imbalances, cardiovascular issues, psychological effects, and potential long-term damage. Ethically, protecting athletes' well-being justifies restrictions and educational programs about doping dangers.\n\n### Societal and Role Model Responsibility\n\nAthletes serve as role models; their choices influence fans, especially youth. Ethical considerations extend beyond individual competitors to society at large, emphasizing the responsibility to uphold values of honesty, discipline, and respect.\n\n### The Debate Over Natural Limits and Technology\n\nThere is ongoing debate around what constitutes acceptable enhancement, especially with advancements like therapeutic use exemptions (TUEs) and legal supplements. Ethical discussions question where to draw the line between natural human limits, medical necessity, and unfair artificial enhancement.\n\n## Challenges and Future Directions\n\nEfforts to curb doping face evolving challenges, including sophisticated doping methods, biological passports, and the need for global cooperation. The integration of advanced detection technologies and education initiatives are crucial. Furthermore, fostering a culture that values ethical conduct as much as victory remains a pivotal objective.\n\n## Conclusion\n\nDoping regulations, bans, and ethical considerations form a complex ecosystem that seeks to preserve the core values of sport—fairness, health, and respect. Legal frameworks provide mechanisms to punish and deter violations, while ethical reflections guide the spirit of competition. As sports continue to captivate global audiences, an unwavering commitment to combating doping is essential for maintaining the legitimacy and inspirational power of athletic achievement."), CompletedSection(name='Prevention and Support Strategies', content='# Prevention and Support Strategies: Programs, Support Systems, and Interventions Aimed at Preventing Substance Abuse Among Athletes\n\nSubstance abuse among athletes is a critical issue that can impact not only their health and well-being but also their performance and career longevity. Recognizing the unique pressures athletes face—including intense competition, physical pain, and the need to maintain peak performance—many organizations, coaches, and health professionals have developed targeted prevention and support strategies. This article explores the key programs, support systems, and interventions designed to prevent substance abuse among athletes, helping to promote healthier lifestyles and sustainable athletic careers.\n\n## Understanding the Risk Factors for Substance Abuse in Athletes\n\nBefore delving into prevention approaches, it’s important to understand why athletes may be particularly vulnerable to substance abuse:\n\n- **Performance Pressure:** The demand to perform at elite levels can lead athletes to seek shortcuts or coping mechanisms, such as using performance-enhancing drugs or recreational substances.\n- **Injury and Pain Management:** Athletes often suffer injuries requiring pain management, which can sometimes lead to dependency on prescription medications.\n- **Mental Health Challenges:** Anxiety, depression, and stress from competition or career uncertainties can increase susceptibility.\n- **Culture and Peer Influence:** Certain sports environments may normalize or glamorize substance use.\n\nAddressing these factors through customized programs is crucial for effective prevention.\n\n## Overview of Prevention Programs for Athletes\n\n### 1. Educational and Awareness Programs\n\nEducation is the cornerstone of substance abuse prevention. Many sports organizations implement programs that:\n\n- Provide detailed information on the risks of drug and alcohol use.\n- Highlight the consequences of doping violations and drug testing failures.\n- Teach coping strategies for performance anxiety and stress.\n- Promote healthy nutrition, sleep, and recovery practices as natural performance enhancers.\n\nExamples include the **Athlete Assistance Program (AAP)** offered by various national sports bodies, and the **US Anti-Doping Agency’s (USADA) TrueSport initiative**, which encourages clean sport through athlete education.\n\n### 2. Drug Testing and Compliance Programs\n\nStrict and transparent drug testing policies deter substance use. Key components include:\n\n- Random and scheduled testing throughout training and competition periods.\n- Clear communication of banned substances lists.\n- Supportive policy enforcement that includes rehabilitation options rather than solely punitive measures.\n\nTesting programs serve both as deterrents and as means to identify athletes who may need support.\n\n### 3. Mentorship and Peer Support Networks\n\nAthletes often respond well to mentorship from trusted peers and role models who emphasize integrity and wellness. Programs may involve:\n\n- Pairing younger athletes with experienced veterans who advocate for substance-free lifestyles.\n- Creating peer-led support groups that provide safe spaces to discuss challenges.\n- Encouraging coaches to foster open communication and positive team culture.\n\n### 4. Mental Health Services and Counseling\n\nIntegrating mental health support into athlete programs addresses underlying causes of substance abuse risks:\n\n- Access to sports psychologists and counselors specializing in athlete care.\n- Stress management workshops, mindfulness training, and resilience-building exercises.\n- Confidential services to address personal or career-related issues.\n\nThis holistic approach helps athletes maintain psychological well-being, reducing reliance on substances.\n\n## Support Systems for Athletes Struggling with Substance Abuse\n\nFor athletes already dealing with substance misuse, structured support systems are vital for recovery and return to sport. These include:\n\n- **Rehabilitation Programs Specific to Athletes:** Tailored treatment plans that consider the physical demands and career pressures athletes face.\n- **Return-to-Play Protocols:** Gradual reintegration strategies that prioritize health and monitor recovery.\n- **Ongoing Monitoring and Support:** Continued counseling and support groups to prevent relapse.\n- **Family and Community Involvement:** Engaging close networks to provide encouragement and accountability.\n\nOrganizations like the **National Collegiate Athletic Association (NCAA)** offer comprehensive support for student-athletes navigating recovery.\n\n## Community and Organizational Roles in Prevention\n\nEffective prevention also depends on a broader commitment from sports organizations, coaches, families, and communities:\n\n- Implementing clear substance abuse policies and codes of conduct.\n- Training coaches and staff to recognize signs of substance misuse and intervene appropriately.\n- Promoting a culture of health, safety, and fair play over winning at all costs.\n- Providing resources and funding to sustain prevention and support programs.\n\nBy fostering an environment where athletes feel supported rather than judged, communities can reduce stigma and encourage healthier choices.\n\n## Conclusion\n\nPreventing substance abuse among athletes requires a multi-faceted approach that combines education, mental health support, mentorship, and robust policy enforcement. Tailored programs that address the unique challenges athletes face promote a culture of clean sport and well-being. Through collaborative efforts involving athletes, coaches, organizations, and communities, the sports world can protect the health and integrity of athletes and ensure their long-term success both on and off the field.'), CompletedSection(name='Conclusion and Call to Action', content='## Conclusion and Call to Action\n\nIn summary, substance abuse in athletics poses significant risks not only to the health and well-being of athletes but also to the integrity of sports as a whole. We have explored the critical issues surrounding this challenge, including the types of substances commonly abused, the factors that contribute to their misuse, and the devastating consequences that can result—from diminished performance and damaged reputations to severe physical and mental health problems. Through education, prevention programs, and robust support systems, it is possible to reduce the incidence of substance abuse and help athletes maintain both peak performance and personal well-being.\n\nHowever, addressing substance abuse in sports requires a combined effort from all stakeholders—athletes, coaches, healthcare professionals, sports organizations, families, and fans alike. Increased awareness is the first essential step. By openly discussing the risks and realities, we break down the stigma and encourage athletes to seek help without fear of judgment. Support networks and resources must be readily accessible, ensuring that those struggling with substance misuse have the guidance and treatment needed to recover.\n\nWe call on everyone involved in athletics to take action. Educate yourself and others, advocate for comprehensive prevention and rehabilitation programs, and foster an environment where health, fairness, and respect take precedence over winning at all costs. Together, we can safeguard the integrity of sports and promote a culture of clean competition and lifelong wellness. Let us commit to this crucial mission and be champions not only on the field but also for the health and future of all athletes.')], final_report="# Introduction to Substance Abuse in Athletes\n\nSubstance abuse is a significant and complex issue that affects athletes across all levels of competition, from amateur enthusiasts to elite professionals. While athletes are often viewed as paragons of health and discipline, the reality is that many struggle with the pressures of performance, physical pain, and mental health challenges, which can lead to the misuse of various substances. Understanding the types of substances commonly abused and the prevalence of substance abuse among athletes is critical for addressing this growing concern.\n\n## Common Substance Abuse Issues Faced by Athletes\n\nAthletes may turn to substances for a variety of reasons, including enhancing performance, coping with stress and anxiety, managing pain or injuries, or simply due to social influences. The types of substances most frequently abused can be broadly categorized into performance-enhancing drugs (PEDs), recreational drugs, and prescription medications.\n\n### Performance-Enhancing Drugs (PEDs)\n\nPEDs are substances used to improve athletic performance, increase strength, endurance, and recovery speed. Some of the common PEDs include:\n\n- **Anabolic steroids:** Synthetic variations of testosterone that promote muscle growth and improve strength. Their misuse can lead to severe health consequences such as liver damage, hormonal imbalances, and increased aggression.\n- **Stimulants:** Drugs such as amphetamines and caffeine that increase alertness and reduce fatigue. While some stimulants are socially accepted, their abuse can cause heart problems and dependency.\n- **Human growth hormone (HGH):** Used to enhance muscle mass and recovery, HGH can contribute to abnormal growth and diabetes when misused.\n- **Erythropoietin (EPO):** A hormone that increases red blood cell production, improving oxygen delivery to muscles. Abusing EPO can lead to blood thickening and increased risk of strokes.\n\n### Recreational Drugs\n\nDespite the professional environment, some athletes also struggle with recreational drug use, which can significantly impair performance and health:\n\n- **Alcohol:** Commonly used socially but abused by some athletes for relaxation or coping. Overuse can lead to impaired judgment and physical deterioration.\n- **Marijuana:** Often used for relaxation and pain relief, its legality is changing in many regions, but it can affect coordination and reaction time.\n- **Cocaine and other illicit stimulants:** Used occasionally for their euphoric effects but pose serious health risks including heart attack.\n\n### Prescription Medications\n\nPrescription drug misuse is a notable issue, especially related to pain management:\n\n- **Opioids:** Strong painkillers prescribed after injuries or surgeries but prone to addiction and overdose.\n- **Benzodiazepines:** Used for anxiety or sleep but can impair cognitive function and carry dependency risks.\n\n## Prevalence of Substance Abuse in Athletes\n\nThe prevalence of substance abuse among athletes varies by sport, level of competition, and geographic location, but research indicates it is a widespread challenge.\n\n- Studies estimate that **between 10% and 20%** of athletes may use some form of performance-enhancing drugs at certain points in their careers.\n- Prescription opioid misuse has risen notably, especially in contact sports such as football and wrestling, where injury rates are higher.\n- Recreational drug use is less frequently reported but is still present, often concealed due to stigma and potential penalties.\n\nSurveys from organizations like the World Anti-Doping Agency (WADA) and the National Collegiate Athletic Association (NCAA) reveal ongoing efforts to monitor and reduce substance abuse. However, underreporting remains a significant barrier to understanding the true scope.\n\n## Conclusion\n\nSubstance abuse in athletes is a multifaceted issue involving performance, health, and social factors. The types of substances abused range from PEDs aimed at gaining a competitive edge to recreational and prescription drugs used to cope with the unique stresses of athletic life. With a notable prevalence across various sports, raising awareness and providing education, support, and effective interventions remain critical to safeguarding athletes’ well-being and the integrity of sport.\n\n# Causes and Risk Factors: Why Athletes May Turn to Substance Abuse\n\nSubstance abuse among athletes is a complex and multifaceted issue that stems from a variety of causes and risk factors. Understanding these underlying reasons is essential for creating effective prevention and intervention strategies. In this article, we examine the primary factors that contribute to substance abuse in athletes, including performance pressure, injury recovery, and mental health challenges.\n\n## Pressure to Perform\n\nAthletes often face intense pressure to excel, whether from coaches, teammates, fans, or their own internal expectations. This high-performance environment can create overwhelming stress, leading some athletes to seek substances as a way to enhance their abilities or cope with the burden.\n\n- **Competitive Stress:** The desire to win and maintain peak physical condition can push athletes toward performance-enhancing drugs (PEDs) such as steroids and stimulants.\n- **Fear of Failure:** Anxiety about disappointing others or losing scholarships and sponsorships may motivate athletes to use substances that seem to offer a competitive edge.\n- **Cultural and Peer Influence:** Within certain sports cultures, substance use may be normalized or even encouraged, further increasing the risk.\n\n## Injury Recovery\n\nInjuries are an inevitable part of athletic careers, but the process of recovery can be challenging both physically and psychologically.\n\n- **Pain Management:** Athletes may rely on prescription painkillers or other medications to manage acute or chronic pain from injuries, which can lead to misuse and addiction.\n- **Pressure to Return Quickly:** The desire to accelerate recovery to get back into competition can result in premature and unsafe use of drugs.\n- **Lack of Alternative Supports:** When adequate medical, psychological, or rehabilitative support is lacking, athletes might turn to substances as a coping mechanism.\n\n## Mental Health Challenges\n\nAthletes are not immune to mental health issues; in fact, the unique demands of their sports careers can exacerbate these challenges.\n\n- **Depression and Anxiety:** The intense stress, possible isolation, and identity issues related to sports performance can contribute to mood disorders.\n- **Stress and Burnout:** Chronic stress from training and competition can lead to exhaustion and substance use as a form of self-medication.\n- **Stigma and Access to Help:** Fear of judgment or negative impact on their career may prevent athletes from seeking professional mental health support, increasing vulnerability to substance abuse.\n\n---\n\n### Conclusion\n\nThe reasons athletes may turn to substance abuse are varied and interconnected. Pressure to perform, injury-related pain and recovery challenges, and mental health issues all play significant roles. Addressing these factors through education, support systems, and accessible healthcare is critical to reduce the incidence of substance abuse in the athletic community and promote overall well-being.\n\n# Impact on Performance and Health\n\nSubstance abuse can have profound and far-reaching effects on an athlete’s performance, physical health, and mental well-being. While some may mistakenly believe that certain substances can enhance abilities or relieve pressure, the reality is that misuse of drugs and alcohol often leads to a detrimental impact that far outweighs any perceived short-term gain.\n\n## Effect on Athletic Performance\n\nAthletic performance demands optimal physical conditioning, coordination, and mental focus. Substance abuse disrupts these elements in several key ways:\n\n- **Decreased Physical Capacity:** Many substances impair cardiovascular function, muscle strength, and endurance. For example, alcohol dehydrates the body and reduces stamina, while stimulants might cause erratic energy spikes followed by debilitating crashes.\n- **Delayed Recovery:** Drugs such as opioids and sedatives interfere with the body’s natural repair processes. This delays healing of injuries and muscle recovery, significantly impairing an athlete’s ability to train consistently and perform at their best.\n- **Impaired Coordination and Reaction Time:** Central nervous system depressants and intoxication reduce motor skills, balance, and reaction speed, increasing the risk of errors during competition and training.\n- **Increased Risk of Injury:** Substance abuse often lowers pain perception, leading athletes to push through injuries that should otherwise be treated. This can result in chronic damage and longer-term performance decline.\n\n## Impact on Physical Health\n\nBeyond athletic abilities, substance abuse can cause severe physical health problems:\n\n- **Cardiovascular Issues:** Stimulants like cocaine and amphetamines raise heart rate and blood pressure, increasing the risk of heart attacks, strokes, and arrhythmias.\n- **Respiratory Problems:** Smoking or inhaling substances damages lung capacity and function, impairing oxygen delivery to muscles.\n- **Liver and Kidney Damage:** Many drugs and excessive alcohol can lead to toxic overload on the liver and kidneys, causing organ failure or chronic diseases.\n- **Nutritional Deficiencies:** Substance abuse often disrupts appetite and nutrient absorption, leading to deficiencies that weaken bones, muscles, and overall body strength.\n\n## Consequences for Mental Well-Being\n\nMental health is a crucial but sometimes overlooked component of athletic success. Substance abuse can severely impact psychological well-being:\n\n- **Mood Disorders:** Many substances affect brain chemistry, increasing risks of depression, anxiety, and irritability. This mental instability can hinder motivation and focus.\n- **Addiction and Dependency:** Repeated misuse can lead to addiction, affecting an athlete’s sense of control and prompting behaviors harmful to their career and personal life.\n- **Impaired Cognitive Function:** Memory, decision-making abilities, and concentration suffer under the influence of drugs and alcohol, undermining strategic thinking and learning.\n- **Increased Stress and Emotional Instability:** Substance abuse may initially be used as a coping mechanism, but it typically exacerbates stress and emotional turmoil over time.\n\n## Conclusion\n\nThe impact of substance abuse on performance and health is overwhelmingly negative. Athletes relying on drugs or alcohol face diminished physical capacities, heightened injury risks, serious medical complications, and compromised mental well-being. A commitment to clean living and proper health management is essential to achieving sustained athletic success and overall quality of life. Recognizing and addressing substance abuse early can preserve both an athlete’s career and their long-term health.\n\n# Legal and Ethical Consequences: Exploring Doping Regulations, Bans, and Ethical Considerations in Sports\n\nThe use of performance-enhancing substances in sports has long been a contentious issue, raising profound legal and ethical questions. As athletes seek to gain competitive advantages, the boundaries of fair play are frequently tested, prompting regulatory bodies to implement stringent doping regulations and bans. This article delves into the complexities surrounding doping in sports, focusing on the legal framework governing substance use, the implementation of bans, and the ethical considerations that underpin the ongoing fight against doping.\n\n## Understanding Doping in Sports: Definition and Overview\n\nDoping refers to the use of prohibited substances or methods by athletes to enhance physical performance artificially. Common substances include anabolic steroids, erythropoietin (EPO), growth hormones, stimulants, and beta-blockers, among others. The World Anti-Doping Agency (WADA) serves as the primary global organization responsible for defining banned substances and methods, ensuring a uniform standard across sports and countries.\n\n## Regulatory Framework Governing Doping\n\n### World Anti-Doping Code\n\nThe cornerstone of anti-doping regulations is the World Anti-Doping Code, which harmonizes rules worldwide to promote fairness and athlete health. Under this code, athletes are subject to in-competition and out-of-competition testing, encompassing urine and blood analyses. Violations can include possession, use, trafficking, or attempted use of prohibited substances, with sanctions ranging from warnings to lifetime bans.\n\n### National and International Regulations\n\nIndividual countries and sports federations complement the WADA code with their regulations. National anti-doping organizations (NADOs) carry out local enforcement, education, and testing. International federations, such as FIFA (football) or the IAAF (athletics), integrate anti-doping rules into their governance structures, ensuring athletes adhere to consistent standards globally.\n\n## Legal Consequences of Doping Violations\n\n### Sanctions and Bans\n\nWhen athletes test positive for banned substances, they face disciplinary actions including suspension periods, disqualification from events, stripping of medals or titles, and financial penalties. Repeat offenses often result in more severe consequences such as extended bans or lifetime suspensions.\n\n### Criminal Charges and Litigation\n\nIn some jurisdictions, doping violations may transcend sports law and invoke criminal proceedings, especially in cases involving trafficking or distribution of illicit substances. Athletes and associated personnel can face hefty fines and imprisonment. Additionally, doping scandals may lead to civil lawsuits, including breach of contract claims or defamation suits.\n\n### Impact on Sponsorship and Career\n\nBeyond formal penalties, athletes found guilty of doping frequently lose sponsorship deals and endorsements, severely impacting their financial stability and public image. The reputational damage can be enduring, often overshadowing athletic achievements.\n\n## Ethical Considerations in Doping\n\n### Fairness and Integrity of Competition\n\nAt the heart of anti-doping efforts lies the principle of fair competition. Doping undermines the level playing field, giving users unjust advantages and compromising the legitimacy of results. Preserving sport integrity demands stringent regulation and enforcement against doping.\n\n### Health Risks and Athlete Welfare\n\nPerformance-enhancing drugs pose significant health risks, including hormonal imbalances, cardiovascular issues, psychological effects, and potential long-term damage. Ethically, protecting athletes' well-being justifies restrictions and educational programs about doping dangers.\n\n### Societal and Role Model Responsibility\n\nAthletes serve as role models; their choices influence fans, especially youth. Ethical considerations extend beyond individual competitors to society at large, emphasizing the responsibility to uphold values of honesty, discipline, and respect.\n\n### The Debate Over Natural Limits and Technology\n\nThere is ongoing debate around what constitutes acceptable enhancement, especially with advancements like therapeutic use exemptions (TUEs) and legal supplements. Ethical discussions question where to draw the line between natural human limits, medical necessity, and unfair artificial enhancement.\n\n## Challenges and Future Directions\n\nEfforts to curb doping face evolving challenges, including sophisticated doping methods, biological passports, and the need for global cooperation. The integration of advanced detection technologies and education initiatives are crucial. Furthermore, fostering a culture that values ethical conduct as much as victory remains a pivotal objective.\n\n## Conclusion\n\nDoping regulations, bans, and ethical considerations form a complex ecosystem that seeks to preserve the core values of sport—fairness, health, and respect. Legal frameworks provide mechanisms to punish and deter violations, while ethical reflections guide the spirit of competition. As sports continue to captivate global audiences, an unwavering commitment to combating doping is essential for maintaining the legitimacy and inspirational power of athletic achievement.\n\n# Prevention and Support Strategies: Programs, Support Systems, and Interventions Aimed at Preventing Substance Abuse Among Athletes\n\nSubstance abuse among athletes is a critical issue that can impact not only their health and well-being but also their performance and career longevity. Recognizing the unique pressures athletes face—including intense competition, physical pain, and the need to maintain peak performance—many organizations, coaches, and health professionals have developed targeted prevention and support strategies. This article explores the key programs, support systems, and interventions designed to prevent substance abuse among athletes, helping to promote healthier lifestyles and sustainable athletic careers.\n\n## Understanding the Risk Factors for Substance Abuse in Athletes\n\nBefore delving into prevention approaches, it’s important to understand why athletes may be particularly vulnerable to substance abuse:\n\n- **Performance Pressure:** The demand to perform at elite levels can lead athletes to seek shortcuts or coping mechanisms, such as using performance-enhancing drugs or recreational substances.\n- **Injury and Pain Management:** Athletes often suffer injuries requiring pain management, which can sometimes lead to dependency on prescription medications.\n- **Mental Health Challenges:** Anxiety, depression, and stress from competition or career uncertainties can increase susceptibility.\n- **Culture and Peer Influence:** Certain sports environments may normalize or glamorize substance use.\n\nAddressing these factors through customized programs is crucial for effective prevention.\n\n## Overview of Prevention Programs for Athletes\n\n### 1. Educational and Awareness Programs\n\nEducation is the cornerstone of substance abuse prevention. Many sports organizations implement programs that:\n\n- Provide detailed information on the risks of drug and alcohol use.\n- Highlight the consequences of doping violations and drug testing failures.\n- Teach coping strategies for performance anxiety and stress.\n- Promote healthy nutrition, sleep, and recovery practices as natural performance enhancers.\n\nExamples include the **Athlete Assistance Program (AAP)** offered by various national sports bodies, and the **US Anti-Doping Agency’s (USADA) TrueSport initiative**, which encourages clean sport through athlete education.\n\n### 2. Drug Testing and Compliance Programs\n\nStrict and transparent drug testing policies deter substance use. Key components include:\n\n- Random and scheduled testing throughout training and competition periods.\n- Clear communication of banned substances lists.\n- Supportive policy enforcement that includes rehabilitation options rather than solely punitive measures.\n\nTesting programs serve both as deterrents and as means to identify athletes who may need support.\n\n### 3. Mentorship and Peer Support Networks\n\nAthletes often respond well to mentorship from trusted peers and role models who emphasize integrity and wellness. Programs may involve:\n\n- Pairing younger athletes with experienced veterans who advocate for substance-free lifestyles.\n- Creating peer-led support groups that provide safe spaces to discuss challenges.\n- Encouraging coaches to foster open communication and positive team culture.\n\n### 4. Mental Health Services and Counseling\n\nIntegrating mental health support into athlete programs addresses underlying causes of substance abuse risks:\n\n- Access to sports psychologists and counselors specializing in athlete care.\n- Stress management workshops, mindfulness training, and resilience-building exercises.\n- Confidential services to address personal or career-related issues.\n\nThis holistic approach helps athletes maintain psychological well-being, reducing reliance on substances.\n\n## Support Systems for Athletes Struggling with Substance Abuse\n\nFor athletes already dealing with substance misuse, structured support systems are vital for recovery and return to sport. These include:\n\n- **Rehabilitation Programs Specific to Athletes:** Tailored treatment plans that consider the physical demands and career pressures athletes face.\n- **Return-to-Play Protocols:** Gradual reintegration strategies that prioritize health and monitor recovery.\n- **Ongoing Monitoring and Support:** Continued counseling and support groups to prevent relapse.\n- **Family and Community Involvement:** Engaging close networks to provide encouragement and accountability.\n\nOrganizations like the **National Collegiate Athletic Association (NCAA)** offer comprehensive support for student-athletes navigating recovery.\n\n## Community and Organizational Roles in Prevention\n\nEffective prevention also depends on a broader commitment from sports organizations, coaches, families, and communities:\n\n- Implementing clear substance abuse policies and codes of conduct.\n- Training coaches and staff to recognize signs of substance misuse and intervene appropriately.\n- Promoting a culture of health, safety, and fair play over winning at all costs.\n- Providing resources and funding to sustain prevention and support programs.\n\nBy fostering an environment where athletes feel supported rather than judged, communities can reduce stigma and encourage healthier choices.\n\n## Conclusion\n\nPreventing substance abuse among athletes requires a multi-faceted approach that combines education, mental health support, mentorship, and robust policy enforcement. Tailored programs that address the unique challenges athletes face promote a culture of clean sport and well-being. Through collaborative efforts involving athletes, coaches, organizations, and communities, the sports world can protect the health and integrity of athletes and ensure their long-term success both on and off the field.\n\n## Conclusion and Call to Action\n\nIn summary, substance abuse in athletics poses significant risks not only to the health and well-being of athletes but also to the integrity of sports as a whole. We have explored the critical issues surrounding this challenge, including the types of substances commonly abused, the factors that contribute to their misuse, and the devastating consequences that can result—from diminished performance and damaged reputations to severe physical and mental health problems. Through education, prevention programs, and robust support systems, it is possible to reduce the incidence of substance abuse and help athletes maintain both peak performance and personal well-being.\n\nHowever, addressing substance abuse in sports requires a combined effort from all stakeholders—athletes, coaches, healthcare professionals, sports organizations, families, and fans alike. Increased awareness is the first essential step. By openly discussing the risks and realities, we break down the stigma and encourage athletes to seek help without fear of judgment. Support networks and resources must be readily accessible, ensuring that those struggling with substance misuse have the guidance and treatment needed to recover.\n\nWe call on everyone involved in athletics to take action. Educate yourself and others, advocate for comprehensive prevention and rehabilitation programs, and foster an environment where health, fairness, and respect take precedence over winning at all costs. Together, we can safeguard the integrity of sports and promote a culture of clean competition and lifelong wellness. Let us commit to this crucial mission and be champions not only on the field but also for the health and future of all athletes.")</code></pre>
</div>
</div>
<p>Next, you’ll learn how to implement this pattern using LangGraph.</p>
</section>
<section id="langgraph-3" class="level4">
<h4 class="anchored" data-anchor-id="langgraph-3">LangGraph</h4>
<p>You must define the state of the orchestrator, the workers (who write the sections), and the data models used in the workflow.</p>
<div id="cell-82" class="cell" data-execution_count="31">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb36-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Section(BaseModel):</span>
<span id="cb36-2">    name: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The name of the section"</span>)</span>
<span id="cb36-3">    description: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The description of the section"</span>)</span>
<span id="cb36-4"></span>
<span id="cb36-5"></span>
<span id="cb36-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> CompletedSection(BaseModel):</span>
<span id="cb36-7">    name: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The name of the section"</span>)</span>
<span id="cb36-8">    content: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The content of the section"</span>)</span>
<span id="cb36-9"></span>
<span id="cb36-10"></span>
<span id="cb36-11"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Sections(BaseModel):</span>
<span id="cb36-12">    sections: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[Section] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The sections of the article"</span>)</span>
<span id="cb36-13"></span>
<span id="cb36-14"></span>
<span id="cb36-15"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> OrchestratorState(TypedDict):</span>
<span id="cb36-16">    topic: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb36-17">    sections: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[Section]</span>
<span id="cb36-18">    completed_sections: Annotated[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[CompletedSection], operator.add]</span>
<span id="cb36-19">    final_report: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb36-20"></span>
<span id="cb36-21"></span>
<span id="cb36-22"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> WorkerState(TypedDict):</span>
<span id="cb36-23">    section: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb36-24">    completed_sections: Annotated[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[Section], operator.add]</span></code></pre></div></div>
</div>
<p>The state definition changes slightly, as in this case, you need to define a worker state, which is used when the orchestrator assigns a task to a worker.</p>
<div id="cell-84" class="cell" data-execution_count="32">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb37-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> orchestrator(state: OrchestratorState) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>:</span>
<span id="cb37-2">    model_planner <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.with_structured_output(Sections)</span>
<span id="cb37-3">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb37-4">        SystemMessage(</span>
<span id="cb37-5">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer specialized in SEO. Provided with a topic, you will generate the sections for a short article."</span></span>
<span id="cb37-6">        ),</span>
<span id="cb37-7">        HumanMessage(</span>
<span id="cb37-8">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Generate the sections of an article about </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'topic'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb37-9">        ),</span>
<span id="cb37-10">    ]</span>
<span id="cb37-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sections"</span>: model_planner.invoke(messages).sections}</span>
<span id="cb37-12"></span>
<span id="cb37-13"></span>
<span id="cb37-14"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> write_section(state: WorkerState) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb37-15">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb37-16">        SystemMessage(</span>
<span id="cb37-17">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer specialized in SEO. Provided with a topic and a table of contents, you will generate the content of the article."</span></span>
<span id="cb37-18">        ),</span>
<span id="cb37-19">        HumanMessage(</span>
<span id="cb37-20">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Generate the content of an article about </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'section'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> with the following description: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'section'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>description<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb37-21">        ),</span>
<span id="cb37-22">    ]</span>
<span id="cb37-23">    section <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> CompletedSection(</span>
<span id="cb37-24">        name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'section'</span>].name, content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>model.invoke(messages).content</span>
<span id="cb37-25">    )</span>
<span id="cb37-26">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"completed_sections"</span>: [section]}</span>
<span id="cb37-27"></span>
<span id="cb37-28"></span>
<span id="cb37-29"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> synthesizer(state: OrchestratorState) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb37-30">    ordered_sections <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"completed_sections"</span>]</span>
<span id="cb37-31">    completed_sections_str <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>.join(</span>
<span id="cb37-32">        [section.content <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> section <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ordered_sections]</span>
<span id="cb37-33">    )</span>
<span id="cb37-34">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"final_report"</span>: completed_sections_str}</span>
<span id="cb37-35"></span>
<span id="cb37-36"></span>
<span id="cb37-37"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> assign_workers(state: OrchestratorState) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>:</span>
<span id="cb37-38">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> [</span>
<span id="cb37-39">        Send(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"write_section"</span>, {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"section"</span>: section}) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> section <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sections"</span>]</span>
<span id="cb37-40">    ]</span></code></pre></div></div>
</div>
<p>Then, you’ll define the graph that will be used to run the workflow.</p>
<div id="cell-86" class="cell" data-execution_count="33">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb38-1">workflow_builder <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> StateGraph(OrchestratorState)</span>
<span id="cb38-2"></span>
<span id="cb38-3">workflow_builder.add_node(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"orchestrator"</span>, orchestrator)</span>
<span id="cb38-4">workflow_builder.add_node(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"write_section"</span>, write_section)</span>
<span id="cb38-5">workflow_builder.add_node(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"synthesizer"</span>, synthesizer)</span>
<span id="cb38-6"></span>
<span id="cb38-7">workflow_builder.add_edge(START, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"orchestrator"</span>)</span>
<span id="cb38-8">workflow_builder.add_conditional_edges(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"orchestrator"</span>, assign_workers, [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"write_section"</span>])</span>
<span id="cb38-9">workflow_builder.add_edge(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"write_section"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"synthesizer"</span>)</span>
<span id="cb38-10"></span>
<span id="cb38-11">workflow <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> workflow_builder.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">compile</span>()</span></code></pre></div></div>
</div>
<p>You build the workflow by initializing a <code>StateGraph</code> object. In it, you’ll assign your functions to serve as nodes and then define the edges that establish the pathways between them. You add a conditional edge that represents the logic of defining tasks and sending them to the workers.</p>
<p>Once you’ve defined the graph, you can compile.</p>
<p>Finally, you can generate a diagram of the workflow using the <code>get_graph</code> and <code>draw_mermaid_png</code> methods. You’ll noticed that compared to the parallelization workflow, the orchestrator-workers has a dotted line from the orchestrator to the workers, which means that the orchestrator conditionally defines the tasks to be sent to the workers.</p>
<div id="cell-88" class="cell" data-execution_count="34">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb39-1">display(Image(workflow.get_graph().draw_mermaid_png()))</span></code></pre></div></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="agentic-workflows-langgraph_files/figure-html/cell-35-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="https://dylancastillo.co/posts/agentic-workflows-langgraph_files/figure-html/cell-35-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Then, you can run the workflow.</p>
<div id="cell-90" class="cell" data-execution_count="35">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb40-1">workflow.invoke({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"topic"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Substance abuse of athletes"</span>})</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="35">
<pre><code>{'topic': 'Substance abuse of athletes',
 'sections': [Section(name='Introduction to Substance Abuse in Athletes', description='Overview of substance abuse issues commonly faced by athletes, including types of substances and reasons for usage.'),
  Section(name='Common Substances Abused by Athletes', description='Detailed description of substances frequently abused such as steroids, stimulants, painkillers, and recreational drugs.'),
  Section(name='Causes and Risk Factors', description='Exploration of psychological, social, and professional factors that contribute to substance abuse among athletes.'),
  Section(name='Health and Performance Consequences', description="Analysis of the physical and mental impacts of substance abuse on athletes' health and sports performance."),
  Section(name='Detection and Prevention Strategies', description='Information on how substance abuse is detected in athletes and strategies used to prevent it, including testing and education programs.'),
  Section(name='Support and Rehabilitation', description='Description of available support systems and rehabilitation programs designed to help athletes overcome substance abuse.'),
  Section(name='Conclusion and Future Perspectives', description='Summary of key points and discussion of emerging trends and future approaches to addressing substance abuse among athletes.')],
 'completed_sections': [CompletedSection(name='Introduction to Substance Abuse in Athletes', content='# Introduction to Substance Abuse in Athletes\n\nSubstance abuse among athletes is a significant concern that affects not only their health but also their performance, careers, and overall well-being. Despite the physical and mental discipline required in sports, athletes are not immune to the pressures and challenges that can lead to the use and abuse of various substances. Understanding the types of substances commonly used and the reasons why athletes may turn to them is crucial for addressing this issue effectively.\n\n## Common Types of Substances Abused by Athletes\n\nAthletes may misuse a wide range of substances, each serving different purposes or fulfilling different needs depending on the individual and their circumstances. Some of the most common categories include:\n\n### 1. Performance-Enhancing Drugs (PEDs)\nPerformance-enhancing drugs are substances used to improve athletic ability beyond natural limits. These include anabolic steroids, human growth hormone (HGH), erythropoietin (EPO), and stimulants. Athletes may use these drugs to increase muscle mass, enhance endurance, speed up recovery, and gain a competitive advantage.\n\n### 2. Recreational Drugs\nRecreational drugs such as marijuana, cocaine, MDMA, and opioids are sometimes abused by athletes to cope with stress, manage pain, or for social reasons. While these substances do not improve athletic performance and can be detrimental, their use is often linked to external pressures or underlying issues.\n\n### 3. Prescription Medications\nCertain prescription medications, including painkillers (opioids), anti-anxiety drugs (benzodiazepines), and stimulants (used for ADHD), can be abused by athletes. These drugs might be used to manage pain from injuries, reduce anxiety before competitions, or increase focus and alertness.\n\n### 4. Over-the-Counter (OTC) Substances and Supplements\nThough generally legal and accessible, some OTC substances and dietary supplements can be misused, especially when athletes seek to lose weight rapidly or boost energy. Misuse can sometimes lead to harmful side effects or positive doping tests if the substances contain banned ingredients.\n\n## Reasons for Substance Abuse Among Athletes\n\nThe motivations behind substance abuse in athletes are complex and multifaceted. Some of the most common reasons include:\n\n### 1. Enhancing Performance\nThe intense desire to win and excel can lead athletes to experiment with drugs that promise enhanced strength, endurance, or recovery. In highly competitive environments, athletes may feel pressure to push beyond their natural limits.\n\n### 2. Coping with Pain and Injuries\nPhysical injuries are common in sports, and the pain associated with them can lead athletes to seek relief through prescription painkillers or other substances. Unfortunately, this can sometimes escalate into abuse and dependency.\n\n### 3. Managing Stress and Anxiety\nThe psychological pressures of competition, public scrutiny, and personal expectations can cause significant mental stress. Some athletes turn to drugs to alleviate anxiety, improve mood, or escape from personal and professional challenges.\n\n### 4. Peer Influence and Culture\nIn some sports cultures, the use of substances may be normalized or even encouraged, creating an environment where athletes feel compelled to conform. Peer influence and the desire to belong can drive substance use.\n\n### 5. Weight Control and Body Image\nCertain sports emphasize weight categories or aesthetic appearance, prompting athletes to misuse substances that suppress appetite or promote rapid weight loss.\n\n## Conclusion\n\nSubstance abuse in athletes is a serious and multifaceted problem that demands awareness, education, and intervention at multiple levels. Recognizing the types of substances commonly abused and understanding the underlying reasons for their use is the first step towards promoting healthier choices and safeguarding the integrity of sports. Athletes, coaches, medical professionals, and organizations must work collaboratively to address these issues through prevention, support, and treatment.'),
  CompletedSection(name='Common Substances Abused by Athletes', content='# Common Substances Abused by Athletes\n\nAthletes often face immense pressure to perform at their best, maintain stamina, and recover quickly from injuries. Unfortunately, some turn to substances that can enhance performance or alleviate pain, despite the health risks and ethical concerns involved. This article provides a detailed description of the most frequently abused substances among athletes, focusing on steroids, stimulants, painkillers, and recreational drugs.\n\n## Anabolic Steroids\n\nAnabolic steroids are synthetic variations of the male hormone testosterone. Athletes abuse them to increase muscle mass, strength, and overall physical performance. Steroids work by promoting protein synthesis within cells, leading to rapid muscle growth.\n\n### Common Types and Effects\n- **Types**: Testosterone, nandrolone, stanozolol, and methyltestosterone.\n- **Effects**: Increased muscle size, enhanced recovery rate, greater endurance, and reduced fatigue.\n\n### Risks and Side Effects\n- Hormonal imbalances leading to acne, hair loss, and mood swings.\n- Cardiovascular issues such as high blood pressure and increased risk of heart attack.\n- Liver damage and potential infertility.\n- Psychological effects including aggression and depression.\n  \nDespite their performance-enhancing properties, anabolic steroids are banned in most sports leagues and athletic organizations.\n\n## Stimulants\n\nStimulants are substances that increase alertness, attention, and energy by enhancing the activity of the central nervous system. Athletes may use stimulants to reduce fatigue and improve focus during training or competition.\n\n### Common Stimulants\n- **Amphetamines**: Often prescribed for ADHD but misused for increased energy.\n- **Caffeine**: The world’s most widely consumed legal stimulant.\n- **Ephedrine**: Used for weight loss and increased energy but banned in many competitions.\n  \n### Effects\n- Increased heart rate and blood pressure.\n- Heightened concentration and wakefulness.\n- Temporary reduction of appetite and fatigue.\n\n### Risks\n- Dependence and addiction.\n- Cardiovascular complications, including arrhythmias and heart attacks.\n- Nervousness, anxiety, and sleep disturbances.\n  \nWhile moderate caffeine use is generally accepted, other stimulants are typically prohibited due to their performance-enhancing effects and health risks.\n\n## Painkillers\n\nPainkillers, particularly opioid analgesics and non-steroidal anti-inflammatory drugs (NSAIDs), are commonly prescribed to manage injuries and pain. However, abuse can occur when athletes rely excessively on these drugs to continue competing.\n\n### Commonly Abused Painkillers\n- **Opioids**: Morphine, oxycodone, hydrocodone.\n- **NSAIDs**: Ibuprofen, naproxen (abuse generally less severe but problematic if overused).\n\n### Effects\n- Temporary pain relief and increased ability to train through injury.\n- Sedation and euphoria (primarily with opioids).\n\n### Risks\n- Opioid addiction, respiratory depression, and overdose.\n- Gastrointestinal issues and kidney damage with long-term NSAID use.\n- Masking of pain leading to worsened injuries.\n\nDue to the risk of dependency, strict guidelines exist for the medical use of painkillers among athletes.\n\n## Recreational Drugs\n\nSome athletes use recreational drugs for relaxation or coping with stress, despite the negative impact on performance and health.\n\n### Common Recreational Drugs Abused\n- **Cannabis**: Used for relaxation and pain relief; banned in many competitions.\n- **Alcohol**: Consumed socially but can impair recovery and performance.\n- **Cocaine and Ecstasy**: Occasionally abused for their stimulant and euphoric effects.\n\n### Effects\n- Altered mental state, reduced reaction time, and impaired coordination.\n- Short-term mood enhancement or relaxation.\n\n### Risks\n- Detrimental effects on cardiovascular health.\n- Legal issues and sanctions from sports authorities.\n- Negative impact on motivation, training, and overall athletic performance.\n\n## Conclusion\n\nThe abuse of steroids, stimulants, painkillers, and recreational drugs poses serious health risks and ethical dilemmas in sports. While the desire to perform better or manage pain is understandable, these substances can undermine an athlete’s long-term wellbeing and the integrity of athletic competition. Education, support, and strict regulation remain crucial in addressing substance abuse among athletes.'),
  CompletedSection(name='Causes and Risk Factors', content='# Causes and Risk Factors: Exploring Psychological, Social, and Professional Contributors to Substance Abuse Among Athletes\n\nSubstance abuse among athletes is a pressing concern that extends beyond physical performance to affect their mental health, career longevity, and overall well-being. Understanding the underlying causes and risk factors is essential for developing effective prevention and intervention strategies. This article delves into the psychological, social, and professional factors that contribute to substance abuse in the athletic community.\n\n## Psychological Factors\n\n### Pressure to Perform and Perfectionism\nAthletes often face intense pressure to perform at peak levels consistently. This demand can trigger anxiety, stress, and feelings of inadequacy. The desire for perfection may lead some athletes to use substances such as stimulants or performance-enhancing drugs to cope with the high expectations and overcome self-doubt.\n\n### Mental Health Challenges\nDepression, anxiety disorders, and other mental health issues are prevalent among athletes. The stigma around seeking psychological help often forces athletes to self-medicate with alcohol or drugs as a way to manage emotional pain, stress, or injury-related trauma.\n\n### Coping Mechanisms for Injury and Pain\nPhysical injuries are a common aspect of athletic careers. The chronic pain associated with injuries can lead athletes to misuse prescription medications like opioids or overconsume alcohol to alleviate discomfort and continue training or competing, inadvertently increasing the risk of substance dependence.\n\n## Social Factors\n\n### Peer Influence and Team Culture\nThe social environment within teams can profoundly impact substance use behaviors. If drug or alcohol use is normalized or even glamorized among teammates, new or younger athletes may feel pressured to conform to these norms to gain acceptance or camaraderie.\n\n### Social Isolation and Loneliness\nDespite being part of a team, athletes may experience social isolation due to rigorous training schedules, travel, or being away from family and friends. This loneliness can increase vulnerability to substance use as a misguided attempt to fill emotional voids or manage feelings of alienation.\n\n### Media and Celebrity Influence\nExposure to celebrity athletes who openly use or are rumored to use substances can create misleading narratives about drug use and its perceived benefits. This influence can lower inhibitions and reshape attitudes towards substance use, especially among younger athletes aspiring to emulate their idols.\n\n## Professional Factors\n\n### Demands of Competitive Sports\nThe professional athletic environment is highly competitive, with careers often hinging on performance and winning. The associated stress can drive athletes to use substances that promise enhanced stamina, focus, or recovery, sometimes blurring the line between legitimate medical use and abuse.\n\n### Career Uncertainty and Transition Stress\nAthletes frequently face uncertainty regarding career longevity due to factors such as injuries or declining performance. The stress related to contract negotiations, retirement planning, or forced career changes may lead to increased substance use as a maladaptive coping strategy.\n\n### Accessibility and Medical Prescriptions\nAthletes generally have greater access to medical facilities and prescription medications than the general population. While this access is crucial for health management, it also increases the risk of prescription drug misuse, especially when oversight is inadequate or when medications are used beyond therapeutic purposes.\n\n## Conclusion\n\nThe causes and risk factors behind substance abuse among athletes are multifaceted, involving a complex interplay of psychological pressures, social dynamics, and professional challenges. Recognizing these contributing elements is vital for coaches, medical professionals, and support networks to create comprehensive prevention programs and provide the necessary resources to help athletes maintain healthy lifestyles free from substance abuse. Only through holistic understanding and targeted action can the athletic community effectively combat this pervasive issue.'),
  CompletedSection(name='Health and Performance Consequences', content="# Health and Performance Consequences: The Physical and Mental Impacts of Substance Abuse on Athletes\n\nSubstance abuse among athletes is a critical issue that can profoundly affect both their health and sports performance. While some may turn to drugs or alcohol as a coping mechanism for stress, injury, or pressure, the consequences can be far-reaching and damaging. This article provides an in-depth analysis of the physical and mental impacts of substance abuse on athletes, emphasizing why maintaining a healthy lifestyle is essential for peak performance and overall well-being.\n\n## Physical Impacts of Substance Abuse on Athletes\n\n### 1. Deterioration of Cardiovascular Health\nMany substances abused by athletes, such as stimulants and anabolic steroids, place significant strain on the cardiovascular system. Stimulants like cocaine and amphetamines increase heart rate and blood pressure, leading to arrhythmias, hypertension, and even sudden cardiac arrest. Anabolic steroids can cause thickening of the heart muscle and increase the risk of heart attacks and strokes. Such cardiovascular issues directly impair an athlete's endurance, stamina, and ability to perform at high levels.\n\n### 2. Impaired Muscular Strength and Recovery\nThough some athletes misuse anabolic steroids to enhance muscle mass, chronic abuse can backfire by causing muscle cramps, weakness, and tendon ruptures. Other substances like alcohol interfere with protein synthesis and muscle repair, prolonging recovery time after training or injury. Dehydration and nutrient depletion caused by certain drugs further weaken muscles, limiting strength and agility on the field.\n\n### 3. Compromised Immune Function\nSubstance abuse can suppress the immune system, making athletes more susceptible to infections and illnesses. For example, excessive alcohol intake has been shown to reduce white blood cell activity, reducing the body’s ability to fight off viruses and bacteria. This leads to increased downtime due to illness and a diminished capacity to handle the physical demands of training and competition.\n\n### 4. Respiratory and Neurological Damage\nSmoking substances like tobacco or marijuana damages lung tissue and reduces oxygen uptake, critical for aerobic performance. Inhalants and certain drugs can cause long-term neurological damage including impaired coordination, balance, and reflexes—all vital for athletic skills. Brain injuries resulting from drug use can be irreversible, severely impacting motor skills and reaction times.\n\n## Mental and Psychological Consequences\n\n### 1. Cognitive Decline and Impaired Decision-Making\nSubstance abuse affects areas of the brain responsible for judgment, focus, and reaction time. Athletes abusing drugs may experience difficulties with concentration, memory, and decision-making — all essential skills for strategic gameplay and quick reactions in sports. Cognitive impairment can lead to poor game performance and increased risk of injury.\n\n### 2. Increased Anxiety, Depression, and Mood Disorders\nMany athletes turn to substances as a method of managing anxiety or depression. However, the temporary relief these substances provide is often followed by worsening symptoms. Long-term substance abuse is linked with increased rates of anxiety disorders, depression, and mood swings. Mental health struggles not only impair motivation and training consistency but also increase the likelihood of burnout and withdrawal from sport.\n\n### 3. Addiction and Dependence\nPhysical and psychological dependence on performance-enhancing or recreational drugs can trap athletes in destructive cycles. Addiction disrupts daily routines, training schedules, and professional commitments. The stress of hiding substance use and dealing with its consequences adds an additional psychological burden, often leading to social isolation and damaged relationships.\n\n### 4. Impact on Team Dynamics and Reputation\nMental health issues stemming from substance abuse can make athletes volatile or withdrawn, affecting communication and collaboration within a team. Additionally, public knowledge of substance abuse can tarnish an athlete’s reputation, leading to a loss of sponsorships, fan support, and career opportunities.\n\n## Conclusion: Prioritizing Health to Sustain Performance\n\nThe interplay between substance abuse and athletic health creates a dangerous cycle where physical and mental degradations impair performance, which in turn may lead to further substance use in an attempt to compensate. Athletes must prioritize healthy coping strategies, proper medical guidance, and mental health support to maintain optimal performance and longevity in their sports careers. Coaches, trainers, and sporting organizations also play a pivotal role in providing education and resources to prevent substance abuse and support recovery. Ultimately, safeguarding an athlete’s well-being ensures not only superior performance but a fulfilling and sustainable athletic journey."),
  CompletedSection(name='Detection and Prevention Strategies', content='# Detection and Prevention Strategies for Substance Abuse in Athletes\n\nSubstance abuse in athletes not only undermines fair competition but also poses significant health risks. To maintain integrity in sports and protect athletes’ well-being, robust detection and prevention strategies are essential. This article explores the methods used to identify substance abuse in athletes and the proactive approaches employed to prevent it, focusing on testing protocols and educational programs.\n\n## Detection of Substance Abuse in Athletes\n\n### 1. Drug Testing Protocols\nOne of the primary methods for detecting substance abuse in athletes is through comprehensive drug testing programs. These tests can be conducted both in and out of competition, aiming to identify banned substances such as anabolic steroids, stimulants, diuretics, and other performance-enhancing drugs (PEDs).\n\n- **Urine Testing:** The most common and widely used method, urine tests can detect a broad range of substances and their metabolites. Samples are collected under strict supervision to prevent tampering.\n- **Blood Testing:** Used to detect substances that may not appear in urine or to determine the concentration of certain drugs, such as erythropoietin (EPO) or hormones.\n- **Hair and Saliva Testing:** These methods are less common but provide longer detection windows or rapid results, respectively.\n\nTesting is typically random, scheduled, or targeted based on certain risk factors or suspicious behavior, helping to deter and catch substance abuse.\n\n### 2. Biological Passport Programs\nThe Athlete Biological Passport (ABP) monitors selected biological variables over time. Rather than detecting the substance directly, it identifies abnormal changes in an athlete’s biological markers that suggest doping. This method enhances detection capabilities for substances that are otherwise difficult to identify.\n\n### 3. Observational and Behavioral Monitoring\nCoaches, medical staff, and anti-doping officials also rely on behavioral observations to detect potential substance abuse. Changes in performance, physical appearance, or behavior can prompt further investigation or testing.\n\n## Prevention Strategies\n\n### 1. Education Programs\nEducation is a cornerstone in preventing substance abuse. Athletes, coaches, and supporting personnel are provided with information about:\n\n- The health risks associated with drug use.\n- The ethical implications and impact on sporting integrity.\n- The specific substances banned by anti-doping authorities.\n- How testing procedures work and the consequences of violations.\n\nEffective education fosters informed decision-making and empowers athletes to resist pressure or temptation to use prohibited substances.\n\n### 2. Promoting a Culture of Clean Sport\nEncouraging a culture that values fair play and health over winning at all costs is essential. This includes:\n\n- Encouraging open dialogue about doping risks.\n- Highlighting positive role models who compete clean.\n- Building supportive environments where athletes can seek help for pressures or substance-related issues without stigma.\n\n### 3. Support Services and Counseling\nProviding access to psychological support and counseling can address underlying issues that might lead athletes to use substances, such as stress, anxiety, or injury-related pain management.\n\n### 4. Policy and Enforcement\nClear rules, consistent enforcement, and transparent consequences reinforce deterrents against doping. Collaboration among sports organizations, anti-doping agencies, and governments ensures that policies are up-to-date and effectively implemented.\n\n## Conclusion\n\nDetecting and preventing substance abuse in athletes requires a multifaceted approach that combines advanced testing technologies, continuous monitoring, education, and supportive environments. By integrating these strategies, the sports community can better protect athletes’ health, uphold the spirit of fair competition, and maintain public confidence in sport.'),
  CompletedSection(name='Support and Rehabilitation', content='# Support and Rehabilitation: Helping Athletes Overcome Substance Abuse\n\nSubstance abuse is a significant challenge faced by many athletes, often impacting not only their performance but also their overall health and well-being. Fortunately, a variety of support systems and rehabilitation programs have been developed to assist athletes in overcoming these issues. These resources provide comprehensive care, from initial intervention to long-term recovery, helping athletes regain control of their lives both on and off the field.\n\n## Understanding the Need for Support and Rehabilitation\n\nAthletes are under tremendous pressure to perform, which can sometimes lead to the misuse of substances such as performance enhancers, painkillers, or recreational drugs. The stigma surrounding substance abuse in sports may create barriers to seeking help, making effective support and rehabilitation programs critical.\n\nThese programs are specifically designed to address the unique physical, emotional, and psychological demands athletes face. Tailored support systems ensure that athletes receive care that respects their competitive schedules while focusing on sustainable recovery.\n\n## Types of Support Systems Available to Athletes\n\n### 1. Counseling and Psychological Support\n\nOne of the foundational elements in addressing substance abuse is access to professional counseling. Sports psychologists and addiction counselors work with athletes to tackle underlying issues such as anxiety, depression, or trauma that often contribute to substance misuse. Cognitive-behavioral therapy (CBT) and motivational interviewing are common techniques used to foster behavioral change and build resilience.\n\n### 2. Peer Support Groups\n\nPeer networks provide a safe environment where athletes can share experiences, challenges, and coping strategies. Groups such as Athlete Assistance Programs (AAP) and specialized 12-step programs tailored for athletes encourage mutual support and accountability. Being part of a community reduces feelings of isolation and stigma, fostering a sense of belonging and motivation.\n\n### 3. Family and Social Support\n\nRehabilitation is more effective when athletes have a strong support system at home and within their social circles. Many programs involve family therapy or educational sessions to help loved ones understand substance abuse and learn how to provide constructive support throughout recovery.\n\n## Rehabilitation Programs Tailored for Athletes\n\n### 1. Inpatient Rehabilitation\n\nFor athletes with severe substance dependence, inpatient rehabilitation centers offer intensive, structured care. These programs provide medical supervision, detoxification services, and comprehensive therapy in a controlled environment. Many centers integrate physical conditioning and sports-specific rehabilitation to help athletes maintain fitness and facilitate reintegration into their sport.\n\n### 2. Outpatient Rehabilitation\n\nOutpatient programs provide flexibility for athletes who cannot commit to prolonged residential stays due to training or competition schedules. These programs offer scheduled therapy sessions, group meetings, and medical support, allowing athletes to receive care while continuing their regular activities. Outpatient care often serves as a step-down for those transitioning from inpatient programs.\n\n### 3. Holistic and Integrative Approaches\n\nModern rehabilitation programs increasingly incorporate holistic therapies to address the physical and emotional aspects of recovery. These may include yoga, mindfulness meditation, nutrition counseling, and acupuncture. Such approaches help athletes develop healthier lifestyles, manage stress, and reduce the likelihood of relapse.\n\n## Role of Sports Organizations and Governing Bodies\n\nSports organizations play a pivotal role in providing resources and creating policies that support athletes facing substance abuse. Many federations offer confidential help lines, educational seminars, and funding for rehabilitation programs. Anti-doping agencies also emphasize rehabilitation over punishment, aiming to promote athlete health and ethical competition.\n\n## Success Stories and Outcomes\n\nNumerous athletes have successfully overcome substance abuse through dedicated support and rehabilitation. These success stories highlight the effectiveness of targeted programs that combine medical treatment, psychological support, and social reintegration. Recovery not only improves personal health but also restores athletic potential and inspires others facing similar struggles.\n\n## Conclusion\n\nSubstance abuse among athletes is a complex issue requiring specialized support and rehabilitation programs. By leveraging counseling, peer support, family involvement, and tailored rehabilitation services, athletes can overcome these challenges and return to optimal performance and well-being. Ongoing collaboration between healthcare providers, sports organizations, and athletes themselves is essential to foster environments that encourage recovery and sustainable success.'),
  CompletedSection(name='Conclusion and Future Perspectives', content='## Conclusion and Future Perspectives\n\n### Summary of Key Points\n\nAddressing substance abuse among athletes remains a critical challenge that demands comprehensive, evidence-based strategies. Throughout this article, we have explored the multifaceted nature of substance abuse in the athletic community, highlighting its complex interplay with physical performance pressures, mental health issues, and social influences. Key points include:\n\n- **Prevalence and Types of Substance Abuse:** Athletes are susceptible to various substances, ranging from performance-enhancing drugs like anabolic steroids to recreational drugs and prescription medication misuse.\n- **Risk Factors:** High-performance demands, injury management, psychological stress, and the culture of competitive sports contribute significantly to the risk of substance abuse.\n- **Impact on Health and Career:** Substance abuse not only jeopardizes athletes’ physical and mental well-being but also threatens their careers through sanctions, suspensions, and loss of reputation.\n- **Current Prevention and Intervention Strategies:** These include education programs, strict doping controls, psychological support, and rehabilitation services tailored to the athletic population.\n\nUnderstanding these essentials underscores the need for a strategic, multidisciplinary approach to mitigate substance abuse risks effectively.\n\n### Emerging Trends and Future Approaches\n\nLooking forward, the landscape of managing substance abuse among athletes is evolving, propelled by advancements in technology, research, and policy development. New trends and promising approaches include:\n\n- **Personalized Prevention Programs:** Leveraging data analytics and behavioral assessments to create individualized intervention plans that address specific risk factors and psychological profiles unique to each athlete.\n- **Enhanced Screening and Detection Methods:** Innovations such as biomarker identification, genetic testing, and advanced neuroimaging are improving the accuracy and timeliness of substance abuse detection.\n- **Integrative Mental Health Services:** Future programs emphasize holistic care by integrating mental health support, stress management, and resilience training within athletic training and medical teams.\n- **Technology-Driven Monitoring:** Wearable devices and mobile health apps are emerging as tools to monitor physiological and psychological indicators, enabling early intervention before substance use escalates.\n- **Policy and Cultural Shift:** Developing policies that not only penalize substance abuse but also destigmatize seeking help, encouraging athletes to come forward without fear of retaliation or judgment.\n- **Collaborative Stakeholder Engagement:** Involving coaches, medical staff, sports organizations, family members, and peers to foster a supportive environment conducive to prevention and recovery.\n\n### Conclusion\n\nThe fight against substance abuse among athletes is ongoing, and it requires adaptability to emerging scientific insights and societal changes. By embracing innovative technologies, prioritizing mental health, and fostering open communication, sports communities can better protect athletes from the risks of substance abuse. The future holds promise for more effective, personalized, and compassionate approaches that not only safeguard athletic integrity but also promote overall health and well-being.')],
 'final_report': "# Introduction to Substance Abuse in Athletes\n\nSubstance abuse among athletes is a significant concern that affects not only their health but also their performance, careers, and overall well-being. Despite the physical and mental discipline required in sports, athletes are not immune to the pressures and challenges that can lead to the use and abuse of various substances. Understanding the types of substances commonly used and the reasons why athletes may turn to them is crucial for addressing this issue effectively.\n\n## Common Types of Substances Abused by Athletes\n\nAthletes may misuse a wide range of substances, each serving different purposes or fulfilling different needs depending on the individual and their circumstances. Some of the most common categories include:\n\n### 1. Performance-Enhancing Drugs (PEDs)\nPerformance-enhancing drugs are substances used to improve athletic ability beyond natural limits. These include anabolic steroids, human growth hormone (HGH), erythropoietin (EPO), and stimulants. Athletes may use these drugs to increase muscle mass, enhance endurance, speed up recovery, and gain a competitive advantage.\n\n### 2. Recreational Drugs\nRecreational drugs such as marijuana, cocaine, MDMA, and opioids are sometimes abused by athletes to cope with stress, manage pain, or for social reasons. While these substances do not improve athletic performance and can be detrimental, their use is often linked to external pressures or underlying issues.\n\n### 3. Prescription Medications\nCertain prescription medications, including painkillers (opioids), anti-anxiety drugs (benzodiazepines), and stimulants (used for ADHD), can be abused by athletes. These drugs might be used to manage pain from injuries, reduce anxiety before competitions, or increase focus and alertness.\n\n### 4. Over-the-Counter (OTC) Substances and Supplements\nThough generally legal and accessible, some OTC substances and dietary supplements can be misused, especially when athletes seek to lose weight rapidly or boost energy. Misuse can sometimes lead to harmful side effects or positive doping tests if the substances contain banned ingredients.\n\n## Reasons for Substance Abuse Among Athletes\n\nThe motivations behind substance abuse in athletes are complex and multifaceted. Some of the most common reasons include:\n\n### 1. Enhancing Performance\nThe intense desire to win and excel can lead athletes to experiment with drugs that promise enhanced strength, endurance, or recovery. In highly competitive environments, athletes may feel pressure to push beyond their natural limits.\n\n### 2. Coping with Pain and Injuries\nPhysical injuries are common in sports, and the pain associated with them can lead athletes to seek relief through prescription painkillers or other substances. Unfortunately, this can sometimes escalate into abuse and dependency.\n\n### 3. Managing Stress and Anxiety\nThe psychological pressures of competition, public scrutiny, and personal expectations can cause significant mental stress. Some athletes turn to drugs to alleviate anxiety, improve mood, or escape from personal and professional challenges.\n\n### 4. Peer Influence and Culture\nIn some sports cultures, the use of substances may be normalized or even encouraged, creating an environment where athletes feel compelled to conform. Peer influence and the desire to belong can drive substance use.\n\n### 5. Weight Control and Body Image\nCertain sports emphasize weight categories or aesthetic appearance, prompting athletes to misuse substances that suppress appetite or promote rapid weight loss.\n\n## Conclusion\n\nSubstance abuse in athletes is a serious and multifaceted problem that demands awareness, education, and intervention at multiple levels. Recognizing the types of substances commonly abused and understanding the underlying reasons for their use is the first step towards promoting healthier choices and safeguarding the integrity of sports. Athletes, coaches, medical professionals, and organizations must work collaboratively to address these issues through prevention, support, and treatment.\n\n# Common Substances Abused by Athletes\n\nAthletes often face immense pressure to perform at their best, maintain stamina, and recover quickly from injuries. Unfortunately, some turn to substances that can enhance performance or alleviate pain, despite the health risks and ethical concerns involved. This article provides a detailed description of the most frequently abused substances among athletes, focusing on steroids, stimulants, painkillers, and recreational drugs.\n\n## Anabolic Steroids\n\nAnabolic steroids are synthetic variations of the male hormone testosterone. Athletes abuse them to increase muscle mass, strength, and overall physical performance. Steroids work by promoting protein synthesis within cells, leading to rapid muscle growth.\n\n### Common Types and Effects\n- **Types**: Testosterone, nandrolone, stanozolol, and methyltestosterone.\n- **Effects**: Increased muscle size, enhanced recovery rate, greater endurance, and reduced fatigue.\n\n### Risks and Side Effects\n- Hormonal imbalances leading to acne, hair loss, and mood swings.\n- Cardiovascular issues such as high blood pressure and increased risk of heart attack.\n- Liver damage and potential infertility.\n- Psychological effects including aggression and depression.\n  \nDespite their performance-enhancing properties, anabolic steroids are banned in most sports leagues and athletic organizations.\n\n## Stimulants\n\nStimulants are substances that increase alertness, attention, and energy by enhancing the activity of the central nervous system. Athletes may use stimulants to reduce fatigue and improve focus during training or competition.\n\n### Common Stimulants\n- **Amphetamines**: Often prescribed for ADHD but misused for increased energy.\n- **Caffeine**: The world’s most widely consumed legal stimulant.\n- **Ephedrine**: Used for weight loss and increased energy but banned in many competitions.\n  \n### Effects\n- Increased heart rate and blood pressure.\n- Heightened concentration and wakefulness.\n- Temporary reduction of appetite and fatigue.\n\n### Risks\n- Dependence and addiction.\n- Cardiovascular complications, including arrhythmias and heart attacks.\n- Nervousness, anxiety, and sleep disturbances.\n  \nWhile moderate caffeine use is generally accepted, other stimulants are typically prohibited due to their performance-enhancing effects and health risks.\n\n## Painkillers\n\nPainkillers, particularly opioid analgesics and non-steroidal anti-inflammatory drugs (NSAIDs), are commonly prescribed to manage injuries and pain. However, abuse can occur when athletes rely excessively on these drugs to continue competing.\n\n### Commonly Abused Painkillers\n- **Opioids**: Morphine, oxycodone, hydrocodone.\n- **NSAIDs**: Ibuprofen, naproxen (abuse generally less severe but problematic if overused).\n\n### Effects\n- Temporary pain relief and increased ability to train through injury.\n- Sedation and euphoria (primarily with opioids).\n\n### Risks\n- Opioid addiction, respiratory depression, and overdose.\n- Gastrointestinal issues and kidney damage with long-term NSAID use.\n- Masking of pain leading to worsened injuries.\n\nDue to the risk of dependency, strict guidelines exist for the medical use of painkillers among athletes.\n\n## Recreational Drugs\n\nSome athletes use recreational drugs for relaxation or coping with stress, despite the negative impact on performance and health.\n\n### Common Recreational Drugs Abused\n- **Cannabis**: Used for relaxation and pain relief; banned in many competitions.\n- **Alcohol**: Consumed socially but can impair recovery and performance.\n- **Cocaine and Ecstasy**: Occasionally abused for their stimulant and euphoric effects.\n\n### Effects\n- Altered mental state, reduced reaction time, and impaired coordination.\n- Short-term mood enhancement or relaxation.\n\n### Risks\n- Detrimental effects on cardiovascular health.\n- Legal issues and sanctions from sports authorities.\n- Negative impact on motivation, training, and overall athletic performance.\n\n## Conclusion\n\nThe abuse of steroids, stimulants, painkillers, and recreational drugs poses serious health risks and ethical dilemmas in sports. While the desire to perform better or manage pain is understandable, these substances can undermine an athlete’s long-term wellbeing and the integrity of athletic competition. Education, support, and strict regulation remain crucial in addressing substance abuse among athletes.\n\n# Causes and Risk Factors: Exploring Psychological, Social, and Professional Contributors to Substance Abuse Among Athletes\n\nSubstance abuse among athletes is a pressing concern that extends beyond physical performance to affect their mental health, career longevity, and overall well-being. Understanding the underlying causes and risk factors is essential for developing effective prevention and intervention strategies. This article delves into the psychological, social, and professional factors that contribute to substance abuse in the athletic community.\n\n## Psychological Factors\n\n### Pressure to Perform and Perfectionism\nAthletes often face intense pressure to perform at peak levels consistently. This demand can trigger anxiety, stress, and feelings of inadequacy. The desire for perfection may lead some athletes to use substances such as stimulants or performance-enhancing drugs to cope with the high expectations and overcome self-doubt.\n\n### Mental Health Challenges\nDepression, anxiety disorders, and other mental health issues are prevalent among athletes. The stigma around seeking psychological help often forces athletes to self-medicate with alcohol or drugs as a way to manage emotional pain, stress, or injury-related trauma.\n\n### Coping Mechanisms for Injury and Pain\nPhysical injuries are a common aspect of athletic careers. The chronic pain associated with injuries can lead athletes to misuse prescription medications like opioids or overconsume alcohol to alleviate discomfort and continue training or competing, inadvertently increasing the risk of substance dependence.\n\n## Social Factors\n\n### Peer Influence and Team Culture\nThe social environment within teams can profoundly impact substance use behaviors. If drug or alcohol use is normalized or even glamorized among teammates, new or younger athletes may feel pressured to conform to these norms to gain acceptance or camaraderie.\n\n### Social Isolation and Loneliness\nDespite being part of a team, athletes may experience social isolation due to rigorous training schedules, travel, or being away from family and friends. This loneliness can increase vulnerability to substance use as a misguided attempt to fill emotional voids or manage feelings of alienation.\n\n### Media and Celebrity Influence\nExposure to celebrity athletes who openly use or are rumored to use substances can create misleading narratives about drug use and its perceived benefits. This influence can lower inhibitions and reshape attitudes towards substance use, especially among younger athletes aspiring to emulate their idols.\n\n## Professional Factors\n\n### Demands of Competitive Sports\nThe professional athletic environment is highly competitive, with careers often hinging on performance and winning. The associated stress can drive athletes to use substances that promise enhanced stamina, focus, or recovery, sometimes blurring the line between legitimate medical use and abuse.\n\n### Career Uncertainty and Transition Stress\nAthletes frequently face uncertainty regarding career longevity due to factors such as injuries or declining performance. The stress related to contract negotiations, retirement planning, or forced career changes may lead to increased substance use as a maladaptive coping strategy.\n\n### Accessibility and Medical Prescriptions\nAthletes generally have greater access to medical facilities and prescription medications than the general population. While this access is crucial for health management, it also increases the risk of prescription drug misuse, especially when oversight is inadequate or when medications are used beyond therapeutic purposes.\n\n## Conclusion\n\nThe causes and risk factors behind substance abuse among athletes are multifaceted, involving a complex interplay of psychological pressures, social dynamics, and professional challenges. Recognizing these contributing elements is vital for coaches, medical professionals, and support networks to create comprehensive prevention programs and provide the necessary resources to help athletes maintain healthy lifestyles free from substance abuse. Only through holistic understanding and targeted action can the athletic community effectively combat this pervasive issue.\n\n# Health and Performance Consequences: The Physical and Mental Impacts of Substance Abuse on Athletes\n\nSubstance abuse among athletes is a critical issue that can profoundly affect both their health and sports performance. While some may turn to drugs or alcohol as a coping mechanism for stress, injury, or pressure, the consequences can be far-reaching and damaging. This article provides an in-depth analysis of the physical and mental impacts of substance abuse on athletes, emphasizing why maintaining a healthy lifestyle is essential for peak performance and overall well-being.\n\n## Physical Impacts of Substance Abuse on Athletes\n\n### 1. Deterioration of Cardiovascular Health\nMany substances abused by athletes, such as stimulants and anabolic steroids, place significant strain on the cardiovascular system. Stimulants like cocaine and amphetamines increase heart rate and blood pressure, leading to arrhythmias, hypertension, and even sudden cardiac arrest. Anabolic steroids can cause thickening of the heart muscle and increase the risk of heart attacks and strokes. Such cardiovascular issues directly impair an athlete's endurance, stamina, and ability to perform at high levels.\n\n### 2. Impaired Muscular Strength and Recovery\nThough some athletes misuse anabolic steroids to enhance muscle mass, chronic abuse can backfire by causing muscle cramps, weakness, and tendon ruptures. Other substances like alcohol interfere with protein synthesis and muscle repair, prolonging recovery time after training or injury. Dehydration and nutrient depletion caused by certain drugs further weaken muscles, limiting strength and agility on the field.\n\n### 3. Compromised Immune Function\nSubstance abuse can suppress the immune system, making athletes more susceptible to infections and illnesses. For example, excessive alcohol intake has been shown to reduce white blood cell activity, reducing the body’s ability to fight off viruses and bacteria. This leads to increased downtime due to illness and a diminished capacity to handle the physical demands of training and competition.\n\n### 4. Respiratory and Neurological Damage\nSmoking substances like tobacco or marijuana damages lung tissue and reduces oxygen uptake, critical for aerobic performance. Inhalants and certain drugs can cause long-term neurological damage including impaired coordination, balance, and reflexes—all vital for athletic skills. Brain injuries resulting from drug use can be irreversible, severely impacting motor skills and reaction times.\n\n## Mental and Psychological Consequences\n\n### 1. Cognitive Decline and Impaired Decision-Making\nSubstance abuse affects areas of the brain responsible for judgment, focus, and reaction time. Athletes abusing drugs may experience difficulties with concentration, memory, and decision-making — all essential skills for strategic gameplay and quick reactions in sports. Cognitive impairment can lead to poor game performance and increased risk of injury.\n\n### 2. Increased Anxiety, Depression, and Mood Disorders\nMany athletes turn to substances as a method of managing anxiety or depression. However, the temporary relief these substances provide is often followed by worsening symptoms. Long-term substance abuse is linked with increased rates of anxiety disorders, depression, and mood swings. Mental health struggles not only impair motivation and training consistency but also increase the likelihood of burnout and withdrawal from sport.\n\n### 3. Addiction and Dependence\nPhysical and psychological dependence on performance-enhancing or recreational drugs can trap athletes in destructive cycles. Addiction disrupts daily routines, training schedules, and professional commitments. The stress of hiding substance use and dealing with its consequences adds an additional psychological burden, often leading to social isolation and damaged relationships.\n\n### 4. Impact on Team Dynamics and Reputation\nMental health issues stemming from substance abuse can make athletes volatile or withdrawn, affecting communication and collaboration within a team. Additionally, public knowledge of substance abuse can tarnish an athlete’s reputation, leading to a loss of sponsorships, fan support, and career opportunities.\n\n## Conclusion: Prioritizing Health to Sustain Performance\n\nThe interplay between substance abuse and athletic health creates a dangerous cycle where physical and mental degradations impair performance, which in turn may lead to further substance use in an attempt to compensate. Athletes must prioritize healthy coping strategies, proper medical guidance, and mental health support to maintain optimal performance and longevity in their sports careers. Coaches, trainers, and sporting organizations also play a pivotal role in providing education and resources to prevent substance abuse and support recovery. Ultimately, safeguarding an athlete’s well-being ensures not only superior performance but a fulfilling and sustainable athletic journey.\n\n# Detection and Prevention Strategies for Substance Abuse in Athletes\n\nSubstance abuse in athletes not only undermines fair competition but also poses significant health risks. To maintain integrity in sports and protect athletes’ well-being, robust detection and prevention strategies are essential. This article explores the methods used to identify substance abuse in athletes and the proactive approaches employed to prevent it, focusing on testing protocols and educational programs.\n\n## Detection of Substance Abuse in Athletes\n\n### 1. Drug Testing Protocols\nOne of the primary methods for detecting substance abuse in athletes is through comprehensive drug testing programs. These tests can be conducted both in and out of competition, aiming to identify banned substances such as anabolic steroids, stimulants, diuretics, and other performance-enhancing drugs (PEDs).\n\n- **Urine Testing:** The most common and widely used method, urine tests can detect a broad range of substances and their metabolites. Samples are collected under strict supervision to prevent tampering.\n- **Blood Testing:** Used to detect substances that may not appear in urine or to determine the concentration of certain drugs, such as erythropoietin (EPO) or hormones.\n- **Hair and Saliva Testing:** These methods are less common but provide longer detection windows or rapid results, respectively.\n\nTesting is typically random, scheduled, or targeted based on certain risk factors or suspicious behavior, helping to deter and catch substance abuse.\n\n### 2. Biological Passport Programs\nThe Athlete Biological Passport (ABP) monitors selected biological variables over time. Rather than detecting the substance directly, it identifies abnormal changes in an athlete’s biological markers that suggest doping. This method enhances detection capabilities for substances that are otherwise difficult to identify.\n\n### 3. Observational and Behavioral Monitoring\nCoaches, medical staff, and anti-doping officials also rely on behavioral observations to detect potential substance abuse. Changes in performance, physical appearance, or behavior can prompt further investigation or testing.\n\n## Prevention Strategies\n\n### 1. Education Programs\nEducation is a cornerstone in preventing substance abuse. Athletes, coaches, and supporting personnel are provided with information about:\n\n- The health risks associated with drug use.\n- The ethical implications and impact on sporting integrity.\n- The specific substances banned by anti-doping authorities.\n- How testing procedures work and the consequences of violations.\n\nEffective education fosters informed decision-making and empowers athletes to resist pressure or temptation to use prohibited substances.\n\n### 2. Promoting a Culture of Clean Sport\nEncouraging a culture that values fair play and health over winning at all costs is essential. This includes:\n\n- Encouraging open dialogue about doping risks.\n- Highlighting positive role models who compete clean.\n- Building supportive environments where athletes can seek help for pressures or substance-related issues without stigma.\n\n### 3. Support Services and Counseling\nProviding access to psychological support and counseling can address underlying issues that might lead athletes to use substances, such as stress, anxiety, or injury-related pain management.\n\n### 4. Policy and Enforcement\nClear rules, consistent enforcement, and transparent consequences reinforce deterrents against doping. Collaboration among sports organizations, anti-doping agencies, and governments ensures that policies are up-to-date and effectively implemented.\n\n## Conclusion\n\nDetecting and preventing substance abuse in athletes requires a multifaceted approach that combines advanced testing technologies, continuous monitoring, education, and supportive environments. By integrating these strategies, the sports community can better protect athletes’ health, uphold the spirit of fair competition, and maintain public confidence in sport.\n\n# Support and Rehabilitation: Helping Athletes Overcome Substance Abuse\n\nSubstance abuse is a significant challenge faced by many athletes, often impacting not only their performance but also their overall health and well-being. Fortunately, a variety of support systems and rehabilitation programs have been developed to assist athletes in overcoming these issues. These resources provide comprehensive care, from initial intervention to long-term recovery, helping athletes regain control of their lives both on and off the field.\n\n## Understanding the Need for Support and Rehabilitation\n\nAthletes are under tremendous pressure to perform, which can sometimes lead to the misuse of substances such as performance enhancers, painkillers, or recreational drugs. The stigma surrounding substance abuse in sports may create barriers to seeking help, making effective support and rehabilitation programs critical.\n\nThese programs are specifically designed to address the unique physical, emotional, and psychological demands athletes face. Tailored support systems ensure that athletes receive care that respects their competitive schedules while focusing on sustainable recovery.\n\n## Types of Support Systems Available to Athletes\n\n### 1. Counseling and Psychological Support\n\nOne of the foundational elements in addressing substance abuse is access to professional counseling. Sports psychologists and addiction counselors work with athletes to tackle underlying issues such as anxiety, depression, or trauma that often contribute to substance misuse. Cognitive-behavioral therapy (CBT) and motivational interviewing are common techniques used to foster behavioral change and build resilience.\n\n### 2. Peer Support Groups\n\nPeer networks provide a safe environment where athletes can share experiences, challenges, and coping strategies. Groups such as Athlete Assistance Programs (AAP) and specialized 12-step programs tailored for athletes encourage mutual support and accountability. Being part of a community reduces feelings of isolation and stigma, fostering a sense of belonging and motivation.\n\n### 3. Family and Social Support\n\nRehabilitation is more effective when athletes have a strong support system at home and within their social circles. Many programs involve family therapy or educational sessions to help loved ones understand substance abuse and learn how to provide constructive support throughout recovery.\n\n## Rehabilitation Programs Tailored for Athletes\n\n### 1. Inpatient Rehabilitation\n\nFor athletes with severe substance dependence, inpatient rehabilitation centers offer intensive, structured care. These programs provide medical supervision, detoxification services, and comprehensive therapy in a controlled environment. Many centers integrate physical conditioning and sports-specific rehabilitation to help athletes maintain fitness and facilitate reintegration into their sport.\n\n### 2. Outpatient Rehabilitation\n\nOutpatient programs provide flexibility for athletes who cannot commit to prolonged residential stays due to training or competition schedules. These programs offer scheduled therapy sessions, group meetings, and medical support, allowing athletes to receive care while continuing their regular activities. Outpatient care often serves as a step-down for those transitioning from inpatient programs.\n\n### 3. Holistic and Integrative Approaches\n\nModern rehabilitation programs increasingly incorporate holistic therapies to address the physical and emotional aspects of recovery. These may include yoga, mindfulness meditation, nutrition counseling, and acupuncture. Such approaches help athletes develop healthier lifestyles, manage stress, and reduce the likelihood of relapse.\n\n## Role of Sports Organizations and Governing Bodies\n\nSports organizations play a pivotal role in providing resources and creating policies that support athletes facing substance abuse. Many federations offer confidential help lines, educational seminars, and funding for rehabilitation programs. Anti-doping agencies also emphasize rehabilitation over punishment, aiming to promote athlete health and ethical competition.\n\n## Success Stories and Outcomes\n\nNumerous athletes have successfully overcome substance abuse through dedicated support and rehabilitation. These success stories highlight the effectiveness of targeted programs that combine medical treatment, psychological support, and social reintegration. Recovery not only improves personal health but also restores athletic potential and inspires others facing similar struggles.\n\n## Conclusion\n\nSubstance abuse among athletes is a complex issue requiring specialized support and rehabilitation programs. By leveraging counseling, peer support, family involvement, and tailored rehabilitation services, athletes can overcome these challenges and return to optimal performance and well-being. Ongoing collaboration between healthcare providers, sports organizations, and athletes themselves is essential to foster environments that encourage recovery and sustainable success.\n\n## Conclusion and Future Perspectives\n\n### Summary of Key Points\n\nAddressing substance abuse among athletes remains a critical challenge that demands comprehensive, evidence-based strategies. Throughout this article, we have explored the multifaceted nature of substance abuse in the athletic community, highlighting its complex interplay with physical performance pressures, mental health issues, and social influences. Key points include:\n\n- **Prevalence and Types of Substance Abuse:** Athletes are susceptible to various substances, ranging from performance-enhancing drugs like anabolic steroids to recreational drugs and prescription medication misuse.\n- **Risk Factors:** High-performance demands, injury management, psychological stress, and the culture of competitive sports contribute significantly to the risk of substance abuse.\n- **Impact on Health and Career:** Substance abuse not only jeopardizes athletes’ physical and mental well-being but also threatens their careers through sanctions, suspensions, and loss of reputation.\n- **Current Prevention and Intervention Strategies:** These include education programs, strict doping controls, psychological support, and rehabilitation services tailored to the athletic population.\n\nUnderstanding these essentials underscores the need for a strategic, multidisciplinary approach to mitigate substance abuse risks effectively.\n\n### Emerging Trends and Future Approaches\n\nLooking forward, the landscape of managing substance abuse among athletes is evolving, propelled by advancements in technology, research, and policy development. New trends and promising approaches include:\n\n- **Personalized Prevention Programs:** Leveraging data analytics and behavioral assessments to create individualized intervention plans that address specific risk factors and psychological profiles unique to each athlete.\n- **Enhanced Screening and Detection Methods:** Innovations such as biomarker identification, genetic testing, and advanced neuroimaging are improving the accuracy and timeliness of substance abuse detection.\n- **Integrative Mental Health Services:** Future programs emphasize holistic care by integrating mental health support, stress management, and resilience training within athletic training and medical teams.\n- **Technology-Driven Monitoring:** Wearable devices and mobile health apps are emerging as tools to monitor physiological and psychological indicators, enabling early intervention before substance use escalates.\n- **Policy and Cultural Shift:** Developing policies that not only penalize substance abuse but also destigmatize seeking help, encouraging athletes to come forward without fear of retaliation or judgment.\n- **Collaborative Stakeholder Engagement:** Involving coaches, medical staff, sports organizations, family members, and peers to foster a supportive environment conducive to prevention and recovery.\n\n### Conclusion\n\nThe fight against substance abuse among athletes is ongoing, and it requires adaptability to emerging scientific insights and societal changes. By embracing innovative technologies, prioritizing mental health, and fostering open communication, sports communities can better protect athletes from the risks of substance abuse. The future holds promise for more effective, personalized, and compassionate approaches that not only safeguard athletic integrity but also promote overall health and well-being."}</code></pre>
</div>
</div>
<p>Finally, I’ll show you how to implement a evaluator-optimizer workflow.</p>
</section>
</section>
<section id="evaluator-optimizer" class="level3">
<h3 class="anchored" data-anchor-id="evaluator-optimizer">Evaluator-optimizer</h3>
<p>This workflow is useful when we have clear evaluation criteria that an LLM evaluator can use to provide feedback to the LLM generator to iteratively improve its output.</p>
<p>Here’s what the workflow looks like:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart LR
    In([In]) --&gt; Gen["Generator (LLM)"]
    Gen -- "Solution" --&gt; Eval["Evaluator (LLM)"]
    Eval -- "Accepted" --&gt; Out([Out])
    Eval -- "Rejected + Feedback" --&gt; Gen
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p><strong>Examples:</strong></p>
<ul>
<li>Content generation that must match certain guidelines such as writing with a particular style.</li>
<li>Improving search results iteratively</li>
</ul>
<p>I’ll walk you through an example of an evaluator-optimizer workflow where you’ll generate a text, evaluate if it matches certain criteria, and then iteratively improve it.</p>
<p>Let’s start with the vanilla implementation.</p>
<section id="vanilla-langchain-4" class="level4">
<h4 class="anchored" data-anchor-id="vanilla-langchain-4">Vanilla (+LangChain)</h4>
<p>As usual, you start by defining the state and required data models.</p>
<div id="cell-95" class="cell" data-execution_count="36">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb42-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Evaluation(BaseModel):</span>
<span id="cb42-2">    explanation: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(</span>
<span id="cb42-3">        description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Explain why the text evaluated matches or not the evaluation criteria"</span></span>
<span id="cb42-4">    )</span>
<span id="cb42-5">    feedback: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(</span>
<span id="cb42-6">        description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Provide feedback to the writer to improve the text"</span></span>
<span id="cb42-7">    )</span>
<span id="cb42-8">    is_correct: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(</span>
<span id="cb42-9">        description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Whether the text evaluated matches or not the evaluation criteria"</span></span>
<span id="cb42-10">    )</span>
<span id="cb42-11"></span>
<span id="cb42-12"></span>
<span id="cb42-13"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> State(BaseModel):</span>
<span id="cb42-14">    topic: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb42-15">    article: Optional[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb42-16">    evaluation: Optional[Evaluation] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span></code></pre></div></div>
</div>
<p>Then, you define the functions for each step in the workflow.</p>
<div id="cell-97" class="cell" data-execution_count="37">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb43-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> evaluate_text(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Evaluation:</span>
<span id="cb43-2">    model_with_str_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.with_structured_output(Evaluation)</span>
<span id="cb43-3">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb43-4">        SystemMessage(</span>
<span id="cb43-5">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert evaluator. Provided with a text, you will evaluate if it's written in British English and if it's appropriate for a young audience. The text must always use British spelling and grammar. Make sure the text doesn't include any em dashes."</span></span>
<span id="cb43-6">        ),</span>
<span id="cb43-7">        HumanMessage(content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Evaluate the following text:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>article<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>),</span>
<span id="cb43-8">    ]</span>
<span id="cb43-9">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model_with_str_output.invoke(messages)</span>
<span id="cb43-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response</span>
<span id="cb43-11"></span>
<span id="cb43-12"></span>
<span id="cb43-13"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> fix_text(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb43-14">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb43-15">        SystemMessage(</span>
<span id="cb43-16">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer. Provided with a text and feedback, you wil improve the text."</span></span>
<span id="cb43-17">        ),</span>
<span id="cb43-18">        HumanMessage(</span>
<span id="cb43-19">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"You were tasked with writing an article about </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>topic<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">. You wrote the following text:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>article<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">You've got the following feedback:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>evaluation<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>feedback<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Fix the text to improve it."</span></span>
<span id="cb43-20">        ),</span>
<span id="cb43-21">    ]</span>
<span id="cb43-22">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.invoke(messages)</span>
<span id="cb43-23">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response.content</span>
<span id="cb43-24"></span>
<span id="cb43-25"></span>
<span id="cb43-26"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> generate_text(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb43-27">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb43-28">        SystemMessage(</span>
<span id="cb43-29">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer. Provided with a topic, you will generate an engaging article with less than 500 words."</span></span>
<span id="cb43-30">        ),</span>
<span id="cb43-31">        HumanMessage(content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Generate a text about this topic:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>topic<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>),</span>
<span id="cb43-32">    ]</span>
<span id="cb43-33">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.invoke(messages)</span>
<span id="cb43-34">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response.content</span>
<span id="cb43-35"></span>
<span id="cb43-36"></span>
<span id="cb43-37"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> generate_text_dispatch(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb43-38">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> state.evaluation:</span>
<span id="cb43-39">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> fix_text(state)</span>
<span id="cb43-40">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> generate_text(state)</span></code></pre></div></div>
</div>
<p>Finally, you create <code>run_workflow</code> function that orchestrates the workflow. In this case, it takes a topic, generates a text, evaluates it, and tries to iteratively improve it. If it fails more than 3 times, it stops.</p>
<div id="cell-99" class="cell" data-execution_count="38">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb44-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> run_workflow(topic: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> State:</span>
<span id="cb44-2">    state <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> State(topic<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>topic)</span>
<span id="cb44-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>):</span>
<span id="cb44-4">        state.article <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> generate_text_dispatch(state)</span>
<span id="cb44-5">        state.evaluation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> evaluate_text(state)</span>
<span id="cb44-6">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> state.evaluation.is_correct:</span>
<span id="cb44-7">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> state</span>
<span id="cb44-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> state</span>
<span id="cb44-9"></span>
<span id="cb44-10"></span>
<span id="cb44-11">output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> run_workflow(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Substance abuse of athletes"</span>)</span></code></pre></div></div>
</div>
<p>Next, let’s see the LangGraph implementation.</p>
</section>
<section id="langgraph-4" class="level4">
<h4 class="anchored" data-anchor-id="langgraph-4">LangGraph</h4>
<p>You’ll start by defining the state of the workflow and data model required for the workflow.</p>
<div id="cell-103" class="cell" data-execution_count="39">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb45-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Evaluation(BaseModel):</span>
<span id="cb45-2">    explanation: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb45-3">    feedback: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb45-4">    is_correct: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span></span>
<span id="cb45-5"></span>
<span id="cb45-6"></span>
<span id="cb45-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> State(TypedDict):</span>
<span id="cb45-8">    topic: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb45-9">    article: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb45-10">    evaluation: Evaluation</span>
<span id="cb45-11">    num_reviews: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span></span></code></pre></div></div>
</div>
<p>In this case, you keep the number of reviews in the state. That’s how you’ll be able to stop the workflow when the number of reviews is reached.</p>
<p>Next, you must define the functions for each node in the workflow.</p>
<div id="cell-105" class="cell" data-execution_count="40">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb46-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> generate_article(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>:</span>
<span id="cb46-2">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb46-3">        SystemMessage(</span>
<span id="cb46-4">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer. Provided with a topic, you will generate an engaging article with less than 500 words."</span></span>
<span id="cb46-5">        ),</span>
<span id="cb46-6">        HumanMessage(content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Generate a text about this topic:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'topic'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>),</span>
<span id="cb46-7">    ]</span>
<span id="cb46-8">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.invoke(messages)</span>
<span id="cb46-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"article"</span>: response.content}</span>
<span id="cb46-10"></span>
<span id="cb46-11"></span>
<span id="cb46-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> fix_article(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>:</span>
<span id="cb46-13">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb46-14">        SystemMessage(</span>
<span id="cb46-15">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert writer. Provided with a text, you will fix the text to improve it. The text must always use British spelling and grammar."</span></span>
<span id="cb46-16">        ),</span>
<span id="cb46-17">        HumanMessage(</span>
<span id="cb46-18">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"You were tasked with writing an article about </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'topic'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">. You wrote the following text:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'article'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">You've got the following feedback:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'evaluation'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>feedback<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Fix the text to improve it."</span></span>
<span id="cb46-19">        ),</span>
<span id="cb46-20">    ]</span>
<span id="cb46-21">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.invoke(messages)</span>
<span id="cb46-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"article"</span>: response.content}</span>
<span id="cb46-23"></span>
<span id="cb46-24"></span>
<span id="cb46-25"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> evaluate_article(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>:</span>
<span id="cb46-26">    model_with_str_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.with_structured_output(Evaluation)</span>
<span id="cb46-27">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb46-28">        SystemMessage(</span>
<span id="cb46-29">            content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are an expert evaluator. Provided with a text, you will evaluate if it's written in British English and if it's appropriate for a young audience. The text must always use British spelling and grammar. Make sure the text doesn't include any em dash. Be very strict with the evaluation. In case of doubt, return a negative evaluation."</span></span>
<span id="cb46-30">        ),</span>
<span id="cb46-31">        HumanMessage(content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Evaluate the following text:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'article'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>),</span>
<span id="cb46-32">    ]</span>
<span id="cb46-33">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model_with_str_output.invoke(messages)</span>
<span id="cb46-34">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"evaluation"</span>: response, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"num_reviews"</span>: state.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"num_reviews"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>}</span>
<span id="cb46-35"></span>
<span id="cb46-36"></span>
<span id="cb46-37"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> route_text(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb46-38">    evaluation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> state.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"evaluation"</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>)</span>
<span id="cb46-39">    num_reviews <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> state.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"num_reviews"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb46-40">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> evaluation <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> evaluation.is_correct <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> num_reviews <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>:</span>
<span id="cb46-41">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Fail"</span></span>
<span id="cb46-42">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Pass"</span></span>
<span id="cb46-43"></span>
<span id="cb46-44"></span>
<span id="cb46-45"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> generate_article_dispatch(state: State) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>:</span>
<span id="cb46-46">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"evaluation"</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> state <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> state[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"evaluation"</span>]:</span>
<span id="cb46-47">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> fix_article(state)</span>
<span id="cb46-48">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb46-49">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> generate_article(state)</span></code></pre></div></div>
</div>
<p>You define:</p>
<ol type="1">
<li><code>generate_text</code>: This function generates a text based on the topic.</li>
<li><code>evaluate_text</code>: This function evaluates the text based on the topic.</li>
<li><code>fix_text</code>: This function fixes the text based on the feedback.</li>
<li><code>generate_article_dispatch</code>: This function dispatches the text generation task to either the <code>generate_text</code> or <code>fix_text</code> function based on the evaluation.</li>
</ol>
<p>Next, you need to define the graph that will be used to run the workflow.</p>
<div id="cell-107" class="cell" data-execution_count="41">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb47-1">workflow_builder <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> StateGraph(State)</span>
<span id="cb47-2"></span>
<span id="cb47-3">workflow_builder.add_node(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_article"</span>, generate_article_dispatch)</span>
<span id="cb47-4">workflow_builder.add_node(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"evaluate_article"</span>, evaluate_article)</span>
<span id="cb47-5"></span>
<span id="cb47-6">workflow_builder.add_edge(START, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_article"</span>)</span>
<span id="cb47-7">workflow_builder.add_edge(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_article"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"evaluate_article"</span>)</span>
<span id="cb47-8">workflow_builder.add_conditional_edges(</span>
<span id="cb47-9">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"evaluate_article"</span>, route_text, {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Pass"</span>: END, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Fail"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"generate_article"</span>}</span>
<span id="cb47-10">)</span>
<span id="cb47-11"></span>
<span id="cb47-12">workflow <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> workflow_builder.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">compile</span>()</span></code></pre></div></div>
</div>
<p>You start by defining the workflow’s architecture with a StateGraph object. Your functions are then brought in as the nodes, and the operational sequence between them is set by defining the edges. Similar to the <em>Prompt chaining</em> pattern, you can use a conditional edge to dynamically route the workflow’s logic based on its current state. But instead of routing to a node, you route back to the text generation node, and iterate until the text is good enough.</p>
<p>Next, you call the <code>compile</code> method to convert your graph into a runnable workflow. You can also generate a visual diagram of the workflow using the <code>get_graph</code> and <code>draw_mermaid_png</code> functions.</p>
<div id="cell-109" class="cell" data-execution_count="42">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb48-1">display(Image(workflow.get_graph().draw_mermaid_png()))</span></code></pre></div></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="agentic-workflows-langgraph_files/figure-html/cell-43-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="https://dylancastillo.co/posts/agentic-workflows-langgraph_files/figure-html/cell-43-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Finally, you can run the workflow with the <code>invoke</code> method.</p>
<div id="cell-111" class="cell" data-execution_count="43">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb49-1">workflow.invoke({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"topic"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Suggest the use enhancing drugs to athletes"</span>})</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="43">
<pre><code>{'topic': 'Suggest the use enhancing drugs to athletes',
 'article': 'The use of performance-enhancing drugs (PEDs) in sports is a complicated and sensitive topic. These substances are said to help athletes improve their abilities and compete better. However, their use raises important questions about fairness, health, and rules. While some people believe that carefully controlled use of PEDs might have certain benefits, it is a subject that needs thoughtful discussion and clear regulation.\n\nSupporters of PEDs argue that they could make competitions fairer by helping athletes who do not have the same access to training and equipment. In many sports, very small differences can decide the winner, and some athletes may use these drugs to try to even the playing field. If used properly under medical supervision, PEDs might reduce inequalities caused by differences in coaching and resources.\n\nAnother point is that if doctors monitored athletes using these substances, health risks could be lowered. Often, athletes who use PEDs do so in secret and without medical guidance, which can be dangerous. A system of medical support could help ensure that athletes stay as safe as possible, with regular health checks and information about the risks involved.\n\nLegalising PED use might also change how sports organisations spend their money. Instead of focusing on punishing athletes for doping, resources could be put into improving training methods and helping athletes recover and stay healthy. This might encourage research into safer ways to enhance performance.\n\nMoreover, being open about PED use could make sports more honest. Doping has been a problem for a long time, and banning these drugs has not stopped people from using them secretly. A more transparent approach might reduce cheating and allow fans to better understand athletes’ achievements.\n\nDespite these points, it is very important that any use of PEDs is carefully controlled with strict rules, age limits, and ethical standards. Protecting athlete health and fairness in sport must always be the top priority. More research and discussion are needed before any changes are made.\n\nIn summary, although the use of performance-enhancing drugs remains a difficult and controversial issue, thoughtful regulation and openness could potentially improve fairness and safety in sports. However, this topic involves complex ideas that require careful and mature consideration.',
 'evaluation': Evaluation(explanation="The text is written using British English spelling conventions, such as 'legalising' with an 's' instead of 'legalizing'. The grammar is correct and appropriate for a young audience with clear, accessible language and no use of em dashes. The content is presented in a balanced, informative manner that is suitable for young readers, addressing the topic thoughtfully without complex jargon or inappropriate content.", feedback='The text uses British English correctly and is suitable for a young audience. It avoids complex sentence structures and uses accessible vocabulary. There are no em dashes present, maintaining adherence to the criteria. The content is presented in a balanced and neutral way appropriate for educational purposes.', is_correct=True),
 'num_reviews': 2}</code></pre>
</div>
</div>
<p>That’s it! You’ve now seen how to implement the most common agentic workflow patterns with a vanilla approach and with LangGraph.</p>
</section>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Throughout this tutorial, you’ve seen how different agentic workflow patterns solve specific types of problems:</p>
<ul>
<li><strong>Prompt Chaining</strong>: Break complex tasks into sequential steps with clear handoffs</li>
<li><strong>Routing</strong>: Classify inputs and route them to specialized handlers</li>
<li><strong>Parallelization</strong>: Run multiple evaluations or processes simultaneously for speed and diversity</li>
<li><strong>Orchestrator-Workers</strong>: Dynamically decompose tasks and distribute work</li>
<li><strong>Evaluator-Optimizer</strong>: Create feedback loops for iterative quality improvement</li>
</ul>
<p>You’ve learned how to implement these patterns with and without LangGraph. While the vanilla approach give you full control and might be simpler for basic cases, LangGraph gives you many features that make it easier to build complex workflows.</p>
<p>Hope you find this tutorial useful. If you have any questions, let me know in the comments below.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2025,
  author = {Castillo, Dylan},
  title = {Agentic Workflows from Scratch with (and Without)
    {LangGraph}},
  date = {2025-07-03},
  url = {https://dylancastillo.co/posts/agentic-workflows-langgraph.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2025" class="csl-entry quarto-appendix-citeas">
Castillo, Dylan. 2025. <span>“Agentic Workflows from Scratch with (and
Without) LangGraph.”</span> July 3, 2025. <a href="https://dylancastillo.co/posts/agentic-workflows-langgraph.html">https://dylancastillo.co/posts/agentic-workflows-langgraph.html</a>.
</div></div></section></div> ]]></description>
  <category>llm</category>
  <category>python</category>
  <category>anthropic</category>
  <category>openai</category>
  <category>agents</category>
  <guid>https://dylancastillo.co/posts/agentic-workflows-langgraph.html</guid>
  <pubDate>Thu, 03 Jul 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Function calling and structured outputs in LLMs with LangChain and OpenAI</title>
  <dc:creator>Dylan Castillo</dc:creator>
  <link>https://dylancastillo.co/posts/function-calling-structured-outputs.html</link>
  <description><![CDATA[ 




<p>Function calling and structured outputs let you go from chatbots that just talk to agents that interact with the world. They’re two of the most important techniques for building LLM applications.</p>
<p>Function calling let LLMs access external tools and services. Structured outputs ensure that the data coming back from your models is ready to integrate</p>
<p>These are two of the most important techniques for building LLM applications. I can tell you that mastering them will make your applications better and easier to maintain.</p>
<p>In this tutorial, you’ll learn:</p>
<ul>
<li>How function calling and structured outputs work and when to use them</li>
<li>How to implement both techniques using LangChain and OpenAI</li>
<li>Practical examples you can run and adapt for your own projects.</li>
</ul>
<p>Let’s get started.</p>
<section id="function-calling" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="function-calling">Function calling</h2>
<p>Function calling refers to the ability to get LLMs to use external tools or functions. It matters because it gives LLMs more capabilities, allows them to talk to external systems, and enables complex task automation. This is one of the key features that unlocked agents.</p>
<p>The usual flow is:</p>
<ol type="1">
<li>The developer sets up an LLM with a set of predefined tools</li>
<li>The user asks a question</li>
<li>The LLM decides if it needs to use a tool</li>
<li>If it does, it invokes the tool and gets the output from the tool.</li>
<li>The LLM then uses the output to answer the user’s question</li>
</ol>
<p>Here’s a diagram that illustrates how function calling works:</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><a href="./images/function-calling-structured-outputs/diagram.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="Function calling flow"><img src="https://dylancastillo.co/posts/images/function-calling-structured-outputs/diagram.png" class="img-fluid figure-img" alt="Function calling flow"></a></p>
<figcaption class="margin-caption">Function calling flow</figcaption>
</figure>
</div>
<p>AI developers are increasingly using function calling to build more complex systems. You can use it to:</p>
<ul>
<li>Get information from a CRM, DB, etc</li>
<li>Perform calculations (e.g., generate an estimate for a variable, financial calculations)</li>
<li>Manipulate data (e.g., data cleaning, data transformation)</li>
<li>Interact with external systems (e.g., booking a flight, sending an email)</li>
</ul>
</section>
<section id="structured-outputs" class="level2">
<h2 class="anchored" data-anchor-id="structured-outputs">Structured outputs</h2>
<p>Structured outputs are a group of methods that “ensure that model outputs adhere to a specific structure”<sup>1</sup>. With proprietary models, this usually means a JSON schema. With open-weight models, a structure can mean anything from a JSON schema to a specific regex pattern. You can use <a href="https://dottxt-ai.github.io/outlines/latest/">outlines</a> for this.</p>
<p>Structured outputs are very useful to create agentic systems, as they simplify the communication between components. As you can imagine, it’s a lot easier to parse the output of a JSON object than a free-form text. Note, however, that as with other things in life, there’s no free lunch. Using this technique might <a href="https://dylancastillo.co/posts/say-what-you-mean-sometimes.html">impact the performance</a> of your task, so you should have evals in place.</p>
<p>In the next sections, I’ll show you how to use function calling and structured outputs with OpenAI.</p>
</section>
<section id="prerequisites" class="level2">
<h2 class="anchored" data-anchor-id="prerequisites">Prerequisites</h2>
<p>To follow this tutorial you’ll need to:</p>
<ol type="1">
<li>Sign up and generate an API key in <a href="https://platform.openai.com/docs/overview">OpenAI</a>.</li>
<li>Sign up and generate an API key in <a href="https://smith.langchain.com/signup">LangSmith</a>.</li>
<li>Create an <code>.env</code> file with the following variables:</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">OPENAI_API_KEY</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>sk-...</span>
<span id="cb1-2"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">LANGCHAIN_TRACING_V2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>true</span>
<span id="cb1-3"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">LANGSMITH_API_KEY</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>lsv2_...</span>
<span id="cb1-4"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">LANGCHAIN_PROJECT</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"my-project"</span></span></code></pre></div></div>
<ol start="4" type="1">
<li>Create a virtual environment in Python and install the requirements:</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span> venv venv</span>
<span id="cb2-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">source</span> venv/bin/activate</span>
<span id="cb2-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install langchain langsmith pydantic langchain-openai python-dotenv jupyter</span></code></pre></div></div>
<p>Once you’ve completed the steps above, you can run copy and paste the code from the next sections. You can also download the notebook from <a href="../posts/function-calling-structured-outputs.html">here</a>.</p>
</section>
<section id="examples" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="examples">Examples</h2>
<p>As usual, you’ll start by importing the necessary libraries.</p>
<p>You’ll use LangChain to interact with the OpenAI API and Pydantic for data validation.</p>
<div id="cell-4" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> textwrap <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> dedent</span>
<span id="cb3-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Literal</span>
<span id="cb3-3"></span>
<span id="cb3-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> requests</span>
<span id="cb3-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb3-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.messages <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> HumanMessage, SystemMessage</span>
<span id="cb3-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.tools <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tool</span>
<span id="cb3-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatOpenAI</span>
<span id="cb3-9"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langsmith <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> traceable</span>
<span id="cb3-10"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pydantic <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> BaseModel, Field</span>
<span id="cb3-11"></span>
<span id="cb3-12">load_dotenv()</span></code></pre></div></div>
</div>
<p>Now that you’ve imported the libraries, we’ll work on three examples:</p>
<ol type="1">
<li>Providing a model with a single tool</li>
<li>Providing a model with multiple tools</li>
<li>Generating a structured output from a model</li>
</ol>
<section id="function-calling-with-a-single-tool" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="function-calling-with-a-single-tool">Function calling with a single tool</h3>
<p>First you start by defining the model and the tool:</p>
<div id="cell-7" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(model_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4.1-mini"</span>)</span>
<span id="cb4-2"></span>
<span id="cb4-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@tool</span></span>
<span id="cb4-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> find_weather(latitude: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>, longitude: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>):</span>
<span id="cb4-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Get the weather of a given latitude and longitude"""</span></span>
<span id="cb4-6">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> requests.get(</span>
<span id="cb4-7">        <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"https://api.open-meteo.com/v1/forecast?latitude=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>latitude<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">&amp;longitude=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>longitude<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">&amp;current=temperature_2m,wind_speed_10m&amp;hourly=temperature_2m,relative_humidity_2m,wind_speed_10m"</span></span>
<span id="cb4-8">    )</span>
<span id="cb4-9">    data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> response.json()</span>
<span id="cb4-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"current"</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"temperature_2m"</span>]</span>
<span id="cb4-11"></span>
<span id="cb4-12"></span>
<span id="cb4-13">tools_mapping <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb4-14">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"find_weather"</span>: find_weather,</span>
<span id="cb4-15">}</span>
<span id="cb4-16"></span>
<span id="cb4-17">model_with_tools <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.bind_tools([find_weather])</span></code></pre></div></div>
</div>
<p>This code sets up a <code>gpt-4.1-mini</code> model with a single tool. To define a tool, you must define a function and use the <code>@tool</code> decorator. This function must necessarily have a docstring because this will be used to describe the tool to the model. In this case, the tool is a function that takes latitude and longitude values and returns the weather for that location by making a call to the Open Meteo API.</p>
<p>Next, you need to tell your code how to find and use your tools. This is the purpose of <code>tools_mapping</code>. It is a common point of confusion. The LLM doesn’t run the tools on its own. It only decides if a tool should be used. After the model makes its decision, your own code must make the actual tool call.</p>
<p>In this situation, since you only have one tool, a mapping isn’t really necessary. But if you were using multiple tools, which is often the case, you would need to create a “map” that links each tool’s name to its corresponding function. This lets you call the right tool when the model decides to use it.</p>
<p>Finally, you need to <em>bind</em> the tool to the model. The binding makes the model aware of the tool, so that it can use it.</p>
<p>Then, let’s define a function that lets you call the model with the tool.</p>
<div id="cell-9" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@traceable</span></span>
<span id="cb5-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_response(question: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>):</span>
<span id="cb5-3">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb5-4">        SystemMessage(</span>
<span id="cb5-5">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You're a helpful assistant. Use the tools provided when relevant."</span></span>
<span id="cb5-6">        ),</span>
<span id="cb5-7">        HumanMessage(question),</span>
<span id="cb5-8">    ]</span>
<span id="cb5-9">    ai_message <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model_with_tools.invoke(messages)</span>
<span id="cb5-10">    messages.append(ai_message)</span>
<span id="cb5-11"></span>
<span id="cb5-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> tool_call <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ai_message.tool_calls:</span>
<span id="cb5-13">        selected_tool <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tools_mapping[tool_call[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>]]</span>
<span id="cb5-14">        tool_msg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> selected_tool.invoke(tool_call)</span>
<span id="cb5-15">        messages.append(tool_msg)</span>
<span id="cb5-16"></span>
<span id="cb5-17">    ai_message <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model_with_tools.invoke(messages)</span>
<span id="cb5-18">    messages.append(ai_message)</span>
<span id="cb5-19"></span>
<span id="cb5-20">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> ai_message.content</span>
<span id="cb5-21"></span>
<span id="cb5-22"></span>
<span id="cb5-23">response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_response(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What's the weather in Tokyo?"</span>)</span>
<span id="cb5-24"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(response)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>The current temperature in Tokyo is approximately 25.5°C. If you want more detailed weather information, please let me know!</code></pre>
</div>
</div>
<p>This function takes a city name and returns the weather for that city. It uses the <code>find_weather</code> tool to get the weather data.</p>
<p>It works as follows:</p>
<ol type="1">
<li><strong>Line 1</strong> adds a LangSmith’s <code>traceable</code> decorator to the function, so that you can see the trace of the function in the LangSmith UI. If you prefer to not use LangSmith, you can remove this line.</li>
<li><strong>Lines 2 to 10</strong> set up the <a href="https://dylancastillo.co/posts/prompt-engineering-101.html">prompts</a> and call the model.</li>
<li><strong>Lines 12 to 16</strong> is where the magic happens. This is a loop that will check if there’s been a tool call in the response from the model. If there is, it will call (invoke) the tool and add the result to the messages.</li>
<li><strong>Lines 17 to 18</strong> the model is called again to get the final response.</li>
</ol>
<p>When you run this code, you’ll get a text response with the weather for the city you asked for. If you check the trace, you can see how the whole process works:</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><a href="./images/function-calling-structured-outputs/trace-spans.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="Function calling trace"><img src="https://dylancastillo.co/posts/images/function-calling-structured-outputs/trace-spans.png" class="img-fluid figure-img" alt="Function calling trace"></a></p>
<figcaption class="margin-caption">Function calling trace</figcaption>
</figure>
</div>
<p>There are three steps in the process:</p>
<ol type="1">
<li><strong>Initial model call</strong> with the question from the user.</li>
<li><strong>Tool call</strong> to get the weather data.</li>
<li><strong>Final model call</strong> to get the response.</li>
</ol>
<p>If you dig deeper into the first model call, you’ll see how the tool is provided to the model and how the model decides to use it:</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><a href="./images/function-calling-structured-outputs/model-calls-tool.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3" title="Model calls tool"><img src="https://dylancastillo.co/posts/images/function-calling-structured-outputs/model-calls-tool.png" class="img-fluid figure-img" alt="Model calls tool"></a></p>
<figcaption class="margin-caption">Model calls tool</figcaption>
</figure>
</div>
<p>The tools is provided by describing it to the model using the docstring of the function. The parameter and their types are also provided. Then the model responds specifying the name of the tool it wants to use and the parameters it wants to pass to it. This tool is then called:</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><a href="./images/function-calling-structured-outputs/tool-call.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4" title="Tool call"><img src="https://dylancastillo.co/posts/images/function-calling-structured-outputs/tool-call.png" class="img-fluid figure-img" alt="Tool call"></a></p>
<figcaption class="margin-caption">Tool call</figcaption>
</figure>
</div>
<p>The results of the tool call are then passed to the model again. The model then uses the result to generate the final response:</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><a href="./images/function-calling-structured-outputs/tool-call-result.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5" title="Tool call result"><img src="https://dylancastillo.co/posts/images/function-calling-structured-outputs/tool-call-result.png" class="img-fluid figure-img" alt="Tool call result"></a></p>
<figcaption class="margin-caption">Tool call result</figcaption>
</figure>
</div>
<p>That’s it. This how you provide a model with tools. In the next section, you’ll see how to use multiple tools.</p>
</section>
<section id="function-calling-with-multiple-tools" class="level3">
<h3 class="anchored" data-anchor-id="function-calling-with-multiple-tools">Function calling with multiple tools</h3>
<p>Similar to the previous example, you start by defining the tools (using the <code>@tool</code> decorator) and binding them to the model.</p>
<p>In addition to <code>get_weather</code>, you’ll also define a tool to check if a response follows the company guidelines. In this case, the company guidelines are that responses should be written in the style of a haiku.<sup>2</sup></p>
<div id="cell-13" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(model_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4.1-mini"</span>)</span>
<span id="cb7-2"></span>
<span id="cb7-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@tool</span></span>
<span id="cb7-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_weather(latitude: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>, longitude: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>):</span>
<span id="cb7-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Get the weather of a given latitude and longitude"""</span></span>
<span id="cb7-6">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> requests.get(</span>
<span id="cb7-7">        <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"https://api.open-meteo.com/v1/forecast?latitude=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>latitude<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">&amp;longitude=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>longitude<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">&amp;current=temperature_2m,wind_speed_10m&amp;hourly=temperature_2m,relative_humidity_2m,wind_speed_10m"</span></span>
<span id="cb7-8">    )</span>
<span id="cb7-9">    data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> response.json()</span>
<span id="cb7-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"current"</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"temperature_2m"</span>]</span>
<span id="cb7-11"></span>
<span id="cb7-12"></span>
<span id="cb7-13"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@tool</span></span>
<span id="cb7-14"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> check_guidelines(drafted_response: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb7-15">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Check if a given response follows the company guidelines"""</span></span>
<span id="cb7-16">    model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(model_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4.1-mini"</span>)</span>
<span id="cb7-17">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.invoke(</span>
<span id="cb7-18">        [</span>
<span id="cb7-19">            SystemMessage(</span>
<span id="cb7-20">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You're a helpful assistant. Your task is to check if a given response follows the company guidelines. The company guidelines are that responses should be written in the style of a haiku. You should reply with 'OK' or 'REQUIRES FIXING' and a short explanation."</span></span>
<span id="cb7-21">            ),</span>
<span id="cb7-22">            HumanMessage(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Current response: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>drafted_response<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>),</span>
<span id="cb7-23">        ]</span>
<span id="cb7-24">    )</span>
<span id="cb7-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response.content</span>
<span id="cb7-26"></span>
<span id="cb7-27"></span>
<span id="cb7-28">tools_mapping <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb7-29">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"get_weather"</span>: get_weather,</span>
<span id="cb7-30">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"check_guidelines"</span>: check_guidelines,</span>
<span id="cb7-31">}</span>
<span id="cb7-32"></span>
<span id="cb7-33">model_with_tools <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.bind_tools([get_weather, check_guidelines])</span></code></pre></div></div>
</div>
<p>This code defines the tools and binds them to the model. Just like we did before, you also need to define a mapping of the tools, so that you can call the right tool when the model decides to use it.</p>
<div id="cell-15" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@traceable</span></span>
<span id="cb8-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_response(question: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>):</span>
<span id="cb8-3">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb8-4">        SystemMessage(</span>
<span id="cb8-5">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You're a helpful assistant. Use the tools provided when relevant. Then draft a response and check if it follows the company guidelines. Only respond to the user after you've validated and modified the response if needed."</span></span>
<span id="cb8-6">        ),</span>
<span id="cb8-7">        HumanMessage(question),</span>
<span id="cb8-8">    ]</span>
<span id="cb8-9">    ai_message <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model_with_tools.invoke(messages)</span>
<span id="cb8-10">    messages.append(ai_message)</span>
<span id="cb8-11"></span>
<span id="cb8-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">while</span> ai_message.tool_calls:</span>
<span id="cb8-13">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> tool_call <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> ai_message.tool_calls:</span>
<span id="cb8-14">            selected_tool <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tools_mapping[tool_call[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>]]</span>
<span id="cb8-15">            tool_msg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> selected_tool.invoke(tool_call)</span>
<span id="cb8-16">            messages.append(tool_msg)</span>
<span id="cb8-17">        ai_message <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model_with_tools.invoke(messages)</span>
<span id="cb8-18">        messages.append(ai_message)</span>
<span id="cb8-19"></span>
<span id="cb8-20">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> ai_message.content</span>
<span id="cb8-21"></span>
<span id="cb8-22"></span>
<span id="cb8-23">response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_response(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What is the temperature in Madrid?"</span>)</span>
<span id="cb8-24"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(response)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sunny Madrid basks,  
Thirty-six degrees embrace,  
Summer's warm caress.</code></pre>
</div>
</div>
<p>This code is pretty much the same as the previous example, but with two tools. There’s also a one small difference.</p>
<p>Previously, we checked for tool calls once. Now, we’ll use a while loop that keeps checking. So, instead of the model having to provide the final answer after one turn, it can now ask for tools multiple times in a row until it has all the information it needs.</p>
<p>This is the core idea behind how agents work. So, congratulations, you’ve just built a simple agent! If you check the process in LangSmith, you’ll see how these turns play out.</p>
<p>Next, let’s see how to use structured outputs.</p>
</section>
<section id="structured-outputs-1" class="level3">
<h3 class="anchored" data-anchor-id="structured-outputs-1">Structured outputs</h3>
<p>Structured outputs are a set of methods used to get model outputs that follow a specific structure. This is useful when you want to get a specific type of output, such as a JSON object.</p>
<p>It’s easy to set up with proprietary models. With LangChain, you can define a <code>dict</code> or a <a href="https://docs.pydantic.dev/latest/concepts/models/">Pydantic model</a> to describe the output. I recommend using Pydantic models.</p>
<p>For example, let’s define a Pydantic model that will help us classify document into categories:</p>
<div id="cell-19" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> DocumentInfo(BaseModel):</span>
<span id="cb10-2">    category: Literal[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"financial"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"legal"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"marketing"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pets"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"other"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(</span>
<span id="cb10-3">        description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The category of the document"</span></span>
<span id="cb10-4">    )</span>
<span id="cb10-5">    summary: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Field(description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A short summary of the document"</span>)</span></code></pre></div></div>
</div>
<p>This model defines the structured output we’ll get from the model. It has two fields: <code>category</code> and <code>summary</code>.</p>
<p>Then, you can use the <code>with_structured_output</code> method to create a model that will return the structured output:</p>
<div id="cell-21" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4.1-mini"</span>, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb11-2"></span>
<span id="cb11-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_document_info(document: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> DocumentInfo:</span>
<span id="cb11-4">    model_with_structure <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.with_structured_output(DocumentInfo)</span>
<span id="cb11-5">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model_with_structure.invoke(document)</span>
<span id="cb11-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response</span>
<span id="cb11-7"></span>
<span id="cb11-8"></span>
<span id="cb11-9">document_text <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dedent(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb11-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">This is a document about cats. Very important document. It explain how cats will take over the world in 20230.</span></span>
<span id="cb11-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb11-12">)</span>
<span id="cb11-13">document_info <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_document_info(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I'm a document about a cat"</span>)</span>
<span id="cb11-14"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(document_info)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>category='pets' summary='A document about a cat.'</code></pre>
</div>
</div>
<p>After running this code, you’ll get a structured output with the category and summary of the document that you can then use in further steps of your workflow.</p>
<p>Depending on the provider, you’ll have different options to get structured outputs. OpenAI offers three different methods:</p>
<ul>
<li><code>function_calling</code>: This uses the tool calling mechanism to get the structured output.</li>
<li><code>json_mode</code>: This method ensures you get a valid JSON object, but it’s not clear how it works under the hood.</li>
<li><code>json_schema</code>: This is default method in LangChain. It ensures that the output is a valid JSON object and that it matches the schema you provide using <a href="https://openai.com/index/introducing-structured-outputs-in-the-api/">constrained decoding</a>.</li>
</ul>
<p><a href="https://ai.google.dev/gemini-api/docs/structured-output">Gemini</a> and <a href="https://docs.anthropic.com/en/docs/test-and-evaluate/strengthen-guardrails/increase-consistency">Anthropic</a> provide their own methods to get structured outputs.</p>
<p>One thing to keep in mind is that structured outputs can impact performance. I’ve <a href="https://dylancastillo.co/posts/llm-pydantic-order-matters.html">written</a> <a href="https://dylancastillo.co/posts/say-what-you-mean-sometimes.html">multiple</a> <a href="https://dylancastillo.co/posts/gemini-structured-outputs.html">posts</a> about this topic, so I won’t go into detail here.</p>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Function calling and structured outputs are powerful tools that help build more capable AI systems. They’re also the foundation of agents.</p>
<p>Function calling is a way to provide LLMs with tools to use. It lets you go from building a chatbot that can only talk to building an AI assistant that can actually interact with the world. It opens up a world of possibilities, from connecting to databases, calling APIs, or automating workflows.</p>
<p>Structured outputs are just as important. They’re critical to integrating LLMs into existing systems. Instead of struggling with parsing free-form text, you get clean, predictable data structures that you can use in your code.</p>
<p>The examples in this tutorial should give you a sense of how to use these methods. But as usual, the real learning happens when you start applying these concepts to your own problems. Pick a task you’re working on, see if any of these methods can help you, and give it a try.</p>
<p>If you have any questions or comments, let me know in the comments below.</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p><a href="https://arxiv.org/abs/2404.07362">“We Need Structured Output”: Towards User-centered Constraints on LLM Output. MX Liu et al.&nbsp;2024</a>↩︎</p></li>
<li id="fn2"><p>Please don’t judge me. Companies do all sorts of weird things these days.↩︎</p></li>
</ol>
</section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2025,
  author = {Castillo, Dylan},
  title = {Function Calling and Structured Outputs in {LLMs} with
    {LangChain} and {OpenAI}},
  date = {2025-07-01},
  url = {https://dylancastillo.co/posts/function-calling-structured-outputs.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2025" class="csl-entry quarto-appendix-citeas">
Castillo, Dylan. 2025. <span>“Function Calling and Structured Outputs in
LLMs with LangChain and OpenAI.”</span> July 1, 2025. <a href="https://dylancastillo.co/posts/function-calling-structured-outputs.html">https://dylancastillo.co/posts/function-calling-structured-outputs.html</a>.
</div></div></section></div> ]]></description>
  <category>llm</category>
  <category>function-calling</category>
  <category>structured-outputs</category>
  <category>openai</category>
  <guid>https://dylancastillo.co/posts/function-calling-structured-outputs.html</guid>
  <pubDate>Tue, 01 Jul 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>What is Retrieval Augmented Generation (RAG)?</title>
  <dc:creator>Dylan Castillo</dc:creator>
  <link>https://dylancastillo.co/posts/what-is-rag.html</link>
  <description><![CDATA[ 




<p><a href="https://arxiv.org/abs/2005.11401">Retrieval Augmented Generation (RAG)</a> is the most popular approach to providing LLMs with external information before they generate a response.</p>
<p>RAG is a technique where you <strong>retrieve</strong> the information required to solve a user’s query, then <strong>augment</strong> the context of the LLM with that information, and <strong>generate</strong> a response. In this tutorial, you’ll learn why RAG is useful, when to use it, and how to build your own RAG pipeline, step-by-step, using Python.</p>
<p>Let’s get started!</p>
<section id="what-is-rag" class="level2">
<h2 class="anchored" data-anchor-id="what-is-rag">What is RAG?</h2>
<p>It’s a technique to improve LLM answers by providing them with external information before they generate a response. It consists of three steps:</p>
<ol type="1">
<li><strong>Retrieve:</strong> The system starts by searching a specific knowledge base for relevant information about the query.</li>
<li><strong>Augment:</strong> This retrieved information is added to context that’s used by the LLM to generate a response.</li>
<li><strong>Generate:</strong> The LLM uses both your question and the provided information to generate an answer.</li>
</ol>
<p>In addition to reducing costs and latency, RAG is useful because it reduces <a href="https://en.wikipedia.org/wiki/Hallucination_(artificial_intelligence)">hallucinations</a>, lets you use current data, and builds trust with users by (potentially) providing citations.</p>
</section>
<section id="vector-databases" class="level2">
<h2 class="anchored" data-anchor-id="vector-databases">Vector databases</h2>
<p>A vector database (VectorDB) is a database designed to store and query data as vector embeddings (numerical representations). So, provided with a user query, it’s the engine you use to find the most similar data in your database. It’s one of the most popular components of the retrieval step in RAG pipelines.</p>
<p>In recent years, many new vector databases have been created. But, in most cases, they had to <a href="https://qdrant.tech/articles/bm42/">re-discover</a> that many of the ideas in the old generation of vector databases such as BM25-based retrieval were still valid and useful.</p>
<p>Some popular vector databases are:</p>
<ol type="1">
<li><em>New generation:</em> <a href="https://qdrant.tech/">Qdrant</a>, <a href="https://www.trychroma.com/">Chroma</a>, <a href="https://www.pinecone.io/">Pinecone</a>, <a href="https://weaviate.io/">Weaviate</a>.</li>
<li><em>Old generation:</em> <a href="https://www.elastic.co/">Elasticsearch</a>/<a href="https://opensearch.org/">OpenSearch</a> and <a href="https://github.com/pgvector/pgvector">Postgres+PGVector</a></li>
</ol>
<p>In this tutorial, you’ll use Chroma. For client projects, I’ve used Elasticsearch, Postgres, Weaviate, and Qdrant. Many companies are already using Elasticsearch or Postgres, so it’s often easier to get started with them.</p>
<section id="why-use-a-vectordb" class="level3">
<h3 class="anchored" data-anchor-id="why-use-a-vectordb">Why use a VectorDB?</h3>
<p>If you have a small dataset, there’s no real reason to use a vector database. But if you’re dealing with thousands or millions of documents, you’ll need to use a vector database to efficiently retrieve the most relevant documents.</p>
<p>They’re useful because:</p>
<ol type="1">
<li>The <a href="https://arxiv.org/abs/2309.01431">more noise</a> in the context provided to the LLM, the more likely it is to produce bad output.</li>
<li>It takes more time to process a longer context.</li>
<li>It costs more to process a longer context.</li>
</ol>
</section>
<section id="retrieval" class="level3">
<h3 class="anchored" data-anchor-id="retrieval">Retrieval</h3>
<p>Retrieval is the process of finding the most relevant documents in the vector database. There are two main approaches when dealing with text-based data: term-based retrieval and embedding-based retrieval.</p>
<section id="term-based-retrieval" class="level4">
<h4 class="anchored" data-anchor-id="term-based-retrieval">Term-based retrieval</h4>
<p>Term-based retrieval is a technique that uses the terms in the query to find the most relevant documents in the vector database.</p>
<p>It’s based on the following ideas:</p>
<ol type="1">
<li><strong>TF-IDF:</strong> Counts how often a term appears in this document (TF). Measures how rare the word is across all documents (IDF). Highlights terms important and unique to this specific document.</li>
<li><strong>Okapi BM25:</strong> Expands TF-IDF to introduce a weighting mechanism for term saturation and document length.</li>
</ol>
</section>
<section id="embedding-based-retrieval" class="level4">
<h4 class="anchored" data-anchor-id="embedding-based-retrieval">Embedding-based retrieval</h4>
<p>Embedding-based retrieval is a technique that uses the embedding of the query to find the most relevant documents in the vector database.</p>
<p>For small datasets, you can use k Nearest Neighbors (k-NN) approach to find the most relevant documents following this approach:</p>
<ol type="1">
<li>Calculate the similarity score between the query vector and every other vector stored in the VectorDB.</li>
<li>Sort all the vectors based on these similarity scores</li>
<li>Return the ‘k’ most similar vectors (relative to the query).</li>
</ol>
<p>For large datasets, you can use Approximate Nearest Neighbors (ANN) algorithms such as Locality-Sensitive Hashing (LSH) or Hierarchical Navigable Small World (HNSW) to find the most relevant documents.</p>
</section>
</section>
</section>
<section id="prerequisites" class="level2">
<h2 class="anchored" data-anchor-id="prerequisites">Prerequisites</h2>
<p>To follow this tutorial you’ll need to:</p>
<ol type="1">
<li>Sign up and generate an API key in <a href="https://platform.openai.com/docs/overview">OpenAI</a>.</li>
<li>Set the API key as an environment variable called <code>OPENAI_API_KEY</code>.</li>
<li>Create a virtual environment in Python and install the requirements:</li>
<li>Download the <a href="../_extras/what-is-rag/bbva.pdf">sample PDF file</a></li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span> venv venv</span>
<span id="cb1-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">source</span> venv/bin/activate</span>
<span id="cb1-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install langchain chromadb langchain-openai langchain-community python-dotenv pypdf jupyter</span></code></pre></div></div>
<p>Once you’ve completed the steps above, you can run copy and paste the code from the next sections. You can also download the notebook from <a href="https://github.com/dylanjcastillo/blog/tree/main/posts/what-is-rag.ipynb">here</a>.</p>
</section>
<section id="rag-without-vector-database" class="level2">
<h2 class="anchored" data-anchor-id="rag-without-vector-database">RAG without vector database</h2>
<p>Let’s go through an example without a VectorDB. We’ll use a sample document that’s about the conditions of some specific banking product. Our goal is to be able to ask questions about it, and get accurate answers.</p>
<p>For the first version of the pipeline, we’ll simply <em>augment</em> the context with the full text of the document. So there’s no real retrieval step in this version. We’ll get to that in the next section.</p>
<p>Start by importing the necessary libraries and load the required variables from the .env file.</p>
<div id="cell-4" class="cell" data-execution_count="49">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb2-2"></span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> chromadb</span>
<span id="cb2-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> chromadb.utils.embedding_functions <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAIEmbeddingFunction</span>
<span id="cb2-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb2-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_community.document_loaders <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> PyPDFLoader</span>
<span id="cb2-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_core.messages <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> HumanMessage, SystemMessage</span>
<span id="cb2-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatOpenAI</span>
<span id="cb2-9"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain_text_splitters <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> RecursiveCharacterTextSplitter</span>
<span id="cb2-10"></span>
<span id="cb2-11">load_dotenv()</span></code></pre></div></div>
</div>
<p>This code will import the necessary libraries and load the required variables from the .env file.</p>
<section id="read-the-document-retrieval" class="level3">
<h3 class="anchored" data-anchor-id="read-the-document-retrieval">Read the document (retrieval)</h3>
<p>Next, we’ll use a <code>DocumentLoader</code> to read the document from the PDF file. Since, we’re dealing with a PDF, we’ll use <code>PyPDFLoader</code>.</p>
<p>There are many other document loaders available in LangChain. You can find the full list <a href="https://python.langchain.com/docs/integrations/document_loaders/">here</a>.</p>
<div id="cell-8" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1">file_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../_extras/what-is-rag/bbva.pdf"</span></span>
<span id="cb3-2">loader <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> PyPDFLoader(file_path)</span>
<span id="cb3-3">pages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb3-4"></span>
<span id="cb3-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> page <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> loader.lazy_load():</span>
<span id="cb3-6">    pages.append(page)</span></code></pre></div></div>
</div>
<p>A <code>DocumentLoader</code> is a class that processes a document and returns a list of <code>Document</code> objects. In the case of <code>PyPDFLoader</code>, it will read each page of the PDF file and return the text of each page with some additional metadata.</p>
<p>A single page will look like this:</p>
<div id="cell-10" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1">pages[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].model_dump()</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>{'id': None,
 'metadata': {'producer': 'Adobe PDF Library 15.0',
  'creator': 'Adobe InDesign 16.1 (Windows)',
  'creationdate': '2021-03-24T14:51:54+01:00',
  'moddate': '2021-03-24T14:51:54+01:00',
  'trapped': '/False',
  'source': '../_extras/what-is-rag/bbva.pdf',
  'total_pages': 4,
  'page': 0,
  'page_label': '1'},
 'page_content': "EDICIÓN AQUA PREP 01-01\nBANCO BILBAO VIZCAYA ARGENTARIA, S.A. - Plaza de San Nicolás, 4 - 48005 BILBAO\nReg. Mer. Vizcaya -T omo 3858, Folio 1, Hoja BI-17 BIS-A, Inscripción 1035ª C.I.F.: A48265169\n1 / 4\nThis document contains the Pre-contractual information and the Prior General Information of the Aqua Pre-paid Card contract \n(hereinafter, the Card) in accordance with the provisions of the Ministerial Order ECE/1263/2019, on the transparency of \ninformation conditions applicable to payment services, and Bank of Spain Circular 5/2012, on the transparency of banking services \nand responsibility in the granting of loans.\nThe information highlighted in bold is especially important, in accordance with Circular 5/2012\n1. ON THE PAYMENT SERVICE PROVIDER\n1.1 Details and registration\nBANCO BILBAO VIZCAYA ARGENTARIA, S.A.\nAddress: Plaza San Nicolás, 4 - 48005 BILBAO. \nPhone number: 900 102 801\nWebsite address: www.bbva.es\nRegistered in the Biscay Commercial Register, Volume 2083, \nFolio 1, Sheet BI-17-A, Entry 1\n1.2 Supervisory Authorities:\nBanco de España (Registry 0182)\n[Spanish National Securities Market Commission]\n2. ON THE USE OF THE PAYMENT SERVICES\n2.1 Main characteristics: PREPAID CARD .\nThe Holder may specify that the card be physical or virtual. \nT erms and conditions governing the availability of funds: in \nother words, when and how the holder will obtain the money:\na) The Card, against a balance previously loaded on it, \nmay be used to purchase goods or services in any of \nthe physical or virtual establishments affiliated with the \ncard systems to which the Card belongs and that are \nshown on it.\nb) T o make online payments with the Card, the Account \nHolder must consult the details pertaining to the card \nnumber, expiration date and CVV via the BBVA website \nor mobile app.\nc) Withdraw money from ATMs, Bank branches and \nany other entities that allow it against the balance \npreviously loaded on it.\nT ransactions carried out with the Card will reduce the \navailable balance.\nUnder no circumstances may transactions be carried out \nin excess of the current unused loaded balance at any time \n(available balance).\n2.2 Conducting transactions. Consent.\nT o withdraw money or pay with the Card in physical \nestablishments, you must present the Card and enter your \npersonal identification number (PIN).\nThe Card's contactless technology can be used to pay or \nwithdraw cash with the Card without having to enter the PIN for \ntransactions under 50 euros.\nFor online shop purchases, you must identify yourself in the \nmanner indicated by the Bank, enter the security password and \nfollow the procedure specified by the Bank..\n2.3 Execution period\nThe transactions will be charged to the Direct Debit Account on \nthe date on which they were executed.\nPre-contractual information and \ninformation  booklet  prior to \nconcluding the payment services \ncontract\nAQUA PRE-PAID CARD",
 'type': 'Document'}</code></pre>
</div>
</div>
<p>In addition to the page content, each Document object includes metadata about the source file, the page number, and other information.</p>
</section>
<section id="augment-the-context" class="level3">
<h3 class="anchored" data-anchor-id="augment-the-context">Augment the context</h3>
<p>Now that we have all the pages of the PDF available as text, let’s build the context we’ll use to generate a response.</p>
<p>We’ll define a system and a user prompt. In the system prompt, we’ll define the role of the assistant and in the user prompt, we’ll provide the user question and the documents.</p>
<div id="cell-14" class="cell" data-execution_count="24">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1">system_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb6-2"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">You are a helpful assistant that can answer questions about the provided context.</span></span>
<span id="cb6-3"></span>
<span id="cb6-4"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Please cite the page number used to answer the question. Write the page number in the format "Page X" at the end of your answer. </span></span>
<span id="cb6-5"></span>
<span id="cb6-6"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">If the answer is not found in the context, please say so.</span></span>
<span id="cb6-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb6-8">user_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb6-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Please answer the following question based on the context provided:</span></span>
<span id="cb6-10"></span>
<span id="cb6-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Question: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{question}</span></span>
<span id="cb6-12"></span>
<span id="cb6-13"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Documents:</span></span>
<span id="cb6-14"><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{documents}</span></span>
<span id="cb6-15"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb6-16"></span>
<span id="cb6-17">pages_str <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span></span>
<span id="cb6-18"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, page <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(pages):</span>
<span id="cb6-19">    pages_str <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"--- PAGE </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> ---</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>page<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>page_content<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span></code></pre></div></div>
</div>
<p>We’ve set up the system and user prompt, and a a variable that stores the pages we extracted as a single string. When we make a request to the model, we’ll combine all of these into messages and send them to the model.</p>
<p>Now, we’re ready to generate a response.</p>
</section>
<section id="generate-response" class="level3">
<h3 class="anchored" data-anchor-id="generate-response">Generate response</h3>
<p>To generate a response we’ll use <code>gpt-4.1-mini</code> and combine the system and user prompts we’ve built to augment the model’s context.</p>
<div id="cell-18" class="cell" data-execution_count="27">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4.1-mini"</span>, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb7-2"></span>
<span id="cb7-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_response(context_vars: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>):</span>
<span id="cb7-4">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb7-5">        SystemMessage(content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>system_prompt),</span>
<span id="cb7-6">        HumanMessage(content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>user_prompt.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>context_vars)),</span>
<span id="cb7-7">    ]</span>
<span id="cb7-8">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.invoke(messages)</span>
<span id="cb7-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response.content</span>
<span id="cb7-10"></span>
<span id="cb7-11"></span>
<span id="cb7-12">question <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What is the main idea of the document?"</span></span>
<span id="cb7-13">response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_response({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>: question, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"documents"</span>: pages_str})</span>
<span id="cb7-14"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(response)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>The main idea of the document is to provide the pre-contractual and general information regarding the Aqua Pre-paid Card offered by Banco Bilbao Vizcaya Argentaria, S.A. (BBVA). It outlines the terms and conditions of the card, including its features, usage, fees, security measures, responsibilities of the cardholder and the bank, contract duration, amendments, termination, applicable law, dispute resolution procedures, and other important legal aspects. The document aims to ensure transparency and inform potential cardholders about their rights and obligations before entering into the contract. 

Page 1 to Page 4</code></pre>
</div>
</div>
<p>In this code, we’ve combined the system, user prompt, the pages extracted from the document, and a user question (“What is the main idea of the document?”) into messages the model can understand.</p>
<p>I tried it with a couple of questions and it worked well. The answers were accurate. Try changing the question and see how the model responds.</p>
<div id="cell-20" class="cell" data-execution_count="28">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1">question <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What are the daily transaction limits?"</span></span>
<span id="cb9-2">response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_response({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>: question, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"documents"</span>: pages_str})</span>
<span id="cb9-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(response)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>The daily transaction limits for the Aqua Pre-paid Card are as follows: The daily purchase limit will be determined by the Card's balance and up to a maximum of 1,000 euros per day. The Holder and the Bank may modify the initially specified limits. Additionally, the monthly limit for collecting lottery and gambling prizes is ten thousand euros. (Page 2)</code></pre>
</div>
</div>
<p>As long as the document contains the information you need, you will likely get an accurate answer from the model.</p>
<p>But you can do better. Right now, the model is using the full text of the document to answer the question. Most questions only require a few sentences from the document.</p>
<p>To answer the “What are the daily transaction limits?”, the model used 3,528 input tokens. While in reality, it needed less than 500 input tokens.</p>
<p>For small documents such as this one, the difference isn’t a big deal. But when you’re dealing with thousands of documents and potentially millions of tokens, the difference can be significant in terms of costs, latency, and accuracy.</p>
<p>Let’s see how we can use a VectorDB to improve improve this.</p>
</section>
</section>
<section id="rag-with-vector-search" class="level2">
<h2 class="anchored" data-anchor-id="rag-with-vector-search">RAG with vector search</h2>
<p>You’ll need to start by doing two things: defining an embedding function, and creating a VectorDB.</p>
<p>In this example, we’ll use the OpenAIEmbeddingFunction to create embeddings and Chroma to store them.</p>
<div id="cell-24" class="cell" data-execution_count="29">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1">openai_ef <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAIEmbeddingFunction(api_key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>os.getenv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OPENAI_API_KEY"</span>))</span>
<span id="cb11-2">vector_db <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> chromadb.PersistentClient()</span>
<span id="cb11-3"></span>
<span id="cb11-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb11-5">    collection <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> vector_db.delete_collection(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bbva"</span>)</span>
<span id="cb11-6"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span>:</span>
<span id="cb11-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pass</span></span>
<span id="cb11-8"></span>
<span id="cb11-9">collection <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> vector_db.create_collection(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bbva"</span>, embedding_function<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>openai_ef)</span></code></pre></div></div>
</div>
<p>In this code, you’ve set up the embedding function and created a VectorDB. The embedding function converts chunks of text from the document into vectors. The VectorDB stores these vectors and allows you to query them based on similarity to the question.</p>
<p>Next, you’ll need to split the pages into smaller chunks that you can query the VectorDB with.</p>
<section id="split-and-index-documents" class="level3">
<h3 class="anchored" data-anchor-id="split-and-index-documents">Split and index documents</h3>
<p>The RecursiveCharacterTextSplitter is a class that splits text into chunks of a specified size. It’s a recursive approach that splits the text into smaller chunks using a hierarchy of delimiters (e.g., <code>"\\n\\n"</code>, <code>"\n"</code>, <code>"."</code>, etc.).</p>
<p>In this example, we’ll use a chunk size of 1,000 characters and an overlap of 200 characters. However, in practice bigger chunks seem to work well and simplify a lot the indexing process. Popular embedding functions can handle up to 8,192 tokens, which is ~32,000 characters. You might want to start there.</p>
<div id="cell-28" class="cell" data-execution_count="30">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1">text_splitter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RecursiveCharacterTextSplitter(chunk_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, chunk_overlap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)</span>
<span id="cb12-2">all_splits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> text_splitter.split_documents(pages)</span></code></pre></div></div>
</div>
<p>This code will split the documents and save those splits into <code>all_splits</code>. Then you need to add those chunks into your VectorDB.</p>
<p>ChromaDB provides you with a simple way to add chunks to your VectorDB:</p>
<div id="cell-30" class="cell" data-execution_count="31">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1">collection.add(</span>
<span id="cb13-2">    documents<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[split.page_content <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> split <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> all_splits],</span>
<span id="cb13-3">    metadatas<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[split.metadata <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> split <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> all_splits],</span>
<span id="cb13-4">    ids<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(i) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(all_splits))],</span>
<span id="cb13-5">)</span></code></pre></div></div>
</div>
<p>This will add the chunks to your VectorDB. In addition to the chunks, this will add the metadata of each chunk and generate unique IDs for each chunk.</p>
</section>
<section id="query-the-database" class="level3">
<h3 class="anchored" data-anchor-id="query-the-database">Query the database</h3>
<p>Once the chunks are in the VectorDB, you can query them with the question.</p>
<div id="cell-34" class="cell" data-execution_count="38">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1">collection.query(</span>
<span id="cb14-2">    query_texts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What are the daily transaction limits?"</span>],</span>
<span id="cb14-3">    n_results<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb14-4">)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="38">
<pre><code>{'ids': [['4']],
 'embeddings': None,
 'documents': [["EDICIÓN AQUA PREP 01-01\nBANCO BILBAO VIZCAYA ARGENTARIA, S.A. - Plaza de San Nicolás, 4 - 48005 BILBAO\nReg. Mer. Vizcaya -T omo 3858, Folio 1, Hoja BI-17 BIS-A, Inscripción 1035ª C.I.F.: A48265169\n2 / 4 \n2.4 T ransaction limits. \nThe daily purchase limit will be determined by the Card's \nbalance and up to a maximum of 1,000 euros per day. The \nHolder and the Bank may modify the initially specified limits. \nThe monthly limit for collecting lottery and gambling prizes is \nten thousand euros.\n2.5 T o sign up for the card, you do not need to take out \nany other accessory service.\n3. ON COSTS AND INTEREST AND EXCHANGE RATES\nMonthly top-up limit: Minimum of 6, maximum of 1000\nThe applicable fees for using the card may be:\na) Pre-paid card issue and maintenance fee: 5 euros.\nb) Fee for issuance of duplicates: 4 euros.\nc) Fee for using the card outside the Eurozone: 3% \napplicable to the exchange value in euros.\nd) Fees to withdraw cash against the card balance at ATMs:"]],
 'uris': None,
 'included': ['metadatas', 'documents', 'distances'],
 'data': None,
 'metadatas': [[{'page_label': '2',
    'source': '../_extras/what-is-rag/bbva.pdf',
    'producer': 'Adobe PDF Library 15.0',
    'total_pages': 4,
    'trapped': '/False',
    'creationdate': '2021-03-24T14:51:54+01:00',
    'page': 1,
    'creator': 'Adobe InDesign 16.1 (Windows)',
    'moddate': '2021-03-24T14:51:54+01:00'}]],
 'distances': [[0.3241901397705078]]}</code></pre>
</div>
</div>
<p>You can even query it with multiple questions at once:</p>
<div id="cell-36" class="cell" data-execution_count="39">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1">collection.query(</span>
<span id="cb16-2">    query_texts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What are the daily transaction limits?"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What is the maximum amount I can withdraw?"</span>],</span>
<span id="cb16-3">    n_results<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb16-4">)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<pre><code>{'ids': [['4'], ['4']],
 'embeddings': None,
 'documents': [["EDICIÓN AQUA PREP 01-01\nBANCO BILBAO VIZCAYA ARGENTARIA, S.A. - Plaza de San Nicolás, 4 - 48005 BILBAO\nReg. Mer. Vizcaya -T omo 3858, Folio 1, Hoja BI-17 BIS-A, Inscripción 1035ª C.I.F.: A48265169\n2 / 4 \n2.4 T ransaction limits. \nThe daily purchase limit will be determined by the Card's \nbalance and up to a maximum of 1,000 euros per day. The \nHolder and the Bank may modify the initially specified limits. \nThe monthly limit for collecting lottery and gambling prizes is \nten thousand euros.\n2.5 T o sign up for the card, you do not need to take out \nany other accessory service.\n3. ON COSTS AND INTEREST AND EXCHANGE RATES\nMonthly top-up limit: Minimum of 6, maximum of 1000\nThe applicable fees for using the card may be:\na) Pre-paid card issue and maintenance fee: 5 euros.\nb) Fee for issuance of duplicates: 4 euros.\nc) Fee for using the card outside the Eurozone: 3% \napplicable to the exchange value in euros.\nd) Fees to withdraw cash against the card balance at ATMs:"],
  ["EDICIÓN AQUA PREP 01-01\nBANCO BILBAO VIZCAYA ARGENTARIA, S.A. - Plaza de San Nicolás, 4 - 48005 BILBAO\nReg. Mer. Vizcaya -T omo 3858, Folio 1, Hoja BI-17 BIS-A, Inscripción 1035ª C.I.F.: A48265169\n2 / 4 \n2.4 T ransaction limits. \nThe daily purchase limit will be determined by the Card's \nbalance and up to a maximum of 1,000 euros per day. The \nHolder and the Bank may modify the initially specified limits. \nThe monthly limit for collecting lottery and gambling prizes is \nten thousand euros.\n2.5 T o sign up for the card, you do not need to take out \nany other accessory service.\n3. ON COSTS AND INTEREST AND EXCHANGE RATES\nMonthly top-up limit: Minimum of 6, maximum of 1000\nThe applicable fees for using the card may be:\na) Pre-paid card issue and maintenance fee: 5 euros.\nb) Fee for issuance of duplicates: 4 euros.\nc) Fee for using the card outside the Eurozone: 3% \napplicable to the exchange value in euros.\nd) Fees to withdraw cash against the card balance at ATMs:"]],
 'uris': None,
 'included': ['metadatas', 'documents', 'distances'],
 'data': None,
 'metadatas': [[{'source': '../_extras/what-is-rag/bbva.pdf',
    'page': 1,
    'total_pages': 4,
    'creator': 'Adobe InDesign 16.1 (Windows)',
    'creationdate': '2021-03-24T14:51:54+01:00',
    'moddate': '2021-03-24T14:51:54+01:00',
    'producer': 'Adobe PDF Library 15.0',
    'page_label': '2',
    'trapped': '/False'}],
  [{'page_label': '2',
    'trapped': '/False',
    'source': '../_extras/what-is-rag/bbva.pdf',
    'creator': 'Adobe InDesign 16.1 (Windows)',
    'total_pages': 4,
    'creationdate': '2021-03-24T14:51:54+01:00',
    'moddate': '2021-03-24T14:51:54+01:00',
    'producer': 'Adobe PDF Library 15.0',
    'page': 1}]],
 'distances': [[0.3241901397705078], [0.416978657245636]]}</code></pre>
</div>
</div>
<p>Now, let’s add the VectorDB into our RAG pipeline.</p>
</section>
<section id="rag-pipeline" class="level3">
<h3 class="anchored" data-anchor-id="rag-pipeline">RAG pipeline</h3>
<p>First, start by defining a function that does the retrieval of the most relevant documents.</p>
<div id="cell-40" class="cell" data-execution_count="43">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_relevant_docs(question: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, top_k: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>):</span>
<span id="cb18-2">    relevant_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> collection.query(query_texts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>question, n_results<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>top_k)</span>
<span id="cb18-3">    documents <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> relevant_docs[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"documents"</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb18-4">    metadatas <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> relevant_docs[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"metadatas"</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb18-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> [</span>
<span id="cb18-6">        {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"page_content"</span>: doc, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Document"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"metadata"</span>: metadata}</span>
<span id="cb18-7">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc, metadata <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(documents, metadatas)</span>
<span id="cb18-8">    ]</span></code></pre></div></div>
</div>
<p>This function will take a question and return the <code>top_k</code> most relevant chunks from the document. Here’s an example:</p>
<div id="cell-42" class="cell" data-execution_count="44">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1">get_relevant_docs(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What are the daily transaction limits?"</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="44">
<pre><code>[{'page_content': "EDICIÓN AQUA PREP 01-01\nBANCO BILBAO VIZCAYA ARGENTARIA, S.A. - Plaza de San Nicolás, 4 - 48005 BILBAO\nReg. Mer. Vizcaya -T omo 3858, Folio 1, Hoja BI-17 BIS-A, Inscripción 1035ª C.I.F.: A48265169\n2 / 4 \n2.4 T ransaction limits. \nThe daily purchase limit will be determined by the Card's \nbalance and up to a maximum of 1,000 euros per day. The \nHolder and the Bank may modify the initially specified limits. \nThe monthly limit for collecting lottery and gambling prizes is \nten thousand euros.\n2.5 T o sign up for the card, you do not need to take out \nany other accessory service.\n3. ON COSTS AND INTEREST AND EXCHANGE RATES\nMonthly top-up limit: Minimum of 6, maximum of 1000\nThe applicable fees for using the card may be:\na) Pre-paid card issue and maintenance fee: 5 euros.\nb) Fee for issuance of duplicates: 4 euros.\nc) Fee for using the card outside the Eurozone: 3% \napplicable to the exchange value in euros.\nd) Fees to withdraw cash against the card balance at ATMs:",
  'type': 'Document',
  'metadata': {'producer': 'Adobe PDF Library 15.0',
   'creationdate': '2021-03-24T14:51:54+01:00',
   'creator': 'Adobe InDesign 16.1 (Windows)',
   'moddate': '2021-03-24T14:51:54+01:00',
   'page': 1,
   'trapped': '/False',
   'source': '../_extras/what-is-rag/bbva.pdf',
   'page_label': '2',
   'total_pages': 4}}]</code></pre>
</div>
</div>
<p>After you’ve retrieved the relevant chunks, you’d want to combine them into a single string that you can pass to the model. You can use <code>get_context</code> to do that.</p>
<div id="cell-44" class="cell" data-execution_count="45">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb21-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_context(relevant_docs: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>]):</span>
<span id="cb21-2">    context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span></span>
<span id="cb21-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> doc <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> relevant_docs:</span>
<span id="cb21-4">        context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"--- PAGE </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>doc[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'metadata'</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'page'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> ---</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>doc[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'page_content'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb21-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> context</span></code></pre></div></div>
</div>
<div id="cell-45" class="cell" data-execution_count="47">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb22-1">docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_relevant_docs(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What are the daily transaction limits?"</span>, top_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb22-2">get_context(docs)</span></code></pre></div></div>
<div class="cell-output cell-output-display" data-execution_count="47">
<pre><code>"--- PAGE 1 ---\nEDICIÓN AQUA PREP 01-01\nBANCO BILBAO VIZCAYA ARGENTARIA, S.A. - Plaza de San Nicolás, 4 - 48005 BILBAO\nReg. Mer. Vizcaya -T omo 3858, Folio 1, Hoja BI-17 BIS-A, Inscripción 1035ª C.I.F.: A48265169\n2 / 4 \n2.4 T ransaction limits. \nThe daily purchase limit will be determined by the Card's \nbalance and up to a maximum of 1,000 euros per day. The \nHolder and the Bank may modify the initially specified limits. \nThe monthly limit for collecting lottery and gambling prizes is \nten thousand euros.\n2.5 T o sign up for the card, you do not need to take out \nany other accessory service.\n3. ON COSTS AND INTEREST AND EXCHANGE RATES\nMonthly top-up limit: Minimum of 6, maximum of 1000\nThe applicable fees for using the card may be:\na) Pre-paid card issue and maintenance fee: 5 euros.\nb) Fee for issuance of duplicates: 4 euros.\nc) Fee for using the card outside the Eurozone: 3% \napplicable to the exchange value in euros.\nd) Fees to withdraw cash against the card balance at ATMs:\n\n--- PAGE 2 ---\nBBVA app or website, or via the phone numbers shown on the \ncards, and in any case within a maximum period of thirteen \nmonths after the date of the debit entry.\n5.3 Liability of the Bank in the event of unauthorized \npayment transactions.\nIf an unauthorized payment transaction is carried out, the \nBank will refund the amount of the unauthorized transaction.\n5.4 Liability of the Holder in the event of unauthorized \ntransactions.\nThe Account Holder will be liable for losses arising from \nunauthorized payment transactions made with the Card up \nto a maximum of 50 euros.\nThe Holder will be liable without any limitations in the \nevent of fraud or gross negligence on their part in meeting \ntheir obligations as respects the security credentials and \nsafekeeping if this situation is not reported to the Bank \nwithout delay.\n5.5 Blocking the Card.\nThe Bank reserves the right to block the Card on objectively \njustified grounds related to the security measures taken\n\n--- PAGE 2 ---\nEDICIÓN AQUA PREP 01-01\nBANCO BILBAO VIZCAYA ARGENTARIA, S.A. - Plaza de San Nicolás, 4 - 48005 BILBAO\nReg. Mer. Vizcaya -T omo 3858, Folio 1, Hoja BI-17 BIS-A, Inscripción 1035ª C.I.F.: A48265169\n3 / 4 \nd) Notify the Bank of any loss, theft or copying of the \nCard or misappropriation of the PIN and/or passwords \nwithout undue delay as soon as they become aware \nof it, at any of the Bank's branches during customer \nservice hours or via the phone numbers shown on the \nCard.\n5.2 Notify the Bank of any unauthorized transactions \nor incorrectly executed payment transactions.\nThe Holder must notify the Bank as soon as they become \naware of the posting of any unauthorized transaction to the \nDirect Debit Account of the Card without undue delay at any \nbranch of the Bank during customer service hours, on the \nBBVA app or website, or via the phone numbers shown on the \ncards, and in any case within a maximum period of thirteen \nmonths after the date of the debit entry.\n\n"</code></pre>
</div>
</div>
<p>This will generate a string similar to the one we used in the previous example.</p>
<p>Finally, you can adapt <code>get_response</code> to use these new steps in the RAG pipeline.</p>
<div id="cell-47" class="cell" data-execution_count="48">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb24-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_messages(question: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, relevant_docs: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>):</span>
<span id="cb24-2">    context_vars <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>: question, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"documents"</span>: get_context(relevant_docs)}</span>
<span id="cb24-3">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb24-4">        SystemMessage(content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>system_prompt),</span>
<span id="cb24-5">        HumanMessage(content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>user_prompt.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>context_vars)),</span>
<span id="cb24-6">    ]</span>
<span id="cb24-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> messages</span>
<span id="cb24-8"></span>
<span id="cb24-9"></span>
<span id="cb24-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_response(question: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>):</span>
<span id="cb24-11">    relevant_docs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_relevant_docs(question)</span>
<span id="cb24-12">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_messages(question, relevant_docs)</span>
<span id="cb24-13">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.invoke(messages)</span>
<span id="cb24-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response.content</span>
<span id="cb24-15"></span>
<span id="cb24-16"></span>
<span id="cb24-17">question <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What are the daily transaction limits?"</span></span>
<span id="cb24-18">response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_response(question)</span>
<span id="cb24-19"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(response)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>The daily purchase limit for transactions is determined by the Card's balance and can be up to a maximum of 1,000 euros per day. Additionally, the monthly limit for collecting lottery and gambling prizes is ten thousand euros. The Holder and the Bank may modify the initially specified limits. 

(Page 1)</code></pre>
</div>
</div>
<p>And, you’re done! You’ve built a RAG pipeline that can answer questions about a document.</p>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>In this post, you’ve learned about what RAG is, how it works, and how to implement it in Python. You’ve learned why you’d want to use it, and how to do it.</p>
<p>You’ve walked through the process of: - Extracting text from a PDF file - Creating embeddings for the chunks - Storing the embeddings in a VectorDB - Querying the VectorDB to find the most relevant chunks - Using the model to generate a response</p>
<p>Hope you find this article useful. If you have any questions or comments, put them in the comments section below.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2025,
  author = {Castillo, Dylan},
  title = {What Is {Retrieval} {Augmented} {Generation} {(RAG)?}},
  date = {2025-06-29},
  url = {https://dylancastillo.co/posts/what-is-rag.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2025" class="csl-entry quarto-appendix-citeas">
Castillo, Dylan. 2025. <span>“What Is Retrieval Augmented Generation
(RAG)?”</span> June 29, 2025. <a href="https://dylancastillo.co/posts/what-is-rag.html">https://dylancastillo.co/posts/what-is-rag.html</a>.
</div></div></section></div> ]]></description>
  <category>llm</category>
  <category>rag</category>
  <category>python</category>
  <guid>https://dylancastillo.co/posts/what-is-rag.html</guid>
  <pubDate>Sun, 29 Jun 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Key parameters of LLMs</title>
  <dc:creator>Dylan Castillo</dc:creator>
  <link>https://dylancastillo.co/posts/key-parameters-llms.html</link>
  <description><![CDATA[ 




<p>I recently did a workshop about building agents. During the workshop I discussed the key parameters for LLMs, so I thought it’d be useful to write a short post about it.</p>
<p>These are the parameters that you will usually use when building LLM-based products:</p>
<ul>
<li>Model</li>
<li>Messages/prompts</li>
<li>Temperature</li>
<li>Seed</li>
<li>Top-P Sampling</li>
<li>Logprobs</li>
<li>Logit biases</li>
<li>Max completion tokens</li>
<li>Response format</li>
<li>Streaming</li>
<li>Tools</li>
</ul>
<p>In the next sections, I’ll go over each of these parameters in more detail and provide some suggestions about how to use them.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Each provider has a slightly different name for the same parameter, but the concept is the same. You’ll have to check the documentation of the provider you’re using to see the exact name of the parameter.</p>
</div>
</div>
<section id="model" class="level2">
<h2 class="anchored" data-anchor-id="model">Model</h2>
<p>When choosing a model, consider the following factors:</p>
<ul>
<li>Complexity of task: Am I solving a problem that requires reasoning capabilities? Or is it a simple task?</li>
<li>Speed: How important is it that the model replies quickly? Is this something that I can run on the background?</li>
<li>Cost: How much do I want to spend on this task?</li>
<li>Provider: Which providers do I have access to? Do I need to self-host?</li>
</ul>
<p>Right now, my go-to models are Gemini 2.5 Pro or Claude 4 for complex tasks. For simpler tasks, I use Gemini 2.5 Flash or OpenAI’s gpt-4.1 family.</p>
<p>The best way to pick a model is to start with the most capable models and then scale down to the simplest models that still capable of solving the task. Otherwise, you could end up spending a lot of time trying to solve an issue that you simply cannot solve reliably with smaller models.</p>
</section>
<section id="messagesprompts" class="level2">
<h2 class="anchored" data-anchor-id="messagesprompts">Messages/prompts</h2>
<p>The messages/prompts you send to the LLM will determine the context and instructions for the LLM to follow. I wrote a guide on <a href="https://dylancastillo.co/posts/prompt-engineering-101.html">prompt engineering</a> that covers the basics of how to write good prompts.</p>
</section>
<section id="temperature" class="level2">
<h2 class="anchored" data-anchor-id="temperature">Temperature</h2>
<p>The temperature parameter controls the randomness of the model’s output. A temperature of 0 will make the model more deterministic, while a temperature of 1 will make the model more random.</p>
<p>I wrote a <a href="https://dylancastillo.co/posts/seed-temperature-llms.html">post</a> about how temperature affects the output of LLMs. For tasks where consistency is important, use a temperature of 0. For tasks where creativity is important, use a temperature above 0. I’ve found that anything above 1.3-4 is too random.</p>
</section>
<section id="seed" class="level2">
<h2 class="anchored" data-anchor-id="seed">Seed</h2>
<p>The seed parameter is used to initialize the random number generator that is then used to sample the next token. If you want to maximize reproducibility, set a seed value.</p>
<p>This is only available in OpenAI, Gemini, and open-weight models. Check my <a href="https://dylancastillo.co/posts/seed-temperature-llms.html">post</a> for more details.</p>
</section>
<section id="top-p-sampling" class="level2">
<h2 class="anchored" data-anchor-id="top-p-sampling">Top-P Sampling</h2>
<p>Top-p sampling is a technique that limits the number of tokens that can be selected from the vocabulary by first selecting the smallest group of tokens whose combined probability ≥ P. For example, top P = 0.9 picks the next token from the smallest group of tokens that together cover at least 90% probability.</p>
<p>I rarely use this parameter.</p>
</section>
<section id="logit-biases" class="level2">
<h2 class="anchored" data-anchor-id="logit-biases">Logit biases</h2>
<p>Logits are the raw scores that the model assigns to each token. You can use biases to change the odds of a token being selected. Positive biases increase the odds of the token being selected, while negative biases do the opposite.</p>
<p>This is often used for document classification tasks or <a href="https://cookbook.openai.com/examples/search_reranking_with_cross-encoders">LLM-based rerankers</a>.</p>
</section>
<section id="logprobs" class="level2">
<h2 class="anchored" data-anchor-id="logprobs">Logprobs</h2>
<p>Logprobs are the logarithmic probabilities of the tokens. They are defined as:</p>
<p><img src="https://latex.codecogs.com/png.latex?logprob(w_i)%20=%20ln(P(w_i))%20=%20ln(%5Cfrac%7Be%5E%7Bz_i%7D%7D%7B%5Csum_%7Bj=1%7D%5E%7Bn%7D%20e%5E%7Bz_j%7D%7D)%20"></p>
<p>Where:</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?w_i"> is the <img src="https://latex.codecogs.com/png.latex?i">-th token in the vocabulary.</li>
<li><img src="https://latex.codecogs.com/png.latex?P(w_i)"> is the probability of the <img src="https://latex.codecogs.com/png.latex?i">-th token.</li>
<li><img src="https://latex.codecogs.com/png.latex?z_i"> is the logit of the <img src="https://latex.codecogs.com/png.latex?i">-th token.</li>
<li><img src="https://latex.codecogs.com/png.latex?n"> is the number of tokens in the vocabulary.</li>
</ul>
<p>You can use this parameter in OpenAI models. Gemini provides a <a href="https://discuss.ai.google.dev/t/get-logprobs-at-output-token-level/54418/15">single request with logprobs per day</a> (yes, I’m not kidding 😅). Anthropic doesn’t provide them.</p>
<p>Open-weight models don’t provide logprobs. They provide logits instead, that you can use to calculate the probabilities of the tokens.</p>
</section>
<section id="max-completion-tokens" class="level2">
<h2 class="anchored" data-anchor-id="max-completion-tokens">Max completion tokens</h2>
<p>This parameter limits the number of tokens that the model can generate. This is useful to control costs and length of the output.</p>
</section>
<section id="response-format" class="level2">
<h2 class="anchored" data-anchor-id="response-format">Response format</h2>
<p>You can use this parameter to specify the format of the response. Anthropic, OpenAI, and Gemini support structured outputs in the form of JSON schemas. I’ve written multiple posts on this topic:</p>
<ul>
<li><a href="https://dylancastillo.co/posts/say-what-you-mean-sometimes.html">Structured outputs can hurt the performance of LLMs</a></li>
<li><a href="https://dylancastillo.co/posts/gemini-structured-outputs.html">The good, the bad, and the ugly of Gemini’s structured outputs</a></li>
<li><a href="https://dylancastillo.co/posts/llm-pydantic-order-matters.html">Structured outputs: don’t put the cart before the horse</a></li>
</ul>
<p>Open-weight models allow for more flexible structured output formats. For example, using <a href="https://dottxt-ai.github.io/outlines/latest/">outlines</a> lets you define custom regEx patterns to extract the data you need.</p>
</section>
<section id="streaming" class="level2">
<h2 class="anchored" data-anchor-id="streaming">Streaming</h2>
<p>This parameter is used to stream the response from the model. This improves the user experience as it allows you to see the output as it’s being generated.</p>
</section>
<section id="tools" class="level2">
<h2 class="anchored" data-anchor-id="tools">Tools</h2>
<p>Tools are a way to extend the capabilities of the model by providing it with external tools. This is critical for building agents.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>This was a very short post about the key parameters for LLMs. I hope you found it useful.</p>
<p>Let me know if you have any questions or feedback.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2025,
  author = {Castillo, Dylan},
  title = {Key Parameters of {LLMs}},
  date = {2025-06-29},
  url = {https://dylancastillo.co/posts/key-parameters-llms.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2025" class="csl-entry quarto-appendix-citeas">
Castillo, Dylan. 2025. <span>“Key Parameters of LLMs.”</span> June 29,
2025. <a href="https://dylancastillo.co/posts/key-parameters-llms.html">https://dylancastillo.co/posts/key-parameters-llms.html</a>.
</div></div></section></div> ]]></description>
  <category>llm</category>
  <category>openai</category>
  <category>anthropic</category>
  <category>gemini</category>
  <category>python</category>
  <guid>https://dylancastillo.co/posts/key-parameters-llms.html</guid>
  <pubDate>Sun, 29 Jun 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Japanese is the most expensive language in terms of input tokens</title>
  <dc:creator>Dylan Castillo</dc:creator>
  <link>https://dylancastillo.co/til/counting-tokens.html</link>
  <description><![CDATA[ 




<p>OpenAI mentions in their documentation that <a href="https://help.openai.com/en/articles/4936856-what-are-tokens-and-how-to-count-them">1 token corresponds to roughly 4 characters</a>.</p>
<p>I was curious how this would work for different languages, so:</p>
<ol type="1">
<li>I took a small section of Paul Graham’s <a href="https://www.paulgraham.com/greatwork.html">How to Do Great Work</a></li>
<li>Translated it into 7 different languages: English, Spanish, French, German, Japanese, Chinese, and Hindi</li>
<li>Counted the tokens</li>
<li>compared the results.</li>
</ol>
<section id="code" class="level2">
<h2 class="anchored" data-anchor-id="code">Code</h2>
<p>Here’s the code:</p>
<div id="cell-2" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tiktoken</span>
<span id="cb1-2"></span>
<span id="cb1-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> read_text(file_path):</span>
<span id="cb1-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(file_path, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r"</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">file</span>:</span>
<span id="cb1-5">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">file</span>.read()</span>
<span id="cb1-6"></span>
<span id="cb1-7">text_en <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> read_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../_extras/counting-tokens/en.md"</span>)</span>
<span id="cb1-8">text_es <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> read_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../_extras/counting-tokens/es.md"</span>)</span>
<span id="cb1-9">text_fr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> read_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../_extras/counting-tokens/fr.md"</span>)</span>
<span id="cb1-10">text_de <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> read_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../_extras/counting-tokens/de.md"</span>)</span>
<span id="cb1-11">text_jp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> read_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../_extras/counting-tokens/jp.md"</span>)</span>
<span id="cb1-12">text_zh <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> read_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../_extras/counting-tokens/zh.md"</span>)</span>
<span id="cb1-13">text_hi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> read_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../_extras/counting-tokens/hi.md"</span>)</span>
<span id="cb1-14">text_ru <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> read_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../_extras/counting-tokens/ru.md"</span>)</span>
<span id="cb1-15">text_pt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> read_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../_extras/counting-tokens/pt.md"</span>)</span>
<span id="cb1-16"></span>
<span id="cb1-17"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> count_tokens(text):</span>
<span id="cb1-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(tiktoken.encoding_for_model(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4o"</span>).encode(text))</span>
<span id="cb1-19"></span>
<span id="cb1-20">chars_count <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb1-21">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"en"</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(text_en),</span>
<span id="cb1-22">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"es"</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(text_es),</span>
<span id="cb1-23">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fr"</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(text_fr),</span>
<span id="cb1-24">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"de"</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(text_de),</span>
<span id="cb1-25">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jp"</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(text_jp),</span>
<span id="cb1-26">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"zh"</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(text_zh),</span>
<span id="cb1-27">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hi"</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(text_hi),</span>
<span id="cb1-28">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ru"</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(text_ru),</span>
<span id="cb1-29">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pt"</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(text_pt),</span>
<span id="cb1-30">}</span>
<span id="cb1-31"></span>
<span id="cb1-32">tokens_count <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb1-33">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"en"</span>: count_tokens(text_en),</span>
<span id="cb1-34">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"es"</span>: count_tokens(text_es),</span>
<span id="cb1-35">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fr"</span>: count_tokens(text_fr),</span>
<span id="cb1-36">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"de"</span>: count_tokens(text_de),</span>
<span id="cb1-37">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jp"</span>: count_tokens(text_jp),</span>
<span id="cb1-38">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"zh"</span>: count_tokens(text_zh),</span>
<span id="cb1-39">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hi"</span>: count_tokens(text_hi),</span>
<span id="cb1-40">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ru"</span>: count_tokens(text_ru),</span>
<span id="cb1-41">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pt"</span>: count_tokens(text_pt),</span>
<span id="cb1-42">}</span></code></pre></div></div>
</div>
<p>This reads the text from the file, and uses <code>tiktoken</code> to count the tokens. I also counted the number of characters in the text.</p>
<p>Then I calculated the ratio of tokens to characters for each language.</p>
<div id="cell-4" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> lang <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"en"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"es"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fr"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"de"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jp"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"zh"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hi"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ru"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pt"</span>]:</span>
<span id="cb2-2">    chars <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> chars_count[lang]</span>
<span id="cb2-3">    tokens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tokens_count[lang]</span>
<span id="cb2-4">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>lang<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>chars <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> tokens<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> chars per token, </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>chars<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> chars, </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>tokens<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> tokens"</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>en: 4.75 chars per token, 2053 chars, 432 tokens
es: 4.56 chars per token, 2271 chars, 498 tokens
fr: 4.69 chars per token, 2689 chars, 573 tokens
de: 4.46 chars per token, 2479 chars, 556 tokens
jp: 1.41 chars per token, 1081 chars, 767 tokens
zh: 1.33 chars per token, 707 chars, 531 tokens
hi: 3.51 chars per token, 2194 chars, 625 tokens
ru: 4.02 chars per token, 2275 chars, 566 tokens
pt: 4.63 chars per token, 2200 chars, 475 tokens</code></pre>
</div>
</div>
</section>
<section id="results" class="level2">
<h2 class="anchored" data-anchor-id="results">Results</h2>
<p>I found this interesting:</p>
<ul>
<li>English is the most efficient language in terms of characters per token, with 4.75 characters per token.</li>
<li>Mandarin Chinese (1.33 characters per token) is the least efficient language in terms of characters per token, followed by Japanese (1.41 characters per token).</li>
<li>The same text in Japanese uses 77% more tokens than in English, making it the most expensive language in terms of input tokens.</li>
<li>Even though Chinese is less efficient than Japanese in terms of characters per token, it’s more efficient in terms of information conveyed per character. The article took 2053 characters in English, 707 characters in Chinese, and 1081 characters in Japanese. This explains why Chinese isn’t also the most expensive language.</li>
<li>Languages that use a latin alphabet (English, Spanish, French, German, Portuguese) are more efficient than languages that use a non-latin alphabet (Japanese, Chinese, Hindi, Russian). Russian is the most efficient language of these, with 4.02 characters per token.</li>
</ul>
</section>
<section id="limitations" class="level2">
<h2 class="anchored" data-anchor-id="limitations">Limitations</h2>
<p>This analysis has some clear limitations:</p>
<ol type="1">
<li>The text might not be a good example of the types of texts you’re working with.</li>
<li>The translations might not be good enough to truly reflect the information conveyed per character.</li>
</ol>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2025,
  author = {Castillo, Dylan},
  title = {Japanese Is the Most Expensive Language in Terms of Input
    Tokens},
  date = {2025-06-27},
  url = {https://dylancastillo.co/til/counting-tokens.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2025" class="csl-entry quarto-appendix-citeas">
Castillo, Dylan. 2025. <span>“Japanese Is the Most Expensive Language in
Terms of Input Tokens.”</span> June 27, 2025. <a href="https://dylancastillo.co/til/counting-tokens.html">https://dylancastillo.co/til/counting-tokens.html</a>.
</div></div></section></div> ]]></description>
  <category>til</category>
  <category>llm</category>
  <category>openai</category>
  <category>tiktoken</category>
  <guid>https://dylancastillo.co/til/counting-tokens.html</guid>
  <pubDate>Fri, 27 Jun 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Prompt engineering 101</title>
  <dc:creator>Dylan Castillo</dc:creator>
  <link>https://dylancastillo.co/posts/prompt-engineering-101.html</link>
  <description><![CDATA[ 




<p>I’ve tried every trick in the book to get Large Language Models (LLMs) to do what I want them to do. I’ve resorted to threats of physical violence. I’ve offered bribes. I’ve even made coding agents call me <a href="https://www.reddit.com/r/cursor/comments/1joapwk/comment/mkqg8aw">big daddy</a> to ensure they follow my repo’s rules<sup>1</sup>.</p>
<p>All this trial and error has taught me a trick or two about writing prompts. This is a key part of using LLMs, but it’s also one of the most hyped and abused techniques. There are so many AI influencers selling and sharing their “ultimate prompt” that it often feels closer to astrology than to engineering.</p>
<p>This article is a no-BS guide to help you get the basics right. It won’t solve all the problems in your agentic workflow or LLM-based applications, but will avoid you making obvious mistakes.</p>
<p>Let’s get started!</p>
<section id="what-is-a-prompt" class="level2">
<h2 class="anchored" data-anchor-id="what-is-a-prompt">What is a prompt?</h2>
<p>Prompts are instructions sent as text to an LLM. Most models work with two types of instructions:</p>
<ol type="1">
<li><strong>System/developer prompt</strong>: Sets the “big picture” or high-level rules for the entire conversation. Examples: “You are a helpful assistant.”; “Always answer in haiku.”</li>
<li><strong>User prompt</strong>: The actual question end-user types and any additional context. Examples: “What’s today’s weather in Dublin?”; “Summarize the following documents”</li>
</ol>
<p>The system prompt gives the assistant a “role”, while the user prompt requests specific content within that framework.</p>
<p>Prompts are usually provided as messages, which are a list of objects with a role and a content:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1">messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb1-2">    {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"system"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You are a helpful assistant."</span>},</span>
<span id="cb1-3">    {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What's the weather in Tokyo?"</span>}</span>
<span id="cb1-4">]</span></code></pre></div></div>
<p>Then, these are passed through a <a href="https://huggingface.co/docs/transformers/en/chat_templating">chat template</a> and converted into a single string that is sent to the model. For example, this is the resulting message text used by <em>Qwen3</em>, after combining the system and user prompts:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource text number-lines code-with-copy"><code class="sourceCode"><span id="cb2-1">&lt;|im_start|&gt;system</span>
<span id="cb2-2">You are a helpful assistant.</span>
<span id="cb2-3">&lt;|im_end|&gt;</span>
<span id="cb2-4"></span>
<span id="cb2-5">&lt;|im_start|&gt;user</span>
<span id="cb2-6">What's the weather in Tokyo?</span>
<span id="cb2-7">&lt;|im_end|&gt;</span></code></pre></div></div>
<p>After you make the request, the model will respond with an <em>assistant</em> message that contains the model’s response<sup>2</sup>. It looks like this:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource text number-lines code-with-copy"><code class="sourceCode"><span id="cb3-1">&lt;|im_start|&gt;assistant</span>
<span id="cb3-2">The weather in Tokyo is sunny.</span>
<span id="cb3-3">&lt;|im_end|&gt;</span></code></pre></div></div>
<p>You’ll generally use the system and user prompts to instruct the model. But for some prompting techniques, such as few-shot prompting, people often use assistant messages to simulate model responses.</p>
</section>
<section id="components-of-a-good-prompt" class="level2">
<h2 class="anchored" data-anchor-id="components-of-a-good-prompt">Components of a good prompt</h2>
<p>There are many useful free resources online you can use to learn more about prompt engineering. I recommend <a href="https://docs.anthropic.com/en/docs/build-with-claude/prompt-engineering/overview#prompt-engineering-tutorial">this article</a> by Anthropic or <a href="https://platform.openai.com/docs/guides/text?api-mode=responses">this one</a> by OpenAI.</p>
<p>Most of the advice boils down to these 6 principles:</p>
<ol type="1">
<li>Be clear and specific</li>
<li>Provide examples</li>
<li>Let models think</li>
<li>Structure prompts into sections and use clear delimiters</li>
<li>Split complex tasks into smaller steps</li>
<li>Repeat instructions when the context is long</li>
</ol>
<p>Let’s go through each of these principles in more detail.</p>
<section id="principle-1-be-clear-and-specific" class="level3">
<h3 class="anchored" data-anchor-id="principle-1-be-clear-and-specific">Principle 1: Be clear and specific</h3>
<p>This is the most important principle. If you cannot describe in detail the task you want to perform, the model will not be able to perform it. Whenever you write a prompt, ask yourself: “If I didn’t have any background knowledge in this domain, could I complete this task based on the text that I just wrote in this prompt?”</p>
<p>In addition to describing the task, you should also provide a role for the model. For example, if you’re classifying documents you can use a role like “You’re an expert in document classification” or if you’re dealing with financial data you can use a role like “You’re an expert in financial analysis”.</p>
<p>Here’s an example of a clear and specific prompt:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource text number-lines code-with-copy"><code class="sourceCode"><span id="cb4-1">You're an expert in business writing. Please review and improve this email by addressing the following issues:</span>
<span id="cb4-2"></span>
<span id="cb4-3">- Fix any grammatical errors and typos</span>
<span id="cb4-4">- Improve clarity and conciseness</span>
<span id="cb4-5">- Ensure professional tone throughout</span>
<span id="cb4-6">- Strengthen the subject line to be more specific</span>
<span id="cb4-7">- Add a clear call-to-action if missing</span>
<span id="cb4-8">- Format for better readability (bullets, paragraphs, etc.)</span>
<span id="cb4-9"></span>
<span id="cb4-10">&lt;EMAIL CONTENT&gt;</span></code></pre></div></div>
<p>This information will let the LLM know which specific task you want it to perform. This should go in the system prompt.</p>
</section>
<section id="principle-2-provide-examples" class="level3">
<h3 class="anchored" data-anchor-id="principle-2-provide-examples">Principle 2: Provide examples</h3>
<p>One of the lowest hanging fruit in prompt engineering is to provide examples. It’s as simple as showing the model a few input and output pairs.</p>
<p>This technique is formally known as “few shot prompt”. It’s a simple but effective way to improve the <a href="https://arxiv.org/abs/2009.03300">quality of the output</a> in many tasks.</p>
<p>Here’s an example of a few-shot prompt:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource text number-lines code-with-copy"><code class="sourceCode"><span id="cb5-1">You are an expert in solving simple word puzzles using reasoning steps. Provided with a list of 4 names, you will concatenate the last letters into a word.</span>
<span id="cb5-2">Examples:</span>
<span id="cb5-3"></span>
<span id="cb5-4">**Example 1**:</span>
<span id="cb5-5"></span>
<span id="cb5-6">Input: 'Ian Peter Bernard Stephen'</span>
<span id="cb5-7"></span>
<span id="cb5-8">Output: 'NRDN'</span>
<span id="cb5-9"></span>
<span id="cb5-10">**Example 2**:</span>
<span id="cb5-11"></span>
<span id="cb5-12">Input: 'Javier Dylan Christopher Joseph'</span>
<span id="cb5-13"></span>
<span id="cb5-14">Output: 'RNRH'</span></code></pre></div></div>
<p>In my experience, it’s better to provide these examples directly in the system prompt because it’s easier to read and keep everything close together. However, as mentioned above, some people prefer to use assistant messages to provide examples.</p>
</section>
<section id="principle-3-let-models-think" class="level3">
<h3 class="anchored" data-anchor-id="principle-3-let-models-think">Principle 3: Let models think</h3>
<p>LLMs think in tokens. If you want them to achieve better results, you should let them use tokens to reason about the problem before generating the final answer.</p>
<p>This process is formally known as “Chain of Thought” (CoT) prompting. Similar to few shot prompts, it’s a powerful way to improve the <a href="https://arxiv.org/abs/2201.11903">quality of results</a> in many tasks.</p>
<p>A 0-shot CoT prompt means that you explicitly ask the model to think step by step to solve the problem but don’t provide any examples of how it should reason about it. A few-shot CoT prompt means that you provide examples of how the model should reason about the problem (e.g., 1-shot means you provide one example, 2-shot means you provide two examples, etc.).</p>
<p>Here are two examples of CoT prompts:</p>
<section id="shot-cot-prompt" class="level4">
<h4 class="anchored" data-anchor-id="shot-cot-prompt">0-Shot CoT Prompt</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource text number-lines code-with-copy"><code class="sourceCode"><span id="cb6-1">**Question:** A cinema sold 120 tickets at $8 each. What was the total revenue?</span>
<span id="cb6-2"></span>
<span id="cb6-3">**Note:** think about your answer step by step</span></code></pre></div></div>
</section>
<section id="shot-cot-prompt-1" class="level4">
<h4 class="anchored" data-anchor-id="shot-cot-prompt-1">1-Shot CoT Prompt</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource text number-lines code-with-copy"><code class="sourceCode"><span id="cb7-1">&lt;example&gt;</span>
<span id="cb7-2">**Question:** Emily buys 3 notebooks at $4 each and 2 pens at $1.50 each. What's her total cost?</span>
<span id="cb7-3">**Reasoning:**</span>
<span id="cb7-4"></span>
<span id="cb7-5">1. Cost of notebooks = 3 × $4 = $12</span>
<span id="cb7-6">2. Cost of pens = 2 × $1.50 = $3</span>
<span id="cb7-7">3. Total cost = $12 + $3 = $15</span>
<span id="cb7-8"></span>
<span id="cb7-9">**Answer:** $15</span>
<span id="cb7-10">&lt;/example&gt;</span>
<span id="cb7-11"></span>
<span id="cb7-12">**Question:** A cinema sold 120 tickets at $8 each. What was the total revenue?</span></code></pre></div></div>
<p>These days, most providers have options to let models think without explicitly asking them to do so in the prompt. With OpenAI models you can use models from the o-family (e.g., o3, o3-mini, o4-mini). For Anthropic and Gemini, you can configure Claude 3.7/4 or Gemini 2.5 models to use thinking tokens by setting a specific parameter. However, as I’m writing this, only Gemini gives you access to the full thinking tokens in the response. OpenAI will give you a summarized version of the thinking process and Anthropic will only give you the final answer.</p>
</section>
</section>
<section id="principle-4-structure-prompts-into-sections" class="level3">
<h3 class="anchored" data-anchor-id="principle-4-structure-prompts-into-sections">Principle 4: Structure prompts into sections</h3>
<p>It’s a common practice to structure system and user prompts into sections. Some people like to use markdown formatting to make the prompt more readable, others use xml tags. You can also use reverse backticks (```) to delimit code blocks or JSON objects. Regardless of the method you use, make sure to do it consistently.</p>
<p>I really haven’t checked if there is any hard evidence that proves this really improves performance because it just <em>feels right</em>. It also helps with readability. You will spend a lot of time iterating on prompts, so making them easy to read is already a good investment on its own.</p>
<section id="system-prompt" class="level4">
<h4 class="anchored" data-anchor-id="system-prompt">System prompt</h4>
<p>For system prompts, you can use the following structure:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource text number-lines code-with-copy"><code class="sourceCode"><span id="cb8-1">**Role and objective**</span>
<span id="cb8-2"></span>
<span id="cb8-3">You’re an expert document classifier. Your goal is to classify this document…</span>
<span id="cb8-4"></span>
<span id="cb8-5">**Rules**</span>
<span id="cb8-6"></span>
<span id="cb8-7">1. Documents that contain information about medical treatments should be classified as …</span>
<span id="cb8-8">2. Do not classify documents into multiple categories</span>
<span id="cb8-9">3. …</span>
<span id="cb8-10"></span>
<span id="cb8-11">**Examples**</span>
<span id="cb8-12"></span>
<span id="cb8-13">Input: [document text]</span>
<span id="cb8-14">Classification: [document category]</span>
<span id="cb8-15">…</span>
<span id="cb8-16"></span>
<span id="cb8-17">**Output**</span>
<span id="cb8-18"></span>
<span id="cb8-19">You should generate a JSON object with this structure: [JSON schema]</span>
<span id="cb8-20"></span>
<span id="cb8-21">**(Optional) Reiterate objective and elicit thinking**</span>
<span id="cb8-22"></span>
<span id="cb8-23">Your goal is to XYZ… Before writing your answers, write your reasoning step by step.</span></code></pre></div></div>
<p>The headers are for reference only, you can skip them if you want. You also don’t need to include all of these sections in your prompt.</p>
</section>
<section id="user-prompt" class="level4">
<h4 class="anchored" data-anchor-id="user-prompt">User prompt</h4>
<p>I’d recommend to keep user prompts short:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource text number-lines code-with-copy"><code class="sourceCode"><span id="cb9-1">**Context**</span>
<span id="cb9-2"></span>
<span id="cb9-3">Input: [document text]</span>
<span id="cb9-4"></span>
<span id="cb9-5">**Briefly reiterate objective**</span>
<span id="cb9-6"></span>
<span id="cb9-7">Please classify this document into a category.</span></code></pre></div></div>
<p>In it’s simplest form, you just provide the context the LLM needs to work with and reiterate the objective.</p>
</section>
</section>
<section id="principle-5-split-complex-tasks-into-smaller-steps" class="level3">
<h3 class="anchored" data-anchor-id="principle-5-split-complex-tasks-into-smaller-steps">Principle 5: Split complex tasks into smaller steps</h3>
<p>LLMs often get confused when the <a href="https://arxiv.org/abs/2307.03172">context is too long</a> and/or the instructions are complex.</p>
<p>For example, you might have a document classifier that precedes a conditional entity extraction. Instead of doing a single LLM call with a prompt that does the document classification and the entity extraction, you can split the task into two steps:</p>
<ol type="1">
<li>First, you classify the document into a category.</li>
<li>Then, you extract the entities from the document, based on the category.</li>
</ol>
<p>Here’s an example of the same task split into two steps.</p>
<section id="big-complex-prompt" class="level4">
<h4 class="anchored" data-anchor-id="big-complex-prompt">Big complex prompt</h4>
<p>This prompt tries (and likely fails) to do two complex tasks at once.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource text number-lines code-with-copy"><code class="sourceCode"><span id="cb10-1">You're an expert document classifier. First, classify the document into the following categories:</span>
<span id="cb10-2"></span>
<span id="cb10-3">- Medical</span>
<span id="cb10-4">- Financial</span>
<span id="cb10-5">- Legal</span>
<span id="cb10-6"></span>
<span id="cb10-7">Then, if the document is classified as "Medical", extract the following entities:</span>
<span id="cb10-8">...</span>
<span id="cb10-9"></span>
<span id="cb10-10">If the document is classified as "Financial", extract the following entities:</span>
<span id="cb10-11">...</span>
<span id="cb10-12"></span>
<span id="cb10-13">If the document is classified as "Legal", extract the following entities:</span>
<span id="cb10-14">...</span></code></pre></div></div>
</section>
<section id="smaller-simpler-prompts" class="level4">
<h4 class="anchored" data-anchor-id="smaller-simpler-prompts">Smaller, simpler prompts</h4>
<p>This second approach splits the task into two smaller prompts that do each task separately.</p>
<p><strong>Prompt 1: Document classification</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource text number-lines code-with-copy"><code class="sourceCode"><span id="cb11-1">You're an expert document classifier. First, classify the document into the following categories:</span>
<span id="cb11-2"></span>
<span id="cb11-3">- Medical</span>
<span id="cb11-4">- Financial</span>
<span id="cb11-5">- Legal</span></code></pre></div></div>
<p><strong>Prompt N: Entity extraction (one for each category)</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource text number-lines code-with-copy"><code class="sourceCode"><span id="cb12-1">You're an expert in entity extraction in the &lt;CATEGORY&gt; domain. Your goal is to extract the entities from the document.</span>
<span id="cb12-2">...</span></code></pre></div></div>
</section>
</section>
<section id="principle-6-with-long-contexts-repeat-instructions" class="level3">
<h3 class="anchored" data-anchor-id="principle-6-with-long-contexts-repeat-instructions">Principle 6: With long contexts, repeat instructions</h3>
<p>LLMs often get confused when the context is too long and the instructions are complex. When context gets above a certain length, it’s better to repeat the instructions at the bottom of the prompt. Anthropic has reported up to <a href="https://docs.anthropic.com/en/docs/build-with-claude/prompt-engineering/overview#essential-tips-for-long-context-prompts">30% performance improvement</a> when using this technique.</p>
<p>You can use the following structure:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource text number-lines code-with-copy"><code class="sourceCode"><span id="cb13-1">You're an expert in entity extraction in the &lt;CATEGORY&gt; domain. Your goal is to classify the document into the following categories: "Medical", "Financial", "Legal".</span>
<span id="cb13-2"></span>
<span id="cb13-3">&lt;VERY LONG CONTEXT&gt;</span>
<span id="cb13-4"></span>
<span id="cb13-5">Remember, your goal is to classify the document into the following categories: "Medical", "Financial", "Legal".</span></code></pre></div></div>
<p>When dealing with long contexts, I generally reiterate the objective at the bottom of the system and user prompts.</p>
</section>
</section>
<section id="other-advanced-prompting-techniques" class="level2">
<h2 class="anchored" data-anchor-id="other-advanced-prompting-techniques">Other advanced prompting techniques</h2>
<p>After you’ve mastered the basics, you’re 90% of the way there. There are other more advanced techniques that might also be worth trying out:</p>
<ol type="1">
<li><strong>Exemplar Selection KNN (ES-KNN):</strong> Instead of having a fixed selection of examples, you can embed the user query and the examples, and then use a KNN algorithm to select the most relevant examples. This has shown to <a href="https://arxiv.org/abs/2506.05614">improve the quality of the results</a> in many tasks.</li>
<li><strong>Self-consistency (SC):</strong> You use the model to generate multiple responses and then select the most consistent one by marginalizing over the noise. This has shown to <a href="https://arxiv.org/abs/2203.11171">boost the performance</a> of CoT prompting.</li>
<li><strong>Thread of Thought (ThoT):</strong> It’s a <a href="https://arxiv.org/abs/2311.08734">two-tiered prompting system</a> that first asks the LLM to do an analytical dissection of the context, step by step, and summarizing intermediate results. Then, it uses another prompt to distill the analysis into a final answer.</li>
</ol>
<p>There are more advanced techniques that I’m not going to cover here. This <a href="https://arxiv.org/abs/2506.05614">paper</a> by E.G. Santana et al is a good starting point.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>This article is a short guide to help you write better prompts. Good prompt engineering can be summarized in 6 key principles:</p>
<ol type="1">
<li>Be clear and specific</li>
<li>Provide examples</li>
<li>Let models think</li>
<li>Structure prompts into sections and use clear delimiters</li>
<li>Split complex tasks into smaller steps</li>
<li>Repeat instructions when the context is long</li>
</ol>
<p>These principles will not solve all the problems in your agentic workflow or LLM-based applications. But they will help you get started.</p>
<p>I hope you found this article useful. If you have any questions or feedback, leave a comment below.</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>It didn’t work, but I felt much better about myself.↩︎</p></li>
<li id="fn2"><p>I removed the thinking tokens for brevity.↩︎</p></li>
</ol>
</section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2025,
  author = {Castillo, Dylan},
  title = {Prompt Engineering 101},
  date = {2025-06-26},
  url = {https://dylancastillo.co/posts/prompt-engineering-101.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2025" class="csl-entry quarto-appendix-citeas">
Castillo, Dylan. 2025. <span>“Prompt Engineering 101.”</span> June 26,
2025. <a href="https://dylancastillo.co/posts/prompt-engineering-101.html">https://dylancastillo.co/posts/prompt-engineering-101.html</a>.
</div></div></section></div> ]]></description>
  <category>llm</category>
  <category>openai</category>
  <category>anthropic</category>
  <category>gemini</category>
  <category>python</category>
  <guid>https://dylancastillo.co/posts/prompt-engineering-101.html</guid>
  <pubDate>Thu, 26 Jun 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Controlling randomness in LLMs: Temperature and Seed</title>
  <dc:creator>Dylan Castillo</dc:creator>
  <link>https://dylancastillo.co/posts/seed-temperature-llms.html</link>
  <description><![CDATA[ 




<p>Temperature and seed are commonly used parameters when interacting with Large Language Models (LLMs). They’re also a source of confusion for many people. In this post, I’ll show you what they are and how they work.</p>
<p>Temperature is a parameter that controls the randomness of the output by scaling the logits of the tokens before applying the softmax function. Seed is also a parameter that controls the randomness of how the model selects tokens during text generation. It sets the initial state of the random number generator, which is then used for the sampling of the tokens during the generation process.</p>
<p>Temperature is available for most providers, while seed is only available for <a href="https://openai.com/api/">OpenAI</a>, Gemini on <a href="https://cloud.google.com/vertex-ai/generative-ai/docs/model-reference/inference">Vertex AI</a>, and open-weight models (that I know of).</p>
<p>Let’s get started.</p>
<section id="how-llms-generate-text" class="level2">
<h2 class="anchored" data-anchor-id="how-llms-generate-text">How LLMs generate text</h2>
<p>To understand how seed and temperature work, we first need to understand how LLMs generate text. Provided with a prompt, a model uses what’s called a <a href="https://huggingface.co/docs/transformers/en/generation_strategies">decoding strategy</a> to generate the next token.</p>
<p>There are many strategies, but for this post, we’ll focus on just two: <strong>greedy search</strong> and <strong>sampling</strong>.</p>
<p>In <strong>greedy search</strong>, the model picks the token with the highest probability at each step. In <strong>sampling</strong>, the model picks a token based on the probability distribution of the tokens in the vocabulary. In both cases, the model will calculate the probability of each token in the vocabulary<sup>1</sup>, and use that to pick the next token. Let’s see an example.</p>
<p>Take the following prompt:</p>
<blockquote class="blockquote">
<p>What’s the favorite dish of Chuck Norris?</p>
</blockquote>
<p>These might be the top 5 most likely next tokens:</p>
<table class="table">
<thead>
<tr class="header">
<th>Rank</th>
<th>Token</th>
<th>Probability</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>‘Dynamite’</td>
<td>0.5823</td>
</tr>
<tr class="even">
<td>2</td>
<td>‘Venom’</td>
<td>0.2891</td>
</tr>
<tr class="odd">
<td>3</td>
<td>‘Himself’</td>
<td>0.0788</td>
</tr>
<tr class="even">
<td>4</td>
<td>‘Radiation’</td>
<td>0.0354</td>
</tr>
<tr class="odd">
<td>5</td>
<td>‘You’</td>
<td>0.0144</td>
</tr>
</tbody>
</table>
<p>If the model uses <strong>greedy search</strong>, it will pick the token with the highest probability, which is ‘Dynamite’.</p>
<p>If it uses <strong>sampling</strong>, it will make a random selection based on those probabilities. So, the model has a 58% chance of picking ‘Dynamite’, a 29% chance of picking ‘Venom’, a 8% chance of picking ‘Himself’, a 4% chance of picking ‘Radiation’, and a 1% chance of picking ‘You’.</p>
</section>
<section id="temperature" class="level2">
<h2 class="anchored" data-anchor-id="temperature">Temperature</h2>
<p>Temperature is a parameter that usually goes from 0 to 1 or 0 to 2, and it’s used to influence the randomness of the output. It does so by scaling the logits of the tokens by the temperature value.</p>
<p>Logits are the raw scores that the model assigns to each token. To go from logits to probabilities, you must apply the softmax function:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Ctext%7BP%7D(w_i)%20=%20%5Ctext%7Bsoftmax%7D(z_i)%20=%20%5Cfrac%7Be%5E%7Bz_i%7D%7D%7B%5Csum_%7Bj=1%7D%5E%7Bn%7D%20e%5E%7Bz_j%7D%7D"></p>
<p>Where:</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?P(w_i)"> is the probability of token <img src="https://latex.codecogs.com/png.latex?w_i"></li>
<li><img src="https://latex.codecogs.com/png.latex?z_i"> is the logit for token <img src="https://latex.codecogs.com/png.latex?w_i"></li>
<li><img src="https://latex.codecogs.com/png.latex?n"> is the total number of possible tokens</li>
</ul>
<p>This is the non-scaled version of the probabilities. If you use Temperature (<img src="https://latex.codecogs.com/png.latex?T">) to scale the logits, you will change the probabilities of the tokens, as shown below:</p>
<p><img src="https://latex.codecogs.com/png.latex?P(w_i)%20=%20%5Cfrac%7Be%5E%7Bz_i%20/%20T%7D%7D%7B%5Csum_%7Bj=1%7D%5E%7Bn%7D%20e%5E%7Bz_j%20/%20T%7D%7D"></p>
<p>Even though you cannot know for sure how proprietary providers (OpenAI, Anthropic, etc.) implement temperature, you can get a good idea of how it works by looking at <a href="https://github.com/huggingface/transformers/blob/6bdd4ec95264e5d8f219cfe4ee29ea9b42474bb7/src/transformers/generation/logits_process.py#L231"><code>TemperatureLogitWrapper</code></a> in the <code>transformers</code> library.</p>
<p>Let’s see a practical example of how temperature affects the probabilities of the tokens:</p>
<div id="cell-4" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-2"></span>
<span id="cb1-3">tokens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Dynamite'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Venom'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Himself'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Radiation'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'You'</span>]</span>
<span id="cb1-4">logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.8</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>])</span>
<span id="cb1-5"></span>
<span id="cb1-6">temperatures <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.999999999</span>]</span>
<span id="cb1-7"></span>
<span id="cb1-8"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> temperature <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> temperatures:</span>
<span id="cb1-9">    probs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.exp(logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> temperature) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(np.exp(logits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> temperature))</span>
<span id="cb1-10">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Temperature: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>temperature<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb1-11">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What's the favorite dish of Chuck Norris?"</span>)</span>
<span id="cb1-12">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Rank | Token      | Probability"</span>)</span>
<span id="cb1-13">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-----|------------|------------"</span>)</span>
<span id="cb1-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, (token, prob) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(tokens, probs), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>):</span>
<span id="cb1-15">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:4d}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> | '</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>token<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:10s}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">' | </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>prob<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb1-16">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Sum of probabilities: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>np<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(probs)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
</div>
<p>This code simulates the impact of different temperature values on the next token probability. Given some initial logits and assuming this is the full vocabulary, we can calculate the probabilities of the tokens for a given temperature.</p>
<p>For a temperature of <strong>0.1</strong>, you get the following probabilities:</p>
<table class="table">
<thead>
<tr class="header">
<th>Rank</th>
<th>Token</th>
<th>Probability</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>‘Dynamite’</td>
<td>0.9991</td>
</tr>
<tr class="even">
<td>2</td>
<td>‘Venom’</td>
<td>0.0009</td>
</tr>
<tr class="odd">
<td>3</td>
<td>‘Himself’</td>
<td>0.0000</td>
</tr>
<tr class="even">
<td>4</td>
<td>‘Radiation’</td>
<td>0.0000</td>
</tr>
<tr class="odd">
<td>5</td>
<td>‘You’</td>
<td>0.0000</td>
</tr>
</tbody>
</table>
<p>For a temperature of <strong>2</strong>, you get the following probabilities:</p>
<table class="table">
<thead>
<tr class="header">
<th>Rank</th>
<th>Token</th>
<th>Probability</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>‘Dynamite’</td>
<td>0.4038</td>
</tr>
<tr class="even">
<td>2</td>
<td>‘Venom’</td>
<td>0.2846</td>
</tr>
<tr class="odd">
<td>3</td>
<td>‘Himself’</td>
<td>0.1486</td>
</tr>
<tr class="even">
<td>4</td>
<td>‘Radiation’</td>
<td>0.0996</td>
</tr>
<tr class="odd">
<td>5</td>
<td>‘You’</td>
<td>0.0635</td>
</tr>
</tbody>
</table>
<p>You can see that for lower temperature values, the model becomes more deterministic. For temperature 0.1, the probability of picking ‘Dynamite’ is &gt;99.9%, while for temperature 2, it’s only 40%.</p>
<p>In essence, temperature impacts the randomness of the output by changing the probabilities of selecting the next token. This should give you a good idea of how temperature works. But let’s try it with a real LLM instead of a simulation.</p>
<p>First, let’s import the required libraries and load the model.</p>
<div id="cell-6" class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb2-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch.nn.functional <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> F</span>
<span id="cb2-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> transformers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> AutoModelForCausalLM, AutoTokenizer</span>
<span id="cb2-5"></span>
<span id="cb2-6">model_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"unsloth/Qwen3-1.7B"</span></span>
<span id="cb2-7">tokenizer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> AutoTokenizer.from_pretrained(model_name)</span>
<span id="cb2-8">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> AutoModelForCausalLM.from_pretrained(</span>
<span id="cb2-9">    model_name,</span>
<span id="cb2-10">    torch_dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"auto"</span>,</span>
<span id="cb2-11">    device_map<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"auto"</span></span>
<span id="cb2-12">)</span></code></pre></div></div>
</div>
<p>For the sake of this example, we’ll use <code>unsloth/Qwen3-1.7B</code>. But what you see here is applicable to most LLMs. We’ll use <code>generate_text</code> as our text generation function.</p>
<div id="cell-8" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> generate_text(prompt, temperature, seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, print_top_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>):</span>
<span id="cb3-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> seed:</span>
<span id="cb3-3">        torch.manual_seed(seed)</span>
<span id="cb3-4">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> torch.cuda.is_available():</span>
<span id="cb3-5">            torch.cuda.manual_seed(seed)</span>
<span id="cb3-6"></span>
<span id="cb3-7">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb3-8">        {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: prompt}</span>
<span id="cb3-9">    ]</span>
<span id="cb3-10">    text <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tokenizer.apply_chat_template(</span>
<span id="cb3-11">        messages,</span>
<span id="cb3-12">        tokenize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,</span>
<span id="cb3-13">        add_generation_prompt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb3-14">        enable_thinking<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span></span>
<span id="cb3-15">    )</span>
<span id="cb3-16">    model_inputs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tokenizer([text], return_tensors<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pt"</span>).to(model.device)</span>
<span id="cb3-17"></span>
<span id="cb3-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> temperature <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb3-19">        model_params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb3-20">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"do_sample"</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb3-21">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"temperature"</span>: temperature <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> temperature <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.9999999</span>,</span>
<span id="cb3-22">        }</span>
<span id="cb3-23">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb3-24">        model_params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb3-25">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"do_sample"</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,</span>
<span id="cb3-26">        }</span>
<span id="cb3-27">    outputs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.generate(</span>
<span id="cb3-28">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>model_inputs,</span>
<span id="cb3-29">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>model_params,</span>
<span id="cb3-30">        max_new_tokens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb3-31">        output_scores<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb3-32">        return_dict_in_generate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb3-33">        pad_token_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tokenizer.eos_token_id</span>
<span id="cb3-34">    )</span>
<span id="cb3-35"></span>
<span id="cb3-36">    output_token_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> outputs.sequences[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].tolist()</span>
<span id="cb3-37">    selected_token <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tokenizer.decode([output_token_id])</span>
<span id="cb3-38"></span>
<span id="cb3-39">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> print_top_k:</span>
<span id="cb3-40">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> selected_token</span>
<span id="cb3-41">    </span>
<span id="cb3-42">    probs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.softmax(outputs.scores[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb3-43">    top_k_probs, top_k_indices <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.topk(probs, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb3-44"></span>
<span id="cb3-45">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Top-10 most likely tokens:"</span>)</span>
<span id="cb3-46">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, (prob, idx) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(top_k_probs, top_k_indices)):</span>
<span id="cb3-47">        token_text <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tokenizer.decode([idx.item()])</span>
<span id="cb3-48">        is_selected <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"← SELECTED"</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> idx.item() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> output_token_id <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span></span>
<span id="cb3-49">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"  </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">. '</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>token_text<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">' (prob: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>prob<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>item()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, logit: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>outputs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>scores[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][idx.item()]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>item()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">) </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>is_selected<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb3-50"></span>
<span id="cb3-51">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> selected_token</span></code></pre></div></div>
</div>
<p>On a high-level, this function takes a prompt, a temperature value, and a seed (which we’ll ignore for now), and returns the top 10 most likely tokens with their probabilities and logits. The implementation looks a bit complicated, so let’s break it down.</p>
<ol type="1">
<li><p><strong>Lines 2 to 16</strong>: It takes a prompt, a temperature value, and optionally a seed. If a seed is provided, it sets the random number generator to that value. Then, it processes the prompt to create the required input for the model.</p></li>
<li><p><strong>Lines 18 to 37</strong>: It chooses to sample from the model or not, based on the temperature value. If temperature is 0, the model will use to a greedy search strategy.</p></li>
<li><p><strong>Lines 39 to 50</strong>: It returns the completion token and optinally prints the top 10 most likely tokens with their probabilities and logits.</p></li>
</ol>
<p>Similar to what you saw in the previous example, you can try low and high temperature values.</p>
<p>This is what you get for a temperature of 0.1:</p>
<div id="cell-10" class="cell" data-execution_count="20">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1">token <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> generate_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tell me a joke about dogs"</span>, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, print_top_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>Top-10 most likely tokens:
  1. 'Why' (prob: 1.0000, logit: 330.0000) ← SELECTED
  2. '!' (prob: 0.0000, logit: -inf) 
  3. '"' (prob: 0.0000, logit: -inf) 
  4. '#' (prob: 0.0000, logit: -inf) 
  5. '$' (prob: 0.0000, logit: -inf) 
  6. '%' (prob: 0.0000, logit: -inf) 
  7. '&amp;' (prob: 0.0000, logit: -inf) 
  8. ''' (prob: 0.0000, logit: -inf) 
  9. '(' (prob: 0.0000, logit: -inf) 
  10. ')' (prob: 0.0000, logit: -inf) </code></pre>
</div>
</div>
<div id="cell-11" class="cell" data-execution_count="21">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1">token <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> generate_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tell me a joke about dogs"</span>, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.99</span>, print_top_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>Top-10 most likely tokens:
  1. 'Why' (prob: 0.5742, logit: 16.5829) ← SELECTED
  2. 'Sure' (prob: 0.3939, logit: 16.2060) 
  3. 'Here' (prob: 0.0319, logit: 13.6935) 
  4. '!' (prob: 0.0000, logit: -inf) 
  5. '"' (prob: 0.0000, logit: -inf) 
  6. '#' (prob: 0.0000, logit: -inf) 
  7. '$' (prob: 0.0000, logit: -inf) 
  8. '%' (prob: 0.0000, logit: -inf) 
  9. '&amp;' (prob: 0.0000, logit: -inf) 
  10. ''' (prob: 0.0000, logit: -inf) </code></pre>
</div>
</div>
<p>You should see similar results. For the “Tell me a joke about dogs” prompt, when using a temperature of 0.1, the model had ~100% probability of picking ‘Why’, while for temperature 2, it’s only 57%.</p>
<p>Note, that when temperature is 0, the model will use to a greedy search strategy, which is the same as picking the most likely token. So no sampling is done and results are deterministic.</p>
</section>
<section id="seed" class="level2">
<h2 class="anchored" data-anchor-id="seed">Seed</h2>
<p>The seed parameter controls the randomness of how a model selects tokens. It sets the initial state for the random number generator used in the token sampling process.</p>
<p>Let’s revisit the example from the previous section to see this in action. By setting the seed to a fixed value, you ensure the generation process is deterministic. This means you will get an identical result on every run, provided all other parameters (like temperature) remain the same in those runs.</p>
<p>We can start by setting our seed to 42 and temperature to 1 to verify which token is generated.</p>
<div id="cell-15" class="cell" data-execution_count="22">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1">generate_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tell me a joke about dogs"</span>, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>, print_top_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>Top-10 most likely tokens:
  1. 'Why' (prob: 0.6792, logit: 33.0000) 
  2. 'Sure' (prob: 0.3208, logit: 32.2500) ← SELECTED
  3. '!' (prob: 0.0000, logit: -inf) 
  4. '"' (prob: 0.0000, logit: -inf) 
  5. '#' (prob: 0.0000, logit: -inf) 
  6. '$' (prob: 0.0000, logit: -inf) 
  7. '%' (prob: 0.0000, logit: -inf) 
  8. '&amp;' (prob: 0.0000, logit: -inf) 
  9. ''' (prob: 0.0000, logit: -inf) 
  10. '(' (prob: 0.0000, logit: -inf) </code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>'Sure'</code></pre>
</div>
</div>
<p>In this case, the model selected “Sure” as the next token, even though its probability is lower than ‘Why’. Now, we can verify that this stays the same over multiple runs.</p>
<div id="cell-17" class="cell" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1">tokens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb11-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>):</span>
<span id="cb11-3">    token <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> generate_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tell me a joke about dogs"</span>, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb11-4">    tokens.append(token)</span>
<span id="cb11-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(tokens)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb11-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(tokens))</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'Sure'}</code></pre>
</div>
</div>
<p>This code runs the text generation process 100 times and verifies that “Sure” was picked in all runs. Next, we should verify that this consistency is lost when we omit the seed parameter.</p>
<div id="cell-19" class="cell" data-execution_count="25">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1">tokens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb13-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>):</span>
<span id="cb13-3">    token <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> generate_text(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tell me a joke about dogs"</span>, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb13-4">    tokens.append(token)</span>
<span id="cb13-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(tokens)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb13-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(tokens))</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'Sure', 'Why'}</code></pre>
</div>
</div>
<p>In this case, you see that after the 100 generations, the model picked two different tokens: ‘Sure’ and ‘Why’. This is expected due to not setting a seed.</p>
<p>You can also use test this with a propietary model. Let’s try it with <code>gpt-4.1-nano</code> from OpenAI.</p>
<div id="cell-21" class="cell" data-execution_count="30">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> openai</span>
<span id="cb15-2"></span>
<span id="cb15-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb15-4"></span>
<span id="cb15-5">load_dotenv()</span>
<span id="cb15-6"></span>
<span id="cb15-7">client <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> openai.OpenAI()</span>
<span id="cb15-8"></span>
<span id="cb15-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> generate_text_openai(prompt, temperature, seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, print_top_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>):</span>
<span id="cb15-10">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> client.chat.completions.create(</span>
<span id="cb15-11">        model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4.1-nano"</span>,</span>
<span id="cb15-12">        messages<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: prompt}],</span>
<span id="cb15-13">        temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>temperature,</span>
<span id="cb15-14">        seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>seed,</span>
<span id="cb15-15">        max_tokens<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb15-16">        logprobs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb15-17">        top_logprobs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,</span>
<span id="cb15-18">    )</span>
<span id="cb15-19">    selected_token <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> response.choices[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].message.content</span>
<span id="cb15-20">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> print_top_k:</span>
<span id="cb15-21">        logprobs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> response.choices[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].logprobs.content[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].top_logprobs</span>
<span id="cb15-22">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Top 10 most likely tokens:"</span>)</span>
<span id="cb15-23">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> idx, token_info <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(logprobs):</span>
<span id="cb15-24">            token <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> token_info.token</span>
<span id="cb15-25">            logprob <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> token_info.logprob</span>
<span id="cb15-26">            prob <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">round</span>(np.exp(logprob)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb15-27">            token_text <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">. '</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>token<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">': </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>prob<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> (</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>logprob<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">)"</span></span>
<span id="cb15-28">            is_selected <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"← SELECTED"</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> token_info.token <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> selected_token <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span></span>
<span id="cb15-29">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>token_text<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>is_selected<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb15-30">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> selected_token</span></code></pre></div></div>
</div>
<p>Similar to the previous function, you provide a prompt, a temperature value, and a seed, and the model will return a completion token and will print the top 10 most likely tokens.</p>
<p>In this case, instead of providing you with the logits, OpenAI will provide you with <code>logprobs</code> which are the logaritmic probabilities of the tokens:</p>
<p><img src="https://latex.codecogs.com/png.latex?logprob(w_i)%20=%20ln(P(w_i))%20=%20ln(%5Cfrac%7Be%5E%7Bz_i%7D%7D%7B%5Csum_%7Bj=1%7D%5E%7Bn%7D%20e%5E%7Bz_j%7D%7D)%20"></p>
<p>First, let’s check the completion token we get for a temperature of 1 and a seed of 42.</p>
<div id="cell-23" class="cell" data-execution_count="31">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1">token <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> generate_text_openai(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tell me a joke about dogs"</span>, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>, print_top_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>Top 10 most likely tokens:
1. 'Why': 59.2600 (-0.5232) ← SELECTED
2. 'Sure': 40.7300 (-0.8982) 
3. ' Why': 0.0000 (-10.6482) 
4. ' sure': 0.0000 (-11.0232) 
5. ' why': 0.0000 (-11.2732) 
6. '为什么': 0.0000 (-11.6482) 
7. ' Sure': 0.0000 (-11.8982) 
8. 'Pourquoi': 0.0000 (-12.2732) 
9. 'why': 0.0000 (-12.3982) 
10. 'sure': 0.0000 (-12.6482) </code></pre>
</div>
</div>
<p>In this case, we get ‘Why’ as the completion token. You can see that the top 10 most likely tokens are not the same as the ones we got with <code>Qwen3-1.7B</code>. This is expected, as the model is different.</p>
<p>Then, we can try to generate 100 tokens with a temperature of 1 and a seed of 42.</p>
<div id="cell-25" class="cell" data-execution_count="32">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1">tokens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb18-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>):</span>
<span id="cb18-3">    token <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> generate_text_openai(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tell me a joke about dogs"</span>, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb18-4">    tokens.append(token)</span>
<span id="cb18-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(tokens)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb18-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(tokens))</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'Why'}</code></pre>
</div>
</div>
<p>Similar to the previous example, we run 100 generations with the same seed and temperature and check if the completion token is the same.</p>
<p>This should <em>generally</em> work, but OpenAI doesn’t guarantee that the same seed will always produce the same output. It might occur that your request is handled by a model with a <a href="https://cookbook.openai.com/examples/reproducible_outputs_with_the_seed_parameter">different configuration</a>, and you’ll get different results.</p>
<p>You can also verify that not using a seed will result in different tokens.</p>
<div id="cell-27" class="cell" data-execution_count="33">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb20-1">tokens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb20-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>):</span>
<span id="cb20-3">    token <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> generate_text_openai(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tell me a joke about dogs"</span>, temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb20-4">    tokens.append(token)</span>
<span id="cb20-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(tokens)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb20-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(tokens))</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'Sure', 'Why'}</code></pre>
</div>
</div>
<p>Now, you can see that the output is not the same in all runs. Some runs picked “Why”, and others picked “Sure”.</p>
<p>In essence, seed influences the output by setting the initial state of the random number generator, which is then used for the sampling of the tokens during the generation process.</p>
</section>
<section id="top-k-and-top-p" class="level2">
<h2 class="anchored" data-anchor-id="top-k-and-top-p"><code>top-k</code> and <code>top-p</code></h2>
<p>In addition to temperature, there are two other parameters that are commonly used to control the randomness of the output of a language model: <code>top-k</code> and <code>top-p</code>.</p>
<section id="top-k" class="level3">
<h3 class="anchored" data-anchor-id="top-k">top-k</h3>
<p>Top-k sampling is a technique that limits the number of tokens that can be selected from the vocabulary. It does so by keeping only the top-k tokens with the highest probabilities. This reduces the <a href="https://huyenchip.com/2024/01/16/sampling.html#top_k">computational workload</a> by getting the top-k logits and then calculating the softmax over these instead of using the complete vocabulary.</p>
<p>This parameter isn’t available for OpenAI models. They provide a <code>top_logprobs</code> parameter, but it’s not the same as top-k sampling. It’s a parameter that returns the top N most likely tokens with their logprobs, but it doesn’t change the sampling process.</p>
</section>
<section id="top-p" class="level3">
<h3 class="anchored" data-anchor-id="top-p">top-p</h3>
<p>Top-p sampling is a technique that limits the number of tokens that can be selected from the vocabulary. It does so including the smallest set of tokens whose combined probability ≥ P. For example, top P = 0.9 picks from the smallest group of tokens that together cover at least 90% probability.</p>
<p>This parameter is available for most providers.</p>
<div id="cell-30" class="cell" data-execution_count="51">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb22-1">generate_text_openai(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tell me a joke about dogs"</span>, top_p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.50</span>, print_top_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>Top 10 most likely tokens:
1. 'Why': 59.2600 (-0.5232) ← SELECTED
2. 'Sure': 40.7300 (-0.8982) 
3. ' Why': 0.0000 (-10.6482) 
4. ' sure': 0.0000 (-11.0232) 
5. ' why': 0.0000 (-11.2732) 
6. '为什么': 0.0000 (-11.6482) 
7. ' Sure': 0.0000 (-11.8982) 
8. 'Pourquoi': 0.0000 (-12.2732) 
9. 'why': 0.0000 (-12.3982) 
10. 'sure': 0.0000 (-12.6482) </code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="51">
<pre><code>'Why'</code></pre>
</div>
</div>
</section>
</section>
<section id="seed-and-temperature-in-practice" class="level2">
<h2 class="anchored" data-anchor-id="seed-and-temperature-in-practice">Seed and temperature in practice</h2>
<p>Now that you understand how seed and temperature work, here are some things to keep in mind when using them:</p>
<ol type="1">
<li><code>seed</code> is only available for <code>OpenAI</code>, <code>Gemini</code> on <code>Vertex AI</code>, and open-weight models.</li>
<li>To get the most deterministic output for a given prompt, set temperature to 0. This minimizes randomness.</li>
<li>If you want creative results that are still reproducible, set temperature to a value greater than 0 and use a fixed seed. This allows for varied outputs that you can generate again.</li>
<li>If you don’t need reproducible results and want unique outputs on every run, you can omit the seed parameter entirely.</li>
<li>Be aware that even if you set a temperature of 0 and a seed, outputs are not guaranteed to be identical. Providers <a href="https://platform.openai.com/docs/advanced-usage#reproducible-outputs">might change model configurations</a> that might impact the output. For OpenAI models, you can monitor such changes by keeping track of the <a href="https://platform.openai.com/docs/api-reference/backward-compatibility">system_fingerprint</a> provided in the responses.</li>
</ol>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>In this post, we explored how the temperature and seed parameters control the output of Large Language Models.</p>
<p>You learned that temperature adjusts the level of randomness: low values (near 0) produce more predictable, deterministic outputs, while high values (near 1) encourage more creative and varied results. In contrast, the seed makes the generation process reproducible. While the specific seed value isn’t important, fixing it ensures you get the same output for a given prompt and set of parameters.</p>
<p>Finally, remember that while temperature is a near-universal setting, seed is only available (at the time of writing) for OpenAI, Gemini on Vertex AI, and open-weight models.</p>
<p>I hope you found this post useful. If you have any questions, let me know in the comments below.</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Modern LLMs often have a vocabulary of 100k+ tokens↩︎</p></li>
</ol>
</section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2025,
  author = {Castillo, Dylan},
  title = {Controlling Randomness in {LLMs:} {Temperature} and {Seed}},
  date = {2025-06-25},
  url = {https://dylancastillo.co/posts/seed-temperature-llms.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2025" class="csl-entry quarto-appendix-citeas">
Castillo, Dylan. 2025. <span>“Controlling Randomness in LLMs:
Temperature and Seed.”</span> June 25, 2025. <a href="https://dylancastillo.co/posts/seed-temperature-llms.html">https://dylancastillo.co/posts/seed-temperature-llms.html</a>.
</div></div></section></div> ]]></description>
  <category>llm</category>
  <category>openai</category>
  <category>python</category>
  <guid>https://dylancastillo.co/posts/seed-temperature-llms.html</guid>
  <pubDate>Wed, 25 Jun 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>2024: Personal Snapshot</title>
  <dc:creator>Dylan Castillo</dc:creator>
  <link>https://dylancastillo.co/posts/2024-personal-snapshot.html</link>
  <description><![CDATA[ 




<p>This is my annual review. I use it as a way to reflect on the past year and get a snapshot of “who I am” at the time of writing.</p>
<p>If it’s me rereading this, welcome back. This is Dylan from 2024.</p>
<p>In previous snapshots, I listed what went well and what didn’t. This year, I’m trying something new: a chronological approach. 2024 went through three distinct phases, and I found it easier to reflect on each one.</p>
<section id="early-2024" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="early-2024">Early 2024</h2>
<p>This was my “I’m lost, and I don’t know what to do” phase.</p>
<p>In my last snapshot, I said that I was going to focus on building a consulting practice in 2024. Then I came up with a new product idea 😅 and spent a big chunk of the first two months of the year building a prototype.</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><a href="images/2024-personal-snapshot/aitheneum.webp" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="At least I generated some cool AI book covers."><img src="https://dylancastillo.co/posts/images/2024-personal-snapshot/aitheneum.webp" class="img-fluid figure-img" alt="At least I generated some cool AI book covers."></a></p>
<figcaption class="margin-caption">At least I generated some cool AI book covers.</figcaption>
</figure>
</div>
<p><a href="https://aitheneum.iwanalabs.com/">AItheneum</a><sup>1</sup> is a tool that helps you read classic philosophy books by making them easier to understand using AI. I pitched it as a way to make classic books more accessible to modern readers.</p>
<p>I had fun working on it, but it wasn’t really solving anyone’s problem. It was a vitamin, not a painkiller. By the time I released it, it was clear nobody cared about it (not even me!).</p>
<p>During this time, I was also contributing to <a href="https://github.com/django-components/django-components">django-components</a> and half-assing talking to potential clients for freelance work and doing cold outreach to get clients. The former was fun, the latter wasn’t.</p>
<p>Later in the year, after reading Alex Hormozi’s <a href="https://www.amazon.com/100M-Leads-Strangers-Stuff-Acquisition-com-ebook/dp/B0CFDR3TYV">100M Leads</a>, I realized that cold outreach at this stage was mostly a waste of time. When you’re just starting out, you should rely on warm introductions or referrals. If you haven’t built credibility yet, you’ll waste a lot of time trying to convince strangers to work with you.</p>
<p>I essentially spent the first two months of the year focusing on the wrong things.</p>
<p>On a more positive note, I was also doing open mic sets almost every week. I’m not sure if this was “good”, but I had a lot of fun performing stand-up comedy.</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><a href="images/2024-personal-snapshot/jokes.webp" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="My last stand-up set"><img src="https://dylancastillo.co/posts/images/2024-personal-snapshot/jokes.webp" class="img-fluid figure-img" alt="My last stand-up set"></a></p>
<figcaption class="margin-caption">My last stand-up set</figcaption>
</figure>
</div>
<p>As you might expect, I bombed a few times. But I also had a few good sets. A professional (but not famous) comedian even invited me to open for him at a show in a nearby city. I didn’t go, but it was flattering.</p>
<p>One thing that surprised me about stand-up comedy is that it follows a somewhat scientific process. Your joke is a hypothesis about what your audience will find funny. You test it by performing it in front of people. If it doesn’t work, you adjust it and test it again. You do this over and over until you find something that works.</p>
<p>The other thing I liked about it is that it’s very meritocratic. If you’re funny, you’ll get laughs. There’s no way to fake it. It’s very easy to figure out who’s good and who’s not. You might not like someone’s style, but if they’re good you cannot deny it.</p>
<p>However, after a few months, I realized it wasn’t sustainable:</p>
<ol type="1">
<li>To get good at stand-up, you have to make time for it. That means writing everyday, and performing as often as possible.</li>
<li>Open mics take a lot of time. To practice an 8 minute set, I’d often have to commute for 1 hour and stay for 1-2 hours of show (during which I did my 8 minutes).</li>
<li>As a beginner, you’ll only get spots during weekday evenings. Which isn’t great if you want to get enough sleep to be productive the next day.</li>
</ol>
<p>Even so, I didn’t fully decide to quit until we had a health crisis at home. My wife and I weren’t prioritizing our health in the first months of the year, and it took its toll.</p>
<p>Stand-up was fun, but it was distracting me from more important things. So I stopped.</p>
<p>I’m not sad or regretful about it, I’m happy that I’ve tried it and that I’ve learned that it’s not what I want to do right now. I’d love to return to it in the future, once I have less pressing things to focus on.</p>
</section>
<section id="mid-2024" class="level2">
<h2 class="anchored" data-anchor-id="mid-2024">Mid 2024</h2>
<p>This was the “work hard and mental health struggles” phase.</p>
<p>I worked with clients on AI projects in various industries, including legal, construction, consumer packaged goods, and finance. I also started blogging again.</p>
<p>I frequently put in 12-hour workdays and worked most weekends. I stopped going to the gym, and switched to home workouts. I rarely went to social events. Life passed by rapidly, and looking back, it all feels like a blur.</p>
<p>I struggled with my mental health. I experienced episodes of depression and anxiety.</p>
<p>Depression has been part of my life for the past twenty years. Though, I’m much better at dealing with it than I used to be. I’ve learned to recognize early warning signs and adjust my approach accordingly.</p>
<p>For that reason, I try to keep track of the “bad days”. Because when they occur too often, my brain is telling me I should take action. During this phase of the year, I had a lot more of those than I’d like.</p>
<p>Eventually, things settled down. I became more conscious of my own limits. I learned to regulate the intensity I put into things. I could push myself hard when I needed to, but also learned to feel comfortable with taking a break and not do anything when I needed to.</p>
<p>I also met some clients in person. While I’m a fan of remote work, seeing people face to face makes you more empathetic toward the people you’re working with. This was a lot more fun than I expected.</p>
<p>During this time I also hired external support to help me develop some of my product ideas and support my consulting work.</p>
</section>
<section id="late-2024" class="level2">
<h2 class="anchored" data-anchor-id="late-2024">Late 2024</h2>
<p>This was the “force myself to stay focused and in motion” phase.</p>
<p>The last few months were still intense, but less focused. I was working with clients while also making time to think about the future. I had a few moments of “what if I drop the consulting thing and go back to product development?”, but decided against it every time.</p>
<p>I did more sales outreach, managed multiple projects, and kept writing blog posts. I wrote a <a href="https://dylancastillo.co/posts/say-what-you-mean-sometimes.html">post about using Structured Outputs in LLMs</a> and fixed a security vulnerability in a <a href="https://github.com/instructor-ai/instructor/pull/1168">Python package</a> that gets more than 1M downloads per month.</p>
<p>I also traveled to Venezuela for the first time in eight years. It was both wonderful and unsettling.</p>
<p>During the first week of the trip, we stayed in a nice hotel in <a href="https://en.wikipedia.org/wiki/Margarita_Island">Margarita</a>, with great food, gym, pools, and a private beach. But if you talked with anyone working at the hotel, you’d learn they were making less than $200/month and did not routinely have access to clean water or electricity. After almost a decade of living in Europe, it felt strange to witness once again such a disparity.</p>
<p>I also met old friends and family there. It made me nostalgic for my childhood and university days, but it also made me realize how much I’ve changed since then. When I was a teenager, I often thought I might end up alone and without friends, as I had extreme social anxiety. Now I’m married, have a great group of friends, and can even tell jokes in public!</p>
<p>After I came back from Venezuela, I started going through more academic research and refreshing my <a href="https://mathacademy.com/">math skills</a>. I’ve always felt that some of my base math skills were lacking and I wanted to fix that. So far, it’s going great.</p>
<p>My father-in-law also moved with us for this part of the year. It was a big change for us, but it’s been a great experience.</p>
</section>
<section id="stats-photos" class="level2">
<h2 class="anchored" data-anchor-id="stats-photos">Stats &amp; Photos</h2>
<p>Here are the stats for the year:</p>
<ul>
<li><strong>💻 Code and blogging</strong>:
<ul>
<li>I committed code on 322 out of 365 days.</li>
<li>I wrote 14 blog posts.</li>
</ul></li>
<li><strong>💰 Financials</strong>:
<ul>
<li>Revenue doubled from last year. So far, my best year.</li>
<li>Costs increased by 155% from last year.</li>
<li>66% of my revenue comes from time-based billing (daily, hourly).</li>
<li>My biggest client represented 33% of my revenue.</li>
</ul></li>
<li><strong>📝 Sales</strong>:
<ul>
<li>I worked on 9 projects with 7 different clients.</li>
<li>I got 3 new clients.</li>
<li>Success rate of proposals: 67%.</li>
</ul></li>
<li><strong>💪 Health &amp; Fitness</strong>:
<ul>
<li>112 strength training sessions (2.2 sessions/week).</li>
<li>3,488 minutes of cardio (~60 minutes/week).</li>
<li>VO2 max: 46 ml/kg/min.</li>
<li>RHR: 57 bpm.</li>
</ul></li>
</ul>
<p>These are some photos from the year:</p>
<div class="custom-gallery-container" data-images="[
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/27394352-8BDD-47EF-AB8D-5B7EEABDD1BE_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;A good stand-up set&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/9BAE2624-4DB5-4D53-8F74-922E25AE2E11_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;A so-so stand-up set&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/281F5B0F-07D6-478C-83E9-73D136A31088_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;The day Edu and Leo decided to never do Airsoft again&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/24E61471-8D7B-4F37-992C-F3428FB46DCA_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;Morocco ❤️&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/4BCF78E3-3FE8-475B-AFB2-D2E9AC358234_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;Old friends 1&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/0CA7E896-69E6-4A2D-BC49-67B3DB5F6618_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;Primos&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/6D90D345-B819-4AD3-865E-249B86EAB6D3_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;Home team&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/08C29CCA-8FCF-4794-8A13-FA31F97CA59F_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;Venezuela, family 1&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/FDC40C8A-EA95-42D5-A927-8ED1801AD182_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;Venezuela, Margarita 😎&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/AE334898-D23D-4F3D-9004-FC1B489A33C9_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;Venezuela, old friends 2&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/451B688D-070E-4E92-BB27-25170A8973A4_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;Venezuela, old friends 3&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/D38E3BF7-4BAC-47B2-83BB-E2CD7216D2E3_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;Venezuela, humming-birds 🐦&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/EC982C3C-B649-4FE9-8E31-812AB9888C32_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;Venezuela, Home&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/D7F82391-78E2-4BDA-8B17-5584DF01F911_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;Venezuela, Zena ❤️&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/F8ECF562-9F0B-4B9E-9B0C-B922D0B826A9_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;Venezuela, Napo's getting old 😢&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/CE02055B-B5A9-454A-9736-B2D86DD17AA7_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;The Colombiano Libertario&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/29408D6A-A961-4004-853A-2959C7A5E636_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;High 🥩 Poker&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/A3D6DCF0-D65B-40C6-A630-FA219AAC0981_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;Tía Mary ❤️&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/2EB0D748-F8AF-49F9-BEF0-3906D7AB017E_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;Family 2&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/PHOTO-2024-12-20-10-02-34.jpg&quot;, &quot;caption&quot;: &quot;Old friends 4&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/609AB45C-8EFC-4DC6-9BFD-241245DD2269_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;Friends (Luciano's farewell 🇦🇷)&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/20A01D83-C0AB-4460-9484-6F32A72E703D_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;Family 3&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/E7FECC11-00B8-4124-9519-82F9ED68C0ED_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;The Dukes of Bocangel ❤️&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/6D91F2D8-D302-4467-A3DC-681CD5D372AE_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;Karaoke 😂&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/2B2543F7-F99E-4D44-BCEA-45AB683A55BF_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;Last run of the year 1&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/89B92C0E-C70F-4660-A0A4-3DA2EEA54B63_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;Last run of the year 2&quot;},
       {&quot;url&quot;: &quot;https://s3.eu-west-1.amazonaws.com/images.dylancastillo.co/2024-personal-snapshot/C9917576-0866-46C3-A500-1E680A24E24F_1_105_c.jpeg&quot;, &quot;caption&quot;: &quot;❤️&quot;}
     ]">
<img class="gallery-image" src="" alt="">
<div class="gallery-caption">

</div>
</div>
<p>I don’t like taking pictures, but looking back, I regret not capturing more key moments from the year. That’s a small lesson I’ll take into next year.</p>
</section>
<section id="lessons-learned" class="level2">
<h2 class="anchored" data-anchor-id="lessons-learned">Lessons Learned</h2>
<p>The three biggest lessons I took away from 2024 are focus, intensity, and action.</p>
<p><strong>Focus</strong> is about figuring out what are the right things to prioritize. It’s easy to say that, but it’s hard to do. Life is full of distractions, and it’s easy to get lost in the noise.</p>
<p>When I’m not sure what to do, I use one heuristic that works well: I prioritize things that will help me on my way regardless of their outcome. For example, if I dedicate more time to writing technical posts, I learn through the act of writing, but I also attract clients who are interested in those posts. The same with sales: I might not get a client from a sales call, but I learn a lot about the process and get better at it. So, regardless of the outcome, I win.</p>
<p><strong>Intensity</strong> is about working hard and taking ownership. This year I handled more work than ever. My brain fought back. At times I felt anxious, depressed, out of energy, and unable to focus. Eventually, my brain accepted that I wouldn’t back down. It stopped fighting against me and began working for me.</p>
<p>It’s not pretty. It’s deeply uncomfortable. But it’s worth it.</p>
<p><strong>Action</strong> is about staying in motion. Being too busy is better than being too idle. When you’re busy, you’re constantly learning, forced to prioritize, and often become more creative under pressure.</p>
<p>I used to think that being “too busy” would prevent me from focusing on the right things. But I eventually realized it was the other way around. The busier I got, the clearer my priorities became. I learned more, and the better I became at what I was doing, the more time I had for the things I really wanted to do.</p>
<p>Being busy made me better and more productive.</p>
</section>
<section id="whats-next" class="level2">
<h2 class="anchored" data-anchor-id="whats-next">What’s Next?</h2>
<p>I’ve realized I’m not great at predicting what I’ll want to do, nor am I a great planner.</p>
<p>Right now, my biggest priority is growing my consulting practice. I also finally found a painkiller product idea that I’ve been slowly working on. If I find enough traction, I’ll pivot to it. But until then, my focus is on consulting.</p>
<p>The only thing I’m sure is that I’ll keep myself busy.</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>yes, I know, what a terrible name.↩︎</p></li>
</ol>
</section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2025,
  author = {Castillo, Dylan},
  title = {2024: {Personal} {Snapshot}},
  date = {2025-01-05},
  url = {https://dylancastillo.co/posts/2024-personal-snapshot.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2025" class="csl-entry quarto-appendix-citeas">
Castillo, Dylan. 2025. <span>“2024: Personal Snapshot.”</span> January
5, 2025. <a href="https://dylancastillo.co/posts/2024-personal-snapshot.html">https://dylancastillo.co/posts/2024-personal-snapshot.html</a>.
</div></div></section></div> ]]></description>
  <category>personal-snapshot</category>
  <guid>https://dylancastillo.co/posts/2024-personal-snapshot.html</guid>
  <pubDate>Sun, 05 Jan 2025 00:00:00 GMT</pubDate>
</item>
<item>
  <title>The good, the bad, and the ugly of Gemini’s structured outputs</title>
  <dc:creator>Dylan Castillo</dc:creator>
  <link>https://dylancastillo.co/posts/gemini-structured-outputs.html</link>
  <description><![CDATA[ 




<p>For a long time, I didn’t pay much attention to the idea that structured outputs could have an impact on the performance of LLMs. But after reading <a href="https://arxiv.org/abs/2408.02442">Let Me Speak Freely?</a> and <a href="https://blog.dottxt.co/say-what-you-mean.html">.txt’s rebuttal</a>, I started to question my assumptions.</p>
<p>I decided to run some benchmarks myself using popular proprietary models, starting with <a href="https://dylancastillo.co/posts/say-what-you-mean-sometimes.html"><em>GPT-4o-mini</em></a>. During my analysis, I found that structured outputs did, in fact, decrease performance on some tasks.</p>
<p>After that, I was curious to see if the same was true for <em>Gemini 1.5 Flash</em>. This time, the answer wasn’t so straightforward, which is why I decided to write a separate post about it. In the process, I ran into an issue in Gemini’s Generative AI SDK that can break your application if you’re not careful.</p>
<p>In this article, I’ll share the results from running various benchmarks for <em>Gemini 1.5 Flash</em> comparing structured and unstructured outputs and the learnings I had along the way.</p>
<p>You can find the full code to run the benchmarks in this <a href="https://github.com/dylanjcastillo/blog/tree/main/_extras/gemini-structured-outputs">GitHub repository</a>.</p>
<section id="results-tldr" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="results-tldr">Results (TLDR)</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Google recently released a new <a href="https://github.com/googleapis/python-genai">Python SDK for Gemini</a>, which seems to address the automatically sorting keys issue.</p>
</div>
</div>
<p>If you’re in a hurry, here are my key findings:</p>
<ul>
<li><strong>The good</strong>: Overall, Gemini’s structured outputs performed on par with unstructured outputs.<sup>1</sup></li>
<li><strong>The bad</strong>: This only holds for the less rigid interpretation of “structured outputs”. When testing constrained decoding specifically, Gemini’s structured outputs performed worse than unstructured outputs.</li>
<li><strong>The ugly</strong>: Function calling and constrained decoding have a big design flaw. The order of the keys specified in the schema is not preserved when using the <a href="https://ai.google.dev/">Generative AI Python SDK</a>. This will break chain-of-thought reasoning in your applications unless you use a workaround (that only works for constrained decoding).</li>
</ul>
<p>The figure below shows the overall results for <em>Gemini 1.5 Flash</em>:</p>
<div id="cell-fig-gemini-flash-best" class="cell page-columns page-full" data-execution_count="1">
<div id="fig-gemini-flash-best" class="cell-output cell-output-display quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-gemini-flash-best-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div>                            <div id="8839e563-ec82-440c-897f-8c2d34e8d122" class="plotly-graph-div" style="height:400px; width:100%;"></div>            <script type="text/javascript">                require(["plotly"], function(Plotly) {                    window.PLOTLYENV=window.PLOTLYENV || {};                                    if (document.getElementById("8839e563-ec82-440c-897f-8c2d34e8d122")) {                    Plotly.newPlot(                        "8839e563-ec82-440c-897f-8c2d34e8d122",                        [{"hoverinfo":"skip","name":"Natural Language","text":["94.84","82.67","97.15"],"textfont":{"size":10},"textposition":"outside","texttemplate":"%{text:.2f}%","x":["GSM8k","Last Letter","Shuffled Objects"],"y":[94.84,82.67,97.15],"type":"bar"},{"hoverinfo":"skip","name":"JSON-Schema","text":["93.63","81.33","86.18"],"textfont":{"size":10},"textposition":"outside","texttemplate":"%{text:.2f}%","x":["GSM8k","Last Letter","Shuffled Objects"],"y":[93.63,81.33,86.18],"type":"bar"},{"hoverinfo":"skip","name":"JSON-Prompt","text":["94.16","82.0","98.37"],"textfont":{"size":10},"textposition":"outside","texttemplate":"%{text:.2f}%","x":["GSM8k","Last Letter","Shuffled Objects"],"y":[94.16,82.0,98.37],"type":"bar"}],                        {"template":{"data":{"barpolar":[{"marker":{"line":{"color":"rgb(17,17,17)","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"barpolar"}],"bar":[{"error_x":{"color":"#f2f5fa"},"error_y":{"color":"#f2f5fa"},"marker":{"line":{"color":"rgb(17,17,17)","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"bar"}],"carpet":[{"aaxis":{"endlinecolor":"#A2B1C6","gridcolor":"#506784","linecolor":"#506784","minorgridcolor":"#506784","startlinecolor":"#A2B1C6"},"baxis":{"endlinecolor":"#A2B1C6","gridcolor":"#506784","linecolor":"#506784","minorgridcolor":"#506784","startlinecolor":"#A2B1C6"},"type":"carpet"}],"choropleth":[{"colorbar":{"outlinewidth":0,"ticks":""},"type":"choropleth"}],"contourcarpet":[{"colorbar":{"outlinewidth":0,"ticks":""},"type":"contourcarpet"}],"contour":[{"colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"type":"contour"}],"heatmapgl":[{"colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"type":"heatmapgl"}],"heatmap":[{"colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"type":"heatmap"}],"histogram2dcontour":[{"colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"type":"histogram2dcontour"}],"histogram2d":[{"colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"type":"histogram2d"}],"histogram":[{"marker":{"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"histogram"}],"mesh3d":[{"colorbar":{"outlinewidth":0,"ticks":""},"type":"mesh3d"}],"parcoords":[{"line":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"parcoords"}],"pie":[{"automargin":true,"type":"pie"}],"scatter3d":[{"line":{"colorbar":{"outlinewidth":0,"ticks":""}},"marker":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"scatter3d"}],"scattercarpet":[{"marker":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"scattercarpet"}],"scattergeo":[{"marker":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"scattergeo"}],"scattergl":[{"marker":{"line":{"color":"#283442"}},"type":"scattergl"}],"scattermapbox":[{"marker":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"scattermapbox"}],"scatterpolargl":[{"marker":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"scatterpolargl"}],"scatterpolar":[{"marker":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"scatterpolar"}],"scatter":[{"marker":{"line":{"color":"#283442"}},"type":"scatter"}],"scatterternary":[{"marker":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"scatterternary"}],"surface":[{"colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"type":"surface"}],"table":[{"cells":{"fill":{"color":"#506784"},"line":{"color":"rgb(17,17,17)"}},"header":{"fill":{"color":"#2a3f5f"},"line":{"color":"rgb(17,17,17)"}},"type":"table"}]},"layout":{"annotationdefaults":{"arrowcolor":"#f2f5fa","arrowhead":0,"arrowwidth":1},"autotypenumbers":"strict","coloraxis":{"colorbar":{"outlinewidth":0,"ticks":""}},"colorscale":{"diverging":[[0,"#8e0152"],[0.1,"#c51b7d"],[0.2,"#de77ae"],[0.3,"#f1b6da"],[0.4,"#fde0ef"],[0.5,"#f7f7f7"],[0.6,"#e6f5d0"],[0.7,"#b8e186"],[0.8,"#7fbc41"],[0.9,"#4d9221"],[1,"#276419"]],"sequential":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"sequentialminus":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]},"colorway":["#636efa","#EF553B","#00cc96","#ab63fa","#FFA15A","#19d3f3","#FF6692","#B6E880","#FF97FF","#FECB52"],"font":{"color":"#f2f5fa"},"geo":{"bgcolor":"rgb(17,17,17)","lakecolor":"rgb(17,17,17)","landcolor":"rgb(17,17,17)","showlakes":true,"showland":true,"subunitcolor":"#506784"},"hoverlabel":{"align":"left"},"hovermode":"closest","mapbox":{"style":"dark"},"margin":{"b":0,"l":0,"r":0,"t":30},"paper_bgcolor":"rgb(17,17,17)","plot_bgcolor":"rgb(17,17,17)","polar":{"angularaxis":{"gridcolor":"#506784","linecolor":"#506784","ticks":""},"bgcolor":"rgb(17,17,17)","radialaxis":{"gridcolor":"#506784","linecolor":"#506784","ticks":""}},"scene":{"xaxis":{"backgroundcolor":"rgb(17,17,17)","gridcolor":"#506784","gridwidth":2,"linecolor":"#506784","showbackground":true,"ticks":"","zerolinecolor":"#C8D4E3"},"yaxis":{"backgroundcolor":"rgb(17,17,17)","gridcolor":"#506784","gridwidth":2,"linecolor":"#506784","showbackground":true,"ticks":"","zerolinecolor":"#C8D4E3"},"zaxis":{"backgroundcolor":"rgb(17,17,17)","gridcolor":"#506784","gridwidth":2,"linecolor":"#506784","showbackground":true,"ticks":"","zerolinecolor":"#C8D4E3"}},"shapedefaults":{"line":{"color":"#f2f5fa"}},"sliderdefaults":{"bgcolor":"#C8D4E3","bordercolor":"rgb(17,17,17)","borderwidth":1,"tickwidth":0},"ternary":{"aaxis":{"gridcolor":"#506784","linecolor":"#506784","ticks":""},"baxis":{"gridcolor":"#506784","linecolor":"#506784","ticks":""},"bgcolor":"rgb(17,17,17)","caxis":{"gridcolor":"#506784","linecolor":"#506784","ticks":""}},"title":{"x":0.05},"updatemenudefaults":{"bgcolor":"#506784","borderwidth":0},"xaxis":{"automargin":true,"gridcolor":"#283442","linecolor":"#506784","ticks":"","title":{"standoff":15},"zerolinecolor":"#283442","zerolinewidth":2},"yaxis":{"automargin":true,"gridcolor":"#283442","linecolor":"#506784","ticks":"","title":{"standoff":15},"zerolinecolor":"#283442","zerolinewidth":2}}},"margin":{"l":50,"r":50,"t":50,"b":50,"pad":10},"yaxis":{"title":{"text":"Score (%)"},"range":[0,105],"fixedrange":true},"xaxis":{"title":{"text":"Task"},"fixedrange":true},"legend":{"orientation":"h","yanchor":"bottom","y":1.05,"xanchor":"center","x":0.5},"modebar":{"remove":["autoScale2d","autoscale","editInChartStudio","editinchartstudio","hoverCompareCartesian","hovercompare","lasso","lasso2d","orbitRotation","orbitrotation","pan","pan2d","pan3d","reset","resetCameraDefault3d","resetCameraLastSave3d","resetGeo","resetSankeyGroup","resetScale2d","resetViewMap","resetViewMapbox","resetViews","resetcameradefault","resetcameralastsave","resetsankeygroup","resetscale","resetview","resetviews","select","select2d","sendDataToCloud","senddatatocloud","tableRotation","tablerotation","toImage","toggleHover","toggleSpikelines","togglehover","togglespikelines","toimage","zoom","zoom2d","zoom3d","zoomIn2d","zoomInGeo","zoomInMap","zoomInMapbox","zoomOut2d","zoomOutGeo","zoomOutMap","zoomOutMapbox","zoomin","zoomout"]},"barmode":"group","height":400,"showlegend":true},                        {"responsive": true}                    ).then(function(){
                            
var gd = document.getElementById('8839e563-ec82-440c-897f-8c2d34e8d122');
var x = new MutationObserver(function (mutations, observer) {{
        var display = window.getComputedStyle(gd).display;
        if (!display || display === 'none') {{
            console.log([gd, 'removed!']);
            Plotly.purge(gd);
            observer.disconnect();
        }}
}});

// Listen for the removal of the full notebook cells
var notebookContainer = gd.closest('#notebook-container');
if (notebookContainer) {{
    x.observe(notebookContainer, {childList: true});
}}

// Listen for the clearing of the current output cell
var outputEl = gd.closest('.output');
if (outputEl) {{
    x.observe(outputEl, {childList: true});
}}

                        })                };                });            </script>        </div>
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-gemini-flash-best-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Best results for Gemini 1.5 Flash.
</figcaption>
</figure>
</div>
</div>
<p>The figure above compares the performance of Gemini’s structured outputs to unstructured outputs. <strong>NL</strong> stands for <em>Natural Language</em>, which means the model writes the output in a free-form manner. In contrast, <strong>JSON-Prompt</strong> and <strong>JSON-Schema</strong> involve structured outputs that follow a predefined JSON schema.</p>
<p>For <strong>JSON-Prompt</strong>, the JSON schema is included in the prompt, instructing the model to generate JSON formatted output based on its MIME type configuration. <strong>JSON-Schema</strong> works similarly, but the schema is set directly in the model’s configuration instead of being included in the prompt.</p>
<p>When considering both <strong>JSON-Prompt</strong> and <strong>JSON-Schema</strong>, Gemini’s structured outputs performed comparably to unstructured outputs. However, with <strong>JSON-Schema</strong> alone (i.e., constrained decoding), performance drops compared to unstructured outputs. This difference is most evident in the <em>Shuffled Objects</em> task, where <strong>NL</strong> achieved a score of 97.15%, while <strong>JSON-Schema</strong> scored 86.18%.</p>
</section>
<section id="structured-outputs-101" class="level2">
<h2 class="anchored" data-anchor-id="structured-outputs-101">Structured outputs 101</h2>
<p>In case you’re not familiar with the concept, structured outputs are a group of methods that <a href="https://arxiv.org/abs/2404.07362">“ensure that the model outputs adhere to a specific structure”</a>. In Open weight models, a <em>structure</em> can mean anything from a JSON schema to a specific regex pattern. With proprietary models, it usually means a JSON schema.</p>
<p>In its less rigid interpretation, this includes any method that can generate LLM outputs adhering to a structured format, such as prompting, <a href="https://platform.openai.com/docs/guides/function-calling">function calling</a>, <a href="https://platform.openai.com/docs/guides/structured-outputs#json-mode">JSON mode</a>, or <a href="https://openai.com/index/introducing-structured-outputs-in-the-api/">constrained decoding</a>.</p>
<p>In its more rigid interpretation, this includes only constrained decoding, as it is the only method that will guarantee the output adheres to the schema you provide.</p>
</section>
<section id="study-design" class="level2">
<h2 class="anchored" data-anchor-id="study-design">Study design</h2>
<p>In Let Me Speak Freely?, Tam et al.&nbsp;evaluated structured and unstructured outputs across three reasoning tasks and six classification tasks. They used exact match to evaluate the reasoning tasks and accuracy to evaluate the classification tasks. They ran the experiments using the following models:</p>
<ol type="1">
<li><strong>Proprietary models</strong>: <em>gpt-3.5-turbo-0125</em>, <em>claude-3-haiku-20240307</em>, <em>gemini-1.5-flash</em>, and <em>gpt-4o-mini-2024-07-18</em>.</li>
<li><strong>Open-weight models</strong>: <em>LLaMA3-8B-Instruct</em>, and <em>Gemma-2-9B-Instruct</em>.</li>
</ol>
<p>For this article, I just focused on <em>Gemini 1.5 Flash</em> and the reasoning tasks. I already ran the benchmarks for <em>GPT-4o-mini</em> and <em>Llama3-8B-Instruct</em> in my <a href="https://dylancastillo.co/posts/say-what-you-mean-sometimes.html">previous post</a>.</p>
<p>I excluded the classification tasks because I believe structured outputs perform better in classification tasks, and this is also in line with the study’s original findings. So I just focused on the three reasoning tasks:</p>
<ol type="1">
<li><a href="https://huggingface.co/datasets/openai/gsm8k">GSM8K</a>: A dataset from of grade school math word problems.</li>
<li><a href="https://huggingface.co/datasets/ChilleD/LastLetterConcat">Last Letter</a>: A dataset of simple word puzzles that require concatening the last letters of a list of names.</li>
<li><a href="https://github.com/google/BIG-bench/tree/main/bigbench/benchmark_tasks/tracking_shuffled_objects">Shuffled Objects</a>: A dataset that requires reasoning about the state of a system after a sequence of shuffling operations.</li>
</ol>
<p>The rest of the article details the process of re-evaluating these benchmarks using <em>Gemini-1.5-Flash</em>.</p>
</section>
<section id="structured-outputs-with-gemini" class="level2">
<h2 class="anchored" data-anchor-id="structured-outputs-with-gemini">Structured outputs with Gemini</h2>
<p>Gemini has three ways of generating structured outputs:</p>
<ol type="1">
<li><a href="https://ai.google.dev/gemini-api/tutorials/extract_structured_data"><strong>Forced function calling (FC)</strong></a>: You force the model to call a “function” and that makes the model generate a JSON schema that matches the function’s arguments.</li>
<li><a href="https://ai.google.dev/gemini-api/docs/structured-output?lang=python#supply-schema-in-prompt"><strong>Schema in prompt (JSON-Prompt)</strong></a>: You include a JSON schema in the prompt, specify <code>mime_type='application/json'</code> and the model generates a response that matches the schema.</li>
<li><a href="https://ai.google.dev/gemini-api/docs/structured-output?lang=python#supply-schema-in-config"><strong>Schema in model configuration (JSON-Schema)</strong></a>: You provide a JSON schema in the model configuration, specify <code>mime_type='application/json'</code> in the request and the model generates a response that matches the schema. This is the only method that seems to use <a href="https://developers.googleblog.com/en/mastering-controlled-generation-with-gemini-15-schema-adherence/">controlled generation</a>.</li>
</ol>
<p>I’ve included <em>JSON-Prompt</em> and <em>JSON-Schema</em> in the analysis, but had to exclude <em>FC</em> because it’s not possible to use it for chain-of-thought reasoning, which is a requirement for the benchmarks.</p>
</section>
<section id="issues-with-geminis-structured-outputs" class="level2">
<h2 class="anchored" data-anchor-id="issues-with-geminis-structured-outputs">Issues with Gemini’s structured outputs</h2>
<p>When running the three benchmarks, I quickly ran into a performance issue with <em>FC</em> and <em>JSON-Schema</em>. In all tasks, both showed double-digit performance drops compared to <em>NL</em>.</p>
<p>This didn’t make a lot of sense, so I started investigating.</p>
<p>I was using the following response schema for all structured outputs:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Response(BaseModel):</span>
<span id="cb1-2">    reasoning: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb1-3">    answer: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span></code></pre></div></div>
<p>The prompts were similar to the one below, adjusted according to the task:</p>
<blockquote class="blockquote">
<p>You are an expert in solving grade school math tasks. You will be presented with a grade-school math word problem and be asked to solve it.</p>
<p>You will always respond with JSON matching the following schema:</p>
<p>[RESPONSE_SCHEMA]</p>
<p>First, provide your step by step reasoning in the “reasoning” field. Then, in the “answer” field, provide your final answer. Don’t include any other text in the “answer” field.</p>
</blockquote>
<p>I eventually realized that the performance drop in <em>JSON-Schema</em> was due to the keys in the schema being reversed when generating the response. I then noticed that Tam et al.&nbsp;briefly mentioned in Let Me Speak Freely? that <em>JSON-Schema</em> responses failed to produce valid JSON due to this exact problem, so they did not include it in their analysis.</p>
<p>I didn’t want to exclude it from the analysis, so I started looking for a way to control the order of the keys in the schema. I found that the order of the keys in the schema gets sorted alphabetically before the response is generated. To confirm this, I ran a test with 100 randomly generated schemas. Every resulting output had its keys sorted alphabetically, so it’s clear this is not by chance.</p>
<p>I also found that the Vertex AI documentation mentions a <a href="https://cloud.google.com/vertex-ai/generative-ai/docs/multimodal/control-generated-output"><code>propertyOrdering</code></a> parameter, which should allow control over the order of keys. However, this feature <a href="https://discuss.ai.google.dev/t/issue-with-key-ordering-in-controlled-generation-on-gemini-1-5/41737/3">doesn’t appear</a> <a href="https://github.com/google-gemini/generative-ai-python/issues/533">to work</a> with the Generative AI Python SDK.</p>
<p>Unable to use the <code>propertyOrdering</code> parameter, I resorted to a quick workaround: I named the keys in a way that forced the desired order alphabetically. Instead of using <code>reasoning</code> and <code>answer</code>, I used <code>reasoning</code> and <code>solution</code>. This preserved the chain-of-thought reasoning in the responses, and resolved the performance drop in <em>JSON-Schema</em>.</p>
<p>But <em>FC</em> was a different story. Unlike <em>JSON-Schema</em>, the order of the keys follow a less predictable pattern, and I couldn’t find a way to control it. So I decided to exclude <em>FC</em> from the analysis.</p>
</section>
<section id="benchmarks-of-gemini-1.5-flash" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="benchmarks-of-gemini-1.5-flash">Benchmarks of Gemini 1.5 Flash</h2>
<p>After applying the key ordering workaround, and additional improvements discussed in my <a href="https://dylancastillo.co/posts/say-what-you-mean-sometimes.html#replicating-.txts-rebuttal.html">previous post</a>, I recomputed the benchmarks.</p>
<p>The table below shows the results for Gemini 1.5 Flash compared to the original results from Tam et al.</p>
<div class="cell page-columns page-full" data-execution_count="2">
<div id="tbl-gemini-1.5-flash" class="cell quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-execution_count="2">
<figure class="quarto-float quarto-float-tbl figure page-columns page-full">
<div aria-describedby="tbl-gemini-1.5-flash-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display" data-execution_count="4">
<style type="text/css">
</style>

<table id="T_cfc97" class="do-not-create-environment cell table table-sm table-striped small">
<thead>
<tr class="header">
<th class="blank" data-quarto-table-cell-role="th">&nbsp;</th>
<th class="blank level0" data-quarto-table-cell-role="th">&nbsp;</th>
<th id="T_cfc97_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">NL</th>
<th id="T_cfc97_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">JSON-Prompt</th>
<th id="T_cfc97_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">JSON-Schema</th>
</tr>
<tr class="even">
<th class="index_name level0" data-quarto-table-cell-role="th">Task</th>
<th class="index_name level1" data-quarto-table-cell-role="th">Method</th>
<th class="blank col0" data-quarto-table-cell-role="th">&nbsp;</th>
<th class="blank col1" data-quarto-table-cell-role="th">&nbsp;</th>
<th class="blank col2" data-quarto-table-cell-role="th">&nbsp;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th rowspan="3" id="T_cfc97_level0_row0" class="row_heading level0 row0" data-quarto-table-cell-role="th">GSM8K</th>
<th id="T_cfc97_level1_row0" class="row_heading level1 row0" data-quarto-table-cell-role="th">Tam et al.</th>
<td id="T_cfc97_row0_col0" class="data row0 col0">89.33</td>
<td id="T_cfc97_row0_col1" class="data row0 col1">89.21</td>
<td id="T_cfc97_row0_col2" class="data row0 col2">47.78</td>
</tr>
<tr class="even">
<th id="T_cfc97_level1_row1" class="row_heading level1 row1" data-quarto-table-cell-role="th">Me, 0-shot</th>
<td id="T_cfc97_row1_col0" class="data row1 col0">93.71</td>
<td id="T_cfc97_row1_col1" class="data row1 col1">93.78</td>
<td id="T_cfc97_row1_col2" class="data row1 col2">93.03</td>
</tr>
<tr class="odd">
<th id="T_cfc97_level1_row2" class="row_heading level1 row2" data-quarto-table-cell-role="th">Me, 3-shot</th>
<td id="T_cfc97_row2_col0" class="data row2 col0">94.84</td>
<td id="T_cfc97_row2_col1" class="data row2 col1">94.16</td>
<td id="T_cfc97_row2_col2" class="data row2 col2">93.63</td>
</tr>
<tr class="even">
<th rowspan="3" id="T_cfc97_level0_row3" class="row_heading level0 row3" data-quarto-table-cell-role="th">Last Letter</th>
<th id="T_cfc97_level1_row3" class="row_heading level1 row3" data-quarto-table-cell-role="th">Tam et al.</th>
<td id="T_cfc97_row3_col0" class="data row3 col0">65.45</td>
<td id="T_cfc97_row3_col1" class="data row3 col1">77.02</td>
<td id="T_cfc97_row3_col2" class="data row3 col2">0.67</td>
</tr>
<tr class="odd">
<th id="T_cfc97_level1_row4" class="row_heading level1 row4" data-quarto-table-cell-role="th">Me, 0-shot</th>
<td id="T_cfc97_row4_col0" class="data row4 col0">82.67</td>
<td id="T_cfc97_row4_col1" class="data row4 col1">80.00</td>
<td id="T_cfc97_row4_col2" class="data row4 col2">81.33</td>
</tr>
<tr class="even">
<th id="T_cfc97_level1_row5" class="row_heading level1 row5" data-quarto-table-cell-role="th">Me, 3-shot</th>
<td id="T_cfc97_row5_col0" class="data row5 col0">80.00</td>
<td id="T_cfc97_row5_col1" class="data row5 col1">82.00</td>
<td id="T_cfc97_row5_col2" class="data row5 col2">80.67</td>
</tr>
<tr class="odd">
<th rowspan="3" id="T_cfc97_level0_row6" class="row_heading level0 row6" data-quarto-table-cell-role="th">Shuffled Obj.</th>
<th id="T_cfc97_level1_row6" class="row_heading level1 row6" data-quarto-table-cell-role="th">Tam et al.</th>
<td id="T_cfc97_row6_col0" class="data row6 col0">58.21</td>
<td id="T_cfc97_row6_col1" class="data row6 col1">65.07</td>
<td id="T_cfc97_row6_col2" class="data row6 col2">N/A</td>
</tr>
<tr class="even">
<th id="T_cfc97_level1_row7" class="row_heading level1 row7" data-quarto-table-cell-role="th">Me, 0-shot</th>
<td id="T_cfc97_row7_col0" class="data row7 col0">97.15</td>
<td id="T_cfc97_row7_col1" class="data row7 col1">92.28</td>
<td id="T_cfc97_row7_col2" class="data row7 col2">86.18</td>
</tr>
<tr class="odd">
<th id="T_cfc97_level1_row8" class="row_heading level1 row8" data-quarto-table-cell-role="th">Me, 3-shot</th>
<td id="T_cfc97_row8_col0" class="data row8 col0">92.68</td>
<td id="T_cfc97_row8_col1" class="data row8 col1">98.37</td>
<td id="T_cfc97_row8_col2" class="data row8 col2">84.96</td>
</tr>
</tbody>
</table>
</div>
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-tbl margin-caption" id="tbl-gemini-1.5-flash-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: Results for Gemini 1.5 Flash.
</figcaption>
</figure>
</div>
</div>
<p>Using a 0-shot prompt and 3-shot prompts, I was able to improve all the metrics on the tasks and methods Tam et al.&nbsp;used for their benchmarks. Which is great!</p>
<p><em>NL</em> and <em>JSON-Prompt</em> are tied, without a clear winner between them. Each method got a slight edge over in 3 out of 6 tasks. On the other hand, <em>JSON-Schema</em> performed worst than <em>NL</em> in 5 out of 6 tasks. Plus, in <em>Shuffled Objects</em>, it did so with a gap of more than 10 percentage points: 97.15% for <em>NL</em> vs.&nbsp;86.18% for <em>JSON-Schema</em>.</p>
<p>Tam et al.&nbsp;defined structured outputs as any method that “involves providing output in standardized formats like JSON or XML through format restriction.” which is in line with the less rigid interpretation of structured outputs. Using this definition, the results show no performance gap between structured and unstructured outputs. This directly contradicts the study’s original claim.</p>
<p>But if you take the also common interpretation that constrained decoding is the only form of structured generation, then the study’s original conclusion still applies: there is indeed a significant performance gap between structured and unstructured outputs.</p>
<p>Weird, I know. But that’s the way it is.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Results are mixed for Gemini 1.5 Flash.</p>
<p>The good news is that structured outputs perform on par with unstructured ones. The bad news is that this only holds if you adopt the more flexible definition of “structured outputs.” And the ugly news is that Gemini’s Generative AI SDK has a major issue in how it handles the order of keys in the provided schema.</p>
<p>Based on the results, I’d suggest the following when using Gemini:</p>
<ol type="1">
<li>Avoid FC for any tasks that require chain-of-thought reasoning.</li>
<li>Default to JSON-Prompt over JSON-Schema for reasoning tasks.</li>
</ol>
<p>Finally, I want to emphasize that I love working with structured outputs. They save a lot of time. But I know there are tasks where they might perform worse (or better!) than unstructured outputs. There’s not enough evidence to support one or the other, so what I should just run my own evals and decide based on that.</p>
<p>That’s the real takeaway: run your own evals and choose the approach that works best for you. Don’t blindly trust random posts online.</p>
<p>You can find the code to replicate my results in this <a href="https://github.com/dylanjcastillo/blog/tree/main/_extras/gemini-structured-outputs">GitHub repository</a>.</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Assuming the less rigid interpretation of “structured outputs”.↩︎</p></li>
</ol>
</section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2024,
  author = {Castillo, Dylan},
  title = {The Good, the Bad, and the Ugly of {Gemini’s} Structured
    Outputs},
  date = {2024-12-27},
  url = {https://dylancastillo.co/posts/gemini-structured-outputs.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2024" class="csl-entry quarto-appendix-citeas">
Castillo, Dylan. 2024. <span>“The Good, the Bad, and the Ugly of
Gemini’s Structured Outputs.”</span> December 27, 2024. <a href="https://dylancastillo.co/posts/gemini-structured-outputs.html">https://dylancastillo.co/posts/gemini-structured-outputs.html</a>.
</div></div></section></div> ]]></description>
  <category>llm</category>
  <category>gemini</category>
  <category>pydantic</category>
  <category>python</category>
  <guid>https://dylancastillo.co/posts/gemini-structured-outputs.html</guid>
  <pubDate>Fri, 27 Dec 2024 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Structured outputs can hurt the performance of LLMs</title>
  <dc:creator>Dylan Castillo</dc:creator>
  <link>https://dylancastillo.co/posts/say-what-you-mean-sometimes.html</link>
  <description><![CDATA[ 




<p>When I read <a href="https://arxiv.org/abs/2408.02442">Let Me Speak Freely?</a> by Tam et al.&nbsp;I thought they raised an interesting question: does constraining LLM outputs to structured formats impact the quality of their responses?</p>
<p>In both the original study and their recent update, Tam et al.&nbsp;concluded that is the case. They found that “structured generation constraints significantly impact LLM performance across various tasks”.</p>
<p>But the study had major flaws. The <a href="https://dottxt.co/">.txt</a> team wrote a very compelling <a href="https://dottxt.co/blog/let-me-speak-freely">rebuttal</a> to the paper. For <em>Llama-3-8B-Instruct</em>, they demonstrate that Tam, et al.&nbsp;results were mostly due to poor prompting, unfair comparisons and the improper use of an “AI parser” rather than the use of structured outputs.</p>
<p>I liked the rebuttal but it still left me wondering how well their results generalize. They focused on a single model<sup>1</sup>, which represents a small fraction of the LLMs powering applications in production today. Open-weight models offer more flexibility on how to <em>structure</em> your output, such as letting users specify <a href="https://dottxt-ai.github.io/outlines/latest/reference/generation/regex/">regex expressions</a> to constrain the output. Proprietary models lack this. Right now, JSON is the only structured output format guaranteed to work across most popular providers.</p>
<p>Given this constraint, would the .txt team’s results still hold?</p>
<p>Plus, both the original study and the rebuttal focused on tasks that might not be a good proxy for the full range of tasks people use LLMs for. Would the rebuttal results be different in settings outside of simple reasoning tasks?</p>
<p>So I decided to:</p>
<ol type="1">
<li>Replicate the results from .txt’s rebuttal using <em>LLaMA3-8B-Instruct</em>.</li>
<li>Replicate the same tasks using a proprietary model <em>GPT-4o-mini</em>.</li>
<li>Test results on a broader set of tasks such as <a href="https://livebench.ai/">LiveBench</a>.</li>
</ol>
<p>This article presents the results of the first two steps. All the code is available on <a href="https://github.com/dylanjcastillo/blog/tree/main/_extras/say-what-you-mean-sometimes">Github</a>.</p>
<section id="results" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="results">Results</h2>
<p>If you’re short on time, here are the key findings:</p>
<ol type="1">
<li>Tam et al.’s conclusions about structured outputs might still hold, even if they did not properly test for it. There are tasks where structured outputs perform worse than unstructured ones.</li>
<li>.txt’s rebuttal is accurate. It shows that structured outputs are as good or better than unstructured outputs for <em>LLaMA3-8B-Instruct</em> in the tasks considered. But a similar approach did not hold for <em>GPT-4o-mini</em> (and possibly other models).</li>
</ol>
<p>The figure below shows the results for <em>GPT-4o-mini</em> using .txt’s prompt fixes, along with additional improvements I made.</p>
<div id="cell-fig-gpt-4o-mini-best" class="cell page-columns page-full" data-execution_count="1">
<div id="fig-gpt-4o-mini-best" class="cell-output cell-output-display quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-gpt-4o-mini-best-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div>                            <div id="f57c9335-f6b7-416b-ba77-e8f2b57ff706" class="plotly-graph-div" style="height:400px; width:100%;"></div>            <script type="text/javascript">                require(["plotly"], function(Plotly) {                    window.PLOTLYENV=window.PLOTLYENV || {};                                    if (document.getElementById("f57c9335-f6b7-416b-ba77-e8f2b57ff706")) {                    Plotly.newPlot(                        "f57c9335-f6b7-416b-ba77-e8f2b57ff706",                        [{"hoverinfo":"skip","name":"Structured","text":["93.86","94.67","89.84"],"textposition":"outside","texttemplate":"%{text:.2f}%","x":["GSM8k","Last Letter","Shuffled Objects"],"y":[93.86,94.67,89.84],"type":"bar"},{"hoverinfo":"skip","name":"Unstructured","text":["94.31","92.0","95.12"],"textposition":"outside","texttemplate":"%{text:.2f}%","x":["GSM8k","Last Letter","Shuffled Objects"],"y":[94.31,92.0,95.12],"type":"bar"}],                        {"template":{"data":{"barpolar":[{"marker":{"line":{"color":"rgb(17,17,17)","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"barpolar"}],"bar":[{"error_x":{"color":"#f2f5fa"},"error_y":{"color":"#f2f5fa"},"marker":{"line":{"color":"rgb(17,17,17)","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"bar"}],"carpet":[{"aaxis":{"endlinecolor":"#A2B1C6","gridcolor":"#506784","linecolor":"#506784","minorgridcolor":"#506784","startlinecolor":"#A2B1C6"},"baxis":{"endlinecolor":"#A2B1C6","gridcolor":"#506784","linecolor":"#506784","minorgridcolor":"#506784","startlinecolor":"#A2B1C6"},"type":"carpet"}],"choropleth":[{"colorbar":{"outlinewidth":0,"ticks":""},"type":"choropleth"}],"contourcarpet":[{"colorbar":{"outlinewidth":0,"ticks":""},"type":"contourcarpet"}],"contour":[{"colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"type":"contour"}],"heatmapgl":[{"colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"type":"heatmapgl"}],"heatmap":[{"colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"type":"heatmap"}],"histogram2dcontour":[{"colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"type":"histogram2dcontour"}],"histogram2d":[{"colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"type":"histogram2d"}],"histogram":[{"marker":{"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"histogram"}],"mesh3d":[{"colorbar":{"outlinewidth":0,"ticks":""},"type":"mesh3d"}],"parcoords":[{"line":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"parcoords"}],"pie":[{"automargin":true,"type":"pie"}],"scatter3d":[{"line":{"colorbar":{"outlinewidth":0,"ticks":""}},"marker":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"scatter3d"}],"scattercarpet":[{"marker":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"scattercarpet"}],"scattergeo":[{"marker":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"scattergeo"}],"scattergl":[{"marker":{"line":{"color":"#283442"}},"type":"scattergl"}],"scattermapbox":[{"marker":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"scattermapbox"}],"scatterpolargl":[{"marker":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"scatterpolargl"}],"scatterpolar":[{"marker":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"scatterpolar"}],"scatter":[{"marker":{"line":{"color":"#283442"}},"type":"scatter"}],"scatterternary":[{"marker":{"colorbar":{"outlinewidth":0,"ticks":""}},"type":"scatterternary"}],"surface":[{"colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"type":"surface"}],"table":[{"cells":{"fill":{"color":"#506784"},"line":{"color":"rgb(17,17,17)"}},"header":{"fill":{"color":"#2a3f5f"},"line":{"color":"rgb(17,17,17)"}},"type":"table"}]},"layout":{"annotationdefaults":{"arrowcolor":"#f2f5fa","arrowhead":0,"arrowwidth":1},"autotypenumbers":"strict","coloraxis":{"colorbar":{"outlinewidth":0,"ticks":""}},"colorscale":{"diverging":[[0,"#8e0152"],[0.1,"#c51b7d"],[0.2,"#de77ae"],[0.3,"#f1b6da"],[0.4,"#fde0ef"],[0.5,"#f7f7f7"],[0.6,"#e6f5d0"],[0.7,"#b8e186"],[0.8,"#7fbc41"],[0.9,"#4d9221"],[1,"#276419"]],"sequential":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"sequentialminus":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]},"colorway":["#636efa","#EF553B","#00cc96","#ab63fa","#FFA15A","#19d3f3","#FF6692","#B6E880","#FF97FF","#FECB52"],"font":{"color":"#f2f5fa"},"geo":{"bgcolor":"rgb(17,17,17)","lakecolor":"rgb(17,17,17)","landcolor":"rgb(17,17,17)","showlakes":true,"showland":true,"subunitcolor":"#506784"},"hoverlabel":{"align":"left"},"hovermode":"closest","mapbox":{"style":"dark"},"margin":{"b":0,"l":0,"r":0,"t":30},"paper_bgcolor":"rgb(17,17,17)","plot_bgcolor":"rgb(17,17,17)","polar":{"angularaxis":{"gridcolor":"#506784","linecolor":"#506784","ticks":""},"bgcolor":"rgb(17,17,17)","radialaxis":{"gridcolor":"#506784","linecolor":"#506784","ticks":""}},"scene":{"xaxis":{"backgroundcolor":"rgb(17,17,17)","gridcolor":"#506784","gridwidth":2,"linecolor":"#506784","showbackground":true,"ticks":"","zerolinecolor":"#C8D4E3"},"yaxis":{"backgroundcolor":"rgb(17,17,17)","gridcolor":"#506784","gridwidth":2,"linecolor":"#506784","showbackground":true,"ticks":"","zerolinecolor":"#C8D4E3"},"zaxis":{"backgroundcolor":"rgb(17,17,17)","gridcolor":"#506784","gridwidth":2,"linecolor":"#506784","showbackground":true,"ticks":"","zerolinecolor":"#C8D4E3"}},"shapedefaults":{"line":{"color":"#f2f5fa"}},"sliderdefaults":{"bgcolor":"#C8D4E3","bordercolor":"rgb(17,17,17)","borderwidth":1,"tickwidth":0},"ternary":{"aaxis":{"gridcolor":"#506784","linecolor":"#506784","ticks":""},"baxis":{"gridcolor":"#506784","linecolor":"#506784","ticks":""},"bgcolor":"rgb(17,17,17)","caxis":{"gridcolor":"#506784","linecolor":"#506784","ticks":""}},"title":{"x":0.05},"updatemenudefaults":{"bgcolor":"#506784","borderwidth":0},"xaxis":{"automargin":true,"gridcolor":"#283442","linecolor":"#506784","ticks":"","title":{"standoff":15},"zerolinecolor":"#283442","zerolinewidth":2},"yaxis":{"automargin":true,"gridcolor":"#283442","linecolor":"#506784","ticks":"","title":{"standoff":15},"zerolinecolor":"#283442","zerolinewidth":2}}},"margin":{"l":50,"r":50,"t":50,"b":50,"pad":10},"yaxis":{"title":{"text":"Score (%)"},"range":[0,105],"fixedrange":true},"xaxis":{"title":{"text":"Task"},"fixedrange":true},"legend":{"orientation":"h","yanchor":"bottom","y":1.05,"xanchor":"center","x":0.5},"modebar":{"remove":["autoScale2d","autoscale","editInChartStudio","editinchartstudio","hoverCompareCartesian","hovercompare","lasso","lasso2d","orbitRotation","orbitrotation","pan","pan2d","pan3d","reset","resetCameraDefault3d","resetCameraLastSave3d","resetGeo","resetSankeyGroup","resetScale2d","resetViewMap","resetViewMapbox","resetViews","resetcameradefault","resetcameralastsave","resetsankeygroup","resetscale","resetview","resetviews","select","select2d","sendDataToCloud","senddatatocloud","tableRotation","tablerotation","toImage","toggleHover","toggleSpikelines","togglehover","togglespikelines","toimage","zoom","zoom2d","zoom3d","zoomIn2d","zoomInGeo","zoomInMap","zoomInMapbox","zoomOut2d","zoomOutGeo","zoomOutMap","zoomOutMapbox","zoomin","zoomout"]},"barmode":"group","height":400,"showlegend":true},                        {"responsive": true}                    ).then(function(){
                            
var gd = document.getElementById('f57c9335-f6b7-416b-ba77-e8f2b57ff706');
var x = new MutationObserver(function (mutations, observer) {{
        var display = window.getComputedStyle(gd).display;
        if (!display || display === 'none') {{
            console.log([gd, 'removed!']);
            Plotly.purge(gd);
            observer.disconnect();
        }}
}});

// Listen for the removal of the full notebook cells
var notebookContainer = gd.closest('#notebook-container');
if (notebookContainer) {{
    x.observe(notebookContainer, {childList: true});
}}

// Listen for the clearing of the current output cell
var outputEl = gd.closest('.output');
if (outputEl) {{
    x.observe(outputEl, {childList: true});
}}

                        })                };                });            </script>        </div>
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-gpt-4o-mini-best-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Overall results for GPT-4o-mini.
</figcaption>
</figure>
</div>
</div>
<p>For <strong>GSM8K</strong> and <strong>Last Letter</strong>, structured and unstructured methods scored similarly. But for <strong>Shuffled Objects</strong>, unstructured outputs clearly surpassed a structured format.</p>
<p>The rest of the article will explain the approach I took to get these results.</p>
</section>
<section id="study-design" class="level2">
<h2 class="anchored" data-anchor-id="study-design">Study design</h2>
<p>Tam et al.&nbsp;evaluated structured and unstructured outputs across three reasoning tasks and six classification tasks. They used exact match to evaluate the reasoning tasks and accuracy to evaluate the classification tasks. They ran the experiments using the following models:</p>
<ol type="1">
<li><strong>Proprietary models</strong>: <em>gpt-3.5-turbo-0125</em>, <em>claude-3-haiku-20240307</em>, <em>gemini-1.5-flash</em>, and <em>gpt-4o-mini-2024-07-18</em>.</li>
<li><strong>Open-weight models</strong>: <em>LLaMA3-8B-Instruct</em>, and <em>Gemma-2-9B-Instruct</em>.</li>
</ol>
<p>.txt used a similar setup, but only focused on the reasoning tasks using <em>LLaMA3-8B-Instruct</em>. They did not include classification tasks because Tam et al.&nbsp;observed that structured outputs resulted in better performance in these tasks, so there was no need to test for it.</p>
<p>I also believe that structured outputs are better for classification tasks. So, I excluded them from my analysis as well.</p>
<p>The reasoning tasks were:</p>
<ol type="1">
<li><a href="https://huggingface.co/datasets/openai/gsm8k">GSM8K</a>: A dataset from of grade school math word problems.</li>
<li><a href="https://huggingface.co/datasets/ChilleD/LastLetterConcat">Last Letter</a>: A dataset of simple word puzzles that require concatening the last letters of a list of names.</li>
<li><a href="https://github.com/google/BIG-bench/tree/main/bigbench/benchmark_tasks/tracking_shuffled_objects">Shuffled Objects</a>: A dataset that requires reasoning about the state of a system after a sequence of shuffling operations.</li>
</ol>
<p>The rest of the article details the process of replicating .txt’s rebuttal on these tasks and evaluating the same tasks using <em>GPT-4o-mini</em>.</p>
</section>
<section id="replicating-.txts-rebuttal" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="replicating-.txts-rebuttal">Replicating .txt’s rebuttal</h2>
<p>.txt made it very easy to reproduce their results by sharing their <a href="https://github.com/dottxt-ai/demos/tree/main/say-what-you-mean">code on Github</a>. I just set up a machine at <a href="https://modal.com/">Modal</a> and ran the code.</p>
<p>While going through the code, I noticed some small issues with the prompts. So I decided to tweak them a bit.</p>
<p>Below are .txt’s original results compared to mine, after the prompt adjustments:</p>
<div class="cell page-columns page-full" data-execution_count="2">
<div id="tbl-llama-3-8b-instruct" class="cell quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-execution_count="2">
<figure class="quarto-float quarto-float-tbl figure page-columns page-full">
<div aria-describedby="tbl-llama-3-8b-instruct-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display" data-execution_count="35">
<style type="text/css">
</style>

<table id="T_83ac5" class="do-not-create-environment cell table table-sm table-striped small">
<thead>
<tr class="header">
<th id="T_83ac5_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">Task</th>
<th colspan="2" id="T_83ac5_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">.txt</th>
<th colspan="2" id="T_83ac5_level0_col3" class="col_heading level0 col3" data-quarto-table-cell-role="th">me, 3-shot</th>
</tr>
<tr class="even">
<th id="T_83ac5_level1_col0" class="col_heading level1 col0" data-quarto-table-cell-role="th"></th>
<th id="T_83ac5_level1_col1" class="col_heading level1 col1" data-quarto-table-cell-role="th">Unstructured</th>
<th id="T_83ac5_level1_col2" class="col_heading level1 col2" data-quarto-table-cell-role="th">Structured</th>
<th id="T_83ac5_level1_col3" class="col_heading level1 col3" data-quarto-table-cell-role="th">Unstructured</th>
<th id="T_83ac5_level1_col4" class="col_heading level1 col4" data-quarto-table-cell-role="th">Structured</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_83ac5_row0_col0" class="data row0 col0">GSM8K</td>
<td id="T_83ac5_row0_col1" class="data row0 col1">77.18</td>
<td id="T_83ac5_row0_col2" class="data row0 col2">77.79</td>
<td id="T_83ac5_row0_col3" class="data row0 col3">79.98</td>
<td id="T_83ac5_row0_col4" class="data row0 col4">79.45</td>
</tr>
<tr class="even">
<td id="T_83ac5_row1_col0" class="data row1 col0">Last Letter</td>
<td id="T_83ac5_row1_col1" class="data row1 col1">73.33</td>
<td id="T_83ac5_row1_col2" class="data row1 col2">77.33</td>
<td id="T_83ac5_row1_col3" class="data row1 col3">74.00</td>
<td id="T_83ac5_row1_col4" class="data row1 col4">78.00</td>
</tr>
<tr class="odd">
<td id="T_83ac5_row2_col0" class="data row2 col0">Shuffled Objects</td>
<td id="T_83ac5_row2_col1" class="data row2 col1">40.72</td>
<td id="T_83ac5_row2_col2" class="data row2 col2">44.35</td>
<td id="T_83ac5_row2_col3" class="data row2 col3">42.68</td>
<td id="T_83ac5_row2_col4" class="data row2 col4">43.90</td>
</tr>
</tbody>
</table>
</div>
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-tbl margin-caption" id="tbl-llama-3-8b-instruct-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: Results for LLaMA3-8B-Instruct.
</figcaption>
</figure>
</div>
</div>
<p>Except for <strong>Structured</strong> in the <strong>Shuffled Objects</strong> task, I was able to improve all the metrics. In <strong>GSM8K’s</strong> case, even reversing .txt’s result, with <strong>Unstructured</strong> outperforming <strong>Structured</strong> by a small margin.</p>
<p>But I don’t think this matters much.</p>
<p>Their conclusion still holds: structured outputs are either as good as or better than unstructured outputs, in the tasks considered.</p>
<p>I’ll explain the prompt changes I made below, so that you can judge for yourself if they make sense.</p>
<section id="formatting-few-shot-examples" class="level3">
<h3 class="anchored" data-anchor-id="formatting-few-shot-examples">Formatting few-shot examples</h3>
<p>In the <strong>GSM8K</strong> and <strong>Last Letter</strong> tasks, the few-shot prompt for both unstructured and structured used examples formatted as JSON objects and asked the LLM to produce the output in the same format, from which the answer was extracted.</p>
<p>That felt unfair. Even though you’re not formally constraining the LLM to produce a JSON object, you’re still asking it to format its response in somewhat unnatural way.</p>
<p>I adjusted the prompts to be as similar as possible for both unstructured and structured outputs while still trying to get the most out of each approach.</p>
<p>For example, in <strong>GSM8K</strong>, the unstructured prompt is:</p>
<blockquote class="blockquote">
<p>You are an expert in solving grade school math tasks. You will be presented with a grade-school math word problem and be asked to solve it. You will always respond in the following format:</p>
<p>&lt;str, reasoning about the answer&gt;</p>
<p>ANSWER: &lt;int, final answer&gt;</p>
<p>First, provide your step by step reasoning. Then, in ANSWER, provide an integer that corresponds to the correct answer to the question. Don’t include any other text in ANSWER.</p>
</blockquote>
<p>And the structured prompt is:</p>
<blockquote class="blockquote">
<p>You are an expert in solving grade school math tasks. You will be presented with a grade-school math word problem and be asked to solve it. You will always respond in the following format:</p>
<p>{“reasoning”: &lt;str, reasoning about the answer&gt;, “answer”: &lt;int, final answer&gt;}</p>
<p>First, provide your step by step reasoning in the “reasoning” field. Then, in the “answer” field, provide an integer that corresponds to the correct answer to the question. Don’t include any other text in the “answer” field.</p>
</blockquote>
<p>Finally, for all the tasks, I used a 3-shot prompt.</p>
</section>
<section id="clarifying-the-task" class="level3">
<h3 class="anchored" data-anchor-id="clarifying-the-task">Clarifying the task</h3>
<p>I also tried to make the prompts clearer. The description of the task in the original <strong>Last Letter</strong> prompt was:</p>
<blockquote class="blockquote">
<p>You are an expert in solving simple word puzzles using reasoning steps. Your specific task is going to be to take a list of 4 names and reason about the last letter of each ., then you will concatenate those letters into a word.</p>
</blockquote>
<p>I changed it to:</p>
<blockquote class="blockquote">
<p>You are an expert in solving word puzzles. Your specific task is going to be to take a list of 4 names, get the last letter of each and concatenate these letters into a word.</p>
</blockquote>
<p>The original prompt was reasonable, but I thought the new version was clearer. Through trial and error, I’ve learned that when working with LLMs, it’s best to be as clear and direct as possible.</p>
</section>
</section>
<section id="evaluating-gpt-4o-mini" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="evaluating-gpt-4o-mini">Evaluating GPT-4o-mini</h2>
<p>Using the same setup as before, I ran the same tasks with <code>gpt-4o-mini-2024-07-18</code>.</p>
<p>In the table below, you can see the results, including the original results from Tam et al.&nbsp;for comparison:</p>
<div class="cell page-columns page-full" data-execution_count="3">
<div id="tbl-gpt-4o-mini" class="cell quarto-float quarto-figure quarto-figure-center anchored page-columns page-full" data-execution_count="3">
<figure class="quarto-float quarto-float-tbl figure page-columns page-full">
<div aria-describedby="tbl-gpt-4o-mini-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display" data-execution_count="36">
<style type="text/css">
</style>

<table id="T_769d4" class="do-not-create-environment cell table table-sm table-striped small">
<thead>
<tr class="header">
<th class="blank" data-quarto-table-cell-role="th">&nbsp;</th>
<th class="blank level0" data-quarto-table-cell-role="th">&nbsp;</th>
<th id="T_769d4_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">NL</th>
<th id="T_769d4_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">FRI</th>
<th id="T_769d4_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">JSON-Mode</th>
<th id="T_769d4_level0_col3" class="col_heading level0 col3" data-quarto-table-cell-role="th">JSON-Schema</th>
</tr>
<tr class="even">
<th class="index_name level0" data-quarto-table-cell-role="th">Task</th>
<th class="index_name level1" data-quarto-table-cell-role="th">Method</th>
<th class="blank col0" data-quarto-table-cell-role="th">&nbsp;</th>
<th class="blank col1" data-quarto-table-cell-role="th">&nbsp;</th>
<th class="blank col2" data-quarto-table-cell-role="th">&nbsp;</th>
<th class="blank col3" data-quarto-table-cell-role="th">&nbsp;</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th rowspan="3" id="T_769d4_level0_row0" class="row_heading level0 row0" data-quarto-table-cell-role="th">GSM8K</th>
<th id="T_769d4_level1_row0" class="row_heading level1 row0" data-quarto-table-cell-role="th">Tam et al.</th>
<td id="T_769d4_row0_col0" class="data row0 col0">94.57</td>
<td id="T_769d4_row0_col1" class="data row0 col1">87.17</td>
<td id="T_769d4_row0_col2" class="data row0 col2">86.95</td>
<td id="T_769d4_row0_col3" class="data row0 col3">91.71</td>
</tr>
<tr class="even">
<th id="T_769d4_level1_row1" class="row_heading level1 row1" data-quarto-table-cell-role="th">Me, 0-shot</th>
<td id="T_769d4_row1_col0" class="data row1 col0">94.31</td>
<td id="T_769d4_row1_col1" class="data row1 col1">92.12</td>
<td id="T_769d4_row1_col2" class="data row1 col2">93.33</td>
<td id="T_769d4_row1_col3" class="data row1 col3">93.48</td>
</tr>
<tr class="odd">
<th id="T_769d4_level1_row2" class="row_heading level1 row2" data-quarto-table-cell-role="th">Me, 3-shot</th>
<td id="T_769d4_row2_col0" class="data row2 col0">93.86</td>
<td id="T_769d4_row2_col1" class="data row2 col1">92.72</td>
<td id="T_769d4_row2_col2" class="data row2 col2">93.25</td>
<td id="T_769d4_row2_col3" class="data row2 col3">92.95</td>
</tr>
<tr class="even">
<th rowspan="3" id="T_769d4_level0_row3" class="row_heading level0 row3" data-quarto-table-cell-role="th">Last Letter</th>
<th id="T_769d4_level1_row3" class="row_heading level1 row3" data-quarto-table-cell-role="th">Tam et al.</th>
<td id="T_769d4_row3_col0" class="data row3 col0">83.11</td>
<td id="T_769d4_row3_col1" class="data row3 col1">84.73</td>
<td id="T_769d4_row3_col2" class="data row3 col2">76.00</td>
<td id="T_769d4_row3_col3" class="data row3 col3">86.07</td>
</tr>
<tr class="odd">
<th id="T_769d4_level1_row4" class="row_heading level1 row4" data-quarto-table-cell-role="th">Me, 0-shot</th>
<td id="T_769d4_row4_col0" class="data row4 col0">87.33</td>
<td id="T_769d4_row4_col1" class="data row4 col1">88.00</td>
<td id="T_769d4_row4_col2" class="data row4 col2">90.00</td>
<td id="T_769d4_row4_col3" class="data row4 col3">87.33</td>
</tr>
<tr class="even">
<th id="T_769d4_level1_row5" class="row_heading level1 row5" data-quarto-table-cell-role="th">Me, 3-shot</th>
<td id="T_769d4_row5_col0" class="data row5 col0">92.00</td>
<td id="T_769d4_row5_col1" class="data row5 col1">94.67</td>
<td id="T_769d4_row5_col2" class="data row5 col2">90.00</td>
<td id="T_769d4_row5_col3" class="data row5 col3">93.33</td>
</tr>
<tr class="odd">
<th rowspan="3" id="T_769d4_level0_row6" class="row_heading level0 row6" data-quarto-table-cell-role="th">Shuffled Obj.</th>
<th id="T_769d4_level1_row6" class="row_heading level1 row6" data-quarto-table-cell-role="th">Tam et al.</th>
<td id="T_769d4_row6_col0" class="data row6 col0">82.85</td>
<td id="T_769d4_row6_col1" class="data row6 col1">81.46</td>
<td id="T_769d4_row6_col2" class="data row6 col2">76.43</td>
<td id="T_769d4_row6_col3" class="data row6 col3">81.77</td>
</tr>
<tr class="even">
<th id="T_769d4_level1_row7" class="row_heading level1 row7" data-quarto-table-cell-role="th">Me, 0-shot</th>
<td id="T_769d4_row7_col0" class="data row7 col0">95.12</td>
<td id="T_769d4_row7_col1" class="data row7 col1">79.67</td>
<td id="T_769d4_row7_col2" class="data row7 col2">81.71</td>
<td id="T_769d4_row7_col3" class="data row7 col3">89.84</td>
</tr>
<tr class="odd">
<th id="T_769d4_level1_row8" class="row_heading level1 row8" data-quarto-table-cell-role="th">Me, 3-shot</th>
<td id="T_769d4_row8_col0" class="data row8 col0">92.68</td>
<td id="T_769d4_row8_col1" class="data row8 col1">69.51</td>
<td id="T_769d4_row8_col2" class="data row8 col2">62.60</td>
<td id="T_769d4_row8_col3" class="data row8 col3">65.85</td>
</tr>
</tbody>
</table>
</div>
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-tbl margin-caption" id="tbl-gpt-4o-mini-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2: Results for GPT-4o-mini.
</figcaption>
</figure>
</div>
</div>
<p><em>NL</em> stands for “Natural Language”, which would correspond to the <em>Unstructured</em> method in the previous table.</p>
<p><em>FRI</em> stands for “Format Restricting Instructions”, which is a JSON generated through the OpenAI’s <a href="https://platform.openai.com/docs/guides/function-calling">function calling</a>. <em>JSON-Mode</em> is a JSON generated through the OpenAI’s <a href="https://platform.openai.com/docs/guides/structured-outputs#json-mode">JSON mode</a>. <em>JSON-Schema</em> is a JSON generated using <a href="https://openai.com/index/introducing-structured-outputs-in-the-api/">constrained decoding</a>.</p>
<p><em>JSON-Schema</em> is the closest equivalent to <strong>Structured</strong> as referenced in the previous table. But, in real-life applications, you don’t really care about how the output was generated. You just want to get the output in the format you want. So, for the sake of comparison, I will consider the three other methods equivalent to <strong>Structured</strong> as well.</p>
<section id="adjusting-for-proprietary-models" class="level3">
<h3 class="anchored" data-anchor-id="adjusting-for-proprietary-models">Adjusting for proprietary models</h3>
<p>In this case, I allowed for 3 retries in the case of parsing errors. I allowed for this because function calling had high error rates in the zero-shot prompting scenario.</p>
<p>These retries primarily affected <strong>FRI</strong> results. This might make the comparisons in <strong>Last Letter</strong> biased in favor of structured outputs (<strong>FRI</strong> was the best method in this case). But since <strong>JSON-Schema</strong> also outperformed <strong>NL</strong> in this case, this adjustment does not alter the overall conclusions. The other methods maintained error rates of &lt;0.5% in <strong>GSM8K</strong> and 0% in <strong>Last Letter</strong> and <strong>Shuffled Objects</strong>.</p>
<p>I used slightly different parsing functions for <strong>Unstructured</strong> and <strong>Structured</strong> outputs. The <strong>Unstructured</strong> parser was more lenient, removing commas and periods at the end of responses. But I believe this remains a fair comparison given that in the <strong>Structured</strong> cases you provide a JSON schema which is more informative.</p>
</section>
<section id="analyzing-the-results" class="level3">
<h3 class="anchored" data-anchor-id="analyzing-the-results">Analyzing the results</h3>
<p>Similar to what the .txt team found, after adjusting the prompts, the performance of structured outputs increases substantially compared to Tam et al.</p>
<p>Except for <em>NL</em> in <strong>GSM8k</strong> and <em>FRI</em> in <strong>Last Letter</strong>, I was able to improve all the metrics for both unstructured and structured outputs using a 0-shot prompt. For 3-shot prompts, I improved <strong>GSM8k</strong> and <strong>Last Letter</strong> across all methods, and <em>NL</em> in <strong>Shuffled Objects</strong>.</p>
<p>For <strong>GSM8k</strong> and <strong>Last Letter</strong>, the results were very similar between unstructured and structured outputs. There was a slight edge for unstructured outputs in <strong>GSM8k</strong> and for structured outputs in <strong>Last Letter</strong>. In these cases, it’s not clear that one approach definitively outperforms the other.</p>
<p>On the other hand, <strong>Shuffled Objects</strong> shows a clear advantage for unstructured outputs over structured outputs. This was unexpected, and even after tweaking the prompts, I couldn’t fully close the gap.</p>
<p>Despite the issues in Tam et al.’s study, their conclusion appears to hold. In this particular scenario, using a fairly popular model with reasonable prompts, there is a significant difference in performance between structured and unstructured outputs.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>In <strong>GSM8k</strong> and <strong>Last Letter</strong>, few-shot prompting generally decreased performance. This is in line with <a href="https://python.useinstructor.com/blog/2024/09/26/bad-schemas-could-break-your-llm-structured-outputs/?h=bad+sc#modes-and-models">other analyses</a>.</p>
</div>
</div>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>You’re here because you want to know whether to use structured or unstructured outputs. As a developer, I’m glad to say the answer is: <a href="https://www.reddit.com/r/orlybooks/comments/50meb5/it_depends/">it depends</a>.</p>
<p>I love using structured outputs in my daily work, because it makes it much easier to work with the output of LLMs. I always encourage <a href="https://iwanalabs.com/">clients</a> who aren’t using them yet to give them a try.</p>
<p>That said, until there’s stronger evidence showing that both approaches are equivalent, the best course of action is to test things for yourself. Run your own <a href="https://hamel.dev/blog/posts/evals/">evals</a> and make a decision based on data.</p>
<p>I expect that in most cases, structured outputs will have similar performance to unstructured outputs. But, if you blindly assume that structured outputs are always equal to or better than unstructured ones, you might be missing out on easy performance gains.</p>
<p>Take the example of <strong>Shuffled Objects</strong> with <em>GPT-4o-mini</em>. You could potentially reduce the gap between the two methods by continuing improving the prompts or by switching to a more powerful model. But the costs, in terms of time and effort, might be more than simply switching to unstructured outputs.</p>
<p>And this cuts both ways. Unstructured outputs aren’t inherently better or worse than structured ones. Again, the right choice depends on your task, the model, and your prompt engineering skills. Test both approaches, identify if there are differences, and choose what works best.</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Although, they’ve also <a href="https://blog.dottxt.co/performance-gsm8k.html">shared results</a> of other open-weight models using a different setup.↩︎</p></li>
</ol>
</section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2024,
  author = {Castillo, Dylan},
  title = {Structured Outputs Can Hurt the Performance of {LLMs}},
  date = {2024-12-08},
  url = {https://dylancastillo.co/posts/say-what-you-mean-sometimes.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2024" class="csl-entry quarto-appendix-citeas">
Castillo, Dylan. 2024. <span>“Structured Outputs Can Hurt the
Performance of LLMs.”</span> December 8, 2024. <a href="https://dylancastillo.co/posts/say-what-you-mean-sometimes.html">https://dylancastillo.co/posts/say-what-you-mean-sometimes.html</a>.
</div></div></section></div> ]]></description>
  <category>llm</category>
  <category>openai</category>
  <category>pydantic</category>
  <category>python</category>
  <guid>https://dylancastillo.co/posts/say-what-you-mean-sometimes.html</guid>
  <pubDate>Sun, 08 Dec 2024 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Transform any image to WebP from the terminal</title>
  <dc:creator>Dylan Castillo</dc:creator>
  <link>https://dylancastillo.co/til/transforming-images-to-webp.html</link>
  <description><![CDATA[ 




<p>I was annoyed by the file size of my photo in the <a href="https://dylanjcastillo.com/about/">About page</a>, because it was slowing down the page load.</p>
<p>Is it important? No.</p>
<p>Don’t I have better things to do on a Saturday afternoon? Yes.</p>
<p>But it’s like going to bed with the closet door open—you know there’s nothing in there, but you just can’t shake the feeling that the devil (or <a href="https://es.wikipedia.org/wiki/Diosdado_Cabello">Diosdado Cabello</a>) might jump out and kill you in your sleep unless you get up and shut it.</p>
<p>So I got o1-mini to write a simple script for me, and thought others might find it useful.</p>
<p>Here it is:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"> img2webp()</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">{</span></span>
<span id="cb1-2"></span>
<span id="cb1-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check if the input file is provided or if help is requested</span></span>
<span id="cb1-4">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[[</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$#</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">-lt</span> 1 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">||</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$1</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--help"</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">||</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$1</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-h"</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]];</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">then</span></span>
<span id="cb1-5">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Usage: img2webp input_image [quality]"</span></span>
<span id="cb1-6">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"  input_image: Path to the input image file"</span></span>
<span id="cb1-7">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"  quality: Quality of the output WebP image (0-100, default is 80)"</span></span>
<span id="cb1-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-9">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fi</span></span>
<span id="cb1-10"></span>
<span id="cb1-11">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">local</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">input</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$1</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb1-12">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">local</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">quality</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:-</span>80<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Default quality is 80 if not specified</span></span>
<span id="cb1-13">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">local</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">output</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">${input</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>.<span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">*</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">.webp"</span></span>
<span id="cb1-14"></span>
<span id="cb1-15">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert the image to WebP using ffmpeg</span></span>
<span id="cb1-16">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ffmpeg</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-i</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$input</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-qscale:v</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$quality</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$output</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb1-17"></span>
<span id="cb1-18">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check if the conversion was successful</span></span>
<span id="cb1-19">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">[[</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$?</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">-eq</span> 0 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">]];</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">then</span></span>
<span id="cb1-20">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Successfully converted '</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$input</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">' to '</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$output</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">' with quality </span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$quality</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">."</span></span>
<span id="cb1-21">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span></span>
<span id="cb1-22">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Failed to convert '</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$input</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">' to WebP."</span></span>
<span id="cb1-23">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-24">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">fi</span></span>
<span id="cb1-25"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">}</span></span></code></pre></div></div>
<p>If you’re using MacOS, you first need to install <code>ffmpeg</code> using Homebrew:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">brew</span> install ffmpeg</span></code></pre></div></div>
<p>Then you can add it to your <code>.zshrc</code> and use it by running <code>img2webp &lt;path_to_image&gt; [quality]</code>.</p>
<p>Just as reference, keeping the same quality, I decreased my profile picture from 234KB to 36KB by just changing from PNG to WebP.</p>
<p>Hope you found this useful.</p>



<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2024,
  author = {Castillo, Dylan},
  title = {Transform Any Image to {WebP} from the Terminal},
  date = {2024-11-23},
  url = {https://dylancastillo.co/til/transforming-images-to-webp.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2024" class="csl-entry quarto-appendix-citeas">
Castillo, Dylan. 2024. <span>“Transform Any Image to WebP from the
Terminal.”</span> November 23, 2024. <a href="https://dylancastillo.co/til/transforming-images-to-webp.html">https://dylancastillo.co/til/transforming-images-to-webp.html</a>.
</div></div></section></div> ]]></description>
  <category>til</category>
  <category>webp</category>
  <category>bash</category>
  <category>ffmpeg</category>
  <guid>https://dylancastillo.co/til/transforming-images-to-webp.html</guid>
  <pubDate>Sat, 23 Nov 2024 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Structured outputs: don’t put the cart before the horse</title>
  <dc:creator>Dylan Castillo</dc:creator>
  <link>https://dylancastillo.co/posts/llm-pydantic-order-matters.html</link>
  <description><![CDATA[ 




<p>Not long ago, you couldn’t reliably ask an LLM to provide you with a response using a specific format. Building tools that used LLM outputs was painful.</p>
<p>Then, through <a href="https://platform.openai.com/docs/guides/function-calling">function calling</a> and <a href="https://platform.openai.com/docs/guides/structured-outputs">structured outputs</a>, we could instruct LLMs to respond in specific formats<sup>1</sup>. So, extracting information from LLM outputs stopped being a problem.</p>
<p>But then I started noticing that structured outputs also had their <a href="https://arxiv.org/abs/2408.02442">own set</a> <a href="https://arxiv.org/abs/2403.06988">of problems</a>. Most importantly, the apparent rigidity of a Pydantic model can make you forget that underneath, you’re still dealing with an LLM. Setting up a response model for your API calls is not the same as setting up a response model for your LLM outputs.</p>
<p>For example, take the following question from the <a href="https://huggingface.co/datasets/livebench/reasoning">LiveBench</a> dataset:</p>
<blockquote class="blockquote">
<p>Suppose I have a physical, solid, equilateral triangle, and I make two cuts. The two cuts are from two parallel lines, and both cuts pass through the interior of the triangle. How many pieces are there after the cuts? Think step by step, and then put your answer in <strong>bold</strong> as a single integer (for example, <strong>0</strong>). If you don’t know, guess.</p>
</blockquote>
<p>Let’s say I write a simple system prompt and two Pydantic models to format the responses:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1">system_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb1-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You're a helpful assistant. You will help me answer a question."</span></span>
<span id="cb1-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">You will use this JSON schema for your response:"</span></span>
<span id="cb1-4">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{response_format}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb1-5">)</span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> ResponseFormatA(BaseModel):</span>
<span id="cb1-8">    reasoning: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb1-9">    answer: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb1-10"></span>
<span id="cb1-11"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> ResponseFormatB(BaseModel):</span>
<span id="cb1-12">    answer: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb1-13">    reasoning: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span></code></pre></div></div>
<p>Do you think that there will be a difference in performance between <code>ResponseFormatA</code> and <code>ResponseFormatB</code>? If so, which one do you think will perform better?</p>
<p>Not sure? Well, you’re in luck! Let’s run some experiments to find out.</p>
<section id="set-up-the-environment" class="level2">
<h2 class="anchored" data-anchor-id="set-up-the-environment">Set up the environment</h2>
<p>First, start by importing the necessary libraries:</p>
<div id="cell-5" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> asyncio</span>
<span id="cb2-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> json</span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> asyncio <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Semaphore</span>
<span id="cb2-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> datetime <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> datetime</span>
<span id="cb2-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pathlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Path</span>
<span id="cb2-6"></span>
<span id="cb2-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb2-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb2-9"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb2-10"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langsmith <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> traceable</span>
<span id="cb2-11"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langsmith.wrappers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> wrap_openai</span>
<span id="cb2-12"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> AsyncOpenAI</span>
<span id="cb2-13"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pydantic <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> BaseModel</span>
<span id="cb2-14"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> scipy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> stats</span>
<span id="cb2-15"></span>
<span id="cb2-16">np.random.seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb2-17"></span>
<span id="cb2-18">load_dotenv()</span>
<span id="cb2-19"></span>
<span id="cb2-20">client <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> wrap_openai(AsyncOpenAI())</span></code></pre></div></div>
</div>
<p>This will set up all the necessary infrastructure to run the experiments. I like using <a href="https://www.langchain.com/langsmith">LangSmith</a> to track <a href="https://smith.langchain.com/public/11545ceb-70d3-4213-9f05-89891586b809/r?runtab=0">runs</a>.</p>
<p>To run the experiment, you need some data. I ended up using a subset of the <a href="https://huggingface.co/datasets/livebench/reasoning">reasoning questions</a> from LiveBench. You can download it and save it in the <code>data</code> directory.</p>
<p>Then, you can read it into a pandas <code>DataFrame</code>:</p>
<div id="cell-7" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1">data_dir <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Path().absolute().parent <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"live_bench"</span></span>
<span id="cb3-2">reasoning_dir <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data_dir <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"reasoning"</span></span>
<span id="cb3-3">live_bench_json <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> reasoning_dir <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question.jsonl"</span></span>
<span id="cb3-4"></span>
<span id="cb3-5">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb3-6">    pd.read_json(live_bench_json, lines<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb3-7">    .query(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"livebench_release_date == '2024-07-26'"</span>)</span>
<span id="cb3-8">    .assign(</span>
<span id="cb3-9">        turns_str<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x: x.turns.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], </span>
<span id="cb3-10">        expects_integer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x: x.turns.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>.contains(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"integer"</span>, case<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb3-11">    )</span>
<span id="cb3-12">    .reset_index()</span>
<span id="cb3-13">    .rename(columns<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"index"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data_point_id"</span>})</span>
<span id="cb3-14">)</span></code></pre></div></div>
</div>
<p>Next, define the system prompt and the Pydantic models you’ll use to format the responses:</p>
<div id="cell-9" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1">system_prompt_template <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (</span>
<span id="cb4-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You're a helpful assistant. You will help me answer a question."</span></span>
<span id="cb4-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">You will use this JSON schema for your response:"</span></span>
<span id="cb4-4">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{response_format}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb4-5">)</span>
<span id="cb4-6"></span>
<span id="cb4-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> ResponseFormatA(BaseModel):</span>
<span id="cb4-8">    reasoning: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb4-9">    answer: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> </span>
<span id="cb4-10"></span>
<span id="cb4-11"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> ResponseFormatB(BaseModel):</span>
<span id="cb4-12">    answer: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span> </span>
<span id="cb4-13">    reasoning: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span></code></pre></div></div>
</div>
<p>In the system prompt you send to the LLM, you’ll replace <code>{response_format}</code> with the JSON schema of the response format you want to use.</p>
<p>Then, let’s define a few helper functions to run the experiment:</p>
<div id="cell-11" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> validate_response(response_json, response_format):</span>
<span id="cb5-2">    response_dict <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> json.loads(response_json)</span>
<span id="cb5-3">    expected_keys <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(response_format.model_json_schema()[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"properties"</span>].keys())</span>
<span id="cb5-4">    actual_keys <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(response_dict.keys())</span>
<span id="cb5-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> actual_keys <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> expected_keys:</span>
<span id="cb5-6">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Response keys </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>actual_keys<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> do not match expected keys </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>expected_keys<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb5-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response_format.model_validate_json(response_json)</span>
<span id="cb5-8"></span>
<span id="cb5-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@traceable</span></span>
<span id="cb5-10"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> process_row(</span>
<span id="cb5-11">    row: pd.Series, </span>
<span id="cb5-12">    response_format: ResponseFormatA <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> ResponseFormatB, </span>
<span id="cb5-13">    semaphore: Semaphore</span>
<span id="cb5-14">) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> ResponseFormatA <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> ResponseFormatB:</span>
<span id="cb5-15">    system_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> system_prompt_template.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(</span>
<span id="cb5-16">        response_format<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>response_format.model_json_schema()</span>
<span id="cb5-17">    )</span>
<span id="cb5-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> semaphore:</span>
<span id="cb5-19">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>):</span>
<span id="cb5-20">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb5-21">                response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> client.chat.completions.create(</span>
<span id="cb5-22">                    model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4o"</span>, </span>
<span id="cb5-23">                    messages<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[</span>
<span id="cb5-24">                        {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"system"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: system_prompt},</span>
<span id="cb5-25">                        {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Question:</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>row<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>turns_str<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>}</span>
<span id="cb5-26">                    ],</span>
<span id="cb5-27">                    response_format<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"json_object"</span>}</span>
<span id="cb5-28">                )</span>
<span id="cb5-29">                response_json <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> response.choices[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].message.content</span>
<span id="cb5-30">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> validate_response(response_json, response_format)</span>
<span id="cb5-31">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span>:</span>
<span id="cb5-32">                <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">pass</span></span>
<span id="cb5-33">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">Exception</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Failed to generate a valid response"</span>)</span>
<span id="cb5-34"></span>
<span id="cb5-35"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@traceable</span></span>
<span id="cb5-36"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> main(df, response_format, concurrency: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>):</span>
<span id="cb5-37">    semaphore <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Semaphore(concurrency)</span>
<span id="cb5-38">    tasks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [process_row(row, response_format, semaphore) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _, row <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> df.iterrows()]</span>
<span id="cb5-39">    responses <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">await</span> asyncio.gather(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tasks)</span>
<span id="cb5-40"></span>
<span id="cb5-41">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> responses</span>
<span id="cb5-42"></span>
<span id="cb5-43"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> extract_answer(answer):</span>
<span id="cb5-44">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(answer).replace(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"**"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>).strip()</span></code></pre></div></div>
</div>
<p>In this code, <code>validate_response</code> is used to check if the response is valid (i.e.&nbsp;it matches the JSON schema in the same order). If it is, it returns the response. Otherwise, it raises an exception.</p>
<p><code>extract_answer</code> is used to remove ** from the answer if it exists in the response. Some of the questions in the LiveBench dataset included instructions to put the answer in bold, which is why we need to remove it.</p>
<p><code>process_row</code> is used to process a single row of the DataFrame. It sends the system prompt to the LLM and validates the response. It includes a simple retry mechanism in case the validation fails. Each run is tracked in LangSmith.</p>
<p>Finally, <code>main</code> is used to run the experiment. It runs the <code>process_row</code> function concurrently for each row in the DataFrame.</p>
</section>
<section id="running-the-experiment" class="level2">
<h2 class="anchored" data-anchor-id="running-the-experiment">Running the experiment</h2>
<p>Now, you can run the experiment using the two response formats:</p>
<div id="cell-14" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1">n_runs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb6-2">df_runs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb6-3"></span>
<span id="cb6-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> run <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n_runs):</span>
<span id="cb6-5">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Run </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>run <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">/</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>n_runs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb6-6">    df_copy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.copy()</span>
<span id="cb6-7">    </span>
<span id="cb6-8">    responses_A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> asyncio.run(main(df_copy, ResponseFormatA))</span>
<span id="cb6-9">    df_copy[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"raw_answer_A"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [r.answer <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> r <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> responses_A]</span>
<span id="cb6-10">    df_copy[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"response_A"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df_copy[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"raw_answer_A"</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>(extract_answer)</span>
<span id="cb6-11">    df_copy[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"is_correct_A"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (df_copy[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"response_A"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> df_copy[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ground_truth"</span>]).astype(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>)</span>
<span id="cb6-12">    </span>
<span id="cb6-13">    responses_B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> asyncio.run(main(df_copy, ResponseFormatB))</span>
<span id="cb6-14">    df_copy[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"raw_answer_B"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [r.answer <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> r <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> responses_B]</span>
<span id="cb6-15">    df_copy[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"response_B"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df_copy[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"raw_answer_B"</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>(extract_answer)</span>
<span id="cb6-16">    df_copy[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"is_correct_B"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (df_copy[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"response_B"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> df_copy[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ground_truth"</span>]).astype(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>)</span>
<span id="cb6-17">    </span>
<span id="cb6-18">    df_copy[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"run"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> run</span>
<span id="cb6-19">    df_run <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df_copy[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data_point_id"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ground_truth"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"is_correct_A"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"is_correct_B"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"run"</span>]]</span>
<span id="cb6-20">    </span>
<span id="cb6-21">    df_runs.append(df_run)</span></code></pre></div></div>
</div>
<p>We run the experiment multiple times with the same inputs to account for the randomness in the LLM’s responses. Ideally, we should run it more than three times, but I’m poor. So, we’ll just do it 3 times.</p>
<div id="cell-16" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1">df_all_runs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.concat(df_runs, ignore_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb7-2"></span>
<span id="cb7-3">n_bootstraps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span></span>
<span id="cb7-4">bootstrap_accuracies_A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb7-5">bootstrap_accuracies_B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb7-6"></span>
<span id="cb7-7">data_point_ids <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df_all_runs[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'data_point_id'</span>].unique()</span>
<span id="cb7-8">n_data_points <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(data_point_ids)</span>
<span id="cb7-9"></span>
<span id="cb7-10">grouped_A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df_all_runs.groupby(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'data_point_id'</span>)[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_correct_A'</span>]</span>
<span id="cb7-11">grouped_B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df_all_runs.groupby(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'data_point_id'</span>)[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_correct_B'</span>]</span>
<span id="cb7-12"></span>
<span id="cb7-13">df_correct_counts_A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> grouped_A.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()</span>
<span id="cb7-14">df_total_counts_A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> grouped_A.count()</span>
<span id="cb7-15">df_correct_counts_B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> grouped_B.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()</span>
<span id="cb7-16">df_total_counts_B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> grouped_B.count()</span>
<span id="cb7-17"></span>
<span id="cb7-18"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n_bootstraps):</span>
<span id="cb7-19">    sampled_ids <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.choice(data_point_ids, size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n_data_points, replace<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb7-20">    sampled_counts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.Series(sampled_ids).value_counts()</span>
<span id="cb7-21">    counts_index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sampled_counts.index</span>
<span id="cb7-22">    </span>
<span id="cb7-23">    total_correct_counts_A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (df_correct_counts_A.loc[counts_index] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> sampled_counts).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()</span>
<span id="cb7-24">    total_observations_A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (df_total_counts_A.loc[counts_index] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> sampled_counts).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()</span>
<span id="cb7-25">    mean_accuracy_A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> total_correct_counts_A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> total_observations_A</span>
<span id="cb7-26">    bootstrap_accuracies_A.append(mean_accuracy_A)</span>
<span id="cb7-27">    </span>
<span id="cb7-28">    total_correct_counts_B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (df_correct_counts_B.loc[counts_index] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> sampled_counts).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()</span>
<span id="cb7-29">    total_observations_B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (df_total_counts_B.loc[counts_index] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> sampled_counts).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()</span>
<span id="cb7-30">    mean_accuracy_B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> total_correct_counts_B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> total_observations_B</span>
<span id="cb7-31">    bootstrap_accuracies_B.append(mean_accuracy_B)</span>
<span id="cb7-32"></span>
<span id="cb7-33">ci_A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.percentile(bootstrap_accuracies_A, [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">97.5</span>])</span>
<span id="cb7-34">ci_B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.percentile(bootstrap_accuracies_B, [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">97.5</span>])</span>
<span id="cb7-35"></span>
<span id="cb7-36">mean_accuracy_A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df_all_runs[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_correct_A'</span>].mean()</span>
<span id="cb7-37">mean_accuracy_B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df_all_runs[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_correct_B'</span>].mean()</span>
<span id="cb7-38"></span>
<span id="cb7-39"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(</span>
<span id="cb7-40">    <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Response format A - Mean: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>mean_accuracy_A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">% CI: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ci_A[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">% - </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ci_A[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">%"</span></span>
<span id="cb7-41">)</span>
<span id="cb7-42"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(</span>
<span id="cb7-43">    <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Response format B - Mean: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>mean_accuracy_B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">% CI: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ci_B[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">% - </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ci_B[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">%"</span></span>
<span id="cb7-44">)</span></code></pre></div></div>
</div>
<p>Then, you can build bootstrap confidence intervals for the accuracies of the two response formats. Given that I’m asking the LLM the same question multiple times, I went with an approach called <a href="https://pmc.ncbi.nlm.nih.gov/articles/PMC5965657/">cluster bootstrapping</a>, which accounts for the fact that the data points are not independent.</p>
<p>It should take a few seconds to run. Once it’s done, you should see output like the following:</p>
<table class="table">
<thead>
<tr class="header">
<th>Response Format</th>
<th>Accuracy (95% CI)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>A</td>
<td>46.67% (35.33% – 58.00%)</td>
</tr>
<tr class="even">
<td>B</td>
<td>33.33% (22.67% – 44.67%)</td>
</tr>
</tbody>
</table>
<p>These results suggest that the order of the fields in the JSON schema does matter.</p>
<p>But if you’re still unsure, you can perform a t-test to see if the two response formats are statistically different:</p>
<div id="cell-18" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1">accuracies_A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df_all_runs.pivot(index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'data_point_id'</span>, columns<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'run'</span>, values<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_correct_A'</span>)</span>
<span id="cb8-2">accuracies_B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df_all_runs.pivot(index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'data_point_id'</span>, columns<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'run'</span>, values<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_correct_B'</span>)</span>
<span id="cb8-3"></span>
<span id="cb8-4">mean_accuracies_A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> accuracies_A.mean(axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb8-5">mean_accuracies_B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> accuracies_B.mean(axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb8-6"></span>
<span id="cb8-7">t_stat, p_value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stats.ttest_rel(mean_accuracies_A, mean_accuracies_B, alternative<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'greater'</span>)</span>
<span id="cb8-8"></span>
<span id="cb8-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"t-statistic: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>t_stat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, p-value: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>p_value<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
</div>
<p>I got a p-value &lt;0.01, meaning I can reject the null hypothesis that the two response formats are the same.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Based on the results of the experiment, we can safely say that <code>ResponseFormatA</code> is better than <code>ResponseFormatB</code>.</p>
<p>But why?</p>
<p>In this case, it’s simple.</p>
<p>These response formats are meant to help the LLM reason step by step to arrive at the answer. This is known as <a href="https://en.wikipedia.org/wiki/Chain_of_thought_reasoning">chain of thought reasoning</a>. However, for it to work, we need the LLM to first provide us with the reasoning of how it arrived at the answer and then the answer.</p>
<p>In <code>ResponseFormatA</code>, we defined our Pydantic model with the reasoning first and the answer second. This means that the LLM will give us the reasoning first, and then provide the answer. Which is exactly what we want.</p>
<p><code>ResponseFormatB</code> works in the opposite way. This means that the LLM will give us the answer first, and then provide the reasoning. So our chain of thought reasoning becomes a <a href="https://www.promptingguide.ai/techniques/zeroshot">zero-shot prompt</a>. In this case, the reasoning is a byproduct of the answer.</p>
<p>So, to summarize, when using structured outputs, don’t put the cart before the horse.</p>
<p>That’s all! Let me know if you have any questions in the comments.</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>I’m referring to OpenAI models here. Open weight models allowed this using <a href="https://github.com/ggerganov/llama.cpp/blob/master/grammars/README.md">grammars</a>.↩︎</p></li>
</ol>
</section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2024,
  author = {Castillo, Dylan},
  title = {Structured Outputs: Don’t Put the Cart Before the Horse},
  date = {2024-11-09},
  url = {https://dylancastillo.co/posts/llm-pydantic-order-matters.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2024" class="csl-entry quarto-appendix-citeas">
Castillo, Dylan. 2024. <span>“Structured Outputs: Don’t Put the Cart
Before the Horse.”</span> November 9, 2024. <a href="https://dylancastillo.co/posts/llm-pydantic-order-matters.html">https://dylancastillo.co/posts/llm-pydantic-order-matters.html</a>.
</div></div></section></div> ]]></description>
  <category>llm</category>
  <category>openai</category>
  <category>pydantic</category>
  <category>python</category>
  <guid>https://dylancastillo.co/posts/llm-pydantic-order-matters.html</guid>
  <pubDate>Sat, 09 Nov 2024 00:00:00 GMT</pubDate>
</item>
</channel>
</rss>
