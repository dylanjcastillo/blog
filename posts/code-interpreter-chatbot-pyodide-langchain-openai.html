<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Dylan Castillo">
<meta name="dcterms.date" content="2023-05-12">
<meta name="description" content="Learn how to build your own code interpreter chatbot using Pyodide, LangChain, and OpenAI.">

<title>Create a Code Interpreter Chatbot with Pyodide, LangChain, and OpenAI – Dylan Castillo</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../logo.webp" rel="icon">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="dark">
<script src="../site_libs/quarto-contrib/iconify-2.1.0/iconify-icon.min.js"></script>
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;0,900;1,300;1,400;1,700;1,900&amp;display=swap" rel="stylesheet">
<script src="https://cdn.usefathom.com/script.js" data-site="ZJFQREIA" defer=""></script>


<meta property="og:title" content="Create a Code Interpreter Chatbot with Pyodide, LangChain, and OpenAI – Dylan Castillo">
<meta property="og:description" content="">
<meta property="og:site_name" content="Dylan Castillo">
<meta name="twitter:title" content="Create a Code Interpreter Chatbot with Pyodide, LangChain, and OpenAI – Dylan Castillo">
<meta name="twitter:description" content="">
<meta name="twitter:site" content="@dylanjcastillo">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../projects.html"> 
<span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/dylanjcastillo"> 
<span class="menu-text"><iconify-icon role="img" inline="" icon="fa6-brands:github" aria-label="Icon github from fa6-brands Iconify.design set." title="Icon github from fa6-brands Iconify.design set."></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.linkedin.com/in/dylanjcastillo/"> 
<span class="menu-text"><iconify-icon role="img" inline="" icon="fa6-brands:linkedin" aria-label="Icon linkedin from fa6-brands Iconify.design set." title="Icon linkedin from fa6-brands Iconify.design set."></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://bsky.app/profile/dylancastillo.co"> 
<span class="menu-text"><iconify-icon role="img" inline="" icon="fa6-brands:bluesky" aria-label="Icon bluesky from fa6-brands Iconify.design set." title="Icon bluesky from fa6-brands Iconify.design set."></iconify-icon></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#prerequisites" id="toc-prerequisites" class="nav-link active" data-scroll-target="#prerequisites">Prerequisites</a></li>
  <li><a href="#building-a-code-interpreter-chatbot" id="toc-building-a-code-interpreter-chatbot" class="nav-link" data-scroll-target="#building-a-code-interpreter-chatbot">Building a Code Interpreter Chatbot</a></li>
  <li><a href="#set-up-your-local-environment" id="toc-set-up-your-local-environment" class="nav-link" data-scroll-target="#set-up-your-local-environment">Set Up Your Local Environment</a></li>
  <li><a href="#run-code-on-the-browser-with-pyodide" id="toc-run-code-on-the-browser-with-pyodide" class="nav-link" data-scroll-target="#run-code-on-the-browser-with-pyodide">Run Code on the Browser with Pyodide</a></li>
  <li><a href="#create-the-chatbot" id="toc-create-the-chatbot" class="nav-link" data-scroll-target="#create-the-chatbot">Create the Chatbot</a></li>
  <li><a href="#next-steps" id="toc-next-steps" class="nav-link" data-scroll-target="#next-steps">Next steps</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Create a Code Interpreter Chatbot with Pyodide, LangChain, and OpenAI</h1>
  <div class="quarto-categories">
    <div class="quarto-category">python</div>
    <div class="quarto-category">llm</div>
    <div class="quarto-category">openai</div>
  </div>
  </div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author"><a href="https://dylancastillo.co">Dylan Castillo</a> </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            <a href="https://iwanalabs.com">
            Iwana Labs
            </a>
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">May 12, 2023</p>
    </div>
  </div>
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">November 23, 2024</p>
    </div>
  </div>
    
  </div>
  


</header>


<p>OpenAI has been giving access to users to the <a href="https://wgmimedia.com/chatgpt-code-interpreter-plugin/">Code Interpreter</a> plugin and people are loving it. I wanted to replicate it outside of ChatGPT, so I created my own (simpler) version, specifically to <a href="https://deepsheet.dylancastillo.co/">analyze and visualize data</a>.</p>
<p>Following that, I figured more people might be interested in building user-facing chatbots capable of running code in the browser. So I put together this tutorial. It will teach you how to create a simple but powerful chatbot that uses Pyodide, LangChain, and OpenAI to generate and run code in the browser for a user.</p>
<p>C’mon, let’s get to work!</p>
<section id="prerequisites" class="level2">
<h2 class="anchored" data-anchor-id="prerequisites">Prerequisites</h2>
<p>To make the most of the tutorial, you should review these topics before getting started:</p>
<ol type="1">
<li>What <a href="https://pyodide.org/en/stable/">Pyodide</a> is.</li>
<li>What <a href="https://python.langchain.com/en/latest/index.html">LangChain</a> is.</li>
<li>The basics of Python backend servers such as <a href="https://docs.litestar.dev/2/">Litestar</a> or <a href="fastapi.tiangolo.com/">FastAPI</a>.</li>
</ol>
<p>In addition, you must create an account at <a href="https://beta.openai.com">OpenAI</a>.</p>
</section>
<section id="building-a-code-interpreter-chatbot" class="level2">
<h2 class="anchored" data-anchor-id="building-a-code-interpreter-chatbot">Building a Code Interpreter Chatbot</h2>
<p>Security and scalability are two major challenges in developing a user-facing chatbot that’s capable of executing code. Companies like <a href="https://replit.com/">Replit</a> must manage <a href="https://cloud.google.com/customers/repl-it">extremely complex infrastructures</a> in order to provide users with online IDEs.</p>
<p>We’re fortunate, however, because what we’re doing in this tutorial isn’t as complex as Replit. We can use a simple solution: Pyodide. Pyodide is a CPython port to WebAssembly/Emscripten that lets Python to run in the browser.</p>
<p>There are some restrictions to what you can do with Pyodide, such as the fact that <a href="https://pyodide.org/en/stable/usage/wasm-constraints.html">not every package is compatible</a> with it and that the maximum memory it can manage is 2GB. But it is more than adequate to process small to medium datasets, which is what you’ll do in this tutorial.</p>
<p>The chatbot you’ll build will work as follows:</p>
<ol type="1">
<li>A user asks a question about a preloaded dataset.</li>
<li>That question, along with a predefined prompt, is sent to the OpenAI API.</li>
<li>The API responds with a code snippet that helps answer the question.</li>
<li>The code snippet is executed on the browser using Pyodide, and the result is displayed to the user.</li>
</ol>
<p>Next, you’ll set up your local environment.</p>
</section>
<section id="set-up-your-local-environment" class="level2">
<h2 class="anchored" data-anchor-id="set-up-your-local-environment">Set Up Your Local Environment</h2>
<p>Before you begin, you must first set up a few things. Follow these steps:</p>
<ol type="1">
<li>Install <a href="https://www.python.org/downloads/">Python 3.10</a>.</li>
<li>Install <a href="https://python-poetry.org/docs/#installation">Poetry</a>. It’s optional but highly recommended.</li>
<li>Clone the project’s repository:</li>
</ol>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">git</span> clone https://github.com/dylanjcastillo/chatbot-code-interpreter</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="4" type="1">
<li><p>From the root folder of the project, install the dependencies:</p>
<ul>
<li>Using <strong>Poetry:</strong> Create the virtual environment in the same directory as the project and install the dependencies:</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1"></a><span class="ex">poetry</span> config virtualenvs.in-project true</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="ex">poetry</span> install</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Using <strong>venv and pip:</strong> Create a virtual environment and install the dependencies listed in <code>requirements.txt</code>:</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1"></a><span class="ex">python3.10</span> <span class="at">-m</span> venv .venv <span class="kw">&amp;&amp;</span> <span class="bu">source</span> .venv/bin/activate</span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="ex">pip</span> install <span class="at">-r</span> requirements.txt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Open <code>src/.env-example</code>, add your OpenAI secret key in the corresponding variable, and save the file as <code>.env</code>.</p></li>
</ol>
<p>You should now have a virtual environment set up with the necessary libraries and a local copy of the repository. Your project structure should look like this:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1"></a><span class="ex">chatbot-code-interpreter</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="ex">├──</span> LICENSE</span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="ex">├──</span> README.md</span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="ex">├──</span> poetry.lock</span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="ex">├──</span> pyproject.toml</span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="ex">├──</span> requirements.txt</span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="ex">├──</span> src</span>
<span id="cb4-8"><a href="#cb4-8"></a><span class="ex">│</span>   ├── app.py</span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="ex">│</span>   ├── config.py</span>
<span id="cb4-10"><a href="#cb4-10"></a><span class="ex">│</span>   ├── prompts</span>
<span id="cb4-11"><a href="#cb4-11"></a><span class="ex">│</span>   │   ├── system.prompt</span>
<span id="cb4-12"><a href="#cb4-12"></a><span class="ex">│</span>   │   └── user.prompt</span>
<span id="cb4-13"><a href="#cb4-13"></a><span class="ex">│</span>   ├── static</span>
<span id="cb4-14"><a href="#cb4-14"></a><span class="ex">│</span>   │   └── all_stocks.csv</span>
<span id="cb4-15"><a href="#cb4-15"></a><span class="ex">│</span>   ├── templates</span>
<span id="cb4-16"><a href="#cb4-16"></a><span class="ex">│</span>   │   └── index.html</span>
<span id="cb4-17"><a href="#cb4-17"></a><span class="ex">│</span>   ├── utils.py</span>
<span id="cb4-18"><a href="#cb4-18"></a><span class="ex">│</span>   └── .env-example</span>
<span id="cb4-19"><a href="#cb4-19"></a><span class="ex">└──</span> .venv/</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These are the most relevant files and directories in the project:</p>
<ul>
<li><code>poetry.lock</code> and <code>pyproject.toml</code>: These files contain the project’s specifications and dependencies. They’re used by Poetry to create a virtual environment.</li>
<li><code>requirements.txt</code>: This file contains a list of Python packages required by the project.</li>
<li><code>src/app.py</code>: This file contains the code of the chatbot.</li>
<li><code>src/config.py</code>: This file contains project configuration details such as OpenAI’s API key (read from a <code>.env</code> file), and the path to the prompts used by the chatbot.</li>
<li><code>src/prompts/</code>: This directory contains the system and user prompts used by the chatbot. I’ve found that keeping the prompts in text files makes it easier to manage them instead of using strings.</li>
<li><code>src/static</code> and <code>src/templates</code>: These files contain the data used in the example and the HTML template used for the chatbot’s interface. You’ll use a dataset with prices and the volume of a group of stocks.</li>
<li><code>src/utils.py</code>: This file contains a function you use to read the prompts from <code>src/prompts</code>.</li>
<li><code>.env-example</code>: This file is a sample file that provides the required environment variables you should provide. In this case, you use it to pass OpenAI’s API key to your application and choose the name the chatbot should use behind the scenes (<code>gpt-3.5.-turbo</code>).</li>
<li><code>.venv/</code>: This directory contains the project’s virtual environment.</li>
</ul>
<p>Alright! On to the exciting stuff now.</p>
</section>
<section id="run-code-on-the-browser-with-pyodide" class="level2">
<h2 class="anchored" data-anchor-id="run-code-on-the-browser-with-pyodide">Run Code on the Browser with Pyodide</h2>
<p>In this step, you’ll configure Pyodide to run Python in the browser. You’ll load <code>pyodide.js</code>, start it, import the required libraries, and define an event handler to process the questions asked by the user.</p>
<p>To make the analysis simpler, I’ll split the code of <code>src/templates/index.html</code> into two sections. In the first section, you’ll only look at the contents of <code>&lt;head&gt;</code> and <code>&lt;body&gt;</code>, and in the second part, you’ll go through the JavaScript code defined in <code>&lt;script&gt;</code>.</p>
<p>Here’s part one:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode numberSource html number-lines code-with-copy"><code class="sourceCode html"><span id="cb5-1"><a href="#cb5-1"></a><span class="dt">&lt;!DOCTYPE</span> html<span class="dt">&gt;</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="dt">&lt;</span><span class="kw">html</span><span class="ot"> lang</span><span class="op">=</span><span class="st">"en"</span><span class="dt">&gt;</span></span>
<span id="cb5-3"><a href="#cb5-3"></a>  <span class="dt">&lt;</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb5-4"><a href="#cb5-4"></a>    <span class="dt">&lt;</span><span class="kw">meta</span><span class="ot"> charset</span><span class="op">=</span><span class="st">"UTF-8"</span><span class="ot"> </span><span class="dt">/&gt;</span></span>
<span id="cb5-5"><a href="#cb5-5"></a>    <span class="dt">&lt;</span><span class="kw">meta</span><span class="ot"> http-equiv</span><span class="op">=</span><span class="st">"X-UA-Compatible"</span><span class="ot"> content</span><span class="op">=</span><span class="st">"IE=edge"</span><span class="ot"> </span><span class="dt">/&gt;</span></span>
<span id="cb5-6"><a href="#cb5-6"></a>    <span class="dt">&lt;</span><span class="kw">meta</span><span class="ot"> name</span><span class="op">=</span><span class="st">"viewport"</span><span class="ot"> content</span><span class="op">=</span><span class="st">"width=device-width, initial-scale=1.0"</span><span class="ot"> </span><span class="dt">/&gt;</span></span>
<span id="cb5-7"><a href="#cb5-7"></a>    <span class="dt">&lt;</span><span class="kw">title</span><span class="dt">&gt;</span>Code Runner Chatbot<span class="dt">&lt;/</span><span class="kw">title</span><span class="dt">&gt;</span></span>
<span id="cb5-8"><a href="#cb5-8"></a>    <span class="dt">&lt;</span><span class="kw">link</span></span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="ot">      rel</span><span class="op">=</span><span class="st">"stylesheet"</span></span>
<span id="cb5-10"><a href="#cb5-10"></a><span class="ot">      href</span><span class="op">=</span><span class="st">"https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css"</span></span>
<span id="cb5-11"><a href="#cb5-11"></a><span class="ot">    </span><span class="dt">/&gt;</span></span>
<span id="cb5-12"><a href="#cb5-12"></a>    <span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> src</span><span class="op">=</span><span class="st">"https://cdn.jsdelivr.net/pyodide/v0.23.2/full/pyodide.js"</span><span class="dt">&gt;&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb5-13"><a href="#cb5-13"></a>  <span class="dt">&lt;/</span><span class="kw">head</span><span class="dt">&gt;</span></span>
<span id="cb5-14"><a href="#cb5-14"></a></span>
<span id="cb5-15"><a href="#cb5-15"></a>  <span class="dt">&lt;</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb5-16"><a href="#cb5-16"></a>    <span class="dt">&lt;</span><span class="kw">main</span><span class="ot"> class</span><span class="op">=</span><span class="st">"container"</span><span class="dt">&gt;</span></span>
<span id="cb5-17"><a href="#cb5-17"></a>      <span class="dt">&lt;</span><span class="kw">h1</span><span class="ot"> style</span><span class="op">=</span><span class="st">"text-align:center;"</span><span class="dt">&gt;</span>Code Runner Chatbot<span class="dt">&lt;/</span><span class="kw">h1</span><span class="dt">&gt;</span></span>
<span id="cb5-18"><a href="#cb5-18"></a>      <span class="dt">&lt;</span><span class="kw">textarea</span></span>
<span id="cb5-19"><a href="#cb5-19"></a><span class="ot">        name</span><span class="op">=</span><span class="st">"query"</span></span>
<span id="cb5-20"><a href="#cb5-20"></a><span class="ot">        id</span><span class="op">=</span><span class="st">"query"</span></span>
<span id="cb5-21"><a href="#cb5-21"></a><span class="ot">        cols</span><span class="op">=</span><span class="st">"30"</span></span>
<span id="cb5-22"><a href="#cb5-22"></a><span class="ot">        rows</span><span class="op">=</span><span class="st">"10"</span></span>
<span id="cb5-23"><a href="#cb5-23"></a><span class="ot">        placeholder</span><span class="op">=</span><span class="st">"Ask a question about the dataset"</span></span>
<span id="cb5-24"><a href="#cb5-24"></a><span class="ot">      </span><span class="dt">&gt;&lt;/</span><span class="kw">textarea</span><span class="dt">&gt;</span></span>
<span id="cb5-25"><a href="#cb5-25"></a>      <span class="dt">&lt;</span><span class="kw">button</span><span class="ot"> id</span><span class="op">=</span><span class="st">"ask-btn"</span><span class="dt">&gt;</span>Ask<span class="dt">&lt;/</span><span class="kw">button</span><span class="dt">&gt;</span></span>
<span id="cb5-26"><a href="#cb5-26"></a>      <span class="dt">&lt;</span><span class="kw">blockquote</span><span class="ot"> id</span><span class="op">=</span><span class="st">"output"</span><span class="dt">&gt;&lt;/</span><span class="kw">blockquote</span><span class="dt">&gt;</span></span>
<span id="cb5-27"><a href="#cb5-27"></a>    <span class="dt">&lt;/</span><span class="kw">main</span><span class="dt">&gt;</span></span>
<span id="cb5-28"><a href="#cb5-28"></a>    <span class="dt">&lt;</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb5-29"><a href="#cb5-29"></a>      <span class="op">&lt;!--</span> SECOND PART OF CODE <span class="op">--&gt;</span></span>
<span id="cb5-30"><a href="#cb5-30"></a>    <span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb5-31"><a href="#cb5-31"></a>  <span class="dt">&lt;/</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb5-32"><a href="#cb5-32"></a><span class="dt">&lt;/</span><span class="kw">html</span><span class="dt">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This section of code loads the necessary libraries and styles, as well as defines the chatbot’s user interface. Here’s how it works:</p>
<ul>
<li><strong>Lines 5 to 10</strong> set a title for the page, load <code>pyodide.js</code> and <code>pico.css</code> (a minimal CSS framework), and define a couple of standard <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/meta">meta tags</a>.</li>
<li><strong>Lines 14 to 20</strong> define a simple UI that lets users input a question, and submit them by clicking on a button, to get answers about the dataset.</li>
</ul>
<p>Then, let’s go through the JavaScript code defined in <code>&lt;script&gt;</code>. This code will load Pyodide, install the required libraries, make the data available for use in Pyodide, and set an event handler to process the user’s question.</p>
<p>Here’s how it looks:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode numberSource javascript number-lines code-with-copy"><code class="sourceCode javascript"><span id="cb6-1"><a href="#cb6-1"></a><span class="kw">const</span> queryTextArea <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">"query"</span>)<span class="op">;</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="kw">const</span> outputElement <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">"output"</span>)<span class="op">;</span></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="kw">const</span> askBtn <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">"ask-btn"</span>)<span class="op">;</span></span>
<span id="cb6-4"><a href="#cb6-4"></a></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">setupPyodide</span>() {</span>
<span id="cb6-6"><a href="#cb6-6"></a>  <span class="kw">let</span> pyodide <span class="op">=</span> <span class="cf">await</span> <span class="fu">loadPyodide</span>()<span class="op">;</span></span>
<span id="cb6-7"><a href="#cb6-7"></a></span>
<span id="cb6-8"><a href="#cb6-8"></a>  <span class="cf">await</span> pyodide<span class="op">.</span><span class="fu">loadPackage</span>([<span class="st">"pandas"</span><span class="op">,</span> <span class="st">"numpy"</span>])<span class="op">;</span></span>
<span id="cb6-9"><a href="#cb6-9"></a></span>
<span id="cb6-10"><a href="#cb6-10"></a>  <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">"/static/all_stocks.csv"</span>)<span class="op">;</span></span>
<span id="cb6-11"><a href="#cb6-11"></a>  <span class="kw">const</span> fileContentArrayBuffer <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">arrayBuffer</span>()<span class="op">;</span></span>
<span id="cb6-12"><a href="#cb6-12"></a>  <span class="kw">const</span> fileContent <span class="op">=</span> <span class="kw">new</span> <span class="bu">Uint8Array</span>(fileContentArrayBuffer)<span class="op">;</span></span>
<span id="cb6-13"><a href="#cb6-13"></a>  pyodide<span class="op">.</span><span class="at">FS</span><span class="op">.</span><span class="fu">writeFile</span>(<span class="st">"all_stocks.csv"</span><span class="op">,</span> fileContent)<span class="op">;</span></span>
<span id="cb6-14"><a href="#cb6-14"></a></span>
<span id="cb6-15"><a href="#cb6-15"></a>  <span class="cf">return</span> pyodide<span class="op">;</span></span>
<span id="cb6-16"><a href="#cb6-16"></a>}</span>
<span id="cb6-17"><a href="#cb6-17"></a></span>
<span id="cb6-18"><a href="#cb6-18"></a><span class="kw">let</span> pyodideReadyPromise <span class="op">=</span> <span class="fu">setupPyodide</span>()<span class="op">;</span></span>
<span id="cb6-19"><a href="#cb6-19"></a></span>
<span id="cb6-20"><a href="#cb6-20"></a>askBtn<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">"click"</span><span class="op">,</span> <span class="kw">async</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb6-21"><a href="#cb6-21"></a>  <span class="kw">let</span> pyodide <span class="op">=</span> <span class="cf">await</span> pyodideReadyPromise<span class="op">;</span></span>
<span id="cb6-22"><a href="#cb6-22"></a></span>
<span id="cb6-23"><a href="#cb6-23"></a>  <span class="kw">const</span> query <span class="op">=</span> queryTextArea<span class="op">.</span><span class="at">value</span><span class="op">;</span></span>
<span id="cb6-24"><a href="#cb6-24"></a>  <span class="kw">const</span> df_info <span class="op">=</span> <span class="cf">await</span> pyodide<span class="op">.</span><span class="fu">runPythonAsync</span>(<span class="vs">`</span></span>
<span id="cb6-25"><a href="#cb6-25"></a><span class="vs">    import pandas as pd</span></span>
<span id="cb6-26"><a href="#cb6-26"></a><span class="vs">    df = pd.read_csv('all_stocks.csv')</span></span>
<span id="cb6-27"><a href="#cb6-27"></a><span class="vs">    pd.set_option('display.max_columns', None)</span></span>
<span id="cb6-28"><a href="#cb6-28"></a><span class="vs">    df.head(3).T</span></span>
<span id="cb6-29"><a href="#cb6-29"></a><span class="vs">    `</span>)<span class="op">;</span></span>
<span id="cb6-30"><a href="#cb6-30"></a></span>
<span id="cb6-31"><a href="#cb6-31"></a>  <span class="kw">const</span> data <span class="op">=</span> <span class="kw">new</span> <span class="bu">FormData</span>()<span class="op">;</span></span>
<span id="cb6-32"><a href="#cb6-32"></a>  data<span class="op">.</span><span class="fu">append</span>(<span class="st">"query"</span><span class="op">,</span> query)<span class="op">;</span></span>
<span id="cb6-33"><a href="#cb6-33"></a>  data<span class="op">.</span><span class="fu">append</span>(<span class="st">"df_info"</span><span class="op">,</span> df_info)<span class="op">;</span></span>
<span id="cb6-34"><a href="#cb6-34"></a></span>
<span id="cb6-35"><a href="#cb6-35"></a>  <span class="cf">try</span> {</span>
<span id="cb6-36"><a href="#cb6-36"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">"/ask"</span><span class="op">,</span> {</span>
<span id="cb6-37"><a href="#cb6-37"></a>      <span class="dt">method</span><span class="op">:</span> <span class="st">"POST"</span><span class="op">,</span></span>
<span id="cb6-38"><a href="#cb6-38"></a>      <span class="dt">body</span><span class="op">:</span> data<span class="op">,</span></span>
<span id="cb6-39"><a href="#cb6-39"></a>    })<span class="op">;</span></span>
<span id="cb6-40"><a href="#cb6-40"></a></span>
<span id="cb6-41"><a href="#cb6-41"></a>    <span class="cf">if</span> (response<span class="op">.</span><span class="at">ok</span>) {</span>
<span id="cb6-42"><a href="#cb6-42"></a>      <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">text</span>()<span class="op">;</span></span>
<span id="cb6-43"><a href="#cb6-43"></a>      <span class="kw">const</span> output <span class="op">=</span> <span class="cf">await</span> pyodide<span class="op">.</span><span class="fu">runPythonAsync</span>(result)<span class="op">;</span></span>
<span id="cb6-44"><a href="#cb6-44"></a></span>
<span id="cb6-45"><a href="#cb6-45"></a>      outputElement<span class="op">.</span><span class="at">innerText</span> <span class="op">=</span> output<span class="op">;</span></span>
<span id="cb6-46"><a href="#cb6-46"></a>    } <span class="cf">else</span> {</span>
<span id="cb6-47"><a href="#cb6-47"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"Error:"</span><span class="op">,</span> response<span class="op">.</span><span class="at">statusText</span>)<span class="op">;</span></span>
<span id="cb6-48"><a href="#cb6-48"></a>    }</span>
<span id="cb6-49"><a href="#cb6-49"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb6-50"><a href="#cb6-50"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(<span class="st">"Error:"</span><span class="op">,</span> error)<span class="op">;</span></span>
<span id="cb6-51"><a href="#cb6-51"></a>  }</span>
<span id="cb6-52"><a href="#cb6-52"></a>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This code loads Pyodide, installs the necessary libraries, makes the data accessible in Pyodide, and finally sets an event handler to process the user’s question. It works as follows:</p>
<ul>
<li><strong>Lines 1 to 3</strong> select the elements of the DOM that you’ll be interacting with.</li>
<li><strong>Lines 5 to 18</strong> define a helper function you use to load Pyodide and the data. You first load Pyodide, and install <code>pandas</code> and <code>numpy</code>. Then, you fetch the dataset and write it into Pyodide’s filesystem, to make it available to use the data in it.</li>
<li><strong>Lines 20 to 52</strong> define the event handler of a click on <code>ask-btn</code>. This means that whenever that button is clicked, this event will execute. The handler does a few things:
<ul>
<li><strong>Lines 21 to 33</strong> wait until Pyodide is fully loaded, extract the question that the user has asked, get the first rows of the dataset (which is how the model can know how to generate the right code), and put together the data to send in a POST request.</li>
<li><strong>Lines 35 to 51</strong> make a POST request to “/ask” with the parameters mentioned earlier. When the server responds, that text is run using Pyodide, and the result is then saved in <code>output</code>.</li>
</ul></li>
</ul>
<p>That’s it! Next, you’ll create the chatbot application.</p>
</section>
<section id="create-the-chatbot" class="level2">
<h2 class="anchored" data-anchor-id="create-the-chatbot">Create the Chatbot</h2>
<p>Now, you’ll create a simple application that will allow users to make questions to the chatbot about the dataset.</p>
<p>Take a look at the code in <code>src/app.py</code>:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass</span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb7-3"><a href="#cb7-3"></a></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="im">from</span> langchain <span class="im">import</span> LLMChain</span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="im">from</span> langchain.chat_models <span class="im">import</span> ChatOpenAI</span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="im">from</span> litestar <span class="im">import</span> Litestar, get, post</span>
<span id="cb7-7"><a href="#cb7-7"></a><span class="im">from</span> litestar.contrib.jinja <span class="im">import</span> JinjaTemplateEngine</span>
<span id="cb7-8"><a href="#cb7-8"></a><span class="im">from</span> litestar.enums <span class="im">import</span> RequestEncodingType</span>
<span id="cb7-9"><a href="#cb7-9"></a><span class="im">from</span> litestar.params <span class="im">import</span> Body</span>
<span id="cb7-10"><a href="#cb7-10"></a><span class="im">from</span> litestar.response_containers <span class="im">import</span> Template</span>
<span id="cb7-11"><a href="#cb7-11"></a><span class="im">from</span> litestar.static_files.config <span class="im">import</span> StaticFilesConfig</span>
<span id="cb7-12"><a href="#cb7-12"></a><span class="im">from</span> litestar.template.config <span class="im">import</span> TemplateConfig</span>
<span id="cb7-13"><a href="#cb7-13"></a><span class="im">from</span> typing_extensions <span class="im">import</span> Annotated</span>
<span id="cb7-14"><a href="#cb7-14"></a></span>
<span id="cb7-15"><a href="#cb7-15"></a><span class="im">from</span> config <span class="im">import</span> OpenAI</span>
<span id="cb7-16"><a href="#cb7-16"></a><span class="im">from</span> utils <span class="im">import</span> get_prompt</span>
<span id="cb7-17"><a href="#cb7-17"></a></span>
<span id="cb7-18"><a href="#cb7-18"></a>chain_create <span class="op">=</span> LLMChain(</span>
<span id="cb7-19"><a href="#cb7-19"></a>    llm<span class="op">=</span>ChatOpenAI(</span>
<span id="cb7-20"><a href="#cb7-20"></a>        temperature<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb7-21"><a href="#cb7-21"></a>        model_name<span class="op">=</span>OpenAI.model_name,</span>
<span id="cb7-22"><a href="#cb7-22"></a>        openai_api_key<span class="op">=</span>OpenAI.secret_key,</span>
<span id="cb7-23"><a href="#cb7-23"></a>    ),</span>
<span id="cb7-24"><a href="#cb7-24"></a>    prompt<span class="op">=</span>get_prompt(),</span>
<span id="cb7-25"><a href="#cb7-25"></a>)</span>
<span id="cb7-26"><a href="#cb7-26"></a></span>
<span id="cb7-27"><a href="#cb7-27"></a></span>
<span id="cb7-28"><a href="#cb7-28"></a><span class="at">@get</span>(path<span class="op">=</span><span class="st">"/"</span>, name<span class="op">=</span><span class="st">"index"</span>)</span>
<span id="cb7-29"><a href="#cb7-29"></a><span class="kw">def</span> index() <span class="op">-&gt;</span> Template:</span>
<span id="cb7-30"><a href="#cb7-30"></a>    <span class="cf">return</span> Template(name<span class="op">=</span><span class="st">"index.html"</span>)</span>
<span id="cb7-31"><a href="#cb7-31"></a></span>
<span id="cb7-32"><a href="#cb7-32"></a></span>
<span id="cb7-33"><a href="#cb7-33"></a><span class="at">@dataclass</span></span>
<span id="cb7-34"><a href="#cb7-34"></a><span class="kw">class</span> Query:</span>
<span id="cb7-35"><a href="#cb7-35"></a>    query: <span class="bu">str</span></span>
<span id="cb7-36"><a href="#cb7-36"></a>    df_info: <span class="bu">str</span></span>
<span id="cb7-37"><a href="#cb7-37"></a></span>
<span id="cb7-38"><a href="#cb7-38"></a></span>
<span id="cb7-39"><a href="#cb7-39"></a><span class="at">@post</span>(path<span class="op">=</span><span class="st">"/ask"</span>, name<span class="op">=</span><span class="st">"ask"</span>, sync_to_thread<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-40"><a href="#cb7-40"></a><span class="kw">def</span> ask(</span>
<span id="cb7-41"><a href="#cb7-41"></a>    data: Annotated[Query, Body(media_type<span class="op">=</span>RequestEncodingType.MULTI_PART)],</span>
<span id="cb7-42"><a href="#cb7-42"></a>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb7-43"><a href="#cb7-43"></a>    query <span class="op">=</span> data.query</span>
<span id="cb7-44"><a href="#cb7-44"></a>    df_info <span class="op">=</span> data.df_info</span>
<span id="cb7-45"><a href="#cb7-45"></a></span>
<span id="cb7-46"><a href="#cb7-46"></a>    chain_result <span class="op">=</span> chain_create.run(</span>
<span id="cb7-47"><a href="#cb7-47"></a>        {</span>
<span id="cb7-48"><a href="#cb7-48"></a>            <span class="st">"df_info"</span>: df_info,</span>
<span id="cb7-49"><a href="#cb7-49"></a>            <span class="st">"query"</span>: query,</span>
<span id="cb7-50"><a href="#cb7-50"></a>        }</span>
<span id="cb7-51"><a href="#cb7-51"></a>    )</span>
<span id="cb7-52"><a href="#cb7-52"></a>    result <span class="op">=</span> chain_result.split(<span class="st">"```python"</span>)[<span class="op">-</span><span class="dv">1</span>][:<span class="op">-</span><span class="dv">3</span>].strip()</span>
<span id="cb7-53"><a href="#cb7-53"></a></span>
<span id="cb7-54"><a href="#cb7-54"></a>    <span class="cf">return</span> result</span>
<span id="cb7-55"><a href="#cb7-55"></a></span>
<span id="cb7-56"><a href="#cb7-56"></a></span>
<span id="cb7-57"><a href="#cb7-57"></a>app <span class="op">=</span> Litestar(</span>
<span id="cb7-58"><a href="#cb7-58"></a>    route_handlers<span class="op">=</span>[index, ask],</span>
<span id="cb7-59"><a href="#cb7-59"></a>    static_files_config<span class="op">=</span>[</span>
<span id="cb7-60"><a href="#cb7-60"></a>        StaticFilesConfig(directories<span class="op">=</span>[<span class="st">"static"</span>], path<span class="op">=</span><span class="st">"/static"</span>, name<span class="op">=</span><span class="st">"static"</span>),</span>
<span id="cb7-61"><a href="#cb7-61"></a>    ],</span>
<span id="cb7-62"><a href="#cb7-62"></a>    template_config<span class="op">=</span>TemplateConfig(</span>
<span id="cb7-63"><a href="#cb7-63"></a>        engine<span class="op">=</span>JinjaTemplateEngine, directory<span class="op">=</span>Path(<span class="st">"templates"</span>)</span>
<span id="cb7-64"><a href="#cb7-64"></a>    ),</span>
<span id="cb7-65"><a href="#cb7-65"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This code provides users with a straightforward interface, allowing them to interact with the chatbot and ask questions about the dataset. Here’s how it works:</p>
<ul>
<li><strong>Lines 1 to 16</strong> import the required libraries. The application uses <a href="https://docs.litestar.dev/2/">Litestar</a>, which is a bit verbose; hence, you’ll notice many import statements. But there’s no real mystery to it, it’s <a href="https://docs.litestar.dev/2/migration/index.html">pretty similar to FastAPI or Flask</a>.</li>
<li><strong>Lines 18 to 25</strong> create an <a href="https://python.langchain.com/en/latest/modules/chains/generic/llm_chain.html">LLMChain</a> to interact with the model using the prompt read from <code>get_prompt</code>, which is a function defined in <code>utils.py</code> reads the prompts defined in <code>src/prompts</code>. The chain takes the prompts, the user’s query, and the first three rows from the dataset, and asks the model for a completion. Make sure to read the prompt to see how they work.</li>
<li><strong>Lines 28 to 30</strong> define the index route, which returns the <code>index.html</code> when a user visits <code>/</code>.</li>
<li><strong>Lines 33 to 54</strong> define a dataclass used to validate the parameters of the request made to <code>/ask</code> and define <code>/ask</code>, which is an endpoint that helps users answer questions about the dataset by generating relevant code.</li>
<li><strong>Lines 57 to 65</strong> set up the Litestar app, incorporating the previously defined routes and the locations of the templates and static files.</li>
</ul>
<p>To test the app, <code>cd</code> into <code>src/</code> and run this code in a terminal within the virtual environment:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1"></a><span class="ex">litestar</span> run <span class="at">--reload</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If everything goes well, you’ll see an output similar to this one:</p>
<p><img src="images/code-interpreter-chatbot-pyodide-langchain-openai/image-1.png" class="img-fluid"></p>
<p>Next, open <code>http://127.0.0.1:8000</code> on your browser. You should see the app’s UI.</p>
<p>Try asking a question to the chatbot. For example, you can ask when were the highest and lowest closing prices of AAPL.</p>
<p>You should get the following result:</p>
<p><img src="images/code-interpreter-chatbot-pyodide-langchain-openai/image.png" class="img-fluid"></p>
<p>That’s all! You’ve built a chatbot capable of running code on your browser.</p>
</section>
<section id="next-steps" class="level2">
<h2 class="anchored" data-anchor-id="next-steps">Next steps</h2>
<p>I won’t cover deployment in this article. This application is pretty standard, so simply choose a method that works well for you and your organization.</p>
<p>I like using NGINX with Gunicorn and Uvicorn workers and wrote a <a href="https://dylancastillo.co/fastapi-nginx-gunicorn/">tutorial</a> about it. That tutorial uses FastAPI, but the same process would also work with Litestar.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Way to go! By now, you’ve built a chatbot that can run Python code on the browser and help you answer complex questions about a dataset.</p>
<p>This is what you’ve covered in this tutorial:</p>
<ul>
<li>How to integrate Pyodide into a web app to run code in the browser.</li>
<li>How to use LangChain’s LLMChain to generate Python code.</li>
<li>How to build a simple application with Litestar.</li>
</ul>
<p>I hope this is useful. Let me know if you have questions.</p>
<p>The code for this tutorial is <a href="https://github.com/dylanjcastillo/chatbot-code-interpreter">available on GitHub</a>.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{castillo2023,
  author = {Castillo, Dylan},
  title = {Create a {Code} {Interpreter} {Chatbot} with {Pyodide,}
    {LangChain,} and {OpenAI}},
  date = {2023-05-12},
  url = {https://dylancastillo.co/posts/code-interpreter-chatbot-pyodide-langchain-openai.html},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-castillo2023" class="csl-entry quarto-appendix-citeas" role="listitem">
Castillo, Dylan. 2023. <span>“Create a Code Interpreter Chatbot with
Pyodide, LangChain, and OpenAI.”</span> May 12, 2023. <a href="https://dylancastillo.co/posts/code-interpreter-chatbot-pyodide-langchain-openai.html">https://dylancastillo.co/posts/code-interpreter-chatbot-pyodide-langchain-openai.html</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/dylancastillo\.co");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="dylanjcastillo/blog_comments" issue-term="pathname" theme="dark-blue" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>Copyright 2024, Dylan Castillo</p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>